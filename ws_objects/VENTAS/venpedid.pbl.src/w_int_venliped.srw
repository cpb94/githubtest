$PBExportHeader$w_int_venliped.srw
forward
global type w_int_venliped from w_int_con_empresa
end type
type gb_6 from groupbox within w_int_venliped
end type
type pb_1 from upb_salir within w_int_venliped
end type
type st_3 from statictext within w_int_venliped
end type
type st_pallets from statictext within w_int_venliped
end type
type st_total_cajas from statictext within w_int_venliped
end type
type st_cajas from statictext within w_int_venliped
end type
type st_tipopallet from statictext within w_int_venliped
end type
type st_articulo from statictext within w_int_venliped
end type
type em_t_pallets from u_em_campo within w_int_venliped
end type
type em_cajas from u_em_campo within w_int_venliped
end type
type em_t_cajas from u_em_campo within w_int_venliped
end type
type uo_articulo from u_em_campo_2 within w_int_venliped
end type
type uo_tipo_pallet from u_em_campo_2 within w_int_venliped
end type
type st_texto_mtrslinieales from statictext within w_int_venliped
end type
type em_mtrs_lineales from u_em_campo within w_int_venliped
end type
type em_cliente from u_em_campo within w_int_venliped
end type
type st_nombre_cliente from statictext within w_int_venliped
end type
type cb_grabar from u_boton within w_int_venliped
end type
type cb_borrar from u_boton within w_int_venliped
end type
type em_descripcion from u_em_campo within w_int_venliped
end type
type st_33 from statictext within w_int_venliped
end type
type cb_insertar from u_boton within w_int_venliped
end type
type uo_tipolinea from u_em_campo_2 within w_int_venliped
end type
type st_tplinea from statictext within w_int_venliped
end type
type cb_stock from u_boton within w_int_venliped
end type
type em_anyo from u_em_campo within w_int_venliped
end type
type gb_3 from groupbox within w_int_venliped
end type
type em_situacion from u_em_campo within w_int_venliped
end type
type gb_4 from groupbox within w_int_venliped
end type
type cb_valorar from u_boton within w_int_venliped
end type
type em_pedido from u_em_campo within w_int_venliped
end type
type st_4 from statictext within w_int_venliped
end type
type st_5 from statictext within w_int_venliped
end type
type st_peso_linea from statictext within w_int_venliped
end type
type gb_1 from groupbox within w_int_venliped
end type
type st_2 from statictext within w_int_venliped
end type
type em_porcentaje from u_em_campo within w_int_venliped
end type
type gb_2 from groupbox within w_int_venliped
end type
type st_proforma from dropdownlistbox within w_int_venliped
end type
type st_6 from statictext within w_int_venliped
end type
type st_peso_total from statictext within w_int_venliped
end type
type st_7 from statictext within w_int_venliped
end type
type st_tono from statictext within w_int_venliped
end type
type em_tono from u_em_campo within w_int_venliped
end type
type st_calibre from statictext within w_int_venliped
end type
type em_calibre from u_em_campo within w_int_venliped
end type
type cb_ultimo_precio from commandbutton within w_int_venliped
end type
type st_texto_precio from statictext within w_int_venliped
end type
type st_caja from statictext within w_int_venliped
end type
type uo_caja from u_em_campo_2 within w_int_venliped
end type
type st_calidad from statictext within w_int_venliped
end type
type st_fecha_intr from statictext within w_int_venliped
end type
type em_fecha_intr from u_em_campo within w_int_venliped
end type
type st_1 from statictext within w_int_venliped
end type
type st_9 from statictext within w_int_venliped
end type
type st_pz from statictext within w_int_venliped
end type
type st_pal from statictext within w_int_venliped
end type
type st_npalet from statictext within w_int_venliped
end type
type em_npal from u_em_campo within w_int_venliped
end type
type st_idioma from statictext within w_int_venliped
end type
type uo_idioma from u_em_campo_2 within w_int_venliped
end type
type uo_calidad from u_em_campo_2 within w_int_venliped
end type
type dw_ultimo_precio from datawindow within w_int_venliped
end type
type gb_5 from groupbox within w_int_venliped
end type
type dw_1 from datawindow within w_int_venliped
end type
type st_texto_cantidad_facturar from statictext within w_int_venliped
end type
type dw_lineas_clte from datawindow within w_int_venliped
end type
type cb_reservas from u_boton within w_int_venliped
end type
type dw_pie from datawindow within w_int_venliped
end type
type sle_observaciones from singlelineedit within w_int_venliped
end type
type st_8 from statictext within w_int_venliped
end type
type st_oc from statictext within w_int_venliped
end type
type uo_familia from u_em_campo_2 within w_int_venliped
end type
type p_1 from picture within w_int_venliped
end type
type st_moneda from statictext within w_int_venliped
end type
type st_10 from statictext within w_int_venliped
end type
type st_dto from statictext within w_int_venliped
end type
type st_deposito from statictext within w_int_venliped
end type
type deposito from statictext within w_int_venliped
end type
type em_cantidad_facturar from u_em_campo within w_int_venliped
end type
type st_dto2 from statictext within w_int_venliped
end type
type em_descuento2 from u_em_campo within w_int_venliped
end type
type em_descuento from u_em_campo within w_int_venliped
end type
type st_texto_cantidad from statictext within w_int_venliped
end type
type st_12 from statictext within w_int_venliped
end type
type sle_orden from singlelineedit within w_int_venliped
end type
type st_13 from statictext within w_int_venliped
end type
type st_14 from statictext within w_int_venliped
end type
type em_tono_imprimir from u_em_campo within w_int_venliped
end type
type em_calibre_imprimir from u_em_campo within w_int_venliped
end type
type st_info_extra from statictext within w_int_venliped
end type
type em_precio from u_em_campo within w_int_venliped
end type
type em_precio_pzs from u_em_campo within w_int_venliped
end type
type em_cantidad from u_em_campo within w_int_venliped
end type
type em_cantidad_en_pzs from u_em_campo within w_int_venliped
end type
type st_observaciones from statictext within w_int_venliped
end type
type dw_detalle from datawindow within w_int_venliped
end type
end forward

global type w_int_venliped from w_int_con_empresa
integer width = 6464
integer height = 3104
string menuname = ""
boolean resizable = true
gb_6 gb_6
pb_1 pb_1
st_3 st_3
st_pallets st_pallets
st_total_cajas st_total_cajas
st_cajas st_cajas
st_tipopallet st_tipopallet
st_articulo st_articulo
em_t_pallets em_t_pallets
em_cajas em_cajas
em_t_cajas em_t_cajas
uo_articulo uo_articulo
uo_tipo_pallet uo_tipo_pallet
st_texto_mtrslinieales st_texto_mtrslinieales
em_mtrs_lineales em_mtrs_lineales
em_cliente em_cliente
st_nombre_cliente st_nombre_cliente
cb_grabar cb_grabar
cb_borrar cb_borrar
em_descripcion em_descripcion
st_33 st_33
cb_insertar cb_insertar
uo_tipolinea uo_tipolinea
st_tplinea st_tplinea
cb_stock cb_stock
em_anyo em_anyo
gb_3 gb_3
em_situacion em_situacion
gb_4 gb_4
cb_valorar cb_valorar
em_pedido em_pedido
st_4 st_4
st_5 st_5
st_peso_linea st_peso_linea
gb_1 gb_1
st_2 st_2
em_porcentaje em_porcentaje
gb_2 gb_2
st_proforma st_proforma
st_6 st_6
st_peso_total st_peso_total
st_7 st_7
st_tono st_tono
em_tono em_tono
st_calibre st_calibre
em_calibre em_calibre
cb_ultimo_precio cb_ultimo_precio
st_texto_precio st_texto_precio
st_caja st_caja
uo_caja uo_caja
st_calidad st_calidad
st_fecha_intr st_fecha_intr
em_fecha_intr em_fecha_intr
st_1 st_1
st_9 st_9
st_pz st_pz
st_pal st_pal
st_npalet st_npalet
em_npal em_npal
st_idioma st_idioma
uo_idioma uo_idioma
uo_calidad uo_calidad
dw_ultimo_precio dw_ultimo_precio
gb_5 gb_5
dw_1 dw_1
st_texto_cantidad_facturar st_texto_cantidad_facturar
dw_lineas_clte dw_lineas_clte
cb_reservas cb_reservas
dw_pie dw_pie
sle_observaciones sle_observaciones
st_8 st_8
st_oc st_oc
uo_familia uo_familia
p_1 p_1
st_moneda st_moneda
st_10 st_10
st_dto st_dto
st_deposito st_deposito
deposito deposito
em_cantidad_facturar em_cantidad_facturar
st_dto2 st_dto2
em_descuento2 em_descuento2
em_descuento em_descuento
st_texto_cantidad st_texto_cantidad
st_12 st_12
sle_orden sle_orden
st_13 st_13
st_14 st_14
em_tono_imprimir em_tono_imprimir
em_calibre_imprimir em_calibre_imprimir
st_info_extra st_info_extra
em_precio em_precio
em_precio_pzs em_precio_pzs
em_cantidad em_cantidad
em_cantidad_en_pzs em_cantidad_en_pzs
st_observaciones st_observaciones
dw_detalle dw_detalle
end type
global w_int_venliped w_int_venliped

type variables
string filtro,bloqueado,acceso
Integer bien,ante_pallets,ante_cajas
decimal{2} ante_valor
str_almmovhis mov
String  tipo // I-> inserción , M -> Modificación
Dec{0}  linea_pedido
String  cod_tipo_unidad,cod_formato,cod_familia,var_control_alm,var_sector,var_clase,control_incremento
String articulo_ant,calidad_ant,idioma_ant,tipolinea_ant,referencia_ant,tipopallet_ant
Dec{2} precio_ant,ante_existencias,var_total
str_venped venped
String campo_actual,var_situacion,var_tipo_pallet_preparacion  
Integer tipo_precio
String impreso,almacen_de_carga
string planificado,is_tipolinea_promocion = '4'
long il_id_alm_orden_carga
Boolean aviso_cambios_descuento,ib_linea_en_orden_de_carga
boolean ib_gestionar_en_piezas = false
end variables

forward prototypes
public subroutine f_grabar_linea ()
public subroutine f_borrar_linea ()
public subroutine f_botones ()
public subroutine f_calculo_precio ()
public subroutine f_consulta_disponible ()
public subroutine f_activar_primer_campo ()
public subroutine f_consulta_reservas ()
public subroutine f_campos_segun_tiplin ()
public subroutine f_peso_linea ()
public subroutine f_recalcular_lineas ()
public subroutine f_control_ordenes (string arg_empresa, integer arg_anyo, decimal arg_pedido, decimal arg_linea)
public function boolean f_borrar_ordenes (string arg_empresa, integer arg_anyo, decimal arg_pedido, decimal arg_linea)
public subroutine f_deposito ()
public function boolean f_control_lnpedido (integer var_linea, string bajas)
public subroutine f_ubicacion_mercaderias ()
public subroutine f_control_tono_calibre ()
public subroutine f_calculo_precio_ant ()
public subroutine f_control ()
public subroutine f_con_stock_articulo ()
public function decimal f_calculo_piezas_pallet ()
end prototypes

public subroutine f_grabar_linea ();str_venliped linped
str_venped   ped 
Dec{0}  ultima,pedido,periodo,parcial_pallets
Dec{2}  parcial_cantidad,parcial_cajas
String tarifa
Dec camb

SetNull(linped.anyo_ent)
SetNull(linped.nummov_ent)
SetNull(linped.anyo_sal)
SetNull(linped.nummov_sal)
SetNull(linped.fila_ent)
SetNull(linped.altura_ent)
SetNull(linped.operario_prepa)
SetNull(linped.orden_preparacion)
linped.numpalet = dec(em_npal.text)
if isnull(linped.numpalet) then linped.numpalet = 0
linped.cantidad_prepa = 0
linped.anyo_proddiaria = 0
linped.contador_proddiaria = 0


periodo   =  Integer(em_anyo.text)
pedido    =  Dec(em_pedido.text)

linped.familia = uo_familia.em_codigo.text;

IF tipo = "M" Then
	 f_cargar_str_venliped(codigo_empresa,periodo,pedido,linea_pedido,linped)	
END IF

linped.control_incremento = control_incremento 
IF Trim(linped.control_incremento) = "" or IsNull(linped.control_incremento) Then
 	linped.control_incremento = "S"
END IF	

IF tipo ="I" THEN
	ultima =  0
	Select max(venliped.linea) 
	Into :ultima 
	From venliped
	Where  venliped.empresa   =   :codigo_empresa
	And    venliped.anyo      =   :periodo
	And    venliped.pedido    =   :pedido;
	
	IF ISNull(ultima) Then ultima=0
	
	ultima = ultima +1
	
END IF

linped.empresa   = venped.empresa
linped.anyo      = venped.anyo
linped.pedido    = venped.pedido
linped.fpedido   = venped.fpedido
linped.cliente   = venped.cliente
linped.tipoiva   = venped.tipoiva
linped.iva       = venped.iva
linped.divisa    = venped.divisa
linped.serie     = venped.serie
linped.zona      = venped.zona
linped.agente1   = venped.agente1
linped.agente2   = venped.agente2
linped.agente3   = venped.agente3
linped.comision11= venped.comision1
linped.comision12= venped.comision11
linped.comision21= venped.comision2
linped.comision22= venped.comision22
linped.comision31= venped.comision31
linped.comision32= venped.comision32
linped.linea     = ultima
linped.articulo  = uo_articulo.em_codigo.text
linped.clase     = var_clase
linped.tonochar  = Trim(em_tono.text)
linped.calibre    = Dec(em_calibre.text)
linped.tono_imprimir    = em_tono_imprimir.text
linped.calibre_imprimir = em_calibre_imprimir.text
linped.fecha_intr  = datetime(date(em_fecha_intr.text))
linped.observaciones = sle_observaciones.text
linped.orden = integer(sle_orden.text)
if linped.fecha_intr=datetime(date(1900,1,1)) then setnull(linped.fecha_intr)
///////////////////////////////////////////////////////////////////////////////////////////////////
if linped.fentrega 		  = datetime(date(1900,1,1)) then setnull(linped.fentrega)
if linped.fentrega_inicial=datetime(date(1900,1,1)) then setnull(linped.fentrega_inicial)
if linped.fecha_entrega2 = datetime(date(1900,1,1)) then setnull(linped.fecha_entrega2)
if linped.fecha_entrega3 = datetime(date(1900,1,1)) then setnull(linped.fecha_entrega3)
if linped.fecha_entrega4 = datetime(date(1900,1,1)) then setnull(linped.fecha_entrega4)
if linped.fecha_entrega5 = datetime(date(1900,1,1)) then setnull(linped.fecha_entrega5)
///////////////////////////////////////////////////////////////////////////////////////////////////

IF Isnull(linped.tonochar)    Then linped.tonochar = ""
IF Isnull(linped.calibre) Then linped.calibre = 0
linped.deposito = "N"
linped.almacen_de_carga = almacen_de_carga
  IF deposito.text = "X" Then
	linped.deposito = "S"
	linped.almacen_deposito = venped.almacen_deposito
	IF IsNUll(linped.almacen_deposito) or trim(linped.almacen_deposito) = ""Then
		f_mensaje("Error en datos","Este cliente no tiene un almacen de deposito asignado" )
		RETURN
	END IF
  END IF
linped.peso = 0
linped.sector    = "N"
IF Trim(linped.articulo) <> "" and Not Isnull(linped.articulo) Then
		SELECT articulos.subfamilia,
				 articulos.formato,
				 articulos.subformato,
				 articulos.modelo,
				 articulos.unidad,
				 articulos.pesopieza,
				 articulos.sector
		INTO   :linped.subfamilia,
				 :linped.formato,
				 :linped.subformato,
				 :linped.modelo,
				 :linped.tipo_unidad,
				 :linped.peso,
				 :linped.sector
		FROM  articulos  
		WHERE articulos.empresa = :codigo_empresa
		AND   articulos.codigo = :linped.articulo;
		
		if uo_tipolinea.em_codigo.text = is_tipolinea_promocion then linped.tipo_unidad = "0" //MUY IMPORTANTE - La promoción siempre va en piezas *******************************************************************************************
END IF


linped.calidad = uo_calidad.em_codigo.text
//if isnull(linped.calidad) or trim(linped.calidad)="0" then linped.calidad = ""
if isnull(linped.calidad) then linped.calidad = ""
IF tipo_precio = 1 Then
	linped.precio   = Dec(em_precio.text)
	IF tipo <> "M" Then 
		linped.precio_aduana = Dec(em_precio.text)
	End if
ELSE
	linped.precio_aduana    = Dec(em_precio.text)
END IF
linped.precio_pzs      = Dec(em_precio_pzs.text)

tarifa                 = f_tarifa_venped(linped.empresa,linped.anyo,linped.pedido)
linped.precio_estand   = f_precio_articulo(linped.empresa,linped.cliente,linped.articulo,linped.calidad,tarifa)

// Si las lineas son muestras pones el precio_estand tarifa f.f. igual que en promocion
CHOOSE CASE linped.clase
	CASE "M"
	       linped.precio_estand = &
                  f_precio_articulo_venlintarifas(linped.empresa,&
                           	  f_tarifa_promparam(linped.empresa),&
								        f_activa_ventarifas(linped.empresa,f_tarifa_promparam(linped.empresa)),&
										  linped.articulo,f_calidad_promparam(linped.empresa))
	CASE "S"
		    IF linped.precio_estand = 0 then
	           linped.precio_estand = &
                  f_precio_articulo_venlintarifas(linped.empresa,&
                           	  f_tarifa_promparam(linped.empresa),&
								        f_activa_ventarifas(linped.empresa,f_tarifa_promparam(linped.empresa)),&
										  linped.articulo,f_calidad_promparam(linped.empresa))
			 End if	
END CHOOSE

linped.cantidad        = Dec(em_cantidad.text)
linped.pallets         = Dec(em_t_pallets.text)
linped.total_cajas     = Dec(em_t_cajas.text)
linped.cajas           = Dec(em_cajas.text)
linped.cantidad_pzs    = Dec(em_cantidad_en_pzs.text)
linped.dtocomer        = 0
linped.planificado     = planificado


If IsNull(em_descuento.text) or Trim(em_descuento.text) ="" THEN
   em_descuento.text ="0"
END IF
If IsNull(em_descuento2.text) or Trim(em_descuento2.text) ="" THEN
   em_descuento2.text ="0"
END IF

linped.dtoesp          = Dec(em_descuento.text)
linped.dtoesp2			  = Dec(em_descuento2.text)
linped.descripcion     = em_descripcion.text
linped.idioma          = uo_idioma.em_campo.text
linped.cantidad_original = Dec(em_cantidad.text)
SetNull(linped.linea_desdoblada_de)


  SELECT familias.linea INTO :linped.linfab FROM familias  
   WHERE ( familias.empresa = :codigo_empresa ) AND  
         ( familias.codigo = :linped.familia )   ;
String   var_tipoter

SELECT genter.empresa,genter.tipoter,genter.codigo,genter.pais,
       genter.provincia  
INTO   :ped.empresa,:var_tipoter,:ped.cliente,:linped.pais,:linped.provincia  
FROM   genter  
WHERE (genter.empresa = :codigo_empresa)
AND   (genter.tipoter = 'C' )
AND   (genter.codigo = :linped.cliente );

linped.tipolinea       = uo_tipolinea.em_codigo.text
linped.texto1          = ""
linped.texto2          = ""
linped.texto3          = ""
IF Trim(linped.articulo) <> "" and Not Isnull(linped.articulo) Then
	linped.referencia      = f_componer_ref(linped.articulo,linped.calidad,linped.tonochar,linped.calibre)
	linped.montajeartcal   = f_componer_artcal(linped.articulo,linped.calidad)
ELSE
	linped.referencia      = ""
	linped.montajeartcal   = ""
END IF

linped.situacion       = em_situacion.text
//linped.situacion       = "C"
linped.metros_lineales = Dec(em_mtrs_lineales.text)
linped.falta           = Datetime(today())
linped.usuario         = nombre_usuario
linped.tipo_pallet     = uo_tipo_pallet.em_codigo.text
linped.caja            = uo_caja.em_codigo.text
linped.tipo_pallet_preparacion     =  var_tipo_pallet_preparacion  

IF tipo="M" THEN
	DELETE FROM venliped  
   WHERE venliped.empresa   = :linped.empresa
	AND   venliped.anyo      = :linped.anyo
	AND   venliped.pedido  = :linped.pedido 
	AND   venliped.linea   = :linea_pedido ;
    linped.linea   = linea_pedido
END IF


IF var_control_alm = "N" Then 
    SetNull(linped.articulo)
    SetNull(linped.formato)
    SetNull(linped.modelo)
    SetNull(linped.calidad)
    SetNull(linped.tonochar)
    SetNull(linped.calibre)
    SetNull(linped.pallets)
    SetNull(linped.total_cajas)
    SetNull(linped.cajas)
    SetNull(linped.linfab)
    SetNull(linped.referencia)
    SetNull(linped.montajeartcal)
    SetNull(linped.tipo_pallet)
	 SetNull(linped.caja)
    linped.tipo_unidad = "0"
END IF

IF linped.pallets = 0 or IsNull(linped.pallets) or linped.cajas > 0 Then
   linped.es_pico = "S"
ELSE		 
   linped.es_pico = "N"
END IF	
parcial_cajas = 0
parcial_cantidad = 0

// santiago 20/11/00
// Grabamos toda la cantidad de piezas en una línea
//IF var_situacion<> "P" Then
//    IF linped.es_pico = "N" Then
//	    IF linped.tipo_unidad = "0" Then
//			  parcial_cantidad  =  linped.cantidad - (f_piezascaja_articulo(linped.empresa,linped.articulo,linped.caja)*(f_cajaspallet_palarticulo(linped.empresa,linped.articulo,linped.tipo_pallet,linped.caja))*Dec(em_t_pallets.text))
//		  	  parcial_cajas     =  linped.cajas
//	      Else
//  	   	  parcial_cantidad  =  linped.cajas *  f_metroscaja_articulo(linped.empresa,linped.articulo,linped.caja)
//		  	  parcial_cajas     =  linped.cajas
//       END IF		
//	    linped.cajas = 0
//	    linped.total_cajas = linped.total_cajas - parcial_cajas
//	    linped.cantidad = linped.cantidad - parcial_cantidad
//    END IF	
//END IF
//If linped.control_incremento = "S" Then 
//	If linped.pallets >1 Then linped.control_incremento = "N"
//END IF	
//santiago 20/11/00
//f_mensaje("precio",String(linped.precio,"###,###.####"))
// Santiago 13/09/00. No hay control de picos
//linped.es_pico = "N"

IF Not f_insertar_venliped(linped) Then
	bien = 1
end if
IF Not f_actualizar_linea_venpedido(linped.empresa,linped.anyo,linped.pedido,linped.linea) Then
	bien = 1
end if
	
linped.deposito = "N"
linped.almacen_deposito = ""

// santiago 20/11/00
//Grabamos toda la cantidad del pedido en una línea
//IF parcial_cantidad <> 0 then
//    ultima =  0
//    Select max(venliped.linea) Into :ultima From venliped
//    Where  venliped.empresa   =   :codigo_empresa
//    And    venliped.anyo      =   :periodo
//    And    venliped.pedido    =   :pedido;
//    IF ISNull(ultima) Then ultima=0
//    ultima = ultima +1
//	 linped.pallets = 0
//	 linped.total_cajas = parcial_cajas
// 	 linped.cajas       = parcial_cajas
//  	 linped.cantidad    = parcial_cantidad
//	 linped.linea       = ultima
//	 // Santiago 13/09/00. No hay control de picos
//	 // linped.es_pico     ="S"
//	 linped.es_pico     = "N"
//    IF Not f_insertar_venliped(linped) Then bien = 1
//	 IF Not f_actualizar_linea_venpedido(linped.empresa,linped.anyo,linped.pedido,linped.linea) Then bien = 1
//END IF	 
//santiago 20/11/00

COMMIT;

f_actualizar_venpedido(codigo_empresa,periodo,pedido)
//f_actualizar_venpedido(codigo_empresa,periodo,pedido)
IF tipo = "M" Then
	IF Trim(linped.articulo) <> "" and Not IsNull(linped.articulo) Then
		f_control_ordenes(linped.empresa,linped.anyo,linped.pedido,linped.linea)
	END IF
END IF

//Control de riesgo a nivel de linea  
	
//if f_riesgo_cliente(codigo_empresa,linped.cliente) + f_pedidos_pendiente_cargar(codigo_empresa,linped.cliente)>f_riesgo_concedido(codigo_empresa,f_cuenta_genter(codigo_empresa,'C',linped.cliente)) then
//	f_mensaje("Atención","El cliente ha superado el riesgo")
//end if
				
COMMIT;

end subroutine

public subroutine f_borrar_linea ();Dec{0}periodo,pedido
long var_anyo,var_pedido,ll_lineas_del_articulo_ya_grabadas
dec  ld_total_cantidad_pedida,disponible,cant_bloqueo
int  li_calibre
string ls_tono,mensaje

var_anyo   = Dec(em_anyo.text)
var_pedido = Dec(em_pedido.text)

periodo = Dec(em_anyo.text)
pedido  = Dec(em_pedido.text)

DELETE FROM venliped 
WHERE ( venliped.empresa = :codigo_empresa ) AND  
		( venliped.anyo    = :periodo ) AND  
		( venliped.pedido  = :pedido ) AND  
		( venliped.linea   = :linea_pedido )   ;

COMMIT;

IF var_control_alm = "S" THEN
	//Vamos a comprobar el total de cantidad pedida
	ls_tono    = Trim(em_tono.text)
	li_calibre = Dec(em_calibre.text)
	
	select isnull(sum(venliped.cantidad),0),
			 isnull(count(*),0) 
	into   :ld_total_cantidad_pedida,
			 :ll_lineas_del_articulo_ya_grabadas 
	from   venliped,
			 articulos
	where  venliped.empresa     = articulos.empresa
	and    venliped.articulo    = articulos.codigo
	and    venliped.empresa     = :codigo_empresa
	and    venliped.anyo        = :var_anyo
	and    venliped.pedido      = :var_pedido
	and    venliped.situacion  <> 'P'
	and    venliped.articulo    = :uo_articulo.em_codigo.text
	and    venliped.calidad     = :uo_calidad.em_codigo.text
	and    venliped.tonochar    = :ls_tono
	and    venliped.calibre     = :li_calibre
	and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
	and    venliped.caja        = :uo_caja.em_codigo.text
	and    venliped.tipolinea  <> :is_tipolinea_promocion
	and    articulos.promocion <> 'S';		
	
	cant_bloqueo = 0	//Este control ya no funcionaba con las nuevas tablas de almacen
	
	disponible = f_disponible_art_cal_to_ca_tp_c(codigo_empresa,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text,em_tono.text,dec(em_calibre.text),uo_tipo_pallet.em_codigo.text,uo_caja.em_codigo.text)	
		
	//if tipo = 'M' then
		ante_existencias = 0
		
		//and    venliped.linea       = :linea_pedido		
		
		select isnull(sum(venliped.cantidad),0)
		into   :ante_existencias
		from   venliped,
			 	 articulos
		where  venliped.empresa     = articulos.empresa
		and    venliped.articulo    = articulos.codigo
		and    venliped.empresa     = :codigo_empresa
		and    venliped.anyo        = :var_anyo
		and    venliped.pedido      = :var_pedido
		and    venliped.situacion   = 'C'
		and    venliped.articulo    = :uo_articulo.em_codigo.text
		and    venliped.calidad     = :uo_calidad.em_codigo.text
		and    venliped.tonochar    = :ls_tono
		and    venliped.calibre     = :li_calibre
		and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
		and    venliped.caja        = :uo_caja.em_codigo.text
		and    venliped.tipolinea  <> :is_tipolinea_promocion
		and    articulos.promocion <> 'S';
		
		if isnull(ante_existencias) then ante_existencias = 0
		
		disponible = disponible + ante_existencias
	//end if
	
	em_situacion.text = "C"
		
	If disponible - cant_bloqueo < ld_total_cantidad_pedida Then
		IF Not f_produccion_articulo(codigo_empresa,uo_articulo.em_codigo.text) Then
			if MessageBox("Artículo excluido de producción.","El artículo no se fabricara más, ¿Desea grabarlo a fabricar? ",Question!, YesNo!,2) = 2 Then
				f_activar_campo(uo_articulo.em_campo)
				Return
			End if
			em_situacion.text = "F"
		ELSE
			em_situacion.text = "F"
		END IF
	ELSE
		// Santiago. Desactivamos el control de disponible de almacenes externos. 06/02/01
	
		// Santiago. Desactivamos el control de disponible de almacenes externos. 06/02/01
	END IF

	if venped.es_proforma <> "N" then
		em_situacion.text = "F"
	end if
	
END IF	
	
if ll_lineas_del_articulo_ya_grabadas > 0 then
	update venliped
	set    venliped.situacion   = :em_situacion.text
	from   venliped,
			 articulos
	where  venliped.empresa     = articulos.empresa
	and    venliped.articulo    = articulos.codigo
	and    venliped.empresa     = :codigo_empresa
	and    venliped.anyo        = :var_anyo
	and    venliped.pedido      = :var_pedido
	and    venliped.situacion  <> 'P'
	and    venliped.articulo    = :uo_articulo.em_codigo.text
	and    venliped.calidad     = :uo_calidad.em_codigo.text
	and    venliped.tonochar    = :ls_tono
	and    venliped.calibre     = :li_calibre
	and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
	and    venliped.caja        = :uo_caja.em_codigo.text
	and    venliped.tipolinea  <> :is_tipolinea_promocion
	and    articulos.promocion <> 'S';
	
	if sqlca.sqlcode <> 0 then
		mensaje = sqlca.sqlerrtext
		rollback;
		MessageBox("Atención",mensaje,Exclamation!,OK!,1)
	end if
end if 

f_actualizar_venpedido(codigo_empresa,periodo,pedido)
COMMIT;
end subroutine

public subroutine f_botones ();// Tipo de lineas de aduana solo afecta al boton grabar
IF tipo_precio = 2 Then
	IF tipo = "I" Then
		cb_grabar.enabled   = FALSE		
	ELSE
		cb_grabar.enabled   = TRUE
	END IF
  	cb_borrar.enabled   = FALSE
	cb_insertar.enabled = FALSE
	cb_reservas.enabled = FALSE
	cb_stock.enabled    = FALSE
	cb_valorar.enabled  = FALSE
	Return
END IF
///////////////////////////////////////////////////////

IF tipo = "M" and var_situacion = "P" Then
	cb_stock.enabled    = FALSE
	cb_borrar.enabled   = FALSE
	cb_insertar.enabled = True
	Return
END IF

If tipo = "I" Then 
  cb_insertar.enabled = FALSE
  cb_borrar.enabled   = FALSE
End If

If tipo = "M" Then
  cb_insertar.enabled = TRUE
  cb_borrar.enabled   = False
  if impreso = "S" then
      if acceso="1" then cb_borrar.enabled   = TRUE
    else
		cb_borrar.enabled   = True
  End if
End If


end subroutine

public subroutine f_calculo_precio ();string codpais,articulo,coleccion,tarifa,divisa
Dec incre,incre2,min_canti, cantidad
Integer t_pallets, i, contador
Dec{4}  t_cantidad,dto,v_precio_esp,v_precio_tarifa,v_pre,v_precio_esp_tar, dto2

IF IsNull(uo_articulo.em_codigo.text) or Trim(uo_articulo.em_codigo.text)= "" Then Return 
IF IsNull(uo_calidad.em_codigo.text) or Trim(uo_calidad.em_codigo.text)= "" Then Return 
  
//Obtención de la cantidad... para calculo de descuento
cantidad = Dec(em_cantidad.text)
contador = 0
For i=1 To dw_detalle.rowcount()
	/*
	if uo_articulo.em_codigo.text = String(dw_detalle.object.articulo[i]) then
		if  dw_detalle.getrow() = i and tipo = 'M' then
		else
			cantidad = cantidad + Dec(dw_detalle.object.venliped_cantidad_facturar[i])
		end if
	end if
	*/
	if uo_articulo.em_codigo.text = String(dw_detalle.object.articulo[i]) then
		if  dw_detalle.getrow() <> i then
			contador ++	
		end if
		if  dw_detalle.getrow() = i and tipo = 'M' then
		else
			cantidad = cantidad + Dec(dw_detalle.object.venliped_cantidad_facturar[i])
		end if
	end if
Next

//if contador > 1 then
//	MessageBox("Atención", "Hay más líneas de pedido de este artículo, revise los descuentos.")
//end if
  
  
  
//dto   = f_dto_cliente_articulo(codigo_empresa,em_cliente.text,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text,cantidad)
//if dto = 0 then
//	dto   = f_dto_tarifa_articulo(codigo_empresa, venped.tarifa, uo_articulo.em_codigo.text, uo_calidad.em_codigo.text, cantidad)
//end if
//
//dto2  = f_dto_cliente_articulo_fecha(codigo_empresa, em_cliente.text, uo_articulo.em_codigo.text, datetime(today()))
//
//if dto2 <> 0 then
//	em_descuento2.visible = true
//	st_dto2.visible = true
//else	
//	em_descuento2.visible = false
//	st_dto2.visible = false
//end if
//
//em_descuento.text  = "0"
//em_descuento2.text = "0"
//v_pre              = 0
//
//articulo = uo_articulo.em_codigo.text
//
//v_pre = f_precio_articulo_esp_tar(codigo_empresa,venped.tarifa,venped.cliente,articulo,uo_calidad.em_codigo.text)
//if v_pre = 0 then
//	v_pre = f_precio_articulo_venlintarifas_activa(codigo_empresa,venped.tarifa,articulo,uo_calidad.em_codigo.text)
//end if

//Nuevo
string ls_articulo,ls_calidad,ls_caja,ls_pallet,ls_tipo_linea
dec    ld_cantidad,ld_m2_caja
long   li_cantidad_en_pzs,ll_piezas_caja

str_precio_y_dtos_articulo_cliente lstr_precio_y_dtos_articulo_cliente

ls_articulo   = uo_articulo.em_codigo.text
ls_calidad    = uo_calidad.em_codigo.text
ls_caja       = uo_caja.em_codigo.text
ls_pallet     = uo_tipo_pallet.em_codigo.text
ls_tipo_linea = uo_tipolinea.em_codigo.text
ld_cantidad   = Dec(em_cantidad.text)
li_cantidad_en_pzs = integer(em_cantidad_en_pzs.text)

f_precio_y_dtos_articulo_cliente(codigo_empresa,venped.cliente,venped.fpedido,venped.tarifa,ls_articulo,ls_calidad,ls_caja,ls_pallet,ld_cantidad,ls_tipo_linea,lstr_precio_y_dtos_articulo_cliente)

em_descuento.text  = string(lstr_precio_y_dtos_articulo_cliente.descuento1)
em_descuento2.text = string(lstr_precio_y_dtos_articulo_cliente.descuento2)
em_precio.text     = string(lstr_precio_y_dtos_articulo_cliente.precio)

if f_unidad_articulo(codigo_empresa,ls_articulo) = "1" then
		
	ld_m2_caja     = f_metroscaja_articulo(codigo_empresa,ls_articulo,ls_caja)
	ll_piezas_caja = f_piezascaja_articulo(codigo_empresa,ls_articulo,ls_caja)
		
	if ll_piezas_caja <> 0 and ld_m2_caja <> 0 then	
		em_precio_pzs.text = string((lstr_precio_y_dtos_articulo_cliente.precio * ld_m2_caja) / ll_piezas_caja,em_precio_pzs.mask)
	else
		em_precio_pzs.text = string(0,em_precio_pzs.mask)
	end if
else
	em_precio_pzs.text = string(lstr_precio_y_dtos_articulo_cliente.precio,em_precio_pzs.mask)
end if

//if dec(em_descuento2.text) <> 0 then
	em_descuento2.visible = true
	st_dto2.visible = true
//else	
//	em_descuento2.visible = false
//	st_dto2.visible = false
//end if
//Fin de Nuevo

//em_descuento.text = string(dto)
//em_descuento2.text = string(dto2)
//em_precio.text    = string(v_pre)
precio_ant        = Dec(em_precio.text)

end subroutine

public subroutine f_consulta_disponible ();str_parametros str
str.s_argumentos[1]= "w_int_venliped"
str.s_argumentos[2]= uo_articulo.em_codigo.text
str.s_argumentos[3]= uo_calidad.em_codigo.text
str.s_argumentos[6]= uo_tipo_pallet.em_codigo.text
str.s_argumentos[7]= uo_caja.em_codigo.text
str.s_argumentos[8]= em_cliente.text
str.s_argumentos[9]= venped.envio
CHOOSE CASE campo_actual
	CASE "ARTICULO"
     str.s_argumentos[3]= ""
     str.s_argumentos[4]= ""
     str.s_argumentos[5]= ""
     str.s_argumentos[6]= ""

   CASE "CALIDAD"
     str.s_argumentos[4]= ""
     str.s_argumentos[5]= ""
     str.s_argumentos[6]= ""

END CHOOSE

str.i_nargumentos = 9
OpenWithParm(w_con_stock_articulos,str)

end subroutine

public subroutine f_activar_primer_campo ();em_precio.enabled = TRUE
uo_tipolinea.enabled = TRUE
uo_articulo.enabled = TRUE

IF tipo= "M" Then	 
	IF var_situacion	 = "P" Then
	   f_activar_campo(em_precio)
		Return
	END IF
END IF
IF tipo_precio = 2 Then
	f_activar_campo(em_precio)
	Return
END IF


IF var_control_alm = "N" THEN
   f_activar_campo(uo_tipolinea.em_campo)
ELSE
   f_activar_campo(uo_articulo.em_campo)
END IF

end subroutine

public subroutine f_consulta_reservas ();str_parametros str
str.s_argumentos[1]= "w_int_venliped"
str.s_argumentos[2]= uo_articulo.em_codigo.text
str.s_argumentos[3]= uo_calidad.em_codigo.text
str.s_argumentos[4]= em_tono.text
str.s_argumentos[5]= em_calibre.text
//str.s_argumentos[6]= uo_tipo_pallet.em_codigo.text
//str.s_argumentos[7]= uo_caja.em_codigo.text
str.i_nargumentos = 5
OpenWithParm(w_con_reservas_articulos,str)

end subroutine

public subroutine f_campos_segun_tiplin ();Integer var_linea
Boolean sino,sino_articulo
String  var_empresa,var_codigo,ls_gestionar_en_piezas
String  cod_tiplin


cod_tiplin  = uo_tipolinea.em_codigo.text 
var_control_alm ="N"

SELECT  ventipolin.control_almacen ,
		  ventipolin.gestionar_en_piezas  
INTO   :var_control_alm,
		 :ls_gestionar_en_piezas
FROM   ventipolin  
WHERE (ventipolin.empresa = :codigo_empresa)
AND   (ventipolin.codigo  = :cod_tiplin);

if ls_gestionar_en_piezas = 'S' then
	ib_gestionar_en_piezas = true
else	
	ib_gestionar_en_piezas = false
end if

IF dw_detalle.GetRow() <> 0 Then
	var_linea= dw_detalle.getItemNumber(dw_detalle.GetRow(),"linea")
END IF

uo_tipolinea.enabled = TRUE

if ib_gestionar_en_piezas then
	em_cantidad.enabled         = false
	em_cantidad_en_pzs.enabled  = true
	em_precio.enabled           = false
	em_precio_pzs.enabled       = true
	
	em_cantidad.visible         = false
	em_cantidad_en_pzs.visible  = true
	em_precio.visible           = false
	em_precio_pzs.visible       = true	
	
	em_cantidad.TabOrder        = 0
	em_precio.TabOrder          = 0
	em_cantidad_en_pzs.TabOrder = 130
	em_precio_pzs.TabOrder      = 160
else
	em_cantidad.enabled         = true
	em_cantidad_en_pzs.enabled  = false
	em_precio.enabled           = true
	em_precio_pzs.enabled       = false	
	
	em_cantidad.visible         = true
	em_cantidad_en_pzs.visible  = false
	em_precio.visible           = true
	em_precio_pzs.visible       = false		
	
	em_cantidad.TabOrder        = 130
	em_precio.TabOrder          = 160
	em_cantidad_en_pzs.TabOrder = 0
	em_precio_pzs.TabOrder      = 0	
end if
	  
IF (tipo= "M"  and  var_situacion	 = "P") or tipo_precio = 2 or (impreso = "S" and acceso= "0") Then
	em_cajas.enabled               = FALSE
	em_calibre.enabled             = FALSE
	em_mtrs_lineales.enabled       = FALSE
	em_t_cajas.enabled             = FALSE
	em_t_pallets.enabled           = FALSE
	em_tono.enabled                = FALSE
	uo_calidad.enabled             = FALSE
	uo_tipo_pallet.enabled         = FALSE
	uo_caja.enabled                = FALSE
	uo_articulo.enabled            = FALSE
	uo_tipolinea.enabled           = FALSE
	em_cantidad.enabled            = FALSE
	em_cantidad_en_pzs.enabled     = FALSE
	Return
END IF

CHOOSE CASE var_control_alm
	CASE "S"
        sino = TRUE
        sino_articulo= TRUE
    CASE "N"
        em_descripcion.text    = f_nombre_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
        st_texto_cantidad.text = "Unidades"
        sino = FALSE
        sino_articulo = FALSE
	CASE ELSE
        Return
END CHOOSE

IF var_control_alm ="S" and var_sector = "N" Then
   sino_articulo = TRUE
   sino          = FALSE
END IF
    em_cajas.enabled               = sino
    em_calibre.enabled             = sino
    em_mtrs_lineales.enabled       = sino
    em_t_cajas.enabled             = sino
    em_t_pallets.enabled           = sino
    em_tono.enabled                = sino
    uo_calidad.enabled             = sino
    uo_tipo_pallet.enabled         = sino
	 uo_caja.enabled                = sino
    uo_articulo.enabled            = sino_articulo

    IF var_control_alm = "S" THEN
      IF trim(uo_articulo.em_codigo.text) <> "" THEN
        cb_reservas.enabled     = sino
        cb_stock.enabled        = sino
      ELSE
        cb_reservas.enabled     = FALSE
        cb_stock.enabled        = FALSE
      END IF
    ELSE
      cb_reservas.enabled     = sino
      cb_stock.enabled        = sino
    END IF

IF var_control_alm = "N"  THEN
  uo_articulo.em_codigo.text = ""
  uo_articulo.em_campo.text  = ""
END IF

IF (var_control_alm = "S" and var_sector ="N") or var_control_alm = "N" THEN 
   uo_calidad.em_codigo.text = ""  
   uo_calidad.em_campo.text = ""
   em_tono.text = ""
   em_calibre.text = ""
   uo_tipo_pallet.em_codigo.text = ""
   uo_tipo_pallet.em_campo.text = ""
	uo_caja.em_codigo.text = ""
	uo_caja.em_campo.text = ""
   em_mtrs_lineales.text = ""
   em_t_cajas.text = ""
   em_t_pallets.text = ""
   em_cajas.text = ""
END IF

//ORDEN DE CARGA
//if ftc_linea_en_orden_carga(Dec(em_anyo.text),Dec(em_pedido.text),var_linea) and tipo <> "I" then
//	st_oc.text = "LÍNEA EN ORDEN DE CARGA."
//	cb_grabar.enabled = false
//else
//	st_oc.text = ""
//	cb_grabar.enabled = true
//end if
    

end subroutine

public subroutine f_peso_linea ();Dec{4} var_anyo,var_pedido,var_peso_linea
string ls_gestionar_en_piezas_ventipolin 

var_anyo     = Dec(em_anyo.text)
var_pedido   = Dec(em_pedido.text)


IF len(uo_articulo.em_codigo.text) <> 0  and len(uo_tipo_pallet.em_codigo.text) <> 0 Then
	IF Dec(em_cantidad.text) = 0 Then
		var_peso_linea = 0
	ELSE
		ls_gestionar_en_piezas_ventipolin = f_gestionar_en_piezas_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
		
		if ls_gestionar_en_piezas_ventipolin = 'S' then
			var_peso_linea= f_calculo_peso_pzs(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text, +&
									Dec(em_cajas.text),Dec(em_t_cajas.text),dec(em_npal.text),Dec(em_cantidad_en_pzs.text),Trim(uo_caja.em_codigo.text))			
		else
			var_peso_linea= f_calculo_peso(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text, +&
									Dec(em_cajas.text),Dec(em_t_cajas.text),dec(em_npal.text),Dec(em_cantidad.text),Trim(uo_caja.em_codigo.text))
		end if
// David 21/05/2003	En lugar de pllets completos, utilizaremos el número de pallets reales
//								Dec(em_cajas.text),Dec(em_t_cajas.text),dec(em_t_pallets.text),Dec(em_cantidad.text),Trim(uo_caja.em_codigo.text))
	END IF
Else	
	var_peso_linea=0
END IF

st_peso_linea.text   = String(var_peso_linea,"###,###,###")

Select sum(peso) Into :var_total From venliped
Where  venliped.empresa   = :codigo_empresa
And    venliped.anyo      = :var_anyo
And    venliped.pedido    = :var_pedido
And    venliped.linea    <> :linea_pedido;

IF IsNull(var_total)      Then var_total       =  0
IF IsNull(var_peso_linea) Then var_peso_linea  =  0

st_peso_total.text = String(var_total + var_peso_linea,"###,###,###")
end subroutine

public subroutine f_recalcular_lineas ();str_venliped  linped
str_venped   ped 
Integer  reg,reg1 
Dec{0}  ultima,pedido,periodo,parcial_pallets
Dec{2}  parcial_cantidad,parcial_cajas
Dec{4}  impdto,importe,acumulado,importedto1,importedto2,importedto3,importedto4,importedtopp,importedtoesp
Dec{4} control_precio,control_bruto,control_importedto,control_importe
Dec{2}  var_dto1,var_dto2,var_dto3,var_dto4,var_dtopp,control_descuento
String  var_tipodto1,var_tipodto2,var_tipodto3,var_tipodto4,var_calculo_dto
Dec{4}  var_impdto1,var_impdto2,var_impdto3,var_impdto4
Integer procesos

periodo   =  Integer(em_anyo.text)
pedido    =  Dec(em_pedido.text)
reg1 = dw_detalle.RowCount()
linped.empresa   = codigo_empresa
linped.anyo      = periodo
linped.pedido  = pedido
For reg = 1 To reg1 
 linped.linea              = Dec(f_valor_columna(dw_detalle,reg,"linea"))
 f_actualizar_linea_venpedido(linped.empresa,linped.anyo,linped.pedido,linped.linea)
COMMIT;
NEXT
f_actualizar_venpedido(codigo_empresa,periodo,pedido)
end subroutine

public subroutine f_control_ordenes (string arg_empresa, integer arg_anyo, decimal arg_pedido, decimal arg_linea);Dec{0} numero
Dec{4} ord_cantidad,va_cantidad
Dec{0} va_calibre,va_pallets,va_total_cajas,va_cajas
String va_referencia,va_situacion,va_tipo_pallet,va_ubicacion,&
		va_articulo,va_calidad,va_caja,va_tono

Select sum(cantidad) Into :ord_cantidad From almlincargas
Where  almlincargas.empresa    = :arg_empresa
And    almlincargas.anyo_ped   = :arg_anyo
And    almlincargas.pedido     = :arg_pedido
And    almlincargas.linea_ped  = :arg_linea;
IF IsNUll(ord_cantidad) Then ord_cantidad = 0
IF ord_cantidad = 0 Then Return
  SELECT venliped.articulo,      venliped.calidad,   
			venliped.tonochar,      venliped.calibre,   
         venliped.cantidad,      venliped.pallets,   
         venliped.total_cajas,   venliped.cajas,   
         venliped.referencia,    venliped.situacion,   
         venliped.tipo_pallet,   venliped.caja  
    INTO :va_articulo,:va_calidad,:va_tono,:va_calibre,:va_cantidad,:va_pallets,:va_total_cajas,   
         :va_cajas,:va_referencia,:va_situacion,:va_tipo_pallet,:va_caja  
    FROM venliped  
   WHERE venliped.empresa = :arg_empresa
	AND   venliped.anyo    = :arg_anyo
	AND   venliped.pedido  = :arg_pedido
	AND   venliped.linea   = :arg_linea;
	 UPDATE almlincargas  
     SET almlincargas.tonochar         =  :va_tono,   
         almlincargas.calibre          =  :va_calibre,   
         almlincargas.referencia       =  :va_referencia,   
         almlincargas.tipo_pallet      =  :va_tipo_pallet,   
         almlincargas.caja             =  :va_caja,   			
         almlincargas.cajas            =  :va_cajas,   
         almlincargas.total_cajas      =  :va_total_cajas,   
         almlincargas.cantidad         =  :va_cantidad,   
         almlincargas.cantidad_ped     =  :va_cantidad,   
         almlincargas.pallets          =  :va_pallets,   
         almlincargas.situacion_pedido =  :va_situacion 
Where  almlincargas.empresa    = :arg_empresa
And    almlincargas.anyo_ped   = :arg_anyo
And    almlincargas.pedido     = :arg_pedido
And    almlincargas.linea_ped  = :arg_linea;
f_actualiza_almlincargas(arg_empresa,arg_anyo,arg_pedido,arg_linea)
Return 


end subroutine

public function boolean f_borrar_ordenes (string arg_empresa, integer arg_anyo, decimal arg_pedido, decimal arg_linea);Delete  From    almlincargas  
WHERE   almlincargas.empresa    = :arg_empresa
AND     almlincargas.anyo_ped   = :arg_anyo
AND     almlincargas.pedido     = :arg_pedido
AND     almlincargas.linea_ped  = :arg_linea;
IF SQLCA.SQLCODE <> 0 Then Return FALSE
Return TRUE

end function

public subroutine f_deposito ();string cliente_art

st_deposito.visible = FALSE
deposito.visible = FALSE
deposito.text = ""

select cliente
into :cliente_art
from articulos
where empresa = :codigo_empresa
and codigo = :uo_articulo.em_codigo.text;

if isnull(cliente_art) or isnull(cliente_Art) then return

IF venped.deposito = "N" Then Return
IF f_deposito_venclientes(codigo_empresa,em_cliente.text) = "S" Then
	IF f_deposito_cliente_articulo(codigo_empresa,em_cliente.text,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text)= "S" Then
		st_deposito.visible = TRUE
		deposito.visible = TRUE
		deposito.text = "X"
	END IF
END IF

end subroutine

public function boolean f_control_lnpedido (integer var_linea, string bajas);Integer  var_veces,var_pedido,var_anyo,numero
//IF var_situacion = "P" Then
//	f_mensaje("Control Almacen","Este Pedido Esta Preparado, No se puede Modificar !!!")
//	Return False
//END IF
var_anyo   = Dec(em_anyo.text)
var_pedido = Dec(em_pedido.text)
numero     = f_ordenes_pedido(codigo_empresa,var_anyo,var_pedido,var_linea)
IF numero >1 Then
	f_mensaje("Control Almacen","Este Pedido En varias Ordenes, No se puede modificar!!!")
	Return FALSE
END IF
IF f_pedido_impreso(codigo_empresa,Dec(em_anyo.text),Dec(em_pedido.text)) Then
	 IF acceso = "2" THEN
		IF bajas = "S" Then
			f_mensaje("Control Almacen","Este Pedido está impreso, no se puede Modificar!!!")
			return FALSE
		END IF
	 ELSE
		IF numero = 0 Then 
			Return TRUE
		ELSE
			IF numero >1 Then
				f_mensaje("Control Almacen","Este Pedido está en varias Órdenes, No se puede modificar!!!")
				Return FALSE
			ELSE
				IF f_ordenes_pedido_listadas(codigo_empresa,var_anyo,var_pedido,var_linea)=0 Then
					f_mensaje("Existe una orden a este pedido! ","La orden se modificará.")			
				ELSE
					f_mensaje("Existe una orden a este pedido Impreso!","La orden se modificará.")			
				END IF
				f_control_ordenes(codigo_empresa,var_anyo,var_pedido,var_linea)
				Return TRUE
			END IF
		END IF

	 END IF
ELSE
	 IF acceso = "2"  or acceso = "1"THEN
		IF numero = 0 Then
			Return True
		ELSE
			IF f_ordenes_pedido_listadas(codigo_empresa,var_anyo,var_pedido,var_linea) = 0 Then
				IF MessageBox("Control Almacen (Este pedido Existe en Ordenes)","¿ Modificar el Pedido ?",Question!,YesNo!)= 1 Then
					f_control_ordenes(codigo_empresa,var_anyo,var_pedido,var_linea)
					return TRUE
				ELSE
					Return FALSE
				END IF
			ELSE
				IF acceso = "1" Then
						f_mensaje("Control almacen","Pedido con ordenes impresas")
						Return true
				ELSE
					f_mensaje("Control almacen","Pedido con ordenes impresas, No se puede Modificar!!!")
					Return  FALSE
				END IF
			END IF
		END IF
	 END IF
END IF

RETURN TRUE
end function

public subroutine f_ubicacion_mercaderias ();//var_anyo   = dw_pedido.GetItemNumber(dw_pedido.GetRow(),"venliped_anyo")
//var_pedido = dw_pedido.GetItemNumber(dw_pedido.GetRow(),"venliped_pedido")
//var_linea  = dw_pedido.GetItemNumber(dw_pedido.GetRow(),"venliped_linea")
//// Guardamos en venliubica
//DELETE FROM venliubica
//WHERE  venliubica.empresa = :codigo_empresa
//AND  venliubica.anyo    = :var_anyo
//AND  venliubica.pedido  = :var_pedido
//AND  venliubica.linea   = :var_linea;
//
//if sqlca.sqlcode <> 0 then
//	f_mensaje("Borrado de venliubica", "Error: "+sqlca.sqlerrtext)
//	bien = false
//end if
//
//// Insertamos un registro por ubicacion con cant > 0
//
//var_empr_alm = dw_ubica_mercad.GetItemString(cont,"almlinubica_empresa")
//var_almacen  = dw_ubica_mercad.GetItemString(cont,"almlinubica_almacen")
//var_zona  = dw_ubica_mercad.GetItemString(cont,"zona")
//var_fila  = dw_ubica_mercad.GetItemNumber(cont,"fila")
//var_altura= dw_ubica_mercad.GetItemNumber(cont,"altura")				
//var_ubica = f_componer_ubicacion(var_almacen,var_zona,var_fila,var_altura)
//
//INSERT INTO venliubica 
//(empresa,anyo,pedido,linea,empr_almacen,ubicacion,cantidad)
//VALUES (:codigo_empresa,:var_anyo, :var_pedido,:var_linea,
//:var_empr_alm,  :var_ubica,:var_parte);
//
//if sqlca.sqlcode <> 0 then
//	f_mensaje("Inserción de venliubica","Error: "+sqlca.sqlerrtext)
//	bien = false
//end if
//
end subroutine

public subroutine f_control_tono_calibre ();/* David 28-03-02
IF Not f_control_tono_artcal(codigo_empresa,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text) Then
 	em_tono.text =  ""
else
	if em_tono.text = "" then	em_tono.text  =  "0"
END IF
IF Not f_control_calibre_artcal(codigo_empresa,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text) Then
   em_calibre.text    =  "0"
else
   if em_calibre.text= "" then em_calibre.text =  "1"
END IF  
*/ // David 28-03-02
end subroutine

public subroutine f_calculo_precio_ant ();string codpais,articulo,coleccion,tarifa,divisa
Dec incre,incre2,min_canti
Integer t_pallets
Dec{4}  t_cantidad,dto,v_precio_esp,v_precio_tarifa,v_pre,v_precio_esp_tar
IF IsNull(uo_articulo.em_codigo.text) or Trim(uo_articulo.em_codigo.text)= "" Then Return 
IF IsNull(uo_calidad.em_codigo.text) or Trim(uo_calidad.em_codigo.text)= "" Then Return 
  
dto   = f_dto_cliente_articulo(codigo_empresa,em_cliente.text,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text,Dec(em_cantidad.text))
em_descuento.text = "0"
em_descuento2.text= '0'
v_pre=0

articulo=uo_articulo.em_codigo.text
coleccion=f_coleccion_articulo(codigo_empresa,articulo)
divisa = f_moneda_cliente(codigo_empresa,venped.cliente)
if uo_tipolinea.em_codigo.text<>'5' then
	// santiago. 05/12/00 . Primero miramos si hay precio especial
	v_pre = f_precio_articulo_esp_tar(codigo_empresa,venped.tarifa,venped.cliente,articulo,uo_calidad.em_codigo.text)
	em_descuento.text =string(f_dto1_venclientes(codigo_empresa,em_cliente.text))
	em_descuento2.text=string(f_dto2_venclientes(codigo_empresa,em_cliente.text))
	if v_pre = 0 then
		if f_precio_neto_almcolecciones(codigo_empresa,coleccion)='S' then
			t_cantidad=dec(em_cantidad.text)
			min_canti=f_minimo_almcolecciones(codigo_empresa,coleccion)
			if t_cantidad>min_canti then
				tarifa=f_tarifa_almcolecciones(codigo_empresa,coleccion)
				v_pre=f_precio_articulo_venlintarifas_activa_m(codigo_empresa,tarifa,articulo,uo_calidad.em_codigo.text,divisa)
			else
				v_pre=f_precio_articulo_venlintarifas_activa_m(codigo_empresa,venped.tarifa,articulo,uo_calidad.em_codigo.text,divisa)
				em_descuento.text=string(f_dto1_venclientes(codigo_empresa,em_cliente.text))
				em_descuento2.text=string(f_dto2_venclientes(codigo_empresa,em_cliente.text))			
			end if
		else
			v_pre=f_precio_articulo_venlintarifas_activa_m(codigo_empresa,venped.tarifa,articulo,uo_calidad.em_codigo.text,divisa)
			em_descuento.text=string(f_dto1_venclientes(codigo_empresa,em_cliente.text))
			em_descuento2.text=string(f_dto2_venclientes(codigo_empresa,em_cliente.text))	
		end if
	end if
end if

em_precio.text=string(v_pre)
precio_ant = Dec(em_precio.text)

end subroutine

public subroutine f_control ();dw_detalle.setredraw(false)
string donde,cuanto
//donde=dw_detalle.Object.DataWindow.VerticalScrollPosition
dw_detalle.Retrieve(codigo_empresa,Integer(em_anyo.text),Dec(em_pedido.text),tipo_precio)
//dw_detalle.Object.DataWindow.VerticalScrollPosition=donde
// si donde vale 0, kaska
dw_detalle.setredraw(true)

	
end subroutine

public subroutine f_con_stock_articulo ();String  referencia,tipo_pallet,nombre_calidad,nombre_tipo_pallet,calidad,caja,tono,articulo
dec{2}  existencias,disponible,preparado,reservado
Integer calibre,x1
string v_articulo

//dw_1.SetRedraw(False)
dw_1.SetFilter("")											  
dw_1.Filter()

IF dw_1.Retrieve(codigo_empresa,uo_articulo.em_codigo.text) = 0 Then 
//	dw_1.SetRedraw(True)
	
	Return
END IF

For x1 = 1 To dw_1.RowCount()
  articulo    = dw_1.GetItemString(x1,"articulo")
  existencias = dw_1.GetItemNumber(x1,"stock")
  calidad	  = dw_1.GetItemString(x1,"calidad")
  nombre_calidad     = f_nombre_calidad_abr(codigo_empresa,calidad)
  tono		         = dw_1.GetItemString(x1,"tono")
  calibre            = dw_1.GetItemNumber(x1,"calibre")
//ANALIZAR QUE HACER CON LA GESTION DE TONOS Y CALIBRES
//  dw_1.SetItem(x1,"codigo_calidad",calidad)
//  dw_1.SetItem(x1,"calidadx",nombre_calidad)
//  dw_1.SetItem(x1,"tonocharx",tono)
//  dw_1.SetItem(x1,"calibre",calibre)
  //NUEVO ALMACEN 01/2014
  //reservado  = f_reservado_articulo_calidad_tono_cali(codigo_empresa,articulo,calidad,tono,calibre)
  //preparado  = f_preparado_articulo_calidad_tono_cali(codigo_empresa,articulo,calidad,tono,calibre)
//  reservado = 0
//  preparado = 0  
//  disponible = existencias - reservado - preparado
  //dw_1.SetItem(x1,"disponible",disponible)
  //dw_1.SetItem(x1,"reservado",reservado)
  //dw_1.SetItem(x1,"preparado",preparado)
End For

dw_1.SetRedraw(True)



end subroutine

public function decimal f_calculo_piezas_pallet ();dec v_piezascaja, v_cajaspallet

select piezascaja
into :v_piezascaja
from almartcajas
where empresa = :codigo_empresa
and articulo = :uo_articulo.em_codigo.text
and caja = :uo_caja.em_codigo.text;

select cajaspallet
into :v_cajaspallet
from palarticulo
where empresa = :codigo_empresa
and articulo = :uo_articulo.em_codigo.text
and caja = :uo_caja.em_codigo.text
and codigo = :uo_tipo_pallet.em_codigo.text;



return v_cajaspallet * v_piezascaja



end function

event open;call super::open;string moneda_genter

aviso_cambios_descuento = false

istr_parametros = Message.PowerObjectParm
istr_parametros.s_titulo_ventana="Introducción lineas de pedidos"
This.title=istr_parametros.s_titulo_ventana
tipo_precio = 1
dw_detalle.SetTransObject(SQLCA)
dw_pie.SetTransObject(SQLCA)
dw_lineas_clte.SetTransObject(SQLCA)

dw_1.dataobject = "dwtc_aux_stock_articulo_pedidos"

if ib_nueva_gestion_de_reservas then
	dw_1.dataobject = "dwtc_aux_stock_articulo_pedidos_new"
else
	dw_1.dataobject = "dwtc_aux_stock_articulo_pedidos2_new"
end if

dw_1.SetTransObject(SQLCA)

IF istr_parametros.i_nargumentos>1 THEN
     em_anyo.text=String(Dec(istr_parametros.s_argumentos[2]))
     em_pedido.text=String(Dec(istr_parametros.s_argumentos[3]))
     IF Trim(em_anyo.text)<>"" and Trim(em_pedido.text)<>"" THEN
         f_control()
     END IF
     istr_parametros.i_nargumentos=0

// Se controla el nivel de acceso del usuario
   acceso  = f_control_acceso(nombre_usuario)
   impreso = f_pedido_impreso_sn(codigo_empresa,dec(em_anyo.text),Dec(em_pedido.text))
     
   venped.anyo   = Dec(em_anyo.text)
   venped.pedido = Dec(em_pedido.text)  


  SELECT venped.empresa,venped.anyo,venped.pedido,venped.fpedido,   
			venped.falta,venped.cliente,venped.observaciones,
			venped.codpago,venped.agente1,venped.agente2,venped.comision1,
			venped.comision2,venped.comision11,
			venped.comision22,venped.dtopp,venped.dtoesp1,   
			venped.dtoesp2,venped.dtoesp3,   
			venped.dtoesp4,venped.tipodto1,   
			venped.tipodto2,venped.tipodto3,   
			venped.tipodto4,venped.explicaciondto1,   
			venped.explicaciondto2,venped.explicaciondto3,   
			venped.explicaciondto4,venped.tipoiva,   
			venped.iva,venped.numpedcli,venped.idioma,   
			venped.divisa,venped.cambio,venped.tarifa,   
			venped.ftarifa,venped.fbloqueo,
			venped.serie,venped.zona,
			venped.forma_envio,venped.cod_entrega,   
			venped.usuario,venped.tipo_portes,
			venped.periodo_fac,venped.peso,
			venped.envio,venped.deposito,
			venped.almacen_deposito,
			venped.almacen_de_carga,
			venped.es_proforma,
			venped.recalcular_packs
	INTO :venped.empresa,:venped.anyo,:venped.pedido,:venped.fpedido,   
			:venped.falta,:venped.cliente,
			:venped.observaciones,:venped.codpago,:venped.agente1,   
			:venped.agente2,:venped.comision1,:venped.comision2,
			:venped.comision11,:venped.comision22,:venped.dtopp,
			:venped.dtoesp1,:venped.dtoesp2,:venped.dtoesp3,:venped.dtoesp4,   
			:venped.tipodto1,:venped.tipodto2,:venped.tipodto3,
			:venped.tipodto4,:venped.explicaciondto1,:venped.explicaciondto2,   
			:venped.explicaciondto3,:venped.explicaciondto4,:venped.tipoiva,   
			:venped.iva,:venped.numpedcli,:venped.idioma,:venped.divisa,   
			:venped.cambio,:venped.tarifa,:venped.ftarifa,:venped.fbloqueo,   
			:venped.serie,:venped.zona,:venped.forma_envio,   
			:venped.cod_entrega,:venped.usuario,:venped.tipo_portes,   
			:venped.periodo_fac,:venped.peso,:venped.envio,:venped.deposito,
			:venped.almacen_deposito,:almacen_de_carga,
			:venped.es_proforma,
			:venped.recalcular_packs
	FROM venped  
	WHERE venped.empresa = :codigo_empresa
	AND   venped.anyo    = :venped.anyo
	AND   venped.pedido  = :venped.pedido;

	IF SQLCA.SQLCODE <> 0 Then
		f_mensaje("(Seleccion venped)Error en datos",sqlca.SqlErrText)
	END IF
      
	em_cliente.text = venped.cliente
	
	st_nombre_cliente.text = f_nombre_cliente(codigo_empresa,"C",em_cliente.text)
	
	tipo = "I"		
	
	int li_decimales_precio
	string  ls_mascara_moneda_tarifa
	
	li_decimales_precio       = f_ventarifas_decimales_precios(codigo_empresa,venped.tarifa)
	ls_mascara_moneda_tarifa  = f_mascara_decimales(li_decimales_precio)
	
	em_precio.setmask(DecimalMask!,ls_mascara_moneda_tarifa)
	em_precio_pzs.setmask(DecimalMask!,ls_mascara_moneda_tarifa)
	
	f_mascara_columna(dw_detalle,"precio",ls_mascara_moneda_tarifa)
	f_mascara_columna(dw_detalle,"venliped_precio_pzs",ls_mascara_moneda_tarifa)
	f_mascara_columna(dw_detalle,"calculo_precio",ls_mascara_moneda_tarifa)
	
	moneda_genter = f_moneda_genter(codigo_empresa,"C",venped.cliente)
	
	if moneda_genter = "7" then
		p_1.PictureName = "c:\bmp\ecu.bmp"
		st_moneda.text = "EUROS"
	else
		if moneda_genter = "1" then
			p_1.PictureName = "c:\bmp\nacional2.bmp"
			st_moneda.text = "PESETAS"
		else
			p_1.PictureName = "c:\bmp\globo.bmp"
			st_moneda.text = f_nombre_moneda(moneda_genter) 
		end if
	end if
	  
END IF


cb_insertar.TriggerEvent(Clicked!)
f_peso_linea()
end event

event close;call super::close; longitud     =  len(trim(codigo_empresa))
 criterio[1]  =  trim(codigo_empresa)+ space(20-longitud)
 longitud     =  len(Trim(String(Dec(em_anyo.text))))
 criterio[2]  =  trim(String(Dec(em_anyo.text)))+space(20-longitud)
 longitud     =  len(Trim(String(Dec(em_pedido.text))))
 criterio[3]  =  trim(String(Dec(em_pedido.text)))+space(20-longitud)
 seleccion    =  criterio[1]+criterio[2]+criterio[3]
 tabla        = "venped"
 f_desbloquear(tabla,seleccion,titulo)
 COMMIT;

 
end event

on ue_f7;call w_int_con_empresa::ue_f7;cb_valorar.TriggerEvent(Clicked!)
end on

on ue_f3;call w_int_con_empresa::ue_f3;cb_grabar.TriggerEvent(Clicked!)
end on

on ue_f6;call w_int_con_empresa::ue_f6;cb_reservas.TriggerEvent(Clicked!)
end on

on ue_f5;call w_int_con_empresa::ue_f5;cb_stock.TriggerEvent(Clicked!)
end on

on ue_f4;call w_int_con_empresa::ue_f4;cb_borrar.TriggerEvent(Clicked!)
end on

on ue_listar;//dw_report  = dw_listado
//dw_report.SetTransObject(SQLCA)
//Datetime fecha
//fecha = DateTime(Date(String(sle_fecha.Text)))
//dw_report.retrieve(codigo_empresa,em_tarifa.text,fecha)
//IF TRIM(filtro)<>"" THEN
// dw_report.SetFilter(filtro)
// dw_report.Filter()
//END IF
//CALL Super::ue_listar
end on

on w_int_venliped.create
int iCurrent
call super::create
this.gb_6=create gb_6
this.pb_1=create pb_1
this.st_3=create st_3
this.st_pallets=create st_pallets
this.st_total_cajas=create st_total_cajas
this.st_cajas=create st_cajas
this.st_tipopallet=create st_tipopallet
this.st_articulo=create st_articulo
this.em_t_pallets=create em_t_pallets
this.em_cajas=create em_cajas
this.em_t_cajas=create em_t_cajas
this.uo_articulo=create uo_articulo
this.uo_tipo_pallet=create uo_tipo_pallet
this.st_texto_mtrslinieales=create st_texto_mtrslinieales
this.em_mtrs_lineales=create em_mtrs_lineales
this.em_cliente=create em_cliente
this.st_nombre_cliente=create st_nombre_cliente
this.cb_grabar=create cb_grabar
this.cb_borrar=create cb_borrar
this.em_descripcion=create em_descripcion
this.st_33=create st_33
this.cb_insertar=create cb_insertar
this.uo_tipolinea=create uo_tipolinea
this.st_tplinea=create st_tplinea
this.cb_stock=create cb_stock
this.em_anyo=create em_anyo
this.gb_3=create gb_3
this.em_situacion=create em_situacion
this.gb_4=create gb_4
this.cb_valorar=create cb_valorar
this.em_pedido=create em_pedido
this.st_4=create st_4
this.st_5=create st_5
this.st_peso_linea=create st_peso_linea
this.gb_1=create gb_1
this.st_2=create st_2
this.em_porcentaje=create em_porcentaje
this.gb_2=create gb_2
this.st_proforma=create st_proforma
this.st_6=create st_6
this.st_peso_total=create st_peso_total
this.st_7=create st_7
this.st_tono=create st_tono
this.em_tono=create em_tono
this.st_calibre=create st_calibre
this.em_calibre=create em_calibre
this.cb_ultimo_precio=create cb_ultimo_precio
this.st_texto_precio=create st_texto_precio
this.st_caja=create st_caja
this.uo_caja=create uo_caja
this.st_calidad=create st_calidad
this.st_fecha_intr=create st_fecha_intr
this.em_fecha_intr=create em_fecha_intr
this.st_1=create st_1
this.st_9=create st_9
this.st_pz=create st_pz
this.st_pal=create st_pal
this.st_npalet=create st_npalet
this.em_npal=create em_npal
this.st_idioma=create st_idioma
this.uo_idioma=create uo_idioma
this.uo_calidad=create uo_calidad
this.dw_ultimo_precio=create dw_ultimo_precio
this.gb_5=create gb_5
this.dw_1=create dw_1
this.st_texto_cantidad_facturar=create st_texto_cantidad_facturar
this.dw_lineas_clte=create dw_lineas_clte
this.cb_reservas=create cb_reservas
this.dw_pie=create dw_pie
this.sle_observaciones=create sle_observaciones
this.st_8=create st_8
this.st_oc=create st_oc
this.uo_familia=create uo_familia
this.p_1=create p_1
this.st_moneda=create st_moneda
this.st_10=create st_10
this.st_dto=create st_dto
this.st_deposito=create st_deposito
this.deposito=create deposito
this.em_cantidad_facturar=create em_cantidad_facturar
this.st_dto2=create st_dto2
this.em_descuento2=create em_descuento2
this.em_descuento=create em_descuento
this.st_texto_cantidad=create st_texto_cantidad
this.st_12=create st_12
this.sle_orden=create sle_orden
this.st_13=create st_13
this.st_14=create st_14
this.em_tono_imprimir=create em_tono_imprimir
this.em_calibre_imprimir=create em_calibre_imprimir
this.st_info_extra=create st_info_extra
this.em_precio=create em_precio
this.em_precio_pzs=create em_precio_pzs
this.em_cantidad=create em_cantidad
this.em_cantidad_en_pzs=create em_cantidad_en_pzs
this.st_observaciones=create st_observaciones
this.dw_detalle=create dw_detalle
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.gb_6
this.Control[iCurrent+2]=this.pb_1
this.Control[iCurrent+3]=this.st_3
this.Control[iCurrent+4]=this.st_pallets
this.Control[iCurrent+5]=this.st_total_cajas
this.Control[iCurrent+6]=this.st_cajas
this.Control[iCurrent+7]=this.st_tipopallet
this.Control[iCurrent+8]=this.st_articulo
this.Control[iCurrent+9]=this.em_t_pallets
this.Control[iCurrent+10]=this.em_cajas
this.Control[iCurrent+11]=this.em_t_cajas
this.Control[iCurrent+12]=this.uo_articulo
this.Control[iCurrent+13]=this.uo_tipo_pallet
this.Control[iCurrent+14]=this.st_texto_mtrslinieales
this.Control[iCurrent+15]=this.em_mtrs_lineales
this.Control[iCurrent+16]=this.em_cliente
this.Control[iCurrent+17]=this.st_nombre_cliente
this.Control[iCurrent+18]=this.cb_grabar
this.Control[iCurrent+19]=this.cb_borrar
this.Control[iCurrent+20]=this.em_descripcion
this.Control[iCurrent+21]=this.st_33
this.Control[iCurrent+22]=this.cb_insertar
this.Control[iCurrent+23]=this.uo_tipolinea
this.Control[iCurrent+24]=this.st_tplinea
this.Control[iCurrent+25]=this.cb_stock
this.Control[iCurrent+26]=this.em_anyo
this.Control[iCurrent+27]=this.gb_3
this.Control[iCurrent+28]=this.em_situacion
this.Control[iCurrent+29]=this.gb_4
this.Control[iCurrent+30]=this.cb_valorar
this.Control[iCurrent+31]=this.em_pedido
this.Control[iCurrent+32]=this.st_4
this.Control[iCurrent+33]=this.st_5
this.Control[iCurrent+34]=this.st_peso_linea
this.Control[iCurrent+35]=this.gb_1
this.Control[iCurrent+36]=this.st_2
this.Control[iCurrent+37]=this.em_porcentaje
this.Control[iCurrent+38]=this.gb_2
this.Control[iCurrent+39]=this.st_proforma
this.Control[iCurrent+40]=this.st_6
this.Control[iCurrent+41]=this.st_peso_total
this.Control[iCurrent+42]=this.st_7
this.Control[iCurrent+43]=this.st_tono
this.Control[iCurrent+44]=this.em_tono
this.Control[iCurrent+45]=this.st_calibre
this.Control[iCurrent+46]=this.em_calibre
this.Control[iCurrent+47]=this.cb_ultimo_precio
this.Control[iCurrent+48]=this.st_texto_precio
this.Control[iCurrent+49]=this.st_caja
this.Control[iCurrent+50]=this.uo_caja
this.Control[iCurrent+51]=this.st_calidad
this.Control[iCurrent+52]=this.st_fecha_intr
this.Control[iCurrent+53]=this.em_fecha_intr
this.Control[iCurrent+54]=this.st_1
this.Control[iCurrent+55]=this.st_9
this.Control[iCurrent+56]=this.st_pz
this.Control[iCurrent+57]=this.st_pal
this.Control[iCurrent+58]=this.st_npalet
this.Control[iCurrent+59]=this.em_npal
this.Control[iCurrent+60]=this.st_idioma
this.Control[iCurrent+61]=this.uo_idioma
this.Control[iCurrent+62]=this.uo_calidad
this.Control[iCurrent+63]=this.dw_ultimo_precio
this.Control[iCurrent+64]=this.gb_5
this.Control[iCurrent+65]=this.dw_1
this.Control[iCurrent+66]=this.st_texto_cantidad_facturar
this.Control[iCurrent+67]=this.dw_lineas_clte
this.Control[iCurrent+68]=this.cb_reservas
this.Control[iCurrent+69]=this.dw_pie
this.Control[iCurrent+70]=this.sle_observaciones
this.Control[iCurrent+71]=this.st_8
this.Control[iCurrent+72]=this.st_oc
this.Control[iCurrent+73]=this.uo_familia
this.Control[iCurrent+74]=this.p_1
this.Control[iCurrent+75]=this.st_moneda
this.Control[iCurrent+76]=this.st_10
this.Control[iCurrent+77]=this.st_dto
this.Control[iCurrent+78]=this.st_deposito
this.Control[iCurrent+79]=this.deposito
this.Control[iCurrent+80]=this.em_cantidad_facturar
this.Control[iCurrent+81]=this.st_dto2
this.Control[iCurrent+82]=this.em_descuento2
this.Control[iCurrent+83]=this.em_descuento
this.Control[iCurrent+84]=this.st_texto_cantidad
this.Control[iCurrent+85]=this.st_12
this.Control[iCurrent+86]=this.sle_orden
this.Control[iCurrent+87]=this.st_13
this.Control[iCurrent+88]=this.st_14
this.Control[iCurrent+89]=this.em_tono_imprimir
this.Control[iCurrent+90]=this.em_calibre_imprimir
this.Control[iCurrent+91]=this.st_info_extra
this.Control[iCurrent+92]=this.em_precio
this.Control[iCurrent+93]=this.em_precio_pzs
this.Control[iCurrent+94]=this.em_cantidad
this.Control[iCurrent+95]=this.em_cantidad_en_pzs
this.Control[iCurrent+96]=this.st_observaciones
this.Control[iCurrent+97]=this.dw_detalle
end on

on w_int_venliped.destroy
call super::destroy
destroy(this.gb_6)
destroy(this.pb_1)
destroy(this.st_3)
destroy(this.st_pallets)
destroy(this.st_total_cajas)
destroy(this.st_cajas)
destroy(this.st_tipopallet)
destroy(this.st_articulo)
destroy(this.em_t_pallets)
destroy(this.em_cajas)
destroy(this.em_t_cajas)
destroy(this.uo_articulo)
destroy(this.uo_tipo_pallet)
destroy(this.st_texto_mtrslinieales)
destroy(this.em_mtrs_lineales)
destroy(this.em_cliente)
destroy(this.st_nombre_cliente)
destroy(this.cb_grabar)
destroy(this.cb_borrar)
destroy(this.em_descripcion)
destroy(this.st_33)
destroy(this.cb_insertar)
destroy(this.uo_tipolinea)
destroy(this.st_tplinea)
destroy(this.cb_stock)
destroy(this.em_anyo)
destroy(this.gb_3)
destroy(this.em_situacion)
destroy(this.gb_4)
destroy(this.cb_valorar)
destroy(this.em_pedido)
destroy(this.st_4)
destroy(this.st_5)
destroy(this.st_peso_linea)
destroy(this.gb_1)
destroy(this.st_2)
destroy(this.em_porcentaje)
destroy(this.gb_2)
destroy(this.st_proforma)
destroy(this.st_6)
destroy(this.st_peso_total)
destroy(this.st_7)
destroy(this.st_tono)
destroy(this.em_tono)
destroy(this.st_calibre)
destroy(this.em_calibre)
destroy(this.cb_ultimo_precio)
destroy(this.st_texto_precio)
destroy(this.st_caja)
destroy(this.uo_caja)
destroy(this.st_calidad)
destroy(this.st_fecha_intr)
destroy(this.em_fecha_intr)
destroy(this.st_1)
destroy(this.st_9)
destroy(this.st_pz)
destroy(this.st_pal)
destroy(this.st_npalet)
destroy(this.em_npal)
destroy(this.st_idioma)
destroy(this.uo_idioma)
destroy(this.uo_calidad)
destroy(this.dw_ultimo_precio)
destroy(this.gb_5)
destroy(this.dw_1)
destroy(this.st_texto_cantidad_facturar)
destroy(this.dw_lineas_clte)
destroy(this.cb_reservas)
destroy(this.dw_pie)
destroy(this.sle_observaciones)
destroy(this.st_8)
destroy(this.st_oc)
destroy(this.uo_familia)
destroy(this.p_1)
destroy(this.st_moneda)
destroy(this.st_10)
destroy(this.st_dto)
destroy(this.st_deposito)
destroy(this.deposito)
destroy(this.em_cantidad_facturar)
destroy(this.st_dto2)
destroy(this.em_descuento2)
destroy(this.em_descuento)
destroy(this.st_texto_cantidad)
destroy(this.st_12)
destroy(this.sle_orden)
destroy(this.st_13)
destroy(this.st_14)
destroy(this.em_tono_imprimir)
destroy(this.em_calibre_imprimir)
destroy(this.st_info_extra)
destroy(this.em_precio)
destroy(this.em_precio_pzs)
destroy(this.em_cantidad)
destroy(this.em_cantidad_en_pzs)
destroy(this.st_observaciones)
destroy(this.dw_detalle)
end on

on ue_f2;call w_int_con_empresa::ue_f2;cb_insertar.TriggerEvent(Clicked!)
end on

event activate;call super::activate;w_int_venliped = ventanas_activas[id_ventana_activa].ventana
end event

type ole_cont_pro from w_int_con_empresa`ole_cont_pro within w_int_venliped
integer taborder = 10
end type

type sle_opcion_orden from w_int_con_empresa`sle_opcion_orden within w_int_venliped
end type

type st_empresa from w_int_con_empresa`st_empresa within w_int_venliped
integer width = 5458
integer height = 88
end type

type gb_6 from groupbox within w_int_venliped
integer x = 1975
integer y = 2724
integer width = 603
integer height = 204
integer textsize = -7
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "Divisa Cliente"
end type

type pb_1 from upb_salir within w_int_venliped
integer x = 5495
integer width = 110
integer height = 104
integer taborder = 0
end type

type st_3 from statictext within w_int_venliped
integer x = 32
integer y = 132
integer width = 78
integer height = 80
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Nº:"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_pallets from statictext within w_int_venliped
integer x = 3154
integer y = 2260
integer width = 210
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Pallets"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_total_cajas from statictext within w_int_venliped
integer x = 3584
integer y = 2260
integer width = 302
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 30593746
boolean enabled = false
string text = "Tot. Cajas"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_cajas from statictext within w_int_venliped
integer x = 3369
integer y = 2260
integer width = 210
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Cajas"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_tipopallet from statictext within w_int_venliped
integer x = 2871
integer y = 2260
integer width = 279
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24076881
boolean enabled = false
string text = "Pallet"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_articulo from statictext within w_int_venliped
integer x = 654
integer y = 2260
integer width = 1266
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Artículo"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_t_pallets from u_em_campo within w_int_venliped
integer x = 3150
integer y = 2332
integer width = 215
integer height = 88
integer taborder = 90
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "##0"
string displaydata = ""
end type

event modificado;call super::modificado;string cadena
long   posi,posi_aux

IF ante_pallets <> Integer(This.text) Then em_mtrs_lineales.text=""

cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                          uo_tipo_pallet.em_codigo.text,&
                          uo_caja.em_codigo.text,&
                          integer(em_t_pallets.text),&
                          0,0, uo_tipolinea.em_codigo.text)
                      

posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if

if f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text) = "1" then
	em_cantidad_facturar.text =  string(f_cantidad_facturar_articulo(codigo_empresa,&
										  uo_articulo.em_codigo.text,&
										  uo_caja.em_codigo.text,&
										  dec(em_cantidad.text)))
end if

f_calculo_precio()

Dec metroscaja
String familia, unidad_articulo
Long n_piezascaja

unidad_articulo = f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text)
n_piezascaja = 0
familia = ""
if not isnull(uo_articulo.em_codigo.text) and uo_articulo.em_codigo.text <> "" and not isnull(uo_caja.em_codigo.text) and uo_caja.em_codigo.text <> "" then
	SELECT  almartcajas.piezascaja, almartcajas.metroscaja, articulos.familia  
	INTO    	:n_piezascaja, :metroscaja, :familia  
	FROM    	almartcajas  INNER JOIN articulos ON almartcajas.empresa = articulos.empresa AND almartcajas.articulo = articulos.codigo  
	WHERE  almartcajas.empresa   = :codigo_empresa
	AND     	almartcajas.articulo  = :uo_articulo.em_codigo.text
	AND     	almartcajas.caja      = :uo_caja.em_codigo.text;
	if isnull(n_piezascaja) then n_piezascaja = 0
	if isnull(metroscaja) then metroscaja = 0
	//metroscaja = round(metroscaja,2)
end if

if not isnull(familia) and familia = '2' or unidad_articulo = '1' then
	if unidad_articulo = "0" then
		if n_piezascaja > 0 and long(em_cantidad.text) > 0 then
			if mod(long(em_cantidad.text), n_piezascaja) <> 0 then
				st_info_extra.text = "ATENCIÓN WOW: Caja INCOMPLETA. Añada +1 en cajas para corregirlo (excepto promoción)."
			else
				st_info_extra.text = ""
			end if
		else
			st_info_extra.text = ""
		end if 
	elseif unidad_articulo = "1" then
		if metroscaja > 0 and dec(em_cantidad.text) > 0 then
			if mod(dec(em_cantidad.text), metroscaja) <> 0 then
				st_info_extra.text = "ATENCIÓN WOW: Caja INCOMPLETA. Añada +1 en cajas para corregirlo (excepto promoción)."
			else
				st_info_extra.text = ""
			end if
		else
			st_info_extra.text = ""
		end if 
	end if
else
	st_info_extra.text = ""
end if

Dec n_cajaspallet, t_cajas
n_cajaspallet = 0
t_cajas = dec(em_t_cajas.text)

SELECT    palarticulo.cajaspallet INTO :n_cajaspallet FROM palarticulo
WHERE    palarticulo.empresa  = :codigo_empresa 
AND      palarticulo.articulo = :uo_articulo.em_codigo.text
AND      palarticulo.codigo   = :uo_tipo_pallet.em_codigo.text 
AND      palarticulo.caja     = :uo_caja.em_codigo.text;
if not isnull(n_cajaspallet) and n_cajaspallet > 0 and t_cajas > 0 and not isnull(familia) and familia = '2' then
	if mod(t_cajas, n_cajaspallet) <> 0 then
		if st_info_extra.text = "" then
			st_info_extra.text = "ATENCIÓN WOW: "
		end if
		st_info_extra.text = st_info_extra.text + "Pallet INCOMPLETO."
	end if
end if 

em_situacion.text = "F"

end event

event getfocus;call super::getfocus;ante_pallets = Integer(This.text)
campo_actual = "PALLETS"
f_peso_linea()
end event

type em_cajas from u_em_campo within w_int_venliped
integer x = 3365
integer y = 2332
integer width = 215
integer height = 88
integer taborder = 100
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "###,###"
end type

event modificado;call super::modificado;string cadena
long   posi,posi_aux

IF ante_cajas <> Integer(This.text) Then em_mtrs_lineales.text=""

cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                          uo_tipo_pallet.em_codigo.text,&
                          uo_caja.em_codigo.text,&								  
                           0,&
                           integer(em_cajas.text),&
                           0, uo_tipolinea.em_codigo.text)
                      
posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if

if f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text) = "1" then
	em_cantidad_facturar.text =  string(f_cantidad_facturar_articulo(codigo_empresa,&
										  uo_articulo.em_codigo.text,&
										  uo_caja.em_codigo.text,&
										  dec(em_cantidad.text)))
end if

f_calculo_precio()

Dec metroscaja
String familia, unidad_articulo
Long n_piezascaja

unidad_articulo = f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text)
n_piezascaja = 0
familia = ""
if not isnull(uo_articulo.em_codigo.text) and uo_articulo.em_codigo.text <> "" and not isnull(uo_caja.em_codigo.text) and uo_caja.em_codigo.text <> "" then
	SELECT  almartcajas.piezascaja, almartcajas.metroscaja, articulos.familia  
	INTO    	:n_piezascaja, :metroscaja, :familia  
	FROM    	almartcajas  INNER JOIN articulos ON almartcajas.empresa = articulos.empresa AND almartcajas.articulo = articulos.codigo  
	WHERE  almartcajas.empresa   = :codigo_empresa
	AND     	almartcajas.articulo  = :uo_articulo.em_codigo.text
	AND     	almartcajas.caja      = :uo_caja.em_codigo.text;
	if isnull(n_piezascaja) then n_piezascaja = 0
	if isnull(metroscaja) then metroscaja = 0
	//metroscaja = round(metroscaja,2)
end if

if not isnull(familia) and familia = '2' or unidad_articulo = '1' then
	if unidad_articulo = "0" then
		if n_piezascaja > 0 and long(em_cantidad.text) > 0 then
			if mod(long(em_cantidad.text), n_piezascaja) <> 0 then
				st_info_extra.text = "ATENCIÓN WOW: Caja INCOMPLETA. Añada +1 en cajas para corregirlo (excepto promoción)."
			else
				st_info_extra.text = ""
			end if
		else
			st_info_extra.text = ""
		end if 
	elseif unidad_articulo = "1" then
		if metroscaja > 0 and dec(em_cantidad.text) > 0 then
			if mod(dec(em_cantidad.text), metroscaja) <> 0 then
				st_info_extra.text = "ATENCIÓN WOW: Caja INCOMPLETA. Añada +1 en cajas para corregirlo (excepto promoción)."
			else
				st_info_extra.text = ""
			end if
		else
			st_info_extra.text = ""
		end if 
	end if
else
	st_info_extra.text = ""
end if

Dec n_cajaspallet, t_cajas
n_cajaspallet = 0
t_cajas = dec(em_t_cajas.text)

SELECT    palarticulo.cajaspallet INTO :n_cajaspallet FROM palarticulo
WHERE    palarticulo.empresa  = :codigo_empresa 
AND      palarticulo.articulo = :uo_articulo.em_codigo.text
AND      palarticulo.codigo   = :uo_tipo_pallet.em_codigo.text 
AND      palarticulo.caja     = :uo_caja.em_codigo.text;
if not isnull(n_cajaspallet) and n_cajaspallet > 0 and t_cajas > 0 and not isnull(familia) and familia = '2' then
	if mod(t_cajas, n_cajaspallet) <> 0 then
		if st_info_extra.text = "" then
			st_info_extra.text = "ATENCIÓN WOW: "
		end if
		st_info_extra.text = st_info_extra.text + "Pallet INCOMPLETO."
	end if
end if 

em_situacion.text = "F"

end event

event getfocus;call super::getfocus;ante_cajas = Integer(This.text)
campo_actual = "CAJAS"
f_peso_linea()
end event

type em_t_cajas from u_em_campo within w_int_venliped
integer x = 3584
integer y = 2332
integer width = 302
integer height = 88
integer taborder = 0
fontcharset fontcharset = ansi!
string facename = "Arial"
boolean enabled = false
alignment alignment = right!
boolean displayonly = true
maskdatatype maskdatatype = numericmask!
string mask = "###,###"
end type

type uo_articulo from u_em_campo_2 within w_int_venliped
integer x = 649
integer y = 2332
integer width = 1266
integer height = 88
integer taborder = 30
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;String var_empresa,codigo_articulo,texto_unidad,des,desc2, articulo, pallet, caja
string cod_tono,cod_calibre,var_cli_art, v_bloqueado, obs_articulo
dec var_linea
Long   total_desc
datetime fecha_anulado
integer nivel
string observaciones,ls_promocion,ls_ventipolin_codigo_por_defecto

nivel = 0
articulo = uo_articulo.em_codigo.text
if dw_detalle.GetRow() > 0 then
	var_linea= dw_detalle.getItemNumber(dw_detalle.GetRow(),"linea")
else
	var_linea = 0
end if

select descripcion, 
		 familia, 
		 promocion,
		 isnull(ventipolin_codigo_por_defecto,'')
into   :uo_articulo.em_campo.text, 
		 :uo_familia.em_codigo.text,
		 :ls_promocion,
		 :ls_ventipolin_codigo_por_defecto
from  articulos
where empresa = :codigo_empresa
and   codigo  = :articulo;

if ls_ventipolin_codigo_por_defecto <> '' then
	if uo_tipolinea.em_codigo.text <> ls_ventipolin_codigo_por_defecto then
		uo_tipolinea.em_codigo.text = ls_ventipolin_codigo_por_defecto
		uo_tipolinea.event modificado(0,0)
	end if	
end if
//if ls_promocion = 'S' and uo_tipolinea.em_codigo.text <> "4" then
//	uo_tipolinea.em_codigo.text = "4"
//	uo_tipolinea.event modificado(0,0)
//end if

uo_familia.event modificado(0,0) //triggerevent("modificado")

////////////////////////////////////  CONTROLAMOS SI EL ARTICULO ESTA BLOQUEADO Y ANULADO /////////////////////////////////////////////////////
select bloqueado, fecha_anulado, cuenta
into :v_bloqueado, :fecha_anulado, :obs_articulo
from articulos
where codigo =  :articulo
and empresa = :codigo_empresa;

if v_bloqueado = 'S' then
	messagebox ("Aviso", "No se puede pasar pedido. El articulo está bloqueado")
	 f_activar_campo(uo_articulo.em_campo)
	 uo_articulo.em_campo.text=""
	 uo_articulo.em_codigo.text=""
	return 0;
end if

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Controlamos si el artículo tiene alguna observación.
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
select articulos.observaciones
into :observaciones
from articulos
where articulos.empresa = :codigo_empresa
and articulos.codigo = :articulo;

if isnull(observaciones) then observaciones = ''

if observaciones <> "" then
	st_observaciones.text = observaciones
	st_observaciones.visible = true
else
	st_observaciones.text = ''
	st_observaciones.visible = false
	
end if

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Fin de: Controlamos si el artículo tiene alguna observación.
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


if tipo="I" and acceso="0" and impreso="S" then
    f_mensaje("! A t e n c i ó n ¡","Este pedido está impreso, usted no tiene acceso a insertar líneas.")
	 uo_articulo.em_campo.text=""
	 uo_articulo.em_codigo.text=""
	 f_activar_campo(uo_articulo.em_campo)
	 Return 0
End if	
var_cli_art = f_cliente_articulo(codigo_empresa, articulo)
if var_cli_art = "" or var_cli_art = venped.cliente then
	SELECT articulos.descripcion,articulos.familia ,articulos.formato,articulos.unidad,articulos.sector
	INTO :des,:cod_familia,:cod_formato,:cod_tipo_unidad,:var_sector
	FROM articulos  
	WHERE articulos.empresa = :codigo_empresa
	AND   articulos.codigo  = :articulo;
	
	//if uo_tipolinea.em_codigo.text = "4" then cod_tipo_unidad = "0"  //MUY IMPORTANTE: LAS MUESTRAS SIEMPRE VAN EN PIEZAS. TAMBIÉN CONTROLADO EN f_calculo_unidades_tipolin

	//if ib_gestionar_en_piezas then cod_tipo_unidad = "0"			
				
	mov.empresa = codigo_empresa
	mov.articulo = articulo
	desc2=f_descripcion_almcliartdesc(codigo_empresa,venped.cliente,articulo)
	if desc2<>'' then
		uo_articulo.em_campo.text=desc2
	else		
		uo_articulo.em_campo.text=des
	end if
	
	select count(descripcion)
	into :total_desc
	from almcliartdesc
	where empresa=:codigo_empresa and
			cliente=:venped.cliente and
			articulo=:articulo
	group by empresa,cliente,articulo;
	
	if isnull(total_desc) then total_desc = 0
	
	if total_desc >= 1 then
		uo_idioma.em_codigo.text = "1"
		uo_idioma.em_campo.text = "1"
		if total_desc = 1 then
			uo_idioma.em_codigo.enabled = FALSE
		else
			uo_idioma.em_codigo.enabled = TRUE
		end if
	end if
	if total_desc = 0 then
		uo_idioma.em_codigo.text = "0"
		uo_idioma.em_campo.text = "0"
		uo_idioma.em_codigo.enabled = FALSE
	end if
	
  em_descuento.text = "0"
  em_descuento2.text = '0'
  em_cajas.text            = ""
  em_cantidad.text         = ""
  em_cantidad_en_pzs.text  = ""
  em_mtrs_lineales.text    = ""
  em_t_cajas.text          = ""
  em_t_pallets.text        = ""
  uo_calidad.em_campo.text = ""
  em_precio.text           = ""
  em_precio_pzs.text       = ""
  uo_calidad.em_codigo.text= ""
  uo_tipo_pallet.em_campo.text= ""
  uo_tipo_pallet.em_codigo.text= ""
  uo_caja.em_campo.text = ""
  uo_caja.em_codigo.text = ""
  em_descripcion.text = uo_articulo.em_campo.text
	
  IF Trim(uo_articulo.em_campo.text)="" THEN 
	 IF Trim(uo_articulo.em_codigo.text)<>"" Then
		 uo_articulo.em_campo.text=""
		 uo_articulo.em_codigo.text=""
		 f_activar_campo(uo_articulo.em_campo)
		 Return 0
	 End if
	END IF		
	
	codigo_articulo=uo_articulo.em_codigo.text
	IF var_sector = "S" Then
	IF len(Trim(uo_articulo.em_codigo.text))<> 0 and uo_tipo_pallet.em_codigo.text = "" Then
		//uo_tipo_pallet.em_codigo.text = f_pallet_palarticulo_cliente(codigo_empresa,articulo,em_cliente.text)
		caja = ""
		pallet = ftc_pallet_articulo(codigo_empresa,articulo,caja)
		if caja = ftc_caja_articulo(codigo_empresa, articulo) then //CAJA POR DEFECTO o COINCIDE CON CAJA DE PALLET POR DEFECTO
			uo_tipo_pallet.em_codigo.text = pallet
			uo_tipo_pallet.em_campo.text  = f_nombre_pallet_abr(codigo_empresa,pallet)
			uo_caja.em_codigo.text = ftc_caja_articulo(codigo_empresa, articulo)
			uo_caja.event modificado(0,0)
			//uo_caja.em_campo.text = f_nombre_almartcaja_abr(codigo_empresa, articulo, caja)
		end if
	END IF
	END IF
	
	uo_calidad.em_codigo.text    = f_calidad_venparametros(codigo_empresa)
	uo_calidad.em_campo.text     = f_nombre_calidad_abr(codigo_empresa,uo_calidad.em_codigo.text)
	uo_calidad.ue_valor_anterior = uo_calidad.em_campo.text
	
	if ib_gestionar_en_piezas then
		st_texto_cantidad.text = "Piezas"
	else
		st_texto_cantidad.text = f_nombre_unidad(cod_tipo_unidad)
	end if
	
	em_cantidad.Setmask(DecimalMask!,f_mascara_unidad(cod_tipo_unidad))
	em_cantidad_facturar.Setmask(DecimalMask!,f_mascara_unidad(cod_tipo_unidad))
	
	f_campos_segun_tiplin()
	
	IF var_total <> 0  and Not IsNUll(var_total) Then
		st_peso_total.text = String(var_total,"###,###,###")
	ELse
		f_peso_linea()
	END IF
	
	if lparam <> 1 then
		f_calculo_precio()
	end if
	
	f_deposito()
	
	st_articulo.text = "Artículo " + f_nombre_formato_abr (codigo_empresa,cod_formato)
else
    f_mensaje("! A t e n c i ó n ¡","El artículo seleccionado no puede ser vendido a este cliente")
	 uo_articulo.em_campo.text=""
	 uo_articulo.em_codigo.text=""
	 f_activar_campo(uo_articulo.em_campo)	
	 return 0
end if


if f_facturar_metros_reales_venped(codigo_empresa,venped.anyo,venped.pedido) = "S" then
	if f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text) = "1" then
		em_cantidad_facturar.text          = "0"
		em_cantidad_facturar.visible       = true
		st_texto_cantidad_facturar.visible = true
	else
		em_cantidad_facturar.visible       = false
		st_texto_cantidad_facturar.visible = false
	end if
end if


////ORDEN DE CARGA
//if ftc_linea_en_orden_carga(Dec(em_anyo.text),Dec(em_pedido.text),var_linea) and tipo <> "I" then
//	st_oc.text = "LÍNEA EN ORDEN DE CARGA."
//	cb_grabar.enabled = false
//else
//	st_oc.text = ""
//	cb_grabar.enabled = true
//end if

f_control_tono_calibre()
f_con_stock_articulo()

em_situacion.text = "F"

if uo_articulo.em_campo.text <> "" then
	Int decimales 
	String mascara
	decimales = ftc_decimales_articulo(codigo_empresa, uo_articulo.em_codigo.text)
	if decimales > 0 then
		mascara = "###,##0."+fill("0",decimales)
	else
		mascara = "###,##0"
	end if
	em_cantidad.Setmask(DecimalMask!,mascara)
end if


end event

event getfocus;call super::getfocus;// para controlar valor anterior
articulo_ant = uo_articulo.em_codigo.text


ue_titulo     = "Ayuda seleccion de articulos"
ue_datawindow = "dw_ayuda_articulos"
ue_filtro     = "isnull(articulos_fecha_anulado)"  //"cliente = '"+venped.cliente+"' or isnull(cliente)"
ue_filtro     = " articulos_uso = '3' "
f_botones()

campo_actual = "ARTICULO"

/*
// para controlar valor anterior
  articulo_ant = uo_articulo.em_codigo.text


ue_titulo     = "Ayuda seleccion de articulos"
ue_datawindow = "dw_ayuda_articulos_almcliartdesc"
//ue_filtro     = "(cliente = '"+venped.cliente+"' or isnull(cliente) ) "+&
//					 " and almcliartdesc_cliente = '"+venped.cliente+"' or "+&
//					 " isnull(almcliartdesc_cliente) "
//ue_filtro     = "( cliente = '"+venped.cliente+"' or isnull(cliente) ) "


f_botones()

campo_actual = "ARTICULO"

return 0

*/
end event

event losefocus;call super::losefocus;IF Trim(This.em_codigo.text) <> "" Then
  cb_reservas.enabled = TRUE
  cb_stock.enabled    = TRUE
ELSE
  cb_reservas.enabled = FALSE
  cb_stock.enabled    = FALSE
END IF

/*
		
IF Trim(This.em_codigo.text) <> "" Then
  cb_reservas.enabled = TRUE
  cb_stock.enabled    = TRUE
ELSE
  cb_reservas.enabled = FALSE
  cb_stock.enabled    = FALSE
End if


return 0	
*/
end event

on uo_articulo.destroy
call u_em_campo_2::destroy
end on

event busqueda;call super::busqueda;/*
String consulta_busqueda, prueba
str_wt_busquedas_entrada busqueda
str_wt_busquedas_salida resultado
Int numero_valores

consulta_busqueda =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE articulos.empresa = '"+codigo_empresa+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"articulos.uso = '3' AND "+&
							"(genter.codigo IS NULL OR genter.codigo = '"+venped.cliente+"' AND genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
//"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							//

busqueda.consulta = consulta_busqueda
busqueda.titulos[1] = "Código"
busqueda.titulos[2] = "Descripción"
busqueda.titulos[3] = "Formato"
busqueda.titulos[4] = "Uso"
busqueda.titulos[5] = "Cliente"
This.em_codigo.text = Trim(ue_valor)
This.em_campo.text  = ""
IF not isnull(This.em_codigo.text) and This.em_codigo.text <> "" THEN
	busqueda.filtro = This.em_codigo.text
	if Long(This.em_codigo.text) = 0 then
		//Es texto
		//busqueda.filtro = this.text
		busqueda.filtro_es_codigo = false
	else
		//Es código
		busqueda.filtro_es_codigo = true
	end if
END IF
OpenWithParm(wt_busquedas, busqueda)
resultado = Message.PowerObjectParm
if resultado.resultado = -1 then
	MessageBox("Error en la creación de la búsqueda",resultado.error)
	return
elseif resultado.resultado > 0 then
	uo_articulo.em_codigo.text = resultado.valores[1]
	uo_articulo.ue_campo.Text = resultado.valores[2]
end if
This.TriggerEvent("modificado")
ue_valor_anterior = Trim(em_campo.text)
ue_campo.SelectText(1,Len(trim(ue_campo.Text)))
return 0
*/



end event

type uo_tipo_pallet from u_em_campo_2 within w_int_venliped
integer x = 2866
integer y = 2332
integer width = 279
integer height = 88
integer taborder = 80
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;uo_tipo_pallet.em_campo.text=f_nombre_palarticulocaja_abr(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text,uo_caja.em_codigo.text)
st_pal.text = string(f_cajas_pallet_articulo(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text,uo_caja.em_codigo.text),"###,###")
IF Trim(uo_tipo_pallet.em_campo.text)=""  or IsNull(uo_tipo_pallet.em_campo.text)THEN 
 IF Trim(uo_tipo_pallet.em_codigo.text)<>"" Then 
   uo_tipo_pallet.em_campo.SetFocus()
 END IF
 uo_tipo_pallet.em_campo.text=""
 uo_tipo_pallet.em_codigo.text=""
END IF

f_peso_linea()

em_situacion.text = "F"
end event

event getfocus;call super::getfocus;ue_titulo     = "Ayuda seleccion de pallets"
ue_datawindow = "dw_ayuda_palarticulo_abr"
//ue_filtro     = "(palarticulo_articulo = '" + uo_articulo.em_codigo.text+ "') and "+&
//                "(palarticulo_caja = '" + uo_caja.em_codigo.text + "')" +" and palarticulo_pordefecto = 'S' "
ue_filtro     = "(palarticulo_articulo = '" + uo_articulo.em_codigo.text+ "') and "+&
                "(palarticulo_caja = '" + uo_caja.em_codigo.text + "')"
campo_actual = "TIPO_PALLET"





end event

on uo_tipo_pallet.destroy
call u_em_campo_2::destroy
end on

type st_texto_mtrslinieales from statictext within w_int_venliped
string tag = "Metros Lineales"
integer x = 3895
integer y = 2260
integer width = 229
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "M.Lin."
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_mtrs_lineales from u_em_campo within w_int_venliped
integer x = 3895
integer y = 2332
integer width = 229
integer height = 88
integer taborder = 110
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
boolean displayonly = true
maskdatatype maskdatatype = decimalmask!
string mask = "###,###.0"
end type

event getfocus;call super::getfocus;campo_actual = "METROS_LINEALES"
f_peso_linea()

end event

event modificado;call super::modificado;em_situacion.text = "F"

/*
If Dec(em_mtrs_lineales.text)=0 THEN Return
 em_cajas.text=""
 em_t_cajas.text=""
 em_t_pallets.text=""
 string cadena
 cadena=f_calculo_unidades_lineales(codigo_empresa,uo_articulo.em_codigo.text,&
                            uo_tipo_pallet.em_codigo.text,&
                            uo_caja.em_codigo.text,&									 
                            Dec(em_mtrs_lineales.text))
                       
 em_t_pallets.text  =Mid(cadena,1,6)
 em_cajas.text      =Mid(cadena,7,6)
 em_t_cajas.text    =Mid(cadena,13,6)
 em_cantidad.text   =Mid(cadena,19,9)
 em_mtrs_lineales.text   =Mid(cadena,28,9)
 f_calculo_precio()

Dec metroscaja
String familia, unidad_articulo
Long n_piezascaja

unidad_articulo = f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text)
n_piezascaja = 0
familia = ""
if not isnull(uo_articulo.em_codigo.text) and uo_articulo.em_codigo.text <> "" and not isnull(uo_caja.em_codigo.text) and uo_caja.em_codigo.text <> "" then
	SELECT  almartcajas.piezascaja, almartcajas.metroscaja, articulos.familia  
	INTO    	:n_piezascaja, :metroscaja, :familia  
	FROM    	almartcajas  INNER JOIN articulos ON almartcajas.empresa = articulos.empresa AND almartcajas.articulo = articulos.codigo  
	WHERE  almartcajas.empresa   = :codigo_empresa
	AND     	almartcajas.articulo  = :uo_articulo.em_codigo.text
	AND     	almartcajas.caja      = :uo_caja.em_codigo.text;
	if isnull(n_piezascaja) then n_piezascaja = 0
	if isnull(metroscaja) then metroscaja = 0
	//metroscaja = round(metroscaja,2)
end if

if not isnull(familia) and familia = '2' or unidad_articulo = '1' then
	if unidad_articulo = "0" then
		if n_piezascaja > 0 and long(em_cantidad.text) > 0 then
			if mod(long(em_cantidad.text), n_piezascaja) <> 0 then
				st_info_extra.text = "ATENCIÓN WOW: Caja INCOMPLETA. Añada +1 en cajas para corregirlo (excepto promoción)."
			else
				st_info_extra.text = ""
			end if
		else
			st_info_extra.text = ""
		end if 
	elseif unidad_articulo = "1" then
		if metroscaja > 0 and dec(em_cantidad.text) > 0 then
			if mod(dec(em_cantidad.text), metroscaja) <> 0 then
				st_info_extra.text = "ATENCIÓN WOW: Caja INCOMPLETA. Añada +1 en cajas para corregirlo (excepto promoción)."
			else
				st_info_extra.text = ""
			end if
		else
			st_info_extra.text = ""
		end if 
	end if
else
	st_info_extra.text = ""
end if

Dec n_cajaspallet, t_cajas
n_cajaspallet = 0
t_cajas = dec(em_t_cajas.text)

SELECT    palarticulo.cajaspallet INTO :n_cajaspallet FROM palarticulo
WHERE    palarticulo.empresa  = :codigo_empresa 
AND      palarticulo.articulo = :uo_articulo.em_codigo.text
AND      palarticulo.codigo   = :uo_tipo_pallet.em_codigo.text 
AND      palarticulo.caja     = :uo_caja.em_codigo.text;
if not isnull(n_cajaspallet) and n_cajaspallet > 0 and t_cajas > 0 and not isnull(familia) and familia = '2' then
	if mod(t_cajas, n_cajaspallet) <> 0 then
		if st_info_extra.text = "" then
			st_info_extra.text = "ATENCIÓN WOW: "
		end if
		st_info_extra.text = st_info_extra.text + "Pallet INCOMPLETO."
	end if
end if 


*/
end event

type em_cliente from u_em_campo within w_int_venliped
integer x = 1074
integer y = 132
integer width = 274
integer height = 76
integer taborder = 0
long textcolor = 128
boolean enabled = false
boolean border = false
alignment alignment = center!
boolean displayonly = true
borderstyle borderstyle = stylebox!
maskdatatype maskdatatype = numericmask!
string mask = "######"
end type

type st_nombre_cliente from statictext within w_int_venliped
integer x = 1390
integer y = 132
integer width = 2363
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
boolean focusrectangle = false
end type

type cb_grabar from u_boton within w_int_venliped
integer x = 1079
integer y = 2684
integer width = 421
integer height = 96
integer taborder = 0
integer weight = 400
fontcharset fontcharset = ansi!
string text = "F3 Grabar  "
end type

event clicked;Dec{0}  var_anyo,var_pedido
String  art,condicion_nueva,cadena,mascara,es_pico, familia
String  motivo,controles,referencia,condicion,tipo_unidad,texto,acumular,condicion2, var_observaciones
Integer opcion,var_linea_acumulado,var_lineas
dec{2}  var_conjunto,diferencia,piezas_caja,dife,var_precio1,var_precio2
Dec{4}  var_precio,disponible,disponible2,cant_bloqueo
dec{6}  metros_pallet
long var_linea_acumulado_n,posi,posi_aux,ll_lineas_del_articulo_ya_grabadas
Dec dto, dto2, v_pre,ld_total_cantidad_pedida
String articulo, codigo_pallet,ls_tono,ls_nueva_situacion
boolean lb_control_reservas_pedido_completo = false
EditMask campo
tipo_array arg

// Si el artículo lleva tono, obligará a ponerlo
string v_tono, v_calibre, mensaje

DEC  cantidad,piezas_pallet,resto
long cantidad_pzs
INT decimales_unidad,li_calibre
BOOLEAN FIN = FALSE
STRING V_SEPARAR_BULTOS, V_SEPARAR_INCOMPLETOS

long ll_total_cantidad_pedida_pzs,ll_disponible_pzs,ll_ante_existencias_pzs,ll_cant_bloqueo_pzs

piezas_pallet = f_piezas_por_pallet(uo_articulo.em_codigo.text, uo_caja.em_codigo.text, uo_tipo_pallet.em_codigo.text)
metros_pallet = f_metros_por_pallet(uo_articulo.em_codigo.text, uo_caja.em_codigo.text, uo_tipo_pallet.em_codigo.text)

tipo_unidad = f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text)	
decimales_unidad = ftc_decimales_articulo(codigo_empresa, uo_articulo.em_codigo.text)	
//if uo_tipolinea.em_codigo.text = "4" then tipo_unidad = "0" //MUY IMPORTANTE - La promoción siempre va en piezas *************************************************************

//Esto lo cambiamos todo 
//if tipo_unidad = "1" then //SACAMOS METROS POR PALLET PARA SEPARAR POR BULTOS CORRECTAMENTE
//	piezas_pallet = round(f_cajaspallet_palarticulo(codigo_empresa, uo_articulo.em_codigo.text, uo_tipo_pallet.em_codigo.text, uo_caja.em_codigo.text) * f_metroscaja_articulo(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text),decimales_unidad)
//end if

select isnull(venclientes.separar_bultos,''),
       isnull(venclientes.separar_incompletos,'')
into  :v_separar_bultos,
      :v_separar_incompletos
from  venclientes
where venclientes.empresa = :codigo_empresa
and   venclientes.codigo  = :em_cliente.text;

v_separar_incompletos = 'S'

if piezas_pallet = 0 then
	//Si no tenemos piezas_pallet no dividimos ni bultos ni incompletos
	v_separar_bultos      = 'N'
	v_separar_incompletos = 'N'
end if

codigo_pallet = uo_tipo_pallet.em_codigo.text

cantidad     = dec(em_cantidad.text)
cantidad_pzs = long(em_cantidad_en_pzs.text)
	
//Vamos a comprobar si tenemos suficiente stock para asignar al pedido	
	
art = uo_articulo.em_codigo.text
IF IsNUll(art) Then art = ""
ls_tono     = Trim(em_tono.text)
li_calibre = Dec(em_calibre.text)
		
mascara        = f_mascara_moneda(venped.divisa)
var_anyo       = Dec(em_anyo.text)
var_pedido     = Dec(em_pedido.text)
var_precio     = Dec(em_precio.text)

string ls_articulos_promocion

select isnull(articulos.tono,'') , isnull(articulos.calibre,'') , isnull(articulos.familia,'') , isnull(articulos.promocion,'') 
into  :v_tono, :v_calibre, :familia, :ls_articulos_promocion
from  articulos
where articulos.empresa = :codigo_empresa
and   articulos.codigo = :uo_articulo.em_codigo.text;

IF trim(uo_familia.em_codigo.text)="" THEN 
	mensaje="Introduzca la familia"
	MessageBox("Campo obligatorio",mensaje,Exclamation!,OK!,1)
	uo_familia.SetFocus()
	RETURN
end if

IF v_tono = 'S' Then
//	IF trim(em_tono.text)="" and familia <> "2" THEN //En WOW existen tonos, pero se indican al preparar el pedido y expedir
//		mensaje="Introduzca el tono"
//		MessageBox("Campo obligatorio",mensaje,Exclamation!,OK!,1)
//		em_tono.SetFocus()
//		RETURN
//	END IF
ELSE
	IF trim(em_tono.text) <> "" THEN
		mensaje="El artículo no tiene gestión de tonos."
		MessageBox("Campo obligatorio",mensaje,Exclamation!,OK!,1)
		em_tono.SetFocus()
		em_tono.text = ''
		RETURN
	END IF
END IF
	
IF v_calibre = 'S' Then
//	IF trim(em_calibre.text)="" or trim(em_calibre.text)='0' THEN
//		mensaje="Introduzca el calibre"
//		MessageBox("Atención",mensaje,Exclamation!,OK!,1)
//		em_calibre.SetFocus()
//		RETURN
//	END IF
ELSE
	IF trim(em_calibre.text) <> "" and trim(em_calibre.text) <> "0" THEN
		mensaje="El artículo no tiene gestión de calibres."
		MessageBox("Atención",mensaje,Exclamation!,OK!,1)
		em_calibre.SetFocus()
		em_calibre.text = ''
		RETURN
	END IF
	
END IF

if f_articulos_tono_cliente(codigo_empresa,uo_articulo.em_codigo.text) = 'S' and trim(em_tono_imprimir.text) = '' then
	mensaje="El artículo tiene obligacion de tono de cliente."
	MessageBox("Atención",mensaje,Exclamation!,OK!,1)
	em_tono_imprimir.SetFocus()
	RETURN	
end if

if f_articulos_calibre_cliente(codigo_empresa,uo_articulo.em_codigo.text) = 'S' and trim(em_calibre_imprimir.text) = '' then
	mensaje="El artículo tiene obligacion de calibre de cliente."
	MessageBox("Atención",mensaje,Exclamation!,OK!,1)
	em_calibre_imprimir.SetFocus()
	RETURN	
end if

IF Trim(uo_tipolinea.em_codigo.text) = "" or Trim(uo_tipolinea.em_campo.text)= ""  Then
  campo   = uo_tipolinea.em_campo
  motivo  = "(Campo Obligatorio) Introduzca el tipo de linea"
  controles = "S"
END IF

IF var_control_alm ="S"  and var_sector = "S" THEN
	//uo_tipo_pallet.TriggerEvent("modificado")
	IF TRIM(uo_tipo_pallet.em_campo.text)="" or IsNull(uo_tipo_pallet.em_campo.text) Then
		campo=uo_tipo_pallet.em_campo
		motivo= "(Campo Obligatorio) Introduzca el tipo de pallet"
		controles="S"
	END IF
END IF

IF (Dec(em_cantidad.text) = 0  or IsNull(em_cantidad.text)) and (Dec(em_cantidad_en_pzs.text) = 0  or IsNull(em_cantidad.text)) Then
	
	motivo    = "(Campo Obligatorio) Introduzca la cantidad"
	controles = "S"
	
	if ib_gestionar_en_piezas then
		campo = em_cantidad_en_pzs	
	else
		campo = em_cantidad
	end if
END IF

IF var_control_alm ="S" and var_sector ="S" THEN
	IF Trim(uo_calidad.em_codigo.text) = ""  or IsNull(art) Then
		campo=uo_calidad.em_campo
		motivo= "(Campo Obligatorio) Introduzca la calidad"
		controles="S"
	END IF
END IF

IF var_control_alm = "S" THEN
	IF Trim(art) = ""  or IsNull(art) Then
		campo=uo_articulo.em_campo
		motivo= "(Campo Obligatorio) Introduzca el articulo"
		controles="S"
	END IF
	
	// Control piezas por conjunto
	var_conjunto= f_conjunto_articulo(codigo_empresa,art)
	IF var_conjunto<> 0 And Not IsNULL(var_conjunto) Then
		IF (Dec(String(Dec(em_cantidad.text)/var_conjunto,"##########")) * var_conjunto) <> Dec(em_cantidad.text) Then
			 motivo= "Cantidad no válida. Este artículo va por conjuntos la cantidad a de ser múltiplo de: " + String(var_conjunto,"##")
			 controles="S"
			 campo= em_cantidad
		END IF
	END IF
END IF

IF Trim(em_descripcion.text) = ""  or IsNull(em_descripcion.text) Then
	campo=em_descripcion
	motivo= "(Campo Obligatorio) Introduzca la descripción del artículo"
	controles="S"
END IF

IF controles="S" THEN
	 MessageBox("No se puede grabar la linea",motivo,Exclamation!, OK!,1)
	 f_activar_campo(campo)
	 Return
END IF

// Control clase de venta
var_clase = "V"

IF (var_control_alm = "S" or  uo_tipolinea.em_codigo.text = "7" ) and ( (dec(em_precio.text) = 0  or IsNull(em_precio.text)) and (dec(em_precio_pzs.text) = 0  or IsNull(em_precio_pzs.text)) ) Then
	// V-> Venta (típica)
	// M-> Muestras sin precio
	// S-> Ventas sin cargo
	// P-> Precio pendiente
	
	if uo_tipolinea.em_codigo.text = "4" then
		//El tipo de linea 4 es muestras wow
		var_clase ="M"
	else	
		campo=em_precio
		motivo= "(Campo Obligatorio) Introduzca el precio"
		controles="S"
		arg.valor[1]  = "Linea de pedido Sin precio"
		arg.valor[11] = "Muestras"
		arg.valor[12] = "Sin Cargo"
		arg.valor[13] = "Precio Pdte." 
		arg.valor[14] = "Cancelar" 
		opcion = f_opciones(arg)
		CHOOSE CASE opcion
			CASE 1
				var_clase ="M"
			CASE 2
				var_clase ="S"
			CASE 3
				var_clase ="P"
			CASE 4
				 f_activar_campo(em_precio)
				 Return
		END CHOOSE
	end if
END IF

IF var_control_alm = "S" and var_situacion <> "P" THEN
	if ls_articulos_promocion = 'S' or uo_tipolinea.em_codigo.text = is_tipolinea_promocion then
		if venped.es_proforma <> "N" then
			em_situacion.text = "F"
		else
			if tipo = 'M' then
				//Lineas modificadas siempre situacion igual a la anterior
			else
				//Lineas nuevas siempre situacion F
				em_situacion.text = "F"
			end if
		end if		
	else
		if lb_control_reservas_pedido_completo then
			//Vamos a comprobar el total de cantidad pedida
			if tipo = 'M' then
				select isnull(sum(venliped.cantidad),0),
						 isnull(count(*),0) 
				into   :ld_total_cantidad_pedida,
						 :ll_lineas_del_articulo_ya_grabadas
				from   venliped
				where  venliped.empresa     = :codigo_empresa
				and    venliped.anyo        = :var_anyo
				and    venliped.pedido      = :var_pedido
				and    venliped.linea      <> :linea_pedido
				and    venliped.situacion  <> 'P'
				and    venliped.articulo    = :uo_articulo.em_codigo.text
				and    venliped.calidad     = :uo_calidad.em_codigo.text
				and    venliped.tonochar    = :ls_tono
				and    venliped.calibre     = :li_calibre
				and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
				and    venliped.caja        = :uo_caja.em_codigo.text;	
				
				//
				SELECT sum( case when ventipolin.gestionar_en_piezas = 'S' then venliped.cantidad_pzs else case when articulos.unidad = '1' then ( venliped.cantidad / almartcajas.metroscaja ) * almartcajas.piezascaja else venliped.cantidad end end ) as cantidad_pzs, 
						 isnull(count(*),0) 
				into   :ll_total_cantidad_pedida_pzs,
						 :ll_lineas_del_articulo_ya_grabadas			
				FROM   venliped,
						 ventipolin, 
						 articulos, 
						 almartcajas 
				WHERE ( venliped.empresa   = ventipolin.empresa ) 
				AND   ( venliped.tipolinea = ventipolin.codigo ) 
				AND   ( venliped.empresa   = articulos.empresa ) 
				AND   ( venliped.articulo  = articulos.codigo ) 
				AND   ( venliped.empresa   = almartcajas.empresa ) 
				AND   ( venliped.articulo  = almartcajas.articulo ) 
				AND   ( venliped.caja      = almartcajas.caja ) 
				AND    venliped.empresa     = :codigo_empresa
				AND    venliped.anyo        = :var_anyo
				AND    venliped.pedido      = :var_pedido
				AND    venliped.linea      <> :linea_pedido
				AND    venliped.situacion  <> 'P'
				AND    venliped.articulo    = :uo_articulo.em_codigo.text
				AND    venliped.calidad     = :uo_calidad.em_codigo.text
				AND    venliped.tonochar    = :ls_tono
				AND    venliped.calibre     = :li_calibre
				AND    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
				AND    venliped.caja        = :uo_caja.em_codigo.text;				
				//
			else
				select isnull(sum(venliped.cantidad),0),
						 isnull(count(*),0) 
				into   :ld_total_cantidad_pedida,
						 :ll_lineas_del_articulo_ya_grabadas 
				from   venliped
				where  venliped.empresa     = :codigo_empresa
				and    venliped.anyo        = :var_anyo
				and    venliped.pedido      = :var_pedido
				and    venliped.situacion  <> 'P'
				and    venliped.articulo    = :uo_articulo.em_codigo.text
				and    venliped.calidad     = :uo_calidad.em_codigo.text
				and    venliped.tonochar    = :ls_tono
				and    venliped.calibre     = :li_calibre
				and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
				and    venliped.caja        = :uo_caja.em_codigo.text;		
				
				//
				SELECT sum( case when ventipolin.gestionar_en_piezas = 'S' then venliped.cantidad_pzs else case when articulos.unidad = '1' then ( venliped.cantidad / almartcajas.metroscaja ) * almartcajas.piezascaja else venliped.cantidad end end ) as cantidad_pzs, 
						 isnull(count(*),0) 
				into   :ll_total_cantidad_pedida_pzs,
						 :ll_lineas_del_articulo_ya_grabadas			
				FROM   venliped,
						 ventipolin, 
						 articulos, 
						 almartcajas 
				WHERE ( venliped.empresa   = ventipolin.empresa ) 
				AND   ( venliped.tipolinea = ventipolin.codigo ) 
				AND   ( venliped.empresa   = articulos.empresa ) 
				AND   ( venliped.articulo  = articulos.codigo ) 
				AND   ( venliped.empresa   = almartcajas.empresa ) 
				AND   ( venliped.articulo  = almartcajas.articulo ) 
				AND   ( venliped.caja      = almartcajas.caja ) 
				AND    venliped.empresa     = :codigo_empresa
				and    venliped.anyo        = :var_anyo
				and    venliped.pedido      = :var_pedido
				and    venliped.situacion  <> 'P'
				and    venliped.articulo    = :uo_articulo.em_codigo.text
				and    venliped.calidad     = :uo_calidad.em_codigo.text
				and    venliped.tonochar    = :ls_tono
				and    venliped.calibre     = :li_calibre
				and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
				and    venliped.caja        = :uo_caja.em_codigo.text;				
				//			
			end if		
			//A la cantidad del pedido le añadimos la de la linea que vamos a grabar
			ld_total_cantidad_pedida += dec(em_cantidad.text)
			
			ll_total_cantidad_pedida_pzs += dec(em_cantidad_en_pzs.text)
		else
			ld_total_cantidad_pedida = dec(em_cantidad.text)
			
			ll_total_cantidad_pedida_pzs = dec(em_cantidad_en_pzs.text)
		end if
		
		cant_bloqueo = 0	//Este control ya no funcionaba con las nuevas tablas de almacen
		ll_cant_bloqueo_pzs = 0
		
		disponible        = f_disponible_art_cal_to_ca_tp_c(codigo_empresa,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text,em_tono.text,dec(em_calibre.text),uo_tipo_pallet.em_codigo.text,uo_caja.em_codigo.text)	
		ll_disponible_pzs = f_disponible_art_cal_to_ca_tp_c_pzs(codigo_empresa,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text,em_tono.text,dec(em_calibre.text),uo_tipo_pallet.em_codigo.text,uo_caja.em_codigo.text)	
		
		if lb_control_reservas_pedido_completo then	
			//if tipo = 'M' then
			ante_existencias = 0		
			
			//and    venliped.linea       = :linea_pedido		
			
			select isnull(sum(venliped.cantidad),0)
			into   :ante_existencias
			from   venliped
			where  venliped.empresa     = :codigo_empresa
			and    venliped.anyo        = :var_anyo
			and    venliped.pedido      = :var_pedido
			and    venliped.situacion   = 'C'
			and    venliped.articulo    = :uo_articulo.em_codigo.text
			and    venliped.calidad     = :uo_calidad.em_codigo.text
			and    venliped.tonochar    = :ls_tono
			and    venliped.calibre     = :li_calibre
			and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
			and    venliped.caja        = :uo_caja.em_codigo.text;
			
			if isnull(ante_existencias) then ante_existencias = 0
			
			disponible = disponible + ante_existencias
			
			ll_ante_existencias_pzs = 0
			
			SELECT sum( case when ventipolin.gestionar_en_piezas = 'S' then venliped.cantidad_pzs else case when articulos.unidad = '1' then ( venliped.cantidad / almartcajas.metroscaja ) * almartcajas.piezascaja else venliped.cantidad end end ) as cantidad_pzs 
			into   :ll_ante_existencias_pzs 
			FROM   venliped,
					 ventipolin, 
					 articulos, 
					 almartcajas 
			WHERE ( venliped.empresa   = ventipolin.empresa ) 
			AND   ( venliped.tipolinea = ventipolin.codigo ) 
			AND   ( venliped.empresa   = articulos.empresa ) 
			AND   ( venliped.articulo  = articulos.codigo ) 
			AND   ( venliped.empresa   = almartcajas.empresa ) 
			AND   ( venliped.articulo  = almartcajas.articulo ) 
			AND   ( venliped.caja      = almartcajas.caja ) 
			AND    venliped.empresa     = :codigo_empresa
			and    venliped.anyo        = :var_anyo
			and    venliped.pedido      = :var_pedido
			and    venliped.situacion   = 'C'
			and    venliped.articulo    = :uo_articulo.em_codigo.text
			and    venliped.calidad     = :uo_calidad.em_codigo.text
			and    venliped.tonochar    = :ls_tono
			and    venliped.calibre     = :li_calibre
			and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
			and    venliped.caja        = :uo_caja.em_codigo.text;						
			
			if isnull(ll_ante_existencias_pzs) then ll_ante_existencias_pzs = 0
			
			ll_disponible_pzs += ll_ante_existencias_pzs
			//end if
		else
			ante_existencias = 0
			if tipo = 'M' then								
				select isnull(sum(venliped.cantidad),0)
				into   :ante_existencias
				from   venliped
				where  venliped.empresa     = :codigo_empresa
				and    venliped.anyo        = :var_anyo
				and    venliped.pedido      = :var_pedido
				and    venliped.linea       = :linea_pedido		
				and    venliped.situacion   = 'C'
				and    venliped.articulo    = :uo_articulo.em_codigo.text
				and    venliped.calidad     = :uo_calidad.em_codigo.text
				and    venliped.tonochar    = :ls_tono
				and    venliped.calibre     = :li_calibre
				and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
				and    venliped.caja        = :uo_caja.em_codigo.text;
				
				if isnull(ante_existencias) then ante_existencias = 0
			
				disponible = disponible + ante_existencias
				
				ll_ante_existencias_pzs = 0
				
				SELECT sum( case when ventipolin.gestionar_en_piezas = 'S' then venliped.cantidad_pzs else case when articulos.unidad = '1' then ( venliped.cantidad / almartcajas.metroscaja ) * almartcajas.piezascaja else venliped.cantidad end end ) as cantidad_pzs 
				into   :ll_ante_existencias_pzs 
				FROM   venliped,
						 ventipolin, 
						 articulos, 
						 almartcajas 
				WHERE ( venliped.empresa   = ventipolin.empresa ) 
				AND   ( venliped.tipolinea = ventipolin.codigo ) 
				AND   ( venliped.empresa   = articulos.empresa ) 
				AND   ( venliped.articulo  = articulos.codigo ) 
				AND   ( venliped.empresa   = almartcajas.empresa ) 
				AND   ( venliped.articulo  = almartcajas.articulo ) 
				AND   ( venliped.caja      = almartcajas.caja ) 
				AND    venliped.empresa     = :codigo_empresa
				and    venliped.anyo        = :var_anyo
				and    venliped.pedido      = :var_pedido
				and    venliped.linea       = :linea_pedido		
				and    venliped.situacion   = 'C'
				and    venliped.articulo    = :uo_articulo.em_codigo.text
				and    venliped.calidad     = :uo_calidad.em_codigo.text
				and    venliped.tonochar    = :ls_tono
				and    venliped.calibre     = :li_calibre
				and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
				and    venliped.caja        = :uo_caja.em_codigo.text;				
				
				if isnull(ll_ante_existencias_pzs) then ll_ante_existencias_pzs = 0
				
				ll_disponible_pzs += ll_ante_existencias_pzs			
			end if		
		end if
		
		em_situacion.text = "C"
			
		//If disponible - cant_bloqueo < ld_total_cantidad_pedida Then
		If ll_disponible_pzs - ll_cant_bloqueo_pzs < ll_total_cantidad_pedida_pzs Then
			IF Not f_produccion_articulo(codigo_empresa,uo_articulo.em_codigo.text) Then
				if MessageBox("Artículo excluido de producción.","El artículo no se fabricara más, ¿Desea grabarlo a fabricar? ",Question!, YesNo!,2) = 2 Then
					f_activar_campo(uo_articulo.em_campo)
					Return
				End if
				em_situacion.text = "F"
			ELSE
				em_situacion.text = "F"
			END IF
		ELSE
			// Santiago. Desactivamos el control de disponible de almacenes externos. 06/02/01
		
			// Santiago. Desactivamos el control de disponible de almacenes externos. 06/02/01
		END IF
	
		if venped.es_proforma <> "N" then
			em_situacion.text = "F"
		end if
	end if	
END IF	
	
ls_nueva_situacion = em_situacion.text
	
if ll_lineas_del_articulo_ya_grabadas > 0 and var_situacion <> "P" and lb_control_reservas_pedido_completo then
	update venliped
	set    venliped.situacion   = :em_situacion.text
	where  venliped.empresa     = :codigo_empresa
	and    venliped.anyo        = :var_anyo
	and    venliped.pedido      = :var_pedido
	and    venliped.situacion  <> 'P'
	and    venliped.articulo    = :uo_articulo.em_codigo.text
	and    venliped.calidad     = :uo_calidad.em_codigo.text
	and    venliped.tonochar    = :ls_tono
	and    venliped.calibre     = :li_calibre
	and    venliped.tipo_pallet = :uo_tipo_pallet.em_codigo.text
	and    venliped.caja        = :uo_caja.em_codigo.text;			
	
	if sqlca.sqlcode <> 0 then
		mensaje = sqlca.sqlerrtext
		rollback;
		MessageBox("Atención",mensaje,Exclamation!,OK!,1)
		uo_articulo.SetFocus()
		return		
	end if
end if 
	
//Fin de Vamos a comprobar si tenemos suficiente stock para asignar al pedido

//En este proceso tenemos un error cuando volvemos a guardar una linea de un pedido que no tenia pico y ahora si que tiene
//Tambien tenemos un error cuando volvemos a guardar una linea preparada

do while not fin
		
	if codigo_pallet = "3" or var_situacion = "P" or ib_linea_en_orden_de_carga or uo_articulo.em_codigo.text = "" then //NO SE SEPARAN BULTOS EN PALLET EN CASO DEL PALLET "SIN PALLET" ni en caso de estar la linea preparada
		fin = true
	else
		if v_separar_bultos = 'S' then
			if ib_gestionar_en_piezas or tipo_unidad <> '1' then
				if tipo_unidad <> '1' then
					//Piezas
					if cantidad > piezas_pallet and var_control_alm = 'S' then
						em_cantidad.text        = string(piezas_pallet)
						em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
						cantidad = cantidad - piezas_pallet
					else
						em_cantidad.text = string(cantidad) 
						em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
						fin = true
					end if				
				else
					//Gestionado en piezas
					if cantidad_pzs > piezas_pallet and var_control_alm = 'S' then						
						em_cantidad_en_pzs.text = string(piezas_pallet)
						em_cantidad.text = string(f_conversion_piezas_cantidad(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text,dec(em_cantidad_en_pzs.text)),em_cantidad.mask)

						cantidad_pzs = cantidad_pzs - piezas_pallet
					else
						em_cantidad_en_pzs.text = string(cantidad_pzs) 
						em_cantidad.text = string(f_conversion_piezas_cantidad(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text,dec(em_cantidad_en_pzs.text)),em_cantidad.mask)
						fin = true
					end if									
				end if
			else
				//Metros
				if cantidad > metros_pallet and var_control_alm = 'S' then
					em_cantidad.text        = string(metros_pallet)
					em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
					cantidad = cantidad - metros_pallet
				else
					em_cantidad.text        = string(cantidad) 
					em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
					fin = true
				end if
			end if
		else
			if v_separar_incompletos = 'S' then
				if resto = 0 and fin = false then
					if ib_gestionar_en_piezas or tipo_unidad <> '1' then
						if tipo_unidad <> '1' then
							//Piezas	
							resto = mod(cantidad,piezas_pallet)
							if resto > 0  and truncate(cantidad / piezas_pallet, 0) > 0 then
								em_cantidad.text = string(truncate(cantidad / piezas_pallet, 0) * piezas_pallet)
								em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
							else
								em_cantidad.text = string(cantidad) 
								em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
								fin = true
							end if																			
						else
							//Gestionado en piezas
							resto = mod(cantidad_pzs,piezas_pallet)
							if resto > 0  and truncate(cantidad_pzs / piezas_pallet, 0) > 0 then
								em_cantidad_en_pzs.text = string(truncate(cantidad_pzs / piezas_pallet, 0) * piezas_pallet)
								em_cantidad.text = string(f_conversion_piezas_cantidad(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text,dec(em_cantidad_en_pzs.text)),em_cantidad.mask)
							else
								em_cantidad_en_pzs.text = string(cantidad_pzs) 
								em_cantidad.text = string(f_conversion_piezas_cantidad(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text,dec(em_cantidad_en_pzs.text)),em_cantidad.mask)
								fin = true
							end if															
						end if
						
					else
						//Metros
						resto = mod(cantidad,metros_pallet)
						if resto > 0  and truncate(cantidad / metros_pallet, 0) > 0 then
							em_cantidad.text        = string(truncate(cantidad / metros_pallet, 0) * metros_pallet)
							em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
						else
							em_cantidad.text        = string(cantidad) 
							em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
							fin = true
						end if						
					end if
				else
					if ib_gestionar_en_piezas or tipo_unidad <> '1' then
						if tipo_unidad <> '1' then
							//Piezas							
							em_cantidad.text        = string(resto) 
							em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
							fin = true						
						else
							//Gestionado en piezas
							em_cantidad_en_pzs.text = string(resto) 
							em_cantidad.text = string(f_conversion_piezas_cantidad(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text,dec(em_cantidad_en_pzs.text)),em_cantidad.mask)
							fin = true													
						end if
					else
						//Metros
						em_cantidad.text        = string(resto) 
						em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
						fin = true
					end if
				end if
			else
				fin = true
			end if
		end if	
	end if
	
	em_situacion.text = ls_nueva_situacion
	
	IF Not f_control_lnpedido(linea_pedido,"N") Then Return
		
		IF tipo= "M" and  var_situacion = "P" Then
			em_situacion.text = "P"
		ELSE
			IF tipo_precio = 2 Then
				f_grabar_linea()
				f_control()
				return
			END IF			
		
			IF Trim(art) = "" Then
				piezas_caja = 0
				tipo_unidad = ""
			ELSE
				piezas_caja = f_piezascaja_articulo(codigo_empresa,art,uo_caja.em_codigo.text)
				tipo_unidad = f_unidad_articulo(codigo_empresa,art)	
				//if uo_tipolinea.em_codigo.text = "4" then tipo_unidad = "0" //MUY IMPORTANTE - La promoción siempre va en piezas *************************************************************
			END IF
			
			IF This.visible = FALSE Then RETURN
			
			controles="N"
			acumular  = "N" 
			
			IF var_control_alm ="S" and var_sector = "S" THEN
				 em_cajas.text=""
				 em_t_cajas.text=""
				 em_t_pallets.text=""
				 em_mtrs_lineales.text =""
				
				 cadena=f_calculo_unidades_tipolin(codigo_empresa,art,&
													 uo_tipo_pallet.em_codigo.text,&
													 uo_caja.em_codigo.text,&
													 integer(em_t_pallets.text),&
													 integer(em_cajas.text),&
													 Dec(em_cantidad.text), uo_tipolinea.em_codigo.text)
											  
				posi_aux = 1
				posi = pos(cadena,"|",1)
				if posi <> 0 then
					em_t_pallets.text     = Mid(cadena,1,posi - 1)
					posi_aux = posi + 1
				end if
				
				posi = pos(cadena,"|",posi_aux)
				if posi <> 0 then
					em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
					posi_aux = posi + 1
				end if
				
				posi = pos(cadena,"|",posi_aux)
				if posi <>0 then
					em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
					posi_aux = posi + 1
				end if
				
				posi = pos(cadena,"|",posi_aux)
				if posi <>0 then
					em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
					//em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
					posi_aux = posi + 1
				end if
				
				posi = pos(cadena,"|",posi_aux)
				if posi <>0 then
					em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
				end if
				
			end if		
			
			IF Trim(art) = "" Then
				referencia = ""
			ELSE
				referencia  = f_componer_ref(art,uo_calidad.em_codigo.text,Trim(em_tono.text),Dec(em_calibre.text))
			END IF
			
			cant_bloqueo = 0
		
			acumular ="N"		

	END IF


	IF tipo = "M" Then var_tipo_pallet_preparacion=uo_tipo_pallet.em_codigo.text
	f_grabar_linea()
	f_control()
	IF tipo = "I" Then dw_detalle.ScrollToRow(dw_detalle.RowCount())
	f_botones()	
		
LOOP

cb_insertar.TriggerEvent(clicked!)
articulo_ant=""
st_pz.text = "0"
st_pal.text = "0"
COMMIT;
end event

type cb_borrar from u_boton within w_int_venliped
integer x = 1509
integer y = 2684
integer width = 421
integer height = 96
integer taborder = 0
boolean bringtotop = true
string text = "F4 Borrar"
end type

event clicked;
//ORDEN CARGA
if ftc_linea_en_orden_carga(Dec(em_anyo.text),Dec(em_pedido.text),linea_pedido) then
	f_mensaje("No se puede borrar la línea","Línea en ORDEN DE CARGA. Contacte con almacén.")
	Return
end if

IF  Not f_control_lnpedido(linea_pedido,"S") Then 
	Return
Else
	f_borrar_ordenes(codigo_empresa,Dec(em_anyo.text),Dec(em_pedido.text),linea_pedido)
END IF
IF This.enabled = FALSE Then RETURN
If MessageBox("Comfirmacion Baja linea de pedido","Desea borrar la línea de pedido seleccionada",Question!, YesNo!,2)= 2 Then
  f_activar_primer_campo()
  Return
END IF
IF f_valor_columna(dw_detalle,dw_detalle.GetRow(),"situacion") = "P" Then
	f_mensaje("No se puede borrar la línea","Línea preparada no se puede borrar")
	Return
END IF

f_borrar_linea()
f_control()
COMMIT;
cb_insertar.TriggerEvent(clicked!)



end event

type em_descripcion from u_em_campo within w_int_venliped
integer x = 23
integer y = 2516
integer width = 1358
integer taborder = 200
fontcharset fontcharset = ansi!
string facename = "Arial"
string mask = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
end type

on getfocus;call u_em_campo::getfocus;campo_actual = "DESCRIPCION"
end on

type st_33 from statictext within w_int_venliped
integer x = 27
integer y = 2436
integer width = 1353
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 15780518
boolean enabled = false
string text = "Descripción artículo"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type cb_insertar from u_boton within w_int_venliped
integer x = 654
integer y = 2684
integer width = 421
integer height = 96
integer taborder = 0
string text = "F2 Insertar"
end type

event clicked;ib_linea_en_orden_de_carga = false

control_incremento = "S"
tipo="I"
linea_pedido = 0
em_cajas.text=""
em_tono.text=""
em_calibre.text=""
em_cantidad.text=""
em_descripcion.text=""
em_mtrs_lineales.text=""
em_precio.text=""
em_descuento.text=""
em_descuento2.text=''
em_situacion.text=""
em_t_cajas.text=""
em_t_pallets.text=""
uo_articulo.em_campo.text=""
uo_calidad.em_campo.text=""
uo_idioma.em_campo.text="0"
uo_tipo_pallet.em_campo.text=""
uo_caja.em_campo.text=""
uo_articulo.em_codigo.text=""
articulo_ant=""
uo_calidad.em_codigo.text=""
uo_tipo_pallet.em_codigo.text=""
uo_caja.em_codigo.text = ""
uo_tipolinea.em_codigo.text="1"
uo_tipolinea.em_campo.text = f_nombre_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
uo_tipolinea.TriggerEvent("modificado")
em_situacion.text = "F" //"C"
em_npal.text = "0"
deposito.text = "N"
var_tipo_pallet_preparacion =""
deposito.visible = FALSE
st_deposito.visible = FALSE
f_botones()
dw_detalle.SelectRow(0,FALSE)
f_activar_primer_campo()
f_peso_linea()
em_fecha_intr.text = string(today(),em_fecha_intr.mask)
planificado = 'N'
st_articulo.text = "Artículo"
em_calibre_imprimir.text = ""
em_tono_imprimir.text = ""

integer orden
select max(orden)
into :orden
from venliped 
where empresa = :codigo_empresa
and anyo = :em_anyo.text
and pedido = :em_pedido.text;

if isnull(orden) or orden = 0 then
	orden = 1
else
	orden = orden +1
end if

sle_orden.text = string(orden)
sle_observaciones.text = ''
uo_familia.em_campo.text=""
uo_familia.em_codigo.text=""

st_observaciones.text = ''
st_observaciones.visible = false
//Reseteamos la dw de stock
dw_1.reset()
end event

type uo_tipolinea from u_em_campo_2 within w_int_venliped
integer x = 23
integer y = 2332
integer width = 622
integer height = 88
integer taborder = 20
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;f_campos_segun_tiplin()
uo_tipolinea.em_campo.text=f_nombre_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
IF Trim(uo_tipolinea.em_campo.text)=""  or IsNull(uo_tipolinea.em_campo.text)THEN 
	 IF Trim(uo_tipolinea.em_codigo.text)<>"" Then 
		f_activar_campo(uo_tipolinea.em_campo)
	 END IF
	 uo_tipolinea.em_campo.text   = ""
	 uo_tipolinea.em_codigo.text  = ""
END IF

end event

on getfocus;call u_em_campo_2::getfocus;ue_titulo     = "Ayuda seleccion tipos de linea (facturación)"
ue_datawindow = "dw_ayuda_ventipolin"
ue_filtro     = ""
tipolinea_ant = this.em_codigo.text

campo_actual = "TIPO_LINEA"
end on

on uo_tipolinea.destroy
call u_em_campo_2::destroy
end on

type st_tplinea from statictext within w_int_venliped
integer x = 23
integer y = 2260
integer width = 626
integer height = 76
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Tipo .Lin"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type cb_stock from u_boton within w_int_venliped
boolean visible = false
integer x = 1088
integer y = 2796
integer width = 416
integer height = 96
integer taborder = 0
boolean enabled = false
string text = "F5 Ver stock"
end type

event clicked;str_parametros valores
IF This.enabled Then
	 IF var_control_alm = "S" Then
		 f_consulta_disponible()
		 IF Message.DoubleParm <> -1  THEN 
			 If em_tono.text= "0" Then em_tono.text="" 
			 If em_calibre.text= "0" Then em_calibre.text="" 
			 valores = Message.PowerObjectParm
	
			 uo_articulo.em_campo.text= f_nombre_articulo(codigo_empresa,valores.s_argumentos[1])
			 uo_articulo.em_codigo.text= valores.s_argumentos[1]
			 uo_calidad.em_campo.text  = f_nombre_calidad_abr(codigo_empresa,valores.s_argumentos[2])
			 uo_calidad.em_codigo.text     = valores.s_argumentos[2]
			 em_tono.text                  = valores.s_argumentos[3]
			 em_calibre.text               = valores.s_argumentos[4]
			 uo_tipo_pallet.em_campo.text  = f_nombre_pallet_abr(codigo_empresa,valores.s_argumentos[5])
			 uo_tipo_pallet.em_codigo.text = valores.s_argumentos[5]
			 uo_caja.em_campo.text = f_nombre_caja_abr (codigo_empresa,valores.s_argumentos[6])
			 uo_caja.em_codigo.text = valores.s_argumentos[6]
			 uo_articulo.ue_valor_anterior = uo_articulo.em_campo.text
			 uo_tipo_pallet.ue_valor_anterior = uo_tipo_pallet.em_campo.text
			 uo_calidad.ue_valor_anterior = uo_calidad.em_campo.text
			 f_deposito()
			 f_activar_campo(uo_calidad.em_campo)
		 END IF
	end if
end if
end event

type em_anyo from u_em_campo within w_int_venliped
integer x = 105
integer y = 136
integer width = 165
integer height = 68
integer taborder = 0
long textcolor = 128
long backcolor = 16777215
boolean enabled = false
boolean border = false
alignment alignment = right!
boolean displayonly = true
borderstyle borderstyle = stylebox!
maskdatatype maskdatatype = numericmask!
string mask = "####"
end type

type gb_3 from groupbox within w_int_venliped
integer x = 1065
integer y = 88
integer width = 2706
integer height = 136
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
borderstyle borderstyle = styleraised!
end type

type em_situacion from u_em_campo within w_int_venliped
boolean visible = false
integer x = 23
integer y = 1448
integer width = 123
integer taborder = 130
boolean border = false
borderstyle borderstyle = stylebox!
end type

type gb_4 from groupbox within w_int_venliped
integer x = 50
integer y = 2628
integer width = 1902
integer height = 296
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
borderstyle borderstyle = styleraised!
end type

type cb_valorar from u_boton within w_int_venliped
integer x = 654
integer y = 2796
integer width = 421
integer height = 96
integer taborder = 0
boolean bringtotop = true
string text = "F7 Valorar"
end type

event clicked;dw_pie.visible = TRUE
dw_pie.InsertRow(1)
dw_pie.SetItem(1,"pie",f_pie_pedido(venped.empresa,venped.anyo,venped.pedido))
f_activar_primer_campo()


end event

type em_pedido from u_em_campo within w_int_venliped
integer x = 325
integer y = 136
integer width = 165
integer height = 68
integer taborder = 0
long textcolor = 128
long backcolor = 16777215
boolean enabled = false
boolean border = false
boolean displayonly = true
borderstyle borderstyle = stylebox!
maskdatatype maskdatatype = numericmask!
string mask = "######"
end type

type st_4 from statictext within w_int_venliped
integer x = 5038
integer y = 116
integer width = 297
integer height = 52
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Peso total"
alignment alignment = center!
boolean focusrectangle = false
end type

type st_5 from statictext within w_int_venliped
integer x = 5033
integer y = 164
integer width = 311
integer height = 52
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Peso Linea"
alignment alignment = center!
boolean focusrectangle = false
end type

type st_peso_linea from statictext within w_int_venliped
integer x = 5358
integer y = 164
integer width = 242
integer height = 52
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
alignment alignment = right!
boolean focusrectangle = false
end type

type gb_1 from groupbox within w_int_venliped
integer x = 14
integer y = 88
integer width = 489
integer height = 136
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
borderstyle borderstyle = styleraised!
end type

type st_2 from statictext within w_int_venliped
integer x = 265
integer y = 136
integer width = 46
integer height = 72
boolean bringtotop = true
integer textsize = -11
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "Algerian"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
string text = "/"
alignment alignment = right!
boolean focusrectangle = false
end type

type em_porcentaje from u_em_campo within w_int_venliped
boolean visible = false
integer x = 878
integer y = 128
integer width = 151
integer taborder = 0
integer weight = 400
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "###"
string displaydata = ""
end type

event tecla_enter;call super::tecla_enter;Dec{4} var_porcentaje
Dec{0} var_anyo,var_pedido
var_porcentaje = Dec(em_porcentaje.text)
var_anyo     = Dec(em_anyo.text)
var_pedido = Dec(em_pedido.text)

IF messageBox("Proceso volcado de precios","Desea Volcar precios al "+ em_porcentaje.text +" %",Question!,YesNo!,2) = 1 Then
   UPDATE venliped	
	Set    venliped.precio_aduana = venliped.precio * :var_porcentaje/100
	Where  venliped.empresa  = :codigo_empresa
   And  	 venliped.anyo     = :var_anyo
	And    venliped.pedido = :var_pedido;
	UPDATE venped	
	Set    venped.porcentaje_aduana = :var_porcentaje
	Where  venped.empresa  = :codigo_empresa
   And  	 venped.anyo     = :var_anyo
	And    venped.pedido = :var_pedido;
	COMMIT;
	f_control()
	f_recalcular_lineas()
	COMMIT;
	f_control()
END IF
end event

type gb_2 from groupbox within w_int_venliped
integer x = 521
integer y = 88
integer width = 526
integer height = 136
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
borderstyle borderstyle = styleraised!
end type

type st_proforma from dropdownlistbox within w_int_venliped
integer x = 530
integer y = 128
integer width = 343
integer height = 276
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "Pedido"
boolean vscrollbar = true
string item[] = {"Pedido","Aduana"}
end type

event selectionchanged;Dec{4}  var_porcentaje
Dec{0}  var_anyo,var_pedido

var_anyo= Dec(em_anyo.text)
var_pedido= Dec(em_pedido.text)

IF This.Text = "Aduana" Then
  tipo_precio = 2
  em_porcentaje.visible = TRUE
	Select venped.porcentaje_aduana Into	:var_porcentaje
	From   venped
	Where  venped.empresa  = :codigo_empresa
   And  	 venped.anyo     = :var_anyo
	And    venped.pedido = :var_pedido;
	em_porcentaje.text = String(var_porcentaje)
ELSE
	 tipo_precio = 1
    em_porcentaje.visible = FALSE
END IF
f_control()
tipo = "I"
cb_insertar.TriggerEvent(Clicked!)
f_peso_linea()
f_botones()
f_activar_primer_campo()
f_campos_segun_tiplin()
end event

type st_6 from statictext within w_int_venliped
integer x = 5029
integer y = 108
integer width = 320
integer height = 116
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
alignment alignment = right!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_peso_total from statictext within w_int_venliped
integer x = 5358
integer y = 112
integer width = 242
integer height = 52
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
alignment alignment = right!
boolean focusrectangle = false
end type

type st_7 from statictext within w_int_venliped
integer x = 5349
integer y = 108
integer width = 265
integer height = 116
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
alignment alignment = right!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_tono from statictext within w_int_venliped
integer x = 2464
integer y = 2260
integer width = 96
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "C"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_tono from u_em_campo within w_int_venliped
event getfocus pbm_ensetfocus
event modificado pbm_custom02
event doubleclicked pbm_lbuttondblclk
integer x = 2217
integer y = 2332
integer width = 242
integer height = 88
integer taborder = 0
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
boolean displayonly = true
string mask = "!!!!!!!!!!!!!!!!!!!!!"
end type

event getfocus;call super::getfocus;campo_actual = "TONO"

end event

event modificado;call super::modificado;
f_control_tono_calibre()

if f_familias_replica_tono_calibre(codigo_empresa,f_familia_articulo(codigo_empresa,uo_articulo.em_codigo.text)) = 'S' then
	em_tono_imprimir.text = this.text
end if

em_situacion.text = "F"
end event

event doubleclicked;integer li_opcion

li_opcion = MessageBox("Proceso de Modificacion", "Desea borrar el tono?", Question!, YesNo!,2)

IF li_opcion = 1 THEN
    em_tono.text = ''
ELSE
    return
END IF
    
end event

type st_calibre from statictext within w_int_venliped
integer x = 2217
integer y = 2260
integer width = 247
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Tono"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_calibre from u_em_campo within w_int_venliped
event getfocus pbm_ensetfocus
event modificado pbm_custom02
integer x = 2459
integer y = 2332
integer width = 101
integer height = 88
integer taborder = 60
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = ""
end type

event getfocus;call super::getfocus;campo_actual = "TONO"

end event

event modificado;call super::modificado;
f_control_tono_calibre()

if f_familias_replica_tono_calibre(codigo_empresa,f_familia_articulo(codigo_empresa,uo_articulo.em_codigo.text)) = 'S' then
	em_calibre_imprimir.text = this.text
end if

em_situacion.text = "F"
end event

type cb_ultimo_precio from commandbutton within w_int_venliped
integer x = 4398
integer y = 2260
integer width = 251
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
end type

event clicked;if uo_articulo.em_codigo.text="" then
	uo_articulo.em_campo.setfocus()
	return
end if
dw_ultimo_precio.settransobject(sqlca)
dw_ultimo_precio.retrieve(codigo_empresa,em_cliente.text,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text)
dw_ultimo_precio.visible=true

end event

type st_texto_precio from statictext within w_int_venliped
integer x = 4402
integer y = 2260
integer width = 238
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Precio"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

event clicked;cb_ultimo_precio.triggerevent(clicked!)
end event

type st_caja from statictext within w_int_venliped
integer x = 2569
integer y = 2260
integer width = 293
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24076881
boolean enabled = false
string text = "Caja"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type uo_caja from u_em_campo_2 within w_int_venliped
event destroy ( )
integer x = 2569
integer y = 2332
integer width = 293
integer height = 88
integer taborder = 70
boolean border = true
borderstyle borderstyle = stylelowered!
end type

on uo_caja.destroy
call u_em_campo_2::destroy
end on

event modificado;uo_caja.em_campo.text=f_nombre_almartcaja_abr(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text)
st_pz.text = string(f_piezascaja_articulo(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text),"###,###")
st_pal.text = string(f_cajas_pallet_articulo(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text,uo_caja.em_codigo.text),"###,###")
IF Trim(uo_caja.em_campo.text)=""  or IsNull(uo_caja.em_campo.text)THEN 
 IF Trim(uo_caja.em_codigo.text)<>"" Then 
   uo_caja.em_campo.SetFocus()
 END IF
 uo_caja.em_campo.text=""
 uo_caja.em_codigo.text=""
END IF

//f_peso_linea()	

em_situacion.text = "F"
end event

event getfocus;call super::getfocus;ue_titulo     = "Ayuda seleccion de cajas"
ue_datawindow = "dw_ayuda_almartcajas"
//ue_filtro     = "almartcajas_articulo = '" + uo_articulo.em_codigo.text+ "'"+" and almartcajas_pordefecto = 'S' "+" and palarticulo_pordefecto = 'S'"
ue_filtro     = "almartcajas_articulo = '" + uo_articulo.em_codigo.text+ "'"
campo_actual  = "CAJA"


end event

type st_calidad from statictext within w_int_venliped
integer x = 2062
integer y = 2260
integer width = 146
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Cal."
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_fecha_intr from statictext within w_int_venliped
integer x = 4649
integer y = 2260
integer width = 270
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "F.Intr."
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_fecha_intr from u_em_campo within w_int_venliped
integer x = 4649
integer y = 2332
integer width = 270
integer height = 88
integer taborder = 160
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = center!
maskdatatype maskdatatype = datemask!
string mask = "dd-mm-yy"
end type

type st_1 from statictext within w_int_venliped
integer x = 119
integer y = 2708
integer width = 261
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "PZ/CJ :"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_9 from statictext within w_int_venliped
integer x = 119
integer y = 2800
integer width = 261
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "CJ/PAL :"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_pz from statictext within w_int_venliped
integer x = 384
integer y = 2708
integer width = 201
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "0"
alignment alignment = right!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_pal from statictext within w_int_venliped
integer x = 384
integer y = 2796
integer width = 201
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "0"
alignment alignment = right!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_npalet from statictext within w_int_venliped
integer x = 4923
integer y = 2260
integer width = 206
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "NºPal."
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_npal from u_em_campo within w_int_venliped
integer x = 4919
integer y = 2332
integer width = 210
integer height = 88
integer taborder = 180
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = "!!!!!"
end type

type st_idioma from statictext within w_int_venliped
integer x = 1925
integer y = 2260
integer width = 137
integer height = 76
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Idi"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type uo_idioma from u_em_campo_2 within w_int_venliped
integer x = 1925
integer y = 2332
integer width = 137
integer height = 88
integer taborder = 40
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;String des,desc2

uo_idioma.em_campo.text=uo_idioma.em_codigo.text
IF Trim(uo_idioma.em_campo.text)="" THEN 
 IF Trim(uo_idioma.em_codigo.text)<>"" Then uo_idioma.em_campo.SetFocus()
 uo_idioma.em_campo.text=""
 uo_idioma.em_codigo.text=""
END IF
des = uo_articulo.em_campo.text
desc2=f_descripcion_almcliartdesc2(codigo_empresa,venped.cliente,uo_articulo.em_codigo.text,dec(uo_idioma.em_codigo.text))
if desc2<>'' then
	uo_articulo.em_campo.text=desc2
else		
	uo_articulo.em_campo.text=des
end if
em_descripcion.text = uo_articulo.em_campo.text
f_control_tono_calibre()
f_calculo_precio()
f_campos_segun_tiplin()
f_deposito()
end event

event getfocus;call super::getfocus;// para controlar valor anterio
  idioma_ant = uo_idioma.em_codigo.text

valor_empresa = TRUE
ue_titulo     = "Ayuda seleccion de descripciones alternativas"
ue_datawindow = "dw_ayuda_almcliartdesc"
ue_filtro     = "cliente = '"+venped.cliente+"' and codigo = '"+uo_articulo.em_codigo.text+"'"


campo_actual = "IDIOMA"
f_peso_linea()
end event

on uo_idioma.destroy
call u_em_campo_2::destroy
end on

type uo_calidad from u_em_campo_2 within w_int_venliped
integer x = 2066
integer y = 2332
integer width = 146
integer height = 88
integer taborder = 50
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;uo_calidad.em_campo.text=f_nombre_calidad_abr(codigo_empresa,uo_calidad.em_codigo.text)
IF Trim(uo_calidad.em_campo.text)="" THEN 
 IF Trim(uo_calidad.em_codigo.text)<>"" Then uo_calidad.em_campo.SetFocus()
 uo_calidad.em_campo.text=""
 uo_calidad.em_codigo.text=""
END IF
f_control_tono_calibre()
f_calculo_precio()
f_campos_segun_tiplin()
f_deposito()

em_situacion.text = "F"
end event

event getfocus;call super::getfocus;// para controlar valor anterio
  calidad_ant = uo_calidad.em_codigo.text

ue_titulo     = "Ayuda seleccion de calidades"
ue_datawindow = "dw_ayuda_almartcal"
ue_filtro     = "almartcal_articulo = '"+uo_articulo.em_codigo.text+"'"


campo_actual = "CALIDAD"
f_peso_linea()
end event

on uo_calidad.destroy
call u_em_campo_2::destroy
end on

type dw_ultimo_precio from datawindow within w_int_venliped
boolean visible = false
integer x = 4663
integer y = 1696
integer width = 1646
integer height = 468
integer taborder = 280
string dataobject = "dw_ultimo_precio"
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event clicked;if isnull(dwo) then return
if isnull(dwo.name) then return

if dwo.name="salir" or dwo.name="salir1" then
	reset()
	visible=false
	em_precio.setfocus()
end if

end event

event doubleclicked;if isnull(row) then return
if row=0 then return

em_precio.text=string(getitemnumber(row,"precio"))
em_precio.setfocus()
reset()
visible=false


end event

type gb_5 from groupbox within w_int_venliped
integer x = 4407
integer y = 2428
integer width = 1888
integer height = 520
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 12632256
string text = "Stock"
end type

type dw_1 from datawindow within w_int_venliped
integer x = 4421
integer y = 2480
integer width = 1993
integer height = 456
boolean bringtotop = true
string dataobject = "dwtc_aux_stock_articulo_pedidos_new"
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event doubleclicked;string cadena,v_pallets,unidad_articulo, tipolinea
long   posi_aux,posi


tipolinea = uo_tipolinea.em_codigo.text

if row > 0 and il_id_alm_orden_carga = 0 then
	if tipolinea = '1' and this.object.tipo_pallet[row] = '00000' then
		messagebox("Aviso","No se puede asginar tono de promocion a una linea de ventas")
		return
	else
		uo_calidad.em_codigo.text = this.object.calidad[row]
		//uo_calidad.event modificado(0,0)
		uo_calidad.em_campo.text=f_nombre_calidad_abr(codigo_empresa,uo_calidad.em_codigo.text)
		
		em_tono.text = this.object.tono[row]
		em_tono.event modificado(0,0)
		
		em_calibre.text = string(this.object.calibre[row],em_calibre.mask)
		em_calibre.event modificado(0,0)
		
		uo_tipo_pallet.em_codigo.text = this.object.tipo_pallet[row]
		uo_tipo_pallet.event modificado(0,0)
		
		uo_caja.em_codigo.text = this.object.caja[row]
		uo_caja.event modificado(0,0)
		
		//em_cantidad.event modificado(0,0)
		
		cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
										 uo_tipo_pallet.em_codigo.text,&
										 uo_caja.em_codigo.text,&
							 0,&
							 0,&
										 Dec(em_cantidad.text), uo_tipolinea.em_codigo.text)
	
	
		unidad_articulo = f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text)
		if unidad_articulo = "1" then
			em_cantidad_facturar.text =  string(f_cantidad_facturar_articulo(codigo_empresa,&
												  uo_articulo.em_codigo.text,&
												  uo_caja.em_codigo.text,&
												  dec(em_cantidad.text)))
		end if
		
		posi_aux = 1
		posi = pos(cadena,"|",1)
		if posi <> 0 then
			v_pallets = Mid(cadena,1,posi - 1)
	
			em_t_pallets.text     = Mid(cadena,1,posi - 1)
			posi_aux = posi + 1
		end if
		
		posi = pos(cadena,"|",posi_aux)
		if posi <> 0 then
			em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux )
			posi_aux = posi + 1
		end if
		
		posi = pos(cadena,"|",posi_aux)
		if posi <>0 then
			em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux )
			posi_aux = posi + 1
		end if
		
		posi = pos(cadena,"|",posi_aux)
		if posi <>0 then
			em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux )
			posi_aux = posi + 1
		end if
		
		posi = pos(cadena,"|",posi_aux)
		if posi <>0 then
			 em_mtrs_lineales.text  = Mid(cadena,posi_aux,posi - posi_aux )
		end if
	end if
else
	if il_id_alm_orden_carga > 0 then
		messagebox("¡Error!","No se puede reasignar stock a una linea de pedido en orden de carga.")
	end if
end if
end event

type st_texto_cantidad_facturar from statictext within w_int_venliped
boolean visible = false
integer x = 1687
integer y = 2124
integer width = 293
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 15780518
boolean enabled = false
string text = "Facturar"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type dw_lineas_clte from datawindow within w_int_venliped
boolean visible = false
integer x = 14
integer y = 1612
integer width = 2583
integer height = 600
integer taborder = 270
string dataobject = "dw_con_pedi_clte"
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event doubleclicked;This.visible = False
end event

type cb_reservas from u_boton within w_int_venliped
integer x = 654
integer y = 2796
integer width = 425
integer height = 96
integer taborder = 0
string text = "F6 Reservas"
end type

event clicked;IF This.enabled = FALSE Then RETURN
str_parametros valores
IF var_control_alm = "N" Then Return

f_consulta_reservas()

IF Message.DoubleParm=-1  THEN 
ELSE
END IF

f_activar_campo(uo_articulo.em_campo)

end event

type dw_pie from datawindow within w_int_venliped
boolean visible = false
integer x = 3790
integer y = 520
integer width = 2185
integer height = 760
integer taborder = 260
boolean titlebar = true
string title = "Pie de pedidos"
string dataobject = "dw_int_venliped3"
boolean controlmenu = true
boolean livescroll = true
end type

on clicked;This.visible = FALSE
f_activar_primer_campo()
end on

type sle_observaciones from singlelineedit within w_int_venliped
integer x = 5138
integer y = 2332
integer width = 992
integer height = 88
integer taborder = 190
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
borderstyle borderstyle = stylelowered!
end type

type st_8 from statictext within w_int_venliped
integer x = 5138
integer y = 2260
integer width = 992
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Observaciones"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_oc from statictext within w_int_venliped
integer x = 3099
integer y = 2456
integer width = 1326
integer height = 120
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 23282157
long backcolor = 553648127
alignment alignment = center!
boolean focusrectangle = false
end type

type uo_familia from u_em_campo_2 within w_int_venliped
event destroy ( )
integer x = 1381
integer y = 2516
integer width = 590
integer taborder = 210
boolean bringtotop = true
boolean border = true
long backcolor = 134217750
borderstyle borderstyle = stylelowered!
end type

on uo_familia.destroy
call u_em_campo_2::destroy
end on

event modificado;string descripcion

select descripcion
into :descripcion
from familias
where empresa = :codigo_empresa
and codigo = :uo_familia.em_codigo.text;

uo_familia.em_campo.text= descripcion
IF Trim(uo_familia.em_campo.text)="" THEN 
	IF Trim(uo_familia.em_codigo.text)<>"" Then uo_familia.em_campo.SetFocus()
	uo_familia.em_campo.text=""
	uo_familia.em_codigo.text=""
END IF




end event

event getfocus;call super::getfocus;ue_titulo     = "Ayuda seleccion de Familias"
ue_datawindow = "dw_ayuda_familias"
ue_filtro     = ""

end event

type p_1 from picture within w_int_venliped
integer x = 2021
integer y = 2768
integer width = 165
integer height = 144
boolean bringtotop = true
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_moneda from statictext within w_int_venliped
integer x = 2213
integer y = 2796
integer width = 302
integer height = 80
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_10 from statictext within w_int_venliped
integer x = 1385
integer y = 2436
integer width = 590
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Familia"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_dto from statictext within w_int_venliped
integer x = 2574
integer y = 2436
integer width = 178
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 15780518
boolean enabled = false
string text = "%Dto"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_deposito from statictext within w_int_venliped
boolean visible = false
integer x = 2450
integer y = 2440
integer width = 123
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Dep"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type deposito from statictext within w_int_venliped
boolean visible = false
integer x = 2450
integer y = 2516
integer width = 123
integer height = 84
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string pointer = "\BMP\Mano.cur"
long textcolor = 255
long backcolor = 12632256
boolean enabled = false
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

event doubleclicked;IF this.visible = FALSE Then Return 

IF This.text = "X" Then
	This.text = ""
ELSE
	This.text = "X"
END IF

end event

type em_cantidad_facturar from u_em_campo within w_int_venliped
boolean visible = false
integer x = 2153
integer y = 2516
integer width = 293
integer taborder = 0
boolean bringtotop = true
integer textsize = -9
fontcharset fontcharset = ansi!
string facename = "Arial"
boolean enabled = false
alignment alignment = right!
maskdatatype maskdatatype = decimalmask!
string mask = "###,###.00"
end type

event getfocus;call super::getfocus;IF var_control_alm = "N" Then st_texto_cantidad.text = "Unidades"
ante_valor= Dec(em_cantidad.text)
campo_actual = "CANTIDAD"
f_peso_linea()


end event

event modificado;call super::modificado;IF var_control_alm ="S"  and var_sector = "S" THEN
 If ante_valor<>Dec(em_cantidad.text) THEN
 em_cajas.text=""
 em_t_cajas.text=""
 em_t_pallets.text=""
 em_mtrs_lineales.text =""
 END  IF



 string cadena
 cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                            uo_tipo_pallet.em_codigo.text,&
                            uo_caja.em_codigo.text,&
									 integer(em_t_pallets.text),&
									 integer(em_cajas.text),&
                            Dec(em_cantidad.text), uo_tipolinea.em_codigo.text)
                       
 em_t_pallets.text     = Mid(cadena,1,6)
 em_cajas.text         = Mid(cadena,7,6)
 em_t_cajas.text       = Mid(cadena,13,6)
 em_cantidad.text      = Mid(cadena,19,9)
 em_mtrs_lineales.text = Mid(cadena,28,9)

f_calculo_precio()
END IF
f_peso_linea()

end event

type st_dto2 from statictext within w_int_venliped
integer x = 2766
integer y = 2436
integer width = 178
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 15780518
boolean enabled = false
string text = "%Dto"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_descuento2 from u_em_campo within w_int_venliped
integer x = 2761
integer y = 2516
integer width = 183
integer height = 88
integer taborder = 250
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = "xxxxxxxxxx"
string displaydata = ""
end type

on getfocus;call u_em_campo::getfocus;campo_actual = "DESCUENTO"
end on

type em_descuento from u_em_campo within w_int_venliped
integer x = 2569
integer y = 2516
integer width = 183
integer height = 88
integer taborder = 240
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = "xxxxxxxxxx"
string displaydata = ""
end type

on getfocus;call u_em_campo::getfocus;campo_actual = "DESCUENTO"
end on

type st_texto_cantidad from statictext within w_int_venliped
integer x = 4128
integer y = 2260
integer width = 270
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Cantidad"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_12 from statictext within w_int_venliped
integer x = 6135
integer y = 2260
integer width = 192
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 32238571
boolean enabled = false
string text = "Orden"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type sle_orden from singlelineedit within w_int_venliped
integer x = 6135
integer y = 2332
integer width = 197
integer height = 88
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
borderstyle borderstyle = stylelowered!
end type

type st_13 from statictext within w_int_venliped
integer x = 2464
integer y = 2436
integer width = 96
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "CI"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_14 from statictext within w_int_venliped
integer x = 1979
integer y = 2436
integer width = 480
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 15780518
boolean enabled = false
string text = "Tono Imprimir"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_tono_imprimir from u_em_campo within w_int_venliped
integer x = 1979
integer y = 2516
integer width = 480
integer height = 88
integer taborder = 220
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = "!!!!!!!!!!!!!!!!!!!!!"
end type

type em_calibre_imprimir from u_em_campo within w_int_venliped
integer x = 2459
integer y = 2516
integer width = 101
integer height = 88
integer taborder = 230
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = ""
end type

type st_info_extra from statictext within w_int_venliped
integer x = 3099
integer y = 2608
integer width = 1326
integer height = 340
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 23282157
long backcolor = 553648127
alignment alignment = center!
boolean focusrectangle = false
end type

type em_precio from u_em_campo within w_int_venliped
integer x = 4402
integer y = 2332
integer width = 247
integer height = 88
integer taborder = 150
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = decimalmask!
string mask = "###,###,###.00###"
end type

event modificado;call super::modificado;//if venped.divisa="1" then
//	This.text = String(Dec(This.text),"###,###,###,###.00")
//else
//f_mensaje("masc",f_mascara_precios_fra_moneda(venped.divisa))
	This.text = String(Dec(This.text),f_mascara_precios_fra_moneda(venped.divisa))
//end if

campo_actual = "PRECIO"

string ls_articulo,ls_caja
dec    ld_m2_caja
long   ll_piezas_caja

ls_articulo   = uo_articulo.em_codigo.text
ls_caja       = uo_caja.em_codigo.text

if f_unidad_articulo(codigo_empresa,ls_articulo) = "1" then
		
	ld_m2_caja     = f_metroscaja_articulo(codigo_empresa,ls_articulo,ls_caja)
	ll_piezas_caja = f_piezascaja_articulo(codigo_empresa,ls_articulo,ls_caja)
	
	if ll_piezas_caja <> 0 and ld_m2_caja <> 0 then
		em_precio_pzs.text = string( (dec(this.text) * ld_m2_caja) / ll_piezas_caja,em_precio_pzs.mask)
	else
		em_precio_pzs.text = "0"
	end if

else
	em_precio_pzs.text = this.text
end if

end event

event getfocus;call super::getfocus;//this.setmask(NumericMask!,f_mascara_precios_fra_moneda(venped.divisa))
end event

type em_precio_pzs from u_em_campo within w_int_venliped
integer x = 4402
integer y = 2332
integer width = 247
integer height = 88
integer taborder = 170
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = decimalmask!
string mask = "###,###,###.00###"
end type

event modified;call super::modified;string ls_articulo,ls_caja
dec    ld_m2_caja
long   ll_piezas_caja


ls_articulo   = uo_articulo.em_codigo.text
ls_caja       = uo_caja.em_codigo.text

if f_unidad_articulo(codigo_empresa,ls_articulo) = "1" then
		
	ld_m2_caja     = f_metroscaja_articulo(codigo_empresa,ls_articulo,ls_caja)
	ll_piezas_caja = f_piezascaja_articulo(codigo_empresa,ls_articulo,ls_caja)
	
	if ll_piezas_caja <> 0 and ld_m2_caja <> 0 then
		em_precio.text = string( (dec(this.text) * ll_piezas_caja) / ld_m2_caja,em_precio.mask)
	else
		em_precio.text = "0"
	end if

else
	em_precio.text = em_precio_pzs.text
end if

end event

type em_cantidad from u_em_campo within w_int_venliped
integer x = 4128
integer y = 2332
integer width = 270
integer height = 88
integer taborder = 120
fontcharset fontcharset = ansi!
string facename = "Arial"
string text = "0"
alignment alignment = right!
maskdatatype maskdatatype = decimalmask!
string mask = "###,###.00"
end type

event modificado;call super::modificado;string cadena, v_pallets, familia, unidad_articulo
Long   posi,posi_aux, n_piezascaja
Dec metroscaja

IF var_control_alm ="S"  and var_sector = "S" THEN
	If ante_valor<>Dec(em_cantidad.text) THEN
		 em_cajas.text=""
		 em_t_cajas.text=""
		 em_t_pallets.text=""
		 em_mtrs_lineales.text =""
	END  IF
 
 	cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                            uo_tipo_pallet.em_codigo.text,&
                            uo_caja.em_codigo.text,&
						 0,&
						 0,&
                            Dec(em_cantidad.text), uo_tipolinea.em_codigo.text)


	unidad_articulo = f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text)
	if unidad_articulo = "1" then
		em_cantidad_facturar.text =  string(f_cantidad_facturar_articulo(codigo_empresa,&
											  uo_articulo.em_codigo.text,&
											  uo_caja.em_codigo.text,&
											  dec(em_cantidad.text)))
		em_cantidad_facturar.ue_ante_valor = em_cantidad_facturar.text
	end if
	
	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		v_pallets = Mid(cadena,1,posi - 1)

		em_t_pallets.text     = Mid(cadena,1,posi - 1)
		em_t_pallets.ue_ante_valor = em_t_pallets.text
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux )
		em_cajas.ue_ante_valor = em_cajas.text
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux )
		em_t_cajas.ue_ante_valor = em_t_cajas.text
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux )
		em_cantidad.ue_ante_valor = em_cantidad.text
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		 em_mtrs_lineales.text  = Mid(cadena,posi_aux,posi - posi_aux )
		 em_mtrs_lineales.ue_ante_valor = em_mtrs_lineales.text
	end if
	
	em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)
	em_cantidad_en_pzs.ue_ante_valor = em_cantidad_en_pzs.text
	
	f_calculo_precio()
END IF
f_peso_linea()

n_piezascaja = 0
familia = ""
if not isnull(uo_articulo.em_codigo.text) and uo_articulo.em_codigo.text <> "" and not isnull(uo_caja.em_codigo.text) and uo_caja.em_codigo.text <> "" then
	SELECT  almartcajas.piezascaja, almartcajas.metroscaja, articulos.familia  
	INTO    	:n_piezascaja, :metroscaja, :familia  
	FROM    	almartcajas  INNER JOIN articulos ON almartcajas.empresa = articulos.empresa AND almartcajas.articulo = articulos.codigo  
	WHERE  almartcajas.empresa   = :codigo_empresa
	AND     	almartcajas.articulo  = :uo_articulo.em_codigo.text
	AND     	almartcajas.caja      = :uo_caja.em_codigo.text;
	if isnull(n_piezascaja) then n_piezascaja = 0
	if isnull(metroscaja) then metroscaja = 0
	//metroscaja = round(metroscaja,2)
end if

if not isnull(familia) and familia = '2' or unidad_articulo = '1' then
	if unidad_articulo = "0" then
		if n_piezascaja > 0 and long(em_cantidad.text) > 0 then
			if mod(long(em_cantidad.text), n_piezascaja) <> 0 then
				st_info_extra.text = "ATENCIÓN WOW: Caja INCOMPLETA. Añada +1 en cajas para corregirlo (excepto promoción)."
			else
				st_info_extra.text = ""
			end if
		else
			st_info_extra.text = ""
		end if 
	elseif unidad_articulo = "1" then
		if metroscaja > 0 and dec(em_cantidad.text) > 0 then
			if mod(dec(em_cantidad.text), metroscaja) <> 0 then
				st_info_extra.text = "ATENCIÓN WOW: Caja INCOMPLETA. Añada +1 en cajas para corregirlo (excepto promoción)."
			else
				st_info_extra.text = ""
			end if
		else
			st_info_extra.text = ""
		end if 
	end if
else
	st_info_extra.text = ""
end if

Dec n_cajaspallet, t_cajas
n_cajaspallet = 0
t_cajas = dec(em_t_cajas.text)

SELECT    palarticulo.cajaspallet INTO :n_cajaspallet FROM palarticulo
WHERE    palarticulo.empresa  = :codigo_empresa 
AND      palarticulo.articulo = :uo_articulo.em_codigo.text
AND      palarticulo.codigo   = :uo_tipo_pallet.em_codigo.text 
AND      palarticulo.caja     = :uo_caja.em_codigo.text;
if not isnull(n_cajaspallet) and n_cajaspallet > 0 and t_cajas > 0 and not isnull(familia) and familia = '2' then
	if mod(t_cajas, n_cajaspallet) <> 0 then
		if st_info_extra.text = "" then
			st_info_extra.text = "ATENCIÓN WOW: "
		end if
		st_info_extra.text = st_info_extra.text + "Pallet INCOMPLETO."
	end if
end if 

em_situacion.text = "F"

end event

event getfocus;call super::getfocus;IF var_control_alm = "N" Then st_texto_cantidad.text = "Unidades"
ante_valor= Dec(em_cantidad.text)
campo_actual = "CANTIDAD"
f_peso_linea()


end event

type em_cantidad_en_pzs from u_em_campo within w_int_venliped
integer x = 4128
integer y = 2332
integer width = 270
integer height = 88
integer taborder = 140
fontcharset fontcharset = ansi!
string facename = "Arial"
string text = "0"
alignment alignment = right!
maskdatatype maskdatatype = decimalmask!
string mask = "###,##0"
end type

event getfocus;//Para debug
integer li_x

li_x = 0
call super::getfocus
end event

event losefocus;//Para debug
integer li_x

li_x = 0
call super::losefocus
end event

event modificado;call super::modificado;dec ld_cantidad
long ll_cantidad_en_pzs

ll_cantidad_en_pzs = long(this.text)

ld_cantidad = f_conversion_piezas_cantidad(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text,ll_cantidad_en_pzs)

em_cantidad.text = string(ld_cantidad,em_cantidad.mask)

em_cantidad.event modificado(0,0)
//El modificado de em_cantidad cambia el valor de este campo
//Volvemos a asignar el valor original:
this.text = string(ll_cantidad_en_pzs,this.mask)
this.ue_ante_valor = this.text

end event

type st_observaciones from statictext within w_int_venliped
boolean visible = false
integer x = 2958
integer y = 2464
integer width = 1435
integer height = 476
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 65535
boolean border = true
boolean focusrectangle = false
end type

type dw_detalle from datawindow within w_int_venliped
integer x = 9
integer y = 236
integer width = 6336
integer height = 1988
string dataobject = "dw_int_venliped2"
boolean vscrollbar = true
end type

event clicked;
IF Row = 0 Then 
   f_activar_primer_campo()
   Return
End IF

This.SelectRow(0,FALSE)
This.SelectRow(Row,TRUE)

il_id_alm_orden_carga = this.object.id_alm_orden_carga[row]
if isnull(il_id_alm_orden_carga) then il_id_alm_orden_carga = 0

uo_tipolinea.em_codigo.text    = This.GetItemString(Row,"tipolinea")
uo_tipolinea.event modificado(0,0)
uo_tipolinea.ue_valor_anterior = uo_tipolinea.em_campo.text

uo_articulo.em_codigo.text    = This.GetItemString(Row,"articulo")
uo_articulo.event modificado(0,1) 
uo_articulo.ue_valor_anterior = uo_articulo.em_campo.text

cod_tipo_unidad               = This.GetItemString(Row,"tipo_unidad")

//if uo_tipolinea.em_codigo.text = "4" then cod_tipo_unidad = "0"  //MUY IMPORTANTE: LAS MUESTRAS SIEMPRE VAN EN PIEZAS. TAMBIÉN CONTROLADO EN f_calculo_unidades_tipolin

//st_texto_cantidad.text = f_nombre_unidad(f_codigo_articulo_unidad(codigo_empresa,uo_articulo.em_codigo.text))

if uo_articulo.em_campo.text <> "" then
	em_cantidad.Setmask(DecimalMask!,f_mascara_unidad(cod_tipo_unidad))
else
	Int decimales 
	String mascara
	decimales = ftc_decimales_articulo(codigo_empresa, uo_articulo.em_codigo.text)
	if decimales > 0 then
		mascara = "###,##0."+fill("0",decimales)
	else
		mascara = "###,##0"
	end if
	em_cantidad.Setmask(DecimalMask!,mascara)
end if

uo_familia.em_codigo.text    = This.GetItemString(Row,"familia")
uo_familia.event modificado(0,0)//triggerevent("modificado")
uo_familia.ue_valor_anterior = uo_familia.em_campo.text

uo_calidad.em_codigo.text    = This.GetItemString(Row,"calidad")
uo_calidad.event modificado(0,0)
uo_calidad.ue_valor_anterior = uo_calidad.em_campo.text

uo_caja.em_codigo.text    = This.GetItemString(Row,"caja")
uo_caja.event modificado(0,0)
uo_caja.ue_valor_anterior = uo_tipo_pallet.em_campo.text

uo_tipo_pallet.em_codigo.text = This.GetItemString(Row,"tipo_pallet")
uo_tipo_pallet.event modificado(0,0)
uo_tipo_pallet.ue_valor_anterior = uo_articulo.em_campo.text

em_cajas.text                 = String(This.GetItemNumber(Row,"cajas"))
em_cantidad.text              = String(This.GetItemNumber(Row,"cantidad"))
em_cantidad.ue_ante_valor     = em_cantidad.text

em_cantidad_en_pzs.text       = String(This.GetItemNumber(Row,"venliped_cantidad_pzs"))
em_cantidad_en_pzs.ue_ante_valor = em_cantidad_en_pzs.text

em_cantidad_facturar.text     = String(This.GetItemNumber(Row,"venliped_cantidad_facturar"))
em_cantidad_facturar.ue_ante_valor = em_cantidad_facturar.text

if ib_gestionar_en_piezas then
	em_cantidad_en_pzs.event modificado(0,0)
else
	em_cantidad.event modificado(0,0)
end if

ante_existencias              = Dec(em_cantidad.text)
em_descripcion.text           = This.GetItemString(Row,"descripcion")
em_mtrs_lineales.text         = String(This.GetItemNumber(Row,"metros_lineales"))
ante_valor                    = This.GetItemNumber(Row,"precio")
//em_situacion.text             = This.GetItemString(Row,"situacion")
em_t_cajas.text               = String(This.GetItemNumber(Row,"total_cajas"))
em_t_cajas.ue_ante_valor = em_t_cajas.text

em_tono.text                  = String(This.GetItemString(Row,"tonochar"))
em_tono.ue_ante_valor = em_tono.text

em_calibre.text               = String(This.GetItemNumber(Row,"calibre"))
em_calibre.ue_ante_valor = em_calibre.text

em_tono_imprimir.text         = This.GetItemString(Row,"tono_imprimir")
em_calibre_imprimir.text      = This.GetItemString(Row,"calibre_imprimir")

uo_idioma.em_codigo.text      = This.GetItemString(Row,"venliped_idioma")
uo_idioma.em_campo.text       = This.GetItemString(Row,"venliped_idioma")

em_t_pallets.text             = String(This.GetItemNumber(Row,"pallets"))
em_t_pallets.ue_ante_valor = em_t_pallets.text

linea_pedido                  = This.GetItemNumber(Row,"linea")
control_incremento            = This.GetItemString(Row,"control_incremento")

referencia_ant                = This.GetItemString(Row,"referencia")
tipopallet_ant                = This.GetItemString(Row,"tipo_pallet")
cod_familia                   = This.GetItemString(Row,"familia")
cod_formato                   = This.GetItemString(Row,"formato")
var_situacion                 = This.GetItemString(Row,"situacion")
em_precio.text                = f_valor_columna(This,Row,"precio")
em_precio_pzs.text            = f_valor_columna(This,Row,"venliped_precio_pzs")

em_descuento.text             = String(This.GetItemNumber(Row,"dtoesp"))
em_descuento2.text				= String(This.GetItemNumber(Row,"venliped_dtoesp2"))
em_fecha_intr.text				= string(date(object.fecha_intr[row]))
em_npal.text				      = String(This.GetItemNumber(Row,"venliped_numpalet"))

st_articulo.text = "Artículo " + f_nombre_formato_abr (codigo_empresa,cod_formato)
planificado 						= This.GetItemString(Row,"venliped_planificado")
sle_observaciones.text 			= This.GetItemString(Row,"venliped_observaciones")
sle_orden.text 			=  string(This.GetItemNumber(Row,"venliped_orden"))

tipo="M"  /* M = Modificacion,    I = Inserción */     
f_botones()
f_peso_linea()
f_deposito()
IF This.GetItemString(Row,"deposito") = "S" Then
		deposito.text = "X"
ELSE
		deposito.text = ""
END IF

em_situacion.text             = This.GetItemString(Row,"situacion")

var_sector  = f_sector_familia(codigo_empresa,f_familia_articulo(codigo_empresa,uo_articulo.em_codigo.text))
f_activar_primer_campo()
f_campos_segun_tiplin()
st_pz.text = string(f_piezascaja_articulo(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text),"###,###")
st_pal.text = string(f_cajas_pallet_articulo(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text,uo_caja.em_codigo.text),"###,###")

this.event rowfocuschanged(row)

Return
end event

event doubleclicked;//Dec v_pedido,v_anyo,v_linea
//String v_tipolinea
//Boolean v_cambio=false
//
//if row=0 then return
//
//v_anyo      = dw_detalle.GetItemNumber(GetRow(),"anyo")
//v_pedido    = dw_detalle.GetItemNumber(GetRow(),"pedido")
//v_linea     = dw_detalle.GetItemNumber(GetRow(),"linea")
//v_tipolinea = dw_detalle.GetItemString(GetRow(),"tipolinea")
//
//if v_tipolinea = "1" then 
//	v_tipolinea="7"
//	v_cambio = true
//else 
//	if v_tipolinea="7" then
//		v_tipolinea="1"
//		v_cambio = true
//	end if
//end if
//
//if v_cambio then
//	update venliped
//	set tipolinea = :v_tipolinea
//	where empresa = :codigo_empresa
//	and   anyo    = :v_anyo
//	and   pedido  = :v_pedido
//	and   linea   = :v_linea
//	using sqlca;
//	
//	if sqlca.sqlcode = 0 then
//		COMMIT;
//		f_control()
//	else
//		f_mensaje ("Introducción de líneas","Error en el cambio de tipo de línea")
//		ROLLBACK;
//	end if
//		
//end if	
end event

event rowfocuschanged;Dec var_linea

if currentrow <= 0 then
	return
end if

var_linea = This.GetItemNumber(currentrow,"linea")

//ORDEN DE CARGA
if ftc_linea_en_orden_carga(Dec(em_anyo.text),Dec(em_pedido.text),var_linea) and tipo <> "I" then
	st_oc.text = "LÍNEA EN ORDEN DE CARGA."
	ib_linea_en_orden_de_carga = true
	//cb_grabar.enabled = false
	uo_tipolinea.enabled = false
	uo_articulo.enabled = false
	uo_idioma.enabled = false
	uo_calidad.enabled = false
	em_tono.enabled = false
	em_calibre.enabled = false
	uo_caja.enabled = false
	uo_tipo_pallet.enabled = false
	em_t_pallets.enabled = false
	em_cajas.enabled = false
	em_t_cajas.enabled = false
	em_mtrs_lineales.enabled = false
	em_cantidad.enabled = false
else
	st_oc.text = ""
	ib_linea_en_orden_de_carga = false
	//cb_grabar.enabled = true
	uo_tipolinea.enabled = true
	uo_articulo.enabled = true
	uo_idioma.enabled = true
	uo_calidad.enabled = true
	em_tono.enabled = true
	em_calibre.enabled = true
	uo_caja.enabled = true
	uo_tipo_pallet.enabled = true
	em_t_pallets.enabled = true
	em_cajas.enabled = true
	em_t_cajas.enabled = true
	em_mtrs_lineales.enabled = true
	em_cantidad.enabled = true
end if
end event

