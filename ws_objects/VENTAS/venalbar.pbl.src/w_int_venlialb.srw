$PBExportHeader$w_int_venlialb.srw
forward
global type w_int_venlialb from w_int_con_empresa
end type
type pb_1 from upb_salir within w_int_venlialb
end type
type st_3 from statictext within w_int_venlialb
end type
type st_texto_cantidad from statictext within w_int_venlialb
end type
type st_pallets from statictext within w_int_venlialb
end type
type st_total_cajas from statictext within w_int_venlialb
end type
type st_cajas from statictext within w_int_venlialb
end type
type st_tipopallet from statictext within w_int_venlialb
end type
type st_calidad from statictext within w_int_venlialb
end type
type st_articulo from statictext within w_int_venlialb
end type
type em_t_pallets from u_em_campo within w_int_venlialb
end type
type em_cajas from u_em_campo within w_int_venlialb
end type
type em_t_cajas from u_em_campo within w_int_venlialb
end type
type em_cantidad from u_em_campo within w_int_venlialb
end type
type uo_articulo from u_em_campo_2 within w_int_venlialb
end type
type uo_tipo_pallet from u_em_campo_2 within w_int_venlialb
end type
type st_texto_mtrslinieales from statictext within w_int_venlialb
end type
type em_mtrs_lineales from u_em_campo within w_int_venlialb
end type
type em_cliente from u_em_campo within w_int_venlialb
end type
type st_nombre_cliente from statictext within w_int_venlialb
end type
type st_texto_precio from statictext within w_int_venlialb
end type
type em_precio from u_em_campo within w_int_venlialb
end type
type em_descripcion from u_em_campo within w_int_venlialb
end type
type st_33 from statictext within w_int_venlialb
end type
type uo_tipolinea from u_em_campo_2 within w_int_venlialb
end type
type st_tplinea from statictext within w_int_venlialb
end type
type st_dto from statictext within w_int_venlialb
end type
type em_descuento from u_em_campo within w_int_venlialb
end type
type dw_pie from datawindow within w_int_venlialb
end type
type em_anyo from u_em_campo within w_int_venlialb
end type
type gb_6 from groupbox within w_int_venlialb
end type
type gb_3 from groupbox within w_int_venlialb
end type
type em_situacion from u_em_campo within w_int_venlialb
end type
type em_albaran from u_em_campo within w_int_venlialb
end type
type st_4 from statictext within w_int_venlialb
end type
type st_5 from statictext within w_int_venlialb
end type
type st_peso_linea from statictext within w_int_venlialb
end type
type gb_1 from groupbox within w_int_venlialb
end type
type st_2 from statictext within w_int_venlialb
end type
type em_porcentaje from u_em_campo within w_int_venlialb
end type
type st_proforma from dropdownlistbox within w_int_venlialb
end type
type st_6 from statictext within w_int_venlialb
end type
type st_peso_total from statictext within w_int_venlialb
end type
type st_7 from statictext within w_int_venlialb
end type
type st_tono from statictext within w_int_venlialb
end type
type em_tono from u_em_campo within w_int_venlialb
end type
type st_calibre from statictext within w_int_venlialb
end type
type em_calibre from u_em_campo within w_int_venlialb
end type
type gb_2 from groupbox within w_int_venlialb
end type
type cb_stock from u_boton within w_int_venlialb
end type
type cb_grabar from u_boton within w_int_venlialb
end type
type cb_borrar from u_boton within w_int_venlialb
end type
type cb_valorar from u_boton within w_int_venlialb
end type
type cb_reservas from u_boton within w_int_venlialb
end type
type cb_palmenos from u_boton within w_int_venlialb
end type
type cb_cajmenos from u_boton within w_int_venlialb
end type
type cb_insertar from u_boton within w_int_venlialb
end type
type st_caja from statictext within w_int_venlialb
end type
type uo_caja from u_em_campo_2 within w_int_venlialb
end type
type st_dto2 from statictext within w_int_venlialb
end type
type em_descuento2 from u_em_campo within w_int_venlialb
end type
type st_texto_npalet from statictext within w_int_venlialb
end type
type em_npal from u_em_campo within w_int_venlialb
end type
type p_1 from picture within w_int_venlialb
end type
type st_moneda from statictext within w_int_venlialb
end type
type st_idioma from statictext within w_int_venlialb
end type
type uo_idioma from u_em_campo_2 within w_int_venlialb
end type
type uo_calidad from u_em_campo_2 within w_int_venlialb
end type
type dw_detalle from datawindow within w_int_venlialb
end type
type cb_palmas from u_boton within w_int_venlialb
end type
type cb_cajmas from u_boton within w_int_venlialb
end type
type em_tono_imprimir from u_em_campo within w_int_venlialb
end type
type em_calibre_imprimir from u_em_campo within w_int_venlialb
end type
type st_1 from statictext within w_int_venlialb
end type
type st_8 from statictext within w_int_venlialb
end type
type em_precio_pzs from u_em_campo within w_int_venlialb
end type
type gb_4 from groupbox within w_int_venlialb
end type
type em_cantidad_en_pzs from u_em_campo within w_int_venlialb
end type
end forward

global type w_int_venlialb from w_int_con_empresa
integer x = 14
integer y = 16
integer width = 5207
integer height = 2788
pb_1 pb_1
st_3 st_3
st_texto_cantidad st_texto_cantidad
st_pallets st_pallets
st_total_cajas st_total_cajas
st_cajas st_cajas
st_tipopallet st_tipopallet
st_calidad st_calidad
st_articulo st_articulo
em_t_pallets em_t_pallets
em_cajas em_cajas
em_t_cajas em_t_cajas
em_cantidad em_cantidad
uo_articulo uo_articulo
uo_tipo_pallet uo_tipo_pallet
st_texto_mtrslinieales st_texto_mtrslinieales
em_mtrs_lineales em_mtrs_lineales
em_cliente em_cliente
st_nombre_cliente st_nombre_cliente
st_texto_precio st_texto_precio
em_precio em_precio
em_descripcion em_descripcion
st_33 st_33
uo_tipolinea uo_tipolinea
st_tplinea st_tplinea
st_dto st_dto
em_descuento em_descuento
dw_pie dw_pie
em_anyo em_anyo
gb_6 gb_6
gb_3 gb_3
em_situacion em_situacion
em_albaran em_albaran
st_4 st_4
st_5 st_5
st_peso_linea st_peso_linea
gb_1 gb_1
st_2 st_2
em_porcentaje em_porcentaje
st_proforma st_proforma
st_6 st_6
st_peso_total st_peso_total
st_7 st_7
st_tono st_tono
em_tono em_tono
st_calibre st_calibre
em_calibre em_calibre
gb_2 gb_2
cb_stock cb_stock
cb_grabar cb_grabar
cb_borrar cb_borrar
cb_valorar cb_valorar
cb_reservas cb_reservas
cb_palmenos cb_palmenos
cb_cajmenos cb_cajmenos
cb_insertar cb_insertar
st_caja st_caja
uo_caja uo_caja
st_dto2 st_dto2
em_descuento2 em_descuento2
st_texto_npalet st_texto_npalet
em_npal em_npal
p_1 p_1
st_moneda st_moneda
st_idioma st_idioma
uo_idioma uo_idioma
uo_calidad uo_calidad
dw_detalle dw_detalle
cb_palmas cb_palmas
cb_cajmas cb_cajmas
em_tono_imprimir em_tono_imprimir
em_calibre_imprimir em_calibre_imprimir
st_1 st_1
st_8 st_8
em_precio_pzs em_precio_pzs
gb_4 gb_4
em_cantidad_en_pzs em_cantidad_en_pzs
end type
global w_int_venlialb w_int_venlialb

type variables
string filtro,bloqueado
Integer bien,ante_pallets,ante_cajas
decimal{2} ante_valor
str_almmovhis mov
String  tipo // I-> inserción , M -> Modificación
Dec{0}  linea_albaran
String  cod_tipo_unidad,cod_formato,cod_familia,var_control_alm,var_sector,var_clase,control_incremento
String articulo_ant,idioma_ant,calidad_ant,tipolinea_ant,referencia_ant,tipopallet_ant
Dec{2} precio_ant,ante_existencias
str_venalb venalb
String campo_actual,var_situacion
Integer tipo_precio
boolean ib_gestionar_en_piezas = false
long il_id_alm_orden_carga
end variables

forward prototypes
public subroutine f_grabar_linea ()
public subroutine f_borrar_linea ()
public subroutine f_botones ()
public subroutine f_calculo_precio ()
public subroutine f_consulta_disponible ()
public subroutine f_activar_primer_campo ()
public subroutine f_consulta_reservas ()
public subroutine f_campos_segun_tiplin ()
public subroutine f_control ()
public subroutine f_peso_linea ()
public subroutine f_recalcular_lineas ()
end prototypes

public subroutine f_grabar_linea ();IF tipo = "I" Then
	IF var_control_alm = "S" Then
		f_mensaje("No se puede grabar la linea"," Solo linea sin control de almacen")
		Return
	END IF
END IF

str_venlialb linalb
str_venalb   ped 

SetNull(linalb.anyo_ent)
SetNull(linalb.nummov_ent)
SetNull(linalb.anyo_sal)
SetNull(linalb.nummov_sal)
SetNull(linalb.fila_ent)
SetNull(linalb.altura_ent)
SetNull(linalb.operario_prepa)
linalb.numpalet = dec(em_npal.text)
linalb.cantidad_original   = Dec(em_cantidad.text)
SetNull(linalb.linea_desdoblada_de)
if isnull(linalb.numpalet) then linalb.numpalet = 0

Dec{0}  ultima,albaran,periodo,parcial_pallets
Dec{2}  parcial_cantidad,parcial_cajas
periodo   =  Integer(em_anyo.text)
albaran    =  Dec(em_albaran.text)
IF tipo = "M" Then
  SELECT venlialb.precio_estand,   
         venlialb.orden_preparacion,   
         venlialb.cantidad_prepa,   
         venlialb.es_pico,   
         venlialb.numero_pico,   
         venlialb.anyo_ent,   
         venlialb.nummov_ent,   
         venlialb.anyo_sal,   
         venlialb.nummov_sal,   
         venlialb.fila_ent,   
         venlialb.altura_ent,   
         venlialb.operario_prepa,   
         venlialb.almacen_ent,   
         venlialb.precio_aduana,   
         venlialb.precio,
			venlialb.cantidad_original,
			venlialb.linea_desdoblada_de
    INTO :linalb.precio_estand,   
         :linalb.orden_preparacion,   
         :linalb.cantidad_prepa,   
         :linalb.es_pico,   
         :linalb.numero_pico,   
         :linalb.anyo_ent,   
         :linalb.nummov_ent,   
         :linalb.anyo_sal,   
         :linalb.nummov_sal,   
         :linalb.fila_ent,   
         :linalb.altura_ent,   
         :linalb.operario_prepa,   
         :linalb.almacen_ent,   
         :linalb.precio_aduana,   
         :linalb.precio,
			:linalb.cantidad_original,
			:linalb.linea_desdoblada_de
   	From venlialb
	WHERE ( venlialb.empresa   = :codigo_empresa ) AND  
         ( venlialb.anyo      = :periodo ) AND  
         ( venlialb.albaran   = :albaran ) AND  
         ( venlialb.linea     = :linea_albaran)   ;
			IF sqlca.Sqlcode <> 0 Then f_mensaje("Error en base de datos",Sqlca.SqlErrText)
		END IF
linalb.control_incremento = control_incremento 
IF Trim(linalb.control_incremento) = "" or IsNull(linalb.control_incremento) Then
 	linalb.control_incremento = "S"
END IF	

IF tipo ="I" THEN
	ultima =  0
	Select max(venlialb.linea) Into :ultima From venlialb
	Where  venlialb.empresa   =   :codigo_empresa
	And    venlialb.anyo      =   :periodo
	And    venlialb.albaran    =   :albaran;
	IF ISNull(ultima) Then ultima=0
	ultima = ultima +1
END IF

linalb.empresa   = venalb.empresa
linalb.anyo      = venalb.anyo
linalb.albaran   = venalb.albaran
linalb.falbaran  = venalb.falbaran
linalb.cliente   = venalb.cliente
linalb.tipoiva   = venalb.tipoiva
linalb.iva       = venalb.iva
linalb.divisa    = venalb.divisa
linalb.serie     = venalb.serie
linalb.zona      = venalb.zona
linalb.agente1   = venalb.agente1
linalb.agente2   = venalb.agente2
linalb.agente3   = venalb.agente3
linalb.comision11= venalb.comision1
linalb.comision12= venalb.comision11
linalb.comision21= venalb.comision2
linalb.comision22= venalb.comision22
linalb.comision31= venalb.comision31
linalb.comision32= venalb.comision32
linalb.linea     = ultima
linalb.articulo  = uo_articulo.em_codigo.text
IF IsNUll(linalb.articulo) Then linalb.articulo = ""
linalb.calidad    = uo_calidad.em_codigo.text
linalb.clase      = var_clase
linalb.tonochar   = Trim(em_tono.text)
linalb.calibre    = Dec(em_calibre.text)
linalb.tono_imprimir   = Trim(em_tono_imprimir.text)
linalb.calibre_imprimir= trim(em_calibre_imprimir.text)
linalb.tipolinea  = uo_tipolinea.em_codigo.text
linalb.idioma     = uo_idioma.em_campo.text

IF Isnull(linalb.tonochar) Then linalb.tonochar = ""
IF Isnull(linalb.calibre)  Then linalb.calibre = 0
linalb.sector = "N"
IF Not IsNull(linalb.articulo) and Trim(linalb.articulo) <> "" Then
	SELECT articulos.empresa,articulos.codigo,articulos.familia,
			 articulos.formato,articulos.modelo,articulos.unidad,
			 articulos.pesopieza,articulos.sector
	INTO   :linalb.empresa,:linalb.articulo,:linalb.familia,:linalb.formato,
			 :linalb.modelo,:linalb.tipo_unidad,:linalb.peso,:linalb.sector    
	FROM articulos  
	WHERE (articulos.empresa = :codigo_empresa )
AND   (articulos.codigo = :linalb.articulo );
END IF

linalb.calidad         = uo_calidad.em_codigo.text
IF tipo_precio = 1 Then
	linalb.precio       			   = Dec(em_precio.text)
ELSE
	linalb.precio_aduana          = Dec(em_precio.text)
END IF

linalb.precio_pzs      = Dec(em_precio_pzs.text)

linalb.precio_estand   = f_precio_articulo(linalb.empresa,linalb.cliente,linalb.articulo,linalb.calidad,f_tarifa_venalb(linalb.empresa,linalb.anyo,linalb.albaran))
linalb.cantidad        = Dec(em_cantidad.text)
linalb.pallets         = Integer(em_t_pallets.text)
linalb.total_cajas     = Integer(em_t_cajas.text)
linalb.cajas           = Integer(em_cajas.text)
linalb.cantidad_pzs    = Dec(em_cantidad_en_pzs.text)
linalb.dtocomer        = 0
If IsNull(em_descuento.text) or Trim(em_descuento.text) ="" THEN
   em_descuento.text ="0"
END IF
If IsNull(em_descuento2.text) or Trim(em_descuento2.text) ="" THEN
   em_descuento2.text ="0"
END IF
linalb.dtoesp          = Dec(em_descuento.text)
linalb.dtoesp2			  = dec(em_descuento2.text)
linalb.descripcion     = em_descripcion.text


SELECT familias.linea INTO :linalb.linfab FROM familias  
WHERE ( familias.empresa = :codigo_empresa ) AND  
         ( familias.codigo = :linalb.familia )   ;
String   var_tipoter
SELECT genter.empresa,genter.tipoter,genter.codigo,genter.pais,
       genter.provincia  
INTO   :ped.empresa,:var_tipoter,:ped.cliente,:linalb.pais,:linalb.provincia  
FROM   genter  
WHERE (genter.empresa = :codigo_empresa)
AND   (genter.tipoter = 'C' )
AND   (genter.codigo = :linalb.cliente )   ;

linalb.tipolinea       = uo_tipolinea.em_codigo.text
linalb.texto1          = ""
linalb.texto2          = ""
linalb.texto3          = ""
linalb.situacion       = em_situacion.text
linalb.metros_lineales = Dec(em_mtrs_lineales.text)
linalb.falta           = Datetime(today())
linalb.usuario         = nombre_usuario
linalb.tipo_pallet     = uo_tipo_pallet.em_codigo.text
linalb.caja            = uo_caja.em_codigo.text
linalb.deposito        = "N"
IF Trim(linalb.articulo) <> "" Then
//	linalb.peso       = f_calculo_peso(codigo_empresa,linalb.articulo,linalb.tipo_pallet,linalb.cajas,linalb.total_cajas,linalb.pallets,linalb.cantidad,linalb.caja)
//	linalb.peso_neto  = f_calculo_peso_neto(codigo_empresa,linalb.articulo,linalb.cajas,linalb.total_cajas,linalb.cantidad,linalb.caja)
	linalb.referencia      = f_componer_ref(linalb.articulo,linalb.calidad,linalb.tonochar,linalb.calibre)
	linalb.montajeartcal   = f_componer_artcal(linalb.articulo,linalb.calidad)
ELSE
	linalb.peso      = 0
	linalb.peso_neto = 0
	linalb.referencia   = ""
	linalb.montajeartcal   = ""
END IF
linalb.control_comisiones  =  f_comision_ventipolin(codigo_empresa,linalb.tipolinea)
linalb.control_descuentos  =  f_descuento_ventipolin(codigo_empresa,linalb.tipolinea)
IF tipo="M" THEN

  UPDATE venlialb  
     SET venlialb.falbaran = :linalb.falbaran,   
         venlialb.fentrega = :linalb.fentrega,   
         venlialb.cliente = :linalb.cliente,   
         venlialb.tipo_unidad = :linalb.tipo_unidad,   
         venlialb.articulo = :linalb.articulo,   
         venlialb.familia = :linalb.familia,   
         venlialb.formato = :linalb.formato,   
         venlialb.modelo = :linalb.modelo,   
         venlialb.calidad = :linalb.calidad,   
         venlialb.tonochar = :linalb.tonochar,   
         venlialb.calibre = :linalb.calibre,   
         venlialb.precio = :linalb.precio,   
         venlialb.precio_estand = :linalb.precio_estand,   
         venlialb.cantidad = :linalb.cantidad,   
         venlialb.pallets = :linalb.pallets,   
         venlialb.total_cajas = :linalb.total_cajas,   
         venlialb.cajas = :linalb.cajas,   
         venlialb.dtoesp = :linalb.dtoesp,   
         venlialb.descripcion = :linalb.descripcion,   
         venlialb.tipoiva = :linalb.tipoiva,   
         venlialb.iva = :linalb.iva,   
         venlialb.provincia = :linalb.provincia,   
         venlialb.pais = :linalb.pais,   
         venlialb.tipolinea = :linalb.tipolinea,   
         venlialb.referencia = :linalb.referencia,   
         venlialb.montajeartcal = :linalb.montajeartcal,   
         venlialb.metros_lineales = :linalb.metros_lineales,   
//         venlialb.peso = :linalb. peso,   
         venlialb.falta = :linalb.falta,   
         venlialb.usuario = :linalb.usuario,   
         venlialb.tipo_pallet = :linalb.tipo_pallet,   
         venlialb.caja = :linalb.caja,   			
         venlialb.importe = :linalb.importe,   
         venlialb.descuento = :linalb.descuento,   
         venlialb.importedto = :linalb.importedto,   
         venlialb.clase = :linalb.clase,   
         venlialb.sector = :linalb.sector,   
         venlialb.agente1 = :linalb.agente1,   
         venlialb.agente2 = :linalb.agente2,   
         venlialb.agente3 = :linalb.agente3,   
         venlialb.comision11 = :linalb.comision11,   
         venlialb.comision12 = :linalb.comision12,   
         venlialb.comision21 = :linalb.comision21,   
         venlialb.comision22 = :linalb.comision22,   
         venlialb.comision31 = :linalb.comision31,   
         venlialb.comision32 = :linalb.comision32,   
         venlialb.deposito = :linalb.deposito,   
//         venlialb.peso_neto = :linalb.peso_neto,   
         venlialb.precio_aduana = :linalb.precio_aduana,   
         venlialb.control_descuentos = :linalb.control_descuentos,   
         venlialb.control_comisiones = :linalb.control_comisiones,   
         venlialb.importe_aduana = :linalb.importe_aduana,   
         venlialb.bruto = :linalb.bruto  ,
			venlialb.dtoesp2 = :linalb.dtoesp2,
			venlialb.numpalet = :linalb.numpalet,
			venlialb.idioma   = :linalb.idioma,
			venlialb.cantidad_original = :linalb.cantidad_original,
			venlialb.linea_desdoblada_de = :linalb.linea_desdoblada_de,
         venlialb.tono_imprimir = :linalb.tono_imprimir,   
         venlialb.calibre_imprimir = :linalb.calibre_imprimir,
			venlialb.cantidad_pzs = :linalb.cantidad_pzs,
			venlialb.precio_pzs = :linalb.precio_pzs
			Where  empresa = :codigo_empresa
			And     anyo   = :periodo
			And     albaran= :albaran
			and     linea  = :linea_albaran;
		IF SQLCA.SQLCODE <> 0 Then f_mensaje("Error en base de datos",sqlca.sqlerrtext)
		linalb.linea = linea_albaran

ELSE
 IF var_control_alm = "N" Then 
    SetNull(linalb.articulo)
    SetNull(linalb.formato)
    SetNull(linalb.modelo)
    SetNull(linalb.calidad)
    SetNull(linalb.tonochar)
    SetNull(linalb.calibre)
    SetNull(linalb.pallets)
    SetNull(linalb.total_cajas)
    SetNull(linalb.cajas)
    SetNull(linalb.linfab)
    SetNull(linalb.referencia)
    SetNull(linalb.montajeartcal)
    SetNull(linalb.tipo_pallet)
    SetNull(linalb.caja)
    linalb.tipo_unidad = "0"
	 linalb.anyo_proddiaria = 0
	 linalb.contador_proddiaria = 0
	 linalb.idioma = "0"
	 linalb.linea_desdoblada_de = 0
  END IF
  iF Trim(linalb.articulo) = "" Then SetNull(linalb.articulo)
  linalb.descripcion     = em_descripcion.text
  f_insertar_venlialb(linalb)
 END IF
COMMIT;
f_actualizar_linea_venalbaran(codigo_empresa,periodo,albaran,linalb.linea)
f_actualizar_venalbaran(codigo_empresa,periodo,albaran)
commit;
end subroutine

public subroutine f_borrar_linea ();Dec{0}periodo,albaran

periodo = Dec(em_anyo.text)
albaran  = Dec(em_albaran.text)

   DELETE FROM venlialb 
   WHERE ( venlialb.empresa = :codigo_empresa ) AND  
         ( venlialb.anyo    = :periodo ) AND  
         ( venlialb.albaran  = :albaran ) AND  
         ( venlialb.linea   = :linea_albaran )   ;

COMMIT;

f_actualizar_venalbaran(codigo_empresa,periodo,albaran)
end subroutine

public subroutine f_botones ();IF tipo_precio = 2 Then
	IF tipo = "I" Then
		cb_grabar.enabled   = FALSE		
	ELSE
		cb_grabar.enabled   = TRUE
	END IF
  	cb_borrar.enabled   = FALSE
	cb_insertar.enabled = FALSE
	cb_reservas.enabled = FALSE
	cb_stock.enabled    = FALSE
	cb_valorar.enabled  = FALSE
	Return
END IF

IF tipo = "M" and var_situacion = "P" Then
	cb_stock.enabled    = FALSE
	cb_borrar.enabled   = FALSE
	Return
END IF

If tipo = "I" Then 
  cb_insertar.enabled = FALSE
  cb_borrar.enabled   = FALSE
End If

If tipo = "M" Then
  cb_insertar.enabled = TRUE
  cb_borrar.enabled   = TRUE
End If

IF tipo_precio = 2 then
	IF tipo = "I" Then
		cb_grabar.enabled = FALSE
	END IF
	cb_grabar.enabled   = TRUE
  	cb_borrar.enabled   = FALSE
	cb_insertar.enabled = FALSE
	cb_reservas.enabled = FALSE
	cb_stock.enabled    = FALSE
	cb_valorar.enabled  = FALSE
END IF
end subroutine

public subroutine f_calculo_precio ();/*  string codpais
  Integer t_pallets
  Dec{4}  t_cantidad
  em_precio.text = String(f_precio_articulo(codigo_empresa,em_cliente.text,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text,venalb.tarifa))
  t_pallets   = Integer(em_t_pallets.text)
  t_cantidad  = Dec(em_cantidad.text)
  IF IsNull(t_pallets) Then t_pallets=0
  IF t_pallets <1 and t_cantidad <>0 Then 
     codpais = f_pais_genter(codigo_empresa,"C",em_cliente.text)  
     em_precio.text= String(f_incremento_precio(codigo_empresa,cod_familia,uo_calidad.em_codigo.text,Dec(em_precio.text),codpais))
  End IF  
  precio_ant = Dec(em_precio.text)*/
  
string codpais,articulo,coleccion,tarifa,divisa
Dec incre,incre2,min_canti
Integer t_pallets
Dec{4}  t_cantidad,dto,v_precio_esp,v_precio_tarifa,v_pre,v_precio_esp_tar

//Nuevo
string ls_articulo,ls_calidad,ls_caja,ls_pallet,ls_tipo_linea
dec    ld_cantidad,ld_m2_caja
long   li_cantidad_en_pzs,ll_piezas_caja

IF IsNull(uo_articulo.em_codigo.text) or Trim(uo_articulo.em_codigo.text)= "" Then Return 
IF IsNull(uo_calidad.em_codigo.text) or Trim(uo_calidad.em_codigo.text)= "" Then Return 
  
dto = 0
em_descuento.text = "0"
em_descuento2.text= '0'
v_pre = 0

ls_articulo   = uo_articulo.em_codigo.text
ls_calidad    = uo_calidad.em_codigo.text
ls_caja       = uo_caja.em_codigo.text
ls_pallet     = uo_tipo_pallet.em_codigo.text
ls_tipo_linea = uo_tipolinea.em_codigo.text
ld_cantidad   = Dec(em_cantidad.text)
li_cantidad_en_pzs = integer(em_cantidad_en_pzs.text)

articulo  = uo_articulo.em_codigo.text
coleccion = f_coleccion_articulo(codigo_empresa,articulo)
divisa    = f_moneda_cliente(codigo_empresa,venalb.cliente)

if uo_tipolinea.em_codigo.text<>'5' then
	v_pre = f_precio_articulo_esp_tar(codigo_empresa,venalb.tarifa,venalb.cliente,articulo,uo_calidad.em_codigo.text)
	em_descuento.text =string(f_dto1_venclientes(codigo_empresa,em_cliente.text))
	em_descuento2.text=string(f_dto2_venclientes(codigo_empresa,em_cliente.text))
	if v_pre = 0 then
		if f_precio_neto_almcolecciones(codigo_empresa,coleccion)='S' then
			t_cantidad=dec(em_cantidad.text)
			min_canti=f_minimo_almcolecciones(codigo_empresa,coleccion)
			if t_cantidad>min_canti then
				tarifa=f_tarifa_almcolecciones(codigo_empresa,coleccion)
				v_pre=f_precio_articulo_venlintarifas_activa_m(codigo_empresa,tarifa,articulo,uo_calidad.em_codigo.text,divisa)
			else
				v_pre=f_precio_articulo_venlintarifas_activa_m(codigo_empresa,venalb.tarifa,articulo,uo_calidad.em_codigo.text,divisa)
				em_descuento.text=string(f_dto1_venclientes(codigo_empresa,em_cliente.text))
				em_descuento2.text=string(f_dto2_venclientes(codigo_empresa,em_cliente.text))			
			end if
		else
			v_pre=f_precio_articulo_venlintarifas_activa_m(codigo_empresa,venalb.tarifa,articulo,uo_calidad.em_codigo.text,divisa)
			em_descuento.text=string(f_dto1_venclientes(codigo_empresa,em_cliente.text))
			em_descuento2.text=string(f_dto2_venclientes(codigo_empresa,em_cliente.text))	
		end if
	end if
end if

em_precio.text=string(v_pre)
precio_ant = Dec(em_precio.text)

if f_unidad_articulo(codigo_empresa,ls_articulo) = "1" then
		
	ld_m2_caja     = f_metroscaja_articulo(codigo_empresa,ls_articulo,ls_caja)
	ll_piezas_caja = f_piezascaja_articulo(codigo_empresa,ls_articulo,ls_caja)
		
	if ll_piezas_caja <> 0 and ld_m2_caja <> 0 then	
		em_precio_pzs.text = string((v_pre * ld_m2_caja) / ll_piezas_caja,em_precio_pzs.mask)
	else
		em_precio_pzs.text = string(0,em_precio_pzs.mask)
	end if
else
	em_precio_pzs.text = string(v_pre,em_precio_pzs.mask)
end if
end subroutine

public subroutine f_consulta_disponible ();str_parametros str
str.s_argumentos[1]= "w_int_venliped"
str.s_argumentos[2]= uo_articulo.em_codigo.text
str.s_argumentos[3]= uo_calidad.em_codigo.text
str.s_argumentos[6]= uo_tipo_pallet.em_codigo.text
str.s_argumentos[7]= uo_caja.em_codigo.text
CHOOSE CASE campo_actual
	CASE "ARTICULO"
     str.s_argumentos[3]= ""
     str.s_argumentos[4]= ""
     str.s_argumentos[5]= ""
     str.s_argumentos[6]= ""
   CASE "CALIDAD"
     str.s_argumentos[4]= ""
     str.s_argumentos[5]= ""
     str.s_argumentos[6]= ""
END CHOOSE

str.i_nargumentos = 7
OpenWithParm(w_con_stock_articulos,str)

end subroutine

public subroutine f_activar_primer_campo ();em_precio.enabled = TRUE
uo_tipolinea.enabled = TRUE
uo_articulo.enabled = TRUE

IF tipo= "M" Then	 
	IF var_situacion	 = "P" or var_situacion	 = "C" Then
	   f_activar_campo(em_precio)
		Return
	END IF
END IF
IF tipo_precio = 2 Then
	f_activar_campo(em_precio)
	Return
END IF



   f_activar_campo(uo_tipolinea.em_campo)


end subroutine

public subroutine f_consulta_reservas ();str_parametros str
str.s_argumentos[1]= "w_int_venlialb"
str.s_argumentos[2]= uo_articulo.em_codigo.text
str.s_argumentos[3]= uo_calidad.em_codigo.text
str.s_argumentos[6]= uo_tipo_pallet.em_codigo.text
str.s_argumentos[7]= uo_caja.em_codigo.text
str.i_nargumentos = 7
OpenWithParm(w_con_reservas_articulos,str)

end subroutine

public subroutine f_campos_segun_tiplin ();Integer var_linea
Boolean sino,sino_articulo
String  var_empresa,var_codigo,ls_gestionar_en_piezas
String  cod_tiplin


cod_tiplin  = uo_tipolinea.em_codigo.text 
var_control_alm ="N"

SELECT  ventipolin.control_almacen ,
		  ventipolin.gestionar_en_piezas  
INTO   :var_control_alm,
		 :ls_gestionar_en_piezas
FROM   ventipolin  
WHERE (ventipolin.empresa = :codigo_empresa)
AND   (ventipolin.codigo  = :cod_tiplin);

if ls_gestionar_en_piezas = 'S' then
	ib_gestionar_en_piezas = true
else	
	ib_gestionar_en_piezas = false
end if

IF dw_detalle.GetRow() <> 0 Then
	var_linea= dw_detalle.getItemNumber(dw_detalle.GetRow(),"linea")
END IF

uo_tipolinea.enabled = TRUE

if ib_gestionar_en_piezas then
	em_cantidad.enabled         = false
	em_cantidad_en_pzs.enabled  = true
	em_precio.enabled           = false
	em_precio_pzs.enabled       = true
	
	em_cantidad.visible         = false
	em_cantidad_en_pzs.visible  = true
	em_precio.visible           = false
	em_precio_pzs.visible       = true	
	
	em_cantidad.TabOrder        = 0
	em_precio.TabOrder          = 0
	em_cantidad_en_pzs.TabOrder = 130
	em_precio_pzs.TabOrder      = 160
else
	em_cantidad.enabled         = true
	em_cantidad_en_pzs.enabled  = false
	em_precio.enabled           = true
	em_precio_pzs.enabled       = false	
	
	em_cantidad.visible         = true
	em_cantidad_en_pzs.visible  = false
	em_precio.visible           = true
	em_precio_pzs.visible       = false		
	
	em_cantidad.TabOrder        = 130
	em_precio.TabOrder          = 160
	em_cantidad_en_pzs.TabOrder = 0
	em_precio_pzs.TabOrder      = 0	
end if
	  
//IF (tipo= "M"  and  var_situacion	 = "P") or tipo_precio = 2 Then
if var_control_alm = 'S' then
	em_cajas.enabled               = FALSE
	em_calibre.enabled             = FALSE
	em_mtrs_lineales.enabled       = FALSE
	em_t_cajas.enabled             = FALSE
	em_t_pallets.enabled           = FALSE
	em_tono.enabled                = FALSE
	uo_calidad.enabled             = FALSE
	uo_tipo_pallet.enabled         = FALSE
	uo_caja.enabled                = FALSE
	uo_articulo.enabled            = FALSE
	uo_tipolinea.enabled           = FALSE
	em_cantidad.enabled            = FALSE
	em_cantidad_en_pzs.enabled     = FALSE
	Return
END IF

CHOOSE CASE var_control_alm
	CASE "S"
        sino = TRUE
        sino_articulo= TRUE
    CASE "N"
        em_descripcion.text    = f_nombre_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
        st_texto_cantidad.text = "Unidades"
        sino = FALSE
        sino_articulo = FALSE
	CASE ELSE
        Return
END CHOOSE

IF var_control_alm ="S" and var_sector = "N" Then
   sino_articulo = TRUE
   sino          = FALSE
END IF
    em_cajas.enabled               = sino
    em_calibre.enabled             = sino
    em_mtrs_lineales.enabled       = sino
    em_t_cajas.enabled             = sino
    em_t_pallets.enabled           = sino
    em_tono.enabled                = sino
    uo_calidad.enabled             = sino
    uo_tipo_pallet.enabled         = sino
	 uo_caja.enabled                = sino
    uo_articulo.enabled            = sino_articulo

    IF var_control_alm = "S" THEN
      IF trim(uo_articulo.em_codigo.text) <> "" THEN
        cb_reservas.enabled     = sino
        cb_stock.enabled        = sino
      ELSE
        cb_reservas.enabled     = FALSE
        cb_stock.enabled        = FALSE
      END IF
    ELSE
      cb_reservas.enabled     = sino
      cb_stock.enabled        = sino
    END IF

IF var_control_alm = "N"  THEN
  uo_articulo.em_codigo.text = ""
  uo_articulo.em_campo.text  = ""
END IF

IF (var_control_alm = "S" and var_sector ="N") or var_control_alm = "N" THEN 
   uo_calidad.em_codigo.text = ""  
   uo_calidad.em_campo.text = ""
   em_tono.text = ""
   em_calibre.text = ""
   uo_tipo_pallet.em_codigo.text = ""
   uo_tipo_pallet.em_campo.text = ""
	uo_caja.em_codigo.text = ""
	uo_caja.em_campo.text = ""
   em_mtrs_lineales.text = ""
   em_t_cajas.text = ""
   em_t_pallets.text = ""
   em_cajas.text = ""
END IF

//ORDEN DE CARGA
//if ftc_linea_en_orden_carga(Dec(em_anyo.text),Dec(em_pedido.text),var_linea) and tipo <> "I" then
//	st_oc.text = "LÍNEA EN ORDEN DE CARGA."
//	cb_grabar.enabled = false
//else
//	st_oc.text = ""
//	cb_grabar.enabled = true
//end if
    

end subroutine

public subroutine f_control ();dw_detalle.setredraw(false)
string donde,cuanto
donde=dw_detalle.Object.DataWindow.VerticalScrollPosition
dw_detalle.Retrieve(codigo_empresa,Integer(em_anyo.text),Dec(em_albaran.text),tipo_precio)
dw_detalle.Object.DataWindow.VerticalScrollPosition=donde
dw_detalle.setredraw(true)


end subroutine

public subroutine f_peso_linea ();string ls_gestionar_en_piezas_ventipolin
Dec{4} var_total,var_anyo,var_albaran,var_peso_linea

var_anyo    = Dec(em_anyo.text)
var_albaran = Dec(em_albaran.text)

IF len(uo_articulo.em_codigo.text) <> 0  and len(uo_tipo_pallet.em_codigo.text) <> 0 Then
	ls_gestionar_en_piezas_ventipolin = f_gestionar_en_piezas_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
	
	if ls_gestionar_en_piezas_ventipolin = 'S' then
		var_peso_linea= f_calculo_peso_pzs(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text, +&
								Dec(em_cajas.text),Dec(em_t_cajas.text),dec(em_npal.text),Dec(em_cantidad_en_pzs.text),Trim(uo_caja.em_codigo.text))			
	else	
		var_peso_linea= f_calculo_peso(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text,Dec(em_cajas.text),Dec(em_t_cajas.text),dec(em_t_pallets.text),Dec(em_cantidad.text),uo_caja.em_codigo.text)
	end if
Else	
	var_peso_linea=0
END IF

st_peso_linea.text   = String(var_peso_linea,"###,###,###")

Select sum(peso) Into :var_total From venlialb
Where  empresa  = :codigo_empresa
And    anyo     = :var_anyo
And    albaran = :var_albaran
And    linea    <>:linea_albaran;

IF IsNull(var_total)      Then var_total       =  0
IF IsNull(var_peso_linea) Then var_peso_linea  =  0

st_peso_total.text = String(var_total + var_peso_linea,"###,###,###")
end subroutine

public subroutine f_recalcular_lineas ();str_venlialb  linalb
str_venalb   ped 
Integer  reg,reg1 
Dec{0}  ultima,albaran,periodo,parcial_pallets
Dec{2}  parcial_cantidad,parcial_cajas
Dec{4}  impdto,importe,acumulado,importedto1,importedto2,importedto3,importedto4,importedtopp,importedtoesp,control_precio,control_bruto,control_importedto,control_importe
Dec{2}  var_dto1,var_dto2,var_dto3,var_dto4,var_dtopp,control_descuento
String  var_tipodto1,var_tipodto2,var_tipodto3,var_tipodto4,var_calculo_dto
Dec{4}  var_impdto1,var_impdto2,var_impdto3,var_impdto4
Integer procesos

periodo   =  Integer(em_anyo.text)
albaran    =  Dec(em_albaran.text)
reg1 = dw_detalle.RowCount()
linalb.empresa   = codigo_empresa
linalb.anyo      = periodo
linalb.albaran  = albaran
  SELECT venalb.dtoesp1,     venalb.dtoesp2,   
         venalb.dtoesp3,     venalb.dtoesp4,   
         venalb.dtopp,       venalb.tipodto1,   
         venalb.tipodto2,    venalb.tipodto3,   
         venalb.tipodto4,    venalb.divisa,
			venalb.calculo_dto
    INTO :var_dto1,    :var_dto2,    :var_dto3,  :var_dto4,   
         :var_dtopp,   :var_tipodto1,:var_tipodto2,   
         :var_tipodto3,:var_tipodto4,:linalb.divisa,
			:var_calculo_dto
    FROM venalb  
   WHERE (venalb.empresa  = :linalb.empresa ) AND  
         (venalb.anyo     = :linalb.anyo ) AND  
         (venalb.albaran = :linalb.albaran );


For reg = 1 To reg1 
 linalb.linea              = Dec(f_valor_columna(dw_detalle,reg,"linea"))
 linalb.cantidad           = Dec(f_valor_columna(dw_detalle,reg,"cantidad"))
 linalb.dtoesp             = Dec(f_valor_columna(dw_detalle,reg,"dtoesp"))
 linalb.tipolinea         = f_valor_columna(dw_detalle,reg,"tipolinea")
 linalb.control_comisiones = f_comision_ventipolin(linalb.empresa,linalb.tipolinea)
 linalb.control_descuentos = f_descuento_ventipolin(linalb.empresa,linalb.tipolinea)

 IF  IsNull(linalb.dtoesp) Then linalb.dtoesp= 0
 IF IsNull(var_dto1)  Then var_dto1  = 0
 IF IsNull(var_dto2)  Then var_dto2  = 0
 IF IsNull(var_dto3)  Then var_dto3  = 0
 IF IsNull(var_dto4)  Then var_dto4  = 0
 IF IsNull(var_dtopp) Then var_dtopp = 0

For procesos = 1 To 2
 linalb.precio_aduana      = Dec(f_valor_columna(dw_detalle,reg,"precio_aduana"))
 linalb.precio             = Dec(f_valor_columna(dw_detalle,reg,"precio"))
 IF procesos = 1 then control_precio = linalb.precio
 IF procesos = 2 then control_precio = linalb.precio_aduana
	
	control_bruto = Dec(String(linalb.cantidad * control_precio,f_mascara_moneda(linalb.divisa)))
	IF var_calculo_dto = "N" Then
		importedtoesp = Dec(String((control_bruto * linalb.dtoesp /100),f_mascara_moneda(linalb.divisa)))
		acumulado = control_bruto - importedtoesp
	ELSE
		acumulado = control_bruto
	END IF
	
	IF linalb.control_descuentos = "N" Then
		linalb.descuento = 0
	ELSE
	 IF var_tipodto1  = "L" Then 
			importedto1 = Dec(String((acumulado * var_dto1 /100),f_mascara_moneda(linalb.divisa)))
			acumulado = acumulado - importedto1
	 END IF
	 IF var_tipodto2  = "L" Then 
			importedto2 = Dec(String((acumulado * var_dto2 /100),f_mascara_moneda(linalb.divisa)))
			acumulado = acumulado - importedto2
	 END IF
	 IF var_tipodto3  = "L" Then 	
		   importedto3 = Dec(String((acumulado * var_dto3 /100),f_mascara_moneda(linalb.divisa)))
			acumulado = acumulado - importedto3
	 END IF
	 IF var_tipodto4  = "L" Then 	
			importedto4  = Dec(String((acumulado * var_dto4 /100),f_mascara_moneda(linalb.divisa)))
			acumulado = acumulado - importedto4
	 END IF
	 importedtopp  = Dec(String((acumulado * var_dtopp /100),f_mascara_moneda(linalb.divisa))) 
	END IF
	control_importedto    = control_bruto - acumulado 
	control_importe       = control_bruto - control_importedto
	If control_bruto = 0 then
		control_descuento  = 0
	ELse
		control_descuento  = (control_importedto/control_bruto)* 100
	END IF
	control_importedto    = control_bruto * control_descuento / 100
	control_importe       = control_bruto - control_importedto
	
	IF var_calculo_dto = "S" Then
		control_precio = control_precio - &
		Dec(String((control_precio * control_descuento)/100,f_mascara_moneda(linalb.divisa)))
		control_descuento = linalb.dtoesp
		control_bruto = Dec(String(linalb.cantidad * control_precio,f_mascara_moneda(linalb.divisa)))
	   importedtoesp = Dec(String((control_bruto * linalb.dtoesp /100),f_mascara_moneda(linalb.divisa)))
		control_importedto    = importedtoesp
	   control_importe       = control_bruto - importedtoesp
	END IF
	
	IF procesos = 1 Then
		linalb.descuento       = control_descuento
		linalb.bruto           = control_bruto
	   linalb.importedto      = control_importedto
	   linalb.importe         = control_importe
		linalb.precio_neto     = control_precio
		
	END IF
	IF procesos = 2 Then
		linalb.descuento_aduana       = control_descuento
	   linalb.importe_aduana         = control_importe
		linalb.precio_aduana_neto     = control_precio
	END IF
Next
  UPDATE venlialb  
     SET importe            = :linalb.importe,   
         descuento          = :linalb.descuento,   
         importedto         = :linalb.importedto,   
         precio_neto        = :linalb.precio_neto,   
         precio_aduana_neto = :linalb.precio_aduana_neto,   
         descuento_aduana   = :linalb.descuento_aduana,   
         importe_aduana     = :linalb.importe_aduana,   
         bruto = :linalb.bruto  
   WHERE ( venlialb.empresa = :linalb.empresa ) AND  
         ( venlialb.anyo = :linalb.anyo ) AND  
         ( venlialb.albaran = :linalb.albaran )  AND 
        ( venlialb.linea = :linalb.linea )   ;
COMMIT;
NEXT
f_actualizar_venalbaran(codigo_empresa,periodo,albaran)
end subroutine

event open;call super::open;string moneda_genter

istr_parametros = Message.PowerObjectParm
istr_parametros.s_titulo_ventana="Introducción lineas de albaranes"
This.title=istr_parametros.s_titulo_ventana
tipo_precio = 1
dw_detalle.SetTransObject(SQLCA)
dw_pie.SetTransObject(SQLCA)



IF istr_parametros.i_nargumentos>1 THEN
     em_anyo.text=istr_parametros.s_argumentos[2]	
     em_albaran.text=istr_parametros.s_argumentos[3]	
     IF Trim(em_anyo.text)<>"" and Trim(em_albaran.text)<>"" THEN
         f_control()
     END IF
     istr_parametros.i_nargumentos=0

     
venalb.anyo   = Dec(em_anyo.text)
venalb.albaran = Dec(em_albaran.text)


  SELECT venalb.empresa,venalb.anyo,
  			venalb.albaran,venalb.falbaran,   
         venalb.falta,venalb.cliente,
         venalb.observaciones,venalb.codpago,
			venalb.agente1,venalb.agente2,venalb.comision1,
			venalb.comision2,venalb.comision11,
			venalb.comision22,venalb.dtopp,venalb.dtoesp1,   
         venalb.dtoesp2,venalb.dtoesp3,   
         venalb.dtoesp4,venalb.tipodto1,   
         venalb.tipodto2,venalb.tipodto3,   
         venalb.tipodto4,venalb.explicaciondto1,   
         venalb.explicaciondto2,venalb.explicaciondto3,   
         venalb.explicaciondto4,venalb.tipoiva,   
         venalb.iva,venalb.numpedcli,venalb.idioma,   
         venalb.divisa,venalb.cambio,venalb.tarifa,   
         venalb.ftarifa,venalb.fbloqueo,
         venalb.serie,venalb.zona,
         venalb.forma_envio,venalb.cod_entrega,   
         venalb.usuario,venalb.tipo_portes,
			venalb.periodo_fac,venalb.peso  
         INTO :venalb.empresa,:venalb.anyo,:venalb.albaran,:venalb.falbaran,   
         :venalb.falta,:venalb.cliente,
         :venalb.observaciones,:venalb.codpago,:venalb.agente1,   
         :venalb.agente2,:venalb.comision1,:venalb.comision2,
         :venalb.comision11,:venalb.comision22,:venalb.dtopp,
         :venalb.dtoesp1,:venalb.dtoesp2,:venalb.dtoesp3,:venalb.dtoesp4,   
         :venalb.tipodto1,:venalb.tipodto2,:venalb.tipodto3,
         :venalb.tipodto4,:venalb.explicaciondto1,:venalb.explicaciondto2,   
         :venalb.explicaciondto3,:venalb.explicaciondto4,:venalb.tipoiva,   
         :venalb.iva,:venalb.numpedcli,:venalb.idioma,:venalb.divisa,   
         :venalb.cambio,:venalb.tarifa,:venalb.ftarifa,:venalb.fbloqueo,   
         :venalb.serie,:venalb.zona,:venalb.forma_envio,   
         :venalb.cod_entrega,:venalb.usuario,:venalb.tipo_portes,   
         :venalb.periodo_fac,:venalb.peso  
         FROM venalb  
         WHERE (venalb.empresa = :codigo_empresa)
         AND   (venalb.anyo    = :venalb.anyo)
         AND   (venalb.albaran  = :venalb.albaran)   
         ORDER BY venalb.empresa ASC,venalb.anyo ASC,venalb.albaran ASC  ;
			

     		em_cliente.text = venalb.cliente

     		st_nombre_cliente.text = f_nombre_cliente(codigo_empresa,"C",em_cliente.text)

     		tipo = "I"
			  
			int li_decimales_precio
			string  ls_mascara_moneda_tarifa
			
			li_decimales_precio       = f_ventarifas_decimales_precios(codigo_empresa,venalb.tarifa)
			ls_mascara_moneda_tarifa  = f_mascara_decimales(li_decimales_precio)
			
			em_precio.setmask(DecimalMask!,ls_mascara_moneda_tarifa)
			
			f_mascara_columna(dw_detalle,"precio",ls_mascara_moneda_tarifa)
			f_mascara_columna(dw_detalle,"calculo_precio",ls_mascara_moneda_tarifa)			  
			  
			moneda_genter = f_moneda_genter(codigo_empresa,"C",venalb.cliente)

			if moneda_genter = "7" then
				p_1.PictureName = "c:\bmp\ecu.bmp"
				st_moneda.text = "EUROS"
			else
				if moneda_genter = "1" then
					p_1.PictureName = "c:\bmp\nacional2.bmp"
					st_moneda.text = "PESETAS"
				else
					p_1.PictureName = "c:\bmp\globo.bmp"
					st_moneda.text = f_nombre_moneda(moneda_genter) 
				end if
			end if
END IF
cb_insertar.TriggerEvent(Clicked!)
f_peso_linea()
end event

event close;call super::close; longitud     =  len(trim(codigo_empresa))
 criterio[1]  =  trim(codigo_empresa)+ space(20-longitud)
 longitud     =  len(Trim(string(dec(em_anyo.text))))
 criterio[2]  =  trim(string(dec(em_anyo.text)))+space(20-longitud)
 longitud     =  len(Trim(string(dec(em_albaran.text))))
 criterio[3]  =  trim(string(dec(em_albaran.text)))+space(20-longitud)
 seleccion    =  criterio[1]+criterio[2]+criterio[3]
 tabla        = "venalb"
 f_desbloquear(tabla,seleccion,titulo)
 COMMIT;
 
 
end event

on ue_f7;call w_int_con_empresa::ue_f7;cb_valorar.TriggerEvent(Clicked!)
end on

on ue_f3;call w_int_con_empresa::ue_f3;cb_grabar.TriggerEvent(Clicked!)
end on

on ue_f6;call w_int_con_empresa::ue_f6;cb_reservas.TriggerEvent(Clicked!)
end on

on ue_f5;call w_int_con_empresa::ue_f5;cb_stock.TriggerEvent(Clicked!)
end on

on ue_f4;call w_int_con_empresa::ue_f4;cb_borrar.TriggerEvent(Clicked!)
end on

on ue_listar;//dw_report  = dw_listado
//dw_report.SetTransObject(SQLCA)
//Datetime fecha
//fecha = DateTime(Date(String(sle_fecha.Text)))
//dw_report.retrieve(codigo_empresa,em_tarifa.text,fecha)
//IF TRIM(filtro)<>"" THEN
// dw_report.SetFilter(filtro)
// dw_report.Filter()
//END IF
//CALL Super::ue_listar
end on

on w_int_venlialb.create
int iCurrent
call super::create
this.pb_1=create pb_1
this.st_3=create st_3
this.st_texto_cantidad=create st_texto_cantidad
this.st_pallets=create st_pallets
this.st_total_cajas=create st_total_cajas
this.st_cajas=create st_cajas
this.st_tipopallet=create st_tipopallet
this.st_calidad=create st_calidad
this.st_articulo=create st_articulo
this.em_t_pallets=create em_t_pallets
this.em_cajas=create em_cajas
this.em_t_cajas=create em_t_cajas
this.em_cantidad=create em_cantidad
this.uo_articulo=create uo_articulo
this.uo_tipo_pallet=create uo_tipo_pallet
this.st_texto_mtrslinieales=create st_texto_mtrslinieales
this.em_mtrs_lineales=create em_mtrs_lineales
this.em_cliente=create em_cliente
this.st_nombre_cliente=create st_nombre_cliente
this.st_texto_precio=create st_texto_precio
this.em_precio=create em_precio
this.em_descripcion=create em_descripcion
this.st_33=create st_33
this.uo_tipolinea=create uo_tipolinea
this.st_tplinea=create st_tplinea
this.st_dto=create st_dto
this.em_descuento=create em_descuento
this.dw_pie=create dw_pie
this.em_anyo=create em_anyo
this.gb_6=create gb_6
this.gb_3=create gb_3
this.em_situacion=create em_situacion
this.em_albaran=create em_albaran
this.st_4=create st_4
this.st_5=create st_5
this.st_peso_linea=create st_peso_linea
this.gb_1=create gb_1
this.st_2=create st_2
this.em_porcentaje=create em_porcentaje
this.st_proforma=create st_proforma
this.st_6=create st_6
this.st_peso_total=create st_peso_total
this.st_7=create st_7
this.st_tono=create st_tono
this.em_tono=create em_tono
this.st_calibre=create st_calibre
this.em_calibre=create em_calibre
this.gb_2=create gb_2
this.cb_stock=create cb_stock
this.cb_grabar=create cb_grabar
this.cb_borrar=create cb_borrar
this.cb_valorar=create cb_valorar
this.cb_reservas=create cb_reservas
this.cb_palmenos=create cb_palmenos
this.cb_cajmenos=create cb_cajmenos
this.cb_insertar=create cb_insertar
this.st_caja=create st_caja
this.uo_caja=create uo_caja
this.st_dto2=create st_dto2
this.em_descuento2=create em_descuento2
this.st_texto_npalet=create st_texto_npalet
this.em_npal=create em_npal
this.p_1=create p_1
this.st_moneda=create st_moneda
this.st_idioma=create st_idioma
this.uo_idioma=create uo_idioma
this.uo_calidad=create uo_calidad
this.dw_detalle=create dw_detalle
this.cb_palmas=create cb_palmas
this.cb_cajmas=create cb_cajmas
this.em_tono_imprimir=create em_tono_imprimir
this.em_calibre_imprimir=create em_calibre_imprimir
this.st_1=create st_1
this.st_8=create st_8
this.em_precio_pzs=create em_precio_pzs
this.gb_4=create gb_4
this.em_cantidad_en_pzs=create em_cantidad_en_pzs
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.pb_1
this.Control[iCurrent+2]=this.st_3
this.Control[iCurrent+3]=this.st_texto_cantidad
this.Control[iCurrent+4]=this.st_pallets
this.Control[iCurrent+5]=this.st_total_cajas
this.Control[iCurrent+6]=this.st_cajas
this.Control[iCurrent+7]=this.st_tipopallet
this.Control[iCurrent+8]=this.st_calidad
this.Control[iCurrent+9]=this.st_articulo
this.Control[iCurrent+10]=this.em_t_pallets
this.Control[iCurrent+11]=this.em_cajas
this.Control[iCurrent+12]=this.em_t_cajas
this.Control[iCurrent+13]=this.em_cantidad
this.Control[iCurrent+14]=this.uo_articulo
this.Control[iCurrent+15]=this.uo_tipo_pallet
this.Control[iCurrent+16]=this.st_texto_mtrslinieales
this.Control[iCurrent+17]=this.em_mtrs_lineales
this.Control[iCurrent+18]=this.em_cliente
this.Control[iCurrent+19]=this.st_nombre_cliente
this.Control[iCurrent+20]=this.st_texto_precio
this.Control[iCurrent+21]=this.em_precio
this.Control[iCurrent+22]=this.em_descripcion
this.Control[iCurrent+23]=this.st_33
this.Control[iCurrent+24]=this.uo_tipolinea
this.Control[iCurrent+25]=this.st_tplinea
this.Control[iCurrent+26]=this.st_dto
this.Control[iCurrent+27]=this.em_descuento
this.Control[iCurrent+28]=this.dw_pie
this.Control[iCurrent+29]=this.em_anyo
this.Control[iCurrent+30]=this.gb_6
this.Control[iCurrent+31]=this.gb_3
this.Control[iCurrent+32]=this.em_situacion
this.Control[iCurrent+33]=this.em_albaran
this.Control[iCurrent+34]=this.st_4
this.Control[iCurrent+35]=this.st_5
this.Control[iCurrent+36]=this.st_peso_linea
this.Control[iCurrent+37]=this.gb_1
this.Control[iCurrent+38]=this.st_2
this.Control[iCurrent+39]=this.em_porcentaje
this.Control[iCurrent+40]=this.st_proforma
this.Control[iCurrent+41]=this.st_6
this.Control[iCurrent+42]=this.st_peso_total
this.Control[iCurrent+43]=this.st_7
this.Control[iCurrent+44]=this.st_tono
this.Control[iCurrent+45]=this.em_tono
this.Control[iCurrent+46]=this.st_calibre
this.Control[iCurrent+47]=this.em_calibre
this.Control[iCurrent+48]=this.gb_2
this.Control[iCurrent+49]=this.cb_stock
this.Control[iCurrent+50]=this.cb_grabar
this.Control[iCurrent+51]=this.cb_borrar
this.Control[iCurrent+52]=this.cb_valorar
this.Control[iCurrent+53]=this.cb_reservas
this.Control[iCurrent+54]=this.cb_palmenos
this.Control[iCurrent+55]=this.cb_cajmenos
this.Control[iCurrent+56]=this.cb_insertar
this.Control[iCurrent+57]=this.st_caja
this.Control[iCurrent+58]=this.uo_caja
this.Control[iCurrent+59]=this.st_dto2
this.Control[iCurrent+60]=this.em_descuento2
this.Control[iCurrent+61]=this.st_texto_npalet
this.Control[iCurrent+62]=this.em_npal
this.Control[iCurrent+63]=this.p_1
this.Control[iCurrent+64]=this.st_moneda
this.Control[iCurrent+65]=this.st_idioma
this.Control[iCurrent+66]=this.uo_idioma
this.Control[iCurrent+67]=this.uo_calidad
this.Control[iCurrent+68]=this.dw_detalle
this.Control[iCurrent+69]=this.cb_palmas
this.Control[iCurrent+70]=this.cb_cajmas
this.Control[iCurrent+71]=this.em_tono_imprimir
this.Control[iCurrent+72]=this.em_calibre_imprimir
this.Control[iCurrent+73]=this.st_1
this.Control[iCurrent+74]=this.st_8
this.Control[iCurrent+75]=this.em_precio_pzs
this.Control[iCurrent+76]=this.gb_4
this.Control[iCurrent+77]=this.em_cantidad_en_pzs
end on

on w_int_venlialb.destroy
call super::destroy
if IsValid(MenuID) then destroy(MenuID)
destroy(this.pb_1)
destroy(this.st_3)
destroy(this.st_texto_cantidad)
destroy(this.st_pallets)
destroy(this.st_total_cajas)
destroy(this.st_cajas)
destroy(this.st_tipopallet)
destroy(this.st_calidad)
destroy(this.st_articulo)
destroy(this.em_t_pallets)
destroy(this.em_cajas)
destroy(this.em_t_cajas)
destroy(this.em_cantidad)
destroy(this.uo_articulo)
destroy(this.uo_tipo_pallet)
destroy(this.st_texto_mtrslinieales)
destroy(this.em_mtrs_lineales)
destroy(this.em_cliente)
destroy(this.st_nombre_cliente)
destroy(this.st_texto_precio)
destroy(this.em_precio)
destroy(this.em_descripcion)
destroy(this.st_33)
destroy(this.uo_tipolinea)
destroy(this.st_tplinea)
destroy(this.st_dto)
destroy(this.em_descuento)
destroy(this.dw_pie)
destroy(this.em_anyo)
destroy(this.gb_6)
destroy(this.gb_3)
destroy(this.em_situacion)
destroy(this.em_albaran)
destroy(this.st_4)
destroy(this.st_5)
destroy(this.st_peso_linea)
destroy(this.gb_1)
destroy(this.st_2)
destroy(this.em_porcentaje)
destroy(this.st_proforma)
destroy(this.st_6)
destroy(this.st_peso_total)
destroy(this.st_7)
destroy(this.st_tono)
destroy(this.em_tono)
destroy(this.st_calibre)
destroy(this.em_calibre)
destroy(this.gb_2)
destroy(this.cb_stock)
destroy(this.cb_grabar)
destroy(this.cb_borrar)
destroy(this.cb_valorar)
destroy(this.cb_reservas)
destroy(this.cb_palmenos)
destroy(this.cb_cajmenos)
destroy(this.cb_insertar)
destroy(this.st_caja)
destroy(this.uo_caja)
destroy(this.st_dto2)
destroy(this.em_descuento2)
destroy(this.st_texto_npalet)
destroy(this.em_npal)
destroy(this.p_1)
destroy(this.st_moneda)
destroy(this.st_idioma)
destroy(this.uo_idioma)
destroy(this.uo_calidad)
destroy(this.dw_detalle)
destroy(this.cb_palmas)
destroy(this.cb_cajmas)
destroy(this.em_tono_imprimir)
destroy(this.em_calibre_imprimir)
destroy(this.st_1)
destroy(this.st_8)
destroy(this.em_precio_pzs)
destroy(this.gb_4)
destroy(this.em_cantidad_en_pzs)
end on

on ue_f2;call w_int_con_empresa::ue_f2;cb_insertar.TriggerEvent(Clicked!)
end on

event ue_pagina_abajo;call super::ue_pagina_abajo;f_pagina_abajo(dw_detalle)
end event

event ue_pagina_arriba;call super::ue_pagina_arriba;f_pagina_arriba(dw_detalle)
end event

event ue_cursor_abajo;call super::ue_cursor_abajo;f_cursor_abajo(dw_detalle)
end event

event ue_cursor_arriba;call super::ue_cursor_arriba;f_cursor_arriba(dw_detalle)
end event

type ole_cont_pro from w_int_con_empresa`ole_cont_pro within w_int_venlialb
integer taborder = 10
end type

type sle_opcion_orden from w_int_con_empresa`sle_opcion_orden within w_int_venlialb
end type

type st_empresa from w_int_con_empresa`st_empresa within w_int_venlialb
integer x = 9
integer y = 4
integer width = 2629
integer height = 112
end type

type pb_1 from upb_salir within w_int_venlialb
integer x = 5024
integer y = 12
integer width = 110
integer height = 104
integer taborder = 0
end type

type st_3 from statictext within w_int_venlialb
integer x = 27
integer y = 140
integer width = 78
integer height = 80
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Nº:"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_texto_cantidad from statictext within w_int_venlialb
integer x = 4242
integer y = 2108
integer width = 274
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Cantidad"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_pallets from statictext within w_int_venlialb
integer x = 3570
integer y = 2108
integer width = 123
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Pal"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_total_cajas from statictext within w_int_venlialb
integer x = 3826
integer y = 2108
integer width = 192
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "T.Cj"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_cajas from statictext within w_int_venlialb
integer x = 3694
integer y = 2108
integer width = 133
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Cj"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_tipopallet from statictext within w_int_venlialb
integer x = 3314
integer y = 2108
integer width = 256
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Tp"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_calidad from statictext within w_int_venlialb
integer x = 2615
integer y = 2108
integer width = 142
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Cl"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_articulo from statictext within w_int_venlialb
integer x = 965
integer y = 2108
integer width = 1486
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Artículo"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type em_t_pallets from u_em_campo within w_int_venlialb
integer x = 3570
integer y = 2180
integer width = 123
integer height = 88
integer taborder = 120
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "##0"
string displaydata = ""
end type

event modificado;call super::modificado;string cadena
long   posi,posi_aux

cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                          uo_tipo_pallet.em_codigo.text,&
                          uo_caja.em_codigo.text,&								  
                          integer(em_t_pallets.text),&
                          0,0,uo_tipolinea.em_codigo.text)
                      
IF ante_pallets <> Integer(This.text) Then em_mtrs_lineales.text=""

posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if

em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)

IF precio_ant = Dec(em_precio.text) Then f_calculo_precio()
end event

event getfocus;call super::getfocus;ante_pallets = Integer(This.text)
campo_actual = "PALLETS"
f_peso_linea()
end event

type em_cajas from u_em_campo within w_int_venlialb
integer x = 3694
integer y = 2180
integer width = 133
integer height = 88
integer taborder = 130
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "###,###"
end type

event modificado;call super::modificado;string cadena
long   posi,posi_aux

cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                          uo_tipo_pallet.em_codigo.text,&
                          uo_caja.em_codigo.text,&								  
                           integer(em_t_pallets.text),&
                           integer(em_cajas.text),&
                           Dec(em_cantidad.text),uo_tipolinea.em_codigo.text)
                      
IF ante_cajas <> Integer(This.text) Then em_mtrs_lineales.text=""

posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if

em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)

IF precio_ant = Dec(em_precio.text) Then f_calculo_precio()
end event

event getfocus;call super::getfocus;ante_cajas = Integer(This.text)
campo_actual = "CAJAS"
f_peso_linea()
end event

type em_t_cajas from u_em_campo within w_int_venlialb
integer x = 3826
integer y = 2180
integer width = 192
integer height = 88
integer taborder = 0
fontcharset fontcharset = ansi!
string facename = "Arial"
boolean enabled = false
alignment alignment = right!
boolean displayonly = true
maskdatatype maskdatatype = numericmask!
string mask = "###,###"
end type

type em_cantidad from u_em_campo within w_int_venlialb
integer x = 4242
integer y = 2180
integer width = 274
integer height = 88
integer taborder = 150
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = decimalmask!
string mask = "###,###.00"
end type

event modificado;call super::modificado;IF var_control_alm ="S"  and var_sector = "S" THEN
	 If ante_valor<>Dec(em_cantidad.text) THEN
		 em_cajas.text=""
		 em_t_cajas.text=""
		 em_t_pallets.text=""
		 em_mtrs_lineales.text =""
	 END  IF
		
	 string cadena
	 long   posi,posi_aux
	 cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                            uo_tipo_pallet.em_codigo.text,&
                            uo_caja.em_codigo.text,&									 
                            integer(em_t_pallets.text),&
                            integer(em_cajas.text),&
                            Dec(em_cantidad.text),uo_tipolinea.em_codigo.text)
                       
 	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		em_t_pallets.text     = Mid(cadena,1,posi - 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
	end if
	
	em_cantidad_en_pzs.text = string(f_conversion_cantidad_piezas( codigo_empresa, uo_articulo.em_codigo.text, uo_caja.em_codigo.text, dec(em_cantidad.text)), em_cantidad_en_pzs.mask)

 	IF precio_ant = Dec(em_precio.text) Then f_calculo_precio()
END IF
f_peso_linea()
end event

event getfocus;call super::getfocus;IF var_control_alm = "N" Then st_texto_cantidad.text = "Unidades"
ante_valor= Dec(em_cantidad.text)
campo_actual = "CANTIDAD"
//f_peso_linea()
end event

type uo_articulo from u_em_campo_2 within w_int_venlialb
integer x = 960
integer y = 2180
integer width = 1490
integer height = 88
integer taborder = 30
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;String var_empresa,codigo_articulo,texto_unidad
String cod_tono,cod_calibre
Long   total_desc

uo_articulo.em_campo.text = f_nombre_articulo(codigo_empresa,uo_articulo.em_codigo.text)

em_cajas.text                 = ""
em_cantidad.text              = ""
em_cantidad_en_pzs.text       = ""
em_mtrs_lineales.text         = ""
em_t_cajas.text               = ""
em_t_pallets.text             = ""
uo_calidad.em_campo.text      = ""
em_precio.text                = ""
em_precio_pzs.text            = ""
uo_calidad.em_codigo.text     = ""
uo_tipo_pallet.em_campo.text  = ""
uo_tipo_pallet.em_codigo.text = ""
em_descuento.text             = ""
em_descuento2.text            = ""
  
IF f_control_almacen_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text) = "S" Then
  em_descripcion.text = uo_articulo.em_campo.text
END IF

IF Trim(uo_articulo.em_campo.text)="" THEN 
	IF Trim(uo_articulo.em_codigo.text)<>"" Then uo_articulo.em_campo.SetFocus()
	uo_articulo.em_campo.text=""
	uo_articulo.em_codigo.text=""
END IF

codigo_articulo=uo_articulo.em_codigo.text

SELECT articulos.empresa,articulos.codigo,articulos.familia ,articulos.formato,articulos.unidad
INTO :mov.empresa,:mov.articulo,:cod_familia,:cod_formato,:cod_tipo_unidad
FROM articulos  
WHERE (articulos.empresa = :codigo_empresa)
AND  	(articulos.codigo  = :codigo_articulo);
			
if uo_tipolinea.em_codigo.text = "4" then cod_tipo_unidad = "0" //MUY IMPORTANTE - Promoción siempre en piezas

select count(descripcion)
into :total_desc
from almcliartdesc
where empresa=:codigo_empresa and
		cliente=:venalb.cliente and
		articulo=:uo_articulo.em_codigo.text
group by empresa,cliente,articulo;
	
if isnull(total_desc) then total_desc = 0

if total_desc >= 1 then
	uo_idioma.em_codigo.text = "1"
	uo_idioma.em_campo.text = "1"
	if total_desc = 1 then
		uo_idioma.em_codigo.enabled = FALSE
	else
		uo_idioma.em_codigo.enabled = TRUE
	end if
end if
if total_desc = 0 then
	uo_idioma.em_codigo.text = "0"
	uo_idioma.em_campo.text = "0"
	uo_idioma.em_codigo.enabled = FALSE
end if			
 
if ib_gestionar_en_piezas then
	st_texto_cantidad.text = "Piezas"
else
	st_texto_cantidad.text = f_nombre_unidad(cod_tipo_unidad)
end if

em_cantidad.Setmask(DecimalMask!,f_mascara_unidad(cod_tipo_unidad))
f_campos_segun_tiplin()
f_peso_linea()
end event

on getfocus;call u_em_campo_2::getfocus;// para controlar valor anterior
  articulo_ant = uo_articulo.em_codigo.text


ue_titulo     = "Ayuda seleccion de articulos"
ue_datawindow = "dw_ayuda_articulos"
ue_filtro     = ""
f_botones()

campo_actual = "ARTICULO"
end on

on losefocus;call u_em_campo_2::losefocus;IF Trim(This.em_codigo.text) <> "" Then
  cb_reservas.enabled = TRUE
  cb_stock.enabled    = TRUE
ELSE
  cb_reservas.enabled = FALSE
  cb_stock.enabled    = FALSE
END IF
end on

on uo_articulo.destroy
call u_em_campo_2::destroy
end on

type uo_tipo_pallet from u_em_campo_2 within w_int_venlialb
integer x = 3314
integer y = 2180
integer width = 256
integer height = 88
integer taborder = 110
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;uo_tipo_pallet.em_campo.text=f_nombre_palarticulocaja_abr(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text,uo_caja.em_codigo.text)

IF Trim(uo_tipo_pallet.em_campo.text)=""  or IsNull(uo_tipo_pallet.em_campo.text)THEN 
 IF Trim(uo_tipo_pallet.em_codigo.text)<>"" Then 
   uo_tipo_pallet.em_campo.SetFocus()
 END IF
 uo_tipo_pallet.em_campo.text=""
 uo_tipo_pallet.em_codigo.text=""
END IF

f_peso_linea()	
end event

event getfocus;call super::getfocus;ue_titulo     = "Ayuda seleccion de pallets"
ue_datawindow = "dw_ayuda_palarticulo_abr"
ue_filtro     = "(palarticulo_articulo = '" + uo_articulo.em_codigo.text+ "') and "+&
                "(palarticulo_caja = '" + uo_caja.em_codigo.text + "')" 
campo_actual = "TIPO_PALLET"



end event

on uo_tipo_pallet.destroy
call u_em_campo_2::destroy
end on

type st_texto_mtrslinieales from statictext within w_int_venlialb
integer x = 4018
integer y = 2108
integer width = 224
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "M. Lin"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type em_mtrs_lineales from u_em_campo within w_int_venlialb
integer x = 4018
integer y = 2180
integer width = 224
integer height = 88
integer taborder = 140
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "###,###.0"
end type

event getfocus;call super::getfocus;campo_actual = "METROS_LINEALES"
f_peso_linea()

end event

event modificado;call super::modificado;If Dec(em_mtrs_lineales.text)=0 THEN Return
 em_cajas.text=""
 em_t_cajas.text=""
 em_t_pallets.text=""
 string cadena
 cadena=f_calculo_unidades_lineales(codigo_empresa,uo_articulo.em_codigo.text,&
                            uo_tipo_pallet.em_codigo.text,&
                            uo_caja.em_codigo.text,&									 
                            Dec(em_mtrs_lineales.text))
                       
 em_t_pallets.text  =Mid(cadena,1,6)
 em_cajas.text      =Mid(cadena,7,6)
 em_t_cajas.text    =Mid(cadena,13,6)
 em_cantidad.text   =Mid(cadena,19,9)
 em_mtrs_lineales.text   =Mid(cadena,28,9)
IF precio_ant = Dec(em_precio.text) Then f_calculo_precio()

end event

type em_cliente from u_em_campo within w_int_venlialb
integer x = 1074
integer y = 148
integer width = 174
integer height = 76
integer taborder = 0
long textcolor = 128
boolean enabled = false
boolean border = false
alignment alignment = center!
boolean displayonly = true
borderstyle borderstyle = stylebox!
maskdatatype maskdatatype = numericmask!
string mask = "######"
end type

type st_nombre_cliente from statictext within w_int_venlialb
integer x = 1239
integer y = 148
integer width = 1010
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
boolean focusrectangle = false
end type

type st_texto_precio from statictext within w_int_venlialb
integer x = 4521
integer y = 2108
integer width = 315
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Precio"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type em_precio from u_em_campo within w_int_venlialb
integer x = 4521
integer y = 2180
integer width = 315
integer height = 88
integer taborder = 160
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = decimalmask!
string mask = "#,###,###.00"
end type

event modificado;call super::modificado;if venalb.divisa="1" then
	This.text = String(Dec(This.text),"###,###,###,###.00")
else
	This.text = String(Dec(This.text),f_mascara_precios_fra_moneda(venalb.divisa))
end if

campo_actual = "PRECIO"

end event

type em_descripcion from u_em_campo within w_int_venlialb
integer x = 14
integer y = 2356
integer width = 2043
integer taborder = 210
fontcharset fontcharset = ansi!
string facename = "Arial"
string mask = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
end type

on getfocus;call u_em_campo::getfocus;campo_actual = "DESCRIPCION"
end on

type st_33 from statictext within w_int_venlialb
integer x = 14
integer y = 2280
integer width = 2048
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Descripción artículo"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type uo_tipolinea from u_em_campo_2 within w_int_venlialb
integer x = 9
integer y = 2180
integer width = 946
integer height = 88
integer taborder = 20
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;f_campos_segun_tiplin()
uo_tipolinea.em_campo.text=f_nombre_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
IF Trim(uo_tipolinea.em_campo.text)=""  or IsNull(uo_tipolinea.em_campo.text)THEN 
 IF Trim(uo_tipolinea.em_codigo.text)<>"" Then 
   f_activar_campo(uo_tipolinea.em_campo)
 END IF
 uo_tipolinea.em_campo.text   = ""
 uo_tipolinea.em_codigo.text  = ""
END IF
IF tipo = "I" Then
IF var_control_alm = "S" Then
	 f_mensaje("No se puede grabar la linea"," Solo linea sin control de almacen")
	 uo_tipolinea.em_campo.text   = ""
 	 uo_tipolinea.em_codigo.text  = ""
	Return
END IF
END IF

end event

on getfocus;call u_em_campo_2::getfocus;ue_titulo     = "Ayuda seleccion tipos de linea (facturación)"
ue_datawindow = "dw_ayuda_ventipolin"
ue_filtro     = ""
tipolinea_ant = this.em_codigo.text

campo_actual = "TIPO_LINEA"
end on

on uo_tipolinea.destroy
call u_em_campo_2::destroy
end on

type st_tplinea from statictext within w_int_venlialb
integer x = 9
integer y = 2108
integer width = 946
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Tp. linea"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_dto from statictext within w_int_venlialb
integer x = 2066
integer y = 2280
integer width = 174
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Dto"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type em_descuento from u_em_campo within w_int_venlialb
integer x = 2062
integer y = 2356
integer width = 183
integer taborder = 220
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = "xxxxxxxxxx"
string displaydata = "Ä"
end type

on getfocus;call u_em_campo::getfocus;campo_actual = "DESCUENTO"
end on

type dw_pie from datawindow within w_int_venlialb
boolean visible = false
integer x = 517
integer y = 384
integer width = 2185
integer height = 764
integer taborder = 240
boolean titlebar = true
string title = "Pie de Albaran"
string dataobject = "dw_int_venlialb3"
boolean controlmenu = true
boolean livescroll = true
end type

on clicked;This.visible = FALSE
f_activar_primer_campo()
end on

type em_anyo from u_em_campo within w_int_venlialb
integer x = 105
integer y = 144
integer width = 165
integer height = 68
integer taborder = 0
long textcolor = 128
boolean enabled = false
boolean border = false
alignment alignment = right!
boolean displayonly = true
borderstyle borderstyle = stylebox!
maskdatatype maskdatatype = numericmask!
string mask = "####"
end type

type gb_6 from groupbox within w_int_venlialb
integer x = 4686
integer y = 2292
integer width = 370
integer height = 308
integer textsize = -7
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 79741120
string text = "Divisa Cliente"
end type

type gb_3 from groupbox within w_int_venlialb
integer x = 1061
integer y = 96
integer width = 1207
integer height = 136
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
borderstyle borderstyle = styleraised!
end type

type em_situacion from u_em_campo within w_int_venlialb
boolean visible = false
integer x = 23
integer y = 2144
integer width = 123
integer taborder = 180
boolean border = false
borderstyle borderstyle = stylebox!
end type

type em_albaran from u_em_campo within w_int_venlialb
integer x = 325
integer y = 144
integer width = 165
integer height = 68
integer taborder = 0
long textcolor = 128
boolean enabled = false
boolean border = false
boolean displayonly = true
borderstyle borderstyle = stylebox!
maskdatatype maskdatatype = numericmask!
string mask = "######"
end type

type st_4 from statictext within w_int_venlialb
integer x = 2286
integer y = 128
integer width = 297
integer height = 52
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Peso total"
alignment alignment = center!
boolean focusrectangle = false
end type

type st_5 from statictext within w_int_venlialb
integer x = 2281
integer y = 176
integer width = 311
integer height = 52
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Peso Linea"
alignment alignment = center!
boolean focusrectangle = false
end type

type st_peso_linea from statictext within w_int_venlialb
integer x = 2606
integer y = 176
integer width = 233
integer height = 52
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
alignment alignment = right!
boolean focusrectangle = false
end type

type gb_1 from groupbox within w_int_venlialb
integer x = 14
integer y = 96
integer width = 489
integer height = 136
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
borderstyle borderstyle = styleraised!
end type

type st_2 from statictext within w_int_venlialb
integer x = 265
integer y = 144
integer width = 46
integer height = 72
boolean bringtotop = true
integer textsize = -11
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "Algerian"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
string text = "/"
alignment alignment = right!
boolean focusrectangle = false
end type

type em_porcentaje from u_em_campo within w_int_venlialb
integer x = 878
integer y = 136
integer width = 151
integer taborder = 0
integer weight = 400
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "###"
string displaydata = ""
end type

event tecla_enter;call super::tecla_enter;Dec{4} var_porcentaje
Dec{0} var_anyo,var_albaran
String uni1,uni2
var_porcentaje = Dec(em_porcentaje.text)
var_anyo     = Dec(em_anyo.text)
var_albaran = Dec(em_albaran.text)
uni1 = ""
uni2 = ""


IF messageBox("Proceso volcado de precios (Unidades)","Desea Volcar precios al "+ em_porcentaje.text +" %",Question!,YesNo!,2) = 1 Then
	uni1 = "0"
END IF	

IF messageBox("Proceso volcado de precios (Metros)","Desea Volcar precios al "+ em_porcentaje.text +" %",Question!,YesNo!,2) = 1 Then
	uni2 = "1"
END IF	
If st_proforma.text = "Albaran" Then
		IF uni1 <> "" or uni2<> "" Then
			UPDATE venlialb	
			Set    venlialb.precio = venlialb.precio * :var_porcentaje/100
			Where  venlialb.empresa  = :codigo_empresa
			And  	 venlialb.anyo     = :var_anyo
			And    venlialb.albaran = :var_albaran
			And    venlialb.tipo_unidad In(:uni1,:uni2);
			COMMIT;
			f_control()
			f_recalcular_lineas()
			COMMIT;
			f_control()
		END IF
ELSE
			IF uni1 <> "" or uni2<> "" Then
				UPDATE venlialb	
				Set    venlialb.precio_aduana = venlialb.precio * :var_porcentaje/100
				Where  venlialb.empresa  = :codigo_empresa
				And  	 venlialb.anyo     = :var_anyo
				And    venlialb.albaran = :var_albaran
				And    venlialb.tipo_unidad In(:uni1,:uni2);
				UPDATE venlialb	
				Set    venlialb.precio_aduana = 0
				Where  venlialb.empresa  = :codigo_empresa
				And  	 venlialb.anyo     = :var_anyo
				And    venlialb.albaran = :var_albaran
				And    venlialb.tipo_unidad Not In(:uni1,:uni2);
				UPDATE venalb	
				Set    venalb.porcentaje_aduana = :var_porcentaje
				Where  venalb.empresa  = :codigo_empresa
				And  	 venalb.anyo     = :var_anyo
				And    venalb.albaran = :var_albaran;
				COMMIT;
				f_control()
				f_recalcular_lineas()
				COMMIT;
				f_control()
			END IF
END IF
end event

type st_proforma from dropdownlistbox within w_int_venlialb
integer x = 535
integer y = 136
integer width = 343
integer height = 276
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "Albaran"
boolean vscrollbar = true
string item[] = {"Albaran","Aduana"}
end type

event selectionchanged;Dec{4}  var_porcentaje
Dec{0}  var_anyo,var_albaran

var_anyo= Dec(em_anyo.text)
var_albaran= Dec(em_albaran.text)

IF This.Text = "Aduana" Then
  tipo_precio = 2
  em_porcentaje.visible = TRUE
	Select venalb.porcentaje_aduana Into	:var_porcentaje
	From   venalb
	Where  venalb.empresa  = :codigo_empresa
   And  	 venalb.anyo     = :var_anyo
	And    venalb.albaran = :var_albaran;
	em_porcentaje.text = String(var_porcentaje)
ELSE
	 tipo_precio = 1
    em_porcentaje.Text= "0"
END IF
f_control()
tipo = "I"
cb_insertar.TriggerEvent(Clicked!)
f_peso_linea()
f_botones()
f_activar_primer_campo()
f_campos_segun_tiplin()
end event

type st_6 from statictext within w_int_venlialb
integer x = 2277
integer y = 120
integer width = 320
integer height = 116
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
alignment alignment = right!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_peso_total from statictext within w_int_venlialb
integer x = 2606
integer y = 124
integer width = 233
integer height = 52
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
alignment alignment = right!
boolean focusrectangle = false
end type

type st_7 from statictext within w_int_venlialb
integer x = 2597
integer y = 120
integer width = 256
integer height = 116
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
alignment alignment = right!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_tono from statictext within w_int_venlialb
integer x = 2958
integer y = 2108
integer width = 82
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "C"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type em_tono from u_em_campo within w_int_venlialb
event getfocus pbm_ensetfocus
event modificado pbm_custom02
integer x = 2766
integer y = 2180
integer width = 192
integer height = 88
integer taborder = 60
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = "!!!!!!!!!!!!!!!!!!!!"
end type

event getfocus;call super::getfocus;campo_actual = "TONO"

end event

event modificado;call super::modificado;string cadena
long   posi,posi_aux

IF ante_pallets <> Integer(This.text) Then em_mtrs_lineales.text=""

cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                          uo_tipo_pallet.em_codigo.text,&
                          uo_caja.em_codigo.text,&								  
                          integer(em_t_pallets.text),&
                          integer(em_cajas.text),Dec(em_cantidad.text),uo_tipolinea.em_codigo.text)
                      
posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if
	

IF precio_ant = Dec(em_precio.text) Then f_calculo_precio()
end event

type st_calibre from statictext within w_int_venlialb
integer x = 2761
integer y = 2108
integer width = 192
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Tono"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type em_calibre from u_em_campo within w_int_venlialb
event getfocus pbm_ensetfocus
event modificado pbm_custom02
integer x = 2958
integer y = 2180
integer width = 82
integer height = 88
integer taborder = 70
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "###,###"
end type

event getfocus;call super::getfocus;campo_actual = "TONO"

end event

event modificado;call super::modificado;string cadena
long   posi,posi_aux

cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                          uo_tipo_pallet.em_codigo.text,&
                          uo_caja.em_codigo.text,&								  
                          integer(em_t_pallets.text),&
                          integer(em_cajas.text),Dec(em_cantidad.text),uo_tipolinea.em_codigo.text)
                      
IF ante_pallets <> Integer(This.text) Then em_mtrs_lineales.text=""

posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if


IF precio_ant = Dec(em_precio.text) Then f_calculo_precio()
end event

type gb_2 from groupbox within w_int_venlialb
integer x = 521
integer y = 96
integer width = 526
integer height = 136
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
borderstyle borderstyle = styleraised!
end type

type cb_stock from u_boton within w_int_venlialb
integer x = 3525
integer y = 2376
integer width = 361
integer height = 80
integer taborder = 0
string text = "F5 Ver stock"
end type

event clicked;IF This.enabled = FALSE Then RETURN
str_parametros valores
       IF var_control_alm = "N" Then Return
       f_consulta_disponible()
       IF Message.DoubleParm=-1  THEN 
       ELSE
          If em_tono.text= "0" Then em_tono.text="" 
          If em_calibre.text= "0" Then em_calibre.text="" 
          valores = Message.PowerObjectParm
          uo_articulo.em_campo.text= f_nombre_articulo(codigo_empresa,valores.s_argumentos[1])
          uo_articulo.em_codigo.text= valores.s_argumentos[1]
          uo_calidad.em_campo.text  = f_nombre_calidad_abr(codigo_empresa,valores.s_argumentos[2])
	   	 uo_calidad.em_codigo.text     = valores.s_argumentos[2]
		    em_tono.text                  = valores.s_argumentos[3]
		    em_calibre.text               = valores.s_argumentos[4]
          uo_tipo_pallet.em_campo.text  = f_nombre_pallet_abr(codigo_empresa,valores.s_argumentos[5])
		    uo_tipo_pallet.em_codigo.text = valores.s_argumentos[5]
          uo_caja.em_campo.text  = f_nombre_caja_abr(codigo_empresa,valores.s_argumentos[5])
		    uo_caja.em_codigo.text = valores.s_argumentos[6]
			 uo_calidad.ue_valor_anterior = uo_calidad.em_campo.text
			 f_activar_campo(uo_calidad.em_campo)
        END IF
end event

type cb_grabar from u_boton within w_int_venlialb
integer x = 3168
integer y = 2376
integer width = 361
integer height = 80
integer taborder = 0
string text = "F3 Grabar  "
end type

event clicked;Dec{0}    var_anyo,var_albaran,re
Dec{4}    var_precio
String    mascara,es_pico

re = dw_detalle.GetRow()
mascara  = f_mascara_moneda(venalb.divisa)
var_anyo       = Dec(em_anyo.text)
var_albaran     = Dec(em_albaran.text)
var_precio     = Dec(em_precio.text)
IF tipo= "M" and  var_situacion	 = "P" Then
	em_situacion.text = "P"
ELSE
IF tipo_precio = 2 Then
	f_grabar_linea()
	f_control()
	return
END IF

String motivo,controles,referencia,condicion,tipo_unidad,texto,acumular,condicion2
Integer  opcion,var_linea_acumulado
dec{2}   disponible,var_conjunto,diferencia,piezas_caja,dife,var_precio1,var_precio2
EditMask campo
tipo_unidad = f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text)
if uo_tipolinea.em_codigo.text = "4" then tipo_unidad = "0" //MUY IMPORTANTE - Promoción siempre en piezas
IF This.visible = FALSE Then RETURN
controles="N"
acumular  = "N" 
END IF
IF Trim(uo_tipolinea.em_codigo.text) = "" or Trim(uo_tipolinea.em_campo.text)= ""  Then
  campo   = uo_tipolinea.em_campo
  motivo  = "(Campo Obligatorio) Introduzca el tipo de linea"
  controles = "S"
END IF
IF var_control_alm ="S"  and var_sector = "S" THEN
  uo_tipo_pallet.TriggerEvent("modificado")
  IF TRIM(uo_tipo_pallet.em_campo.text)="" or IsNull(uo_tipo_pallet.em_campo.text) Then
   campo=uo_tipo_pallet.em_campo
   motivo= "(Campo Obligatorio) Introduzca el tipo de pallet"
   controles="S"
  END IF
  uo_caja.TriggerEvent("modificado")
  IF TRIM(uo_caja.em_campo.text)="" or IsNull(uo_caja.em_campo.text) Then
   campo=uo_tipo_pallet.em_campo
   motivo= "(Campo Obligatorio) Introduzca el tipo de caja"
   controles="S"
  END IF

END IF

IF (Dec(em_cantidad.text) = 0  or IsNull(em_cantidad.text)) and (Dec(em_cantidad_en_pzs.text) = 0  or IsNull(em_cantidad.text)) Then
   motivo= "(Campo Obligatorio) Introduzca la cantidad"
   controles="S"
	
	if ib_gestionar_en_piezas then
		campo = em_cantidad_en_pzs	
	else
		campo = em_cantidad
	end if	
END IF

IF var_control_alm ="S" and var_sector ="S" THEN
  IF Trim(uo_calidad.em_codigo.text) = ""  or IsNull(uo_articulo.em_codigo.text) Then
   campo=uo_calidad.em_campo
   motivo= "(Campo Obligatorio) Introduzca la calidad"
   controles="S"
  END IF
END IF

IF var_control_alm = "S" THEN
  IF Trim(uo_articulo.em_codigo.text) = ""  or IsNull(uo_articulo.em_codigo.text) Then
   campo=uo_articulo.em_campo
   motivo= "(Campo Obligatorio) Introduzca el artículo"
   controles="S"
  END IF
  
END IF

IF controles="S" THEN
 MessageBox("No se puede grabar la linea",motivo,Exclamation!, OK!,1)
 f_activar_campo(campo)
 Return
END IF



// Control clase de venta
var_clase ="V"

  // V-> Venta (típica)
  // M-> Muestras sin precio
  // S-> Ventas sin cargo
  // P-> Precio pendiente

  IF (Dec(em_precio.text) = 0  or IsNull(em_precio.text)) and Dec(em_precio_pzs.text) = 0  or IsNull(em_precio_pzs.text) Then
   campo=em_precio
   motivo= "(Campo Obligatorio) Introduzca el precio"
   controles="S"
   tipo_array arg
   arg.valor[1]  = "Linea de albaran Sin precio"
   arg.valor[11] = "Muestras"
   arg.valor[12] = "Sin Cargo"
   arg.valor[13] = "Precio Pdte." 
   arg.valor[14] = "Cancelar" 
   opcion = f_opciones(arg)
   CHOOSE CASE opcion
 	 CASE 1
		var_clase ="M"
    CASE 2
		var_clase ="S"
	 CASE 3
		var_clase ="P"
	 CASE 4
		 f_activar_campo(em_precio)
		 Return
   END CHOOSE
END IF

acumular ="N"
IF var_control_alm = "N" Then
  SetNull(uo_articulo.text)
  SetNull(uo_calidad.text)
  SetNull(uo_tipo_pallet.text)
  SetNull(uo_caja.text)
  SetNull(referencia)
  // Siempre se graban el situacion= "C" 
  em_situacion.text="C"
END IF
f_grabar_linea()
f_control()
IF tipo = "I" Then dw_detalle.ScrollToRow(dw_detalle.RowCount())
f_botones()
cb_insertar.TriggerEvent(clicked!)
articulo_ant=""
dw_detalle.ScrollToRow(re)
dw_detalle.SeTRow(re)

end event

type cb_borrar from u_boton within w_int_venlialb
integer x = 3525
integer y = 2292
integer width = 361
integer height = 80
integer taborder = 0
string text = "F4 Borrar     "
end type

event clicked;call super::clicked;IF This.enabled = FALSE Then RETURN

IF var_control_alm = "S" Then
	 f_mensaje("No se puede borrar la linea"," Solo lineas sin control de almacen")
 	Return
END IF

If MessageBox("Comfirmacion Baja linea de albaran","Desa borra la linea de pedido seleccionada",Question!, YesNo!,2)= 2 Then
  f_activar_primer_campo()
  Return
END IF

f_borrar_linea()
f_control()
cb_insertar.TriggerEvent(clicked!)

end event

type cb_valorar from u_boton within w_int_venlialb
integer x = 3881
integer y = 2376
integer width = 361
integer height = 80
integer taborder = 0
string text = "F7 Valorar   "
end type

event clicked;call super::clicked;dw_pie.visible = TRUE
dw_pie.InsertRow(1)
dw_pie.SetItem(1,"pie",f_pie_albaran(venalb.empresa,venalb.anyo,venalb.albaran))
f_activar_primer_campo()


end event

type cb_reservas from u_boton within w_int_venlialb
integer x = 3881
integer y = 2292
integer width = 361
integer height = 80
integer taborder = 0
string text = "F6 Reservas"
end type

on clicked;call u_boton::clicked;IF This.enabled = FALSE Then RETURN
str_parametros valores
       IF var_control_alm = "N" Then Return
       f_consulta_reservas()
       IF Message.DoubleParm=-1  THEN 
       ELSE
        END IF
       f_activar_campo(uo_articulo.em_campo)

end on

type cb_palmenos from u_boton within w_int_venlialb
event clicked pbm_bnclicked
integer x = 4539
integer y = 2292
integer width = 91
integer height = 80
integer taborder = 0
string text = "(-)"
end type

event clicked;call super::clicked;Dec  pall,vanyo,valbaran,vlinea
long ll_pallets_albaran
IF dw_detalle.GetRow() <> 0 Then
//IF f_control_almacen_ventipolin(codigo_empresa,dw_detalle.GetItemString(dw_detalle.GetRow(),"tipolinea")) = "N" Then Return
	pall     = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"pallets")
	vanyo    = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"anyo")
	valbaran = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"albaran")
	vlinea   = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"linea")
	IF IsNull(pall) Then pall = 0
	pall = pall -1
	
	Update venlialb
	Set    venlialb.pallets = :pall
	Where  venlialb.empresa = :codigo_empresa
	And    venlialb.anyo    = :vanyo
	And    venlialb.albaran = :valbaran
	And    venlialb.linea   = :vlinea;
	
	if sqlca.sqlcode = 0 then
		select sum(isnull(venlialb.pallets,0))
		into   :ll_pallets_albaran
		from   venlialb
		Where  venlialb.empresa = :codigo_empresa
		And    venlialb.anyo    = :vanyo
		And    venlialb.albaran = :valbaran;
	
		Update venalb
		Set    venalb.bultos = :ll_pallets_albaran
		Where  venalb.empresa = :codigo_empresa
		And    venalb.anyo    = :vanyo
		And    venalb.albaran = :valbaran;		
		
		if sqlca.sqlcode = 0 then
			Commit;
			dw_detalle.SetItem(dw_detalle.GetRow(),"pallets",pall)
			em_t_pallets.text = string(pall,em_t_pallets.mask)
		else
			rollback;
		end if
		
	else
		rollback;
	end if
END IF
end event

type cb_cajmenos from u_boton within w_int_venlialb
event clicked pbm_bnclicked
integer x = 4539
integer y = 2376
integer width = 91
integer height = 80
integer taborder = 0
string text = "(-)"
end type

event clicked;call super::clicked;Dec cj,tcj,vanyo,valbaran,vlinea
IF dw_detalle.GetRow() <> 0 Then
//IF f_control_almacen_ventipolin(codigo_empresa,dw_detalle.GetItemString(dw_detalle.GetRow(),"tipolinea")) = "N" Then Return
	cj     = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"cajas")
	tcj     = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"total_cajas")
	vanyo    = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"anyo")
	valbaran = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"albaran")
	vlinea   = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"linea")
	IF IsNull(cj) Then cj = 0
	if cj=0 then return
	cj = cj - 1
	IF IsNull(tcj) Then tcj = 0
	tcj = tcj - 1

	Update venlialb
	Set cajas = :cj,
	    total_cajas = :tcj
	Where empresa = :codigo_empresa
	And   anyo    = :vanyo
	And   albaran = :valbaran
	And   linea   = :vlinea;
	Commit;

	dw_detalle.SetItem(dw_detalle.GetRow(),"cajas",cj)
	dw_detalle.SetItem(dw_detalle.GetRow(),"total_cajas",tcj)	
	
	em_cajas.text = string(cj,em_cajas.mask)		
	em_t_cajas.text = string(tcj,em_t_cajas.mask)		
END IF
end event

type cb_insertar from u_boton within w_int_venlialb
integer x = 3168
integer y = 2292
integer width = 361
integer height = 80
integer taborder = 0
string text = "F2 Insertar"
end type

event clicked;control_incremento = "P"
tipo="I"
linea_albaran = 0
em_cajas.text=""
em_tono.text=""
em_calibre.text=""
em_cantidad.text=""
em_descripcion.text=""
em_mtrs_lineales.text=""
em_precio.text=""
em_descuento.text=""
em_descuento2.text=''
em_situacion.text=""
em_t_cajas.text=""
em_t_pallets.text=""
uo_articulo.em_campo.text=""
uo_calidad.em_campo.text=""
uo_idioma.em_campo.text = "0"
uo_idioma.em_codigo.text = "0"
uo_tipo_pallet.em_campo.text=""
uo_articulo.em_codigo.text=""
articulo_ant=""
uo_calidad.em_codigo.text=""
uo_tipo_pallet.em_codigo.text=""
uo_caja.em_codigo.text = ""
uo_tipolinea.em_codigo.text=""
uo_tipolinea.em_campo.text = f_nombre_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
uo_tipolinea.TriggerEvent("modificado")
em_situacion.text="S"
em_npal.text = "0"
em_tono_imprimir.text=""
em_calibre_imprimir.text=""
f_botones()
dw_detalle.SelectRow(0,FALSE)
f_activar_primer_campo()
//f_peso_linea()
end event

type st_caja from statictext within w_int_venlialb
integer x = 3040
integer y = 2108
integer width = 274
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Tc"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type uo_caja from u_em_campo_2 within w_int_venlialb
event destroy ( )
integer x = 3040
integer y = 2180
integer width = 274
integer height = 88
integer taborder = 90
boolean border = true
borderstyle borderstyle = stylelowered!
end type

on uo_caja.destroy
call u_em_campo_2::destroy
end on

event modificado;uo_caja.em_campo.text=f_nombre_almartcaja_abr(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text)

IF Trim(uo_caja.em_campo.text)=""  or IsNull(uo_caja.em_campo.text)THEN 
 IF Trim(uo_caja.em_codigo.text)<>"" Then 
   uo_caja.em_campo.SetFocus()
 END IF
 uo_caja.em_campo.text=""
 uo_caja.em_codigo.text=""
END IF


end event

event getfocus;call super::getfocus;ue_titulo     = "Ayuda seleccion de cajas"
ue_datawindow = "dw_ayuda_almartcajas"
ue_filtro     = "almartcajas_articulo = '" + uo_articulo.em_codigo.text+ "'"
campo_actual = "CAJA"



end event

type st_dto2 from statictext within w_int_venlialb
integer x = 2245
integer y = 2280
integer width = 174
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Dto"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type em_descuento2 from u_em_campo within w_int_venlialb
integer x = 2240
integer y = 2356
integer width = 183
integer taborder = 230
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = "xxxxxxxxxx"
string displaydata = "Ä"
end type

on getfocus;call u_em_campo::getfocus;campo_actual = "DESCUENTO"
end on

type st_texto_npalet from statictext within w_int_venlialb
integer x = 4841
integer y = 2108
integer width = 210
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "NºPal."
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type em_npal from u_em_campo within w_int_venlialb
integer x = 4837
integer y = 2180
integer width = 210
integer height = 88
integer taborder = 200
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = "!!!!!"
end type

event modificado;call super::modificado;if venalb.divisa="1" then
	This.text = String(Dec(This.text),"###,###,###,###.00")
else
	This.text = String(Dec(This.text),f_mascara_precios_fra_moneda(venalb.divisa))
end if

campo_actual = "PRECIO"

end event

type p_1 from picture within w_int_venlialb
integer x = 4791
integer y = 2340
integer width = 165
integer height = 144
boolean bringtotop = true
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_moneda from statictext within w_int_venlialb
integer x = 4709
integer y = 2496
integer width = 325
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 79741120
boolean enabled = false
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_idioma from statictext within w_int_venlialb
integer x = 2459
integer y = 2108
integer width = 151
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Idi"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type uo_idioma from u_em_campo_2 within w_int_venlialb
integer x = 2459
integer y = 2180
integer width = 151
integer height = 88
integer taborder = 40
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;String des,desc2

uo_idioma.em_campo.text=uo_idioma.em_codigo.text
IF Trim(uo_idioma.em_campo.text)="" THEN 
 IF Trim(uo_idioma.em_codigo.text)<>"" Then uo_idioma.em_campo.SetFocus()
 uo_idioma.em_campo.text=""
 uo_idioma.em_codigo.text=""
END IF
des = uo_articulo.em_campo.text
desc2=f_descripcion_almcliartdesc2(codigo_empresa,venalb.cliente,uo_articulo.em_codigo.text,dec(uo_idioma.em_codigo.text))
if desc2<>'' then
	uo_articulo.em_campo.text=desc2
else		
	uo_articulo.em_campo.text=des
end if
em_descripcion.text = uo_articulo.em_campo.text
if idioma_ant <> uo_idioma.em_codigo.text then
	f_calculo_precio()
end if
f_campos_segun_tiplin()
end event

event getfocus;call super::getfocus;// para controlar valor anterio
  idioma_ant = uo_idioma.em_codigo.text

valor_empresa = TRUE
ue_titulo     = "Ayuda seleccion de descripciones alternativas"
ue_datawindow = "dw_ayuda_almcliartdesc"
ue_filtro     = "cliente = '"+venalb.cliente+"' and codigo = '"+uo_articulo.em_codigo.text+"'"


campo_actual = "IDIOMA"
f_peso_linea()
end event

on uo_idioma.destroy
call u_em_campo_2::destroy
end on

type uo_calidad from u_em_campo_2 within w_int_venlialb
integer x = 2615
integer y = 2180
integer width = 142
integer height = 88
integer taborder = 50
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;call super::modificado;uo_calidad.em_campo.text=f_nombre_calidad_abr(codigo_empresa,uo_calidad.em_codigo.text)
IF Trim(uo_calidad.em_campo.text)="" THEN 
 IF Trim(uo_calidad.em_codigo.text)<>"" Then uo_calidad.em_campo.SetFocus()
 uo_calidad.em_campo.text=""
 uo_calidad.em_codigo.text=""
END IF
IF calidad_ant <> uo_calidad.em_codigo.text Then
   f_calculo_precio()
END IF
f_campos_segun_tiplin()
end event

event getfocus;call super::getfocus;// para controlar valor anterio
  calidad_ant = uo_calidad.em_codigo.text

ue_titulo     = "Ayuda seleccion de calidades"
ue_datawindow = "dw_ayuda_calidades"
ue_filtro     = ""

campo_actual = "CALIDAD"
f_peso_linea()
end event

on uo_calidad.destroy
call u_em_campo_2::destroy
end on

type dw_detalle from datawindow within w_int_venlialb
integer x = 9
integer y = 240
integer width = 5179
integer height = 1848
string dataobject = "dw_int_venlialb2"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;IF Row = 0 Then 
   f_activar_primer_campo()
   Return
End IF

This.SelectRow(0,FALSE)
This.SelectRow(Row,TRUE)

//il_id_alm_orden_carga = this.object.id_alm_orden_carga[row]
//if isnull(il_id_alm_orden_carga) then il_id_alm_orden_carga = 0

tipo="M"  /* M = Modificacion,    I = Inserción */  

uo_tipolinea.em_codigo.text    = This.GetItemString(Row,"tipolinea")
uo_tipolinea.event modificado(0,0)
uo_tipolinea.ue_valor_anterior = uo_tipolinea.em_campo.text

uo_articulo.em_codigo.text    = This.GetItemString(Row,"venlialb_articulo")
uo_articulo.event modificado(0,1) 
uo_articulo.ue_valor_anterior = uo_articulo.em_campo.text

cod_tipo_unidad               = This.GetItemString(Row,"tipo_unidad")

//if uo_tipolinea.em_codigo.text = "4" then cod_tipo_unidad = "0"  //MUY IMPORTANTE: LAS MUESTRAS SIEMPRE VAN EN PIEZAS. TAMBIÉN CONTROLADO EN f_calculo_unidades_tipolin

//st_texto_cantidad.text = f_nombre_unidad(f_codigo_articulo_unidad(codigo_empresa,uo_articulo.em_codigo.text))

if uo_articulo.em_campo.text <> "" then
	em_cantidad.Setmask(DecimalMask!,f_mascara_unidad(cod_tipo_unidad))
else
	Int decimales 
	String mascara
	decimales = ftc_decimales_articulo(codigo_empresa, uo_articulo.em_codigo.text)
	if decimales > 0 then
		mascara = "###,##0."+fill("0",decimales)
	else
		mascara = "###,##0"
	end if
	em_cantidad.Setmask(DecimalMask!,mascara)
end if

//uo_familia.em_codigo.text    = This.GetItemString(Row,"familia")
//uo_familia.event modificado(0,0)//triggerevent("modificado")
//uo_familia.ue_valor_anterior = uo_familia.em_campo.text

uo_calidad.em_codigo.text    = This.GetItemString(Row,"calidad")
uo_calidad.event modificado(0,0)
uo_calidad.ue_valor_anterior = uo_calidad.em_campo.text

uo_caja.em_codigo.text    = This.GetItemString(Row,"venlialb_caja")
uo_caja.event modificado(0,0)
uo_caja.ue_valor_anterior = uo_tipo_pallet.em_campo.text

uo_tipo_pallet.em_codigo.text = This.GetItemString(Row,"tipo_pallet")
uo_tipo_pallet.event modificado(0,0)
uo_tipo_pallet.ue_valor_anterior = uo_articulo.em_campo.text

em_cajas.text                 = String(This.GetItemNumber(Row,"cajas"))
em_cantidad.text              = String(This.GetItemNumber(Row,"cantidad"))
em_cantidad.ue_ante_valor     = em_cantidad.text

em_cantidad_en_pzs.text       = String(This.GetItemNumber(Row,"venlialb_cantidad_pzs"))
em_cantidad_en_pzs.ue_ante_valor = em_cantidad_en_pzs.text

//em_cantidad_facturar.text     = String(This.GetItemNumber(Row,"venlialb_cantidad_facturar"))
//em_cantidad_facturar.ue_ante_valor = em_cantidad_facturar.text

if ib_gestionar_en_piezas then
	em_cantidad_en_pzs.event modificado(0,0)
else
	em_cantidad.event modificado(0,0)
end if

ante_existencias              = Dec(em_cantidad.text)
em_descripcion.text           = This.GetItemString(Row,"descripcion")
em_mtrs_lineales.text         = String(This.GetItemNumber(Row,"metros_lineales"))
ante_valor                    = This.GetItemNumber(Row,"precio")
//em_situacion.text             = This.GetItemString(Row,"situacion")
em_t_cajas.text               = String(This.GetItemNumber(Row,"total_cajas"))
em_t_cajas.ue_ante_valor = em_t_cajas.text

em_tono.text                  = String(This.GetItemString(Row,"tonochar"))
em_tono.ue_ante_valor = em_tono.text

em_calibre.text               = String(This.GetItemNumber(Row,"calibre"))
em_calibre.ue_ante_valor = em_calibre.text

em_tono_imprimir.text         = This.GetItemString(Row,"tono_imprimir")
em_calibre_imprimir.text      = This.GetItemString(Row,"calibre_imprimir")

uo_idioma.em_codigo.text      = This.GetItemString(Row,"idioma")
uo_idioma.em_campo.text       = This.GetItemString(Row,"idioma")

em_t_pallets.text             = String(This.GetItemNumber(Row,"pallets"))
em_t_pallets.ue_ante_valor = em_t_pallets.text

linea_albaran                 = This.GetItemNumber(Row,"linea")
control_incremento            = This.GetItemString(Row,"venlialb_control_incremento")

referencia_ant                = This.GetItemString(Row,"venlialb_referencia")
tipopallet_ant                = This.GetItemString(Row,"tipo_pallet")
cod_familia                   = This.GetItemString(Row,"venlialb_familia")
cod_formato                   = This.GetItemString(Row,"venlialb_formato")
var_situacion                 = This.GetItemString(Row,"situacion")
em_precio.text                = f_valor_columna(This,Row,"precio")
em_precio_pzs.text            = f_valor_columna(This,Row,"venlialb_precio_pzs")

em_descuento.text             = String(This.GetItemNumber(Row,"dtoesp"))
em_descuento2.text				= String(This.GetItemNumber(Row,"venlialb_dtoesp2"))
//em_fecha_intr.text				= string(date(object.fecha_intr[row]))
em_npal.text				      = String(This.GetItemNumber(Row,"venlialb_numpalet"))

st_articulo.text = "Artículo " + f_nombre_formato_abr (codigo_empresa,cod_formato)
//planificado 						= This.GetItemString(Row,"venlialb_planificado")
//sle_observaciones.text 			= This.GetItemString(Row,"venlialb_observaciones")
//sle_orden.text 			=  string(This.GetItemNumber(Row,"venlialb_orden"))
   
f_botones()
f_peso_linea()
//f_deposito()
//IF This.GetItemString(Row,"deposito") = "S" Then
//		deposito.text = "X"
//ELSE
//		deposito.text = ""
//END IF

em_situacion.text             = This.GetItemString(Row,"situacion")

var_sector  = f_sector_familia(codigo_empresa,f_familia_articulo(codigo_empresa,uo_articulo.em_codigo.text))
f_activar_primer_campo()
f_campos_segun_tiplin()
//st_pz.text = string(f_piezascaja_articulo(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text),"###,###")
//st_pal.text = string(f_cajas_pallet_articulo(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text,uo_caja.em_codigo.text),"###,###")

this.event rowfocuschanged(row)

Return
end event

event doubleclicked;//Dec v_alb,v_anyo,v_linea
//String v_tipolinea
//Boolean v_cambio=false
//
//if row=0 then return
//
//v_anyo      = dw_detalle.GetItemNumber(GetRow(),"anyo")
//v_alb       = dw_detalle.GetItemNumber(GetRow(),"albaran")
//v_linea     = dw_detalle.GetItemNumber(GetRow(),"linea")
//v_tipolinea = dw_detalle.GetItemString(GetRow(),"tipolinea")
//
//if v_tipolinea = "1" then 
//	v_tipolinea="7"
//	v_cambio = true
//else 
//	if v_tipolinea="7" then
//		v_tipolinea="1"
//		v_cambio = true
//	end if
//end if
//
//if v_cambio then
//	update venlialb
//	set tipolinea = :v_tipolinea
//	where empresa = :codigo_empresa
//	and   anyo    = :v_anyo
//	and   albaran = :v_alb
//	and   linea   = :v_linea
//	using sqlca;
//	
//	if sqlca.sqlcode = 0 then
//		COMMIT;
//		f_control()
//	else
//		f_mensaje ("Introducción de líneas","Error en el cambio de tipo de línea")
//		ROLLBACK;
//	end if
//		
//end if	
end event

type cb_palmas from u_boton within w_int_venlialb
event clicked pbm_bnclicked
integer x = 4242
integer y = 2292
integer width = 302
integer height = 80
integer taborder = 0
string text = "Pallets(+)"
end type

event clicked;call super::clicked;Dec  pall,vanyo,valbaran,vlinea
long ll_pallets_albaran
IF dw_detalle.GetRow() <> 0 Then
//IF f_control_almacen_ventipolin(codigo_empresa,dw_detalle.GetItemString(dw_detalle.GetRow(),"tipolinea")) = "N" Then Return
	pall     = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"pallets")
	vanyo    = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"anyo")
	valbaran = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"albaran")
	vlinea   = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"linea")
	IF IsNull(pall) Then pall = 0
	pall = pall +1
	
	Update venlialb
	Set    venlialb.pallets = :pall
	Where  venlialb.empresa = :codigo_empresa
	And    venlialb.anyo    = :vanyo
	And    venlialb.albaran = :valbaran
	And    venlialb.linea   = :vlinea;
	
	if sqlca.sqlcode = 0 then
		select sum(isnull(venlialb.pallets,0))
		into   :ll_pallets_albaran
		from   venlialb
		Where  venlialb.empresa = :codigo_empresa
		And    venlialb.anyo    = :vanyo
		And    venlialb.albaran = :valbaran;
	
		Update venalb
		Set    venalb.bultos = :ll_pallets_albaran
		Where  venalb.empresa = :codigo_empresa
		And    venalb.anyo    = :vanyo
		And    venalb.albaran = :valbaran;		
		
		if sqlca.sqlcode = 0 then
			Commit;
			dw_detalle.SetItem(dw_detalle.GetRow(),"pallets",pall)
			em_t_pallets.text = string(pall,em_t_pallets.mask)
		else
			rollback;
		end if
		
	else
		rollback;
	end if
END IF
end event

type cb_cajmas from u_boton within w_int_venlialb
event clicked pbm_bnclicked
integer x = 4242
integer y = 2376
integer width = 302
integer height = 80
integer taborder = 0
string text = "Cajas(+)"
end type

event clicked;call super::clicked;Dec cj,tcj,vanyo,valbaran,vlinea
IF dw_detalle.GetRow() <> 0 Then
//IF f_control_almacen_ventipolin(codigo_empresa,dw_detalle.GetItemString(dw_detalle.GetRow(),"tipolinea")) = "N" Then Return
	cj     = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"cajas")
	tcj     = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"total_cajas")
	vanyo    = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"anyo")
	valbaran = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"albaran")
	vlinea   = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"linea")
	IF IsNull(cj) Then cj = 0
	cj = cj +1
	IF IsNull(tcj) Then tcj = 0
	tcj = tcj +1

	Update venlialb
	Set cajas = :cj,
	    total_cajas = :tcj
	Where empresa = :codigo_empresa
	And   anyo    = :vanyo
	And   albaran = :valbaran
	And   linea   = :vlinea;
	Commit;

	dw_detalle.SetItem(dw_detalle.GetRow(),"cajas",cj)
	dw_detalle.SetItem(dw_detalle.GetRow(),"total_cajas",tcj)	
	
	em_cajas.text = string(cj,em_cajas.mask)		
	em_t_cajas.text = string(tcj,em_t_cajas.mask)		
END IF
end event

type em_tono_imprimir from u_em_campo within w_int_venlialb
integer x = 2423
integer y = 2356
integer width = 425
integer taborder = 80
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "MS Sans Serif"
alignment alignment = right!
string mask = "!!!!"
end type

type em_calibre_imprimir from u_em_campo within w_int_venlialb
integer x = 2853
integer y = 2356
integer width = 87
integer taborder = 100
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "MS Sans Serif"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "###,###"
end type

type st_1 from statictext within w_int_venlialb
integer x = 2853
integer y = 2280
integer width = 87
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "CI"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_8 from statictext within w_int_venlialb
integer x = 2423
integer y = 2280
integer width = 425
integer height = 76
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Tono Imprimir"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type em_precio_pzs from u_em_campo within w_int_venlialb
integer x = 4521
integer y = 2180
integer width = 315
integer height = 88
integer taborder = 190
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = decimalmask!
string mask = "#,###,###.00"
end type

event modified;call super::modified;string ls_articulo,ls_caja
dec    ld_m2_caja
long   ll_piezas_caja


ls_articulo   = uo_articulo.em_codigo.text
ls_caja       = uo_caja.em_codigo.text

if f_unidad_articulo(codigo_empresa,ls_articulo) = "1" then
		
	ld_m2_caja     = f_metroscaja_articulo(codigo_empresa,ls_articulo,ls_caja)
	ll_piezas_caja = f_piezascaja_articulo(codigo_empresa,ls_articulo,ls_caja)
	
	if ll_piezas_caja <> 0 and ld_m2_caja <> 0 then
		em_precio.text = string( (dec(this.text) * ll_piezas_caja) / ld_m2_caja,em_precio.mask)
	else
		em_precio.text = "0"
	end if

else
	em_precio.text = em_precio_pzs.text
end if

end event

type gb_4 from groupbox within w_int_venlialb
integer x = 3159
integer y = 2252
integer width = 1490
integer height = 220
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
borderstyle borderstyle = styleraised!
end type

type em_cantidad_en_pzs from u_em_campo within w_int_venlialb
integer x = 4242
integer y = 2180
integer width = 274
integer height = 88
integer taborder = 170
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = decimalmask!
string mask = "###,##0"
end type

