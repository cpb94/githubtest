$PBExportHeader$wi_mant_prod_diaria_nueva.srw
forward
global type wi_mant_prod_diaria_nueva from w_int_con_empresa
end type
type cb_aceptar from u_boton within wi_mant_prod_diaria_nueva
end type
type cb_cancelar from u_boton within wi_mant_prod_diaria_nueva
end type
type pb_1 from upb_salir within wi_mant_prod_diaria_nueva
end type
type dw_listado from datawindow within wi_mant_prod_diaria_nueva
end type
type pb_2 from upb_imprimir within wi_mant_prod_diaria_nueva
end type
type gb_7 from groupbox within wi_mant_prod_diaria_nueva
end type
type gb_6 from groupbox within wi_mant_prod_diaria_nueva
end type
type gb_2 from groupbox within wi_mant_prod_diaria_nueva
end type
type gb_1 from groupbox within wi_mant_prod_diaria_nueva
end type
type em_fechadesde from u_em_campo within wi_mant_prod_diaria_nueva
end type
type cb_listar from commandbutton within wi_mant_prod_diaria_nueva
end type
type em_nueva_fecha from u_em_campo within wi_mant_prod_diaria_nueva
end type
type em_fechahasta from u_em_campo within wi_mant_prod_diaria_nueva
end type
type dw_tonos from datawindow within wi_mant_prod_diaria_nueva
end type
type st_2 from statictext within wi_mant_prod_diaria_nueva
end type
type dw_produccion from u_datawindow within wi_mant_prod_diaria_nueva
end type
type st_1 from statictext within wi_mant_prod_diaria_nueva
end type
type p_rayas from picture within wi_mant_prod_diaria_nueva
end type
type tab_1 from tab within wi_mant_prod_diaria_nueva
end type
type tabpage_1 from userobject within tab_1
end type
type dw_1 from u_datawindow within tabpage_1
end type
type tabpage_1 from userobject within tab_1
dw_1 dw_1
end type
type tabpage_2 from userobject within tab_1
end type
type dw_2 from u_datawindow within tabpage_2
end type
type tabpage_2 from userobject within tab_1
dw_2 dw_2
end type
type tabpage_3 from userobject within tab_1
end type
type dw_3 from u_datawindow within tabpage_3
end type
type tabpage_3 from userobject within tab_1
dw_3 dw_3
end type
type tabpage_4 from userobject within tab_1
end type
type dw_4 from u_datawindow within tabpage_4
end type
type tabpage_4 from userobject within tab_1
dw_4 dw_4
end type
type tabpage_5 from userobject within tab_1
end type
type dw_5 from u_datawindow within tabpage_5
end type
type tabpage_5 from userobject within tab_1
dw_5 dw_5
end type
type tabpage_6 from userobject within tab_1
end type
type dw_6 from u_datawindow within tabpage_6
end type
type tabpage_6 from userobject within tab_1
dw_6 dw_6
end type
type tabpage_7 from userobject within tab_1
end type
type dw_7 from u_datawindow within tabpage_7
end type
type tabpage_7 from userobject within tab_1
dw_7 dw_7
end type
type tabpage_8 from userobject within tab_1
end type
type dw_8 from u_datawindow within tabpage_8
end type
type tabpage_8 from userobject within tab_1
dw_8 dw_8
end type
type tabpage_9 from userobject within tab_1
end type
type dw_9 from u_datawindow within tabpage_9
end type
type tabpage_9 from userobject within tab_1
dw_9 dw_9
end type
type tabpage_10 from userobject within tab_1
end type
type dw_10 from u_datawindow within tabpage_10
end type
type tabpage_10 from userobject within tab_1
dw_10 dw_10
end type
type tabpage_11 from userobject within tab_1
end type
type dw_11 from u_datawindow within tabpage_11
end type
type tabpage_11 from userobject within tab_1
dw_11 dw_11
end type
type tabpage_12 from userobject within tab_1
end type
type dw_12 from u_datawindow within tabpage_12
end type
type tabpage_12 from userobject within tab_1
dw_12 dw_12
end type
type tabpage_13 from userobject within tab_1
end type
type dw_13 from u_datawindow within tabpage_13
end type
type tabpage_13 from userobject within tab_1
dw_13 dw_13
end type
type tabpage_14 from userobject within tab_1
end type
type dw_14 from u_datawindow within tabpage_14
end type
type tabpage_14 from userobject within tab_1
dw_14 dw_14
end type
type tabpage_15 from userobject within tab_1
end type
type dw_15 from u_datawindow within tabpage_15
end type
type tabpage_15 from userobject within tab_1
dw_15 dw_15
end type
type tab_1 from tab within wi_mant_prod_diaria_nueva
tabpage_1 tabpage_1
tabpage_2 tabpage_2
tabpage_3 tabpage_3
tabpage_4 tabpage_4
tabpage_5 tabpage_5
tabpage_6 tabpage_6
tabpage_7 tabpage_7
tabpage_8 tabpage_8
tabpage_9 tabpage_9
tabpage_10 tabpage_10
tabpage_11 tabpage_11
tabpage_12 tabpage_12
tabpage_13 tabpage_13
tabpage_14 tabpage_14
tabpage_15 tabpage_15
end type
type dw_pendiente_escandallo from u_datawindow within wi_mant_prod_diaria_nueva
end type
type dw_pendiente from u_datawindow within wi_mant_prod_diaria_nueva
end type
type dw_reservas_pendiente_escandallo from datawindow within wi_mant_prod_diaria_nueva
end type
type dw_situacion_articulo from datawindow within wi_mant_prod_diaria_nueva
end type
end forward

global type wi_mant_prod_diaria_nueva from w_int_con_empresa
integer x = 0
integer y = 0
integer width = 3685
integer height = 2300
cb_aceptar cb_aceptar
cb_cancelar cb_cancelar
pb_1 pb_1
dw_listado dw_listado
pb_2 pb_2
gb_7 gb_7
gb_6 gb_6
gb_2 gb_2
gb_1 gb_1
em_fechadesde em_fechadesde
cb_listar cb_listar
em_nueva_fecha em_nueva_fecha
em_fechahasta em_fechahasta
dw_tonos dw_tonos
st_2 st_2
dw_produccion dw_produccion
st_1 st_1
p_rayas p_rayas
tab_1 tab_1
dw_pendiente_escandallo dw_pendiente_escandallo
dw_pendiente dw_pendiente
dw_reservas_pendiente_escandallo dw_reservas_pendiente_escandallo
dw_situacion_articulo dw_situacion_articulo
end type
global wi_mant_prod_diaria_nueva wi_mant_prod_diaria_nueva

type variables
Datawindow dw_array[1 to 15]
long  posicion_dw_array[1 to 15]
string linea_activa,array_lineas[1 to 15]
boolean array_lineas_modificadas[1 to 15],filigrana = false
boolean bloqueando = false
string filtro_formatos_linea = ""
long row_anterior_arrastre
long y_anterior_arrastre
int pagina_seleccionada = 0
end variables

forward prototypes
public subroutine f_actualizar_datos ()
public subroutine f_recalculo_produccion ()
public subroutine f_agrupar_lineas ()
public subroutine f_borrar_lin_proddiaria ()
public subroutine f_valores_datawindows (string var_empresa)
public function datetime f_pasar_lineas_siguiente_grupo (string ar_empresa, datetime dia, long indice, long total, string linea)
public function boolean f_dividir_linea (long indice1, decimal total_horas_grupo, decimal horas_dia, datetime nuevo_dia)
public function boolean f_grabar_produccion ()
public function string f_filtro_formatos_linea (string arg_empresa, string arg_linea)
public subroutine f_reservas_pendiente_esc (long arg_row)
public function boolean f_actualizar_pendiente_comp (long arg_row)
public subroutine f_mostrar_situacion_articulo_coccion (string arg_articulo, integer arg_coccion, integer arg_anyo_orden_produccion, long arg_orden_produccion)
end prototypes

public subroutine f_actualizar_datos ();Long reg,registros
String art,emp

registros = dw_produccion.rowcount()

for reg = 1 to registros
	f_mensaje_proceso("Actualizando datos",reg,registros)
	emp = dw_produccion.GetItemString(reg,"empresa")	
	art = dw_produccion.GetItemString(reg,"articulo")
	// esto ha de cambiar, cuando se haga la opción de la empresa en la
	// ventana
	dw_produccion.SetItem(reg,"familia",f_familia_articulo(emp,art))
	dw_produccion.SetItem(reg,"formato",f_formato_articulo(emp,art))		
next
end subroutine

public subroutine f_recalculo_produccion ();// By Pako M. 22/12/98 \\

long     indice1,total1,ultima_orden,dias_de_mas
datetime dia,dia_ant,nuevo_dia,fecha_anterior
datetime hora_comienzo,hora_comienzo_teorica
dec      total_horas_grupo,horas_dia,pendiente_cambio,m2_articulo,metros_hora_formato
dec      cantidad,horas_articulo,horas_libres_grupo_anterior
string   formato,ant_formato,linea,articulo,ant_articulo,respetar_hora_comienzo,tipo_linea
int      bien = 0
boolean  cambiar_anterior
dw_produccion.SetRedraw(FALSE)

total1  = dw_produccion.rowcount()
dia_ant = dw_produccion.getitemdatetime(1,"fecha")

for indice1 = 1 to total1
	f_mensaje_proceso("Preparando Lineas",indice1,total1)
	dw_produccion.setitem(indice1,"fecha",dia_ant)
	dw_produccion.setitem(indice1,"orden",indice1)
next
dw_produccion.groupcalc()

f_agrupar_lineas()

linea      = dw_produccion.getitemstring(1,"linea")
tipo_linea = f_tipo_linea(codigo_empresa,linea)
horas_dia                   = 24
total_horas_grupo           = 0
pendiente_cambio            = 0
horas_libres_grupo_anterior = 0

//Obtenemos el ultimo articulo de la producción
//del dia anterior al inicio de la producción que calculamos
//y calculamos las horas libres que nos quedaron ese dia
fecha_anterior = datetime(relativedate(date(dia_ant),-1))
dia_ant = fecha_anterior

select max(orden)
into   :ultima_orden
from   proddiaria
where  empresa = :codigo_empresa
and    linea   = :linea
and    fecha   = :fecha_anterior;

if isnull(ultima_orden) then ultima_orden = 0

ant_formato = ""
ant_articulo = ""

if ultima_orden > 0 then
	select articulo,hora_comienzo,cantidad
	into   :articulo,:hora_comienzo,:cantidad
	from   proddiaria
	where  empresa = :codigo_empresa
	and    linea   = :linea
	and    fecha   = :fecha_anterior
	and    orden   = :ultima_orden;
	
	if isnull(articulo) then articulo = ""
	if trim(articulo) <> "" then
		formato      = f_formato_articulo(codigo_empresa,articulo)
		ant_articulo = articulo
		ant_formato  = formato
		m2_articulo         = f_conversion_cantidad_m2(codigo_empresa , articulo , cantidad )
		metros_hora_formato = f_metros_formato_linea_hora(codigo_empresa,linea,formato)
		horas_articulo      = m2_articulo / metros_hora_formato		
		horas_libres_grupo_anterior = (secondsafter(time(hora_comienzo),time(23,59,59)) / 3600) - horas_articulo		
	end if

end if

for indice1 = 1 to total1	
	f_mensaje_proceso("Recalculando La Produccion",indice1,total1)
	if bien = 0 then
		dia                    = dw_produccion.getitemdatetime(indice1,"fecha")
		
		if dia <> dia_ant then
			total_horas_grupo = pendiente_cambio - horas_libres_grupo_anterior
			horas_libres_grupo_anterior = 0
			dia_ant = dia			
		end if
		
		articulo    = dw_produccion.getitemstring(indice1,"articulo")
		formato     = f_formato_articulo(codigo_empresa,articulo)				
		if ant_formato = "" then
			ant_formato = formato
		end if
		if ant_articulo = "" then
			ant_articulo = articulo
		end if		
		
		choose case tipo_linea
			case "P"
				//Calculo del tiempo perdido en los cambios de la prensa
				if ant_articulo <> articulo then
					f_tiempo_cambio_molde_linea(codigo_empresa,linea)
				end if
			case "E"
				//Calculo del tiempo perdido en los cambios de la esmaltadora
				
				if ant_articulo <> articulo then
					if ant_formato <> formato then				
						total_horas_grupo = total_horas_grupo + f_tiempo_cambio_formato_linea(codigo_empresa,linea)
					else
						total_horas_grupo = total_horas_grupo + f_tiempo_cambio_modelo_linea(codigo_empresa,linea)
					end if
				end if		
			case "H"
				//Calculo del tiempo perdido en los cambios del horno
				if ant_articulo <> articulo then
					f_tiempo_cambio_ciclo_linea(codigo_empresa,linea)
					f_tiempo_cambio_temperatura_linea(codigo_empresa,linea)
				end if				
		end  choose
		
		respetar_hora_comienzo = dw_produccion.getitemstring(indice1,"respetar_hora_comienzo")
		if isnull(respetar_hora_comienzo) then respetar_hora_comienzo = "N"
		
		if respetar_hora_comienzo = "S" then
			hora_comienzo = dw_produccion.getitemdatetime(indice1,"hora_comienzo")
			if total_horas_grupo > 24 then
				dias_de_mas = Truncate(total_horas_grupo/24, 0)
				total_horas_grupo = total_horas_grupo - (24 * dias_de_mas)
				dia = datetime(relativedate(date(dia),dias_de_mas),time(0,0,0))
			end if
			
			hora_comienzo_teorica = datetime(date(dia), relativetime(time(0,0,0),total_horas_grupo*3600))			
			if hora_comienzo_teorica > hora_comienzo then
				hora_comienzo = hora_comienzo_teorica
			else				
				if date(dia) < date(hora_comienzo) then
					total_horas_grupo = (SecondsAfter (time(0,0,0),time(hora_comienzo))/3600) 
					dia = datetime(date(hora_comienzo),time(0,0,0))
				else					
					total_horas_grupo = total_horas_grupo + (SecondsAfter (relativetime(time(0,0,0),total_horas_grupo*3600),time(hora_comienzo))/3600) 
				end if				
			end if
		else
			hora_comienzo = datetime(date(dia),relativetime(time(0,0,0),total_horas_grupo*3600))
		end if		
				
		dw_produccion.object.hora_comienzo[indice1] = hora_comienzo
		dw_produccion.object.fecha[indice1]         = dia
		
		cantidad            = dw_produccion.getitemdecimal(indice1,"cantidad")					
		m2_articulo         = f_conversion_cantidad_m2(codigo_empresa , articulo , cantidad )
		metros_hora_formato = f_metros_formato_linea_hora(codigo_empresa,linea,formato)
		horas_articulo      = m2_articulo / metros_hora_formato
		total_horas_grupo   = total_horas_grupo + horas_articulo


		ant_formato  = formato
		ant_articulo = articulo
		if not f_linea_activa_dia(codigo_empresa,linea,dia) then			
			horas_dia = 0
		else
			horas_dia = 24
		end if
		if total_horas_grupo > horas_dia then
			nuevo_dia = f_pasar_lineas_siguiente_grupo(codigo_empresa,dia,indice1,total1,linea)			
			if (total_horas_grupo - horas_articulo) > horas_dia then
				pendiente_cambio = (total_horas_grupo - horas_articulo) - horas_dia 
			else
				pendiente_cambio = 0
			end if
			if nuevo_dia <> dia then
				if not(f_dividir_linea (indice1,total_horas_grupo,horas_dia,nuevo_dia)) then					
					indice1 = indice1 -1					
				end if
			else
				bien = 1
			end if			
		end if
		total1 = dw_produccion.rowcount()
	end if
next

dw_produccion.SetRedraw(TRUE)

dw_produccion.Sort()
dw_produccion.GroupCalc()

end subroutine

public subroutine f_agrupar_lineas ();long   indice,total,indice_s,orden_produccion,orden_produccion_s
int    anyo_orden,anyo_orden_s,coccion,coccion_s
string articulo,articulo_s
string linea
string fabricado,fabricado_s,respetar_hora_comienzo_s
dec    cantidad
datetime hora_comienzo_s

total = dw_produccion.rowcount()

if total > 0 then
	for indice = 1 to total -1
		indice_s           = indice +1
		linea              = dw_produccion.getitemstring(indice,"articulo")
		articulo           = dw_produccion.getitemstring(indice,"articulo")
		coccion				 = dw_produccion.getitemnumber(indice,"coccion")
		//fabricado          = dw_produccion.getitemstring(indice,"fabricado")
		cantidad           = dw_produccion.getitemdecimal(indice,"cantidad")
		orden_produccion   = dw_produccion.getitemnumber(indice,"orden_produccion")
		anyo_orden         = dw_produccion.getitemnumber(indice,"anyo_orden_produccion")		
		
		articulo_s         = dw_produccion.getitemstring(indice_s,"articulo")
		coccion_s			 = dw_produccion.getitemnumber(indice_s,"coccion")
		//fabricado_s        = dw_produccion.getitemstring(indice_s,"fabricado")		
		orden_produccion_s = dw_produccion.getitemnumber(indice_s,"orden_produccion")
		anyo_orden_s       = dw_produccion.getitemnumber(indice_s,"anyo_orden_produccion")
		hora_comienzo_s    = dw_produccion.getitemdatetime(indice_s,"hora_comienzo")		
		respetar_hora_comienzo_s = dw_produccion.getitemstring(indice_s,"respetar_hora_comienzo")		
		if isnull(respetar_hora_comienzo_s) then respetar_hora_comienzo_s = "N"
		
		do while (articulo = articulo_s) and (orden_produccion = orden_produccion_s) &
													and (anyo_orden = anyo_orden_s) &
													and (coccion = coccion_s) &
													and (indice_s <= total) &													
													and respetar_hora_comienzo_s <> "S"
													
			cantidad = cantidad + dw_produccion.getitemdecimal(indice_s,"cantidad")
			dw_produccion.deleterow(indice_s)
			total = dw_produccion.rowcount()
			if indice_s <= total then
				articulo_s         = dw_produccion.getitemstring(indice_s,"articulo")
				coccion_s			 = dw_produccion.getitemnumber(indice_s,"coccion")
				//fabricado_s        = dw_produccion.getitemstring(indice_s,"fabricado")
				orden_produccion_s = dw_produccion.getitemnumber(indice_s,"orden_produccion")
				anyo_orden_s       = dw_produccion.getitemnumber(indice_s,"anyo_orden_produccion")				
				hora_comienzo_s    = dw_produccion.getitemdatetime(indice_s,"hora_comienzo")		
				respetar_hora_comienzo_s = dw_produccion.getitemstring(indice_s,"respetar_hora_comienzo")						
			end if
			dw_produccion.setitem(indice,"cantidad",cantidad)
//			dw_produccion.update()
//			commit;
		loop
	next
	total = dw_produccion.rowcount()
end if
end subroutine

public subroutine f_borrar_lin_proddiaria ();datetime fecha
int bien = 0

fecha = datetime(RelativeDate ( today(),-60))

delete from proddiaria where fecha < :fecha USING sqlca ;

if sqlca.sqlcode <> 0 then
	f_mensaje("Error al borrar","Atención , se ha producido el error~n"+&
	          sqlca.sqlerrtext+"~nEn F_BORRAR_LINEAS_ANTERIORES~n"+&
				 "Avise al administrador de su sistema")
	rollback;
else
	commit;
end if

end subroutine

public subroutine f_valores_datawindows (string var_empresa);//By Pakito 06/03/00
//En esta funcion cargamos los valores de la 15 datawindows de la ventana
long      pos_x,pos_y,pos_width,pos_height
boolean   var_VScrollBar
datetime  ultima_fecha
datastore lineas
long      indice,total,orden
string    linea,nombre_linea,sel,tipo_linea

sel = "select codigo,descripcion,resumido,tipo_linea,0 orden " +&
		"from prodlineas "+&
		"where empresa = '"+var_empresa+"' "
		
		
lineas = f_cargar_cursor(sel)
total  = lineas.rowcount()

if total > 0 then
	IF tab_1.tabpage_1.PageCreated() = False THEN
		tab_1.tabpage_1.CreatePage()
	END IF		
	if total > 1 then
		IF tab_1.tabpage_2.PageCreated() = False THEN
			tab_1.tabpage_2.CreatePage()
		END IF		
		if total > 2 then			
			IF tab_1.tabpage_3.PageCreated() = False THEN
				tab_1.tabpage_3.CreatePage()
			END IF		
			if total > 3 then
				IF tab_1.tabpage_4.PageCreated() = False THEN
					tab_1.tabpage_4.CreatePage()
				END IF		
				if total > 4 then
					IF tab_1.tabpage_5.PageCreated() = False THEN
						tab_1.tabpage_5.CreatePage()
					END IF		
					if total > 5 then
						IF tab_1.tabpage_6.PageCreated() = False THEN
							tab_1.tabpage_6.CreatePage()
						END IF		
						if total > 6 then			
							IF tab_1.tabpage_7.PageCreated() = False THEN
								tab_1.tabpage_7.CreatePage()
							END IF		
							if total > 7 then
								IF tab_1.tabpage_8.PageCreated() = False THEN
									tab_1.tabpage_8.CreatePage()
								END IF		
								if total > 8 then
									IF tab_1.tabpage_9.PageCreated() = False THEN
										tab_1.tabpage_9.CreatePage()
									END IF		
									if total > 9 then
										IF tab_1.tabpage_10.PageCreated() = False THEN
											tab_1.tabpage_10.CreatePage()
										END IF		
										if total > 10 then			
											IF tab_1.tabpage_11.PageCreated() = False THEN
												tab_1.tabpage_11.CreatePage()
											END IF		
											if total > 11 then
												IF tab_1.tabpage_12.PageCreated() = False THEN
													tab_1.tabpage_12.CreatePage()
												END IF		
												if total > 12 then
													IF tab_1.tabpage_13.PageCreated() = False THEN
														tab_1.tabpage_13.CreatePage()
													END IF		
													if total > 13 then
														IF tab_1.tabpage_14.PageCreated() = False THEN
															tab_1.tabpage_14.CreatePage()
														END IF		
														if total > 14 then			
															IF tab_1.tabpage_15.PageCreated() = False THEN
																tab_1.tabpage_15.CreatePage()
															END IF		
														end if
													end if	
												end if
											end if
										end if		
									end if	
								end if				
							end if		
						end if	
					end if				
				end if
			end if		
		end if	
	end if
end if


tab_1.tabpage_1.visible = FALSE
tab_1.tabpage_2.visible = FALSE
tab_1.tabpage_3.visible = FALSE
tab_1.tabpage_4.visible = FALSE
tab_1.tabpage_5.visible = FALSE
tab_1.tabpage_6.visible = FALSE
tab_1.tabpage_7.visible = FALSE
tab_1.tabpage_8.visible = FALSE
tab_1.tabpage_9.visible = FALSE
tab_1.tabpage_10.visible = FALSE
tab_1.tabpage_11.visible = FALSE
tab_1.tabpage_12.visible = FALSE
tab_1.tabpage_13.visible = FALSE
tab_1.tabpage_14.visible = FALSE
tab_1.tabpage_15.visible = FALSE

dw_array[1]  = tab_1.tabpage_1.dw_1
dw_array[2]  = tab_1.tabpage_2.dw_2
dw_array[3]  = tab_1.tabpage_3.dw_3
dw_array[4]  = tab_1.tabpage_4.dw_4
dw_array[5]  = tab_1.tabpage_5.dw_5
dw_array[6]  = tab_1.tabpage_6.dw_6
dw_array[7]  = tab_1.tabpage_7.dw_7
dw_array[8]  = tab_1.tabpage_8.dw_8
dw_array[9]  = tab_1.tabpage_9.dw_9
dw_array[10] = tab_1.tabpage_10.dw_10
dw_array[11] = tab_1.tabpage_11.dw_11
dw_array[12] = tab_1.tabpage_12.dw_12
dw_array[13] = tab_1.tabpage_13.dw_13
dw_array[14] = tab_1.tabpage_14.dw_14
dw_array[15] = tab_1.tabpage_15.dw_15

pos_x       = 0
pos_y			= 0
pos_width   = 3547
pos_height  = 1012
var_VScrollBar = true
dw_produccion.dataobject  = "dw_mant_prod_diaria_n"
dw_produccion.SetTransObject(sqlca)

for indice = 1 to total
	dw_array[indice].x          = pos_x
	dw_array[indice].y          = pos_y
	dw_array[indice].width      = pos_width
	dw_array[indice].height     = pos_height
	dw_array[indice].VScrollBar = var_VScrollBar
	dw_array[indice].dataobject = "dw_mant_prod_diaria_n"
	dw_array[indice].tag        = string(indice)
	dw_produccion.sharedata(dw_array[indice])
	posicion_dw_array[indice]   = 0
next

for indice = 1 to total
	tipo_linea = lineas.object.tipo_linea[indice]
	choose case tipo_linea
		case "P"
			orden = 1
		case "E"
			orden = 2
		case "H"
			orden = 3
	end choose
	lineas.object.orden[indice] = orden
next
lineas.setsort("orden,convert(int,codigo)")
lineas.sort()
em_fechadesde.text = ""
if total > 0 then
	for indice = 1 to total
		array_lineas[indice] = lineas.object.codigo[indice]
		array_lineas_modificadas[indice] = false
		//Seleccionamos la menor de las maximas fechas de las ordenes de
		//Producción segun lineas de producción
		select max(fecha)
		into   :ultima_fecha
		from   proddiaria
		where  empresa = :var_empresa
		and    linea   = :array_lineas[indice];
		
		if not(isnull(ultima_fecha)) then		
			if em_fechadesde.text = "00-00-00" then
				em_fechadesde.text = string(date(ultima_fecha),"dd/mm/yy")
			else
				if date(em_fechadesde.text) > date(ultima_fecha) then
					em_fechadesde.text = string(date(ultima_fecha),"dd/mm/yy")
				end if
			end if
		end if	
	next	
	if em_fechadesde.text = "00-00-00" then
		em_fechadesde.text = string(today(),"dd/mm/yy")
	end if
	if total > 0 then
		tab_1.tabpage_1.visible = true
		tab_1.tabpage_1.text    =  lineas.object.descripcion[1]
		if total > 1 then
			tab_1.tabpage_2.visible = true
			tab_1.tabpage_2.text    =  lineas.object.descripcion[2]
			if total > 2 then			
				tab_1.tabpage_3.visible = true
				tab_1.tabpage_3.text    =  lineas.object.descripcion[3]
				if total > 3 then
					tab_1.tabpage_4.visible = true
					tab_1.tabpage_4.text    =  lineas.object.descripcion[4]
					if total > 4 then
						tab_1.tabpage_5.visible = true
						tab_1.tabpage_5.text    =  lineas.object.descripcion[5]
						if total > 5 then
							tab_1.tabpage_6.visible = true
							tab_1.tabpage_6.text    =  lineas.object.descripcion[6]
							if total > 6 then			
								tab_1.tabpage_7.visible = true
								tab_1.tabpage_7.text    =  lineas.object.descripcion[7]
								if total > 7 then
									tab_1.tabpage_8.visible = true
									tab_1.tabpage_8.text    =  lineas.object.descripcion[8]
									if total > 8 then
										tab_1.tabpage_9.visible = true
										tab_1.tabpage_9.text    =  lineas.object.descripcion[9]
										if total > 9 then
											tab_1.tabpage_10.visible = true
											tab_1.tabpage_10.text    =  lineas.object.descripcion[10]
											if total > 10 then			
												tab_1.tabpage_11.visible = true
												tab_1.tabpage_11.text    =  lineas.object.descripcion[11]
												if total > 11 then
													tab_1.tabpage_12.visible = true
													tab_1.tabpage_12.text    =  lineas.object.descripcion[12]
													if total > 12 then
														tab_1.tabpage_13.visible = true
														tab_1.tabpage_13.text    =  lineas.object.descripcion[13]
														if total > 13 then
															tab_1.tabpage_14.visible = true
															tab_1.tabpage_14.text    =  lineas.object.descripcion[14]
															if total > 14 then			
																tab_1.tabpage_15.visible = true
																tab_1.tabpage_15.text    =  lineas.object.descripcion[15]
															end if
														end if	
													end if
												end if
											end if		
										end if	
									end if				
								end if		
							end if	
						end if				
					end if
				end if		
			end if	
		end if
	end if
	if total < 15 then
		for indice = total+1 to 15
			destroy dw_array[indice]
		next
	end if
end if
destroy lineas

end subroutine

public function datetime f_pasar_lineas_siguiente_grupo (string ar_empresa, datetime dia, long indice, long total, string linea);long indice1,orden,contador
datetime nuevo_dia
boolean linea_activa_dia

contador = 0
linea_activa_dia = false
nuevo_dia = datetime(dia)
do while not(linea_activa_dia) and contador < 200	
	nuevo_dia = datetime(relativedate(date(nuevo_dia),1))	
	linea_activa_dia = f_linea_activa_dia(codigo_empresa,linea,nuevo_dia)
	contador = contador +1
loop

if contador = 200 then
	messagebox("ERROR","NO ES POSIBLE RECALCULAR LA PRODUCCION")
	return dia
else	
	orden = 2	
	for indice1 = indice + 1 to total
		dw_produccion.setitem(indice1,"fecha",datetime(nuevo_dia))
		dw_produccion.setitem(indice1,"orden",orden)
		orden = orden +1
	next
	return nuevo_dia
end if
end function

public function boolean f_dividir_linea (long indice1, decimal total_horas_grupo, decimal horas_dia, datetime nuevo_dia);// by Pako M. 23/12/98 \\
// Retorna true si ha dividido la linea \\

dec      diferencia,dif_cant
string   articulo,v_empresa,fabricado,impresa,caja,formato
string   tipo_pallet,tono,tono_obligatorio,linea
dec      relacion_cant_m2,cant,cant_m2,cant_horas,metros_hora_formato
long     donde,calibre,orden_produccion,anyo_orden
int      coccion
datetime fecha,f_entrada

if horas_dia > 0 then
	diferencia       = total_horas_grupo - horas_dia
	linea            = dw_produccion.getitemstring(indice1,"linea")
	articulo         = dw_produccion.getitemstring(indice1,"articulo")
	coccion          = dw_produccion.getitemnumber(indice1,"coccion")
	v_empresa        = dw_produccion.getitemstring(indice1,"empresa")
	cant             = dw_produccion.getitemdecimal(indice1,"cantidad")
	orden_produccion = dw_produccion.getitemnumber(indice1,"orden_produccion")
	anyo_orden       = dw_produccion.getitemnumber(indice1,"anyo_orden_produccion")	
	cant_m2          = f_conversion_cantidad_m2(codigo_empresa , articulo , cant )
	formato          = f_formato_articulo(codigo_empresa,articulo)
	metros_hora_formato = f_metros_formato_linea_hora(codigo_empresa,linea,formato)
	cant_horas          = cant_m2 / metros_hora_formato
	if diferencia > cant_horas then
		diferencia = cant_horas
	end if
	//fabricado        = dw_produccion.getitemstring(indice1,"fabricado")
	f_entrada        = dw_produccion.getitemdatetime(indice1,"f_entrada")	
	fecha            = nuevo_dia
	relacion_cant_m2 = cant_m2/cant
	dif_cant         = (diferencia * metros_hora_formato)/relacion_cant_m2
	if (cant - dif_cant)>= 1 then 
		dw_produccion.setitem(indice1,"cantidad",cant - dif_cant)
		donde = dw_produccion.insertrow(indice1+1)
		dw_produccion.setitem(donde,"empresa",v_empresa)
		dw_produccion.setitem(donde,"fecha",fecha)
		dw_produccion.setitem(donde,"linea",linea)
		dw_produccion.setitem(donde,"orden",1)
		dw_produccion.setitem(donde,"articulo",articulo)
		dw_produccion.setitem(donde,"coccion",coccion)
		dw_produccion.setitem(donde,"cantidad",dif_cant)
		//dw_produccion.setitem(donde,"fabricado",fabricado)
		dw_produccion.setitem(donde,"impresa","N")
		dw_produccion.setitem(donde,"f_entrada",f_entrada)
		dw_produccion.setitem(donde,"orden_produccion",orden_produccion)
		dw_produccion.setitem(donde,"anyo_orden_produccion",anyo_orden)
		return true
	else
		dw_produccion.setitem(indice1,"fecha",fecha)
		dw_produccion.setitem(indice1,"orden",1)
		return false
	end if
else
	fecha = nuevo_dia
	dw_produccion.setitem(indice1,"fecha",fecha)	
	dw_produccion.setitem(indice1,"orden",1)
	return false
end if



end function

public function boolean f_grabar_produccion ();datetime f_desde 
long     indice,total,orden,anyo_orden_produccion,orden_produccion
string   linea,articulo,familia,formato,unidad,impresa
string   respetar_hora_comienzo
datetime fecha,f_entrada,hora_comienzo
dec      cantidad 
int      coccion
boolean  bien = true
f_desde = datetime(date(em_fechadesde.text))

delete proddiaria
where  empresa = :codigo_empresa
and    fecha  >= :f_desde;

if sqlca.sqlcode = 0 then
	total = dw_produccion.rowcount()
	if total > 0 then
		for indice = 1 to total
			linea                 = dw_produccion.object.linea[indice] 
			//orden                 = dw_produccion.object.orden[indice] 
			fecha                 = dw_produccion.object.fecha[indice] 
			articulo              = dw_produccion.object.articulo[indice] 
			coccion               = dw_produccion.object.coccion[indice] 
			familia               = dw_produccion.object.familia[indice] 
			formato               = dw_produccion.object.formato[indice] 
			cantidad              = dw_produccion.object.cantidad[indice] 
			unidad                = dw_produccion.object.unidad[indice] 
			//fabricado             = dw_produccion.object.fabricado[indice] 
			f_entrada             = dw_produccion.object.f_entrada[indice] 
			impresa               = dw_produccion.object.impresa[indice] 
			anyo_orden_produccion = dw_produccion.object.anyo_orden_produccion[indice] 
			orden_produccion      = dw_produccion.object.orden_produccion[indice] 
			hora_comienzo         = dw_produccion.object.hora_comienzo[indice]
			respetar_hora_comienzo= dw_produccion.object.respetar_hora_comienzo[indice]
			if isnull(respetar_hora_comienzo) then respetar_hora_comienzo = "N"
			
			select max(orden)
			into   :orden
			from   proddiaria
			where  empresa = :codigo_empresa
			and    linea   = :linea
			and    fecha   = :fecha;
			
			if isnull(orden) then orden = 0
			
			orden ++
			
			insert into proddiaria
				( empresa,
				  linea,
				  orden,
				  fecha,
				  articulo,
				  coccion,
				  familia,
				  formato,
				  cantidad,
				  unidad,
				  f_entrada,
				  impresa,
				  anyo_orden_produccion,
				  orden_produccion,
				  hora_comienzo,
				  respetar_hora_comienzo)
			values
				( :codigo_empresa,
				  :linea,
				  :orden,
				  :fecha,
				  :articulo,
				  :coccion,
				  :familia,
				  :formato,
				  :cantidad,
				  :unidad,
				  :f_entrada,
				  :impresa,
				  :anyo_orden_produccion,
				  :orden_produccion,
				  :hora_comienzo,
				  :respetar_hora_comienzo);
				  
			if sqlca.sqlcode <> 0 then
				bien = false
			end if
		next
	end if
else
	bien = false
end if

return bien
end function

public function string f_filtro_formatos_linea (string arg_empresa, string arg_linea);string sel,filtro,formato
long indice,total
datastore formatos

sel = "SELECT formato "+&
		"FROM   prodmetroshoralinea "+&
		"where  empresa = '"+arg_empresa+"' "+&
		"and    linea   = '"+arg_linea+"' "+&
		"and    (metroshora > 0 and metroshora is not null)"

formatos = f_cargar_cursor(sel)
total = formatos.rowcount()
filtro = ""
if total > 0 then
	for indice = 1 to total
		formato = formatos.object.formato[indice]
		if trim(filtro) = "" then
			filtro = "'"+formato+"'"
		else
			filtro = filtro+",'"+formato+"'"
		end if
	next
	if trim(filtro) <> "" then
		filtro = "formato in ("+filtro+")"
	else
		filtro = "formato = '*'"  	//No seleccionamos ningun formato
	end if
else
	filtro = "formato = '*'"  	//No seleccionamos ningun formato
end if

destroy formatos

return filtro
end function

public subroutine f_reservas_pendiente_esc (long arg_row);string    sel,articulo,calidad,tono,tipo_pallet,caja,referencia,mascara
int       calibre,anyo
long      indice,total,contador,linea,donde
dec       stock,reservado,preparado,disponible,reservado_produccion
datastore dw_stock

dw_reservas_pendiente_escandallo.retrieve(codigo_empresa)
dw_reservas_pendiente_escandallo.visible = false

articulo = dw_pendiente_escandallo.object.articulo[arg_row]
//Se utilizara en el almacen el calibre para indicar la cocción
calibre  = dw_pendiente_escandallo.object.coccion[arg_row]
anyo     = dw_pendiente_escandallo.object.anyo[arg_row]
contador = dw_pendiente_escandallo.object.contador[arg_row]
linea    = dw_pendiente_escandallo.object.linea[arg_row]

mascara  = f_mascara_unidad(f_unidad_articulo(codigo_empresa,articulo))

dw_reservas_pendiente_escandallo.Modify("disponible.edit.format = '"+mascara+"'")
dw_reservas_pendiente_escandallo.Modify("disponible.format = '"+mascara+"'")
dw_reservas_pendiente_escandallo.Modify("reservado.edit.format = '"+mascara+"'")
dw_reservas_pendiente_escandallo.Modify("reservado.format = '"+mascara+"'")

sel = "select calidad,tonochar,calibre,tipo_pallet,caja,sum(existencias) stock "+&
		"from almlinubica "+&
		"where empresa  = '"+codigo_empresa+"' "+&
		"and   articulo = '"+articulo+"' "+&
		"and   calibre  = "+string(calibre,"##")+" "+&
		"group by calidad,tonochar,calibre,tipo_pallet,caja"
		
dw_stock = f_cargar_cursor(sel)
f_cargar_cursor_nuevo(sel, dw_stock)
total = dw_stock.rowcount()

if total > 0 then
	for indice = 1 to total
		calidad     = dw_stock.object.calidad[indice]
		tono        = dw_stock.object.tonochar[indice]
		calibre     = dw_stock.object.calibre[indice]
		tipo_pallet = dw_stock.object.tipo_pallet[indice]
		caja        = dw_stock.object.caja[indice]
		stock       = dw_stock.object.stock[indice]
		referencia  = f_componer_ref(articulo,calidad,tono,calibre)
		reservado   = f_reservado_referencia_tipo_pallet_caja(codigo_empresa,referencia,tipo_pallet,caja)
		preparado   = f_preparado_referencia_tipo_pallet_caja(codigo_empresa,referencia,tipo_pallet,caja)
		disponible  = stock - reservado - preparado
		
// Lo quito porque no existe la tabla proddiaria_pendiente_comp_res
		
//		select cantidad
//		into   :reservado_produccion
//		from   proddiaria_pendiente_comp_res
//		where  empresa     = :codigo_empresa
//		and    anyo        = :anyo
//		and    contador    = :contador
//		and    linea       = :linea
//		and    articulo    = :articulo
//		and    calidad     = :calidad
//		and    tono        = :tono
//		and    calibre     = :calibre
//		and    tipo_pallet = :tipo_pallet
//		and    caja        = :caja;
		
		if isnull(reservado_produccion) then reservado_produccion = 0
		
		donde = dw_reservas_pendiente_escandallo.insertrow(0)
		dw_reservas_pendiente_escandallo.object.empresa[donde]     = codigo_empresa
		dw_reservas_pendiente_escandallo.object.articulo[donde]    = articulo
		dw_reservas_pendiente_escandallo.object.calidad[donde]     = calidad
		dw_reservas_pendiente_escandallo.object.tono[donde]        = tono
		dw_reservas_pendiente_escandallo.object.calibre[donde]     = calibre
		dw_reservas_pendiente_escandallo.object.tipo_pallet[donde] = tipo_pallet
		dw_reservas_pendiente_escandallo.object.caja[donde]        = caja
		dw_reservas_pendiente_escandallo.object.disponible[donde]  = disponible
		dw_reservas_pendiente_escandallo.object.reservado[donde]   = reservado_produccion
	next
	dw_reservas_pendiente_escandallo.visible = true
	dw_reservas_pendiente_escandallo.setfocus()
else
	messagebox("Atención","Articulo sin stock.")
end if

destroy dw_stock
end subroutine

public function boolean f_actualizar_pendiente_comp (long arg_row);dec     cantidad
//No se utiliza
int     anyo_orden_produccion
long    orden_produccion
string  articulo,asignada_prensa,asignada_esmaltadora,asignado_horno,filtro
boolean bien = true

asignada_prensa      = dw_pendiente_escandallo.object.asignada_prensa[arg_row]
asignada_esmaltadora = dw_pendiente_escandallo.object.asignada_esmaltadora[arg_row]
asignado_horno       = dw_pendiente_escandallo.object.asignado_horno[arg_row]

if asignada_prensa = "S" or asignada_esmaltadora = "S" or asignado_horno = "S" then
	articulo = dw_pendiente_escandallo.object.articulo[arg_row]
	cantidad = dw_pendiente_escandallo.object.cantidad[arg_row]
	anyo_orden_produccion = dw_pendiente.object.anyo_orden_produccion[dw_pendiente.getrow()]
	orden_produccion      = dw_pendiente.object.orden_produccion[dw_pendiente.getrow()]
	dw_produccion.setredraw(false)
	filtro = dw_produccion.object.datawindow.table.filter
	dw_produccion.setfilter("")
	dw_produccion.filter()
	//Proceso para buscar las lineas que debemos modificar.
	
	//
	dw_produccion.setfilter(filtro)
	dw_produccion.filter()	
	dw_produccion.setredraw(true)
end if

return bien
end function

public subroutine f_mostrar_situacion_articulo_coccion (string arg_articulo, integer arg_coccion, integer arg_anyo_orden_produccion, long arg_orden_produccion);string   filtro,v_seleccion,linea
long     indice,total,donde,ande
datetime fecha,hora

dw_array[tab_1.SelectedTab].setredraw(false)
filtro = dw_produccion.object.datawindow.table.filter
dw_produccion.setfilter("")
dw_produccion.filter()

dw_situacion_articulo.visible = false
dw_situacion_articulo.retrieve(codigo_empresa)

//Proceso para buscar las lineas
v_seleccion = "articulo = '"+arg_articulo+"' and coccion = "+string(arg_coccion,"#0")+" "+&
				"and anyo_orden_produccion = "+string(arg_anyo_orden_produccion,"###0")+" "+&
				"and orden_produccion = "+string(arg_orden_produccion,"########0")
	
indice = 1
total  = dw_produccion.rowcount()
do
	donde = dw_produccion.find(v_seleccion,indice,total)
	if donde > 0 then
		indice = donde +1
		linea  = dw_produccion.object.linea[donde]
		fecha  = dw_produccion.object.fecha[donde]
		hora   = dw_produccion.object.hora_comienzo[donde]
				
		ande = dw_situacion_articulo.insertrow(0)
		dw_situacion_articulo.object.empresa[ande] = codigo_empresa
		dw_situacion_articulo.object.linea[ande]   = linea
		dw_situacion_articulo.object.dia[ande]     = fecha
		dw_situacion_articulo.object.hora[ande]    = hora		
	end if
loop while donde > 0 and indice <= total

if dw_situacion_articulo.rowcount() > 0 then
	dw_situacion_articulo.visible = true
end if
//
dw_produccion.setfilter(filtro)
dw_produccion.filter()	
dw_array[tab_1.SelectedTab].setredraw(true)
end subroutine

on wi_mant_prod_diaria_nueva.create
int iCurrent
call super::create
this.cb_aceptar=create cb_aceptar
this.cb_cancelar=create cb_cancelar
this.pb_1=create pb_1
this.dw_listado=create dw_listado
this.pb_2=create pb_2
this.gb_7=create gb_7
this.gb_6=create gb_6
this.gb_2=create gb_2
this.gb_1=create gb_1
this.em_fechadesde=create em_fechadesde
this.cb_listar=create cb_listar
this.em_nueva_fecha=create em_nueva_fecha
this.em_fechahasta=create em_fechahasta
this.dw_tonos=create dw_tonos
this.st_2=create st_2
this.dw_produccion=create dw_produccion
this.st_1=create st_1
this.p_rayas=create p_rayas
this.tab_1=create tab_1
this.dw_pendiente_escandallo=create dw_pendiente_escandallo
this.dw_pendiente=create dw_pendiente
this.dw_reservas_pendiente_escandallo=create dw_reservas_pendiente_escandallo
this.dw_situacion_articulo=create dw_situacion_articulo
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.cb_aceptar
this.Control[iCurrent+2]=this.cb_cancelar
this.Control[iCurrent+3]=this.pb_1
this.Control[iCurrent+4]=this.dw_listado
this.Control[iCurrent+5]=this.pb_2
this.Control[iCurrent+6]=this.gb_7
this.Control[iCurrent+7]=this.gb_6
this.Control[iCurrent+8]=this.gb_2
this.Control[iCurrent+9]=this.gb_1
this.Control[iCurrent+10]=this.em_fechadesde
this.Control[iCurrent+11]=this.cb_listar
this.Control[iCurrent+12]=this.em_nueva_fecha
this.Control[iCurrent+13]=this.em_fechahasta
this.Control[iCurrent+14]=this.dw_tonos
this.Control[iCurrent+15]=this.st_2
this.Control[iCurrent+16]=this.dw_produccion
this.Control[iCurrent+17]=this.st_1
this.Control[iCurrent+18]=this.p_rayas
this.Control[iCurrent+19]=this.tab_1
this.Control[iCurrent+20]=this.dw_pendiente_escandallo
this.Control[iCurrent+21]=this.dw_pendiente
this.Control[iCurrent+22]=this.dw_reservas_pendiente_escandallo
this.Control[iCurrent+23]=this.dw_situacion_articulo
end on

on wi_mant_prod_diaria_nueva.destroy
call super::destroy
if IsValid(MenuID) then destroy(MenuID)
destroy(this.cb_aceptar)
destroy(this.cb_cancelar)
destroy(this.pb_1)
destroy(this.dw_listado)
destroy(this.pb_2)
destroy(this.gb_7)
destroy(this.gb_6)
destroy(this.gb_2)
destroy(this.gb_1)
destroy(this.em_fechadesde)
destroy(this.cb_listar)
destroy(this.em_nueva_fecha)
destroy(this.em_fechahasta)
destroy(this.dw_tonos)
destroy(this.st_2)
destroy(this.dw_produccion)
destroy(this.st_1)
destroy(this.p_rayas)
destroy(this.tab_1)
destroy(this.dw_pendiente_escandallo)
destroy(this.dw_pendiente)
destroy(this.dw_reservas_pendiente_escandallo)
destroy(this.dw_situacion_articulo)
end on

event open;call super::open;this.title = "Mantenimiento Producción Diaria"

dw_listado.settransobject(sqlca)
dw_tonos.settransobject(sqlca)
dw_pendiente.settransobject(sqlca)
dw_pendiente_escandallo.settransobject(sqlca)
dw_reservas_pendiente_escandallo.settransobject(sqlca)
dw_situacion_articulo.settransobject(sqlca)

tab_1.visible = false
f_borrar_lin_proddiaria()
f_valores_datawindows(codigo_empresa)

dw_produccion.visible = false
dw_situacion_articulo.visible = false

end event

event closequery;if bloqueando then
	if messagebox("Aviso de cierre","Se estaba modificando la producción diaria.~n¿desea usted cerrar la ventana?",Question!,YesNo!,2) = 1 then
		f_desbloquear("proddiaria",codigo_empresa,"Mantenimiento Producción Diaria")
		commit Using SQLCA;
		bloqueando = false
	else
		return 1
	end if
end if
end event

type ole_cont_pro from w_int_con_empresa`ole_cont_pro within wi_mant_prod_diaria_nueva
integer taborder = 10
end type

type sle_opcion_orden from w_int_con_empresa`sle_opcion_orden within wi_mant_prod_diaria_nueva
end type

type st_empresa from w_int_con_empresa`st_empresa within wi_mant_prod_diaria_nueva
integer x = 9
integer y = 36
integer width = 1093
end type

type cb_aceptar from u_boton within wi_mant_prod_diaria_nueva
integer x = 2295
integer y = 40
integer height = 92
integer taborder = 90
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
boolean enabled = false
string text = "&Aceptar"
end type

event clicked;long indice

cb_aceptar.enabled    = false
cb_cancelar.enabled   = false
em_fechahasta.enabled = true
em_fechadesde.enabled = true
cb_listar.enabled     = true
p_rayas.visible       = true
st_1.visible          = true
tab_1.visible         = false

dw_produccion.setfilter("")
dw_produccion.filter()
dw_produccion.AcceptText()
dw_pendiente.setfilter("")
dw_pendiente.filter()
dw_pendiente_escandallo.setfilter("")
dw_pendiente_escandallo.filter()

//dw_produccion.update()
//commit;
dw_produccion.setredraw(false)
dw_produccion.sort()
dw_produccion.groupcalc()

for indice = 1 to 15
	if not(isnull(array_lineas[indice])) and trim(array_lineas[indice]) <> "" then
		if array_lineas_modificadas[indice] then
			dw_produccion.setfilter("linea = '"+array_lineas[indice]+"'")
			dw_produccion.filter()
			if dw_produccion.rowcount() > 0 then
				st_1.text = "Recalculando La Producción "+f_nombre_linea_abr(codigo_empresa,array_lineas[indice])
				f_recalculo_produccion()
				f_actualizar_datos()
			end if
		end if
	end if
next
st_1.text = "Actualizando La Producción"
dw_produccion.setfilter("")
dw_produccion.filter()

if f_grabar_produccion() then
	if dw_pendiente.update() = -1 then
		rollback;
		messagebox("Error","El proceso no se actualiza")
	else
		if dw_pendiente_escandallo.update() = -1 then
			rollback;
			messagebox("Error","El proceso no se actualiza")
		else
			commit;		
		end if
	end if
else
	rollback;
	messagebox("Error","El proceso no se actualiza")
end if

dw_produccion.sort()
dw_produccion.groupcalc()
dw_produccion.setredraw(true)

st_1.visible = false
p_rayas.visible = false

if bloqueando then
	f_desbloquear("proddiaria",codigo_empresa,"Mantenimiento Producción Diaria")
	commit Using SQLCA;
	bloqueando = false
end if

cb_listar.triggerevent(clicked!)
end event

type cb_cancelar from u_boton within wi_mant_prod_diaria_nueva
integer x = 2702
integer y = 40
integer height = 92
integer taborder = 110
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
boolean enabled = false
string text = "&Cancelar"
end type

event clicked;cb_aceptar.enabled    = false
cb_cancelar.enabled   = false
em_fechahasta.enabled = true
em_fechadesde.enabled = true
cb_listar.enabled     = true

if bloqueando then
	f_desbloquear("proddiaria",codigo_empresa,"Mantenimiento Producción Diaria")
	commit Using SQLCA;
	bloqueando = false
end if

cb_listar.triggerevent(clicked!)


end event

type pb_1 from upb_salir within wi_mant_prod_diaria_nueva
integer x = 3470
integer y = 40
integer width = 110
integer height = 96
integer taborder = 160
boolean bringtotop = true
end type

type dw_listado from datawindow within wi_mant_prod_diaria_nueva
boolean visible = false
integer x = 9
integer y = 92
integer width = 494
integer height = 360
integer taborder = 150
boolean bringtotop = true
string dataobject = "report_mant_prod_diaria_n"
boolean livescroll = true
end type

type pb_2 from upb_imprimir within wi_mant_prod_diaria_nueva
integer x = 3182
integer y = 40
integer width = 105
integer taborder = 130
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
boolean originalsize = false
string picturename = "print!"
end type

event clicked;date fecha


if em_fechadesde.text ="" then
	f_activar_campo(em_fechadesde)
else	
	dw_listado.retrieve(codigo_empresa,date(em_fechadesde.text))
//		fecha = date(em_fechadesde.text)
	if f_imprimir_datawindow(dw_listado) then
//			update proddiaria set impresa = "S"
//			where empresa = :uo_empresa.em_codigo.text
//			and fecha >= :fecha ;
	end if
end if



end event

type gb_7 from groupbox within wi_mant_prod_diaria_nueva
integer x = 2281
integer width = 841
integer height = 144
integer taborder = 170
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
borderstyle borderstyle = styleraised!
end type

type gb_6 from groupbox within wi_mant_prod_diaria_nueva
integer x = 1915
integer width = 320
integer height = 144
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
end type

type gb_2 from groupbox within wi_mant_prod_diaria_nueva
integer x = 1545
integer width = 370
integer height = 144
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "Fecha Activa"
end type

type gb_1 from groupbox within wi_mant_prod_diaria_nueva
integer x = 1175
integer width = 370
integer height = 144
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Desde "
end type

type em_fechadesde from u_em_campo within wi_mant_prod_diaria_nueva
integer x = 1189
integer y = 52
integer width = 320
integer height = 76
integer taborder = 30
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
long backcolor = 16777215
alignment alignment = center!
maskdatatype maskdatatype = datemask!
string mask = "dd-mm-yy"
end type

type cb_listar from commandbutton within wi_mant_prod_diaria_nueva
integer x = 1929
integer y = 40
integer width = 293
integer height = 92
integer taborder = 40
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Consultar"
end type

event clicked;long indice

for indice = 1 to 15
	array_lineas_modificadas[indice] = false
next

tab_1.visible = false
if em_fechadesde.text = "00-00-00" then
	f_activar_campo(em_fechadesde)
else	
	dw_produccion.setfilter("")
	dw_produccion.retrieve(codigo_empresa,date(em_fechadesde.text))	
	dw_pendiente.setfilter("")
	dw_pendiente.retrieve(codigo_empresa)	
	dw_pendiente_escandallo.retrieve(codigo_empresa)
	if dw_produccion.rowcount()> 0 then
		if pagina_seleccionada = 0 then
			pagina_seleccionada = 1
		end if
		tab_1.SelectTab(pagina_seleccionada)
		linea_activa = array_lineas[pagina_seleccionada]			
		dw_produccion.setfilter("linea = '"+linea_activa+"'")
		dw_produccion.filter()		
		filtro_formatos_linea = f_filtro_formatos_linea(codigo_empresa,linea_activa) 
		dw_pendiente.setfilter(filtro_formatos_linea)
		dw_pendiente.filter()
		if dw_pendiente.rowcount() > 0 then
			dw_pendiente.setrow(1)
			dw_pendiente.selectrow(1,true)
			dw_pendiente.event rowfocuschanged(1)
		end if
		if dw_array[pagina_seleccionada].rowcount() > 0 then
			dw_array[pagina_seleccionada].setrow(dw_array[pagina_seleccionada].rowcount())
			dw_array[pagina_seleccionada].scrolltorow(dw_array[pagina_seleccionada].rowcount())
			posicion_dw_array[pagina_seleccionada] = dw_array[pagina_seleccionada].rowcount()
		end if			
	else
		em_nueva_fecha.text = em_fechadesde.text
	end if
	tab_1.visible = true
end if

end event

type em_nueva_fecha from u_em_campo within wi_mant_prod_diaria_nueva
integer x = 1559
integer y = 52
integer width = 320
integer height = 76
integer taborder = 50
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
long backcolor = 16777215
alignment alignment = center!
maskdatatype maskdatatype = datemask!
string mask = "dd-mm-yy"
end type

event tecla_tabulador;call super::tecla_tabulador;int res

if date(this.text) >= date(em_fechadesde.text) then
	dw_produccion.triggerevent("clicked(0,0,0,cb_anyadir)")
else
	res = messagebox("Error","La fecha introducida no esta en el rango seleccionado~n"+&
				  "¿Desea modificar el rango?",question!,yesno!,1)
	if res = 1 then
		if cb_aceptar.enabled then
			res = messagebox("Atención","¿Desea actualizar los cambios realizados?",question!,yesno!,1)
			if res =1 then
				cb_aceptar.triggerevent("cliked")
			else
				cb_cancelar.triggerevent("cliked")
			end if
		end if
		this.text=""
//		em_fechahasta.enabled = true
		em_fechadesde.enabled = true
		setfocus(em_fechadesde)
	else
		this.text = ""
		setfocus(this)
	end if
end if
end event

type em_fechahasta from u_em_campo within wi_mant_prod_diaria_nueva
boolean visible = false
integer x = 2240
integer y = 152
integer width = 320
integer taborder = 60
boolean bringtotop = true
long backcolor = 16777215
alignment alignment = center!
maskdatatype maskdatatype = datemask!
string mask = "dd-mm-yy"
end type

type dw_tonos from datawindow within wi_mant_prod_diaria_nueva
boolean visible = false
integer x = 928
integer y = 344
integer width = 709
integer height = 492
integer taborder = 20
boolean bringtotop = true
boolean titlebar = true
string title = "Historico de Tonos"
string dataobject = "dw_con_historico_tonos"
boolean livescroll = true
end type

event doubleclicked;this.visible = false
dw_produccion.setfocus()
end event

type st_2 from statictext within wi_mant_prod_diaria_nueva
boolean visible = false
integer x = 1783
integer y = 72
integer width = 315
integer height = 36
boolean bringtotop = true
integer textsize = -7
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 79741120
boolean enabled = false
string text = "Pakito 22/03/00"
boolean focusrectangle = false
end type

type dw_produccion from u_datawindow within wi_mant_prod_diaria_nueva
integer x = 1106
integer y = 8
integer width = 59
integer height = 52
integer taborder = 70
string dragicon = "\bmp\arrastrar.ico"
boolean bringtotop = true
string dataobject = "dw_mant_prod_diaria_n"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;long maxi,i,num,donde,indice1,total1,posicion
long orden_produccion,contador
int  orden_anterior,orden_auxiliar,orden,anyo_orden,anyo,coccion
datetime fecha_grupo,fecha_auxiliar
string nueva_fecha,linea,sel,articulo
string tipo_linea

if not(bloqueando) then
	if not f_bloquear("proddiaria",codigo_empresa,"Mantenimiento Producción Diaria") then
      commit Using SQLCA;
		bloqueando = true
		cb_aceptar.enabled    = true
		cb_cancelar.enabled   = true
		em_fechahasta.enabled = false
		em_fechadesde.enabled = false
		cb_listar.enabled     = false		
	else
		// problema concurrencia
		st_empresa.setfocus()
	end if
end if

if bloqueando then
	
	//choose case f_objeto_datawindow(this) 
	choose case dwo.name
		case "cb_borrar"
				indice1 = this.getrow()
				if indice1 > 0 then
					if messagebox("Confirmación","¿Desea borrar la linea seleccionada?",Question!,YesNo!,2) = 1 then
						fecha_grupo = this.getitemdatetime(indice1,"fecha")
						
						total1 = this.rowcount()
						fecha_auxiliar = fecha_grupo
						do until indice1 > total1 or fecha_grupo <> fecha_auxiliar
							fecha_auxiliar = this.getitemdatetime(indice1,"fecha")
							orden_auxiliar = this.getitemnumber(indice1,"orden")
							this.setitem(indice1,"orden",orden_auxiliar - 1)
							indice1 = indice1 +1
						loop
						
						indice1 = this.getrow()
						
						tipo_linea       = f_tipo_linea(codigo_empresa,linea_activa)
						orden_produccion = this.object.orden_produccion[indice1]
						anyo_orden       = this.object.anyo_orden_produccion[indice1]
						articulo         = this.object.articulo[indice1]
						coccion          = this.object.coccion[indice1]
						sel = "anyo_orden_produccion = "+string(anyo_orden,"####")
						sel = sel + " and orden_produccion = "+string(orden_produccion,"########")
						donde = dw_pendiente.find(sel,1,dw_pendiente.rowcount())
						if donde > 0 then
							dw_pendiente.setrow(donde)
							dw_pendiente.selectrow(0,false)
							dw_pendiente.selectrow(1,true)
							anyo     = dw_pendiente.object.anyo[donde]
							contador = dw_pendiente.object.contador[donde]
							dw_pendiente_escandallo.setfilter("anyo = "+string(anyo,"####")+" and contador = "+&
																		 string(contador,"########"))
							dw_pendiente_escandallo.filter()			
							if dw_pendiente.object.articulo[donde] = articulo and coccion = 0 then
								choose case tipo_linea
									case "P"
										dw_pendiente.object.asignada_prensa[donde] = "N"
									case "E"
										dw_pendiente.object.asignada_esmaltadora[donde] = "N"						
									case "H"
										dw_pendiente.object.asignado_horno[donde] = "N"						
								end choose							
							else
								sel = "articulo = '"+articulo+"' and coccion = "+string(coccion,"#0")
								
								donde = dw_pendiente_escandallo.find(sel,1,dw_pendiente_escandallo.rowcount())
								if donde > 0 then
									dw_pendiente_escandallo.setrow(donde)
									dw_pendiente_escandallo.selectrow(0,false)
									dw_pendiente_escandallo.selectrow(1,true)								
									choose case tipo_linea
										case "P"
											dw_pendiente_escandallo.object.asignada_prensa[donde] = "N"
										case "E"
											dw_pendiente_escandallo.object.asignada_esmaltadora[donde] = "N"						
										case "H"
											dw_pendiente_escandallo.object.asignado_horno[donde] = "N"						
									end choose															
								end if
							end if
						end if					
						
						this.DeleteRow(indice1)
						if indice1 > 1 then
							dw_array[tab_1.SelectedTab].Setrow(indice1 -1)
						end if
					end if
				end if
		case else
			if row > 0 then
				this.setrow(row)
				//drag(begin!)
			end if			
	end choose
	
	call super::clicked
	
	if row > 0 then
		this.selectrow(0,false)
		this.selectrow(row,true)
	end if	
end if
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = ""
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

event rbuttondown;string articulo,linea
int    anyo_orden
dec    orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = This.GetColumnName()
valor_empresa = TRUE
CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 				
	CASE "tono"
		SetNull(bus_campo)		
		articulo = this.object.articulo[row]
		dw_tonos.retrieve(codigo_empresa,articulo)
		if dw_tonos.rowcount() > 0 then
			dw_tonos.x = xpos * 2
			dw_tonos.y = ypos * 2
			dw_tonos.visible = true
			dw_tonos.setfocus()
		else
			messagebox("Atención","Articulo sin historico de tonos")
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if		
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

event rowfocuschanged;call super::rowfocuschanged;if this.rowcount() > 0 then
	if currentrow > 0 then
		if not(isnull(this.getitemdatetime(currentrow,"fecha"))) then
			em_nueva_fecha.text = string(this.getitemdatetime(currentrow,"fecha"),"dd/mm/yy")
		end if
	end if
end if
end event

event itemfocuschanged;call super::itemfocuschanged;long pos
string columna
this.accepttext()
columna = this.GetColumnName( )

if columna = "cantidad" then
	if not (date(this.getitemdatetime(row,"fecha")) >= date(em_fechadesde.text)) then
		messagebox("Atención","La fecha "+string(this.getitemdatetime(row,"fecha"),"dd/mm/yy")+"~nno está dentro del rango permitido")
		this.setcolumn("fecha")
	end if
end if
end event

event doubleclicked;//string v_articulo
//str_parametros lstr_param
//if row > 0 then
//	v_articulo = this.getitemstring(row,"articulo")
//	if not (IsNull(v_articulo)) or not(v_articulo = "") then
//		lstr_param.i_nargumentos    = 2
//		lstr_param.s_argumentos[2]= v_articulo
//		OpenWithParm(wi_mant_proddetartic, lstr_param)
//	end if
//end if
end event

event getfocus;dw_tonos.visible = false
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int valido_formato,cajas,tipos_pallet
string formato,columna,caja,tipo_pallet

columna = dwo.Name

if columna = "articulo" then
	formato = f_formato_articulo(codigo_empresa,data)
	if isnull(formato) then formato = ""
	if trim(formato) <> "" then
		select count(*)
		into   :valido_formato
		from   prodmetroshoralinea
		where  empresa = :codigo_empresa
		and    linea   = :linea_activa
		and    formato = :formato;
		
		if isnull(valido_formato) then valido_formato = 0
		
		if valido_formato = 0 then
			messagebox("Atención","El formato del articulo no es valido para esta linea de producción.")		
			return 2	
		else
			return 0					
		end if
	end if
else
	if columna = "hora" then		
		this.object.respetar_hora_comienzo[row] = "S"
		if isnull(data) then
			this.object.hora_comienzo[row] = datetime(date(this.object.fecha[row]),time(0,0,0))
		else
			this.object.hora_comienzo[row] = datetime(date(this.object.fecha[row]),time(mid(data,12,5)))
		end if
	end if
end if
end event

event dragdrop;long     donde,indice1,total1,orden_auxiliar,orden
long     anyo,contador,linea
int      anyo_orden_produccion,orden_produccion
datetime fecha_grupo,fecha_auxiliar,nueva_fecha
string   tipo_linea
dec      reservado

tipo_linea = f_tipo_linea(codigo_empresa,linea_activa)

//Soltamos el objeto
DataWindow origen
if source <> this then
	IF source.TypeOf() = DataWindow! THEN
		origen = source
		if row > 0 then
			donde = row
			fecha_grupo = getitemdatetime(row,"fecha")
			if not(isnull(fecha_grupo) or year(date(fecha_grupo)) = 1900) then
				orden = this.getitemnumber(donde,"orden")
				if this.object.marca[row] = "I" then
					donde = row +1
					orden = orden +1
				end if								
				indice1 = donde
				total1 = this.rowcount()
				fecha_auxiliar = fecha_grupo
				do until indice1 > total1 or fecha_grupo <> fecha_auxiliar
					fecha_auxiliar = this.getitemdatetime(indice1,"fecha")
					orden_auxiliar = this.getitemnumber(indice1,"orden")
					this.setitem(indice1,"orden",orden_auxiliar + 1)
					indice1 = indice1 +1
				loop

				donde = this.InsertRow(donde)
				this.SetItem(donde,"empresa",origen.object.empresa[origen.getrow()])
				this.SetItem(donde,"f_entrada",dw_pendiente.object.f_entrada[dw_pendiente.getrow()])
				this.SetItem(donde,"linea", linea_activa)
				//this.SetItem(donde,"fabricado","N")		
				this.SetItem(donde,"impresa","N")
				this.SetItem(donde,"fecha",fecha_grupo)
				this.SetItem(donde,"hora_comienzo",fecha_grupo)
				this.SetItem(donde,"orden",orden)
				anyo_orden_produccion = dw_pendiente.object.anyo_orden_produccion[dw_pendiente.getrow()]
				orden_produccion      = dw_pendiente.object.orden_produccion[dw_pendiente.getrow()]
				if isnull(orden_produccion) or orden_produccion = 0 then
					anyo_orden_produccion = year(Date(fecha_grupo))
					orden_produccion 		 = f_numero_orden_linea(codigo_empresa,"",anyo_orden_produccion)
					dw_pendiente.object.anyo_orden_produccion[dw_pendiente.getrow()] = anyo_orden_produccion
					dw_pendiente.object.orden_produccion[dw_pendiente.getrow()]      = orden_produccion
				end if
				this.SetItem(donde,"anyo_orden_produccion",anyo_orden_produccion)
				this.SetItem(donde,"orden_produccion",orden_produccion)
				this.object.articulo[donde]         = origen.object.articulo[origen.getrow()]
				this.object.familia[donde]          = origen.object.familia[origen.getrow()]
				this.object.formato[donde]          = origen.object.formato[origen.getrow()]							
				this.object.unidad[donde]           = origen.object.unidad[origen.getrow()]			
				this.object.coccion[donde]          = origen.object.coccion[origen.getrow()]
				
				if origen = dw_pendiente_escandallo then					
					anyo     = origen.object.anyo[origen.getrow()]
					contador = origen.object.contador[origen.getrow()]
					linea    = origen.object.linea[origen.getrow()]					
					
					select cantidad
					into   :reservado
					from   proddiaria_pendiente_comp_res
					where  empresa     = :codigo_empresa
					and    anyo        = :anyo
					and    contador    = :contador
					and    linea       = :linea;
					
					if isnull(reservado) then reservado = 0										
				else
					reservado = 0
				end if
				
				choose case tipo_linea
					case "P"
						this.object.cantidad[donde] = origen.object.cantidad_prensa[origen.getrow()] - reservado
						origen.object.asignada_prensa[origen.getrow()] = "S"
					case "E"
						this.object.cantidad[donde] = origen.object.cantidad_esmaltadora[origen.getrow()] - reservado
						origen.object.asignada_esmaltadora[origen.getrow()] = "S"						
					case "H"
						this.object.cantidad[donde] = origen.object.cantidad_horno[origen.getrow()] - reservado
						origen.object.asignado_horno[origen.getrow()] = "S"						
				end choose
				this.accepttext()
				this.groupcalc()
				dw_array[tab_1.SelectedTab].setrow(donde)
				dw_array[tab_1.SelectedTab].Scrolltorow(donde)								
//				this.sort()
//				this.groupcalc()			
			end if
		else			
			if isnull(date(em_nueva_fecha.text)) or year(date(em_nueva_fecha.text)) = 1900 then
				messagebox("Atención","Introduzca la fecha de la orden de producción")
				setfocus(em_nueva_fecha)
			else
				nueva_fecha = datetime(date(em_nueva_fecha.text))
				/////////				
				
				total1 = this.rowcount()
				if total1 > 0 then
					orden = 0
					for indice1 = 1 to total1
						fecha_grupo = getitemdatetime(indice1,"fecha")
						if fecha_grupo = nueva_fecha then
							if orden < this.getitemnumber(indice1,"orden") then
								orden = this.getitemnumber(indice1,"orden")
							end if
						end if
					next
					
				else
					orden = 0
				end if
				orden ++
				/////////
				donde = this.InsertRow(0)
				this.SetItem(donde,"empresa",origen.object.empresa[origen.getrow()])
				this.SetItem(donde,"f_entrada",dw_pendiente.object.f_entrada[dw_pendiente.getrow()])
				this.SetItem(donde,"linea", linea_activa)
				//this.SetItem(donde,"fabricado","N")		
				this.SetItem(donde,"impresa","N")
				this.SetItem(donde,"fecha",nueva_fecha)
				this.SetItem(donde,"hora_comienzo",nueva_fecha)
				this.SetItem(donde,"orden",orden)
				anyo_orden_produccion = dw_pendiente.object.anyo_orden_produccion[dw_pendiente.getrow()]
				orden_produccion      = dw_pendiente.object.orden_produccion[dw_pendiente.getrow()]
				if isnull(orden_produccion) or orden_produccion = 0 then
					anyo_orden_produccion = year(Date(nueva_fecha))
					orden_produccion 		 = f_numero_orden_linea(codigo_empresa,"",anyo_orden_produccion)
					dw_pendiente.object.anyo_orden_produccion[dw_pendiente.getrow()] = anyo_orden_produccion
					dw_pendiente.object.orden_produccion[dw_pendiente.getrow()]      = orden_produccion
				end if				
				this.SetItem(donde,"anyo_orden_produccion",anyo_orden_produccion)
				this.SetItem(donde,"orden_produccion",orden_produccion)
				this.object.articulo[donde]         = origen.object.articulo[origen.getrow()]
				this.object.familia[donde]          = origen.object.familia[origen.getrow()]
				this.object.formato[donde]          = origen.object.formato[origen.getrow()]
				this.object.unidad[donde]           = origen.object.unidad[origen.getrow()]			
				this.object.coccion[donde]          = origen.object.coccion[origen.getrow()]
				if origen = dw_pendiente_escandallo then
					anyo     = origen.object.anyo[origen.getrow()]
					contador = origen.object.contador[origen.getrow()]
					linea    = origen.object.linea[origen.getrow()]					
					
					select cantidad
					into   :reservado
					from   proddiaria_pendiente_comp_res
					where  empresa     = :codigo_empresa
					and    anyo        = :anyo
					and    contador    = :contador
					and    linea       = :linea;
					
					if isnull(reservado) then reservado = 0										
				else
					reservado = 0
				end if
				
				choose case tipo_linea
					case "P"
						this.object.cantidad[donde] = origen.object.cantidad_prensa[origen.getrow()] - reservado
						origen.object.asignada_prensa[origen.getrow()] = "S"
					case "E"
						this.object.cantidad[donde] = origen.object.cantidad_esmaltadora[origen.getrow()] - reservado
						origen.object.asignada_esmaltadora[origen.getrow()] = "S"						
					case "H"
						this.object.cantidad[donde] = origen.object.cantidad_horno[origen.getrow()] - reservado
						origen.object.asignado_horno[origen.getrow()] = "S"						
				end choose
				this.accepttext()
				this.groupcalc()
				dw_array[tab_1.SelectedTab].setrow(donde)
				dw_array[tab_1.SelectedTab].Scrolltorow(donde)								
//				this.sort()
//				this.groupcalc()				
			end if						
		end if				
	END IF
end if
end event

type st_1 from statictext within wi_mant_prod_diaria_nueva
boolean visible = false
integer x = 837
integer y = 544
integer width = 2235
integer height = 584
boolean bringtotop = true
integer textsize = -48
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "AudreyTwo SWC"
boolean italic = true
string pointer = "HourGlass!"
long textcolor = 8388608
long backcolor = 16777215
boolean enabled = false
string text = "Recalculando La Producción"
alignment alignment = center!
boolean focusrectangle = false
boolean righttoleft = true
end type

type p_rayas from picture within wi_mant_prod_diaria_nueva
boolean visible = false
integer y = 288
integer width = 3589
integer height = 1764
string picturename = "c:\bmp\rayas.bmp"
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type tab_1 from tab within wi_mant_prod_diaria_nueva
integer y = 144
integer width = 3584
integer height = 1144
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean raggedright = true
boolean createondemand = true
integer selectedtab = 1
tabpage_1 tabpage_1
tabpage_2 tabpage_2
tabpage_3 tabpage_3
tabpage_4 tabpage_4
tabpage_5 tabpage_5
tabpage_6 tabpage_6
tabpage_7 tabpage_7
tabpage_8 tabpage_8
tabpage_9 tabpage_9
tabpage_10 tabpage_10
tabpage_11 tabpage_11
tabpage_12 tabpage_12
tabpage_13 tabpage_13
tabpage_14 tabpage_14
tabpage_15 tabpage_15
end type

on tab_1.create
this.tabpage_1=create tabpage_1
this.tabpage_2=create tabpage_2
this.tabpage_3=create tabpage_3
this.tabpage_4=create tabpage_4
this.tabpage_5=create tabpage_5
this.tabpage_6=create tabpage_6
this.tabpage_7=create tabpage_7
this.tabpage_8=create tabpage_8
this.tabpage_9=create tabpage_9
this.tabpage_10=create tabpage_10
this.tabpage_11=create tabpage_11
this.tabpage_12=create tabpage_12
this.tabpage_13=create tabpage_13
this.tabpage_14=create tabpage_14
this.tabpage_15=create tabpage_15
this.Control[]={this.tabpage_1,&
this.tabpage_2,&
this.tabpage_3,&
this.tabpage_4,&
this.tabpage_5,&
this.tabpage_6,&
this.tabpage_7,&
this.tabpage_8,&
this.tabpage_9,&
this.tabpage_10,&
this.tabpage_11,&
this.tabpage_12,&
this.tabpage_13,&
this.tabpage_14,&
this.tabpage_15}
end on

on tab_1.destroy
destroy(this.tabpage_1)
destroy(this.tabpage_2)
destroy(this.tabpage_3)
destroy(this.tabpage_4)
destroy(this.tabpage_5)
destroy(this.tabpage_6)
destroy(this.tabpage_7)
destroy(this.tabpage_8)
destroy(this.tabpage_9)
destroy(this.tabpage_10)
destroy(this.tabpage_11)
destroy(this.tabpage_12)
destroy(this.tabpage_13)
destroy(this.tabpage_14)
destroy(this.tabpage_15)
end on

event selectionchanged;string articulo_marcado
long   donde

pagina_seleccionada = newindex
linea_activa = array_lineas[newindex]
dw_produccion.setfilter("linea = '"+linea_activa+"'")
dw_produccion.filter()
filtro_formatos_linea = f_filtro_formatos_linea(codigo_empresa,linea_activa) 
if dw_pendiente.getrow() > 0 then
	articulo_marcado = dw_pendiente.object.articulo[dw_pendiente.getrow()]
else
	articulo_marcado = ""
end if
dw_pendiente.setfilter(filtro_formatos_linea)
dw_pendiente.filter()
if dw_pendiente.rowcount() > 0 then
	donde = dw_pendiente.find("articulo = '"+articulo_marcado+"'",1,dw_pendiente.rowcount())
	if donde = 0 then
		donde = 1
	end if
	dw_pendiente.scrolltorow(donde)
	dw_pendiente.setrow(donde)
	dw_pendiente.selectrow(0,false)
	dw_pendiente.selectrow(donde,true)
	dw_pendiente.event rowfocuschanged(donde)
else
	dw_pendiente_escandallo.setfilter("contador = 0")
	dw_pendiente_escandallo.filter()
end if

if posicion_dw_array[newindex] > 0 then
	if dw_array[newindex].rowcount() >= posicion_dw_array[newindex] then
		dw_array[newindex].setrow(posicion_dw_array[newindex])
		dw_array[newindex].scrolltorow(posicion_dw_array[newindex])
		dw_array[newindex].triggerevent(rowfocuschanged!)
	else
		if dw_array[newindex].rowcount() > 0 then
			posicion_dw_array[newindex] = dw_array[newindex].rowcount()
			dw_array[newindex].setrow(posicion_dw_array[newindex])
			dw_array[newindex].scrolltorow(posicion_dw_array[newindex])			
			dw_array[newindex].triggerevent(rowfocuschanged!)
		else
			posicion_dw_array[newindex] = 0
		end if
	end if
else
	if dw_array[newindex].rowcount() > 0 then
		posicion_dw_array[newindex] = dw_array[newindex].rowcount()
		dw_array[newindex].setrow(posicion_dw_array[newindex])
		dw_array[newindex].scrolltorow(posicion_dw_array[newindex])			
		dw_array[newindex].triggerevent(rowfocuschanged!)
	end if	
end if

end event

type tabpage_1 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "1"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_1 dw_1
end type

on tabpage_1.create
this.dw_1=create dw_1
this.Control[]={this.dw_1}
end on

on tabpage_1.destroy
destroy(this.dw_1)
end on

type dw_1 from u_datawindow within tabpage_1
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 90
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event getfocus;dw_produccion.event getfocus()
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

event rbuttondown;call super::rbuttondown;//dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
string articulo,linea
int    anyo_orden
dec    orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = This.GetColumnName()
valor_empresa = TRUE
CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 				
	CASE "tono"
		SetNull(bus_campo)		
		articulo = this.object.articulo[row]
		dw_tonos.retrieve(codigo_empresa,articulo)
		if dw_tonos.rowcount() > 0 then
			dw_tonos.x = xpos * 2
			dw_tonos.y = ypos * 2
			dw_tonos.visible = true
			dw_tonos.setfocus()
		else
			messagebox("Atención","Articulo sin historico de tonos")
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if		
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

type tabpage_2 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "2"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_2 dw_2
end type

on tabpage_2.create
this.dw_2=create dw_2
this.Control[]={this.dw_2}
end on

on tabpage_2.destroy
destroy(this.dw_2)
end on

type dw_2 from u_datawindow within tabpage_2
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;//dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
string articulo,linea
int    anyo_orden
dec    orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = This.GetColumnName()
valor_empresa = TRUE
CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 				
	CASE "tono"
		SetNull(bus_campo)		
		articulo = this.object.articulo[row]
		dw_tonos.retrieve(codigo_empresa,articulo)
		if dw_tonos.rowcount() > 0 then
			dw_tonos.x = xpos * 2
			dw_tonos.y = ypos * 2
			dw_tonos.visible = true
			dw_tonos.setfocus()
		else
			messagebox("Atención","Articulo sin historico de tonos")
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if		
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_3 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "3"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_3 dw_3
end type

on tabpage_3.create
this.dw_3=create dw_3
this.Control[]={this.dw_3}
end on

on tabpage_3.destroy
destroy(this.dw_3)
end on

type dw_3 from u_datawindow within tabpage_3
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;//dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
string articulo,linea
int    anyo_orden
dec    orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = This.GetColumnName()
valor_empresa = TRUE
CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 				
	CASE "tono"
		SetNull(bus_campo)		
		articulo = this.object.articulo[row]
		dw_tonos.retrieve(codigo_empresa,articulo)
		if dw_tonos.rowcount() > 0 then
			dw_tonos.x = xpos * 2
			dw_tonos.y = ypos * 2
			dw_tonos.visible = true
			dw_tonos.setfocus()
		else
			messagebox("Atención","Articulo sin historico de tonos")
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if		
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_4 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "4"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_4 dw_4
end type

on tabpage_4.create
this.dw_4=create dw_4
this.Control[]={this.dw_4}
end on

on tabpage_4.destroy
destroy(this.dw_4)
end on

type dw_4 from u_datawindow within tabpage_4
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;//dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
string articulo,linea
int    anyo_orden
dec    orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = This.GetColumnName()
valor_empresa = TRUE
CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 				
	CASE "tono"
		SetNull(bus_campo)		
		articulo = this.object.articulo[row]
		dw_tonos.retrieve(codigo_empresa,articulo)
		if dw_tonos.rowcount() > 0 then
			dw_tonos.x = xpos * 2
			dw_tonos.y = ypos * 2
			dw_tonos.visible = true
			dw_tonos.setfocus()
		else
			messagebox("Atención","Articulo sin historico de tonos")
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if		
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_5 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "5"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_5 dw_5
end type

on tabpage_5.create
this.dw_5=create dw_5
this.Control[]={this.dw_5}
end on

on tabpage_5.destroy
destroy(this.dw_5)
end on

type dw_5 from u_datawindow within tabpage_5
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;//dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
string articulo,linea
int    anyo_orden
dec    orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = This.GetColumnName()
valor_empresa = TRUE
CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 				
	CASE "tono"
		SetNull(bus_campo)		
		articulo = this.object.articulo[row]
		dw_tonos.retrieve(codigo_empresa,articulo)
		if dw_tonos.rowcount() > 0 then
			dw_tonos.x = xpos * 2
			dw_tonos.y = ypos * 2
			dw_tonos.visible = true
			dw_tonos.setfocus()
		else
			messagebox("Atención","Articulo sin historico de tonos")
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if		
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_6 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "6"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_6 dw_6
end type

on tabpage_6.create
this.dw_6=create dw_6
this.Control[]={this.dw_6}
end on

on tabpage_6.destroy
destroy(this.dw_6)
end on

type dw_6 from u_datawindow within tabpage_6
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;//dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
string articulo,linea
int    anyo_orden
dec    orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = This.GetColumnName()
valor_empresa = TRUE
CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 				
	CASE "tono"
		SetNull(bus_campo)		
		articulo = this.object.articulo[row]
		dw_tonos.retrieve(codigo_empresa,articulo)
		if dw_tonos.rowcount() > 0 then
			dw_tonos.x = xpos * 2
			dw_tonos.y = ypos * 2
			dw_tonos.visible = true
			dw_tonos.setfocus()
		else
			messagebox("Atención","Articulo sin historico de tonos")
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if		
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_7 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "7"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_7 dw_7
end type

on tabpage_7.create
this.dw_7=create dw_7
this.Control[]={this.dw_7}
end on

on tabpage_7.destroy
destroy(this.dw_7)
end on

type dw_7 from u_datawindow within tabpage_7
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;//dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
string articulo,linea
int    anyo_orden
dec    orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = This.GetColumnName()
valor_empresa = TRUE
CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 				
	CASE "tono"
		SetNull(bus_campo)		
		articulo = this.object.articulo[row]
		dw_tonos.retrieve(codigo_empresa,articulo)
		if dw_tonos.rowcount() > 0 then
			dw_tonos.x = xpos * 2
			dw_tonos.y = ypos * 2
			dw_tonos.visible = true
			dw_tonos.setfocus()
		else
			messagebox("Atención","Articulo sin historico de tonos")
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if		
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_8 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "8"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_8 dw_8
end type

on tabpage_8.create
this.dw_8=create dw_8
this.Control[]={this.dw_8}
end on

on tabpage_8.destroy
destroy(this.dw_8)
end on

type dw_8 from u_datawindow within tabpage_8
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;//dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
string articulo,linea
int    anyo_orden
dec    orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = This.GetColumnName()
valor_empresa = TRUE
CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 				
	CASE "tono"
		SetNull(bus_campo)		
		articulo = this.object.articulo[row]
		dw_tonos.retrieve(codigo_empresa,articulo)
		if dw_tonos.rowcount() > 0 then
			dw_tonos.x = xpos * 2
			dw_tonos.y = ypos * 2
			dw_tonos.visible = true
			dw_tonos.setfocus()
		else
			messagebox("Atención","Articulo sin historico de tonos")
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if		
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_9 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "9"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_9 dw_9
end type

on tabpage_9.create
this.dw_9=create dw_9
this.Control[]={this.dw_9}
end on

on tabpage_9.destroy
destroy(this.dw_9)
end on

type dw_9 from u_datawindow within tabpage_9
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;//dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
string articulo,linea
int    anyo_orden
dec    orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = This.GetColumnName()
valor_empresa = TRUE
CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 				
	CASE "tono"
		SetNull(bus_campo)		
		articulo = this.object.articulo[row]
		dw_tonos.retrieve(codigo_empresa,articulo)
		if dw_tonos.rowcount() > 0 then
			dw_tonos.x = xpos * 2
			dw_tonos.y = ypos * 2
			dw_tonos.visible = true
			dw_tonos.setfocus()
		else
			messagebox("Atención","Articulo sin historico de tonos")
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if		
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_10 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "10"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_10 dw_10
end type

on tabpage_10.create
this.dw_10=create dw_10
this.Control[]={this.dw_10}
end on

on tabpage_10.destroy
destroy(this.dw_10)
end on

type dw_10 from u_datawindow within tabpage_10
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_11 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "11"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_11 dw_11
end type

on tabpage_11.create
this.dw_11=create dw_11
this.Control[]={this.dw_11}
end on

on tabpage_11.destroy
destroy(this.dw_11)
end on

type dw_11 from u_datawindow within tabpage_11
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_12 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "12"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_12 dw_12
end type

on tabpage_12.create
this.dw_12=create dw_12
this.Control[]={this.dw_12}
end on

on tabpage_12.destroy
destroy(this.dw_12)
end on

type dw_12 from u_datawindow within tabpage_12
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_13 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "13"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_13 dw_13
end type

on tabpage_13.create
this.dw_13=create dw_13
this.Control[]={this.dw_13}
end on

on tabpage_13.destroy
destroy(this.dw_13)
end on

type dw_13 from u_datawindow within tabpage_13
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_14 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "14"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_14 dw_14
end type

on tabpage_14.create
this.dw_14=create dw_14
this.Control[]={this.dw_14}
end on

on tabpage_14.destroy
destroy(this.dw_14)
end on

type dw_14 from u_datawindow within tabpage_14
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type tabpage_15 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 3547
integer height = 1024
long backcolor = 12632256
string text = "15"
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_15 dw_15
end type

on tabpage_15.create
this.dw_15=create dw_15
this.Control[]={this.dw_15}
end on

on tabpage_15.destroy
destroy(this.dw_15)
end on

type dw_15 from u_datawindow within tabpage_15
integer y = 4
integer width = 3547
integer height = 1012
integer taborder = 100
string dragicon = "\bmp\arrastrar.ico"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;array_lineas_modificadas[tab_1.selectedtab] = true
dw_produccion.event clicked(xpos,ypos,this.getrow(),dwo)
end event

event doubleclicked;dw_produccion.event doubleclicked(xpos,ypos,this.getrow(),dwo)
end event

event dragdrop;dw_produccion.event dragdrop(source,row,dwo)
end event

event dragwithin;if row > 0 then
	this.setrow(row)
end if
if row_anterior_arrastre > row then
	if row_anterior_arrastre = this.rowcount() then
		this.object.marca[row_anterior_arrastre] = "I"
		row_anterior_arrastre = this.rowcount() + 1
	else
		if row > 0 then
			this.object.marca[row] = "S"						
			row_anterior_arrastre = row
		end if		
	end if
else
	if row_anterior_arrastre < row then
		this.object.marca[row] = "I"
		row_anterior_arrastre = row
	end if
end if	

end event

event getfocus;dw_produccion.event getfocus()
end event

event itemchanged;//Comprobamos si el formato es valido para la linea
int ret
ret =  dw_produccion.event itemchanged(this.getrow(),dwo,data)

return ret
end event

event itemfocuschanged;call super::itemfocuschanged;dw_produccion.event itemfocuschanged(this.getrow(),dwo)
end event

event rbuttondown;call super::rbuttondown;dw_produccion.event rbuttondown(xpos,ypos,this.getrow(),dwo)
end event

event rowfocuschanged;call super::rowfocuschanged;if dec(this.tag) = tab_1.selectedtab then
	posicion_dw_array[tab_1.selectedtab] = currentrow
end if
dw_produccion.event rowfocuschanged(currentrow)
end event

event key;string articulo,linea
int    anyo_orden
long   orden_produccion

bus_filtro=""
bus_titulo=""
bus_datawindow = ""
bus_campo = this.GetColumnName()
valor_empresa = TRUE

CHOOSE CASE bus_campo
	CASE "articulo"
		bus_filtro     = filtro_formatos_linea
		bus_datawindow = "dw_ayuda_articulos"
		bus_titulo     = "VENTANA SELECCION DE ARTICULOS"
	CASE "caja"
		bus_titulo     = "Ayuda seleccion de cajas"
		bus_datawindow = "dw_ayuda_almartcajas"
		bus_filtro     = "almartcajas_articulo = '"+this.object.articulo[this.getrow()]+"'"
	CASE "tipo_pallet"		
		bus_titulo     = "Ayuda seleccion de pallets"
		bus_datawindow = "dw_ayuda_palarticulo_abr"
		bus_filtro     = "(palarticulo_articulo = '"+this.object.articulo[this.getrow()]+"') and "+&
							  "(palarticulo_caja = '"+this.object.caja[this.getrow()]+"')" 		
	CASE "tono"
		SetNull(bus_campo)
		if KeyDown(Keyenter!) then			
			articulo = this.object.articulo[this.getrow()]
			dw_tonos.retrieve(codigo_empresa,articulo)
			if dw_tonos.rowcount() > 0 then
//				dw_tonos.x = xpos - 709
//				dw_tonos.y = ypos - 492
				dw_tonos.visible = true
				dw_tonos.setfocus()
			else
				messagebox("Atención","Articulo sin historico de tonos")
			end if							  
		end if
	CASE "orden_produccion"		
		SetNull(bus_campo)
		orden_produccion = this.object.orden_produccion[this.getrow()]
		if isnull(orden_produccion) then orden_produccion = 0
		if orden_produccion = 0 then
			linea      = this.object.linea[this.getrow()]
			anyo_orden = this.object.anyo_orden_produccion[this.getrow()]
			this.object.orden_produccion[this.getrow()] = f_numero_orden_linea(codigo_empresa,linea,anyo_orden)
			this.accepttext()
		end if
	CASE ELSE
		SetNull(bus_campo)
END CHOOSE

CALL Super::key

end event

type dw_pendiente_escandallo from u_datawindow within wi_mant_prod_diaria_nueva
integer x = 1792
integer y = 1288
integer width = 1792
integer height = 764
integer taborder = 120
string dragicon = "Warning!"
string dataobject = "dw_mant_prod_diaria_n_pendiente2"
boolean vscrollbar = true
end type

event clicked;call super::clicked;string  tipo_linea
boolean arrastrar

if not(bloqueando) then
	if not f_bloquear("proddiaria",codigo_empresa,"Mantenimiento Producción Diaria") then
      commit Using SQLCA;
		bloqueando = true
		cb_aceptar.enabled    = true
		cb_cancelar.enabled   = true
		em_fechahasta.enabled = false
		em_fechadesde.enabled = false
		cb_listar.enabled     = false		
	else
		// problema concurrencia
		st_empresa.setfocus()
	end if
end if

if row > 0 and bloqueando then	
	tipo_linea = f_tipo_linea(codigo_empresa,linea_activa)
	choose case tipo_linea
		case "P"
			if this.object.pasar_por_prensa[row] = "S" and this.object.asignada_prensa[row] <> "S" then
				arrastrar = true				
			else
				arrastrar = false
			end if
		case "E"
			if this.object.pasar_por_esmaltadora[row] = "S" and this.object.asignada_esmaltadora[row] <> "S" then
				arrastrar = true				
			else
				arrastrar = false
			end if			
		case "H"
			if this.object.pasar_por_horno[row] = "S" and this.object.asignado_horno[row] <> "S" then
				arrastrar = true				
			else
				arrastrar = false
			end if			
		case else
		arrastrar = false
	end choose
	this.selectrow(0,false)
	this.selectrow(row,true)
	this.setrow(row)			
	if arrastrar then
		drag(begin!)
		row_anterior_arrastre = dw_produccion.rowcount() +1
	end if
end if			
end event

event rbuttondown;call super::rbuttondown;
if row > 0 then
	f_reservas_pendiente_esc(row)	
end if
end event

event rowfocuschanged;call super::rowfocuschanged;if currentrow > 0 then
	this.selectrow(0,false)
	this.selectrow(currentrow,true)
	this.setrow(currentrow)
	if dw_reservas_pendiente_escandallo.visible then
		f_reservas_pendiente_esc(currentrow)
	end if
end if
end event

event doubleclicked;string articulo
int    coccion,anyo_orden_produccion
long   orden_produccion

if row > 0 then
	articulo = this.object.articulo[row]
	coccion  = this.object.coccion[row]
	anyo_orden_produccion = dw_pendiente.object.anyo_orden_produccion[dw_produccion.getrow()]
	orden_produccion      = dw_pendiente.object.orden_produccion[dw_produccion.getrow()]
	
	f_mostrar_situacion_articulo_coccion(articulo,coccion,anyo_orden_produccion,orden_produccion)
end if
end event

type dw_pendiente from u_datawindow within wi_mant_prod_diaria_nueva
integer y = 1288
integer width = 1792
integer height = 764
integer taborder = 100
string dragicon = "Warning!"
string dataobject = "dw_mant_prod_diaria_n_pendiente"
boolean vscrollbar = true
end type

event clicked;call super::clicked;string  tipo_linea
boolean arrastrar

if not(bloqueando) then
	if not f_bloquear("proddiaria",codigo_empresa,"Mantenimiento Producción Diaria") then
      commit Using SQLCA;
		bloqueando = true
		cb_aceptar.enabled    = true
		cb_cancelar.enabled   = true
		em_fechahasta.enabled = false
		em_fechadesde.enabled = false
		cb_listar.enabled     = false		
	else
		// problema concurrencia
		st_empresa.setfocus()
	end if
end if

if row > 0 and bloqueando then	
	//this.event rowfocuschanged(row)
	
	tipo_linea = f_tipo_linea(codigo_empresa,linea_activa)
	choose case tipo_linea
		case "P"
			if this.object.pasar_por_prensa[row] = "S" and this.object.asignada_prensa[row] <> "S" then
				arrastrar = true				
			else
				arrastrar = false
			end if
		case "E"
			if this.object.pasar_por_esmaltadora[row] = "S" and this.object.asignada_esmaltadora[row] <> "S" then
				arrastrar = true				
			else
				arrastrar = false
			end if			
		case "H"
			if this.object.pasar_por_horno[row] = "S" and this.object.asignado_horno[row] <> "S" then
				arrastrar = true				
			else
				arrastrar = false
			end if			
		case else
		arrastrar = false
	end choose
	this.selectrow(0,false)
	this.selectrow(row,true)
	this.setrow(row)		
	if arrastrar then
		drag(begin!)
		row_anterior_arrastre = dw_produccion.rowcount() +1
	end if
end if			
end event

event rowfocuschanged;call super::rowfocuschanged;int  anyo
long contador

dw_reservas_pendiente_escandallo.visible = false

if this.rowcount() > 0 then
	if currentrow > 0 then
		this.selectrow(0,false)
		this.selectrow(currentrow,true)
		this.setrow(currentrow)		
		anyo     = this.object.anyo[currentrow]
		contador = this.object.contador[currentrow]
		
		dw_pendiente_escandallo.setfilter("anyo = "+string(anyo,"####")+" and contador = "+&
													 string(contador,"########"))
		dw_pendiente_escandallo.filter()		

	end if
end if
end event

event doubleclicked;string articulo
int    coccion,anyo_orden_produccion
long   orden_produccion

if row > 0 then
	articulo              = this.object.articulo[row]
	coccion               = 0
	anyo_orden_produccion = this.object.anyo_orden_produccion[row]
	orden_produccion      = this.object.orden_produccion[row]
	
	f_mostrar_situacion_articulo_coccion(articulo,coccion,anyo_orden_produccion,orden_produccion)
end if
end event

type dw_reservas_pendiente_escandallo from datawindow within wi_mant_prod_diaria_nueva
integer x = 1787
integer y = 1124
integer width = 1646
integer height = 360
integer taborder = 140
boolean bringtotop = true
string dataobject = "dw_con_reservas_pendiente_escandallo"
boolean livescroll = true
end type

event itemchanged;dec     anterior_reserva,actual_reserva,disponible,stock,reservado,preparado
string  articulo,calidad,tono,tipo_pallet,caja,referencia
int     calibre,anyo
long    contador,linea
boolean actualizar = true,bien = true

if dwo.name = "reservado" then
	
	if    dw_pendiente_escandallo.object.asignada_prensa[dw_pendiente_escandallo.getrow()] = "S" &
		or dw_pendiente_escandallo.object.asignada_esmaltadora[dw_pendiente_escandallo.getrow()] = "S" &
		or dw_pendiente_escandallo.object.asignado_horno[dw_pendiente_escandallo.getrow()] = "S" then
		
		messagebox("Atención","No se pueden modificar las reservar de una producción planificada.")
		bien       = false
		
	else
	
		anterior_reserva = this.object.reservado[row]
		actual_reserva   = dec(data)
		disponible       = this.object.disponible[row]
		articulo         = this.object.articulo[row]
		calidad          = this.object.calidad[row]
		tono             = this.object.tono[row]
		calibre          = this.object.calibre[row]
		tipo_pallet      = this.object.tipo_pallet[row]
		caja             = this.object.caja[row]
		
		anyo             = dw_pendiente_escandallo.object.anyo[dw_pendiente_escandallo.getrow()]
		contador         = dw_pendiente_escandallo.object.contador[dw_pendiente_escandallo.getrow()]
		linea            = dw_pendiente_escandallo.object.linea[dw_pendiente_escandallo.getrow()]
		if actual_reserva > anterior_reserva then
			if disponible < (actual_reserva - anterior_reserva) then
				messagebox("Atención","No se puede reservar mas cantidad que el disponible.")
				actualizar = false
				bien       = false
			end if
		else
			if actual_reserva = 0 then
				delete from proddiaria_pendiente_comp_res
				where  empresa     = :codigo_empresa
				and    anyo        = :anyo
				and    contador    = :contador
				and    linea       = :linea
				and    articulo    = :articulo
				and    calidad     = :calidad
				and    tono        = :tono
				and    calibre     = :calibre
				and    tipo_pallet = :tipo_pallet
				and    caja        = :caja; 
				
				if sqlca.sqlcode <> 0 then
					rollback;
					messagebox("Atención","Se ha producido un error al actualizar la reserva.")
					bien = false
				else
					commit;
				end if
			end if		
		end if	
		
		if actualizar and actual_reserva > 0 then
			if anterior_reserva = 0 then
				insert into proddiaria_pendiente_comp_res
						(empresa,			anyo,			contador,			linea,
						 articulo,			calidad,		tono,					calibre,
						 tipo_pallet,		caja,			cantidad)
				values			 
						(:codigo_empresa,	:anyo,		:contador,			:linea,
						 :articulo,			:calidad,	:tono,				:calibre,
						 :tipo_pallet,		:caja,		:actual_reserva);
				
			else
				update proddiaria_pendiente_comp_res
				set    cantidad    = :actual_reserva
				where  empresa     = :codigo_empresa
				and    anyo        = :anyo
				and    contador    = :contador
				and    linea       = :linea
				and    articulo    = :articulo
				and    calidad     = :calidad
				and    tono        = :tono
				and    calibre     = :calibre
				and    tipo_pallet = :tipo_pallet
				and    caja        = :caja; 
			end if
			
			if sqlca.sqlcode <> 0 then
				rollback;
				messagebox("Atención","Se ha producido un error al actualizar la reserva.")
				bien = false
			else
				commit;
			end if
			referencia  = f_componer_ref(articulo,calidad,tono,calibre)
			stock       = f_stock_referencia_tipo_pallet_caja(codigo_empresa,referencia,tipo_pallet,caja)
			reservado   = f_reservado_referencia_tipo_pallet_caja(codigo_empresa,referencia,tipo_pallet,caja)
			preparado   = f_preparado_referencia_tipo_pallet_caja(codigo_empresa,referencia,tipo_pallet,caja)
			disponible  = stock - reservado - preparado				
			this.object.disponible[row] = disponible
		end if
		//f_actualizar_pendiente_comp(dw_pendiente_escandallo.getrow())
	end if
end if

if bien then
	return 0
else
	return 2
end if
end event

event itemerror;return 1

end event

event clicked;if dwo.name = "salir" then
	this.visible = false
end if
end event

type dw_situacion_articulo from datawindow within wi_mant_prod_diaria_nueva
integer x = 896
integer y = 452
integer width = 1573
integer height = 424
integer taborder = 70
boolean bringtotop = true
string dataobject = "dw_mant_prod_diaria_situacion_articulo"
boolean livescroll = true
end type

event clicked;this.visible = false
end event

