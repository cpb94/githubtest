$PBExportHeader$wtc_trabajos_disenyo_nuevo.srw
forward
global type wtc_trabajos_disenyo_nuevo from wt_ventana_padre
end type
type pb_borrar_trabajo from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type pb_duplica_trabajo from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type pb_anyade_trabajo from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type st_2 from statictext within wtc_trabajos_disenyo_nuevo
end type
type cb_generar_pieza from commandbutton within wtc_trabajos_disenyo_nuevo
end type
type cb_generar_coleccion from commandbutton within wtc_trabajos_disenyo_nuevo
end type
type dw_ficha_comercial from datawindow within wtc_trabajos_disenyo_nuevo
end type
type pb_anyade_archivo from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type pb_borrar_archivo from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type pb_anyade_propuesta from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type pb_borrar_propuesta from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type pb_anyade_cliente from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type pb_quitar_cliente from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type dw_clientes from u_dw within wtc_trabajos_disenyo_nuevo
end type
type dw_archivos from u_dw within wtc_trabajos_disenyo_nuevo
end type
type dw_con_piezas_coleccion from u_dw within wtc_trabajos_disenyo_nuevo
end type
type pb_2 from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type p_seleccion from picture within wtc_trabajos_disenyo_nuevo
end type
type pb_archivos_modelo from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type cb_tr from commandbutton within wtc_trabajos_disenyo_nuevo
end type
type dw_imagen from u_dw_imagen within wtc_trabajos_disenyo_nuevo
end type
type pb_3 from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type dw_imp_lab from datawindow within wtc_trabajos_disenyo_nuevo
end type
type dw_fecha_necesidad from u_dw within wtc_trabajos_disenyo_nuevo
end type
type dw_versiones from u_dw within wtc_trabajos_disenyo_nuevo
end type
type pb_anyade_version from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type pb_borrar_version from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type dw_bases_version_pieza from u_dw within wtc_trabajos_disenyo_nuevo
end type
type popup_versiones from datawindow within wtc_trabajos_disenyo_nuevo
end type
type cb_popup_versiones from commandbutton within wtc_trabajos_disenyo_nuevo
end type
type pb_bases_mas from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type pb_bases_menos from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type dw_bases from u_dw within wtc_trabajos_disenyo_nuevo
end type
type dw_piezas from u_dw within wtc_trabajos_disenyo_nuevo
end type
type dw_imagen_pieza from u_dw_imagen within wtc_trabajos_disenyo_nuevo
end type
type st_imagen_pieza from statictext within wtc_trabajos_disenyo_nuevo
end type
type st_produccion from statictext within wtc_trabajos_disenyo_nuevo
end type
type pb_estructura_archivos from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type dw_trabajos from u_dw within wtc_trabajos_disenyo_nuevo
end type
type cb_marcar_no_produccion from commandbutton within wtc_trabajos_disenyo_nuevo
end type
type cb_borrar_marcados from commandbutton within wtc_trabajos_disenyo_nuevo
end type
type dw_estructura from datawindow within wtc_trabajos_disenyo_nuevo
end type
type cb_marcar_todo from commandbutton within wtc_trabajos_disenyo_nuevo
end type
type cb_4 from commandbutton within wtc_trabajos_disenyo_nuevo
end type
type st_guardar from statictext within wtc_trabajos_disenyo_nuevo
end type
type dw_propuestas from u_dw within wtc_trabajos_disenyo_nuevo
end type
type pb_1 from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type pb_4 from picturebutton within wtc_trabajos_disenyo_nuevo
end type
type dw_referencias from u_dw within wtc_trabajos_disenyo_nuevo
end type
type cb_1 from commandbutton within wtc_trabajos_disenyo_nuevo
end type
type dw_actualizar_base from u_dw within wtc_trabajos_disenyo_nuevo
end type
type cb_2 from commandbutton within wtc_trabajos_disenyo_nuevo
end type
end forward

global type wtc_trabajos_disenyo_nuevo from wt_ventana_padre
integer width = 5810
integer height = 3756
string title = "Trabajos diseño"
pb_borrar_trabajo pb_borrar_trabajo
pb_duplica_trabajo pb_duplica_trabajo
pb_anyade_trabajo pb_anyade_trabajo
st_2 st_2
cb_generar_pieza cb_generar_pieza
cb_generar_coleccion cb_generar_coleccion
dw_ficha_comercial dw_ficha_comercial
pb_anyade_archivo pb_anyade_archivo
pb_borrar_archivo pb_borrar_archivo
pb_anyade_propuesta pb_anyade_propuesta
pb_borrar_propuesta pb_borrar_propuesta
pb_anyade_cliente pb_anyade_cliente
pb_quitar_cliente pb_quitar_cliente
dw_clientes dw_clientes
dw_archivos dw_archivos
dw_con_piezas_coleccion dw_con_piezas_coleccion
pb_2 pb_2
p_seleccion p_seleccion
pb_archivos_modelo pb_archivos_modelo
cb_tr cb_tr
dw_imagen dw_imagen
pb_3 pb_3
dw_imp_lab dw_imp_lab
dw_fecha_necesidad dw_fecha_necesidad
dw_versiones dw_versiones
pb_anyade_version pb_anyade_version
pb_borrar_version pb_borrar_version
dw_bases_version_pieza dw_bases_version_pieza
popup_versiones popup_versiones
cb_popup_versiones cb_popup_versiones
pb_bases_mas pb_bases_mas
pb_bases_menos pb_bases_menos
dw_bases dw_bases
dw_piezas dw_piezas
dw_imagen_pieza dw_imagen_pieza
st_imagen_pieza st_imagen_pieza
st_produccion st_produccion
pb_estructura_archivos pb_estructura_archivos
dw_trabajos dw_trabajos
cb_marcar_no_produccion cb_marcar_no_produccion
cb_borrar_marcados cb_borrar_marcados
dw_estructura dw_estructura
cb_marcar_todo cb_marcar_todo
cb_4 cb_4
st_guardar st_guardar
dw_propuestas dw_propuestas
pb_1 pb_1
pb_4 pb_4
dw_referencias dw_referencias
cb_1 cb_1
dw_actualizar_base dw_actualizar_base
cb_2 cb_2
end type
global wtc_trabajos_disenyo_nuevo wtc_trabajos_disenyo_nuevo

type variables
String grupo_usuario
String version_pieza

end variables

forward prototypes
public function boolean hay_cambios ()
public function integer f_guardar ()
public function integer f_borrar ()
public subroutine mostrar_controles_insercion ()
public subroutine mostrar_controles_edicion ()
public subroutine seleccionar_fila (datawindow dw, integer fila, integer columna)
public subroutine seleccionar_fila_guardar (integer sel_cliente, integer sel_propuesta, integer sel_pieza, integer sel_version, integer sel_trabajo, integer sel_archivo)
public subroutine f_cargar_imagen_expo2 ()
private subroutine f_cargar_imagen_expo ()
public subroutine seleccionar_fila_error (integer fila_cliente, integer fila_propuesta, integer fila_pieza, integer fila_version, integer fila_cliente_actual, integer fila_propuesta_actual, integer fila_pieza_actual, integer fila_version_actual)
public subroutine seleccionar_por_codigo (string cliente, string propuesta, string pieza, string version_color, string trabajo, string archivo)
end prototypes

public function boolean hay_cambios ();Boolean resultado
resultado = false

dw_1.accepttext() //Necesario para que se detecten los cambios en el campo en el que se tiene el foco

if dw_1.DeletedCount() + dw_1.ModifiedCount() > 0 or dw_trabajos.DeletedCount() + dw_trabajos.ModifiedCount() > 0 or dw_propuestas.DeletedCount() + dw_propuestas.ModifiedCount() > 0 or dw_clientes.DeletedCount() + dw_clientes.ModifiedCount() > 0 or dw_piezas.DeletedCount() + dw_piezas.ModifiedCount() > 0 or dw_versiones.DeletedCount() + dw_versiones.ModifiedCount() > 0 or dw_archivos.DeletedCount() + dw_archivos.ModifiedCount() > 0 then
	resultado = true
end if

return resultado
end function

public function integer f_guardar ();//SOBRESCRIBIMOS LA FUNCION DEL PADRE. NO LA LLMAMOS CON super::funcion()

long i, j, j2, k, m, n, fila_cliente, maximo_pieza, maximo_prueba, maximo_codigo_p, npiezas, numero_piezas, numero_archivos, numero_tipos, pasado, pieza_imagen_copia, existe
string sel, campo, motivo, coleccion, coleccion_antigua, tecnico, v_control, coleccion_nueva, desc_funcion, base, ruta_archivos_exposicion
boolean falta_Campo, aceptado
String cliente, propuesta, pieza, version_color, prueba, pieza_global, pieza_codigo_lab, descripcion, trabajo_pasar_pieza, serie_lab, version_pieza2, base_final
Int resultado
Long sel_cliente, sel_propuesta, sel_pieza, sel_version, sel_trabajo, sel_archivo
String ruta, fichero, codigo_archivo, extension, fichero_nuevo, tamanyo
String ruta_imagen_copia, ruta_imagen_destino, ruta_copia, fichero_copia, fichero_destino, tamanyo_copia, pieza_imagen_copia_st
String cod_cliente, cod_propuesta, cod_pieza, cod_version, cod_trabajo, cod_archivo, tecnico_lab_actual, tecnico_lab_coleccion_antigua
String cliente_actual, cliente_relieve, relieve, razon

Datetime fecha_coleccion, fecha_fin_trabajo, fecha_solicitud, ahora


ahora = Datetime(Today(), Now())

Datastore piezas, archivos, tipos

resultado = 1 //Todo ok si devolvemos 1

param_colisiones.empresa = codigo_empresa
param_colisiones.tabla = "modelo"
param_colisiones.campo = "modelo"
param_colisiones.filtro = ""
param_colisiones.buscar_huecos = false

str_colisiones pcolisiones_pieza

setnull(fecha_fin_trabajo)

//Obtenemos las filas seleccionadas para volverlas a marcar una vez realizado el guardado
sel_cliente = dw_clientes.getrow()
sel_propuesta = dw_propuestas.getrow()
sel_pieza = dw_piezas.getrow()
sel_version = dw_versiones.getrow()
sel_trabajo = dw_trabajos.getrow()
sel_archivo = dw_archivos.getrow()

if sel_cliente > 0 then
	cod_cliente = dw_clientes.object.cliente[sel_cliente]
end if
if sel_propuesta > 0 then
	cod_propuesta = dw_propuestas.object.modelo_propuesta_codigo[sel_propuesta]
end if
if sel_pieza > 0 then
	cod_pieza = dw_piezas.object.codigo[sel_pieza]
end if
if sel_version > 0 then
	cod_version = dw_versiones.object.codigo[sel_version]
end if
if sel_trabajo > 0 then
	cod_trabajo = dw_trabajos.object.modelo_trabajo_codigo[sel_trabajo]
end if 
if sel_archivo > 0 then
	cod_archivo = dw_archivos.object.codigo[sel_archivo]
end if


//QUITAMOS REDRAW PARA EVITAR PARPADEOS
dw_clientes.SetRedraw(false)
dw_propuestas.SetRedraw(false)	
dw_trabajos.SetRedraw(false)	
dw_versiones.SetRedraw(false)	
dw_piezas.SetRedraw(false)	
dw_archivos.SetRedraw(false)
dw_bases_version_pieza.SetRedraw(false)
dw_imagen_pieza.setredraw(false)

//------------------------------------------------------------------------------------------------------------------------------
//			   AQUÍ IRÁ EL CÓDIGO PARA COMPROBAR LOS CAMPOS OBLIGATORIOS.
//------------------------------------------------------------------------------------------------------------------------------

//VALIDACIÓN dw_1
// Campos obligatorios dw_1 
dw_1.accepttext()
falta_campo = false
if dw_1.rowcount() > 0 then
	if IsNull(dw_1.object.coleccion[dw_1.getrow()]) or Trim(String(dw_1.object.coleccion[dw_1.getrow()])) = "" then
		  campo = "coleccion"
		  motivo = "Campo Obligatorio: Colección. "
		  falta_campo = True
	elseif IsNull(dw_1.object.funcion[dw_1.getrow()]) or Trim(String(dw_1.object.funcion[dw_1.getrow()])) = "" then
		  campo = "funcion"
		  motivo = "Campo Obligatorio: Función. "
		  falta_campo = True
	elseif IsNull(dw_1.object.pavrev[dw_1.getrow()]) or Trim(String(dw_1.object.pavrev[dw_1.getrow()])) = "" then
		  campo = "pavrev"
		  motivo = "Campo Obligatorio: Pav / Rev. "
		  falta_campo = True
	elseif IsNull(dw_1.object.tecnico_dis[dw_1.getrow()]) or Trim(String(dw_1.object.tecnico_dis[dw_1.getrow()])) = "" then
		  campo = "tecnico_dis"
		  motivo = "Campo Obligatorio: Diseñador "
		  falta_campo = True
	elseif IsNull(dw_1.object.comercial[dw_1.getrow()]) or Trim(String(dw_1.object.comercial[dw_1.getrow()])) = "" then
		  campo = "comercial"
		  motivo = "Campo Obligatorio: Comercial "
		  falta_campo = True
	elseif IsNull(dw_1.object.relieve[dw_1.getrow()]) or Trim(String(dw_1.object.relieve[dw_1.getrow()])) = "" then
		  campo = "relieve"
		  motivo = "Campo Obligatorio: Relieve "
		  falta_campo = True
	end if	

	if falta_campo then
	  MessageBox("Campo obligatorio: "+campo,motivo,Exclamation!, OK!,1)
	  dw_1.setfocus()
	  dw_1.SetColumn(campo)
	  //seleccionar_fila_guardar(sel_cliente, sel_propuesta, sel_pieza, sel_version, sel_trabajo, sel_archivo) //Selecciono lo que se veía, puesto que el error no necesita cambiar la fila seleccionada para su visualización
	  seleccionar_por_codigo(cod_cliente, cod_propuesta, cod_pieza, cod_version, cod_trabajo, cod_archivo)
	  return 0
	end if
end if


//VALIDACIÓN dw_referencias
dw_referencias.accepttext()
falta_campo = false
For i = 1 To dw_referencias.rowcount()
	if IsNull(dw_referencias.object.referencia[dw_referencias.getrow()]) or Trim(String(dw_referencias.object.referencia[dw_1.getrow()])) = "" then
		  campo = "referencia"
		  motivo = "Campo Obligatorio: Modelo de referencia. "
		  falta_campo = True
	end if	
Next

if falta_campo then
  MessageBox("Campo obligatorio: "+campo,motivo,Exclamation!, OK!,1)
  dw_referencias.setfocus()
  dw_referencias.SetColumn(campo)
  return 0
end if

//VALIDACIÓN dw_clientes -------------------------------------------------------------------------------------------------------------------------
// Mínimo 1 cliente
if dw_clientes.RowCount() < 1 then
	messagebox("Aviso", 'Debe existir al menos un cliente asociado al modelo')
	//seleccionar_fila_guardar(sel_cliente, sel_propuesta, sel_pieza, sel_version, sel_trabajo, sel_archivo) //Selecciono lo que se veía, puesto que el error no necesita cambiar la fila seleccionada para su visualización
	 seleccionar_por_codigo(cod_cliente, cod_propuesta, cod_pieza, cod_version, cod_trabajo, cod_archivo)
	return 0
end if

dw_clientes.accepttext()
falta_campo = false
IF dw_clientes.rowcount() > 0 THEN
	falta_campo = false
	i = 1
	DO WHILE ( i <= dw_clientes.rowcount() AND NOT falta_campo )
		
		// Campos obligatorios dw_clientes 
		IF IsNull(dw_clientes.object.cliente[i]) or Trim(String(dw_clientes.object.cliente[i]))="" THEN
			  campo="cliente"
			  motivo  = "Campo Obligatorio: cliente"
			  falta_campo = True
		END IF
		
		//Comprobamos el relieve (si es exclusivo no se puede utilizar)
		if not falta_campo then
			relieve = dw_1.object.relieve[dw_1.getrow()]
			cliente_actual = dw_clientes.object.cliente[i]
			cliente_relieve = ""
			SELECT art_tipomoldura.cliente, genter.razon 
			INTO :cliente_relieve, :razon 
			FROM art_tipomoldura 
			LEFT OUTER JOIN genter ON art_tipomoldura.empresa = genter.empresa 
				AND art_tipomoldura.cliente = genter.codigo  
				AND genter.tipoter = 'C' 
			WHERE art_tipomoldura.empresa = :codigo_empresa 
			AND art_tipomoldura.codigo = :relieve;
			
			if not isnull(cliente_relieve) and cliente_relieve <> "" then
				if cliente_relieve <> cliente_actual and cliente_actual <> '87' then
					MessageBox("Error", "El relieve seleccionado es exclusivo del cliente "+razon+". Seleccione otro relieve antes de continuar.")
					seleccionar_fila_error(i,0,0,0, sel_cliente, sel_propuesta, sel_pieza, sel_version) //Selecciono el cliente que no está bien
				 	return 0
				end if
			end if
		end if
		
		//Comprobamos que el cliente esté en el histórico de la colección
		cliente = dw_clientes.object.cliente[i]
		if cliente <> '87' then //salvo cliente TENCER
			existe = 0
			coleccion = dw_1.object.coleccion[dw_1.getrow()]			
			SELECT isnull(COUNT(*), 0)
			INTO :existe 
			FROM deshistorico 
			WHERE empresa = :codigo_empresa AND coleccion = :coleccion AND cliente = :cliente;
			IF existe = 0 THEN
				 messagebox("Aviso", 'Debe introducir el cliente '+cliente+' en el historico de la colección')
				 seleccionar_fila_error(i,0,0,0, sel_cliente, sel_propuesta, sel_pieza, sel_version) //Selecciono el cliente que no está
				 return 0
			END IF
		end if 
		
		//Si no ponemos esta condición, aparecerá el filtro al usuario por no existir un valor válido de cliente
		if not falta_campo then
		
			//DW dependientes del cliente -------------------------------------------------------------------------------------------------------------------------
			cliente = dw_clientes.object.cliente[i]
			
			//VALIDACIÓN dw_propuestas -------------------------------------------------------------------------------------------------------------------------
			//Filtro con las dependencias correspondientes : cliente
			dw_propuestas.setfilter("modelo_propuesta_cliente = '"+cliente+"'")
			dw_propuestas.filter()
			dw_propuestas.accepttext()
			if dw_propuestas.RowCount() < 1 then
				messagebox("Aviso", 'Debe existir al menos una propuesta por cliente asociado al modelo')
				seleccionar_fila_error(i,0,0,0, sel_cliente, sel_propuesta, sel_pieza, sel_version) //Selecciono el cliente que no tiene propuestas
				return 0
			end if
		
		end if
	
		IF dw_propuestas.rowcount() > 0  and falta_campo = false THEN
			j = 1
			DO WHILE (j <= dw_propuestas.rowcount() AND NOT falta_campo )
				
				// Campos obligatorios dw_propuestas 
				IF IsNull(dw_propuestas.object.modelo_propuesta_formato[j]) or Trim(String(dw_propuestas.object.modelo_propuesta_formato[j]))="" THEN
					  campo="modelo_propuesta_formato"
					  motivo  = "Campo Obligatorio: Formato"
					  falta_campo = True
				END IF
				
				//Una propuesta, por defecto no está rechazada (salvo que se indique lo contrario) por lo que el null se convierte a rechazado NO
				IF IsNull(dw_propuestas.object.modelo_propuesta_rechazado[j]) or Trim(String(dw_propuestas.object.modelo_propuesta_rechazado[j]))="" THEN
					 dw_propuestas.object.modelo_propuesta_rechazado[j] = '0'
				END IF
				
				
				//DW dependientes de la propuesta -------------------------------------------------------------------------------------------------------------------------
				propuesta = dw_propuestas.object.modelo_propuesta_codigo[j]
				
				//VALIDACIÓN dw_trabajos -------------------------------------------------------------------------------------------------------------------------
				//Filtro con las dependencias correspondientes : cliente, propuesta
				dw_trabajos.setfilter("modelo_trabajo_cliente = '"+cliente+"' and modelo_trabajo_propuesta = '"+propuesta+"'")
				dw_trabajos.filter()
				dw_trabajos.accepttext()
				if dw_trabajos.RowCount() < 1 then
					messagebox("Aviso", 'Debe existir al menos un trabajo para cada propuesta asociada al modelo') 
					seleccionar_fila_error(i,j,0,0, sel_cliente, sel_propuesta, sel_pieza, sel_version) //Selecciono el cliente y la propuesta que no tienen trabajos
					return 0
				end if
				
				// Campos obligatorios dw_trabajos 
				dw_trabajos.accepttext()
				IF dw_trabajos.rowcount() > 0 and falta_campo = false THEN
					k = 1
					DO WHILE (k <= dw_trabajos.rowcount() AND NOT falta_campo )
						
						IF IsNull(dw_trabajos.object.modelo_trabajo_serie[k]) or Trim(String(dw_trabajos.object.modelo_trabajo_serie[k]))="" THEN
							  campo="modelo_trabajo_serie"
							  motivo  = "Campo Obligatorio: Serie"
							  falta_campo = True
						END IF
						
						IF IsNull(dw_trabajos.object.modelo_trabajo_acabado_lab[k]) or Trim(String(dw_trabajos.object.modelo_trabajo_acabado_lab[k]))="" THEN
							  campo="modelo_trabajo_acabado_lab"
							  motivo  = "Campo Obligatorio: Acabado"
							  falta_campo = True
						END IF
						
						IF IsNull(dw_trabajos.object.modelo_trabajo_tecnico_dis[k]) or Trim(String(dw_trabajos.object.modelo_trabajo_tecnico_dis[k]))="" THEN
							  campo="modelo_trabajo_tecnico_dis"
							  motivo  = "Campo Obligatorio: Diseñador"
							  falta_campo = True
						END IF
						
						IF IsNull(dw_trabajos.object.modelo_trabajo_comercial[k]) or Trim(String(dw_trabajos.object.modelo_trabajo_comercial[k]))="" THEN
							  campo="modelo_trabajo_comercial"
							  motivo  = "Campo Obligatorio: Comercial"
							  falta_campo = True
						END IF
						
						IF IsNull(dw_trabajos.object.modelo_trabajo_fecha_solicitud[k]) or Trim(String(dw_trabajos.object.modelo_trabajo_fecha_solicitud[k]))="" THEN
							  campo="modelo_trabajo_fecha_solicitud"
							  motivo  = "Campo Obligatorio: Fecha Solicitud"
							  falta_campo = True
						END IF
						
						IF IsNull(dw_trabajos.object.modelo_trabajo_fecha_necesidad[k]) or Trim(String(dw_trabajos.object.modelo_trabajo_fecha_necesidad[k]))="" THEN
							  campo="modelo_trabajo_fecha_necesidad"
							  motivo  = "Campo Obligatorio: Fecha Necesidad"
							  falta_campo = True
						END IF
						
						IF IsNull(dw_trabajos.object.modelo_trabajo_pasta[k]) or Trim(String(dw_trabajos.object.modelo_trabajo_pasta[k]))="" THEN
						  campo ="modelo_trabajo_pasta"
						  motivo = "Campo Obligatorio: Introduzca tipo de pasta"
						  falta_campo = True
						END IF 
						
						IF IsNull(dw_trabajos.object.modelo_trabajo_base_cliente[k]) or Trim(String(dw_trabajos.object.modelo_trabajo_base_cliente[k]))="" THEN
						  campo ="modelo_trabajo_base_cliente"
						  motivo = "Campo Obligatorio: Indique si el trabajo es sobre base de cliente"
						  falta_campo = True
						END IF 
						
						IF not IsNull(dw_trabajos.object.modelo_trabajo_fecha_fin[k]) and datetime(date('1900-01-01')) <> dw_trabajos.object.modelo_trabajo_fecha_fin[k] then
							if isnull(fecha_fin_trabajo) then
								fecha_fin_trabajo = dw_trabajos.object.modelo_trabajo_fecha_fin[k]
							elseif fecha_fin_trabajo < dw_trabajos.object.modelo_trabajo_fecha_fin[k] then
								fecha_fin_trabajo = dw_trabajos.object.modelo_trabajo_fecha_fin[k]
							end if
						END IF
						
						k++
					LOOP
					
					//Errores dw_trabajos
					IF falta_campo THEN
						  MessageBox(" "+campo+": Campo obligatorio",motivo,Exclamation!, OK!,1)
//						  dw_piezas.setfilter("cliente = '"+cliente+"' and propuesta ='"+String(dw_propuestas.object.modelo_propuesta_codigo[j])+"'")
//						  dw_piezas.filter()
						  seleccionar_fila_error(i,j,0,0, sel_cliente, sel_propuesta, sel_pieza, sel_version) //Selecciono el cliente y la propuesta donde se encuentra el trabajo con errores
						  dw_trabajos.setfocus()
						  dw_trabajos.SetColumn(campo)
						  return 0
					END IF
				END IF
				
				
				//VALIDACIÓN dw_versiones -------------------------------------------------------------------------------------------------------------------------
				//Filtro con las dependencias correspondientes : cliente, propuesta
				dw_versiones.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
				dw_versiones.filter()
				dw_versiones.accepttext()
				
				// Campos obligatorios dw_versiones 
				IF dw_versiones.rowcount() > 0  and falta_campo = false THEN
					k = 1
					DO WHILE (k <= dw_versiones.rowcount() AND NOT falta_campo )
				
						IF IsNull(dw_versiones.object.descripcion[k]) or Trim(String(dw_versiones.object.descripcion[k]))="" THEN
							  campo="descripcion"
							  motivo  = "Campo Obligatorio: Descripcion"
							  falta_campo = True
						END IF
						
						k++
					LOOP
					
					//ERRORES dw_versiones
					IF falta_campo THEN
					  MessageBox(" "+campo+": Campo obligatorio",motivo,Exclamation!, OK!,1)
//					  dw_piezas.setfilter("cliente = '"+cliente+"' and propuesta ='"+String(dw_propuestas.object.modelo_propuesta_codigo[j])+"'")
//					  dw_piezas.filter()
					  seleccionar_fila_error(i,j,0,0, sel_cliente, sel_propuesta, sel_pieza, sel_version) //Selecciono el cliente y la propuesta donde se encuentra la versión con errores
					  dw_versiones.setfocus()
					  dw_versiones.SetColumn(campo)
					  return 0
					END IF
				END IF
				
				//VALIDACIÓN dw_piezas -------------------------------------------------------------------------------------------------------------------------
				//Filtro con las dependencias correspondientes : cliente, propuesta
				
				dw_piezas.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
				dw_piezas.filter()
				dw_piezas.accepttext()
				
				/*
				//Si hay piezas deben darse de alta las versiones de color
				if dw_piezas.rowcount() > 0 and dw_versiones.rowcount() < 1 then
					messagebox("Aviso", 'Debe existir al menos una versión de color si el modelo ha sido pasado a pieza')
					seleccionar_fila_error(sel_cliente, sel_propuesta, sel_pieza)
					return 0
				end if
				*/
				
				// Campos obligatorios dw_piezas 
				IF dw_piezas.rowcount() > 0  and falta_campo = false THEN
					k = 1
					DO WHILE (k <= dw_piezas.rowcount() AND NOT falta_campo )
				
						IF IsNull(dw_piezas.object.descripcion[k]) or Trim(String(dw_piezas.object.descripcion[k]))="" THEN
							  campo="descripcion"
							  motivo  = "Campo Obligatorio: Descripcion"
							  falta_campo = True
						END IF
						
						//DW dependientes de la pieza -------------------------------------------------------------------------------------------------------------------------
						pieza = dw_piezas.object.codigo[k]
						
						//DW dependientes de la pieza y la versión de color -------------------------------------------------------------------------------------------------------------------------
						For n = 1 To dw_versiones.rowcount()
							version_color = dw_versiones.object.codigo[n]
						
							//Filtro con las dependencias correspondientes : cliente, propuesta, pieza, version
							dw_archivos.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"' and pieza = '"+pieza+"' and modelo_version = '"+version_color+"'")
							dw_archivos.filter()
							dw_archivos.accepttext()
							
							// Campos obligatorios dw_archivos 
							IF dw_archivos.rowcount() > 0  and falta_campo = false THEN
								m = 1
								DO WHILE (m <= dw_archivos.rowcount() AND NOT falta_campo )
							
									IF IsNull(dw_archivos.object.tipo_maquina_disenyo[m]) or Trim(String(dw_archivos.object.tipo_maquina_disenyo[m]))="" THEN
										  campo="tipo_maquina_disenyo"
										  motivo  = "Campo Obligatorio: Tipo Máquina"
										  falta_campo = True
									END IF
									
									IF IsNull(dw_archivos.object.archivo_disenyo[m]) or Trim(String(dw_archivos.object.archivo_disenyo[m]))="" THEN
										  campo="archivo_disenyo"
										  motivo  = "Campo Obligatorio: Archivo"
										  falta_campo = True
									END IF
									
									IF IsNull(dw_archivos.object.modelo_version[m]) or Trim(String(dw_archivos.object.modelo_version[m]))="" THEN
										  campo="modelo_version"
										  motivo  = "Campo Obligatorio: Versión de Color"
										  falta_campo = True
									END IF
									
									m++
								LOOP
								
								//ERRORES dw_archivos
								IF falta_campo THEN
								  MessageBox(" "+campo+": Campo obligatorio",motivo,Exclamation!, OK!,1)
								  seleccionar_fila_error(i,j,k,n, sel_cliente, sel_propuesta, sel_pieza, sel_version) //Selecciono el cliente, la propuesta, la pieza y la versión donde está el archivo con error
								  dw_archivos.setfocus()
								  dw_archivos.SetColumn(campo)
								  return 0
								END IF
							END IF
							
						Next
						
						//Fin DW dependientes de la pieza y versión de color -------------------------------------------------------------------------------------------------------------------------
						
						k++
					LOOP
					
					//Fin DW dependientes de la pieza  -------------------------------------------------------------------------------------------------------------------------
					
					//ERRORES dw_piezas
					IF falta_campo THEN
					  MessageBox(" "+campo+": Campo obligatorio",motivo,Exclamation!, OK!,1)
					  seleccionar_fila_error(i,j,k,0, sel_cliente, sel_propuesta, sel_pieza, sel_version) //Marco la pieza que tiene el error
					  dw_piezas.setfocus()
					  dw_piezas.SetColumn(campo)
					  return 0
					END IF
				END IF
				
				j++
			LOOP
			
			//Fin DW dependientes de la propuesta -------------------------------------------------------------------------------------------------------------------------
				
			//ERRORES dw_propuestas
			IF falta_campo THEN
			  MessageBox(" "+campo+": Campo obligatorio",motivo,Exclamation!, OK!,1)
			  seleccionar_fila_error(i,0,0,0, sel_cliente, sel_propuesta, sel_pieza, sel_version) //Selecciono la propuesta que tiene el error
			  dw_propuestas.setfocus()
			  dw_propuestas.SetColumn(campo)
			  return 0
			END IF
		END IF	
		
		i++
		
	LOOP
	
	//Fin DW dependientes del cliente-------------------------------------------------------------------------------------------------------------------------
	
	//ERRORES dw_clientes
	IF falta_campo THEN
	  MessageBox(" "+campo+": Campo obligatorio",motivo,Exclamation!, OK!,1)
	  /*
	  if dw_propuestas.rowcount() > 0 then
	 	 dw_piezas.setfilter("cliente = '"+cliente+"' and propuesta ='"+String(dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.rowcount()])+"'")
	  else
	  	 dw_piezas.setfilter("cliente = '"+cliente+"'")
	  end if
	  dw_piezas.filter()
	  */
	  seleccionar_fila_error(i,0,0,0, sel_cliente, sel_propuesta, sel_pieza, sel_version) // Selecciono el cliente que tiene el error
	  dw_clientes.setfocus()
	  dw_clientes.SetColumn(campo)
	  return 0
	END IF
END IF

/*---------------------------------------------------------------------------------------------------------------------------------
			   					FIN DE COMPROBAR LOS CAMPOS OBLIGATORIOS.
---------------------------------------------------------------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------------------------------------------------------------
			   					GRABACIÓN DW PRINCIPAL
---------------------------------------------------------------------------------------------------------------------------------*/

// El primer campo del datawindow será el que reciba el código generado. 
// Por tanto, al crear el datawindow maestro debemos situar en primera posición dicho campo
dw_1.accepttext()

//Codigo por si se desea mostrar aviso antes de guardar (Por defecto NO, si no utilizar Message.DoubleParm = 10001)

dw_1.SetTransObject(trans_ts)	
dw_clientes.SetTransObject(trans_ts)
dw_propuestas.SetTransObject(trans_ts)
dw_referencias.SetTransObject(trans_ts)
dw_piezas.SetTransObject(trans_ts)
dw_trabajos.SetTransObject(trans_ts)
dw_versiones.SetTransObject(trans_ts)
dw_archivos.SetTransObject(trans_ts)
dw_bases_version_pieza.SetTransObject(trans_ts)

coleccion_antigua = ""

if dw_1.rowcount() > 0 then
	dw_1.object.modelo_empresa[dw_1.getrow()] = codigo_empresa		
	coleccion = dw_1.object.coleccion[dw_1.getrow()]
	fecha_coleccion = dw_1.object.descoleccionsol_fecha_coleccion[dw_1.getrow()]
	
	if String(dw_1.object.#1[dw_1.getrow()]) = '' or isnull (dw_1.object.#1[dw_1.getrow()]) then
		padre_codigo = String(f_colisiones (trans_ts, param_colisiones))
		if padre_codigo = '0'  then
			messagebox("ERROR", "No se puede asignar un código.")
			ROLLBACK USING trans_ts;

			//seleccionar_fila_guardar(sel_cliente, sel_propuesta, sel_pieza, sel_version, sel_trabajo, sel_archivo) //Uso seleccionar_fila_guardar para mostrar lo que ya había seleccionado a pesar del error
			 seleccionar_por_codigo(cod_cliente, cod_propuesta, cod_pieza, cod_version, cod_trabajo, cod_archivo)
			return 0
		else
			dw_1.object.#1[dw_1.getrow()] = padre_codigo
		end if
	else
		//¿Se ha modificado la colección?
		SELECT modelo.coleccion, descoleccionsol.tecnico_lab INTO :coleccion_antigua, :tecnico_lab_coleccion_antigua 
		FROM modelo LEFT OUTER JOIN descoleccionsol ON modelo.empresa = descoleccionsol.empresa AND modelo.coleccion = descoleccionsol.codigo 
		WHERE modelo.empresa = :codigo_empresa AND modelo.modelo = :padre_codigo USING trans_ts;
		
		if isnull(coleccion_antigua) then coleccion_antigua = ""
	end if
end if


rtn = dw_1.Update()

/*---------------------------------------------------------------------------------------------------------------------------------
			   					FIN GRABACIÓN DW PRINCIPAL
---------------------------------------------------------------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------------------------------------------------------------
				   				GRABACIÓN DATAWINDOWS AUXILIARES
---------------------------------------------------------------------------------------------------------------------------------*/

SELECT ruta_archivos_exposicion 
INTO :ruta_archivos_exposicion 
FROM empresas 
WHERE empresa = :codigo_empresa using trans_ts;

IF rtn = 1 THEN
	rtn = dw_referencias.update()
end if

//CLIENTES
IF rtn = 1 THEN
	dw_clientes.setfilter("")
	dw_clientes.filter()
	for i = 1 to dw_clientes.RowCount()
		dw_clientes.object.modelo[i] = dw_1.object.#1[dw_1.getrow()]
	next
	rtn = dw_clientes.update() 
end if		

//PROPUESTAS
if rtn = 1 then
	dw_propuestas.setfilter("")
	dw_propuestas.filter()
	for i = 1 to dw_propuestas.RowCount()
		dw_propuestas.object.modelo_propuesta_modelo[i] = dw_1.object.#1[dw_1.getrow()]
	next
	rtn = dw_propuestas.update() 
end if

//PIEZAS
pcolisiones_pieza.empresa = codigo_empresa
pcolisiones_pieza.tabla = "modelo_pieza"
pcolisiones_pieza.campo = "codigo_lab"
pcolisiones_pieza.filtro = ""
pcolisiones_pieza.buscar_huecos = false
maximo_pieza = Long(f_colisiones (trans_ts, pcolisiones_pieza))
if maximo_pieza = 0  then
	MessageBox("Error Grabando","No se ha podido asignar un codigo para laboratorio en las piezas nuevas generadas.")
	rtn = -1
end if
if rtn = 1 then
	dw_piezas.setfilter("")
	dw_piezas.filter()
	for i = 1 to dw_piezas.RowCount()
		dw_piezas.object.modelo[i] = dw_1.object.#1[dw_1.getrow()]
		if isnull(dw_piezas.object.codigo_lab[i]) or dw_piezas.object.codigo_lab[i] = '' then 
			dw_piezas.object.codigo_lab[i] = String(maximo_pieza)
			maximo_pieza = maximo_pieza + 1
		end if
	next
	if rtn = 1 then
		rtn = dw_piezas.update() 
	end if
end if

//TRABAJOS
if rtn = 1 then
	dw_trabajos.setfilter("")
	dw_trabajos.filter()
	coleccion = dw_1.object.coleccion[dw_1.getrow()] 
	for i = 1 to dw_trabajos.RowCount()
		dw_trabajos.object.modelo_trabajo_modelo[i] = dw_1.object.#1[dw_1.getrow()]
		
		//Pasar a pieza
		if dw_trabajos.object.pasar_pieza[i] > 0 then //Solo puede haber un pasar pieza a la vez, puesto que guardamos cada vez que se pasa a pieza un trabajo
			npiezas = dw_trabajos.object.pasar_pieza[i]
			//base = dw_fecha_necesidad.object.base[dw_fecha_necesidad.getrow()]

//	ojo		version_pieza = dw_fecha_necesidad.object.version[dw_fecha_necesidad.getrow()]   
			trabajo_pasar_pieza = dw_trabajos.object.modelo_trabajo_codigo[i]
			dw_trabajos.object.pasar_pieza[i] = 0
			cliente = dw_trabajos.object.modelo_trabajo_cliente[i]
			propuesta = dw_trabajos.object.modelo_trabajo_propuesta[i]
			serie_lab = dw_trabajos.object.modelo_trabajo_serie[i]
			pasado = dw_trabajos.object.pasado[i]
			
			select tecnico_lab
			into :tecnico
			from descoleccionsol 
			where empresa = :codigo_empresa
			and codigo = :coleccion
			and tecnico_lab is not null using trans_ts;
			
			if isnull(tecnico) or tecnico = '' then  // Si el trabajo no tiene tecnico asociado
				select codigo, control
				into :tecnico, :v_control
				from tecnico_lab
				where ( control + control_inkcid ) * prioridad = ( select min ((control + control_inkcid) * prioridad ) &
																					from tecnico_lab &
																					where empresa = :codigo_empresa and activo = 'S')
				and empresa = :codigo_empresa
				and activo = 'S' using trans_ts;
				
				update tecnico_lab 
				set control = :v_control + 1
				where empresa = :codigo_empresa
				and codigo = :tecnico using trans_ts;
		
				if trans_ts.SqlCode <> 0 then rtn = -1;
			end if
			
			if rtn = 1 then
				/*
				// Ya no guardamos el técnico a nivel de modelo
				update desmodelo 
				set tecnico_lab = :tecnico
				where empresa = :codigo_empresa
				and modelo = :padre_codigo using trans_ts;
			
				if trans_ts.SqlCode <> 0 then rtn = -1;
				*/
			end if
		
			// Ponemos el técnico en la colección
			if rtn = 1 then
				update descoleccionsol
				set tecnico_lab = :tecnico
				where empresa = :codigo_empresa
				and codigo = :coleccion using trans_ts;
				
				if trans_ts.SqlCode <> 0 then rtn = -1;
			end if 
			
			//Insertamos las piezas
			//
			if rtn = 1 then
				if pasado <= 0 then
					select max(codigo)
					into :maximo_codigo_p
					from modelo_pieza
					where empresa = :codigo_empresa 
					and modelo = :padre_codigo
					and cliente = :cliente 
					and propuesta = :propuesta using trans_ts;
					
					if isnull(maximo_codigo_p) then maximo_codigo_p = 0
					
					//****************************************************************************
					//Sistema de piezas automáticas	
					//Detección de imágenes de piezas posiblemente compatibles (mismo numero de piezas y si es posible mismo cliente). Solo en casos en que el numero de piezas es mayor que 1. 
					if npiezas > 1 then
						SELECT MIN(CONVERT(integer, pieza)) INTO :pieza_imagen_copia 
						FROM modelo_pieza_archivo 
						INNER JOIN modelo_pieza ON modelo_pieza_archivo.empresa = modelo_pieza.empresa 
							AND modelo_pieza_archivo.pieza = modelo_pieza.codigo_lab 
						INNER JOIN modelo_propuesta ON modelo_pieza.empresa = modelo_propuesta.empresa 
							AND modelo_pieza.modelo = modelo_propuesta.modelo 
							AND modelo_pieza.cliente = modelo_propuesta.cliente 
							AND modelo_pieza.propuesta = modelo_propuesta.codigo 
						WHERE modelo_pieza_archivo.empresa = :codigo_empresa 
							AND modelo_pieza.modelo = :padre_codigo 
							AND modelo_propuesta.cliente = :cliente 
							AND modelo_propuesta.numero_piezas = :npiezas using trans_ts;
						
						if isnull(pieza_imagen_copia) or pieza_imagen_copia = 0 then
							SELECT MIN(CONVERT(integer, pieza)) INTO :pieza_imagen_copia 
							FROM modelo_pieza_archivo 
							INNER JOIN modelo_pieza ON modelo_pieza_archivo.empresa = modelo_pieza.empresa AND modelo_pieza_archivo.pieza = modelo_pieza.codigo_lab 
							INNER JOIN modelo_propuesta ON modelo_pieza.empresa = modelo_propuesta.empresa 
								AND modelo_pieza.modelo = modelo_propuesta.modelo 
								AND modelo_pieza.cliente = modelo_propuesta.cliente 
								AND modelo_pieza.propuesta = modelo_propuesta.codigo 
							WHERE modelo_pieza_archivo.empresa = :codigo_empresa 
								AND modelo_pieza.modelo = :padre_codigo 
								AND modelo_propuesta.numero_piezas = :npiezas using trans_ts;
						end if				
					end if
					//****************************************************************************
					
					maximo_codigo_p++
					j = 1
					Do While j <= npiezas and rtn = 1 
						pieza = String(maximo_codigo_p) 
						pieza_codigo_lab = String(maximo_pieza)
						
						//****************************************************************************
						//Sistema de piezas automáticas	
						//Buscamos la imagen del modelo (Solo en casos de una única pieza que concidirá con la del modelo)
						if npiezas = 1 then
							SELECT TOP 1 ruta, fichero, tamanyo 
							INTO :ruta_copia, :fichero_copia, :tamanyo_copia 
							FROM modelo_archivo_expo 
							WHERE empresa = :codigo_empresa AND modelo = :padre_codigo
							ORDER BY CONVERT(integer,codigo) ASC USING trans_ts;
							
							ruta_imagen_copia = ruta_archivos_exposicion + trim(ruta_copia) + trim(fichero_copia)
							fichero_destino = "P" + pieza_codigo_lab + "-" + String(j) + ".jpg"
							ruta_imagen_destino = ruta_archivos_exposicion + trim(ruta_copia) + fichero_destino
							if filecopy(ruta_imagen_copia, ruta_imagen_destino, false) <> 1 then
								//MessageBox("Atención", "No ha sido posible añadir las imagenes de la pieza de forma automática. Avise al diseñador para que las añada manualmente.")
							else			
								INSERT INTO modelo_pieza_archivo (empresa, pieza, codigo, ruta, fichero, activo, fecha_modificacion, tamanyo) 
								VALUES (:codigo_empresa, :pieza_codigo_lab, 1, :ruta_copia, :fichero_destino, 0, :ahora, :tamanyo_copia) USING trans_ts;
								if trans_ts.SqlCode <> 0 then rtn = -1;
								if rtn = 1 then
									//Crear las miniaturas
									sel = "SELECT * FROM archivo_resolucion WHERE empresa = '"+codigo_empresa+"'"
									f_cargar_cursor_transaccion (trans_ts,  tipos,  sel)
									numero_tipos = tipos.RowCount()
									m = 1
									Do While m <= numero_tipos and rtn = 1 
										tamanyo = tipos.object.tamanyo[m]
										ftc_tranformar_imagen_IM ( ruta_archivos_exposicion + trim(ruta_copia), ruta_archivos_exposicion + trim(ruta_copia)+ tamanyo + "\" , fichero_destino, tipos.object.resolucion[m], tamanyo, tipos.object.color[j])
										/*
										ruta_imagen_copia = ruta_archivos_exposicion + trim(ruta_copia) + tamanyo + "\" + trim(fichero_copia)
										ruta_imagen_destino = ruta_archivos_exposicion + trim(ruta_copia) + tamanyo + "\" + fichero_destino
										rtn = filecopy(ruta_imagen_copia, ruta_imagen_destino)
										*/
										m++
									Loop
									
								end if
							end if		
						end if						
						//****************************************************************************
					
						if j = 1 then
							pieza_global = pieza
						end if
						desc_funcion = dw_1.object.art_grupo2_descripcion[dw_1.getrow()]
						if not isnull(desc_funcion) and desc_funcion <> "" then
							descripcion = desc_funcion + " "+String(j)+"/"+String(npiezas)
						else
							descripcion = "PIEZA "+String(j)+"/"+String(npiezas)
						end if
						
						INSERT INTO modelo_pieza (empresa, modelo, cliente, propuesta, codigo, descripcion, codigo_lab, modelo_trabajo, revisado, activo) 
						VALUES (:codigo_empresa, :padre_codigo, :cliente, :propuesta, :pieza, :descripcion, :pieza_codigo_lab, :trabajo_pasar_pieza, "N", "N") using trans_ts;
						if trans_ts.SqlCode <> 0 then rtn = -1;
						
						//****************************************************************************
						//Sistema de piezas automáticas	
						//insertamos imágenes similares en las piezas para ayudar a diseño.
						if rtn = 1 and not isnull(pieza_imagen_copia) and pieza_imagen_copia <> 0 then
							pieza_imagen_copia_st = String(pieza_imagen_copia) 
							pieza_imagen_copia ++
							SELECT TOP 1 ruta, fichero, tamanyo 
							INTO :ruta_copia, :fichero_copia, :tamanyo_copia 
							FROM modelo_pieza_archivo 
							WHERE empresa = :codigo_empresa AND pieza = :pieza_imagen_copia_st
							ORDER BY CONVERT(integer,codigo) ASC USING trans_ts;
							
							ruta_imagen_copia = ruta_archivos_exposicion + trim(ruta_copia) + trim(fichero_copia)
							fichero_destino = "P" + pieza_codigo_lab + "-1.jpg"
							ruta_imagen_destino = ruta_archivos_exposicion + trim(ruta_copia) + fichero_destino
							if filecopy(ruta_imagen_copia, ruta_imagen_destino, false) <> 1 then
								//MessageBox("Atención", "No ha sido posible añadir las imagenes de la pieza de forma automática. Avise al diseñador para que las añada manualmente.")
							else			
								INSERT INTO modelo_pieza_archivo (empresa, pieza, codigo, ruta, fichero, activo, fecha_modificacion, tamanyo) 
								VALUES (:codigo_empresa, :pieza_codigo_lab, 1, :ruta_copia, :fichero_destino, 0, :ahora, :tamanyo_copia) USING trans_ts;
								if trans_ts.SqlCode <> 0 then rtn = -1;
								if rtn = 1 then
									//Crear las miniaturas
									
									sel = "SELECT * FROM archivo_resolucion WHERE empresa = '"+codigo_empresa+"'"
									f_cargar_cursor_transaccion (trans_ts,  tipos,  sel)
									numero_tipos = tipos.RowCount()
									m = 1
									Do While m <= numero_tipos and rtn = 1 
										tamanyo = tipos.object.tamanyo[m]
										ftc_tranformar_imagen_IM ( ruta_archivos_exposicion + trim(ruta_copia), ruta_archivos_exposicion + trim(ruta_copia)+ tamanyo + "\" , fichero_destino, tipos.object.resolucion[m], tamanyo, tipos.object.color[j])
										/*
										ruta_imagen_copia = ruta_archivos_exposicion + trim(ruta_copia) + tamanyo + "\" + trim(fichero_copia)
										ruta_imagen_destino = ruta_archivos_exposicion + trim(ruta_copia) + tamanyo + "\" + fichero_destino
										rtn = filecopy(ruta_imagen_copia, ruta_imagen_destino)
										*/
										m++
									Loop
									
								end if
							end if
						end if
						//****************************************************************************
						
						
						//Base para cada versión de color
						j2 = 1
						Do While j2 <= dw_bases.rowcount() and rtn = 1 
							base = dw_bases.object.codigo[j2]
							base_final = dw_bases.object.base_final[j2]
							INSERT INTO modelo_pieza_version (empresa, modelo, cliente, propuesta, pieza, version, base, base_final) 
							VALUES (:codigo_empresa, :padre_codigo, :cliente, :propuesta, :pieza, :version_pieza, :base, :base_final) using trans_ts;
							if trans_ts.SqlCode <> 0 then rtn = -1;
							
							j2++
						Loop
						
						maximo_codigo_p++
						maximo_pieza++
						j++
					Loop
				else
					//Borramos las bases que hubieran, puesto que el comercial puede haber actualizado las bases haciendo clic de nuevo en pasar a pieza
					DELETE FROM modelo_pieza_version 
					WHERE empresa = :codigo_empresa AND modelo = :padre_codigo AND cliente = :cliente AND propuesta = :propuesta AND version = :version_pieza using trans_ts;
					if trans_ts.SqlCode <> 0 then rtn = -1;
					if rtn = 1 then
						//Insertamos las bases indicadas por el comercial
						
						sel = "SELECT codigo FROM modelo_pieza WHERE empresa = '"+codigo_empresa+"' AND modelo = '"+padre_codigo+"' AND cliente = '"+cliente+"' AND propuesta = '"+propuesta+"'"
						f_cargar_cursor_transaccion (trans_ts,  piezas,  sel)
						numero_piezas = piezas.RowCount()
						j = 1
						Do While j <= numero_piezas and rtn = 1 
							pieza = piezas.object.codigo[j]
							UPDATE modelo_pieza 
							SET modelo_trabajo = :trabajo_pasar_pieza 
							WHERE empresa = :codigo_empresa 
							AND modelo = :padre_codigo 
							AND cliente = :cliente 
							AND propuesta = :propuesta 
							AND codigo = :pieza 
							using trans_ts;
							
							if trans_ts.SqlCode <> 0 then rtn = -1;
							j2 = 1
							Do While j2 <= dw_bases.rowcount() and rtn = 1 
								base = dw_bases.object.codigo[j2]	
								base_final = dw_bases.object.base_final[j2]
								INSERT INTO modelo_pieza_version (empresa, modelo, cliente, propuesta, pieza, version, base, base_final) 
								VALUES (:codigo_empresa, :padre_codigo, :cliente, :propuesta, :pieza, :version_pieza, :base, :base_final) using trans_ts;
								if trans_ts.SqlCode <> 0 then rtn = -1;
								j2++
							Loop
							j++
						Loop
						Destroy piezas
					end if
				end if
			end if
		
			if rtn = -1 then 
				messagebox("Atención", "Error al Pasar a Pieza")
			end if
		end if
	next
	if rtn = 1 then
		rtn = dw_trabajos.update() 
	end if
end if

//VERSIONES
if rtn = 1 then
	dw_versiones.setfilter("")
	dw_versiones.filter()
	for i = 1 to dw_versiones.RowCount()
		dw_versiones.object.modelo[i] = dw_1.object.#1[dw_1.getrow()]
	next
	rtn = dw_versiones.update() 
end if

//ARCHIVOS
if rtn = 1 then
	dw_archivos.setfilter("")
	dw_archivos.filter()
	for i = 1 to dw_archivos.RowCount()
		dw_archivos.object.modelo[i] = dw_1.object.#1[dw_1.getrow()]
	next
	rtn = dw_archivos.update() 
end if

if rtn = 1 then
	dw_bases_version_pieza.setfilter("")
	dw_bases_version_pieza.filter()
	rtn = dw_bases_version_pieza.update() 
end if

//FECHA COLECCIÓN
if rtn = 1 and not isnull(fecha_fin_trabajo) and (isnull(fecha_coleccion) or fecha_coleccion = datetime(date('1900-01-01'))) then
	update descoleccionsol 
	set fecha_coleccion = :fecha_fin_trabajo 
	where empresa = :codigo_empresa
	and codigo = :coleccion using trans_ts;
	
	if trans_ts.SqlCode <> 0 then rtn = -1;
end if


//GESTION CAMBIOS DE COLECCION 
if rtn = 1 and coleccion_antigua <> "" and coleccion_antigua <> coleccion then
	//Técnico laboratorio
	tecnico_lab_actual = ""
	SELECT tecnico_lab 
	INTO :tecnico_lab_actual 
	FROM descoleccionsol 
	WHERE empresa = :codigo_empresa AND codigo = :coleccion USING trans_ts;
		
	if isnull(tecnico_lab_actual) or tecnico_lab_actual = "" then		
		UPDATE descoleccionsol 
		SET tecnico_lab = :tecnico_lab_coleccion_antigua 
		WHERE empresa = :codigo_empresa AND codigo = :coleccion USING trans_ts;
		
		if trans_ts.SqlCode <> 0 then rtn = -1;
		if rtn = 1 then
			update tecnico_lab 
			set control = control + 1
			where empresa = :codigo_empresa
			and codigo = :tecnico_lab_coleccion_antigua using trans_ts;
			
			if trans_ts.SqlCode <> 0 then rtn = -1;
		end if
	end if
	
	//Actualización imágenes coleccion
	sel = "SELECT ruta, fichero, codigo "+&
			"FROM modelo_archivo_expo WHERE empresa = '"+codigo_empresa+"' "+&
			"AND modelo = '"+padre_codigo+"' "+&
			"AND coleccion = '"+coleccion_antigua+"' "
	f_cargar_cursor_transaccion (trans_ts,  archivos,  sel)
	numero_archivos = archivos.RowCount()
	i = 1
	ruta = ""
	fichero = "" 
	Do While i <= numero_archivos and rtn = 1 
		ruta = ruta_archivos_exposicion + trim(archivos.object.ruta[i])
		fichero = trim(archivos.object.fichero[i])
		codigo_archivo = trim(archivos.object.codigo[i])
		
		extension = mid(fichero, pos(fichero,"."))
		fichero_nuevo = coleccion+"-"+padre_codigo+"-"+codigo_archivo+extension
		
		rtn = filemove(ruta + fichero, ruta + fichero_nuevo)
		if rtn <> 1 then
			Messagebox("Error", "Se ha producido un error moviendo los archivos del modelo a la nuevo colección. Por favor, avise inmediatamente al administrador.")
		else
			//Movemos las imágenes generadas para cada tamaño
			sel = "SELECT * FROM archivo_resolucion WHERE empresa = '"+codigo_empresa+"'"
			f_cargar_cursor_transaccion (trans_ts,  tipos,  sel)
			numero_tipos = tipos.RowCount()
			j = 1
			Do While j <= numero_tipos and rtn = 1 
				tamanyo = tipos.object.tamanyo[j]
				ftc_tranformar_imagen_IM ( ruta, ruta + tamanyo + "\" , fichero_nuevo, tipos.object.resolucion[j], tamanyo, tipos.object.color[j])
				filedelete(ruta + tamanyo + "\" + fichero)
				//rtn = filemove(ruta + tamanyo + "\" + fichero, ruta + tamanyo + "\" + fichero_nuevo)
				j++
			Loop
			if rtn = 1 then
				UPDATE modelo_archivo_expo 
				SET coleccion = :coleccion, fichero = :fichero_nuevo 
				WHERE empresa = :codigo_empresa AND coleccion = :coleccion_antigua AND modelo = :padre_codigo and codigo = :codigo_archivo using trans_ts;
			else
				Messagebox("Error", "Se ha producido un error moviendo los archivos del modelo a la nuevo colección. Por favor, avise inmediatamente al administrador.")
			end if
			
		end if
		
		i++
	Loop
	
end if

/*---------------------------------------------------------------------------------------------------------------------------------
				   			FIN GRABACIÓN DATAWINDOWS AUXILIARES
---------------------------------------------------------------------------------------------------------------------------------*/
	
		
IF rtn = 1 THEN	
	COMMIT USING trans_ts;
	mostrar_controles_edicion()

	dw_1.setfocus()
	dw_1.setcolumn(2)
	
ELSE
	ROLLBACK USING trans_ts;
END IF
dw_1.SetTransObject(SQLCA)	
dw_clientes.SetTransObject(SQLCA)	
dw_propuestas.SetTransObject(SQLCA)	
dw_trabajos.SetTransObject(SQLCA)	
dw_versiones.SetTransObject(SQLCA)	
dw_piezas.SetTransObject(SQLCA)		
dw_archivos.SetTransObject(SQLCA)	
dw_con_piezas_coleccion.SetTransObject(SQLCA)
dw_bases_version_pieza.SetTransObject(SQLCA)
dw_referencias.SetTransObject(SQLCA)

Destroy tipos
Destroy archivos

estado = 1 // Modo edición


// Refrescar Datawindows después de guardar.
if rtn = 1 then
	dw_1.retrieve (codigo_empresa, padre_codigo)
	dw_clientes.retrieve (codigo_empresa, padre_codigo)	
	dw_propuestas.retrieve (codigo_empresa, padre_codigo)	
	dw_trabajos.retrieve (codigo_empresa, padre_codigo)	
	dw_versiones.retrieve (codigo_empresa, padre_codigo)	
	dw_piezas.retrieve (codigo_empresa, padre_codigo)	
	dw_archivos.retrieve (codigo_empresa, padre_codigo)	
	dw_bases_version_pieza.retrieve (codigo_empresa, padre_codigo)	
	dw_estructura.retrieve (codigo_empresa, padre_codigo)	
	dw_referencias.retrieve (codigo_empresa, padre_codigo)	
	//p_imagen.PictureName = f_cargar_imagen_nuevo(padre_codigo)
	f_cargar_imagen_expo()
	coleccion_nueva = dw_1.object.coleccion[dw_1.getrow()]
	if not isnull(coleccion_nueva) and coleccion_nueva <> '' then
		dw_con_piezas_coleccion.retrieve (codigo_empresa, coleccion_nueva)
	end if
	
	//seleccionar_fila_guardar(sel_cliente, sel_propuesta, sel_pieza, sel_version, sel_trabajo, sel_archivo)
else
	//seleccionar_fila_error(sel_cliente, sel_propuesta, sel_pieza, sel_version)
end if

seleccionar_por_codigo(cod_cliente, cod_propuesta, cod_pieza, cod_version, cod_trabajo, cod_archivo)
//seleccionar_fila_guardar(sel_cliente, sel_propuesta, sel_pieza, sel_version, sel_trabajo, sel_archivo)


return rtn
end function

public function integer f_borrar ();//SOBRESCRIBIMOS LA FUNCION DEL PADRE. NO LA LLMAMOS CON super::funcion()
str_ventana_alerta parametros
string sel, modelo, coleccion, ruta_papelera, ruta_borrado, ruta_origen, ruta_archivos_exposicion
long clientes, piezas, i, j, numero_archivos, numero_archivos_disenyo
string botones[2]
Datastore archivos, miniaturas

// Excepcion: Tengo que tomar el valor de la coleccion antes de borrar el datawindow dw_1. Al borrarlo da error por no contener ninguna fila. Hemos sobrescrito es script del padre.
coleccion = dw_1.object.coleccion[1]
modelo = dw_1.object.#1[dw_1.getrow()]

parametros.titulo = "Atención Borrado de Modelo"
parametros.subtitulo = "Borrar MODELO"
parametros.mensaje = "Atención, se borrarán también todos los archivos asociados, ¿Desea borrar el MODELO?"
parametros.tipo = 1
//parametros.botones = botones
parametros.mostrar_imagen = true
openwithparm(wtc_ventana_alerta, parametros)
borrar = Int(Message.DoubleParm)

rtn = 0
if borrar = 1 then
	padre_codigo = dw_1.object.#1[dw_1.GetRow()]
	coleccion = dw_1.object.coleccion[dw_1.GetRow()]
	
	SELECT ruta_archivos_exposicion 
	INTO :ruta_archivos_exposicion 
	FROM empresa 
	WHERE empresa = :codigo_empresa using trans_ts;
	
	//****************************************************************************************
	//Hay que comprobar si hay clientes asociados al modelo antes de borrar (SOLO COMERCIALES)
	clientes = dw_clientes.rowcount()
	SELECT isnull(COUNT(*), 0) INTO :clientes FROM modelo_cliente WHERE empresa = :codigo_empresa AND modelo = :padre_codigo USING trans_ts;
	SELECT isnull(COUNT(*), 0) INTO :numero_archivos_disenyo FROM  modelo_propuesta_sistema_archivos WHERE empresa = :codigo_empresa AND modelo = :padre_codigo USING trans_ts;
	if isnull(clientes) then 
		clientes = 0 
	end if
	if isnull(numero_archivos_disenyo) then
		numero_archivos_disenyo = 0 
	end if
	if numero_archivos_disenyo > 0 then
		if grupo_usuario <> "DISENYO" then
			MessageBox("Error","No es posible borrar un modelo si tiene ARCHIVOS DE DISEÑO asociados. Si desea borralo, avise al diseñador.")
			return -1
		end if
	end if
	//****************************************************************************************
	
	//ES POSIBLE BORRAR SOLO SI NO HAY PIEZAS
	piezas = 0
	SELECT COUNT(*) INTO :piezas FROM modelo_pieza WHERE empresa = :codigo_empresa AND modelo = :padre_codigo USING trans_ts;
	if piezas > 0 then
		MessageBox("Error","No es posible borrar un modelo si tiene piezas asociadas. Si desea borralo, elimine primero todos sus piezas.")
		return -1
	end if
	
	dw_1.SetTransObject(trans_ts)	
	
	rtn = dw_1.deleterow(0)
	if rtn = 1 then
		rtn = dw_1.update()
	end if
end if

if rtn = 1 then
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//   AQUÍ IRÁ EL CÓDIGO DE LOS DW AUXILIARES. CONTROLAR LOS BORRADOS CON rtn. 
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	DELETE FROM modelo_referencia WHERE empresa = :codigo_empresa AND modelo = :padre_codigo USING trans_ts;
	
	IF trans_ts.sqlcode <> 0 THEN
		MessageBox("Error Borrado", "No ha sido posible borrar el modelo. Error SQL: "+trans_ts.SQLErrText)
		rtn = -1
	END IF
	
	DELETE FROM modelo_trabajo WHERE empresa = :codigo_empresa AND modelo = :padre_codigo USING trans_ts;
	
	IF trans_ts.sqlcode <> 0 THEN
		MessageBox("Error Borrado", "No ha sido posible borrar el modelo. Error SQL: "+trans_ts.SQLErrText)
		rtn = -1
	END IF
	
	DELETE FROM modelo_propuesta WHERE empresa = :codigo_empresa AND modelo = :padre_codigo USING trans_ts;
	
	IF trans_ts.sqlcode <> 0 THEN
		MessageBox("Error Borrado", "No ha sido posible borrar el modelo. Error SQL: "+trans_ts.SQLErrText)
		rtn = -1
	END IF
	
	DELETE FROM modelo_cliente WHERE empresa = :codigo_empresa AND modelo = :padre_codigo USING trans_ts;
	
	IF trans_ts.sqlcode <> 0 THEN
		MessageBox("Error Borrado", "No ha sido posible borrar el modelo. Error SQL: "+trans_ts.SQLErrText)
		rtn = -1
	END IF
	
	ruta_papelera = ""
	SELECT ruta_papelera_disenyo INTO :ruta_papelera FROM empresas WHERE empresa = :codigo_empresa using trans_ts;
	IF trans_ts.SQLCode <> 0 THEN         
		MessageBox("SQL error", trans_ts.SQLErrText +" No se ha podido realizar encontrar la ruta de la papelera de reciclaje: "+String(trans_ts.SQLDBCode))
		rtn = -1
	END IF
	
	if isnull(ruta_papelera) or ruta_papelera = "" then
		MessageBox("Error Borrado", " No se ha definido una ruta para la papelera de reciclaje.")
		rtn = -1
	end if
	
	if rtn = 1 then
		//**********************************************************************
		//PROCESO DE BORRADO DE IMÁGENES DEL MODELO
		sel = "SELECT ruta, fichero FROM modelo_archivo_expo WHERE empresa = '"+codigo_empresa+"' AND modelo = '"+padre_codigo+"'"
		f_cargar_cursor_transaccion (trans_ts,  archivos,  sel)
		numero_archivos = archivos.rowcount()
		For i = 1 To numero_archivos
			ruta_origen = trim(ruta_archivos_exposicion) + trim(String(archivos.object.ruta[i]))+trim(String(archivos.object.fichero[i]))
			ruta_borrado = ruta_papelera +  "old_" + String(Today(), "dd_mm_yy") + "_" + String(Now(), "hh_mm_ss") + "_" + trim(String(trim(String(archivos.object.fichero[i]))))
			FileMove(ruta_origen, ruta_borrado)
			//FileDelete(trim(String(archivos.object.ruta[i]))+trim(String(archivos.object.fichero[i])))
			//**********************************************************************
			//PROCESO DE BORRADO DE IMÁGENES DE CADA TAMAÑO EXISTENTE
			sel = "SELECT * FROM archivo_resolucion WHERE empresa = '"+codigo_empresa+"'"
			f_cargar_cursor_transaccion (trans_ts,  miniaturas,  sel)
			For j = 1 To miniaturas.RowCount()
				ruta_origen = trim(ruta_archivos_exposicion) + trim(String(archivos.object.ruta[i]))+miniaturas.object.tamanyo[j]+"\"+trim(String(archivos.object.fichero[i]))
				FileDelete(ruta_origen)
			Next
			Destroy miniaturas
			//FIN PROCESO DE BORRADO DE IMÁGENES DE CADA TAMAÑO EXISTENTE
			//**********************************************************************
		Next
		Destroy archivos
		DELETE FROM modelo_archivo_expo WHERE empresa = :codigo_empresa AND modelo = :padre_codigo USING trans_ts;
		IF trans_ts.sqlcode <> 0 THEN
			MessageBox("Error Borrado", "No ha sido posible borrar el modelo. Error SQL: "+trans_ts.SQLErrText)
			rtn = -1
		END IF	
		//FIN PROCESO DE BORRADO DE IMÁGENES DEL MODELO
		//**********************************************************************
		
		//**********************************************************************
		//PROCESO DE BORRADO DE ARCHIVOS DEL MODELO
		sel = "SELECT * FROM modelo_propuesta_sistema_archivos WHERE empresa = '"+codigo_empresa+"' AND modelo = '"+padre_codigo+"'"
		f_cargar_cursor_transaccion (trans_ts,  archivos,  sel)
		numero_archivos = archivos.rowcount()
		For i = 1 To numero_archivos
			ruta_origen = trim(ruta_archivos_exposicion) + trim(String(archivos.object.ruta[i]))+trim(String(archivos.object.fichero[i]))
			ruta_borrado = ruta_papelera +  "old_" + String(Today(), "dd_mm_yy") + "_" + String(Now(), "hh_mm_ss") + "_" + trim(String(trim(String(archivos.object.fichero[i]))))
			FileMove(ruta_origen, ruta_borrado)
			//FileDelete(trim(String(archivos.object.ruta[i]))+trim(String(archivos.object.fichero[i])))
		Next
		Destroy archivos
		DELETE FROM modelo_propuesta_sistema_archivos WHERE empresa = :codigo_empresa AND modelo = :padre_codigo USING trans_Ts;
		IF trans_Ts.sqlcode <> 0 THEN
			MessageBox("Error Borrado", "No ha sido posible borrar el modelo. Error SQL: "+trans_Ts.SQLErrText)
			rtn = -1
		END IF	
		//FIN PROCESO DE BORRADO DE ARCHIVOS DEL MODELO
		//**********************************************************************
	end if
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	if rtn = 1 then
		COMMIT USING trans_ts;
		dw_1.SetTransObject(SQLCA)	
		destroy archivos
		pb_nuevo.TriggerEvent(Clicked!)	
		mostrar_controles_insercion()
		dw_1.setfocus()
		dw_1.setcolumn(2)
		estado = 0 // Modo Insercion
		dw_imagen.visible = false
		MessageBox("Borrado Completo", "No olvide borrar las posibles imágenes del modelo que pueda haber en en la colección "+coleccion)
	ELSE
		ROLLBACK USING trans_ts;
		dw_1.SetTransObject(SQLCA)	
		destroy archivos
//		dw_1.object.coleccion[1] = coleccion
		dw_1.object.#1[1] = modelo
		pb_cancelar.triggerevent(Clicked!)
	
	END IF
end if

return rtn
end function

public subroutine mostrar_controles_insercion ();cb_generar_pieza.visible = false
cb_generar_coleccion.visible = false

super::mostrar_controles_insercion()
end subroutine

public subroutine mostrar_controles_edicion ();cb_generar_pieza.visible = true
cb_generar_coleccion.visible = true

super::mostrar_controles_edicion()
end subroutine

public subroutine seleccionar_fila (datawindow dw, integer fila, integer columna);if fila > 0 then //and fila <> dw.getselectedrow(0) then
	dw.SetRow (fila)
	dw.scrolltorow(fila)
	if columna <> 0 then
		dw.SetColumn(columna)
	end if
	dw.event rowfocuschanged(fila)
end if
end subroutine

public subroutine seleccionar_fila_guardar (integer sel_cliente, integer sel_propuesta, integer sel_pieza, integer sel_version, integer sel_trabajo, integer sel_archivo);dw_clientes.setredraw(false)
dw_propuestas.setredraw(false)
dw_piezas.setredraw(false)
dw_versiones.setredraw(false)
dw_trabajos.setredraw(false)
dw_archivos.setredraw(false)
dw_bases_version_pieza.setredraw(false)
dw_imagen_pieza.setredraw(false)

//dw_clientes.setrow(sel_cliente)
//dw_propuestas.setrow(sel_propuesta)
//dw_piezas.setrow(sel_pieza)
//dw_versiones.setrow(sel_version)

seleccionar_fila(dw_clientes,sel_cliente,0)
seleccionar_fila(dw_propuestas,sel_propuesta,0)
seleccionar_fila(dw_piezas,sel_pieza,0)
seleccionar_fila(dw_piezas,sel_version,0)

dw_trabajos.setrow(sel_trabajo)
dw_archivos.setrow(sel_archivo)

dw_clientes.setredraw(true)
dw_propuestas.setredraw(true)
dw_piezas.setredraw(true)
dw_versiones.setredraw(true)
dw_trabajos.setredraw(true)
dw_archivos.setredraw(true)
dw_bases_version_pieza.setredraw(true)
dw_imagen_pieza.setredraw(true)
end subroutine

public subroutine f_cargar_imagen_expo2 ();string codigo_archivo, codigo_coleccion, modelo, ruta, tamanyo
Long min_codigo_archivo

SELECT tamanyo INTO :tamanyo FROM archivo_resolucion WHERE empresa = :codigo_empresa AND codigo = 1;

dw_ficha_comercial.object.p_1.visible = false // para evitar efectos raros en pantalla.

codigo_coleccion = dw_1.object.coleccion[dw_1.getrow()]
modelo = f_codigo_principal()

if not isnull(codigo_coleccion) and codigo_coleccion <> "" and not isnull(modelo) and modelo <> "" then
	
	ruta = ftc_imagen_ruta("1",codigo_coleccion,modelo,"")

	if ruta <> "" then	
		dw_ficha_comercial.object.p_1.filename =  ruta
		dw_ficha_comercial.object.p_1.visible = TRUE
	else
		dw_ficha_comercial.object.p_1.visible = FALSE
	end if
else
	dw_ficha_comercial.object.p_1.visible = FALSE
end if

end subroutine

private subroutine f_cargar_imagen_expo ();string codigo_coleccion, modelo
Long min_codigo_archivo

codigo_coleccion = dw_1.object.coleccion[dw_1.getrow()]
modelo = f_codigo_principal()

if not isnull(codigo_coleccion) and codigo_coleccion <> "" and not isnull(modelo) and modelo <> "" then
	ftc_imagen_fondo_datawindow(dw_imagen,"1",codigo_coleccion,modelo,"")
end if
end subroutine

public subroutine seleccionar_fila_error (integer fila_cliente, integer fila_propuesta, integer fila_pieza, integer fila_version, integer fila_cliente_actual, integer fila_propuesta_actual, integer fila_pieza_actual, integer fila_version_actual);Long propuesta_marcada, pieza_marcada, version_marcada

dw_clientes.setredraw(false)
dw_propuestas.setredraw(false)
dw_piezas.setredraw(false)
dw_versiones.setredraw(false)
dw_trabajos.setredraw(false)
dw_archivos.setredraw(false)
dw_bases_version_pieza.setredraw(false)
dw_imagen_pieza.setredraw(false)

if fila_cliente > 0 then
	if fila_cliente <> fila_cliente_actual then
		//dw_clientes.setrow(fila_cliente)
		seleccionar_fila(dw_clientes,fila_cliente,0)
	end if
else
	seleccionar_fila(dw_clientes,fila_cliente_actual,0)
end if

propuesta_marcada = dw_propuestas.getrow()
if fila_propuesta > 0 then
	if (fila_cliente <> fila_cliente_actual or propuesta_marcada <> fila_propuesta) then
		//dw_propuestas.setrow(fila_propuesta)
		seleccionar_fila(dw_propuestas,fila_propuesta,0)
	end if
else
	seleccionar_fila(dw_propuestas,fila_propuesta_actual,0)
end if

propuesta_marcada = dw_propuestas.getrow()
pieza_marcada = dw_piezas.getrow()
if fila_pieza > 0 then
	if (fila_cliente <> fila_cliente_actual or propuesta_marcada <> fila_propuesta or pieza_marcada <> fila_pieza) then
		//dw_piezas.setrow(fila_pieza)
		seleccionar_fila(dw_piezas,fila_pieza,0)
	end if
else
	seleccionar_fila(dw_piezas,fila_pieza_actual,0)
end if

propuesta_marcada = dw_propuestas.getrow()
version_marcada = dw_versiones.getrow()
if fila_version > 0 then 
	if (fila_cliente <> fila_cliente_actual or  propuesta_marcada <> fila_propuesta or version_marcada <> fila_version) then
		//dw_piezas.setrow(fila_pieza)
		seleccionar_fila(dw_versiones,fila_version,0)
	end if
else
	seleccionar_fila(dw_versiones,fila_version_actual,0)
end if

dw_clientes.setredraw(true)
dw_propuestas.setredraw(true)
dw_piezas.setredraw(true)
dw_versiones.setredraw(true)
dw_trabajos.setredraw(true)
dw_archivos.setredraw(true)
dw_bases_version_pieza.setredraw(true)
dw_imagen_pieza.setredraw(true)
end subroutine

public subroutine seleccionar_por_codigo (string cliente, string propuesta, string pieza, string version_color, string trabajo, string archivo);Long fila

dw_clientes.setredraw(false)
dw_propuestas.setredraw(false)
dw_piezas.setredraw(false)
dw_versiones.setredraw(false)
dw_trabajos.setredraw(false)
dw_archivos.setredraw(false)
dw_bases_version_pieza.setredraw(false)
dw_imagen_pieza.setredraw(false)

if dw_clientes.rowcount() >= 1 then
	fila = dw_clientes.Find("cliente = '"+cliente + "'", 1, dw_clientes.rowcount())
	if fila > 0 then
		seleccionar_fila(dw_clientes, fila, 0)
	end if
end if

if dw_propuestas.rowcount() >= 1 then
	fila = dw_propuestas.Find("modelo_propuesta_codigo = '"+propuesta + "'", 1, dw_propuestas.rowcount())
	if fila > 0 then
		seleccionar_fila(dw_propuestas, fila, 0)
	end if
end if

if dw_piezas.rowcount() >= 1 then
	fila = dw_piezas.Find("codigo = '"+pieza + "'", 1, dw_piezas.rowcount())
	if fila > 0 then
		seleccionar_fila(dw_piezas, fila, 0)
	end if
end if

if dw_versiones.rowcount() >= 1 then
	fila = dw_versiones.Find("codigo = '"+version_color + "'", 1, dw_versiones.rowcount())
	if fila > 0 then
		seleccionar_fila(dw_versiones, fila, 0)
	end if
end if

if dw_trabajos.rowcount() >= 1 then
	fila = dw_trabajos.Find("modelo_trabajo_codigo = '"+trabajo + "'", 1, dw_trabajos.rowcount())
	if fila > 0 then
		dw_trabajos.setrow(fila)
	end if
end if

if dw_archivos.rowcount() >= 1 then
	fila = dw_archivos.Find("codigo = '"+archivo + "'", 1, dw_archivos.rowcount())
	if fila > 0 then
		dw_archivos.setrow(fila)
	end if
end if

dw_clientes.setredraw(true)
dw_propuestas.setredraw(true)
dw_piezas.setredraw(true)
dw_versiones.setredraw(true)
dw_trabajos.setredraw(true)
dw_archivos.setredraw(true)
dw_bases_version_pieza.setredraw(true)
dw_imagen_pieza.setredraw(true)
end subroutine

on wtc_trabajos_disenyo_nuevo.create
int iCurrent
call super::create
this.pb_borrar_trabajo=create pb_borrar_trabajo
this.pb_duplica_trabajo=create pb_duplica_trabajo
this.pb_anyade_trabajo=create pb_anyade_trabajo
this.st_2=create st_2
this.cb_generar_pieza=create cb_generar_pieza
this.cb_generar_coleccion=create cb_generar_coleccion
this.dw_ficha_comercial=create dw_ficha_comercial
this.pb_anyade_archivo=create pb_anyade_archivo
this.pb_borrar_archivo=create pb_borrar_archivo
this.pb_anyade_propuesta=create pb_anyade_propuesta
this.pb_borrar_propuesta=create pb_borrar_propuesta
this.pb_anyade_cliente=create pb_anyade_cliente
this.pb_quitar_cliente=create pb_quitar_cliente
this.dw_clientes=create dw_clientes
this.dw_archivos=create dw_archivos
this.dw_con_piezas_coleccion=create dw_con_piezas_coleccion
this.pb_2=create pb_2
this.p_seleccion=create p_seleccion
this.pb_archivos_modelo=create pb_archivos_modelo
this.cb_tr=create cb_tr
this.dw_imagen=create dw_imagen
this.pb_3=create pb_3
this.dw_imp_lab=create dw_imp_lab
this.dw_fecha_necesidad=create dw_fecha_necesidad
this.dw_versiones=create dw_versiones
this.pb_anyade_version=create pb_anyade_version
this.pb_borrar_version=create pb_borrar_version
this.dw_bases_version_pieza=create dw_bases_version_pieza
this.popup_versiones=create popup_versiones
this.cb_popup_versiones=create cb_popup_versiones
this.pb_bases_mas=create pb_bases_mas
this.pb_bases_menos=create pb_bases_menos
this.dw_bases=create dw_bases
this.dw_piezas=create dw_piezas
this.dw_imagen_pieza=create dw_imagen_pieza
this.st_imagen_pieza=create st_imagen_pieza
this.st_produccion=create st_produccion
this.pb_estructura_archivos=create pb_estructura_archivos
this.dw_trabajos=create dw_trabajos
this.cb_marcar_no_produccion=create cb_marcar_no_produccion
this.cb_borrar_marcados=create cb_borrar_marcados
this.dw_estructura=create dw_estructura
this.cb_marcar_todo=create cb_marcar_todo
this.cb_4=create cb_4
this.st_guardar=create st_guardar
this.dw_propuestas=create dw_propuestas
this.pb_1=create pb_1
this.pb_4=create pb_4
this.dw_referencias=create dw_referencias
this.cb_1=create cb_1
this.dw_actualizar_base=create dw_actualizar_base
this.cb_2=create cb_2
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.pb_borrar_trabajo
this.Control[iCurrent+2]=this.pb_duplica_trabajo
this.Control[iCurrent+3]=this.pb_anyade_trabajo
this.Control[iCurrent+4]=this.st_2
this.Control[iCurrent+5]=this.cb_generar_pieza
this.Control[iCurrent+6]=this.cb_generar_coleccion
this.Control[iCurrent+7]=this.dw_ficha_comercial
this.Control[iCurrent+8]=this.pb_anyade_archivo
this.Control[iCurrent+9]=this.pb_borrar_archivo
this.Control[iCurrent+10]=this.pb_anyade_propuesta
this.Control[iCurrent+11]=this.pb_borrar_propuesta
this.Control[iCurrent+12]=this.pb_anyade_cliente
this.Control[iCurrent+13]=this.pb_quitar_cliente
this.Control[iCurrent+14]=this.dw_clientes
this.Control[iCurrent+15]=this.dw_archivos
this.Control[iCurrent+16]=this.dw_con_piezas_coleccion
this.Control[iCurrent+17]=this.pb_2
this.Control[iCurrent+18]=this.p_seleccion
this.Control[iCurrent+19]=this.pb_archivos_modelo
this.Control[iCurrent+20]=this.cb_tr
this.Control[iCurrent+21]=this.dw_imagen
this.Control[iCurrent+22]=this.pb_3
this.Control[iCurrent+23]=this.dw_imp_lab
this.Control[iCurrent+24]=this.dw_fecha_necesidad
this.Control[iCurrent+25]=this.dw_versiones
this.Control[iCurrent+26]=this.pb_anyade_version
this.Control[iCurrent+27]=this.pb_borrar_version
this.Control[iCurrent+28]=this.dw_bases_version_pieza
this.Control[iCurrent+29]=this.popup_versiones
this.Control[iCurrent+30]=this.cb_popup_versiones
this.Control[iCurrent+31]=this.pb_bases_mas
this.Control[iCurrent+32]=this.pb_bases_menos
this.Control[iCurrent+33]=this.dw_bases
this.Control[iCurrent+34]=this.dw_piezas
this.Control[iCurrent+35]=this.dw_imagen_pieza
this.Control[iCurrent+36]=this.st_imagen_pieza
this.Control[iCurrent+37]=this.st_produccion
this.Control[iCurrent+38]=this.pb_estructura_archivos
this.Control[iCurrent+39]=this.dw_trabajos
this.Control[iCurrent+40]=this.cb_marcar_no_produccion
this.Control[iCurrent+41]=this.cb_borrar_marcados
this.Control[iCurrent+42]=this.dw_estructura
this.Control[iCurrent+43]=this.cb_marcar_todo
this.Control[iCurrent+44]=this.cb_4
this.Control[iCurrent+45]=this.st_guardar
this.Control[iCurrent+46]=this.dw_propuestas
this.Control[iCurrent+47]=this.pb_1
this.Control[iCurrent+48]=this.pb_4
this.Control[iCurrent+49]=this.dw_referencias
this.Control[iCurrent+50]=this.cb_1
this.Control[iCurrent+51]=this.dw_actualizar_base
this.Control[iCurrent+52]=this.cb_2
end on

on wtc_trabajos_disenyo_nuevo.destroy
call super::destroy
if IsValid(MenuID) then destroy(MenuID)
destroy(this.pb_borrar_trabajo)
destroy(this.pb_duplica_trabajo)
destroy(this.pb_anyade_trabajo)
destroy(this.st_2)
destroy(this.cb_generar_pieza)
destroy(this.cb_generar_coleccion)
destroy(this.dw_ficha_comercial)
destroy(this.pb_anyade_archivo)
destroy(this.pb_borrar_archivo)
destroy(this.pb_anyade_propuesta)
destroy(this.pb_borrar_propuesta)
destroy(this.pb_anyade_cliente)
destroy(this.pb_quitar_cliente)
destroy(this.dw_clientes)
destroy(this.dw_archivos)
destroy(this.dw_con_piezas_coleccion)
destroy(this.pb_2)
destroy(this.p_seleccion)
destroy(this.pb_archivos_modelo)
destroy(this.cb_tr)
destroy(this.dw_imagen)
destroy(this.pb_3)
destroy(this.dw_imp_lab)
destroy(this.dw_fecha_necesidad)
destroy(this.dw_versiones)
destroy(this.pb_anyade_version)
destroy(this.pb_borrar_version)
destroy(this.dw_bases_version_pieza)
destroy(this.popup_versiones)
destroy(this.cb_popup_versiones)
destroy(this.pb_bases_mas)
destroy(this.pb_bases_menos)
destroy(this.dw_bases)
destroy(this.dw_piezas)
destroy(this.dw_imagen_pieza)
destroy(this.st_imagen_pieza)
destroy(this.st_produccion)
destroy(this.pb_estructura_archivos)
destroy(this.dw_trabajos)
destroy(this.cb_marcar_no_produccion)
destroy(this.cb_borrar_marcados)
destroy(this.dw_estructura)
destroy(this.cb_marcar_todo)
destroy(this.cb_4)
destroy(this.st_guardar)
destroy(this.dw_propuestas)
destroy(this.pb_1)
destroy(this.pb_4)
destroy(this.dw_referencias)
destroy(this.cb_1)
destroy(this.dw_actualizar_base)
destroy(this.cb_2)
end on

event open;String cliente, grupo
Long fila, fila_cliente
str_parametros lstr_param
int produccion

cerrar_sin_abrir = false

////PERMISOS NUEVOS
//String nombre_ventana
//nombre_ventana = this.ClassName()
//SELECT P.permiso INTO :permiso_ventana 
//FROM uti_permisos_ventana P 
//INNER JOIN uti_ventana V ON P.ventana = V.codigo AND P.empresa = V.empresa 
//WHERE P.empresa = :codigo_empresa AND V.nombre = :nombre_ventana AND P.usuario = :nombre_usuario;
//
//If permiso_ventana = 0 then
//	MESSAGEBOX("Atención. Consulte con el Administrador",nombre_usuario+", No tienes Acceso a este programa")
//	cerrar_sin_abrir = true
//elseif permiso_ventana = 1 then
//	//Solo lectura
//	pb_grabar.visible = false
//	pb_borrar.visible = false
//elseif permiso_ventana = 2 then
//	//OK acceso total
//	
//else
//	//Opción no contemplada -> Salir
//	MESSAGEBOX("Atención. Consulte con el Administrador",nombre_usuario+", No tienes Acceso a este programa")
//	cerrar_sin_abrir = true
//end if
//
//if cerrar_sin_abrir = true then
//	this.Post Event ue_cerrar_sin_abrir()
//else

	//Obtener grupo para saber si disenyo o laboratorio
	grupo_usuario = ""
	SELECT utigrupos.descripcion INTO :grupo_usuario 
	FROM usuarios 
	INNER JOIN utigrupos ON usuarios.v_grupo = utigrupos.codigo 
	WHERE v_usuario = :nombre_usuario;
	
	if grupo_usuario = "INFORMATICA" then
		cb_tr.visible = true
		pb_estructura_archivos.visible = true
	else
		if grupo_usuario = "DISENYO" or grupo_usuario = "LABORATORIO" then
			pb_estructura_archivos.visible = true
		end if
		cb_tr.visible = false
	end if
	
	dw_1.SetTransObject(SQLCA)
	
	pb_nuevo.triggerevent(clicked!)
	
	mostrar_controles_insercion()
	
	select nombre
	into :st_titulo.text
	from empresas
	where empresa = :codigo_empresa;
	
	// Si recibo el codigo lo visualizo
	lstr_param = Message.PowerObjectParm
	
	nombre_ventana_invoca = lstr_param.s_titulo_ventana
	IF lstr_param.i_nargumentos >= 1 THEN
		ventana_invoca = lstr_param.nombre_ventana
		if not isnull(lstr_param.s_argumentos[1]) and lstr_param.s_argumentos[1] <> "" then
			padre_codigo = lstr_param.s_argumentos[1]
			if dw_1.retrieve (codigo_empresa, lstr_param.s_argumentos[1]) <> 1 then
				padre_codigo = ""
				pb_nuevo.triggerevent(clicked!)
				mostrar_controles_insercion()
			else
				estado = 1 // Modo edición
				mostrar_controles_edicion()
			end if
		end if
		//referencias
		if lstr_param.i_nargumentos = 2 then
			
		end if
	END IF
	
	dw_1.SetFocus()
	
	This.Title = "Trabajos Diseño"
	
	dw_trabajos.SetTransObject(SQLCA)
	//dw_trabajos.SetRowFocusIndicator(p_seleccion)
	dw_con_piezas_coleccion.SetTransObject(SQLCA)
	dw_clientes.SetTransObject(SQLCA)
	//dw_clientes.marcar_filas = true
	dw_clientes.SetRowFocusIndicator(p_seleccion, 0, 3)
	dw_propuestas.SetTransObject(SQLCA)
	//dw_propuestas.marcar_filas = true
	dw_propuestas.SetRowFocusIndicator(p_seleccion, 0, 3)
	dw_versiones.SetTransObject(SQLCA)
	dw_versiones.SetRowFocusIndicator(p_seleccion, 0, 3)
	//dw_versiones.marcar_filas = true
	dw_piezas.SetTransObject(SQLCA)
	//dw_piezas.marcar_filas = true
	dw_piezas.SetRowFocusIndicator(p_seleccion, 0, 3)
	dw_archivos.SetTransObject(SQLCA)
	dw_bases_version_pieza.SetTransObject(SQLCA)
	dw_bases.SetTransObject(SQLCA)
	dw_fecha_necesidad.visible = false
	popup_versiones.SetTransObject(SQLCA)
	dw_ficha_comercial.SetTransObject(SQLCA)
	dw_estructura.SetTransObject(SQLCA)
	dw_referencias.SetTransObject(SQLCA)
	dw_actualizar_base.SetTransObject(SQLCA)
	
	if padre_codigo <> "" then
		dw_clientes.SetRedraw(false)
		dw_propuestas.SetRedraw(false)	
		dw_trabajos.SetRedraw(false)	
		dw_versiones.SetRedraw(false)	
		dw_piezas.SetRedraw(false)	
		dw_archivos.SetRedraw(false)
		dw_clientes.retrieve (codigo_empresa, padre_codigo)	
		dw_propuestas.retrieve (codigo_empresa, padre_codigo)	
		dw_trabajos.retrieve (codigo_empresa, padre_codigo)	
		dw_versiones.retrieve (codigo_empresa, padre_codigo)	
		dw_piezas.retrieve (codigo_empresa, padre_codigo)	
		dw_archivos.retrieve (codigo_empresa, padre_codigo)	
		dw_bases_version_pieza.retrieve (codigo_empresa, padre_codigo)	
		//p_imagen.PictureName = f_cargar_imagen_nuevo(padre_codigo)
		dw_estructura.retrieve (codigo_empresa, padre_codigo)	
		dw_referencias.retrieve (codigo_empresa, padre_codigo)	
		f_cargar_imagen_expo()
		
		if not isnull(dw_1.object.coleccion[dw_1.getrow()] ) and dw_1.object.coleccion[dw_1.getrow()] <> '' then
			dw_con_piezas_coleccion.retrieve(codigo_empresa, dw_1.object.coleccion[dw_1.getrow()])	
			if dw_con_piezas_coleccion.rowcount() > 0 then
				fila = dw_con_piezas_coleccion.Find("modelo_modelo = '"+padre_codigo+"'", 1, dw_con_piezas_coleccion.rowcount())
				if fila > 0 then
					dw_con_piezas_coleccion.scrolltorow(fila)
					dw_con_piezas_coleccion.setrow(fila)
				end if
			end if
		end if
		estado = 1
		
		if lstr_param.i_nargumentos >= 4 then
			fila = dw_clientes.Find("cliente = '"+lstr_param.s_argumentos[2]+"'",1,dw_clientes.rowcount())
			seleccionar_fila (dw_clientes,fila,0)
			fila = dw_propuestas.Find("modelo_propuesta_codigo = '"+lstr_param.s_argumentos[3]+"'",1,dw_propuestas.rowcount())
			seleccionar_fila (dw_propuestas,fila,0)
			fila = dw_piezas.Find("codigo = '"+lstr_param.s_argumentos[4]+"'",1,dw_piezas.rowcount())
			seleccionar_fila (dw_piezas,fila,0)
		else
			//Filtros para mostrar lo último realizado al seleccionar un modelo
			fila_cliente = 0
			IF lstr_param.i_nargumentos >= 2 and not isnull(lstr_param.s_argumentos[2]) and lstr_param.s_argumentos[2] <> "" then
				if dw_clientes.rowcount() > 0 then
					fila_cliente = dw_clientes.Find("cliente = '"+lstr_param.s_argumentos[2]+"'",1,dw_clientes.rowcount())
				end if
			else
				fila_cliente = dw_clientes.rowcount()
				cliente = dw_clientes.object.cliente[dw_clientes.rowcount()]
			end if
			seleccionar_fila (dw_clientes,fila_cliente,0)
		end if
		
		dw_clientes.SetRedraw(true)
		dw_propuestas.SetRedraw(true)	
		dw_trabajos.SetRedraw(true)	
		dw_versiones.SetRedraw(true)	
		dw_piezas.SetRedraw(true)	
		dw_archivos.SetRedraw(true)
		
		//En producción
		produccion = 0
		SELECT COUNT(*) INTO :produccion FROM articulos WHERE empresa = :codigo_empresa AND modelo_origen = :padre_codigo using sqlca;
		if produccion > 0 then
			st_produccion.visible = true
		else
			st_produccion.visible = false
		end if
		
	end if
//end if
end event

event activate;call super::activate;wtc_trabajos_disenyo_nuevo = ventanas_activas[id_ventana_activa].ventana

if permiso_ventana = 1 then
	//Solo lectura
	pb_grabar.visible = false
	pb_borrar.visible = false
end if





end event

type pb_imprimir from wt_ventana_padre`pb_imprimir within wtc_trabajos_disenyo_nuevo
integer x = 672
integer y = 96
end type

event pb_imprimir::clicked;Boolean imprimir
String trabajo, cliente, propuesta, modelo

//Solo se puede imprimir en modo edicion
if estado = 1 then
	imprimir = true
	if hay_cambios() then
		if MessageBox("Atención","¿Desea guardar los cambios antes de imprimir?",Question!,YesNo!,1) = 1 then
			if f_guardar() <> 1 then 
				imprimir = false
			end if
		end if	
	end if
	
	if imprimir = true and dw_trabajos.Getrow() > 0 then 
		modelo = f_codigo_principal()
		cliente = dw_trabajos.object.modelo_trabajo_cliente[dw_trabajos.Getrow()]
		propuesta = dw_trabajos.object.modelo_trabajo_propuesta[dw_trabajos.Getrow()]
		trabajo = dw_trabajos.object.modelo_trabajo_codigo[dw_trabajos.Getrow()]
		
		dw_ficha_comercial.retrieve(codigo_empresa, modelo, trabajo, cliente, propuesta)
		//dw_ficha_comercial.object.p_1.filename = f_cargar_imagen_nuevo(padre_codigo)
		f_cargar_imagen_expo2()
		
		f_imprimir_datawindow(dw_ficha_comercial)
		
	end if
end if
end event

type p_logo from wt_ventana_padre`p_logo within wtc_trabajos_disenyo_nuevo
integer x = 5271
integer y = 4
end type

type dw_1 from wt_ventana_padre`dw_1 within wtc_trabajos_disenyo_nuevo
integer x = 37
integer y = 236
integer width = 3890
integer height = 508
integer taborder = 10
string dataobject = "dwtc_modelo"
boolean border = false
end type

event dw_1::usr_keydown;call super::usr_keydown;string campo
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda

if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "funcion"
			busqueda.titulo_ventana = "Búsqueda de Función"
			busqueda.consulta  = " SELECT art_grupo2.codigo, art_grupo2.descripcion "+&
										" FROM art_grupo2 "+&
										" WHERE empresa = '"+codigo_empresa+"' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Función de la Pieza "
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				dw_1.object.funcion[dw_1.GetRow()] 							= resultado.valores[1]		// Devuelve el valor que encuentra ...
				dw_1.object.art_grupo2_descripcion[dw_1.GetRow()] 		= resultado.valores[2]		// Devuelve el valor que encuentra ...
				dw_1.Modify("art_grupo2_descripcion.Background.Color  = "+ftc_control_color_descripcion(0))			
			end if
			
		CASE "tecnico_dis"
			busqueda.titulo_ventana = "Búsqueda de Diseñador"
			busqueda.consulta  = "SELECT CODIGO, DESCRIPCION FROM TECNICO_DIS WHERE EMPRESA = '"+codigo_empresa+"' and activo = 'S' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Diseñador"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				dw_1.object.tecnico_dis[dw_1.GetRow()] 							= resultado.valores[1]			// Devuelve el valor que encuentra ...
				dw_1.object.tecnico_dis_descripcion[dw_1.GetRow()] 	= resultado.valores[2]			// Devuelve el valor que encuentra ...
				dw_1.Modify("tecnico_dis_descripcion.Background.Color  = "+ftc_control_color_descripcion(0))			
			end if		
			
		CASE "comercial"
			busqueda.titulo_ventana = "Búsqueda de Comercial"
			busqueda.consulta  = "SELECT CODIGO, DESCRIPCION FROM comercial WHERE EMPRESA = '"+codigo_empresa+"' and activo = '1' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Comercial"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				dw_1.object.comercial[dw_1.GetRow()] 					= resultado.valores[1]			// Devuelve el valor que encuentra ...
				dw_1.object.comercial_descripcion[dw_1.GetRow()] 	= resultado.valores[2]			// Devuelve el valor que encuentra ...
				dw_1.Modify("comercial_descripcion.Background.Color  = "+ftc_control_color_descripcion(0))			
			end if	
			
		CASE "relieve"
			Open(wtc_ayuda_busqueda_relieves)
			resultado = Message.PowerObjectParm
			if resultado.resultado = -1 then
				MessageBox("Error en la creación de la búsqueda",resultado.error)
			elseif resultado.resultado >= 2 then
				this.object.relieve[this.getrow()] = resultado.valores[1]
				this.object.art_tipomoldura_descripcion_1[this.getrow()] = resultado.valores[2]
			end if
	END CHOOSE
end if	
	

end event

event dw_1::clicked;call super::clicked;str_parametros lstr_param
long esta_abierta

this.accepttext()

CHOOSE CASE dwo.name
	CASE "p_coleccion"
		esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_coleccion2")
		//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
		if esta_abierta = -1 then
			lstr_param.s_argumentos[1] = this.object.coleccion[row]
			lstr_param.i_nargumentos = 1
			lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
			lstr_param.resultado = ''
			Openwithparm(wtc_mant_coleccion2, lstr_param)
		else
			ventanas_activas[esta_abierta].ventana.BringToTop = true
		end if

		CASE "p_disenyador"
		esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_disenyador")
		//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
		if esta_abierta = -1 then
			lstr_param.s_argumentos[1] = this.object.tecnico_dis[row]
			lstr_param.i_nargumentos = 1
			lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
			lstr_param.resultado = ''
			Openwithparm(wtc_mant_disenyador, lstr_param)
		else
			ventanas_activas[esta_abierta].ventana.BringToTop = true
		end if

		CASE "p_comercial"
		esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_comercial")
		//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
		if esta_abierta = -1 then
			lstr_param.s_argumentos[1] = this.object.comercial[row]
			lstr_param.i_nargumentos = 1
			lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
			lstr_param.resultado = ''
			Openwithparm(wtc_mant_comercial, lstr_param)
		else
			ventanas_activas[esta_abierta].ventana.BringToTop = true
		end if
		
	
		CASE "p_expo"
			if hay_cambios() then
				//MessageBox("Atención", "Debe guardar los cambios antes de modificar los archivos de la exposición")
				if f_guardar() <> 1 then
					return
				end if
			end if
			
			if isnull(dw_1.object.funcion[dw_1.getrow()]) or dw_1.object.funcion[dw_1.getrow()] = "" then
				MessageBox("Error", "Debe indicar la función del modelo y guardar, antes de modificar los archivos de la exposición")
				return
			end if
			
			if isnull(dw_1.object.pavrev[dw_1.getrow()]) or dw_1.object.pavrev[dw_1.getrow()] = "" then
				MessageBox("Error", "Debe indicar si el modelo es un pavimento o un revestimiento y guardar, antes de modificar los archivos de la exposición")
				return
			end if
			
			esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_modelo_archivo")
			//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
			if esta_abierta = -1 then
				lstr_param.s_argumentos[1] = dw_1.object.coleccion[dw_1.getrow()]
				lstr_param.s_argumentos[2] = f_codigo_principal()
				lstr_param.i_nargumentos = 2
				lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
				lstr_param.resultado = ''
				Openwithparm(wtc_mant_modelo_archivo, lstr_param)
			else
				ventanas_activas[esta_abierta].ventana.BringToTop = true
			end if	

		CASE "p_archivos"
			if hay_cambios() then
				MessageBox("Atención", "Debe guardar los cambios antes de gestionar los archivos de disenyo")
				return
			end if
			
			if f_codigo_principal() = "" then
				return
			end if
			
			//La ventana será response
			lstr_param.s_argumentos[1] = f_codigo_principal()
			lstr_param.i_nargumentos = 1
			lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
			lstr_param.resultado = ''
			Openwithparm(wtc_mant_modelo_sistema_archivos, lstr_param)
							
END CHOOSE		
		
		
		
		
		
		
		
		
		


end event

event dw_1::itemchanged;call super::itemchanged;string resultado, resultado1, resultado3
String cod1, cod2
datetime resultado2

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "coleccion"
			
		SELECT ambiente.descripcion, descoleccionsol.fecha_coleccion, tecnico_dis.descripcion, descoleccionsol.comercial, descoleccionsol.disenyador 
		INTO :resultado1, :resultado2, :resultado3, :cod1, :cod2
		FROM descoleccionsol, tecnico_dis, ambiente 
		WHERE descoleccionsol.empresa = :codigo_empresa
		and descoleccionsol.codigo = :data
		and descoleccionsol.disenyador = tecnico_dis.codigo
		and descoleccionsol.empresa = tecnico_dis.empresa 
		and descoleccionsol.empresa = ambiente.empresa 
		and descoleccionsol.ambiente = ambiente.codigo;

		if SQLCA.sqlcode <> 100 then
			this.object.ambiente_descripcion[Row] 		= resultado1
			this.object.descoleccionsol_fecha_coleccion[Row] 		= resultado2
			this.object.tecnico_dis_descripcion_1[Row] 		= resultado3
			if isnull(dw_1.object.comercial[dw_1.getrow()]) or dw_1.object.comercial[dw_1.getrow()] = "" then
				dw_1.object.comercial[dw_1.getrow()] = cod1
				dw_1.EVENT itemchanged(dw_1.Getrow(), dw_1.object.comercial, dw_1.object.comercial[dw_1.Getrow()])
			end if
			if isnull(dw_1.object.tecnico_dis[dw_1.getrow()]) or dw_1.object.tecnico_dis[dw_1.getrow()] = "" then
				dw_1.object.tecnico_dis[dw_1.getrow()] = cod2
				dw_1.EVENT itemchanged(dw_1.Getrow(), dw_1.object.tecnico_dis, dw_1.object.tecnico_dis[dw_1.Getrow()])
			end if
			dw_con_piezas_coleccion.retrieve (codigo_empresa, this.object.coleccion[1])
		else
			dwo.Primary[row] = ''
			this.object.descoleccionsol_ambiente[Row] 		= ''
			setnull(resultado2)
			this.object.descoleccionsol_fecha_coleccion[Row] 	= resultado2
			dw_con_piezas_coleccion.reset()
			return 2
		end if

	CASE "funcion"
		SELECT art_grupo2.descripcion 
		INTO :resultado
		FROM art_grupo2
		WHERE empresa = :codigo_empresa
		and art_grupo2.codigo = :data
		ORDER BY art_grupo2.descripcion ;

		if SQLCA.sqlcode <> 100 then
			this.object.art_grupo2_descripcion[Row] 		= resultado
		else
			dwo.Primary[row] = ''
			this.object.art_grupo2_descripcion[Row] 		= ''
			return 2
		end if

	CASE "tecnico_dis"
		SELECT tecnico_dis.descripcion 
		INTO :resultado
		FROM tecnico_dis
		WHERE empresa = :codigo_empresa 
		and activo = 'S' 
		and tecnico_dis.codigo = :data
		ORDER BY tecnico_dis.descripcion ;

		if SQLCA.sqlcode <> 100 then
			this.object.tecnico_dis_descripcion[Row] 		= resultado
		else
			dwo.Primary[row] = ''
			this.object.tecnico_dis_descripcion[Row] 		= ''
			return 2
		end if
		
	CASE "comercial"
		SELECT comercial.descripcion 
		INTO :resultado
		FROM comercial
		WHERE empresa = :codigo_empresa 
		and activo = '1'
		and comercial.codigo = :data
		ORDER BY comercial.descripcion;

		if SQLCA.sqlcode <> 100 then
			this.object.comercial_descripcion[Row] 		= resultado
//			this.Modify("comercial_descripcion.Background.Color  = "+ftc_control_color_descripcion(0))			
		else
			dwo.Primary[row] = ''
			this.object.comercial_descripcion[Row] 		= ''
			return 2
		end if
	CASE "relieve"
		SELECT art_tipomoldura.descripcion
		INTO :resultado
		FROM art_tipomoldura
		WHERE empresa = :codigo_empresa
		and art_tipomoldura.codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.art_tipomoldura_descripcion_1[Row] 		= resultado
		else
			dwo.Primary[row] = ''
			this.object.art_tipomoldura_descripcion_1[Row] 		= ''
			return 2			
		end if
END CHOOSE


this.Accepttext()
end event

event dw_1::constructor;call super::constructor;//this.Modify("coleccion.ValidationMsg='Debe indicar una colección válida para continuar.'")
end event

type pb_borrar from wt_ventana_padre`pb_borrar within wtc_trabajos_disenyo_nuevo
integer x = 5317
integer y = 104
string disabledname = "C:\Tencer_PB12\Delete_24x24_D.png"
end type

type pb_salir from wt_ventana_padre`pb_salir within wtc_trabajos_disenyo_nuevo
integer x = 5637
integer y = 104
string picturename = "C:\Tencer_PB12\Log Out_24x24Gris.png"
end type

type pb_grabar from wt_ventana_padre`pb_grabar within wtc_trabajos_disenyo_nuevo
integer x = 512
integer y = 96
end type

type st_titulo from wt_ventana_padre`st_titulo within wtc_trabajos_disenyo_nuevo
integer x = 46
integer width = 1902
integer height = 72
string facename = "Verdana"
long bordercolor = 33554432
end type

type pb_nuevo from wt_ventana_padre`pb_nuevo within wtc_trabajos_disenyo_nuevo
integer x = 41
integer y = 96
string disabledname = "C:\Tencer_PB12\New_24x24_D.png"
end type

event pb_nuevo::clicked;call super::clicked;if dw_1.rowcount() > 0 then
	dw_1.SetColumn(1)
end if
dw_clientes.reset()
dw_propuestas.reset()
dw_piezas.reset()
dw_versiones.reset()
dw_archivos.reset()
dw_trabajos.reset()
dw_con_piezas_coleccion.reset()
dw_imagen.visible = false
st_produccion.visible = false
end event

type pb_cancelar from wt_ventana_padre`pb_cancelar within wtc_trabajos_disenyo_nuevo
integer x = 5477
integer y = 104
string picturename = "C:\Tencer_PB12\Undo_24x24Gris.png"
end type

event pb_cancelar::clicked;call super::clicked;String cliente, propuesta, pieza
Long fila_cliente, produccion

if estado = 1 then
	
	dw_clientes.SetRedraw(false)
	dw_propuestas.SetRedraw(false)	
	dw_trabajos.SetRedraw(false)	
	dw_versiones.SetRedraw(false)	
	dw_piezas.SetRedraw(false)	
	dw_archivos.SetRedraw(false)
	dw_bases_version_pieza.SetRedraw(false)
	
	dw_1.retrieve(codigo_empresa, padre_codigo)
	dw_con_piezas_coleccion.retrieve (codigo_empresa, dw_1.object.coleccion[1])
	
	dw_clientes.retrieve (codigo_empresa, padre_codigo)	
	dw_propuestas.retrieve (codigo_empresa, padre_codigo)	
	dw_trabajos.retrieve (codigo_empresa, padre_codigo)
	dw_versiones.retrieve (codigo_empresa, padre_codigo)	
	dw_piezas.retrieve (codigo_empresa, padre_codigo)	
	dw_archivos.retrieve (codigo_empresa, padre_codigo)	
	dw_bases_version_pieza.retrieve (codigo_empresa, padre_codigo)	
	dw_estructura.retrieve (codigo_empresa, padre_codigo)	
	dw_referencias.retrieve (codigo_empresa, padre_codigo)	
	
	//p_imagen.PictureName = f_cargar_imagen_nuevo(padre_codigo)
	f_cargar_imagen_expo()
	
	//Filtros para mostrar lo último realizado al seleccionar un modelo
	fila_cliente = dw_clientes.rowcount()
	cliente = dw_clientes.object.cliente[dw_clientes.rowcount()]
	seleccionar_fila (dw_clientes,fila_cliente,0)
	
	dw_clientes.SetRedraw(true)
	dw_propuestas.SetRedraw(true)	
	dw_trabajos.SetRedraw(true)	
	dw_versiones.SetRedraw(true)	
	dw_piezas.SetRedraw(true)	
	dw_archivos.SetRedraw(true)
	dw_bases_version_pieza.SetRedraw(true)
	
	//En producción
	produccion = 0
	SELECT COUNT(*) INTO :produccion FROM articulos WHERE empresa = :codigo_empresa AND modelo_origen = :padre_codigo using sqlca;
	if produccion > 0 then
		st_produccion.visible = true
	else
		st_produccion.visible = false
	end if
	
else
	Parent.setfocus()
	pb_nuevo.triggerevent(clicked!)
end if

end event

type pb_buscar from wt_ventana_padre`pb_buscar within wtc_trabajos_disenyo_nuevo
integer x = 201
integer y = 96
end type

event pb_buscar::clicked;string campo
String cliente, propuesta, pieza, coleccion_nueva
Long fila_cliente, produccion

campo = dw_1.GetColumnName()

padre_busqueda.filtro_es_codigo = false
choose case campo
	case "modelo"
		padre_busqueda.filtro_es_codigo = true
//		padre_busqueda.consulta =  " SELECT modelo.modelo, modelo.modelo, art_grupo2.descripcion, tecnico_dis.descripcion, comercial.descripcion "+&	
//									" FROM modelo LEFT OUTER JOIN tecnico_dis ON modelo.empresa = tecnico_dis.empresa AND modelo.tecnico_dis = tecnico_dis.codigo "+&
//									" LEFT OUTER JOIN comercial ON modelo.comercial = comercial.codigo AND modelo.empresa = comercial.empresa "+&
//									" LEFT OUTER JOIN descoleccionsol ON modelo.empresa = descoleccionsol.empresa AND modelo.coleccion = descoleccionsol.codigo "+&
//									" LEFT OUTER JOIN art_grupo2 ON modelo.funcion = art_grupo2.codigo  "+&
//									" WHERE modelo.empresa = '"+codigo_empresa+"' "+&
//									" ORDER BY CONVERT(INTEGER, modelo.modelo) desc"
									
//									
//		padre_busqueda.consulta =  " SELECT modelo.modelo, modelo.modelo, art_grupo2.descripcion, tecnico_dis.descripcion, comercial.descripcion, genter.razon "+&	
//									" FROM modelo LEFT OUTER JOIN tecnico_dis ON modelo.empresa = tecnico_dis.empresa AND modelo.tecnico_dis = tecnico_dis.codigo "+&
//									" LEFT OUTER JOIN comercial ON modelo.comercial = comercial.codigo AND modelo.empresa = comercial.empresa "+&
//									" LEFT OUTER JOIN descoleccionsol ON modelo.empresa = descoleccionsol.empresa AND modelo.coleccion = descoleccionsol.codigo "+&
//									" LEFT OUTER JOIN art_grupo2 ON modelo.funcion = art_grupo2.codigo, deshistorico D1, genter  "+&
//									" WHERE modelo.empresa = '"+codigo_empresa+"' AND "+&
//									" modelo.empresa = D1.empresa AND "+&
//									" modelo.coleccion = D1.coleccion AND "+&
//									" D1.f_pres = (SELECT MAX(D2.f_pres) FROM deshistorico D2 WHERE D2.empresa = modelo.empresa AND D2.coleccion = modelo.coleccion) AND "+&
//									" genter.empresa = D1.empresa AND genter.codigo = D1.cliente AND genter.tipoter = 'C' "+&
//									" ORDER BY CONVERT(INTEGER, modelo.modelo) desc"				
									
									
		padre_busqueda.consulta =  "SELECT modelo.modelo, modelo.modelo, art_grupo2.descripcion, tecnico_dis.descripcion, comercial.descripcion "+&	
									" FROM modelo LEFT OUTER JOIN tecnico_dis ON modelo.empresa = tecnico_dis.empresa AND modelo.tecnico_dis = tecnico_dis.codigo "+&
									" LEFT OUTER JOIN comercial ON modelo.comercial = comercial.codigo AND modelo.empresa = comercial.empresa "+&
									" LEFT OUTER JOIN descoleccionsol ON modelo.empresa = descoleccionsol.empresa AND modelo.coleccion = descoleccionsol.codigo "+&
									" LEFT OUTER JOIN art_grupo2 ON modelo.funcion = art_grupo2.codigo  "+&
									" WHERE modelo.empresa = '"+codigo_empresa+"' "+&
									" ORDER BY CONVERT(INTEGER, modelo.modelo) desc"		
		
		padre_busqueda.titulos[1] = "Modelo"
		padre_busqueda.titulos[2] = "Modelo"
		padre_busqueda.titulos[3] = "Función"
		padre_busqueda.titulos[4] = "Diseñador"
		padre_busqueda.titulos[5] = "Comercial"
		//padre_busqueda.titulos[6] = "Cliente"

	case else
		padre_busqueda.filtro_es_codigo = true
		padre_busqueda.consulta =  " SELECT modelo.modelo, modelo.modelo, art_grupo2.descripcion, tecnico_dis.descripcion, comercial.descripcion "+&	
									" FROM modelo LEFT OUTER JOIN tecnico_dis ON modelo.empresa = tecnico_dis.empresa AND modelo.tecnico_dis = tecnico_dis.codigo "+&
									" LEFT OUTER JOIN comercial ON modelo.comercial = comercial.codigo AND modelo.empresa = comercial.empresa "+&
									" LEFT OUTER JOIN descoleccionsol ON modelo.empresa = descoleccionsol.empresa AND modelo.coleccion = descoleccionsol.codigo "+&
									" LEFT OUTER JOIN art_grupo2 ON modelo.funcion = art_grupo2.codigo  "+&
									" WHERE modelo.empresa = '"+codigo_empresa+"' "+&
									" ORDER BY CONVERT(INTEGER, modelo.modelo) desc"
		padre_busqueda.titulos[1] = "Modelo"
		padre_busqueda.titulos[2] = "Modelo"
		padre_busqueda.titulos[3] = "Función"
		padre_busqueda.titulos[4] = "Diseñador"
		padre_busqueda.titulos[5] = "Comercial"		
end choose


call super :: clicked

if padre_codigo <> "" then
	
	dw_clientes.SetRedraw(false)
	dw_propuestas.SetRedraw(false)	
	dw_trabajos.SetRedraw(false)	
	dw_versiones.SetRedraw(false)	
	dw_piezas.SetRedraw(false)	
	dw_archivos.SetRedraw(false)
	dw_bases_version_pieza.SetRedraw(false)
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// AQUÍ PONDREMOS TODOS LOS DATAWINDOWS AUXILIARES
	
	dw_clientes.retrieve(codigo_empresa,padre_codigo)
	coleccion_nueva = dw_1.object.coleccion[dw_1.getrow()]
	if not isnull(coleccion_nueva) and coleccion_nueva <> '' then
		dw_con_piezas_coleccion.retrieve (codigo_empresa, coleccion_nueva)
	end if
	dw_clientes.retrieve (codigo_empresa, padre_codigo)	
	dw_propuestas.retrieve (codigo_empresa, padre_codigo)	
	dw_trabajos.retrieve (codigo_empresa, padre_codigo)
	dw_versiones.retrieve (codigo_empresa, padre_codigo)	
	dw_piezas.retrieve (codigo_empresa, padre_codigo)	
	dw_archivos.retrieve (codigo_empresa, padre_codigo)	
	dw_bases_version_pieza.retrieve (codigo_empresa, padre_codigo)	
	dw_estructura.retrieve (codigo_empresa, padre_codigo)	
	dw_referencias.retrieve (codigo_empresa, padre_codigo)	
	f_cargar_imagen_expo()
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//p_imagen.PictureName = f_cargar_imagen_nuevo(padre_codigo)
	fila_cliente = dw_clientes.rowcount()
	seleccionar_fila (dw_clientes,fila_cliente,3)
	
	dw_clientes.SetRedraw(true)
	dw_propuestas.SetRedraw(true)	
	dw_trabajos.SetRedraw(true)	
	dw_versiones.SetRedraw(true)	
	dw_piezas.SetRedraw(true)	
	dw_archivos.SetRedraw(true)
	dw_bases_version_pieza.SetRedraw(true)
	
	//En producción
	produccion = 0
	SELECT COUNT(*) INTO :produccion FROM articulos WHERE empresa = :codigo_empresa AND modelo_origen = :padre_codigo using sqlca;
	if produccion > 0 then
		st_produccion.visible = true
	else
		st_produccion.visible = false
	end if
	
end if
end event

type pb_borrar_trabajo from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 2194
integer y = 1752
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_minus.png"
alignment htextalign = left!
string powertiptext = "EliminarRegistro"
end type

event clicked;String modelo, cliente, propuesta, trabajo, es_pasar_pieza, codigo_trabajo_pasado
boolean error_borrando
long fila_actual, usado,i, pasar_a_pieza

if dw_trabajos.rowcount() <= 0 then
	return
end if

modelo = dw_trabajos.object.modelo_trabajo_modelo[dw_trabajos.getrow()]
cliente = dw_trabajos.object.modelo_trabajo_cliente[dw_trabajos.getrow()]
propuesta = dw_trabajos.object.modelo_trabajo_propuesta[dw_trabajos.getrow()]
trabajo = dw_trabajos.object.modelo_trabajo_codigo[dw_trabajos.getrow()]

usado = dw_piezas.rowcount()
es_pasar_pieza = dw_trabajos.object.modelo_trabajo_modelo_version[dw_trabajos.getrow()]
codigo_trabajo_pasado = ""

//Es un  trabajo pasar a pieza y quedan piezas
if not isnull(es_pasar_pieza) and es_pasar_pieza <> "" and usado > 0 then
	pasar_a_pieza = 0
	For i = 1 to dw_trabajos.rowcount() 
		if not isnull(dw_trabajos.object.modelo_trabajo_modelo_version[i]) and dw_trabajos.object.modelo_trabajo_modelo_version[i] <> "" then
			if trabajo <> codigo_trabajo_pasado then
				codigo_trabajo_pasado = dw_trabajos.object.modelo_trabajo_codigo[i]
			end if
			pasar_a_pieza++
		end if
	Next
	if pasar_a_pieza > 1 then
		//Borramos el pasar a pieza porque existen más trabajos pasar a pieza
		
		//Actualizamos el campo trabajo pasado a pieza de las piezas
		if codigo_trabajo_pasado <> "" then
			For i = 1 To dw_piezas.rowcount()
				dw_piezas.object.modelo_trabajo[i] = codigo_trabajo_pasado
			Next
		end if
	else
		//No podemos borrar el trabajo pasar a pieza si solo hay un pasar a pieza y existen piezas
		MessageBox("Error", "No se puede borrar un trabajo de Pasar a Pieza, si existen piezas asociadas. Borre las piezas primero si desea borrar este trabajo.")
		return
		
	end if
end if



error_borrando = false
fila_actual = dw_trabajos.getrow()
if fila_actual > 0 then
	if dw_trabajos.DeleteRow(fila_actual) <> 1 then
		error_borrando = True
	else
		error_borrando = False
	end if
end if

if error_borrando then
	MessageBox("Error","No ha sido posible borrar el trabajo")
end if
end event

type pb_duplica_trabajo from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 2350
integer y = 1752
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\duplicar.png"
alignment htextalign = left!
string powertiptext = "Duplicar Registro"
end type

event clicked;long total_filas, fila_antigua, fila_actual, nuevaprueba, indice, maximo_valor_dw
string modelo_actual, v_empresa, v_modelo, v_cliente, v_propuesta, v_serie, v_descripcion_serie
string v_acabado_lab, v_descripcion_acabado_lab, v_tecnico_dis, v_tecnico_dis_descripcion, v_pasta, v_base_cli

modelo_actual = f_codigo_principal()

fila_antigua = dw_trabajos.GetRow()

if fila_antigua > 0 then 
	v_empresa = dw_trabajos.object.modelo_trabajo_empresa[fila_antigua]
	//v_modelo = dw_trabajos.object.modelo_trabajo_modelo[fila_antigua]
	v_cliente = dw_trabajos.object.modelo_trabajo_cliente[fila_antigua]
	v_propuesta = dw_trabajos.object.modelo_trabajo_propuesta[fila_antigua]
	v_serie = dw_trabajos.object.modelo_trabajo_serie[fila_antigua]
	v_descripcion_serie = dw_trabajos.object.desserie_descripcion[fila_antigua] 
	v_acabado_lab = dw_trabajos.object.modelo_trabajo_acabado_lab[fila_antigua] 
	v_descripcion_acabado_lab = dw_trabajos.object.tipoacabado_lab_descripcion[fila_antigua]
	v_tecnico_dis = dw_trabajos.object.modelo_trabajo_tecnico_dis[fila_antigua]
	v_tecnico_dis_descripcion = dw_trabajos.object.tecnico_dis_descripcion[fila_antigua]
	v_pasta = dw_trabajos.object.modelo_trabajo_pasta[fila_antigua] 
	v_base_cli = dw_trabajos.object.modelo_trabajo_base_cliente[fila_antigua] 
	//	f_solicitud = dw_trabajos.object.destrabajo2_fecha_solicitud[dw_trabajos.GetRow()] 
	//	f_necesidad = dw_trabajos.object.destrabajo2_fecha_necesidad[dw_trabajos.GetRow()] 
	
	fila_actual = dw_trabajos.InsertRow(0)
	
	dw_trabajos.scrolltorow(fila_actual)
	dw_trabajos.SetColumn(3)
	dw_trabajos.Setfocus()
		
	total_filas = dw_trabajos.RowCount()
	/*
	select max(codigo) 
	into :nuevaprueba 
	from modelo_trabajo 
	where empresa = :codigo_empresa 
	and modelo = :modelo_actual 
	and cliente = :v_cliente 
	and propuesta = :v_propuesta;
	*/
	maximo_valor_dw = long(dw_trabajos.Describe("Evaluate('Max(integer(modelo_trabajo_codigo))', 0)"))
	if isnull(nuevaprueba) then nuevaprueba = 0
	if isnull(maximo_valor_dw) then maximo_valor_dw = 0
	
	if nuevaprueba > maximo_valor_dw then
		nuevaprueba ++
	else
		nuevaprueba = maximo_valor_dw +1
	end if	
	
	dw_trabajos.object.modelo_trabajo_empresa[fila_actual] = v_empresa
	//dw_trabajos.object.modelo_trabajo_modelo[fila_actual] = v_modelo
	dw_trabajos.object.modelo_trabajo_cliente[fila_actual] = v_cliente
	dw_trabajos.object.modelo_trabajo_propuesta[fila_actual] = v_propuesta
	dw_trabajos.object.modelo_trabajo_codigo[fila_actual] = String(nuevaprueba)
	
	dw_trabajos.object.modelo_trabajo_serie[fila_actual] = v_serie
	dw_trabajos.object.desserie_descripcion[fila_actual] = v_descripcion_serie 
	dw_trabajos.object.modelo_trabajo_acabado_lab[fila_actual] = v_acabado_lab
	dw_trabajos.object.tipoacabado_lab_descripcion[fila_actual] = v_descripcion_acabado_lab
	dw_trabajos.object.modelo_trabajo_tecnico_dis[fila_actual] = v_tecnico_dis
	dw_trabajos.object.tecnico_dis_descripcion[dw_trabajos.GetRow()] = v_tecnico_dis_descripcion
	dw_trabajos.object.modelo_trabajo_fecha_solicitud[fila_actual] = datetime(today())
	//29-07-2015 - Agilidad fichas monococcion y bicoccion
//	if (v_acabado_lab = "1" or v_acabado_lab = "2") then
//		dw_trabajos.object.modelo_trabajo_fecha_necesidad[fila_actual] = dw_trabajos.object.modelo_trabajo_fecha_solicitud[fila_actual]
//		dw_trabajos.object.modelo_trabajo_fecha_fin[fila_actual] = dw_trabajos.object.modelo_trabajo_fecha_solicitud[fila_actual]
//	end if
	dw_trabajos.object.pasado[fila_actual] = 0
	
	dw_trabajos.object.modelo_trabajo_pasta[fila_actual] = v_pasta 
	dw_trabajos.object.modelo_trabajo_base_cliente[fila_actual] = v_base_cli
end if	


end event

type pb_anyade_trabajo from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 2039
integer y = 1752
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_plus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;long fila_actual, nuevo_codigo, indice, maximo_valor_dw
string modelo_actual, cliente, propuesta, disenyador, comercial_trabajo, v_coleccion

nuevo_codigo = 0

modelo_actual = dw_1.object.#1[dw_1.getrow()]

if dw_clientes.getrow() <= 0 then
	MessageBox("Error","Debe seleccionar un cliente para poder insertar un nuevo trabajo")
	return
end if
cliente = dw_clientes.object.cliente[dw_clientes.getrow()]

if isnull(cliente) or cliente = "" then
	MessageBox("Error","Debe indicar un cliente para poder insertar un nuevo trabajo")
	return
end if

if dw_propuestas.getrow() <= 0 then
	MessageBox("Error","Debe seleccionar una propuesta para poder insertar un nuevo trabajo")
	return
end if
propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.getrow()]

if isnull(propuesta) or propuesta = "" then
	MessageBox("Error","Debe indicar una propuesta para poder insertar un nuevo trabajo")
	return
end if

maximo_valor_dw = long(dw_trabajos.Describe("Evaluate('Max(integer(modelo_trabajo_codigo))', 0)"))
if isnull(maximo_valor_dw) then maximo_valor_dw = 0
nuevo_codigo = maximo_valor_dw +1

fila_actual = dw_trabajos.InsertRow(0)

dw_trabajos.object.modelo_trabajo_codigo[fila_actual] = String(nuevo_codigo)

dw_trabajos.scrolltorow(fila_actual)
dw_trabajos.Setfocus()
dw_trabajos.object.modelo_trabajo_empresa[fila_actual] = codigo_empresa
dw_trabajos.object.modelo_trabajo_cliente[fila_actual] = cliente
dw_trabajos.object.modelo_trabajo_propuesta[fila_actual] = propuesta
dw_trabajos.object.modelo_trabajo_fecha_solicitud[fila_actual] = datetime(today(),now())
dw_trabajos.object.pasado[fila_actual] = 0

//Diseñadores y comercial Colección (Petición Jesús 11/02/2013) *****************************************************************************************************
v_coleccion = dw_1.object.coleccion[dw_1.getrow()]
if not isnull(v_coleccion) and v_coleccion <> "" then
	SELECT disenyador, comercial INTO :disenyador, :comercial_trabajo FROM descoleccionsol WHERE empresa = :codigo_empresa AND codigo = :v_coleccion USING sqlca;
	dw_trabajos.object.modelo_trabajo_tecnico_dis[fila_actual] = disenyador
	dw_trabajos.EVENT itemchanged(fila_actual, dw_trabajos.object.modelo_trabajo_tecnico_dis, disenyador)
	dw_trabajos.object.modelo_trabajo_comercial[fila_actual] = comercial_trabajo
	dw_trabajos.EVENT itemchanged(fila_actual, dw_trabajos.object.modelo_trabajo_comercial, comercial_trabajo)
end if
//********************************************************************************************************************************************************************
dw_trabajos.SetColumn(9)
end event

type st_2 from statictext within wtc_trabajos_disenyo_nuevo
integer x = 4827
integer y = 2784
integer width = 960
integer height = 80
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24076881
string text = "Imagen Modelo"
alignment alignment = center!
boolean focusrectangle = false
end type

type cb_generar_pieza from commandbutton within wtc_trabajos_disenyo_nuevo
integer x = 3721
integer y = 16
integer width = 544
integer height = 100
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Generar Modelo"
end type

event clicked;/*
string ambiente, disenyador, estado2, observaciones_col, comercial, comercial_trabajo
string pieza, funcion, observaciones_pz, laboratorio, pavrev
string serie, relieve, formato, pasta, acabado_lab, contratipo, aceptado, base_cliente, base, observaciones_trab 
datetime fecha_solicitud, fecha_necesidad, fecha_lab
long max_coleccion, trabajo, modelo
string v_coleccion, grafica, INKCID
*/
datetime fecha_solicitud, fecha_necesidad
string v_coleccion, funcion, disenyador, pavrev, cliente, comercial_trabajo, observaciones_pz, serie, pasta, base_cliente, relieve

if hay_cambios() then
	MessageBox("Atención","Debe guardar los cambios o cancelar antes de Generar una pieza nueva")
	return
end if

if dw_clientes.getrow() > 0 and dw_propuestas.getrow() > 0 and dw_trabajos.getrow() > 0 and dw_1.getrow() > 0 then
	
	if padre_codigo <> '' then				
			
		/////////////////////////////////////////////////////////////////////////////////////////////////////
		// 										 Carga de los datos del modelo												//
		/////////////////////////////////////////////////////////////////////////////////////////////////////

		v_coleccion = 	dw_1.object.coleccion[dw_1.GetRow()]
		//funcion = dw_1.object.funcion[dw_1.getrow()]
		pavrev = dw_1.object.pavrev[dw_1.getrow()]
		disenyador = dw_1.object.tecnico_dis[dw_1.getrow()]
		observaciones_pz = dw_1.object.observaciones[dw_1.getrow()]
		relieve = dw_1.object.relieve[dw_1.getrow()] //Nos interesa por culpa de que se valida el relieve con el cliente
		
		/////////////////////////////////////////////////////////////////////////////////////////////////////
		// 										 Carga de los datos del cliente												//
		/////////////////////////////////////////////////////////////////////////////////////////////////////
		
		cliente = dw_clientes.object.cliente[dw_clientes.getrow()]

		/////////////////////////////////////////////////////////////////////////////////////////////////////
		// 										 Carga de los datos del trabajo												//
		/////////////////////////////////////////////////////////////////////////////////////////////////////

		//trabajo = dw_trabajos.object.destrabajo2_trabajo[dw_trabajos.Getrow()]
		serie = dw_trabajos.object.modelo_trabajo_serie[dw_trabajos.Getrow()]
		pasta = dw_trabajos.object.modelo_trabajo_pasta[dw_trabajos.Getrow()]
		base_cliente = dw_trabajos.object.modelo_trabajo_base_cliente[dw_trabajos.Getrow()]
		comercial_trabajo = dw_trabajos.object.modelo_trabajo_comercial[dw_trabajos.Getrow()]
		fecha_solicitud = datetime(today(),now())
		setnull (fecha_necesidad)

		/////////////////////////////////////////////////////////////////////////////////////////////////////
		// 										 Nuevo modelo y nuevo trabajo													//
		/////////////////////////////////////////////////////////////////////////////////////////////////////
		
		 pb_nuevo.triggerevent(clicked!)
		 
		 //CARGA DEL MODELO
		 if dw_1.Getrow() > 0 then
			 dw_1.accepttext()
			 dw_1.object.coleccion[dw_1.Getrow()] = v_coleccion
			 dw_1.EVENT itemchanged(dw_1.Getrow(), dw_1.object.coleccion, v_coleccion)
			 
			 //Diseñadores y comercial (Petición Jesús 11/02/2013) ****************************************************************************************************************
			 SELECT disenyador, comercial INTO :disenyador, :comercial_trabajo FROM descoleccionsol WHERE empresa = :codigo_empresa AND codigo = :v_coleccion USING sqlca;
			 //********************************************************************************************************************************************************************

			 dw_1.object.tecnico_dis[dw_1.getrow()] = disenyador
			 dw_1.EVENT itemchanged(dw_1.Getrow(), dw_1.object.tecnico_dis, disenyador)
			 dw_1.object.comercial[dw_1.getrow()] = comercial_trabajo
			 dw_1.EVENT itemchanged(dw_1.Getrow(), dw_1.object.comercial, comercial_trabajo)
			 
			 //dw_1.object.funcion[dw_1.Getrow()] = funcion
			 dw_1.object.observaciones[dw_1.Getrow()] = observaciones_pz
			 dw_1.object.pavrev[dw_1.Getrow()] = pavrev
			 dw_1.object.relieve[dw_1.Getrow()] = relieve 
			  dw_1.EVENT itemchanged(dw_1.Getrow(), dw_1.object.relieve, relieve)
			 
			 //CARGA DEL CLIENTE
			 pb_anyade_cliente.triggerevent(clicked!)
			 
			 if dw_clientes.getrow() > 0 then
				 dw_clientes.object.cliente[dw_clientes.getrow()] = cliente
				 dw_clientes.EVENT itemchanged(dw_clientes.Getrow(), dw_clientes.object.cliente, cliente)
				 
				 //CARGA DE LA PROPUESTA
				 pb_anyade_propuesta.triggerevent(clicked!)
				 
				 if dw_propuestas.getrow() > 0 then
			 
					 //CARGA DEL TRABAJO
					 pb_anyade_trabajo.triggerevent(clicked!)
					 if dw_trabajos.getrow() > 0 then
						 dw_trabajos.accepttext()
						 dw_trabajos.object.modelo_trabajo_pasta[dw_trabajos.Getrow()] = pasta
						 dw_trabajos.object.modelo_trabajo_base_cliente[dw_trabajos.Getrow()] = base_cliente
						 
						 dw_trabajos.object.modelo_trabajo_serie[dw_trabajos.Getrow()] = serie
						 dw_trabajos.EVENT itemchanged(dw_trabajos.Getrow(), dw_trabajos.object.modelo_trabajo_serie, serie)
								 
						 dw_trabajos.object.modelo_trabajo_tecnico_dis[dw_trabajos.Getrow()] = disenyador
						 dw_trabajos.EVENT itemchanged(dw_trabajos.Getrow(), dw_trabajos.object.modelo_trabajo_tecnico_dis, disenyador) 
						 
						 dw_trabajos.object.modelo_trabajo_comercial[dw_trabajos.Getrow()] = comercial_trabajo
						 dw_trabajos.EVENT itemchanged(dw_trabajos.Getrow(), dw_trabajos.object.modelo_trabajo_comercial, comercial_trabajo)
					end if
				end if
			end if
		end if
	end if
else
	messagebox("Atención", "Debe seleccionar el trabajo que se desee duplicar.")
end if


end event

type cb_generar_coleccion from commandbutton within wtc_trabajos_disenyo_nuevo
integer x = 3721
integer y = 124
integer width = 544
integer height = 100
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Generar Colección"
end type

event clicked;String codigo, cliente, v_coleccion
String disenyador, comercial_trabajo, funcion, pavrev, observaciones_modelo
String serie, relieve, formato, pasta, acabado_lab, base_cliente
datetime fecha_solicitud, fecha_necesidad
long max_coleccion

str_ventana_alerta parametros
string botones[2]
Int aviso, resultado 
str_colisiones pcolisiones_local
boolean exito 

str_parametros lstr_param
long esta_abierta

if hay_cambios() then
	MessageBox("Error","Debe guardar antes de Generar Colección")
	return
end if
codigo = f_codigo_principal()
if dw_trabajos.getrow() <= 0 or dw_clientes.getrow() <= 0 or dw_propuestas.getrow() <= 0 or isnull(codigo) or codigo = '' then
	messagebox("Atención", "Debe seleccionar el trabajo que se desee duplicar.")
end if

parametros.titulo = "Atención"
parametros.subtitulo = "Generar Colección"
parametros.mensaje = "¿Desea generar una colección nueva?~nEstos cambios se guardarán inmediatamente una vez realizados."
botones[1] = "Sí"
botones[2] = "No"
parametros.tipo = 2
parametros.botones = botones
parametros.mostrar_imagen = true
openwithparm(wtc_ventana_alerta, parametros)
aviso = Int(Message.DoubleParm)

if aviso = 1 then
 	
	string estado2
	
	exito = true
	v_coleccion = 	dw_1.object.coleccion[dw_1.GetRow()]
	cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
	SELECT disenyador INTO :disenyador FROM descoleccionsol WHERE empresa = :codigo_empresa AND codigo = :v_coleccion USING trans_ts;
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////
	// 												 NUEVA COLECCION															//
	/////////////////////////////////////////////////////////////////////////////////////////////////////
	
	pcolisiones_local.empresa = codigo_empresa
	pcolisiones_local.tabla = "descoleccionsol"
	pcolisiones_local.campo = "codigo"
	pcolisiones_local.filtro = ""
	pcolisiones_local.buscar_huecos = true
	max_coleccion = Long(f_colisiones (trans_ts, pcolisiones_local))
	
	INSERT INTO descoleccionsol (empresa, codigo, ambiente, disenyador, estado, observaciones, comercial, grafica) 
		SELECT :codigo_empresa, :max_coleccion, ambiente, disenyador, 'DISPONIBLE', '', comercial, grafica 
		FROM descoleccionsol 
		WHERE empresa = :codigo_empresa and codigo = :v_coleccion USING trans_ts;
		
	IF trans_ts.SQLCode = -1 THEN 
		exito = false
		messagebox("Error Inserción en la Tabla descoleccionsol", trans_ts.SQLErrText)
	END IF
	
	insert into deshistorico (empresa, coleccion, orden, f_pres, cliente, estado) 
		SELECT empresa, :max_coleccion, '1', f_pres, cliente, 'Pendiente' 
		FROM deshistorico 
		WHERE empresa = :codigo_empresa AND coleccion = :v_coleccion AND cliente = :cliente USING trans_ts;
	
	IF trans_ts.SQLCode = -1 THEN 
		exito = false
		messagebox("Error Inserción en la Tabla deshistorico", trans_ts.SQLErrText)
	END IF
		
	/////////////////////////////////////////////////////////////////////////////////////////////////////
	// 										 Carga de los datos del modelo												//
	/////////////////////////////////////////////////////////////////////////////////////////////////////
	
	//Modelo
	funcion = dw_1.object.funcion[dw_1.Getrow()] 
	relieve = dw_1.object.relieve[dw_1.Getrow()] 
	observaciones_modelo = dw_1.object.observaciones[dw_1.Getrow()] 
	pavrev = dw_1.object.pavrev[dw_1.Getrow()] 
	
	//Propuesta
	formato = dw_propuestas.object.modelo_propuesta_formato[dw_propuestas.Getrow()] 
	
	//Trabajo
	serie = dw_trabajos.object.modelo_trabajo_serie[dw_trabajos.Getrow()] 
	comercial_trabajo = dw_trabajos.object.modelo_trabajo_comercial[dw_trabajos.Getrow()] 
	acabado_lab = dw_trabajos.object.modelo_trabajo_acabado_lab[dw_trabajos.Getrow()] 
	pasta = dw_trabajos.object.modelo_trabajo_pasta[dw_trabajos.Getrow()] 
	base_cliente = dw_trabajos.object.modelo_trabajo_base_cliente[dw_trabajos.Getrow()] 
	fecha_solicitud = datetime(today())
	fecha_necesidad = datetime(relativedate(date(fecha_solicitud),7),time(0))
	
	
	if exito then
		commit using trans_ts;	
		//Hay que hacerlo ahora o la transacción bloquea de la colección (evento itemchanged de clientes)
		
	else
		MessageBox("SQL error", trans_ts.SQLErrText)
		rollback using trans_ts;
	end if
	

	/////////////////////////////////////////////////////////////////////////////////////////////////////
	// 												 NUEVO MODELO																//
	/////////////////////////////////////////////////////////////////////////////////////////////////////
	
	pb_nuevo.triggerevent(clicked!)
	
	if dw_1.Getrow() > 0 then
		 dw_1.accepttext()
		 dw_1.object.funcion[dw_1.Getrow()] = funcion
		 dw_1.object.relieve[dw_1.Getrow()] = relieve
		 dw_1.object.observaciones[dw_1.Getrow()] = observaciones_modelo
		 dw_1.object.pavrev[dw_1.Getrow()] = pavrev
		 
		 dw_1.object.coleccion[dw_1.Getrow()] = String(max_coleccion)
		 dw_1.EVENT itemchanged(dw_1.Getrow(), dw_1.object.coleccion, v_coleccion)
		 dw_1.object.tecnico_dis[dw_1.getrow()] = disenyador
		 dw_1.EVENT itemchanged(dw_1.Getrow(), dw_1.object.tecnico_dis, disenyador)
		 dw_1.object.comercial[dw_1.getrow()] = comercial_trabajo
		 dw_1.EVENT itemchanged(dw_1.Getrow(), dw_1.object.comercial, comercial_trabajo)
		 
		 //CARGA DEL CLIENTE
		 pb_anyade_cliente.triggerevent(clicked!)
		 
		 if dw_clientes.getrow() > 0 then
			 dw_clientes.object.cliente[dw_clientes.getrow()] = cliente
			 dw_clientes.EVENT itemchanged(dw_clientes.Getrow(), dw_clientes.object.cliente, cliente)
			 
			 //CARGA DE LA PROPUESTA
			 pb_anyade_propuesta.triggerevent(clicked!)
			 
			 if dw_propuestas.getrow() > 0 then
				dw_propuestas.object.modelo_propuesta_formato[dw_propuestas.getrow()] = formato				
				dw_propuestas.EVENT itemchanged(dw_propuestas.Getrow(), dw_propuestas.object.modelo_propuesta_formato, formato)
		 
				 //CARGA DEL TRABAJO
				 pb_anyade_trabajo.triggerevent(clicked!)
				 if dw_trabajos.getrow() > 0 then
					 dw_trabajos.accepttext()
					 dw_trabajos.object.modelo_trabajo_pasta[dw_trabajos.Getrow()] = pasta
					 dw_trabajos.object.modelo_trabajo_base_cliente[dw_trabajos.Getrow()] = base_cliente
					 dw_trabajos.object.modelo_trabajo_fecha_solicitud[dw_trabajos.Getrow()] = fecha_solicitud
					 dw_trabajos.object.modelo_trabajo_fecha_necesidad[dw_trabajos.Getrow()] = fecha_necesidad
					 
					 dw_trabajos.object.modelo_trabajo_serie[dw_trabajos.Getrow()] = serie
					 dw_trabajos.EVENT itemchanged(dw_trabajos.Getrow(), dw_trabajos.object.modelo_trabajo_serie, serie)
					 
					 dw_trabajos.object.modelo_trabajo_acabado_lab[dw_trabajos.Getrow()] = acabado_lab
					 dw_trabajos.EVENT itemchanged(dw_trabajos.Getrow(), dw_trabajos.object.modelo_trabajo_acabado_lab, acabado_lab) 
							 
					 dw_trabajos.object.modelo_trabajo_tecnico_dis[dw_trabajos.Getrow()] = disenyador
					 dw_trabajos.EVENT itemchanged(dw_trabajos.Getrow(), dw_trabajos.object.modelo_trabajo_tecnico_dis, disenyador) 
					 
					 dw_trabajos.object.modelo_trabajo_comercial[dw_trabajos.Getrow()] = comercial_trabajo
					 dw_trabajos.EVENT itemchanged(dw_trabajos.Getrow(), dw_trabajos.object.modelo_trabajo_comercial, comercial_trabajo)
				end if
			end if
		end if
	end if
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////
	// 										 Fin Carga del NUEVO MODELO													//
	/////////////////////////////////////////////////////////////////////////////////////////////////////
	
	esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_coleccion2")
	lstr_param.s_argumentos[1] = String(max_coleccion)
	lstr_param.i_nargumentos = 1
	lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
	lstr_param.resultado = ''
	if esta_abierta = -1 then
		Openwithparm(wtc_mant_coleccion2, lstr_param)
	else
		Close(wtc_mant_coleccion2)
		Openwithparm(wtc_mant_coleccion2, lstr_param)
	end if

end if
end event

type dw_ficha_comercial from datawindow within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 1915
integer y = 764
integer width = 1664
integer height = 708
integer taborder = 110
boolean bringtotop = true
string dataobject = "dwtc_report_modelo"
boolean livescroll = true
end type

type pb_anyade_archivo from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 2039
integer y = 2636
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_plus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;long fila_actual, nuevo_codigo, indice, maximo_valor_dw
string modelo_actual, cliente, propuesta, pieza, version_color

nuevo_codigo = 0

modelo_actual = dw_1.object.#1[dw_1.getrow()]

if dw_clientes.getrow() <= 0 then
	MessageBox("Error","Debe seleccionar un cliente para poder insertar un nuevo archivo")
	return
end if
cliente = dw_clientes.object.cliente[dw_clientes.getrow()]

if isnull(cliente) or cliente = "" then
	MessageBox("Error","Debe indicar un cliente para poder insertar un nuevo archivo")
	return
end if

if dw_propuestas.getrow() <= 0 then
	MessageBox("Error","Debe seleccionar una propuesta para poder insertar un nuevo archivo")
	return
end if
propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.getrow()]

if isnull(propuesta) or propuesta = "" then
	MessageBox("Error","Debe indicar una propuesta para poder insertar un nuevo archivo")
	return
end if

if dw_piezas.getrow() <= 0 then
	MessageBox("Error","Debe seleccionar una pieza para poder insertar un nuevo archivo")
	return
end if
pieza = dw_piezas.object.codigo[dw_piezas.getrow()]

if isnull(pieza) or pieza = "" then
	MessageBox("Error","Debe indicar una pieza para poder insertar un nuevo archivo")
	return
end if

if dw_versiones.getrow() <= 0 then
	MessageBox("Error","Debe seleccionar una versión de color para poder insertar un nuevo archivo")
	return
end if
version_color = dw_versiones.object.codigo[dw_versiones.getrow()]

if isnull(version_color) or version_color = "" then
	MessageBox("Error","Debe indicar una versión de color para poder insertar un nuevo archivo")
	return
end if

if not isnull(modelo_actual) and modelo_actual <> "" then
	dw_archivos.setredraw(false)
	dw_archivos.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"' and pieza = '"+pieza+"'")
	dw_archivos.filter()
	
	maximo_valor_dw = long(dw_archivos.Describe("Evaluate('Max(integer(codigo))', 0)"))
	if isnull(maximo_valor_dw) then maximo_valor_dw = 0
	nuevo_codigo = maximo_valor_dw +1
	
	
else
	MessageBox("Error","Debe guardar el Modelo Nuevo antes de añadir archivos")
	return
end if

fila_actual = dw_archivos.InsertRow(0)

dw_archivos.object.codigo[fila_actual] = String(nuevo_codigo)

dw_archivos.scrolltorow(fila_actual)
dw_archivos.SetColumn(2)
dw_archivos.Setfocus()
dw_archivos.object.empresa[fila_actual] = codigo_empresa
dw_archivos.object.cliente[fila_actual] = cliente
dw_archivos.object.propuesta[fila_actual] = propuesta
dw_archivos.object.pieza[fila_actual] = pieza
dw_archivos.object.modelo_version[fila_actual] = version_color

dw_archivos.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"' and pieza = '"+pieza+"' and modelo_version = '"+version_color+"'")
dw_archivos.filter()

dw_archivos.setredraw(true)

end event

type pb_borrar_archivo from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 2190
integer y = 2636
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_minus.png"
alignment htextalign = left!
string powertiptext = "EliminarRegistro"
end type

event clicked;boolean error_borrando
long fila_actual, total, total2, archivos, pruebas, aviso
String modelo, cliente, propuesta, pieza, archivo, archivo_dis, tipo_maquina
str_ventana_alerta parametros
string botones[2]

error_borrando = false
fila_actual = dw_archivos.getrow()
if isnull(fila_actual) or fila_actual = 0 then
	MessageBox("Error","Debe seleccionar una fila para borrar")
	return
end if

modelo = dw_1.object.#1[dw_1.getrow()]
cliente = dw_archivos.object.cliente[fila_actual]
propuesta = dw_archivos.object.propuesta[fila_actual]
pieza = dw_archivos.object.pieza[fila_actual]
archivo = dw_archivos.object.codigo[fila_actual]

tipo_maquina = dw_archivos.object.tipo_maquina_disenyo[fila_actual]
archivo_dis = dw_archivos.object.archivo_disenyo[fila_actual]

//No podemos borrar un archivo si hay aplicaciones de laboratorio que lo usan
total = 0
SELECT COUNT(*) INTO :total FROM modelo_aplicacion WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente and propuesta = :propuesta and pieza = :pieza and modelo_archivo = :archivo;
total2 = 0
SELECT COUNT(*) INTO :total2 FROM archivo_disenyo_sistema_archivos WHERE empresa = :codigo_empresa AND tipomaquina_disenyo = :tipo_maquina AND archivo = :archivo_dis;

if total > 0 then
	MessageBox("Atención","No es posible borrar un archivo si se usa en una prueba de laboratorio.")
	return
elseif total2 > 0 then
	parametros.titulo = "Atención"
	parametros.subtitulo = "Desvincular Archivo"
	parametros.mensaje = "Si el archivo no se usa en ningún modelo más, contine ficheros que antes debería borrar. ¿Seguro que quiere desvincular el archivo?"
	botones[1] = "Sí"
	botones[2] = "No"
	parametros.tipo = 2
	parametros.botones = botones
	parametros.mostrar_imagen = true
	openwithparm(wtc_ventana_alerta, parametros)
	aviso = Int(Message.DoubleParm)
	if aviso = 1 then
		if dw_archivos.DeleteRow(fila_actual) <> 1 then
			error_borrando = True
		else
			error_borrando = False
		end if
	end if
else
	if dw_archivos.DeleteRow(fila_actual) <> 1 then
		error_borrando = True
	else
		error_borrando = False
	end if
end if

if error_borrando then
	MessageBox("Error","No ha sido posible borrar el archivo")
end if


end event

type pb_anyade_propuesta from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 64
integer y = 1760
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_plus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;long fila_actual, nuevo_codigo, indice, maximo_valor_dw, i
string modelo_actual, cliente, rechazado

nuevo_codigo = 0

modelo_actual = dw_1.object.#1[dw_1.getrow()]

if dw_clientes.getrow() <= 0 then
	MessageBox("Error","Debe seleccionar un cliente para poder insertar una nueva propuesta")
	return
end if
cliente = dw_clientes.object.cliente[dw_clientes.getrow()]

if isnull(cliente) or cliente = "" then
	MessageBox("Error","Debe indicar un cliente para poder insertar una nueva propuesta")
	return
end if

maximo_valor_dw = long(dw_propuestas.Describe("Evaluate('Max(integer(modelo_propuesta_codigo))', 0)"))
if isnull(maximo_valor_dw) then maximo_valor_dw = 0
nuevo_codigo = maximo_valor_dw +1


dw_propuestas.accepttext()

if nuevo_codigo > 1 then
	if MessageBox("Propuestas activas en laboratorio", "Ha creado una nueva propuesta, ¿ EL CLIENTE HA RECHAZADO LAS ANTERIORES?", Question!, Yesno!,2) = 1 then
		For i = 1 To dw_propuestas.rowcount()
			dw_propuestas.object.modelo_propuesta_rechazado[i] = '1'
		Next
	end if
end if

fila_actual = dw_propuestas.InsertRow(0)

if fila_actual > 0 then
	dw_propuestas.object.modelo_propuesta_codigo[fila_actual] = String(nuevo_codigo)
	
	dw_propuestas.object.modelo_propuesta_empresa[fila_actual] = codigo_empresa
	dw_propuestas.object.modelo_propuesta_cliente[fila_actual] = cliente
	dw_propuestas.object.modelo_propuesta_rechazado[fila_actual] = '0'
	
	seleccionar_fila (dw_propuestas,fila_actual,5)
end if

dw_propuestas.accepttext()
end event

type pb_borrar_propuesta from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 219
integer y = 1760
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_minus.png"
alignment htextalign = left!
string powertiptext = "EliminarRegistro"
end type

event clicked;boolean error_borrando, hay_piezas
long fila_actual, total, piezas, trabajos, versiones, fila_maxima, archivos, i, total_filas
String modelo, cliente, propuesta

error_borrando = false
fila_actual = dw_propuestas.getrow()
fila_maxima = dw_propuestas.rowcount()
if isnull(fila_actual) or fila_actual = 0 then
	MessageBox("Error","Debe seleccionar una fila para borrar")
	return
end if

modelo = dw_1.object.#1[dw_1.getrow()]
cliente = dw_propuestas.object.modelo_propuesta_cliente[fila_actual]
propuesta = dw_propuestas.object.modelo_propuesta_codigo[fila_actual]

//No podemos borrar una propuesta si hay piezas con pruebas asociadas, archivos de diseño o versiones de color
total = 0
piezas = 0
trabajos = 0
versiones = 0
archivos = 0
SELECT COUNT(*) INTO :piezas FROM modelo_pieza WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente and propuesta = :propuesta;
//SELECT COUNT(*) INTO :trabajos FROM modelo_trabajo WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente and propuesta = :propuesta;
SELECT COUNT(*) INTO :archivos FROM modelo_propuesta_sistema_archivos WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente and propuesta = :propuesta;
SELECT COUNT(*) INTO :versiones FROM modelo_version WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente and propuesta = :propuesta;
total = piezas + trabajos + archivos + versiones

if total > 0 then
	MessageBox("Atención","No es posible borrar una propuesta si ya se han realizado piezas, existen archivos de diseño en la propuesta o si existen versiones de color.")
	return
else
	//Borrar trabajos
	total_filas = dw_trabajos.rowcount()
	i = total_filas
	Do while i > 0 and not error_borrando
		if dw_trabajos.deleterow(i) <> 1 then
			error_borrando = true
		end if
		i --
	loop
	if not error_borrando then
		if dw_propuestas.DeleteRow(fila_actual) <> 1 then
			error_borrando = True
		else
			error_borrando = False
		end if
	end if
end if


if error_borrando then
	MessageBox("Error","No ha sido posible borrar la propuesta")
else
	if fila_maxima = fila_actual then
		seleccionar_fila (dw_propuestas,fila_actual - 1,5)
	else
		seleccionar_fila (dw_propuestas,fila_actual,5)
	end if
end if


end event

type pb_anyade_cliente from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 3945
integer y = 604
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_plus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;long fila_actual
String cliente

fila_actual = dw_clientes.InsertRow(0)

if fila_actual > 0 then
	dw_clientes.object.empresa[fila_actual] = codigo_empresa
	dw_clientes.object.modelo_cliente_orden[fila_actual] = fila_actual
	
	seleccionar_fila (dw_clientes,fila_actual,3)
end if
end event

type pb_quitar_cliente from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 4101
integer y = 604
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_minus.png"
alignment htextalign = left!
string powertiptext = "EliminarRegistro"
end type

event clicked;boolean error_borrando, hay_piezas
long fila_actual, fila_maxima, propuestas
String modelo,cliente

error_borrando = false
fila_actual = dw_clientes.getrow()
fila_maxima = dw_clientes.rowcount()
if isnull(fila_actual) or fila_actual = 0 then
	MessageBox("Error","Debe seleccionar una fila para borrar")
	return
end if

modelo = dw_1.object.#1[dw_1.getrow()]
cliente = dw_clientes.object.cliente[fila_actual]
if isnull(cliente) or cliente = "" then
	//Borramos porque no hay datos asociados
	if dw_clientes.DeleteRow(fila_actual) <> 1 then
		error_borrando = True
	else
		error_borrando = False
	end if
	
else
	//No podemos borrar un cliente si hay piezas con pruebas asociadas
	//Hay que comprobar si hay clientes asociados al modelo antes de borrar
	propuestas = 0
	propuestas = dw_propuestas.rowcount()
	//SELECT COUNT(*) INTO :propuestas FROM modelo_cliente WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente;
	
	if not isnull(propuestas) AND propuestas > 0 then
		MessageBox("Error","No es posible borrar un cliente si tiene propuestas asociadas.")
		return
	else
		if dw_clientes.DeleteRow(fila_actual) <> 1 then
			error_borrando = True
		else
			error_borrando = False
		end if
	end if
end if

if error_borrando then
	MessageBox("Error","No ha sido posible borrar el cliente")
else
	if fila_actual = fila_maxima then
		seleccionar_fila (dw_clientes,fila_actual - 1,3)
	else
		seleccionar_fila (dw_clientes,fila_actual,3)
	end if
end if
end event

type dw_clientes from u_dw within wtc_trabajos_disenyo_nuevo
event pr1 pbm_dwnitemchangefocus
integer x = 3931
integer y = 236
integer width = 1851
integer height = 372
integer taborder = 20
string dataobject = "dwtc_modelo_cliente"
boolean vscrollbar = true
end type

event clicked;call super::clicked;str_parametros lstr_param
long esta_abierta
String cliente

CHOOSE CASE dwo.name
	CASE "p_nuevo"
		esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_clientes")
		//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
		if esta_abierta = -1 then
			lstr_param.s_argumentos[1] = this.object.cliente[row]
			lstr_param.i_nargumentos = 1
			lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
			lstr_param.resultado = ''
			Openwithparm(wtc_mant_clientes, lstr_param)
		else
			ventanas_activas[esta_abierta].ventana.BringToTop = true
		end if
END CHOOSE

/*
if row > 0 then
	filtro_general(row, 0, 0)
end if
*/

end event

event itemchanged;call super::itemchanged;string resultado, resultado2, modelo, cliente, propuesta, coleccion, relieve, cliente_relieve, razon
Int repetidos, i, j, propuestas
Boolean cambiar_dependencias

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "cliente"
		cambiar_dependencias = false
		modelo = dw_1.object.#1[dw_1.getrow()]
		cliente = this.object.cliente_actual[row]
		
		if data = "" then
			dwo.Primary[row] = cliente
			return 2	
		end if
		
		if not isnull(cliente) and cliente <> "" then
			dw_propuestas.setfilter("modelo_propuesta_cliente = '"+cliente+"' ")
			dw_propuestas.filter()
			if dw_propuestas.rowcount() > 0 and not isnull(modelo) and modelo <> "" then
				MessageBox("Error","No puede cambiar un cliente que ya tiene propuestas")
				dwo.Primary[row] = cliente
				return 2	
			else
				cambiar_dependencias = true
			end if
		end if
		
		coleccion = dw_1.object.coleccion[dw_1.getrow()]
		if isnull(coleccion) or coleccion = '' then
			MessageBox("Error","Debe indicar previamente la colección del modelo")
			dwo.Primary[row] = cliente
			return 2	
		end if
		
		SELECT genter.razon 
		INTO :resultado
		FROM genter 
		WHERE genter.empresa = :codigo_empresa AND genter.tipoter = 'C' AND genter.codigo = :data;
		if SQLCA.sqlcode <> 100 then
			
			//Comprobamos el relieve (si es exclusivo no se puede utilizar)
			relieve = dw_1.object.relieve[dw_1.getrow()]
			if isnull(relieve) or relieve = "" then
				MessageBox("Error", "Debe indicar el relieve antes de buscar cliente")
				dwo.Primary[row] = cliente
				return 2	
			else
				cliente_relieve = ""
				SELECT art_tipomoldura.cliente, genter.razon INTO :cliente_relieve, :razon FROM art_tipomoldura LEFT OUTER JOIN genter ON art_tipomoldura.empresa = genter.empresa AND art_tipomoldura.cliente = genter.codigo  AND genter.tipoter = 'C' WHERE art_tipomoldura.empresa = :codigo_empresa AND art_tipomoldura.codigo = :relieve;
				if not isnull(cliente_relieve) and cliente_relieve <> "" then
					if cliente_relieve <> data and data <> '87' then //TENCER ACEPTA CUALQUIER RELIEVE
						MessageBox("Error", "El relieve seleccionado es exclusivo del cliente "+razon+". Seleccione otro relieve antes de continuar.")
						dwo.Primary[row] = cliente
						return 2	
					end if
				end if
			end if
			
			//Comprobamos que el cliente no este repetido
			repetidos = 0
			repetidos = Integer(this.Describe("Evaluate('sum(if(long(cliente) = "+data+",1,0))', 0)"))
			if repetidos > 1 then
				MessageBox("Error","El cliente seleccionado ya existe en el modelo")
				dwo.Primary[row] = cliente
				return 2	
			end if
			
			//Comprobamos que esté en el historico (salvo Tencer)
			//if data <> '87' then
			SELECT cliente 
			INTO :resultado2
			FROM deshistorico 
			WHERE empresa = :codigo_empresa AND coleccion = :coleccion AND cliente = :data;
			if SQLCA.sqlcode = 100 then
				MessageBox("Error","El cliente seleccionado debe estar en el histórico de la colección.")
				dwo.Primary[row] = cliente
				return 2	
			end if
			//end if
			
			this.object.genter_razon[Row] 	= resultado
			this.object.cliente_actual[Row]	= data
			
			if cambiar_dependencias then
				
				dw_propuestas.setfilter("modelo_propuesta_cliente = '"+cliente+"'")
				dw_propuestas.filter()
				propuestas = dw_propuestas.rowcount()
				For i = 1 To propuestas 
					dw_propuestas.object.modelo_propuesta_cliente[i] = data	
					propuesta = dw_propuestas.object.modelo_propuesta_codigo[i]
					
					dw_trabajos.setfilter("modelo_trabajo_cliente = '"+cliente+"' and modelo_trabajo_propuesta = '"+propuesta+"'")
					dw_trabajos.filter()
					For j = 1 To dw_trabajos.rowcount()
						dw_trabajos.object.modelo_trabajo_cliente[j] = data		
					Next
					
					dw_versiones.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
					dw_versiones.filter()
					For j = 1 To dw_versiones.rowcount()
						dw_versiones.object.cliente[j] = data	
					Next
					
					dw_piezas.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
					dw_piezas.filter()
					For j = 1 To dw_piezas.rowcount()
						dw_piezas.object.cliente[j] = data
					Next
					
					dw_piezas.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
					dw_piezas.filter()
					For j = 1 To dw_archivos.rowcount()
						dw_archivos.object.cliente[j] = data		
					Next
				Next
			end if
			
			
			dw_propuestas.setfilter("modelo_propuesta_cliente = '"+data+"' ")
			dw_propuestas.filter()
		
			//Debe elegir el usuario una propuesta			
			dw_trabajos.setfilter("modelo_trabajo_cliente = '-1'")
			dw_trabajos.filter()
			
			dw_piezas.setfilter("cliente = '-1'")
			dw_piezas.filter()
			
			dw_versiones.setfilter("cliente = '-1'")
			dw_versiones.filter()
			
			dw_archivos.setfilter("cliente = '-1'")
			dw_archivos.filter()
		else
			dwo.Primary[row] = cliente
			return 2	
			/*
			else
				dwo.Primary[row] = ''
				this.object.genter_razon[Row] 		= ''
				this.object.cliente_actual[row] = ''
				return 2			
			end if
			*/
		end if

END CHOOSE


this.Accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo, modelo, cliente, propuesta, coleccion, relieve, cliente_relieve, razon
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda
Int repetidos, propuestas, i, j
Boolean cambiar_dependencias

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "cliente"
			modelo = dw_1.object.#1[dw_1.getrow()] 
			cliente = this.object.cliente[this.getrow()]
			cambiar_dependencias = false
			if not isnull(cliente) and cliente <> "" then
				dw_propuestas.setfilter("modelo_propuesta_cliente = '"+cliente+"' ")
				dw_propuestas.filter()
				propuestas = dw_propuestas.rowcount()
				if propuestas > 0 then
					if not isnull(modelo) and modelo <> "" then
//						SELECT COUNT(*) INTO :propuestas FROM modelo_propuestas WHERE empresa = :codigo_empresa AND cliente 
						MessageBox("Error","No puede cambiar un cliente que ya tiene propuestas")
						return
					else
						cambiar_dependencias = true
					end if
				end if
			end if
			
			coleccion = dw_1.object.coleccion[dw_1.getrow()]
			if isnull(coleccion) or coleccion = '' then
				MessageBox("Error","Debe indicar previamente la colección del modelo")
				return
			end if
			
			busqueda.titulo_ventana = "Búsqueda de Clientes"
			/*
			busqueda.consulta  = " SELECT genter.codigo, genter.razon "+&
										" FROM genter "+&
										" WHERE genter.empresa = '"+codigo_empresa+"' AND genter.tipoter = 'C' ORDER BY genter.razon"
			*/
			busqueda.consulta  = "SELECT genter.codigo, genter.razon "+&
										"FROM deshistorico INNER JOIN genter ON deshistorico.empresa = genter.empresa AND deshistorico.cliente = genter.codigo AND genter.tipoter = 'C' "+&
										"WHERE deshistorico.empresa = '"+codigo_empresa+"' AND deshistorico.coleccion = '"+coleccion+"' "+&
										"UNION SELECT genter.codigo, genter.razon FROM genter WHERE genter.codigo = '87' AND genter.tipoter = 'C' ORDER BY genter.razon"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Descripción"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				
				//Comprobamos el relieve (si es exclusivo no se puede utilizar)
				relieve = dw_1.object.relieve[dw_1.getrow()]
				if isnull(relieve) or relieve = "" then
					MessageBox("Error", "Debe indicar el relieve antes de buscar cliente")
					return
				else
					cliente_relieve = ""
					SELECT art_tipomoldura.cliente, genter.razon INTO :cliente_relieve, :razon FROM art_tipomoldura LEFT OUTER JOIN genter ON art_tipomoldura.empresa = genter.empresa AND art_tipomoldura.cliente = genter.codigo  AND genter.tipoter = 'C' WHERE art_tipomoldura.empresa = :codigo_empresa AND art_tipomoldura.codigo = :relieve;
					if not isnull(cliente_relieve) and cliente_relieve <> "" then
						if cliente_relieve <> resultado.valores[1] and resultado.valores[1] <> '87' then
							MessageBox("Error", "El relieve seleccionado es exclusivo del cliente "+razon+". Seleccione otro relieve antes de continuar.")
							return
						end if
					end if
				end if
				
				//Comprobamos que el cliente no este repetido
				repetidos = 0
				repetidos = Integer(this.Describe("Evaluate('sum(if(long(cliente) = "+resultado.valores[1]+",1,0))', 0)"))
				if repetidos > 0 then
					MessageBox("Error","El cliente seleccionado ya existe en el modelo")
					return
				end if
				
				
				this.object.cliente[this.GetRow()] 			= resultado.valores[1]		
				this.object.genter_razon[this.GetRow()] 	= resultado.valores[2]	
				this.object.cliente_actual[this.GetRow()] = resultado.valores[1]		
						
				if cambiar_dependencias then
					
					dw_propuestas.setfilter("modelo_propuesta_cliente = '"+cliente+"'")
					dw_propuestas.filter()
					propuestas = dw_propuestas.rowcount()
					For i = 1 To propuestas 
						dw_propuestas.object.modelo_propuesta_cliente[i] = resultado.valores[1]		
						propuesta = dw_propuestas.object.modelo_propuesta_codigo[i]
						
						dw_trabajos.setfilter("modelo_trabajo_cliente = '"+cliente+"' and modelo_trabajo_propuesta = '"+propuesta+"'")
						dw_trabajos.filter()
						For j = 1 To dw_trabajos.rowcount()
							dw_trabajos.object.modelo_trabajo_cliente[j] = resultado.valores[1]		
						Next
						
						dw_versiones.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
						dw_versiones.filter()
						For j = 1 To dw_versiones.rowcount()
							dw_versiones.object.cliente[j] = resultado.valores[1]		
						Next
						
						dw_piezas.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
						dw_piezas.filter()
						For j = 1 To dw_piezas.rowcount()
							dw_piezas.object.cliente[j] = resultado.valores[1]		
						Next
						
						dw_piezas.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
						dw_piezas.filter()
						For j = 1 To dw_archivos.rowcount()
							dw_archivos.object.cliente[j] = resultado.valores[1]		
						Next
					Next
				end if
				
				//Debe elegir el usuario una propuesta
				dw_propuestas.setfilter("modelo_propuesta_cliente = '"+resultado.valores[1]+"'")
				dw_propuestas.filter()
				
				dw_trabajos.setfilter("modelo_trabajo_cliente = '-1'")
				dw_trabajos.filter()
				
				dw_piezas.setfilter("cliente = '-1'")
				dw_piezas.filter()
				
				dw_versiones.setfilter("cliente = '-1'")
				dw_versiones.filter()
				
				dw_archivos.setfilter("cliente = '-1'")
				dw_archivos.filter()
				
			end if
	END CHOOSE
end if	
	
end event

event rowfocuschanged;call super::rowfocuschanged;String cliente
Long fila_cliente, fila_propuesta, i

fila_cliente = this.getrow()
if fila_cliente > 0 then
	cliente = this.object.cliente[fila_cliente]
else
	cliente = '-1'
end if

if isnull(cliente) or cliente = '' then
	cliente = '-1'
end if

dw_propuestas.setfilter("modelo_propuesta_cliente = '"+cliente+"' ")
dw_propuestas.filter()

//Seleccion fila y propuesta
fila_propuesta = dw_propuestas.rowcount()
seleccionar_fila (dw_propuestas,fila_propuesta,0)

//Marcado especial de fila seleccionada
/*
if currentrow > 0 then
	For i = 1 To this.rowcount()
		this.object.seleccionado[i] = 0
	Next
	
	this.object.seleccionado[currentrow] = 1
end if
*/
end event

type dw_archivos from u_dw within wtc_trabajos_disenyo_nuevo
integer x = 2025
integer y = 1900
integer width = 2359
integer height = 880
integer taborder = 70
string dataobject = "dwtc_modelo_archivo2"
boolean vscrollbar = true
end type

event itemchanged;call super::itemchanged;string resultado, resultado1, tipo, modelo, cliente, propuesta, codigo, descripcion, pieza, version_color, codigo_actual, tipo_maquina_disenyo_actual
dec  resultado2, resultado3
datetime resultado_fecha
int alerta, info, fila, ficheros, i

String serigrafia_codigo, serigrafia_nombre
Boolean serigrafia_automatica = true

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "tipo_maquina_disenyo"
		SELECT descripcion
		INTO :resultado
		FROM tipomaquina_disenyo
		WHERE empresa = :codigo_empresa
		and codigo = :data;
		
		//Si cambia el tipo, eliminar los archivos porque son dependientes
		if this.object.modelo_archivo_archivo_nombre_actual[Row] <> "" then
			if MessageBox("Atención", "Cambiar el tipo de máquina, pondrá en blanco la casilla de archivo, ¿desea continuar?", Question!, YesNo!, 2) = 2 then
				tipo_maquina_disenyo_actual  = this.object.tipo_maquina_disenyo_actual[Row]
				SELECT descripcion
				INTO :resultado
				FROM tipomaquina_disenyo
				WHERE empresa = :codigo_empresa
				and codigo = :tipo_maquina_disenyo_actual;
				dwo.Primary[row] = tipo_maquina_disenyo_actual
				this.object.tipomaquina_disenyo_descripcion[Row] = resultado
				return 2		
			end if
		end if
		this.object.modelo_archivo_archivo_nombre_actual[Row]	= ""
		this.object.archivo_disenyo[Row] 			= ""	
		this.object.archivo_disenyo_nombre[Row] 	= ""
		
		this.object.modelo_archivo_dependencia[Row] 	= ""		
		this.object.archivo_disenyo_nombre_1[Row] 		= ""
		
		this.object.dependiente[row] = 0
		this.object.usado[row] = 0
		this.object.ficheros[row] = 0

		if SQLCA.sqlcode <> 100 then
			this.object.tipomaquina_disenyo_descripcion[Row] 		= resultado
			this.object.tipo_maquina_disenyo_actual[Row] = resultado
			
			if data = "3" then
				//Serigrafía automática
				//Condiciones
				//Se aplica solo al primer archivo de serigrafía que se añade
				
				dw_archivos.setredraw(false)
				//Filtro actual de archivos
				//modelo = dw_archivos.object.modelo[dw_archivos.getrow()]
				cliente = dw_archivos.object.cliente[dw_archivos.getrow()]
				propuesta = dw_archivos.object.propuesta[dw_archivos.getrow()]
				pieza = dw_archivos.object.pieza[dw_archivos.getrow()]
				version_color = dw_archivos.object.modelo_version[dw_archivos.getrow()]
				
				//Filtro para ver todas los archivos de la misma pieza y obtener la serigrafía común
				dw_archivos.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"' and pieza = '"+pieza+"' and tipo_maquina_disenyo = '3'")
				dw_archivos.filter()
				
				serigrafia_codigo = ""
				serigrafia_nombre = ""
				For i=1 To dw_archivos.rowcount()
					if serigrafia_codigo = "" then
						serigrafia_codigo = dw_archivos.object.archivo_disenyo[i]
						serigrafia_nombre = dw_archivos.object.archivo_disenyo_nombre[i]
					else
						codigo_actual = dw_archivos.object.archivo_disenyo[i]
						if not isnull(codigo_actual) and codigo_actual <> "" and serigrafia_codigo <> codigo_actual then
							//Más de un codigo - No aplicamos el sistema de codigo automático
							serigrafia_automatica = false
						end if
					end if
				Next
				
				//Restablecer Filtro
				dw_archivos.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"' and pieza = '"+pieza+"' and modelo_version = '"+version_color+"'")
				dw_archivos.filter()
				
				if serigrafia_codigo <> "" and serigrafia_automatica then
					dw_archivos.object.archivo_disenyo[Row] 			= 	serigrafia_codigo
					dw_archivos.object.archivo_disenyo_nombre[Row] 	= serigrafia_nombre
				end if
				
				dw_archivos.setredraw(true)
			end if
			
		else			
			dwo.Primary[row] = ''
			this.object.tipomaquina_disenyo_descripcion[Row] 		= ''
			return 2			
		end if
	CASE "archivo_disenyo"
		tipo = this.object.tipo_maquina_disenyo[Row]
		if isnull(tipo) or tipo = "" then
			MessageBox("Error","Debe seleccionar un tipo de maquina antes de indicar el archivo")
			dwo.Primary[row] = this.object.modelo_archivo_archivo_nombre_actual[row]
			return 2
		end if
		SELECT nombre
		INTO :resultado
		FROM archivo_disenyo
		WHERE empresa = :codigo_empresa 
		AND tipomaquina_disenyo = :tipo 
		and codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.archivo_disenyo_nombre[Row] 		= resultado
			alerta = 0
			ficheros = 0
			modelo = f_codigo_principal()
			SELECT COUNT(*) INTO :alerta FROM modelo_archivo m2 WHERE m2.empresa = :codigo_empresa AND m2.tipo_maquina_disenyo = :tipo AND m2.archivo_disenyo = :data AND modelo <> :modelo ;
			this.object.dependiente[Row] = alerta
			SELECT COUNT(*) INTO :ficheros FROM archivo_disenyo_sistema_archivos A WHERE A.empresa = :codigo_empresa AND A.tipomaquina_disenyo = :tipo AND A.archivo = :data;
			this.object.ficheros[Row] = ficheros
		else
			dwo.Primary[row] = ''
			this.object.archivo_disenyo_nombre[Row] 		= ''
			this.object.dependiente[Row] = 0
			this.object.ficheros[Row] = 0
			return 2			
		end if	
			
	CASE "modelo_version"
		fila = dw_versiones.Find("codigo = '"+data+"'", 0, dw_versiones.rowcount())
		if fila > 0 then
			codigo = dw_versiones.object.codigo[fila]
			descripcion = dw_versiones.object.descripcion[fila]
			this.object.modelo_version[row] = codigo
			this.object.modelo_version_descripcion [row] = descripcion
		else
			dwo.Primary[row] = ''
			this.object.modelo_version_descripcion[Row] = ''
			return 2	
		end if
		/*
		modelo = dw_1.object.#1[dw_1.getrow()]
		cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
		propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.getrow()]
		
		SELECT descripcion
		INTO :resultado
		FROM modelo_version
		WHERE empresa = :codigo_empresa 
		AND modelo = :modelo 
		AND cliente = :cliente 
		AND propuesta = :propuesta 
		and codigo = :data;

		if SQLCA.sqlcode <> 100 then
			
		else
			dwo.Primary[row] = ''
			return 2			
		end if	
		*/
	CASE "modelo_archivo_dependencia"
		tipo = this.object.tipo_maquina_disenyo[Row]
		if isnull(tipo) or tipo = "" then
			MessageBox("Error","Debe seleccionar un tipo de maquina antes de indicar el archivo")
			dwo.Primary[row] = this.object.modelo_archivo_dependencia_nombre_actual[row]
			return 2
		end if
		SELECT nombre
		INTO :resultado
		FROM archivo_disenyo
		WHERE empresa = :codigo_empresa 
		AND tipomaquina_disenyo = :tipo 
		and codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.archivo_disenyo_nombre_1[Row] 		= resultado
			modelo = f_codigo_principal()
			info = 0
			SELECT COUNT(*) INTO :info FROM modelo_archivo m2 WHERE m2.empresa = :codigo_empresa AND m2.tipo_maquina_disenyo = :tipo AND m2.dependencia = :data and modelo <> :modelo;
			this.object.usado[Row] = info
		else
			dwo.Primary[row] = ''
			this.object.archivo_disenyo_nombre_1[Row] 		= ''
			this.object.usado[Row] = 0
			return 2			
		end if
END CHOOSE


this.Accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo, modelo, cliente, propuesta, tipo, codigo, tipo_maquina_disenyo_actual, descripcion
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda
Int alerta, info, num_versiones, ficheros

//if key = KeyF8! then
	//dw_1.EVENT usr_keydown(key, keyflags)
//end if

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "tipo_maquina_disenyo"
			busqueda.titulo_ventana = "Búsqueda de Tipo de Archivo "
			busqueda.consulta  =  "  SELECT tipomaquina_disenyo.codigo, tipomaquina_disenyo.descripcion "+&
										 "  FROM   tipomaquina_disenyo   "+&
										 "  WHERE  tipomaquina_disenyo.empresa = '"+codigo_empresa+"'"+&
	 									 "  ORDER BY tipomaquina_disenyo.descripcion ASC  "
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Tipo de Máquina"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				if this.object.archivo_disenyo_nombre[this.GetRow()] <> "" then
					if MessageBox("Atención", "Cambiar el tipo de máquina, pondrá en blanco la casilla del archivo, ¿desea continuar?", Question!, YesNo!, 2) = 2 then
						tipo_maquina_disenyo_actual  = this.object.tipo_maquina_disenyo_actual[this.GetRow()]
						SELECT descripcion
						INTO :descripcion
						FROM tipomaquina_disenyo
						WHERE empresa = :codigo_empresa
						and codigo = :tipo_maquina_disenyo_actual;
						this.object.tipo_maquina_disenyo[this.GetRow()] 						= tipo_maquina_disenyo_actual		
						this.object.tipomaquina_disenyo_descripcion[this.GetRow()] 			= descripcion
						return 
					end if
				end if
				this.object.tipo_maquina_disenyo[this.GetRow()] 						= resultado.valores[1]		
				this.object.tipo_maquina_disenyo_actual[this.GetRow()]				= resultado.valores[1]		
				this.object.tipomaquina_disenyo_descripcion[this.GetRow()] 			= resultado.valores[2]	
				this.object.modelo_archivo_archivo_nombre_actual[this.GetRow()]	= ""
				
				//Si cambia el tipo, eliminar los archivos porque son dependientes
				this.object.archivo_disenyo[this.GetRow()] 			= ""	
				this.object.archivo_disenyo_nombre[this.GetRow()] 	= ""
				
				this.object.modelo_archivo_dependencia[this.GetRow()] 	= ""		
				this.object.archivo_disenyo_nombre_1[this.GetRow()] 		= ""	
				
				this.object.dependiente[this.GetRow()] = 0
				this.object.usado[this.GetRow()] = 0
				this.object.ficheros[this.GetRow()] = 0
			end if

		CASE "archivo_disenyo"
			tipo = this.object.tipo_maquina_disenyo[this.getrow()]
			if isnull(tipo) or tipo = "" then
				MessageBox("Error","Debe seleccionar un tipo de maquina antes de indicar el archivo")
				return
			end if
			busqueda.titulo_ventana = "Búsqueda de Archivos de Diseño"
			busqueda.consulta  = " SELECT codigo, nombre "+&
										" FROM archivo_disenyo "+&
										" WHERE empresa = '"+codigo_empresa+"' AND tipomaquina_disenyo = '"+tipo+"' ORDER BY codigo ASC"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Formato"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				codigo = resultado.valores[1]
				this.object.archivo_disenyo[this.GetRow()] 		= codigo
				this.object.archivo_disenyo_nombre[this.GetRow()] 		= resultado.valores[2]		
				modelo = f_codigo_principal()
				alerta = 0
				ficheros = 0
				SELECT COUNT(*) INTO :alerta FROM modelo_archivo m2 WHERE m2.empresa = :codigo_empresa AND m2.tipo_maquina_disenyo = :tipo AND m2.archivo_disenyo = :codigo AND modelo <> :modelo;
				SELECT COUNT(*) INTO :ficheros FROM archivo_disenyo_sistema_archivos A WHERE A.empresa = :codigo_empresa AND A.tipomaquina_disenyo = :tipo AND A.archivo = :codigo;
				this.object.dependiente[this.GetRow()] = alerta
				this.object.ficheros[this.GetRow()] = ficheros
			end if

		CASE "modelo_version"
			num_versiones = dw_versiones.rowcount()
			popup_versiones.reset()
			if num_versiones > 0 then
				dw_versiones.RowsCopy(1, num_versiones, Primary!, popup_versiones, 1, Primary!)
				popup_versiones.visible = true
				cb_popup_versiones.visible = true
				dw_archivos.SelectRow(0, false)
				dw_archivos.SelectRow(dw_archivos.getrow(), true)
			end if
			
			/*
			modelo = dw_1.object.#1[dw_1.getrow()]
			cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
			propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.getrow()]

			busqueda.titulo_ventana = "Búsqueda de Versiones de Color"
			busqueda.consulta  = " SELECT CODIGO, DESCRIPCION "+&
										" FROM modelo_version "+&
										" WHERE empresa = '"+codigo_empresa+"' AND modelo = '"+modelo+"' AND cliente = '"+cliente+"' AND propuesta = '"+propuesta+"' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Relieve "
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_version[this.GetRow()] 			= resultado.valores[1]		
			end if
			*/
		CASE "modelo_archivo_dependencia"
			tipo = this.object.tipo_maquina_disenyo[this.getrow()]
			if isnull(tipo) or tipo = "" then
				MessageBox("Error","Debe seleccionar un tipo de maquina antes de indicar el archivo")
				return
			end if
			
			busqueda.titulo_ventana = "Búsqueda de Archivo para dependencia"
			busqueda.consulta  = " SELECT codigo, nombre "+&
										" FROM archivo_disenyo "+&
										" WHERE empresa = '"+codigo_empresa+"' AND tipomaquina_disenyo = '"+tipo+"' ORDER BY CONVERT(integer,codigo) ASC"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Nombre "
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				codigo = resultado.valores[1]		
				this.object.modelo_archivo_dependencia[this.GetRow()] 	= codigo
				this.object.archivo_disenyo_nombre_1[this.GetRow()] 		= resultado.valores[2]	
				modelo = f_codigo_principal()
				info = 0
				SELECT COUNT(*) INTO :info FROM modelo_archivo m2 WHERE m2.empresa = :codigo_empresa AND m2.tipo_maquina_disenyo = :tipo AND m2.dependencia = :codigo AND modelo <> :modelo;
				this.object.usado[this.GetRow()] = info
			end if
	END CHOOSE
end if	
	
end event

event clicked;call super::clicked;String codigo_nuevo, prefijo, nombre, tipo
str_colisiones pcolisiones

str_parametros lstr_param
long esta_abierta, aviso

Datastore dependencias 
String modelo, sel, articulos, articulos1, articulos2, archivo
Int i, numero, numero1, numero2

str_ventana_alerta parametros
string botones[2]

CHOOSE CASE dwo.name
	CASE "p_archivos"
		if hay_cambios() then
			//MessageBox("Atención", "Debe guardar los cambios antes de gestionar los archivos de la pieza")
			if f_guardar() <> 1 then
				return //Fallo de validación en la grabación
			end if
		end if
		
		if f_codigo_principal() = "" then
			return
		end if
		
		//La ventana será response
		lstr_param.s_argumentos[1] = this.object.tipo_maquina_disenyo[row]
		lstr_param.s_argumentos[2] = this.object.archivo_disenyo[row]
		lstr_param.s_argumentos[3] = this.object.archivo_disenyo_nombre[row]
		lstr_param.i_nargumentos = 3
		lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
		lstr_param.resultado = ''
		Openwithparm(wtc_mant_archivos_disenyo_sistema_archivos, lstr_param)
		
	CASE "p_nuevo"
		tipo = this.object.tipo_maquina_disenyo[row]
		if isnull(tipo) or tipo = "" then
			MessageBox("Error","Debe indicar el tipo de máquina para generar un archivo nuevo.")
			destroy dependencias
			return
		end if
		if not isnull(this.object.archivo_disenyo[row]) and this.object.archivo_disenyo[row] <> "" then
			parametros.titulo = "Atención"
			parametros.subtitulo = "Nuevo Archivo"
			parametros.mensaje = "Va a generar un archivo nuevo, ¿desea reemplazar el archivo actual "+String(this.object.archivo_disenyo_nombre[row])+" por uno nuevo?"
			botones[1] = "Sí"
			botones[2] = "No"
			parametros.tipo = 2
			parametros.botones = botones
			parametros.mostrar_imagen = true
			openwithparm(wtc_ventana_alerta, parametros)
			aviso = Int(Message.DoubleParm)
			if aviso = 2 then
				destroy dependencias
				return
			end if
		end if

		//--------------------------------------------------------------------------------------------
		// Inicio de trans_ts
		//--------------------------------------------------------------------------------------------
		pcolisiones.empresa = codigo_empresa
		pcolisiones.tabla = "archivo_disenyo"
		pcolisiones.campo = "codigo"
		pcolisiones.filtro = pcolisiones.tabla+".tipomaquina_disenyo = '"+this.object.tipo_maquina_disenyo[row]+"'"				
		pcolisiones.buscar_huecos = true
		codigo_nuevo = String(f_colisiones(trans_ts, pcolisiones))
		
		if codigo_nuevo = '0'  then
			messagebox("ERROR", "No se ha podido generar un archivo nuevo. Intentelo mas tarde y si ocurre el error de nuevo contacte con el administrador.")
			ROLLBACK USING trans_ts;
		else
		//--------------------------------------------------------------------------------------------
			// Creación del nombre para el fichero
			SELECT prefijo INTO :prefijo FROM tipomaquina_disenyo WHERE empresa = :codigo_empresa AND codigo = :tipo using trans_ts;
			nombre = prefijo + codigo_nuevo
			
			INSERT INTO archivo_disenyo (empresa, tipomaquina_disenyo, codigo, nombre) VALUES (:codigo_empresa,:tipo,:codigo_nuevo,:nombre) USING trans_ts;
			IF trans_ts.SQLCode <> 0 THEN         
				ROLLBACK USING trans_ts;
				MessageBox("Error","SQL error en la inserción de archivo ")				
				
			END IF
				
			this.object.archivo_disenyo[row] = codigo_nuevo
			this.object.archivo_disenyo_nombre[row] = nombre
		//--------------------------------------------------------------------------------------------
			
			COMMIT USING trans_ts;
		end if
		//--------------------------------------------------------------------------------------------
		// Fin de trans_ts
		//--------------------------------------------------------------------------------------------
		
		
	CASE "p_alerta"
		tipo = this.object.tipo_maquina_disenyo[row]
		if isnull(tipo) or tipo = "" then
			destroy dependencias
			return
		end if
		archivo = this.object.archivo_disenyo[row]
		if isnull(archivo) or archivo = ""  then
			destroy dependencias
			return
		end if
		modelo = f_codigo_principal()
		sel = "SELECT DISTINCT modelo "+&
				"FROM modelo_archivo "+&
				"WHERE empresa = '"+codigo_empresa+"' AND tipo_maquina_disenyo = '"+tipo+"' AND archivo_disenyo = '"+archivo+"'"
		f_cargar_cursor_transaccion (SQLCA,  dependencias,  sel)
		numero = dependencias.RowCount()
		i = 1
		articulos = ""
		do while (i <= numero) 
			if i > 1 then
				articulos = articulos + ", "+ dependencias.object.modelo[i]
			else
				articulos = articulos + dependencias.object.modelo[i]
			end if
			i++
		loop
		if numero > 0 then
			MessageBox("Modelos dependientes del archivo","Los siguientes modelos dependen de este archivo: "+articulos)
		end if
	CASE "p_info"
		tipo = this.object.tipo_maquina_disenyo[row]
		if isnull(tipo) or tipo = "" then
			destroy dependencias
			return
		end if
		archivo = this.object.modelo_archivo_dependencia[row]
		if isnull(archivo) or archivo = ""  then
			destroy dependencias
			return
		end if
		modelo = f_codigo_principal()
		
		//Modelos origen
		sel = "SELECT DISTINCT modelo "+&
				"FROM modelo_archivo "+&
				"WHERE empresa = '"+codigo_empresa+"' AND tipo_maquina_disenyo = '"+tipo+"' AND archivo_disenyo = '"+archivo+"'"
		f_cargar_cursor_transaccion (SQLCA,  dependencias,  sel)
		numero1 = dependencias.RowCount()
		i = 1
		articulos1 = ""
		do while (i <= numero1) 
			if i > 1 then
				articulos1 = articulos1 + ", "+ dependencias.object.modelo[i]
			else
				articulos1 = articulos1 + dependencias.object.modelo[i]
			end if
			i++
		loop
		
		//Modelos dependientes
		sel = "SELECT DISTINCT modelo "+&
				"FROM modelo_archivo "+&
				"WHERE empresa = '"+codigo_empresa+"' AND tipo_maquina_disenyo = '"+tipo+"' AND dependencia = '"+archivo+"'"
		f_cargar_cursor_transaccion (SQLCA,  dependencias,  sel)
		numero2 = dependencias.RowCount()
		i = 1
		articulos = ""
		do while (i <= numero2) 
			if i > 1 then
				articulos2 = articulos2 + ", "+ dependencias.object.modelo[i]
			else
				articulos2 = articulos2 + dependencias.object.modelo[i]
			end if
			i++
		loop
		if numero1 > 0 then
			MessageBox("Modelos origen del archivo","Los modelos origen de este archivo son: "+articulos1)
		end if
		if numero2 > 0 then
			MessageBox("Otros modelos dependientes del archivo","Los modelos que también dependen del archivo "+String(this.object.archivo_disenyo_nombre_1[row])+" son: "+articulos2)
		end if
END CHOOSE

destroy dependencias


end event

type dw_con_piezas_coleccion from u_dw within wtc_trabajos_disenyo_nuevo
integer x = 4393
integer y = 1900
integer width = 891
integer height = 880
integer taborder = 80
string dataobject = "dwtc_coleccion_modelos"
boolean vscrollbar = true
end type

event clicked;call super::clicked;str_parametros lstr_param 

if row > 0 then
	if dwo.name = "modelo_modelo" then
		padre_codigo = this.object.modelo_modelo[row]	
		
		lstr_param.s_argumentos[1] = padre_codigo
		lstr_param.i_nargumentos = 1
		lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
		lstr_param.resultado = ''
		
		Message.PowerObjectParm = lstr_param
		Parent.triggerevent(open!)
	end if
end if
end event

type pb_2 from picturebutton within wtc_trabajos_disenyo_nuevo
string tag = "Exposición"
boolean visible = false
integer x = 827
integer y = 96
integer width = 146
integer height = 128
integer taborder = 110
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\presentation.png"
alignment htextalign = left!
string powertiptext = "Archivos Exposición"
end type

event clicked;str_parametros lstr_param
long esta_abierta

if hay_cambios() then
	//MessageBox("Atención", "Debe guardar los cambios antes de modificar los archivos de la exposición")
	if f_guardar() <> 1 then
		return
	end if
end if

if isnull(dw_1.object.funcion[dw_1.getrow()]) or dw_1.object.funcion[dw_1.getrow()] = "" then
	MessageBox("Error", "Debe indicar la función del modelo y guardar, antes de modificar los archivos de la exposición")
	return
end if

if isnull(dw_1.object.pavrev[dw_1.getrow()]) or dw_1.object.pavrev[dw_1.getrow()] = "" then
	MessageBox("Error", "Debe indicar si el modelo es un pavimento o un revestimiento y guardar, antes de modificar los archivos de la exposición")
	return
end if

esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_modelo_archivo")
//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
if esta_abierta = -1 then
	lstr_param.s_argumentos[1] = dw_1.object.coleccion[dw_1.getrow()]
	lstr_param.s_argumentos[2] = f_codigo_principal()
	lstr_param.i_nargumentos = 2
	lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
	lstr_param.resultado = ''
	Openwithparm(wtc_mant_modelo_archivo, lstr_param)
else
	ventanas_activas[esta_abierta].ventana.BringToTop = true
end if
end event

type p_seleccion from picture within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 4535
integer y = 156
integer width = 73
integer height = 64
boolean bringtotop = true
boolean originalsize = true
string picturename = "C:\Tencer_PB12\fila_seleccionada.png"
boolean focusrectangle = false
end type

type pb_archivos_modelo from picturebutton within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 2121
integer y = 88
integer width = 146
integer height = 128
integer taborder = 120
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "C:\Tencer_PB12\index.png"
alignment htextalign = left!
string powertiptext = "Archivos del Modelo"
end type

event clicked;str_parametros lstr_param
long esta_abierta

if hay_cambios() then
	MessageBox("Atención", "Debe guardar los cambios antes de gestionar los archivos de disenyo")
	return
end if

if f_codigo_principal() = "" then
	return
end if

//La ventana será response
lstr_param.s_argumentos[1] = f_codigo_principal()
lstr_param.i_nargumentos = 1
lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
lstr_param.resultado = ''
Openwithparm(wtc_mant_modelo_sistema_archivos, lstr_param)

end event

type cb_tr from commandbutton within wtc_trabajos_disenyo_nuevo
integer x = 4288
integer y = 124
integer width = 873
integer height = 100
integer taborder = 130
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Traspaso Tiffs y Serigrafía"
end type

event clicked;//Serigrafia
DELETE FROM archivo_disenyo WHERE tipomaquina_disenyo = 3 AND codigo IN (SELECT modelo FROM desmodelo);
INSERT INTO archivo_disenyo (empresa, tipomaquina_disenyo, codigo, nombre) SELECT :codigo_empresa, 3, modelo, ("S"+modelo) FROM desmodelo;

//Tiffs
DELETE FROM archivo_disenyo WHERE tipomaquina_disenyo = 1 AND codigo IN (SELECT codigo FROM desimagenestif);
INSERT INTO archivo_disenyo (empresa, tipomaquina_disenyo, codigo, nombre) SELECT :codigo_empresa, 1, codigo, ("T"+codigo) FROM desimagenestif;
end event

type dw_imagen from u_dw_imagen within wtc_trabajos_disenyo_nuevo
integer x = 4827
integer y = 2868
integer width = 960
integer height = 720
integer taborder = 120
end type

type pb_3 from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 357
integer y = 96
integer width = 146
integer height = 128
integer taborder = 200
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\index_view.png"
alignment htextalign = right!
string powertiptext = "Búsqueda por Archivo de Pieza"
end type

event clicked;string campo
String cliente, propuesta, pieza, coleccion_nueva
Long fila_cliente, produccion
long numero_valores
str_wt_busquedas_salida resultado_busqueda
integer columna

campo = dw_1.GetColumnName()

padre_busqueda.filtro_es_codigo = false

padre_busqueda.consulta =  " SELECT DISTINCT modelo.modelo, archivo_disenyo.nombre, modelo_pieza.codigo_lab, art_grupo2.descripcion, tecnico_dis.descripcion, comercial.descripcion, CONVERT(integer, modelo.modelo) AS orden "+&
									" FROM modelo "+&
									" LEFT OUTER JOIN modelo_archivo ON modelo.empresa = modelo_archivo.empresa AND modelo.modelo = modelo_archivo.modelo "+&
									" LEFT OUTER JOIN modelo_pieza ON modelo_archivo.empresa = modelo_pieza.empresa AND modelo_archivo.modelo = modelo_pieza.modelo AND modelo_archivo.cliente = modelo_pieza.cliente AND modelo_archivo.propuesta = modelo_pieza.propuesta AND modelo_archivo.pieza = modelo_pieza.codigo "+&
									" LEFT OUTER JOIN archivo_disenyo ON modelo_archivo.empresa = archivo_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo.codigo "+&
									" LEFT OUTER JOIN tecnico_dis ON modelo.empresa = tecnico_dis.empresa AND modelo.tecnico_dis = tecnico_dis.codigo  "+&
									" LEFT OUTER JOIN comercial ON modelo.comercial = comercial.codigo AND modelo.empresa = comercial.empresa "+&
									" LEFT OUTER JOIN descoleccionsol ON modelo.empresa = descoleccionsol.empresa AND modelo.coleccion = descoleccionsol.codigo "+&
									" LEFT OUTER JOIN art_grupo2 ON modelo.funcion = art_grupo2.codigo "+&
									" WHERE modelo.empresa = '"+codigo_empresa+"' AND archivo_disenyo IS NOT NULL "+&
									" ORDER BY orden desc  "

padre_busqueda.titulos[1] = "Modelo"
padre_busqueda.titulos[2] = "Archivo"
padre_busqueda.titulos[3] = "Pieza"
padre_busqueda.titulos[4] = "Función"
padre_busqueda.titulos[5] = "Diseñador"
padre_busqueda.titulos[6] = "Comercial"		
padre_busqueda.titulos[7] = "Modelo"		

if hay_cambios() = true then
	if MessageBox("Atención", "¿Desea grabar las modificaciones?", Exclamation!, YesNo!, 2) = 1 then
		if f_guardar() <> 1 then
			return //Fallo de validación en la grabación, no buscar
		end if
	end if
end if

columna = dw_1.GetColumn()
OpenWithParm(wt_busquedas, padre_busqueda)
resultado_busqueda = Message.PowerObjectParm		// Devuelve el valor que encuentra ...
if resultado_busqueda.error = '' then
	numero_valores = UpperBound(resultado_busqueda.valores)
	if not isnull(numero_valores) and numero_valores >= 1 then
		dw_1.retrieve (codigo_empresa, resultado_busqueda.valores[1])
		padre_codigo = dw_1.object.#1[1]
		estado = 1 // Modo edición
	else
		padre_codigo = ""
		if dw_1.rowcount() > 0 then
			if dw_1.getrow() > 0 and dw_1.object.#1[dw_1.getrow()] <> "" then
				padre_codigo = dw_1.object.#1[dw_1.getrow()]
			end if
		end if
	end if
else
	messagebox("Error", resultado_busqueda.error )
end if

mostrar_controles_edicion()

dw_1.setfocus()
if dw_1.rowcount() > 0 then
	dw_1.SetColumn(columna)
end if


if padre_codigo <> "" then
	
	dw_clientes.SetRedraw(false)
	dw_propuestas.SetRedraw(false)	
	dw_trabajos.SetRedraw(false)	
	dw_versiones.SetRedraw(false)	
	dw_piezas.SetRedraw(false)	
	dw_archivos.SetRedraw(false)
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// AQUÍ PONDREMOS TODOS LOS DATAWINDOWS AUXILIARES
	
	dw_clientes.retrieve(codigo_empresa,padre_codigo)
	coleccion_nueva = dw_1.object.coleccion[dw_1.getrow()]
	if not isnull(coleccion_nueva) and coleccion_nueva <> '' then
		dw_con_piezas_coleccion.retrieve (codigo_empresa, coleccion_nueva)
	end if
	dw_clientes.retrieve (codigo_empresa, padre_codigo)	
	dw_propuestas.retrieve (codigo_empresa, padre_codigo)	
	dw_trabajos.retrieve (codigo_empresa, padre_codigo)
	dw_versiones.retrieve (codigo_empresa, padre_codigo)	
	dw_piezas.retrieve (codigo_empresa, padre_codigo)	
	dw_archivos.retrieve (codigo_empresa, padre_codigo)	
	f_cargar_imagen_expo()
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//p_imagen.PictureName = f_cargar_imagen_nuevo(padre_codigo)
	fila_cliente = dw_clientes.rowcount()
	seleccionar_fila (dw_clientes,fila_cliente,3)
	
	dw_clientes.SetRedraw(true)
	dw_propuestas.SetRedraw(true)	
	dw_trabajos.SetRedraw(true)	
	dw_versiones.SetRedraw(true)	
	dw_piezas.SetRedraw(true)	
	dw_archivos.SetRedraw(true)
	
	//En producción
	produccion = 0
	SELECT COUNT(*) INTO :produccion FROM articulos WHERE empresa = :codigo_empresa AND modelo_origen = :padre_codigo using sqlca;
	if produccion > 0 then
		st_produccion.visible = true
	else
		st_produccion.visible = false
	end if
	
end if
end event

type dw_imp_lab from datawindow within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 4891
integer y = 432
integer width = 686
integer height = 400
integer taborder = 130
boolean bringtotop = true
string title = "none"
string dataobject = "report_solicitud_laboratorio2"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type dw_fecha_necesidad from u_dw within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 1810
integer y = 748
integer width = 2075
integer height = 944
integer taborder = 110
boolean bringtotop = true
string dataobject = "dwtc_fecha_necesidad"
boolean border = true
borderstyle borderstyle = styleraised!
end type

event buttonclicking;call super::buttonclicking;Long fila_principal, fila_trabajo, fila_trabajo_nueva, fila_propuesta
string botones[2]
str_ventana_alerta parametros
Int aviso, fila, resultado, npiezas, i, pasado
String codigo, comercial, coleccion, tecnico, formato, base, version_color, version_color_trabajo
String modelo, cliente, propuesta, version_seleccionada
Datetime fecha_necesidad
Dwobject temp

this.accepttext()
dw_bases.accepttext()

if dwo.name = "b_continuar" then	
//	NO AVISAMOS
//	parametros.titulo = "Atención"
//	parametros.subtitulo = "Pasar a Pieza"
//	parametros.mensaje = "¿Seguro que desea pasar a pieza?~nEstos cambios se guardarán inmediatamente una vez realizados."
//	botones[1] = "Sí"
//	botones[2] = "No"
//	parametros.tipo = 2
//	parametros.botones = botones
//	parametros.mostrar_imagen = true
//	openwithparm(wtc_ventana_alerta, parametros)
//	aviso = Int(Message.DoubleParm)
	aviso = 1
	
	fila_principal = dw_1.getrow()
	fila_trabajo = dw_trabajos.getrow()
	fila_propuesta = dw_propuestas.getrow()
	codigo = f_codigo_principal()
	
	dw_fecha_necesidad.accepttext()
	//GRABADO PREVIO
	resultado = f_guardar()
	
	if resultado <> 1 then
		dw_trabajos.SelectRow(0, false)
		dw_fecha_necesidad.visible = false
		dw_bases.visible = false
		pb_bases_mas.visible = false
		pb_bases_menos.visible = false
		return -1
	end if
	
	fecha_necesidad = dw_fecha_necesidad.object.fecha_necesidad[1]
	if isnull(fecha_necesidad) or String(fecha_necesidad) = "00/00/00" then
		MessageBox("Error", "Debe indicar la fecha de necesidad")
		return -1
	end if
	
	version_color = dw_fecha_necesidad.object.version[1]
	if isnull(version_color) or version_color = "" then
		MessageBox("Error", "Debe indicar la versión de color")
		return -1
	end if
	
	if dw_bases.rowcount() <= 0 then
		MessageBox("Error", "Debe indicar al menos una base")
		return -1
	else
		For i = 1 To dw_bases.rowcount() 
			if isnull(dw_bases.object.codigo[i]) or dw_bases.object.codigo[i] = "" then
				MessageBox("Error", "Ha dejado una linea de base en blanco. Por favor, indique la base o borre la linea.")
				return -1 
			end if
			if isnull(dw_bases.object.base_final[i]) or dw_bases.object.base_final[i] = "" then
				MessageBox("Error", "Debe indicar si la base es DEFINITIVA o PROVISIONAL.")
				return -1 
			end if
		Next
	end if
	
	if dw_trabajos.rowcount() > 0 then
		//Datos del trabajo seleccionado necesarios
		comercial = dw_trabajos.object.modelo_trabajo_comercial[fila_trabajo]
		if isnull(comercial) or comercial = '' then
			MessageBox("Error", "Debe indicar el comercial del trabajo")
			dw_trabajos.SelectRow(0, false)
			dw_fecha_necesidad.visible = false
			dw_bases.visible = false
			pb_bases_mas.visible = false
			pb_bases_menos.visible = false
			return
		end if
		
		//Datos de la propuesta necesarios
		formato = dw_propuestas.object.modelo_propuesta_formato[fila_propuesta]
		if isnull(formato) or formato = '' then
			MessageBox("Error", "Debe indicar el formato de la propuesta")
			dw_trabajos.SelectRow(0, false)
			dw_fecha_necesidad.visible = false
			dw_bases.visible = false
			pb_bases_mas.visible = false
			pb_bases_menos.visible = false
			return
		end if
		npiezas = Integer(dw_propuestas.object.modelo_propuesta_numero_piezas[fila_propuesta])
		if isnull(npiezas) or npiezas <= 0 then
			MessageBox("Error", "Debe indicar el numero de piezas de la propuesta")
			dw_trabajos.SelectRow(0, false)
			dw_fecha_necesidad.visible = false
			dw_bases.visible = false
			pb_bases_mas.visible = false
			pb_bases_menos.visible = false
			return
		end if
		
		//Trabajo de diseño nuevo (pasar a pieza) solo si no se había pasado a pieza ya....
		version_color_trabajo = dw_trabajos.object.modelo_trabajo_modelo_version[fila_trabajo]
		if not isnull(version_color_trabajo) and version_color_trabajo <> "" then
			pasado = 1
		end if
	end if		
	
	if pasado > 0 then
		fila_trabajo_nueva = dw_trabajos.getrow()
		dw_trabajos.object.pasado[fila_trabajo_nueva] = 1
		dw_trabajos.object.pasar_pieza[fila_trabajo_nueva] = npiezas
	else
		//INTRODUCIMOS TODAS LAS VERSIONES DE COLOR PARA AGILIZAR - 29-07-2015 - Version color codigo "0"
		if version_color <> "0" then 
			i = dw_versiones.find("codigo = '"+version_color+"'", 1, dw_versiones.rowcount())
		else
			i = 1
		end if
		Do while i <= dw_versiones.rowcount() and resultado = 1  
			version_pieza = string(i)
			//Nuevo trabajo (pasar a pieza)
			pb_duplica_trabajo.triggerevent(clicked!)
			
			fila_trabajo_nueva = dw_trabajos.getrow()
			dw_trabajos.object.pasar_pieza[fila_trabajo_nueva] = npiezas //Solo puede haber un pasar pieza a la vez, por lo tanto guardamos()
			
			dw_trabajos.object.modelo_trabajo_comercial[fila_trabajo_nueva] = comercial
			temp = dw_trabajos.object.modelo_trabajo_comercial
			dw_trabajos.EVENT itemchanged(fila_trabajo_nueva, temp, comercial)
			dw_trabajos.object.modelo_trabajo_fecha_necesidad[fila_trabajo_nueva] = fecha_necesidad
			dw_trabajos.object.modelo_trabajo_observaciones[fila_trabajo_nueva] = "PASAR A PIEZA."
			//dw_trabajos.object.modelo_trabajo_observaciones[fila_trabajo_nueva] = "PASAR A PIEZA VERSION "+upper(dw_fecha_necesidad.object.version_descripcion[1])+"."
			dw_trabajos.object.modelo_trabajo_modelo_version[fila_trabajo_nueva] = dw_versiones.object.codigo[i]
			
			//También está pasado a pieza si existen piezas (No solo si se ha pasado la versión)
			pasado = dw_piezas.rowcount()
			if pasado > 0 then
				dw_trabajos.object.pasado[fila_trabajo_nueva] = 1
			end if
			
			//FORZAMOS EL GUARDADO PARA EVITAR INCONSISTENCIAS  PASANDO A PIEZA
			dw_trabajos.object.modelo_trabajo_comercial[fila_trabajo_nueva] = comercial // Rellenamos el comercial para que no de error al confimar campos obligatorios y luego lo dejamos en blanco
			resultado = f_guardar()
			//dw_trabajos.object.modelo_trabajo_comercial[fila_trabajo_nueva] = '' // Lo ponemos en blanco para que el comercial lo rellene 
			
			if version_color = "0" then
				i++
			else
				i = dw_versiones.rowcount() + 1 //SOLO PASAMOS ESA VERSIÓN DE COLOR (NO TODAS)
			end if
		loop
	end if
	
	if dw_trabajos.rowcount() > 0 then
		//FORZAMOS EL GUARDADO PARA EVITAR INCONSISTENCIAS PASANDO A PIEZA
		dw_trabajos.object.modelo_trabajo_comercial[fila_trabajo_nueva] = comercial // Rellenamos el comercial para que no de error al confimar campos obligatorios y luego lo dejamos en blanco
		resultado = f_guardar()
	//	dw_trabajos.object.modelo_trabajo_comercial[fila_trabajo_nueva] = '' // Lo ponemos en blanco para que el comercial lo rellene 

		if resultado <> 1 then
			Messagebox("Error", "Se ha producido un error en el guardado de pasar a pieza.")
			//dw_trabajos.object.pasar_pieza[fila_trabajo_nueva] = 0
			dw_trabajos.SelectRow(0, false)
			pb_cancelar.triggerevent(clicked!)
		end if
	end if
	
	dw_fecha_necesidad.visible = false
	dw_bases.visible = false
	pb_bases_mas.visible = false
	pb_bases_menos.visible = false
	popup_versiones.visible = false
else
	dw_fecha_necesidad.visible = false
	dw_bases.visible = false
	pb_bases_mas.visible = false
	pb_bases_menos.visible = false
	popup_versiones.visible = false
end if
dw_trabajos.SelectRow(0, false)

this.accepttext()

/*
//ANTES DE PERMITIR PASAR A PIEZA TODAS LAS VERSIONES DE COLOR A LA VEZ
Long fila_principal, fila_trabajo, fila_trabajo_nueva, fila_propuesta
string botones[2]
str_ventana_alerta parametros
Int aviso, fila, resultado, npiezas, i, pasado
String codigo, comercial, coleccion, tecnico, formato, base, version_color, version_color_trabajo
String modelo, cliente, propuesta, version_seleccionada
Datetime fecha_necesidad
Dwobject temp

this.accepttext()
dw_bases.accepttext()

if dwo.name = "b_continuar" then	
//	NO AVISAMOS
//	parametros.titulo = "Atención"
//	parametros.subtitulo = "Pasar a Pieza"
//	parametros.mensaje = "¿Seguro que desea pasar a pieza?~nEstos cambios se guardarán inmediatamente una vez realizados."
//	botones[1] = "Sí"
//	botones[2] = "No"
//	parametros.tipo = 2
//	parametros.botones = botones
//	parametros.mostrar_imagen = true
//	openwithparm(wtc_ventana_alerta, parametros)
//	aviso = Int(Message.DoubleParm)
	aviso = 1
	
	fila_principal = dw_1.getrow()
	fila_trabajo = dw_trabajos.getrow()
	fila_propuesta = dw_propuestas.getrow()
	codigo = f_codigo_principal()
	
	if aviso = 1 then
		dw_fecha_necesidad.accepttext()
		//GRABADO PREVIO
		resultado = f_guardar()
		
		if resultado <> 1 then
			dw_trabajos.SelectRow(0, false)
			dw_fecha_necesidad.visible = false
			dw_bases.visible = false
			pb_bases_mas.visible = false
			pb_bases_menos.visible = false
			return -1
		end if
		
		fecha_necesidad = dw_fecha_necesidad.object.fecha_necesidad[1]
		if isnull(fecha_necesidad) or String(fecha_necesidad) = "00/00/00" then
			MessageBox("Error", "Debe indicar la fecha de necesidad")
			return -1
		end if
		
		version_color = dw_fecha_necesidad.object.version[1]
		if isnull(version_color) or version_color = "" then
			MessageBox("Error", "Debe indicar la versión de color")
			return -1
		end if
		
		if dw_bases.rowcount() <= 0 then
			MessageBox("Error", "Debe indicar al menos una base")
			return -1
		else
			For i = 1 To dw_bases.rowcount() 
				if isnull(dw_bases.object.codigo[i]) or dw_bases.object.codigo[i] = "" then
					MessageBox("Error", "Ha dejado una linea de base en blanco. Por favor, indique la base o borre la linea.")
					return -1 
				end if
				if isnull(dw_bases.object.base_final[i]) or dw_bases.object.base_final[i] = "" then
					MessageBox("Error", "Debe indicar si la base es DEFINITIVA o PROVISIONAL.")
					return -1 
				end if
			Next
		end if
		
		if dw_trabajos.rowcount() > 0 then
			//Datos del trabajo seleccionado necesarios
			comercial = dw_trabajos.object.modelo_trabajo_comercial[fila_trabajo]
			if isnull(comercial) or comercial = '' then
				MessageBox("Error", "Debe indicar el comercial del trabajo")
				dw_trabajos.SelectRow(0, false)
				dw_fecha_necesidad.visible = false
				dw_bases.visible = false
				pb_bases_mas.visible = false
				pb_bases_menos.visible = false
				return
			end if
			
			//Datos de la propuesta necesarios
			formato = dw_propuestas.object.modelo_propuesta_formato[fila_propuesta]
			if isnull(formato) or formato = '' then
				MessageBox("Error", "Debe indicar el formato de la propuesta")
				dw_trabajos.SelectRow(0, false)
				dw_fecha_necesidad.visible = false
				dw_bases.visible = false
				pb_bases_mas.visible = false
				pb_bases_menos.visible = false
				return
			end if
			npiezas = Integer(dw_propuestas.object.modelo_propuesta_numero_piezas[fila_propuesta])
			if isnull(npiezas) or npiezas <= 0 then
				MessageBox("Error", "Debe indicar el numero de piezas de la propuesta")
				dw_trabajos.SelectRow(0, false)
				dw_fecha_necesidad.visible = false
				dw_bases.visible = false
				pb_bases_mas.visible = false
				pb_bases_menos.visible = false
				return
			end if
			
			//Trabajo de diseño nuevo (pasar a pieza) solo si no se había pasado a pieza ya....
			version_color_trabajo = dw_trabajos.object.modelo_trabajo_modelo_version[fila_trabajo]
			if not isnull(version_color_trabajo) and version_color_trabajo <> "" then
				pasado = 1
			else
				pb_duplica_trabajo.triggerevent(clicked!)
			end if
		else
			//Nuevo trabajo (pasar a pieza)
			pb_anyade_trabajo.triggerevent(clicked!)
		end if		
		
		fila_trabajo_nueva = dw_trabajos.getrow()
		dw_trabajos.object.pasar_pieza[fila_trabajo_nueva] = npiezas //Solo puede haber un pasar pieza a la vez, por lo tanto guardamos()
		
		if pasado > 0 then
			dw_trabajos.object.pasado[fila_trabajo_nueva] = 1
		else
			dw_trabajos.object.modelo_trabajo_comercial[fila_trabajo_nueva] = comercial
			temp = dw_trabajos.object.modelo_trabajo_comercial
			dw_trabajos.EVENT itemchanged(fila_trabajo_nueva, temp, comercial)
			dw_trabajos.object.modelo_trabajo_fecha_necesidad[fila_trabajo_nueva] = fecha_necesidad
			dw_trabajos.object.modelo_trabajo_observaciones[fila_trabajo_nueva] = "PASAR A PIEZA."
			//dw_trabajos.object.modelo_trabajo_observaciones[fila_trabajo_nueva] = "PASAR A PIEZA VERSION "+upper(dw_fecha_necesidad.object.version_descripcion[1])+"."
			dw_trabajos.object.modelo_trabajo_modelo_version[fila_trabajo_nueva] = version_color
			
			//También está pasado a pieza si existen piezas (No solo si se ha pasado la versión)
			pasado = dw_piezas.rowcount()
			if pasado > 0 then
				dw_trabajos.object.pasado[fila_trabajo_nueva] = 1
			end if
		end if
		
		if dw_trabajos.rowcount() > 0 then
			//FORZAMOS EL GUARDADO PARA EVITAR INCONSISTENCIAS EN EL DUPLICADO
			resultado = f_guardar()
			if resultado <> 1 then
				Messagebox("Error", "Se ha producido un error en el guardado de pasar a pieza.")
				//dw_trabajos.object.pasar_pieza[fila_trabajo_nueva] = 0
				dw_trabajos.SelectRow(0, false)
				pb_cancelar.triggerevent(clicked!)
			end if
		end if
	END IF	
	dw_fecha_necesidad.visible = false
	dw_bases.visible = false
	pb_bases_mas.visible = false
	pb_bases_menos.visible = false
else
	dw_fecha_necesidad.visible = false
	dw_bases.visible = false
	pb_bases_mas.visible = false
	pb_bases_menos.visible = false
end if
dw_trabajos.SelectRow(0, false)

this.accepttext()
*/
end event

event usr_dwnkey;call super::usr_dwnkey;string campo, acabado
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda
Long num_versiones, i, fila

//if key = KeyF8! then
	//dw_1.EVENT usr_keydown(key, keyflags)
//end if

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "version"	
			if dw_trabajos.object.pasado[dw_trabajos.getrow()] <= 0 then
				num_versiones = dw_versiones.rowcount()
				popup_versiones.reset()
				//29-07-2015 Agilizar monococcion y bicoccion
				acabado = dw_trabajos.object.modelo_trabajo_acabado_lab[dw_trabajos.getrow()]
				if not isnull(acabado) and (acabado = "1" or acabado = "2") and dw_trabajos.find("trim(modelo_trabajo_modelo_version) <> ''", 1, dw_trabajos.rowcount()) = 0 and dw_versiones.rowcount() > 1 then  
					fila = popup_versiones.insertrow(0)
					popup_versiones.object.codigo[fila] = "0"
					popup_versiones.object.descripcion[fila] = "TODAS LAS VERSIONES DE COLOR"
				end if
				//Fin Agilizar monococcion y bicoccion
				For i = 1 To num_versiones
					if dw_trabajos.find("modelo_trabajo_modelo_version = '"+dw_versiones.object.codigo[i]+"'", 1, dw_trabajos.rowcount()) = 0 then //NO INCLUIMOS VERSIONES DE COLOR YA PASADAS
						fila = popup_versiones.insertrow(0)
						popup_versiones.object.codigo[fila] = dw_versiones.object.codigo[i]
						popup_versiones.object.descripcion[fila] = dw_versiones.object.descripcion[i]
					end if
				Next
				if popup_versiones.rowcount() > 0 then
					//dw_versiones.RowsCopy(1, num_versiones, Primary!, popup_versiones, 1, Primary!)
					popup_versiones.visible = true
					cb_popup_versiones.visible = true
				end if
			end if
	END CHOOSE
end if	
	
end event

event itemchanged;call super::itemchanged;string resultado, codigo, descripcion, acabado
Long fila

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "fecha_necesidad"
		if dw_trabajos.object.pasado[dw_trabajos.getrow()] <= 0 then
			
		else
			dwo.Primary[row] = this.object.fecha_necesidad_a[row]
			return 2	
		end if
	CASE "version"
		if dw_trabajos.object.pasado[dw_trabajos.getrow()] <= 0 then
			acabado = dw_trabajos.object.modelo_trabajo_acabado_lab[dw_trabajos.getrow()]
			fila = dw_versiones.Find("codigo = '"+data+"'", 0, dw_versiones.rowcount())
			if data = "0" and not isnull(acabado) and (acabado = "1" or acabado = "2") and dw_versiones.rowcount() > 1 then //29-07-2015 Agilizar monococcion y bicoccion
				if dw_trabajos.find("trim(modelo_trabajo_modelo_version) <> '' ", 1, dw_trabajos.rowcount()) = 0 then //NO SE PUEDEN PASAR TODAS, PORQUE YA EXISTE ALGUNA PASADA
					dw_versiones.accepttext()
					this.object.version[row] = "0"
					this.object.version_descripcion [row] = "TODAS LAS VERSIONES DE COLOR"
					this.object.version_anterior [row] = "0"
				else
					dwo.Primary[row] = ''
					this.object.version_descripcion[Row] = ''
					this.object.version_anterior [row] = ''
					return 2
				end if
			elseif fila > 0 then
				dw_versiones.accepttext()
				codigo = dw_versiones.object.codigo[fila]
				descripcion = dw_versiones.object.descripcion[fila]
				fila = dw_trabajos.Find("modelo_trabajo_modelo_version = '"+data+"'", 0, dw_trabajos.rowcount())
				if fila > 0 then
					//No podemos pasar a pieza mas de una vez la misma version de color
					dwo.Primary[row] = this.object.version_anterior [row]
					MessageBox("Error", "Ya ha pasado a pieza esta versión de color")
					return 2	
				else
					this.object.version[row] = codigo
					this.object.version_descripcion [row] = descripcion
					this.object.version_anterior [row] = codigo
				end if
			else
				dwo.Primary[row] = ''
				this.object.version_descripcion[Row] = ''
				this.object.version_anterior [row] = ''
				return 2	
			end if
		else
			dwo.Primary[row] = this.object.version_anterior[row]
			return 2	
		end if
END CHOOSE


this.Accepttext()
end event

type dw_versiones from u_dw within wtc_trabajos_disenyo_nuevo
integer x = 37
integer y = 1900
integer width = 1979
integer height = 732
integer taborder = 60
boolean bringtotop = true
string dataobject = "dwtc_modelo_version3"
boolean vscrollbar = true
end type

event itemchanged;call super::itemchanged;Long i, filas
if row > 0 then
	CHOOSE CASE dwo.name
		CASE "descripcion"
			filas = dw_archivos.rowcount()
			For i = 1 To filas
				if dw_archivos.object.modelo_version[i] = this.object.codigo[row] then
					dw_archivos.object.modelo_version_descripcion[i] = data
				end if
			Next
	END CHOOSE
end if
end event

event rowfocuschanged;call super::rowfocuschanged;String cliente, propuesta, pieza, version_color
Long fila_cliente, fila_propuesta, fila_pieza, fila_version, i

fila_cliente = dw_clientes.getrow()

if fila_cliente > 0 then 
	cliente = dw_clientes.object.cliente[fila_cliente]
else
	cliente = '-1'
end if

fila_propuesta = dw_propuestas.getrow()

if fila_propuesta > 0 then 
	propuesta = dw_propuestas.object.modelo_propuesta_codigo[fila_propuesta]
else
	propuesta = '-1'
end if

fila_version = dw_versiones.getrow()
if fila_version > 0 then
	version_color = dw_versiones.object.codigo[fila_version]
else
	version_color = '-1' 
end if

fila_pieza = dw_piezas.getrow()
if fila_pieza > 0 then
	pieza = dw_piezas.object.codigo[fila_pieza]
else
	pieza = '-1' 
end if

if isnull(cliente) or cliente = '' then
	cliente = '-1'
end if

if isnull(propuesta) or propuesta = '' then
	propuesta = '-1'
end if

if isnull(pieza) or pieza = '' then
	pieza = '-1'
end if

if isnull(version_color) or version_color = '' then
	version_color = '-1'
end if

dw_archivos.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"' and pieza = '"+pieza+"' and modelo_version = '"+version_color+"'")
dw_archivos.filter()

if dw_piezas.getrow() > 0 and dw_versiones.getrow() > 0 then
	//dw_archivos.object.titulo.text = "Archivos PIEZA "+dw_piezas.object.codigo_lab[dw_piezas.getrow()]+" "+dw_piezas.object.descripcion[dw_piezas.getrow()]+" - VERSIÓN "+dw_versiones.object.codigo[dw_versiones.getrow()]+" "+dw_versiones.object.descripcion[dw_versiones.getrow()]
	dw_archivos.object.titulo.text = dw_piezas.object.descripcion[dw_piezas.getrow()]+" "+dw_versiones.object.descripcion[dw_versiones.getrow()]
else
	dw_archivos.object.titulo.text = "Archivos Pieza y Versión seleccionadas"
end if

dw_bases_version_pieza.setfilter("modelo_pieza_version_cliente = '"+cliente+"' and modelo_pieza_version_propuesta = '"+propuesta+"' and modelo_pieza_version_pieza = '"+pieza+"' and modelo_pieza_version_version = '"+version_color+"'")
dw_bases_version_pieza.filter()


//Marcado especial de fila seleccionada
/*
if currentrow > 0 then
	For i = 1 To this.rowcount()
		this.object.seleccionado[i] = 0
	Next
	
	this.object.seleccionado[currentrow] = 1
end if
*/
end event

type pb_anyade_version from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 64
integer y = 2496
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_plus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;long fila_actual, nuevo_codigo, indice, maximo_valor_dw
string modelo_actual, cliente, propuesta

nuevo_codigo = 0

modelo_actual = dw_1.object.#1[dw_1.getrow()]

if dw_clientes.getrow() <= 0 then
	MessageBox("Error","Debe seleccionar un cliente para poder insertar una nueva versión de color")
	return
end if
cliente = dw_clientes.object.cliente[dw_clientes.getrow()]

if isnull(cliente) or cliente = "" then
	MessageBox("Error","Debe indicar un cliente para poder insertar una nueva versión de color")
	return
end if

if dw_propuestas.getrow() <= 0 then
	MessageBox("Error","Debe seleccionar una propuesta para poder insertar una nueva versión de color")
	return
end if
propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.getrow()]

if isnull(propuesta) or propuesta = "" then
	MessageBox("Error","Debe indicar una propuesta para poder insertar una nueva versión de color")
	return
end if

maximo_valor_dw = long(dw_versiones.Describe("Evaluate('Max(integer(codigo))', 0)"))
if isnull(maximo_valor_dw) then maximo_valor_dw = 0
nuevo_codigo = maximo_valor_dw +1

fila_actual = dw_versiones.InsertRow(0)

dw_versiones.object.codigo[fila_actual] = String(nuevo_codigo)

dw_versiones.scrolltorow(fila_actual)
dw_versiones.SetColumn(2)
dw_versiones.Setfocus()
dw_versiones.object.empresa[fila_actual] = codigo_empresa
dw_versiones.object.cliente[fila_actual] = cliente
dw_versiones.object.propuesta[fila_actual] = propuesta
end event

type pb_borrar_version from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 215
integer y = 2496
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_minus.png"
alignment htextalign = left!
string powertiptext = "EliminarRegistro"
end type

event clicked;boolean error_borrando
long fila_actual, total, archivos, pruebas, archivos_dw, trabajos
String modelo, cliente, propuesta, versionsel
str_ventana_alerta parametros

parametros.titulo = "Borrado de Versión de Color"
parametros.subtitulo = "Borrar Versión"
parametros.mensaje = "Atención, va a borrar definitivamente una versión de color, ¿Desea continuar?"
parametros.tipo = 1
//parametros.botones = botones
parametros.mostrar_imagen = true
openwithparm(wtc_ventana_alerta, parametros)
borrar = Int(Message.DoubleParm)

if borrar <> 1 then
	return
end if

error_borrando = false
fila_actual = dw_versiones.getrow()
if isnull(fila_actual) or fila_actual = 0 then
	MessageBox("Error","Debe seleccionar una fila para borrar")
	return
end if

modelo = dw_1.object.#1[dw_1.getrow()]
cliente = dw_versiones.object.cliente[fila_actual]
propuesta = dw_versiones.object.propuesta[fila_actual]
versionsel = dw_versiones.object.codigo[fila_actual]

//No podemos borrar una propuesta si hay piezas con pruebas asociadas, trabajos o versiones de color
total = 0
archivos = 0
archivos_dw = Integer(dw_archivos.Describe("Evaluate('sum(if(long(modelo_version) = "+versionsel+",1,0))', 0)"))
pruebas = 0
SELECT COUNT(*) INTO :archivos FROM modelo_archivo WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente and propuesta = :propuesta and modelo_version = :versionsel;
SELECT COUNT(*) INTO :pruebas FROM modelo_prueba WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente and propuesta = :propuesta and modelo_version = :versionsel;
SELECT COUNT(*) INTO :trabajos FROM modelo_trabajo WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente and propuesta = :propuesta and modelo_version = :versionsel;
total = archivos + pruebas + archivos_dw

//Si hay piezas no se pueden borrar las versiones de color pasadas a pieza (en caso de error al pasar a pieza, primero borrar las piezas)
if dw_piezas.rowcount() > 0 then
	total = total + trabajos
end if 

if total > 0 then
	MessageBox("Atención","No es posible borrar una versión de color si ya se han realizado pruebas de laboratorio, existen archivos asociados o se ha pasado a pieza para esa versión de color.")
	return
else
	if dw_versiones.DeleteRow(fila_actual) <> 1 then
		error_borrando = True
	else
		error_borrando = False
	end if
end if

if error_borrando then
	MessageBox("Error","No ha sido posible borrar la versión de color")
else
	if f_guardar() = 1 then
		DELETE FROM modelo_pieza_version WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente AND propuesta = :propuesta AND version = :versionsel;
		UPDATE modelo_trabajo SET modelo_version = NULL WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente AND propuesta = :propuesta AND modelo_version = :versionsel;
	else
		pb_cancelar.triggerevent(clicked!)
	end if
end if
end event

type dw_bases_version_pieza from u_dw within wtc_trabajos_disenyo_nuevo
integer x = 2025
integer y = 2784
integer width = 1833
integer height = 808
integer taborder = 60
string dataobject = "dwtc_modelo_pieza_version"
boolean vscrollbar = true
end type

event itemchanged;call super::itemchanged;String cliente = ""
string resultado
dec  resultado2, resultado3

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "modelo_pieza_version_base"
		if dw_clientes.getrow() > 0 then
			cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
		end if
		if not isnull(cliente) and cliente <> "" then
			/*
			if cliente <> '87' then 
				SELECT articulos.descripcion, articulos.ancho, articulos.largo
				INTO :resultado, :resultado2, :resultado3
				FROM articulos 
				LEFT OUTER JOIN genter ON articulos.empresa = genter.empresa AND articulos.cliente = genter.codigo 
				WHERE articulos.empresa = :codigo_empresa and articulos.uso = '1' and genter.codigo = :cliente and articulos.codigo = :data;
			else
				//Si el cliente es tencer codigo 87, puede probarse sobre cualquier base
				SELECT articulos.descripcion, articulos.ancho, articulos.largo
				INTO :resultado, :resultado2, :resultado3
				FROM articulos 
				WHERE articulos.empresa = :codigo_empresa and articulos.uso = '1' and articulos.codigo = :data;
			end if
			*/
			//Se puede escoger la base de cualquier cliente
			SELECT articulos.descripcion, articulos.ancho, articulos.largo
			INTO :resultado, :resultado2, :resultado3
			FROM articulos 
			WHERE articulos.empresa = :codigo_empresa and articulos.uso = '1' and articulos.codigo = :data;
			if SQLCA.sqlcode <> 100 then
				this.object.articulos_descripcion[Row] 		= resultado
				this.object.articulos_ancho[Row] 		= resultado2
				this.object.articulos_largo[Row] 		= resultado3
			else
				dwo.Primary[row] = ''
				this.object.articulos_descripcion[Row] 		= ''
				this.object.articulos_ancho[Row] 		= 0
				this.object.articulos_largo[Row] 		= 0
				return 2			
			end if
		end if
END CHOOSE


this.Accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo, cliente = ""
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda

//if key = KeyF8! then
	//dw_1.EVENT usr_keydown(key, keyflags)
//end if

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "modelo_pieza_version_base"
			if dw_clientes.getrow() > 0 then
				cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
			end if
			if not isnull(cliente) and cliente <> "" then
				/*
				if cliente <> '87' then 
					busqueda.consulta =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE articulos.uso = '1' AND articulos.empresa = '"+codigo_empresa+"' AND articulos.cliente = '"+cliente+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
				else
					//Para Tencer se puede seleccionar cualquier base
					busqueda.consulta =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE articulos.uso = '1' AND articulos.empresa = '"+codigo_empresa+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
				end if
				*/
				//Se puede escoger la base de cualquier cliente
				busqueda.consulta =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE articulos.uso = '1' AND articulos.empresa = '"+codigo_empresa+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
				busqueda.titulo_ventana = "Búsqueda de Base"
				busqueda.titulos[1] = "Código"
				busqueda.titulos[2] = "Base"
				busqueda.titulos[3] = "Ancho"
				busqueda.titulos[4] = "Largo"
				
				OpenWithParm(wt_busquedas, busqueda)
				resultado = Message.PowerObjectParm
				if resultado.resultado > 0 then
					this.object.modelo_pieza_version_base[this.GetRow()] 		= resultado.valores[1]		
					this.object.articulos_descripcion[this.GetRow()] 	= resultado.valores[2]		
					this.object.articulos_ancho[this.GetRow()] 			= Dec(resultado.valores[3])
					this.object.articulos_largo[this.GetRow()] 			= Dec(resultado.valores[4])
				end if
			end if
	END CHOOSE
end if	
	
end event

type popup_versiones from datawindow within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 55
integer y = 748
integer width = 1755
integer height = 948
integer taborder = 80
boolean bringtotop = true
string title = "none"
string dataobject = "dwtc_modelo_version2"
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event clicked;String codigo, descripcion
Long fila
if row > 0 then
	codigo = this.object.codigo[row]
	descripcion = this.object.descripcion[row]
	/*
	dw_archivos.object.modelo_version[dw_archivos.getrow()] = codigo
	dw_archivos.object.modelo_version_descripcion [dw_archivos.getrow()] = descripcion
	dw_archivos.SelectRow(0, false)
	*/
	fila = dw_trabajos.Find("modelo_trabajo_modelo_version = '"+codigo+"'", 0, dw_trabajos.rowcount())
	if fila > 0 then
		//No podemos pasar a pieza mas de una vez la misma version de color
		MessageBox("Error", "Ya ha pasado a pieza esta versión de color")
	else
		dw_fecha_necesidad.object.version[dw_fecha_necesidad.getrow()] = codigo
		dw_fecha_necesidad.object.version_anterior[dw_fecha_necesidad.getrow()] = codigo
		dw_fecha_necesidad.object.version_descripcion[dw_fecha_necesidad.getrow()] = descripcion
	end if
	popup_versiones.visible = false
	cb_popup_versiones.visible = false
end if
end event

type cb_popup_versiones from commandbutton within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 1362
integer y = 1548
integer width = 402
integer height = 104
integer taborder = 70
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Cancelar"
end type

event clicked;popup_versiones.visible = false
cb_popup_versiones.visible = false
end event

type pb_bases_mas from picturebutton within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 1856
integer y = 1556
integer width = 105
integer height = 92
integer taborder = 120
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_plus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;dw_bases.insertrow(0)

end event

type pb_bases_menos from picturebutton within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 1961
integer y = 1556
integer width = 105
integer height = 92
integer taborder = 130
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_minus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;if dw_bases.getrow() > 0 then
	dw_bases.deleterow(dw_bases.getrow())
end if
end event

type dw_bases from u_dw within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 1819
integer y = 1060
integer width = 2057
integer height = 472
integer taborder = 120
boolean bringtotop = true
string dataobject = "dwtc_aux_bases"
boolean vscrollbar = true
end type

event usr_dwnkey;call super::usr_dwnkey;string campo, cliente, filtro_bases = "", filtro_relieve, relieve
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda
Long num_versiones

//if key = KeyF8! then
	//dw_1.EVENT usr_keydown(key, keyflags)
//end if

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "codigo"
			if dw_clientes.getrow() > 0 then
				cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
			end if
			if not isnull(cliente) and cliente <> "" then
				/*
				if cliente <> '87' then 
					busqueda.consulta =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE articulos.uso = '1' AND articulos.empresa = '"+codigo_empresa+"' AND articulos.cliente = '"+cliente+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
				else
					//Para Tencer se puede seleccionar cualquier base
					busqueda.consulta =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE articulos.uso = '1' AND articulos.empresa = '"+codigo_empresa+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
				end if
				*/
				//Se puede escoger una base de cualquier cliente
				//Filtro solo bases
				
//				if dw_fecha_necesidad.object.solo_bases[1] = 1 then
//					filtro_bases = "articulos.uso = '1' AND "
//				else
//					filtro_bases = "articulos.uso <> '3' AND "
//				end if

				if dw_fecha_necesidad.object.solo_bases[1] = 1 then
					filtro_bases = "articulos.uso = '1' AND "
				else
					filtro_bases = " 1 = 1 AND "
				end if
				
				filtro_relieve = ""
				relieve = dw_1.object.relieve[dw_1.getrow()] 
				if not isnull(relieve) and relieve <> "" then
					if relieve = '5' then //LISO
						filtro_relieve = " (articulos.relieve = '"+relieve+"' OR articulos.relieve IS NULL OR RTRIM(articulos.relieve) = '') AND "
					else	
						filtro_relieve = " articulos.relieve = '"+relieve+"' AND "
					end if
				end if
				
				busqueda.consulta =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE "+filtro_bases+&
							"articulos.empresa = '"+codigo_empresa+"' AND "+filtro_relieve+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
				busqueda.titulo_ventana = "Búsqueda de Bases"
				busqueda.titulos[1] = "Código"
				busqueda.titulos[2] = "Descripción"
				busqueda.titulos[3] = "Formato"
				busqueda.titulos[4] = "Uso"
				busqueda.titulos[5] = "Cliente"
				
				OpenWithParm(wt_busquedas, busqueda)
				resultado = Message.PowerObjectParm
				if resultado.resultado > 0 then
					this.object.codigo[this.GetRow()] 			= resultado.valores[1]		
					this.object.descripcion[this.GetRow()] 	= resultado.valores[2]		
				end if
			end if
	END CHOOSE
end if	
	
end event

event itemchanged;call super::itemchanged;string resultado, cliente

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "codigo"
		if dw_clientes.getrow() > 0 then
			cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
		end if
		if not isnull(cliente) and cliente <> "" then
			/*
			if cliente <> '87' then 
				SELECT articulos.descripcion 
				INTO :resultado 
				FROM articulos 
				LEFT OUTER JOIN genter ON articulos.empresa = genter.empresa AND articulos.cliente = genter.codigo 
				WHERE articulos.empresa = :codigo_empresa and articulos.uso = '1' and genter.codigo = :cliente and articulos.codigo = :data;
			else
				//Si el cliente es tencer codigo 87, puede probarse sobre cualquier base
				SELECT articulos.descripcion 
				INTO :resultado 
				FROM articulos 
				WHERE articulos.empresa = :codigo_empresa and articulos.uso = '1' and articulos.codigo = :data;
			end if
			*/
			//Se puede escoger una base de cualquier cliente
			SELECT articulos.descripcion 
			INTO :resultado 
			FROM articulos 
			WHERE articulos.empresa = :codigo_empresa  and articulos.codigo = :data;
			if SQLCA.sqlcode <> 100 then
				this.object.descripcion[Row] 		= resultado
			else
				dwo.Primary[row] = ''
				this.object.descripcion[Row] 		= ''
				return 2			
			end if
		end if
END CHOOSE


this.Accepttext()
end event

type dw_piezas from u_dw within wtc_trabajos_disenyo_nuevo
integer x = 37
integer y = 2640
integer width = 1979
integer height = 948
integer taborder = 50
string dataobject = "dwtc_modelo_pieza2"
boolean vscrollbar = true
end type

event itemchanged;call super::itemchanged;string resultado, resultado1
dec  resultado2, resultado3
datetime resultado_fecha

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "modelo_pieza_base"
		SELECT descripcion, ancho, largo
		INTO :resultado, :resultado2, :resultado3
		FROM articulos
		WHERE empresa = :codigo_empresa and uso = '1'
		and codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.articulos_descripcion[Row] 		= resultado
			this.object.articulos_ancho[Row] 		= resultado2
			this.object.articulos_largo[Row] 		= resultado3
		else
			dwo.Primary[row] = ''
			this.object.articulos_descripcion[Row] 		= ''
			this.object.articulos_ancho[Row] 		= 0
			this.object.articulos_largo[Row] 		= 0
			return 2			
		end if
END CHOOSE


this.Accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda

//if key = KeyF8! then
	//dw_1.EVENT usr_keydown(key, keyflags)
//end if

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "modelo_pieza_base"
			busqueda.titulo_ventana = "Búsqueda de Serie"
			busqueda.consulta  = " SELECT CODIGO, DESCRIPCION, ancho, largo "+&
										" FROM articulos "+&
										" WHERE empresa = '"+codigo_empresa+"' AND uso = '1' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Base"
			busqueda.titulos[3] = "Ancho"
			busqueda.titulos[4] = "Largo"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_pieza_base[this.GetRow()] 		= resultado.valores[1]		
				this.object.articulos_descripcion[this.GetRow()] 	= resultado.valores[2]		
				this.object.articulos_ancho[this.GetRow()] 			= Dec(resultado.valores[3])
				this.object.articulos_largo[this.GetRow()] 			= Dec(resultado.valores[4])
			end if
	END CHOOSE
end if	
	
end event

event rowfocuschanged;call super::rowfocuschanged;String cliente, propuesta, pieza, version_color, codigo_lab
Long fila_cliente, fila_propuesta, fila_pieza, fila_version, i

fila_cliente = dw_clientes.getrow()

if fila_cliente > 0 then 
	cliente = dw_clientes.object.cliente[fila_cliente]
else
	cliente = '-1'
end if

fila_propuesta = dw_propuestas.getrow()

if fila_propuesta > 0 then 
	propuesta = dw_propuestas.object.modelo_propuesta_codigo[fila_propuesta]
else
	propuesta = '-1'
end if

fila_version = dw_versiones.getrow()
if fila_version > 0 then
	version_color = dw_versiones.object.codigo[fila_version]
else
	version_color = '-1' 
end if

fila_pieza = this.getrow()
if fila_pieza > 0 then
	pieza = this.object.codigo[fila_pieza]
	codigo_lab = this.object.codigo_lab[fila_pieza]
else
	pieza = '-1' 
end if

if isnull(cliente) or cliente = '' then
	cliente = '-1'
end if

if isnull(propuesta) or propuesta = '' then
	propuesta = '-1'
end if

if isnull(pieza) or pieza = '' then
	pieza = '-1'
end if

if isnull(version_color) or version_color = '' then
	version_color = '-1'
end if

dw_archivos.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"' and pieza = '"+pieza+"' and modelo_version = '"+version_color+"'")
dw_archivos.filter()

if dw_piezas.getrow() > 0 and dw_versiones.getrow() > 0 then
	//dw_archivos.object.titulo.text = "Archivos PIEZA "+dw_piezas.object.codigo_lab[dw_piezas.getrow()]+" "+dw_piezas.object.descripcion[dw_piezas.getrow()]+" VERSIÓN "+dw_versiones.object.codigo[dw_versiones.getrow()]+" "+dw_versiones.object.descripcion[dw_versiones.getrow()]
	dw_archivos.object.titulo.text = dw_piezas.object.descripcion[dw_piezas.getrow()]+" "+dw_versiones.object.descripcion[dw_versiones.getrow()]
else
	dw_archivos.object.titulo.text = "Archivos Pieza y Versión seleccionadas"
end if

dw_bases_version_pieza.setfilter("modelo_pieza_version_cliente = '"+cliente+"' and modelo_pieza_version_propuesta = '"+propuesta+"' and modelo_pieza_version_pieza = '"+pieza+"' and modelo_pieza_version_version = '"+version_color+"'")
dw_bases_version_pieza.filter()

if not isnull(codigo_lab) and codigo_lab <> "" then
	ftc_imagen_fondo_datawindow(dw_imagen_pieza, "1", "", "", codigo_lab)
else
	dw_imagen_pieza.visible = false
end if


//Marcado especial de fila seleccionada
/*
if currentrow > 0 then
	For i = 1 To this.rowcount()
		this.object.seleccionado[i] = 0
	Next
	
	this.object.seleccionado[currentrow] = 1
end if
*/
end event

event clicked;call super::clicked;str_parametros lstr_param
long esta_abierta
Boolean imprimir
String cliente_desc, cliente, modelo, modelo_version, propuesta, ruta, pieza, pieza_lab, sel, texto_ficheros
Long i, j, numero_versiones, numero_ficheros
Datastore ficheros

CHOOSE CASE dwo.name
	CASE "p_pieza"
		lstr_param.s_argumentos[1] = this.object.codigo_lab[row]
		lstr_param.i_nargumentos = 1
		lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
		lstr_param.resultado = ''
		esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_pruebas")
		if esta_abierta <> -1 then
			close(wtc_mant_pruebas)
			OpenWithParm(wtc_mant_pruebas,lstr_param)
		else
			OpenWithParm(wtc_mant_pruebas,lstr_param)
		end if
	
	
	//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
	/*
	if esta_abierta = -1 then
		Openwithparm(wtc_mant_pruebas, lstr_param)
	else
		ventanas_activas[esta_abierta].ventana.BringToTop = true
	end if
	*/
	
	
	CASE "p_expo"
		if hay_cambios() then
			if f_guardar() <> 1 then
				return //Fallo de validación en la grabación
			end if
		end if
		
		lstr_param.s_argumentos[1] = this.object.codigo_lab[row]
		lstr_param.i_nargumentos = 1
		lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
		lstr_param.resultado = ''
		esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_pieza_archivo")
		if esta_abierta <> -1 then
			close(wtc_mant_pieza_archivo)
			OpenWithParm(wtc_mant_pieza_archivo,lstr_param)
		else
			OpenWithParm(wtc_mant_pieza_archivo,lstr_param)
		end if
		
	CASE "p_lab"
	//Solo se puede imprimir en modo edicion
	if estado = 1 then
		imprimir = true
		if hay_cambios() then
			if MessageBox("Atención","¿Desea guardar los cambios antes de imprimir?",Question!,YesNo!,1) = 1 then
				if f_guardar() <> 1 then 
					imprimir = false
				end if
			end if	
		end if
		
		if imprimir = true then 
			modelo = dw_1.object.modelo[dw_1.getrow()]
			cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
			cliente_desc = dw_clientes.object.genter_razon[dw_clientes.getrow()]
			propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.getrow()]
			pieza = this.object.codigo[row]
			pieza_lab = this.object.codigo_lab[row]
			
			//Ficheros
			texto_ficheros = ""
			numero_versiones = dw_versiones.rowcount()
			For i = 1 To numero_versiones
				modelo_version = dw_versiones.object.codigo[i]
				texto_ficheros = texto_ficheros + dw_versiones.object.descripcion[i]+": "
				sel = "SELECT archivo_disenyo.nombre "+&
						 "FROM modelo_archivo INNER JOIN archivo_disenyo ON modelo_archivo.empresa = archivo_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo.codigo "+&
						 "WHERE modelo_archivo.empresa = '"+codigo_empresa+"' "+&
						 "AND modelo_archivo.modelo = '"+modelo+"' "+&
						 "AND modelo_archivo.cliente = '"+cliente+"' "+&
						 "AND modelo_archivo.propuesta = '"+propuesta+"' "+&
						 "AND modelo_archivo.pieza = '"+pieza+"' "+&
						 "AND modelo_archivo.modelo_version = '"+modelo_version+"' ORDER BY modelo_archivo.tipo_maquina_disenyo DESC";
				f_cargar_cursor_trans (SQLCA,  sel,  ficheros)
				numero_ficheros = ficheros.RowCount()
				j = 1
				Do While j <= numero_ficheros 
					texto_ficheros = texto_ficheros + trim(ficheros.object.archivo_disenyo_nombre[j])
					if j < numero_ficheros then
						texto_ficheros = texto_ficheros + " - " 
					end if
					j ++
				Loop
				texto_ficheros = texto_ficheros+"~n"
			Next
			Destroy ficheros
			//Mostrar todo
			if not isnull(pieza) and pieza <> "" then
				ruta = ftc_imagen_ruta("2","","",pieza_lab)
				dw_imp_lab.object.referencia[1] = "M" + modelo + " / P" + pieza_lab
				dw_imp_lab.object.cliente[1] = cliente + " - " + cliente_desc
				dw_imp_lab.object.disenyador[1] = dw_trabajos.object.tecnico_dis_descripcion[dw_trabajos.rowcount()]
				dw_imp_lab.object.tecnico[1] = dw_1.object.tecnico_lab_descripcion[dw_1.getrow()]
				dw_imp_lab.object.imagen[1] = ruta
				dw_imp_lab.object.ficheros[1] = texto_ficheros
			end if
			f_imprimir_datawindow(dw_imp_lab)
			
		end if
	end if
	
END CHOOSE
end event

type dw_imagen_pieza from u_dw_imagen within wtc_trabajos_disenyo_nuevo
integer x = 3863
integer y = 2868
integer width = 960
integer height = 720
integer taborder = 120
boolean bringtotop = true
end type

type st_imagen_pieza from statictext within wtc_trabajos_disenyo_nuevo
integer x = 3863
integer y = 2784
integer width = 960
integer height = 80
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24076881
string text = "Imagen Pieza"
alignment alignment = center!
boolean focusrectangle = false
end type

type st_produccion from statictext within wtc_trabajos_disenyo_nuevo
integer x = 1051
integer y = 120
integer width = 805
integer height = 76
boolean bringtotop = true
integer textsize = -12
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 18948574
long backcolor = 67108864
string text = "Modelo en Producción"
boolean focusrectangle = false
end type

type pb_estructura_archivos from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 1920
integer y = 88
integer width = 146
integer height = 128
integer taborder = 110
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\tables.png"
string powertiptext = "Estructura de Ficheros"
end type

event clicked;//if dw_estructura.visible = true then
//	dw_estructura.visible = false
//	Parent.width = 5801
//else
//	dw_estructura.visible = true
//	Parent.width = 7840
//end if

if Parent.width = 7831 then
	Parent.width = 5810
else
	Parent.width = 7831
end if
end event

type dw_trabajos from u_dw within wtc_trabajos_disenyo_nuevo
integer x = 2021
integer y = 748
integer width = 3762
integer height = 1148
integer taborder = 40
string dataobject = "dwtc_modelo_trabajo"
boolean vscrollbar = true
end type

event clicked;call super::clicked;str_parametros lstr_param
long esta_abierta, fila, fila_busqueda
String acabado

this.accepttext()

CHOOSE CASE dwo.name
	CASE "p_serie"
	esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_serie")
	//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
	if esta_abierta = -1 then
		lstr_param.s_argumentos[1] = this.object.modelo_trabajo_serie[row]
		lstr_param.i_nargumentos = 1
		lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
		lstr_param.resultado = ''
		Openwithparm(wtc_mant_serie, lstr_param)
	else
		ventanas_activas[esta_abierta].ventana.BringToTop = true
	end if
CASE "p_pieza"
	/*
	if dw_piezas.rowcount() > 0 then
		MessageBox("Error","Ya se ha pasado a pieza esta propuesta.")
		return
	end if
	*/
	if isnull(dw_trabajos.object.modelo_trabajo_modelo_version[row]) or dw_trabajos.object.modelo_trabajo_modelo_version[row] = "" then
		IF IsNull(dw_trabajos.object.modelo_trabajo_fecha_fin[row]) or datetime(date('1900-01-01')) = dw_trabajos.object.modelo_trabajo_fecha_fin[row] then
			MessageBox("Error","El trabajo no tiene fecha fin. Debe estar finalizado antes de pasar a pieza.")
			return
		end if
	end if
	
	If dw_versiones.rowcount() <= 0 then
		MessageBox("Error","Debe indicar las versiones de color existentes, antes de Pasar a Pieza.")
		return
	end if
	/*
	if hay_cambios() then
		MessageBox("Atención", "Debe guardar antes de pasar a pieza")
		return
	end if
	*/
	dw_fecha_necesidad.reset()
	dw_fecha_necesidad.insertrow(0)
	dw_fecha_necesidad.visible = not(dw_fecha_necesidad.visible)
	dw_fecha_necesidad.object.solo_bases[1] = 1
	dw_bases.reset()
	fila = dw_bases.insertrow(0)
	dw_bases.visible = not(dw_bases.visible)
	pb_bases_mas.visible = not(pb_bases_mas.visible)
	pb_bases_menos.visible = not(pb_bases_menos.visible)
	This.setrow(row)
	This.SelectRow(0, false)
  	This.SelectRow(row, true)	
	
	//Comprobamos que el trabajo no esté ya pasado a pieza...
	if not isnull(dw_trabajos.object.modelo_trabajo_modelo_version[row]) and dw_trabajos.object.modelo_trabajo_modelo_version[row] <> "" then
		dw_trabajos.object.pasado[row] = 1
		
		dw_fecha_necesidad.object.fecha_necesidad[fila] = dw_trabajos.object.modelo_trabajo_fecha_necesidad[row]
		dw_fecha_necesidad.object.fecha_necesidad_a[fila] = dw_fecha_necesidad.object.fecha_necesidad[fila]
		
		dw_fecha_necesidad.object.version[fila] = dw_trabajos.object.modelo_trabajo_modelo_version[row]
		dw_fecha_necesidad.object.version_anterior[fila] = dw_fecha_necesidad.object.version[fila]
		fila_busqueda = dw_versiones.Find("codigo = '"+dw_fecha_necesidad.object.version[fila]+"'", 0, dw_versiones.rowcount())
		if fila_busqueda > 0 then
			dw_fecha_necesidad.object.version_descripcion[fila] = dw_versiones.object.descripcion[fila_busqueda]
		end if
	else
		  //29-07-2015 Agilizar monococcion y bicoccion
		acabado = this.object.modelo_trabajo_acabado_lab[row]
		if not isnull(acabado) and (acabado = "1" or acabado = "2") and dw_trabajos.find("trim(modelo_trabajo_modelo_version) <> '' ", 1, dw_trabajos.rowcount()) = 0 and dw_versiones.rowcount() > 1 then 
			dw_fecha_necesidad.object.version[fila] = "0"
			dw_fecha_necesidad.object.version_descripcion [fila] = "TODAS LAS VERSIONES DE COLOR"
			dw_fecha_necesidad.object.version_anterior [fila] = "0"
		elseif dw_versiones.rowcount() = 1 and dw_trabajos.find("trim(modelo_trabajo_modelo_version) <> '' ", 1, dw_trabajos.rowcount()) = 0 then
			dw_fecha_necesidad.object.version[fila] =  dw_versiones.object.codigo[1]
			dw_fecha_necesidad.object.version_descripcion[fila] = dw_versiones.object.descripcion[1]
			dw_fecha_necesidad.object.version_anterior [fila] = dw_versiones.object.codigo[1]
		end if
	end if
END CHOOSE

end event

event itemchanged;call super::itemchanged;string resultado, resultado1, cliente, fecha
dec  resultado2, resultado3
datetime resultado_fecha

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "modelo_trabajo_serie"
		cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
		if not isnull(cliente) and cliente <> '' then
			if cliente <> '87' then
				SELECT desserie.descripcion
				INTO :resultado
				FROM desserie
				WHERE empresa = :codigo_empresa and cliente = :cliente
				and desserie.codigo = :data;
			else
				//Para Tencer se puede probar cualquier serie
				SELECT desserie.descripcion
				INTO :resultado
				FROM desserie
				WHERE empresa = :codigo_empresa 
				and desserie.codigo = :data;
			end if
			if SQLCA.sqlcode <> 100 then
				this.object.desserie_descripcion[Row] 		= resultado
			else
				dwo.Primary[row] = ''
				this.object.desserie_descripcion[Row] 		= ''
				return 2			
			end if
		end if
	CASE "modelo_trabajo_acabado_lab"
		SELECT tipoacabado_lab.descripcion
		INTO :resultado
		FROM tipoacabado_lab
		WHERE empresa = :codigo_empresa
		and tipoacabado_lab.codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.tipoacabado_lab_descripcion[Row] 		= resultado
			
			//29-07-2015 - Agilidad fichas monococcion y bicoccion
			resultado = this.object.modelo_trabajo_acabado_lab[Row]
//			if (resultado = "1" or resultado = "2") then
//				fecha = String(this.object.modelo_trabajo_fecha_necesidad[Row], "dd-mm-yy")
//				if fecha = "00-00-00" or fecha = "" then
//					this.object.modelo_trabajo_fecha_necesidad[Row] = this.object.modelo_trabajo_fecha_solicitud[Row]
//				end if
//				fecha = String(this.object.modelo_trabajo_fecha_fin[Row], "dd-mm-yy")
//				if fecha = "00-00-00" or fecha = "" then
//					this.object.modelo_trabajo_fecha_fin[Row] = this.object.modelo_trabajo_fecha_solicitud[Row]
//				end if
//			end if
			
		else
			dwo.Primary[row] = ''
			this.object.tipoacabado_lab_descripcion[Row] 		= ''
			return 2			
		end if

	CASE "modelo_trabajo_tecnico_dis"
		SELECT tecnico_dis.descripcion 
		INTO :resultado
		FROM tecnico_dis
		WHERE empresa = :codigo_empresa 
		and activo = 'S' 
		and tecnico_dis.codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.tecnico_dis_descripcion[Row] 		= resultado
		else
			dwo.Primary[row] = ''
			this.object.tecnico_dis_descripcion[Row] 		= ''
			return 2
		end if
		
	CASE "modelo_trabajo_comercial"
		SELECT comercial.descripcion 
		INTO :resultado
		FROM comercial
		WHERE empresa = :codigo_empresa
		and activo = '1'
		and comercial.codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.comercial_descripcion[Row] 		= resultado
//			this.Modify("comercial_descripcion.Background.Color  = "+ftc_control_color_descripcion(0))			
		else
			dwo.Primary[row] = ''
			this.object.comercial_descripcion[Row] 		= ''
			return 2
		end if
	CASE "modelo_trabajo_fecha_solicitud" 
		//29-07-2015 - Agilidad fichas monococcion y bicoccion
		resultado = this.object.modelo_trabajo_acabado_lab[Row]
		if not isnull(resultado) and (resultado = "1" or resultado = "2") then
//			this.object.modelo_trabajo_fecha_necesidad[Row] = this.object.modelo_trabajo_fecha_solicitud[Row]
//			this.object.modelo_trabajo_fecha_fin[Row] = this.object.modelo_trabajo_fecha_solicitud[Row]
		end if
END CHOOSE


this.Accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo, cliente, acabado, fecha
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda

//if key = KeyF8! then
	//dw_1.EVENT usr_keydown(key, keyflags)
//end if

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "modelo_trabajo_serie"
			cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
			if not isnull(cliente) and cliente <> '' then
				if cliente <> '87' then
					busqueda.consulta  = " SELECT CODIGO, DESCRIPCION "+&
												" FROM desserie "+&
												" WHERE empresa = '"+codigo_empresa+"' AND cliente = '"+cliente+"' ORDER BY DESCRIPCION"
				else
					busqueda.consulta  = " SELECT CODIGO, DESCRIPCION "+&
												" FROM desserie "+&
												" WHERE empresa = '"+codigo_empresa+"' ORDER BY DESCRIPCION"
				end if
										
				busqueda.titulo_ventana = "Búsqueda de Serie"
				busqueda.titulos[1] = "Código"
				busqueda.titulos[2] = "Serie "
				
				OpenWithParm(wt_busquedas, busqueda)
				resultado = Message.PowerObjectParm
				if resultado.resultado > 0 then
					this.object.modelo_trabajo_serie[this.GetRow()] 			= resultado.valores[1]		
					this.object.desserie_descripcion[this.GetRow()] 		= resultado.valores[2]		
				end if
			end if
		CASE "modelo_trabajo_acabado_lab"
			busqueda.titulo_ventana = "Búsqueda de Acabado"
			busqueda.consulta  = " SELECT CODIGO, DESCRIPCION "+&
										" FROM tipoacabado_lab "+&
										" WHERE empresa = '"+codigo_empresa+"' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Acabado "
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_trabajo_acabado_lab[this.GetRow()] 			= resultado.valores[1]		
				this.object.tipoacabado_lab_descripcion[this.GetRow()] 		= resultado.valores[2]		
				
				//29-07-2015 - Agilidad fichas monococcion y bicoccion
//				acabado = this.object.modelo_trabajo_acabado_lab[this.GetRow()]
//				if (acabado = "1" or acabado = "2") then
//					fecha = String(this.object.modelo_trabajo_fecha_necesidad[this.GetRow()], "dd-mm-yy")
//					if fecha = "00-00-00" or fecha = "" then
//						this.object.modelo_trabajo_fecha_necesidad[this.GetRow()] = this.object.modelo_trabajo_fecha_solicitud[this.GetRow()]
//					end if
//					fecha = String(this.object.modelo_trabajo_fecha_fin[this.GetRow()], "dd-mm-yy")
//					if fecha = "00-00-00" or fecha = "" then
//						this.object.modelo_trabajo_fecha_fin[this.GetRow()] = this.object.modelo_trabajo_fecha_solicitud[this.GetRow()]
//					end if
//				end if
				
			end if
			
		CASE "modelo_trabajo_tecnico_dis"
			busqueda.titulo_ventana = "Búsqueda de Diseñador"
			busqueda.consulta  = "SELECT CODIGO, DESCRIPCION FROM TECNICO_DIS WHERE EMPRESA = '"+codigo_empresa+"' and activo = 'S' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Diseñador"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_trabajo_tecnico_dis[this.GetRow()] 					= resultado.valores[1]			
				this.object.tecnico_dis_descripcion[this.GetRow()] 	= resultado.valores[2]			
			end if		
			
		CASE "modelo_trabajo_comercial"
			busqueda.titulo_ventana = "Búsqueda de Comercial"
			busqueda.consulta  = "SELECT CODIGO, DESCRIPCION FROM comercial WHERE EMPRESA = '"+codigo_empresa+"' and activo = '1' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Comercial"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_trabajo_comercial[this.GetRow()] 					= resultado.valores[1]			
				this.object.comercial_descripcion[this.GetRow()] 	= resultado.valores[2]			
//				this.Modify("comercial_descripcion.Background.Color  = "+ftc_control_color_descripcion(0))			
			end if		
			
	END CHOOSE
end if	
	
end event

type cb_marcar_no_produccion from commandbutton within wtc_trabajos_disenyo_nuevo
integer x = 5824
integer y = 3476
integer width = 645
integer height = 100
integer taborder = 130
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Marcar NO Producción"
end type

event clicked;Long i
dw_estructura.retrieve (codigo_empresa, padre_codigo)	
if st_produccion.visible = true then
	if dw_estructura.rowcount() > 0 then
		For i = 1 To dw_estructura.rowcount()
			if dw_estructura.object.pieza[i] <> "0" and dw_estructura.object.produccion[i] = 0 then //Es fichero de máquina y se puede marcar
				dw_estructura.object.marcado[i] = 1
			end if
		Next	
		//cb_marcar_todo.triggerevent(clicked!)
	end if
else
	MessageBox("Atención", "El modelo no está en producción, por lo que no se marcará nada.")
end if
end event

type cb_borrar_marcados from commandbutton within wtc_trabajos_disenyo_nuevo
integer x = 6478
integer y = 3476
integer width = 695
integer height = 100
integer taborder = 140
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Borrar Ficheros Marcados"
end type

event clicked;string botones[2]
Int cambiar
str_ventana_alerta parametros

Long n, i, j, total_aplicaciones
String usuario_windows, sel
String nombre_archivo, tipomaquina_disenyo, codigo_archivo, prueba_archivo
String modelo, cliente, propuesta, pieza, prueba, aplicacion, ruta_archivos_disenyo, ruta, ruta_papelera, archivos_borrados

str_registro_sistema registro
Datastore aplicaciones

parametros.titulo = "Atención Borrar Archivos"
parametros.subtitulo = "Borrar Archivos Marcados"
parametros.mensaje = "Va a eliminar definitivamente TODOS los archivos seleccionados y no se podrán recuperar, ¿esta seguro?"
parametros.tipo = 1
//parametros.botones = botones
parametros.mostrar_imagen = true
openwithparm(wtc_ventana_alerta, parametros)
cambiar = Int(Message.DoubleParm)
if cambiar <> 1 then
	return	
end if

ContextKeyword lcxk_base
This.GetContextService("Keyword", lcxk_base)
usuario_windows = upper(ftc_variable_entorno("USERNAME", lcxk_base))

rtn = 1 
n = 1

st_guardar.visible = true
archivos_borrados = ""

Do while rtn = 1 and n <= dw_estructura.rowcount()
	
	if dw_estructura.object.pieza[n] <> "0" and dw_estructura.object.produccion[n] = 0 and dw_estructura.object.marcado[n] = 1 then
		
		tipomaquina_disenyo = dw_estructura.object.tipo_maquina_disenyo[n]
		codigo_archivo = dw_estructura.object.archivo_disenyo[n]
		prueba_archivo = dw_estructura.object.codigo[n]
		nombre_archivo = dw_estructura.object.fichero[n]
		
		//Si el archivo no se ha limpiado ya...
		
		if pos(archivos_borrados, nombre_archivo) = 0 then
		
			//Borrado del archivo de las aplicaciones de las pruebas laboratorio y tickets de máquinas de producción
			
			sel = "SELECT modelo_aplicacion.modelo, modelo_aplicacion.cliente, modelo_aplicacion.propuesta, modelo_aplicacion.pieza, modelo_aplicacion.prueba, modelo_aplicacion.codigo  "+&
					"FROM modelo_aplicacion INNER JOIN modelo_archivo ON modelo_aplicacion.empresa = modelo_archivo.empresa AND modelo_aplicacion.modelo = modelo_archivo.modelo AND modelo_aplicacion.cliente = modelo_archivo.cliente AND modelo_aplicacion.propuesta = modelo_archivo.propuesta AND modelo_aplicacion.pieza = modelo_archivo.pieza AND modelo_aplicacion.modelo_archivo = modelo_archivo.codigo "+&
					"WHERE modelo_archivo.empresa = '"+codigo_empresa+"' AND modelo_archivo.tipo_maquina_disenyo = '"+tipomaquina_disenyo+"' AND modelo_archivo.archivo_disenyo = '"+codigo_archivo+"' AND modelo_aplicacion.modelo_archivo_prueba = '"+prueba_archivo+"'"
			f_cargar_cursor_transaccion (trans_ts,  aplicaciones,  sel)
					
			j = 1
			total_aplicaciones = aplicaciones.RowCount()
			
			if st_produccion.visible = true then
				
				do while (j <= total_aplicaciones AND rtn = 1) 
					modelo = aplicaciones.object.modelo_aplicacion_modelo[j]
					cliente = aplicaciones.object.modelo_aplicacion_cliente[j]
					propuesta = aplicaciones.object.modelo_aplicacion_propuesta[j]
					pieza = aplicaciones.object.modelo_aplicacion_pieza[j]
					prueba = aplicaciones.object.modelo_aplicacion_prueba[j]
					aplicacion = aplicaciones.object.modelo_aplicacion_codigo[j]
					
					UPDATE modelo_aplicacion 
					set modelo_archivo = NULL, modelo_archivo_prueba = NULL 
					WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente AND propuesta = :propuesta AND pieza = :pieza AND prueba = :prueba AND codigo = :aplicacion USING trans_ts;
					
					IF trans_ts.SQLCode <> 0 THEN         
						MessageBox("SQL error", trans_ts.SQLErrText +". Archivo "+nombre_archivo+". Actualización de Aplicaciones de Laboratorio: "+String(trans_ts.SQLDBCode))
						rtn = -1
					END IF
					
					j++
				loop
				
				Destroy aplicaciones
				
				if rtn = 1 then	
					UPDATE modelo_pieza_ticket 
					SET tipo_maquina = NULL, archivo_disenyo = NULL, archivo_disenyo_prueba = NULL 
					WHERE empresa = :codigo_empresa AND tipo_maquina = :tipomaquina_disenyo AND archivo_disenyo = :codigo_archivo AND archivo_disenyo_prueba = :prueba_archivo USING trans_ts;
							
					IF trans_ts.SQLCode <> 0 THEN         
						MessageBox("SQL error", trans_ts.SQLErrText +". Archivo "+nombre_archivo+" Actualización de Tickets de Máquinas de Producción: "+String(trans_ts.SQLDBCode))
						rtn = -1
					END IF
				end if
			else
				if total_aplicaciones > 0 then
					MessageBox("Error", "No puede borrar archivos que están siendo usados en pruebas de laboratorio (Archivo: "+nombre_archivo+"). Solo se permite su borrado cuando el artículo pasa a producción.")
					rtn = -1
				end if
			end if
			
			SELECT ruta_archivos_disenyo INTO :ruta_archivos_disenyo FROM empresas WHERE empresa = :codigo_empresa using trans_ts;
			if isnull(ruta_archivos_disenyo) then ruta_archivos_disenyo = ""
			
			//Borrado del archivo
			if rtn = 1 then
				ruta = ruta_archivos_disenyo + f_reemplazar(trim(String(dw_estructura.object.ruta[n])), ruta_archivos_disenyo, "") + trim(String(dw_estructura.object.fichero[n]))
				ruta_papelera = ""
				SELECT ruta_papelera_disenyo INTO :ruta_papelera FROM empresas WHERE empresa = :codigo_empresa using trans_ts;
				IF trans_ts.SQLCode <> 0 THEN         
					MessageBox("SQL error", trans_ts.SQLErrText +". Archivo "+nombre_archivo+". No se ha podido encontrar la ruta de la papelera de reciclaje: "+String(trans_ts.SQLDBCode))
					rtn = -1
				END IF
				
				if not isnull(ruta_papelera) and ruta_papelera <> "" then
					ruta_papelera = ruta_papelera +  "old_" + String(Today(), "dd_mm_yy") + "_" + String(Now(), "hh_mm_ss") + "_" + trim(String(dw_estructura.object.fichero[n]))
					rtn = FileMove(ruta, ruta_papelera)
					if rtn = 1 then
						DELETE FROM archivo_disenyo_sistema_archivos 
						WHERE empresa = :codigo_empresa AND tipomaquina_disenyo = :tipomaquina_disenyo AND archivo = :codigo_archivo AND codigo = :prueba_archivo USING trans_ts;
						
						IF trans_ts.SQLCode <> 0 THEN         
							MessageBox("SQL error", trans_ts.SQLErrText +". Archivo "+nombre_archivo+". No se ha podido realizar el borrado en la base de datos: "+String(trans_ts.SQLDBCode))
							rtn = -1
						END IF
					else
						MessageBox("Error", "No se ha podido mover el archivo "+nombre_archivo+" a la papelera. Por favor, avise al administrador.")
						rtn = -1 
					end if
				else
					MessageBox("Error", "En la base de datos la ruta de la papelera de reciclaje no está definida. Por favor, avise al administrador.")
					rtn = -1
				end if
			end if
			
			if rtn = 1 then
				registro.usuario_windows = usuario_windows
				registro.trans = trans_ts
				registro.accion = "BORRAR - multiple"
				registro.tabla = "archivo_disenyo_sistema_archivos"
				registro.clave = codigo_empresa + "#" + tipomaquina_disenyo + "#" + codigo_archivo + "#" + prueba_archivo
				registro.valor = ruta
				if not ftc_registrar_cambios(registro) then
					rtn = -1
				end if
			end if
			
			if rtn = 1 then
				COMMIT USING trans_ts;
				archivos_borrados = archivos_borrados + nombre_archivo + " : "
			else
				ROLLBACK USING trans_ts;
				rtn = -1
			end if
		
		end if
		
	end if
	
	n++
Loop


if rtn = 1 then
	MessageBox("Borrado Finalizado", "Se ha realizado con éxito el borrado de los archivos marcados.")
end if

st_guardar.visible = false
dw_estructura.retrieve (codigo_empresa, padre_codigo)	
end event

type dw_estructura from datawindow within wtc_trabajos_disenyo_nuevo
integer x = 5792
integer y = 232
integer width = 2025
integer height = 3368
integer taborder = 10
string title = "none"
string dataobject = "dwtc_estructura_archivos"
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event clicked;str_parametros lstr_param
String texto_banda_seleccionada
Long fila, fila_cliente, fila_propuesta, fila_pieza, fila_version_color
String cliente, propuesta, pieza, version_color
String tipo_maquina_disenyo, archivo_disenyo, archivo_disenyo_nombre

if dwo.Type <> "datawindow" then
	
	//Obtengo la fila
	texto_banda_seleccionada = this.GetBandAtPointer()
	//Separamos del string lo que es la banda de lo que es la fila, sabiendo que el tabulador las separa
	fila = Long(Mid(texto_banda_seleccionada, LastPos(texto_banda_seleccionada, "~t") + 1))
	
	//QUITAMOS REDRAW PARA EVITAR PARPADEOS
	dw_clientes.SetRedraw(false)
	dw_propuestas.SetRedraw(false)	
	dw_trabajos.SetRedraw(false)	
	dw_versiones.SetRedraw(false)	
	dw_piezas.SetRedraw(false)	
	dw_archivos.SetRedraw(false)
	dw_bases_version_pieza.SetRedraw(false)
	
	cliente = this.object.cliente[fila] 
	propuesta = this.object.propuesta[fila] 
	pieza = this.object.pieza[fila] 
	version_color = this.object.version_color[fila] 
	
	choose case dwo.band
		case "tree.level.1" //Cliente
			fila_cliente = dw_clientes.Find("cliente = '"+cliente+"'", 1, dw_clientes.rowcount()) 
			seleccionar_fila(dw_clientes, fila_cliente, 0)
			dw_clientes.SetRedraw(true)
		case "tree.level.2" //Propuesta
			fila_cliente = dw_clientes.Find("cliente = '"+cliente+"'", 1, dw_clientes.rowcount()) 
			seleccionar_fila(dw_clientes, fila_cliente, 0)
			fila_propuesta = dw_propuestas.Find("modelo_propuesta_codigo = '"+propuesta+"'", 1, dw_propuestas.rowcount()) 
			seleccionar_fila(dw_propuestas, fila_propuesta, 0)
		case "tree.level.3" //Pieza (Si no es cabecera PSD)
			if pieza <> "0" then
				fila_cliente = dw_clientes.Find("cliente = '"+cliente+"'", 1, dw_clientes.rowcount()) 
				seleccionar_fila(dw_clientes, fila_cliente, 0)
				fila_propuesta = dw_propuestas.Find("modelo_propuesta_codigo = '"+propuesta+"'", 1, dw_propuestas.rowcount()) 
				seleccionar_fila(dw_propuestas, fila_propuesta, 0)
				fila_pieza = dw_piezas.Find("codigo_lab = '"+pieza+"'", 1, dw_piezas.rowcount()) 
				seleccionar_fila(dw_piezas, fila_pieza, 0)
			end if
		case "tree.level.4" //Versión Color (Si no es cabecera PSD)
			if pieza <> "0" and version_color <> "0" then
				fila_cliente = dw_clientes.Find("cliente = '"+cliente+"'", 1, dw_clientes.rowcount()) 
				seleccionar_fila(dw_clientes, fila_cliente, 0)
				fila_propuesta = dw_propuestas.Find("modelo_propuesta_codigo = '"+propuesta+"'", 1, dw_propuestas.rowcount()) 
				seleccionar_fila(dw_propuestas, fila_propuesta, 0)
				fila_pieza = dw_piezas.Find("codigo_lab = '"+pieza+"'", 1, dw_piezas.rowcount()) 
				seleccionar_fila(dw_piezas, fila_pieza, 0)
				fila_version_color = dw_versiones.Find("codigo = '"+version_color+"'", 1, dw_versiones.rowcount())
				seleccionar_fila(dw_versiones, fila_version_color, 0)
			end if
		case "detail" //Archivo concreto
			//fila = this.getrow()
			if dwo.name <> "marcado" then
				if pieza <> "0" and version_color <> "0" then //Es un archivo de pieza
					tipo_maquina_disenyo = this.object.tipo_maquina_disenyo[fila] 
					archivo_disenyo = this.object.archivo_disenyo[fila] 
					archivo_disenyo_nombre = this.object.archivo_disenyo_nombre[fila] 
					//La ventana será response
					lstr_param.s_argumentos[1] = tipo_maquina_disenyo
					lstr_param.s_argumentos[2] = archivo_disenyo
					lstr_param.s_argumentos[3] = archivo_disenyo_nombre
					lstr_param.i_nargumentos = 3
					lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
					lstr_param.resultado = ''
					Openwithparm(wtc_mant_archivos_disenyo_sistema_archivos, lstr_param)
				else //Es un archivo de la propuesta
					//La ventana será response
					lstr_param.s_argumentos[1] = f_codigo_principal()
					lstr_param.s_argumentos[2] = cliente
					lstr_param.s_argumentos[3] = propuesta
					lstr_param.i_nargumentos = 3
					lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
					lstr_param.resultado = ''
					Openwithparm(wtc_mant_modelo_propuesta_sistema_archivos, lstr_param)
				end if
			else
				if Long(this.object.marcado[fila]) = 1 then
					this.object.marcado[fila] = 0
				else
					if this.object.produccion[fila] > 0 then
						MessageBox("Atención", "No puede marcar un archivo que está en producción.")
					else
						this.object.marcado[fila] = 1
					end if
				end if
				
			end if
	end choose
	
	//MOSTRAMOS REDRAW
	dw_clientes.SetRedraw(true)
	dw_propuestas.SetRedraw(true)	
	dw_trabajos.SetRedraw(true)	
	dw_versiones.SetRedraw(true)	
	dw_piezas.SetRedraw(true)	
	dw_archivos.SetRedraw(true)
	dw_bases_version_pieza.SetRedraw(true)
	
end if
end event

event retrieveend;this.ExpandAll()
end event

type cb_marcar_todo from commandbutton within wtc_trabajos_disenyo_nuevo
integer x = 5824
integer y = 3376
integer width = 645
integer height = 100
integer taborder = 130
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Mostrar Todo"
end type

event clicked;dw_estructura.retrieve (codigo_empresa, padre_codigo)	
dw_estructura.ExpandAll()

end event

type cb_4 from commandbutton within wtc_trabajos_disenyo_nuevo
integer x = 6478
integer y = 3376
integer width = 695
integer height = 100
integer taborder = 140
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Ocultar Todo"
end type

event clicked;dw_estructura.CollapseAll()
end event

type st_guardar from statictext within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 6546
integer y = 60
integer width = 635
integer height = 152
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 18882815
long backcolor = 67108864
string text = "Borrando archivos. Espere por favor."
alignment alignment = center!
boolean focusrectangle = false
end type

type dw_propuestas from u_dw within wtc_trabajos_disenyo_nuevo
integer x = 37
integer y = 748
integer width = 1979
integer height = 1148
integer taborder = 30
string dataobject = "dwtc_modelo_propuesta"
boolean vscrollbar = true
end type

event clicked;call super::clicked;long fila_actual, fila_maxima, nuevo_codigo, indice, maximo_valor_dw
string modelo_actual, cliente, propuesta, formato

str_parametros lstr_param
long esta_abierta

boolean error_borrando
long  total, archivos, pruebas, imagenes, piezas_coleccion
String modelo, pieza, pieza_lab, trabajo_pasar_pieza, coleccion
Int npiezas

if row > 0 then 
	CHOOSE CASE dwo.name
		CASE "p_archivos"
				if hay_cambios() then
					//MessageBox("Atención", "Debe guardar los cambios antes de gestionar los archivos de disenyo")
					if f_guardar() <> 1 then
						return //Fallo de validación en la grabación
					end if
				end if
				
				if f_codigo_principal() = "" then
					return
				end if
				
				cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
				if isnull(cliente) or cliente = "" then
					MessageBox("Error","Debe seleccionar un cliente para poder gestionar los archivos asociados")
					return
				end if
				propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.getrow()]
				if isnull(propuesta) or propuesta = "" then
					MessageBox("Error","Debe seleccionar una propuesta para poder gestionar los archivos asociados")
					return
				end if
				
				formato = dw_propuestas.object.modelo_propuesta_formato[dw_propuestas.getrow()]
				if isnull(formato) or formato = "" then
					MessageBox("Error","Debe indicar un formato válido para poder gestionar los archivos asociados")
					return
				end if
				
				//La ventana será response
				lstr_param.s_argumentos[1] = f_codigo_principal()
				lstr_param.s_argumentos[2] = cliente
				lstr_param.s_argumentos[3] = propuesta
				lstr_param.i_nargumentos = 3
				lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
				lstr_param.resultado = ''
				Openwithparm(wtc_mant_modelo_propuesta_sistema_archivos, lstr_param)
			
		CASE "p_mas"
			
			//Debe existir al menos una pieza generada por pasar pieza para añadir piezas nuevas (sumamos solo el número)
			if dw_piezas.rowcount() <= 0 then
				//MessageBox("Error",'Debe "Pasar a Pieza" antes de añadir o quitar piezas de una propuesta existente.')
				npiezas = Integer(dw_propuestas.object.modelo_propuesta_numero_piezas[row])
				if not isnull(npiezas) then
					dw_propuestas.object.modelo_propuesta_numero_piezas[row] = npiezas + 1
				else
					dw_propuestas.object.modelo_propuesta_numero_piezas[row] = 1 
				end if
				return
			end if
			
			nuevo_codigo = 0
			
			modelo_actual = dw_1.object.#1[dw_1.getrow()]
			
			if dw_clientes.getrow() <= 0 then
				MessageBox("Error","Debe seleccionar un cliente para poder insertar una nueva pieza")
				return
			end if
			cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
			
			if isnull(cliente) or cliente = "" then
				MessageBox("Error","Debe indicar un cliente para poder insertar una nueva pieza")
				return
			end if
			
			if dw_propuestas.getrow() <= 0 then
				MessageBox("Error","Debe seleccionar una propuesta para poder insertar una nueva pieza")
				return
			end if
			propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.getrow()]
			
			if isnull(propuesta) or propuesta = "" then
				MessageBox("Error","Debe indicar una propuesta para poder insertar una nueva pieza")
				return
			end if
			
			maximo_valor_dw = long(dw_piezas.Describe("Evaluate('Max(integer(codigo))', 0)"))
			if isnull(maximo_valor_dw) then maximo_valor_dw = 0
			nuevo_codigo = maximo_valor_dw +1
			
			//Obtenemos el id de último trabajo de pasar a piezar
			trabajo_pasar_pieza = ""
			if dw_piezas.rowcount() > 0 then
				trabajo_pasar_pieza = dw_piezas.object.modelo_trabajo[dw_piezas.rowcount()]
			end if
			
			fila_actual = dw_piezas.InsertRow(0)
			
			if fila_actual > 0 then
				dw_piezas.object.codigo[fila_actual] = String(nuevo_codigo)
				dw_piezas.object.empresa[fila_actual] = codigo_empresa
				dw_piezas.object.cliente[fila_actual] = cliente
				dw_piezas.object.propuesta[fila_actual] = propuesta
				dw_piezas.object.modelo_trabajo[fila_actual] = trabajo_pasar_pieza
				
				seleccionar_fila (dw_piezas,fila_actual,2)
				//dw_propuestas.object.modelo_propuesta_numero_piezas[row] = Integer(dw_propuestas.object.modelo_propuesta_numero_piezas[row]) + 1
				dw_propuestas.object.modelo_propuesta_numero_piezas[row] = dw_piezas.rowcount()
			end if
			
		CASE "p_menos"
			str_ventana_alerta parametros
			coleccion = dw_1.object.coleccion[dw_1.getrow()]
			
			parametros.titulo = "Borrado de Pieza"
			parametros.subtitulo = "Borrar Pieza"
			parametros.mensaje = "Atención, va a reducir definitivamente el número de piezas del modelo, ¿Desea continuar?"
			parametros.tipo = 1
			//parametros.botones = botones
			parametros.mostrar_imagen = true
			openwithparm(wtc_ventana_alerta, parametros)
			borrar = Int(Message.DoubleParm)
			
			if borrar <> 1 then
				return
			end if
			
			error_borrando = false
			//fila_actual = dw_piezas.getrow() 
			fila_actual = dw_piezas.rowcount() //Selecciono siempre la última
			if isnull(fila_actual) or fila_actual <= 0 then
				//MessageBox("Error","No hay piezas que borrar")
				npiezas = Integer(dw_propuestas.object.modelo_propuesta_numero_piezas[row])
				if not isnull(npiezas) and npiezas > 0 then
					dw_propuestas.object.modelo_propuesta_numero_piezas[row] = npiezas - 1
				else
					dw_propuestas.object.modelo_propuesta_numero_piezas[row] = 0
				end if
				return
			end if
			
			modelo = dw_1.object.#1[dw_1.getrow()]
			cliente = dw_piezas.object.cliente[fila_actual]
			propuesta = dw_piezas.object.propuesta[fila_actual]
			pieza = dw_piezas.object.codigo[fila_actual]
			pieza_lab = dw_piezas.object.codigo_lab[fila_actual]
			
			//No podemos borrar una propuesta si hay piezas con pruebas asociadas, trabajos o versiones de color
			total = 0
			archivos = 0
			pruebas = 0
			SELECT COUNT(*) INTO :archivos FROM modelo_archivo WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente and propuesta = :propuesta and pieza = :pieza;
			SELECT COUNT(*) INTO :pruebas FROM modelo_prueba WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente and propuesta = :propuesta and pieza = :pieza;
			SELECT COUNT(*) INTO :imagenes FROM modelo_pieza_archivo WHERE empresa = :codigo_empresa AND pieza = :pieza_lab;
			total = archivos + pruebas + imagenes
			
			if total > 0 then
				MessageBox("Atención","No es posible borrar una pieza si ya se han realizado pruebas de laboratorio o existen archivos asociados.")
				return
			else
				if dw_piezas.DeleteRow(fila_actual) <> 1 then
					error_borrando = True
				else
					error_borrando = False
				end if
			end if
			
			if error_borrando then
				MessageBox("Error","No ha sido posible borrar la pieza")
			else
				
				seleccionar_fila (dw_piezas,fila_actual - 1,2)
				dw_propuestas.object.modelo_propuesta_numero_piezas[row] = dw_piezas.rowcount()
				
				if f_guardar() = 1 then
					rtn = 1
					DELETE FROM modelo_pieza_version WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente AND propuesta = :propuesta AND pieza = :pieza using trans_ts;
					if trans_ts.SqlCode = -1 then rtn = -1;
					
					//Si el número de piezas es 0 para toda la colección, se debe borrar el técnico de laboratorio
					SELECT COUNT(*) INTO :piezas_coleccion 
					FROM modelo_pieza 
					INNER JOIN modelo ON modelo_pieza.empresa = modelo.empresa AND modelo_pieza.modelo = modelo.modelo 
					INNER JOIN descoleccionsol ON modelo.empresa = descoleccionsol.empresa AND modelo.coleccion = descoleccionsol.codigo
					WHERE descoleccionsol.empresa = :codigo_empresa AND descoleccionsol.codigo = :coleccion using trans_ts;
					
					if piezas_coleccion <= 0 then
						UPDATE descoleccionsol SET tecnico_lab = NULL WHERE empresa = :codigo_empresa AND codigo = :coleccion using trans_ts;
						if trans_ts.SqlCode = -1 then rtn = -1;
					end if
					
					if rtn = 1 then					
						commit using trans_Ts;
					else
						rollback using trans_Ts;
					end if
					
				else
					pb_cancelar.triggerevent(clicked!)
				end if
				/*
				if Integer(dw_propuestas.object.modelo_propuesta_numero_piezas[row]) > 0 then
					dw_propuestas.object.modelo_propuesta_numero_piezas[row] = Integer(dw_propuestas.object.modelo_propuesta_numero_piezas[row]) - 1
				end if
				*/
			end if
	END CHOOSE
end if
end event

event itemchanged;call super::itemchanged;string resultado, formato_actual, modelo, cliente, propuesta
Dec resultado2, resultado3
Int repetidos, npiezas

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "modelo_propuesta_formato"
		formato_actual = this.object.modelo_propuesta_formato_actual[row]
		
		SELECT formatos.descripcion, formatos.ancho, formatos.largo 
		INTO :resultado, :resultado2, :resultado3
		FROM formatos
		WHERE empresa = :codigo_empresa
		and formatos.codigo = :data;

		if SQLCA.sqlcode <> 100 then
			//Restricción "No puede haber una propuesta con el mismo formato y numero de piezas" es controlada por una clave UNIQUE en la BD
			/*	
			//Comprobamos que el formato no este repetido
			repetidos = 0
			repetidos = Integer(this.Describe("Evaluate('sum(if(long(modelo_propuesta_formato) = "+data+",1,0))', 0)"))
			if repetidos > 1 then
				MessageBox("Error","El formato seleccionado ya existe en la propuesta actual")
				dwo.Primary[row] = formato_actual
				return 2	
			end if
			*/
			//Restricción "No puede cambiarse un formato si tiene archivos de diseño asociados"
			/*
			npiezas = 0
			modelo = f_codigo_principal()
			cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
			propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.getrow()]
			SELECT COUNT(*) INTO :npiezas FROM modelo_propuesta_sistema_archivos WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente AND propuesta = :propuesta;
			if npiezas > 0 then
				MessageBox("Error","No puede modificar un formato si la propuesta tiene ya archivos de diseño.")
				dwo.Primary[row] = formato_actual
				return 2	
			end if
			*/
			this.object.formatos_abreviado[Row] 		= resultado
			this.object.formatos_ancho[Row] 		= resultado2
			this.object.formatos_largo[Row] 		= resultado3
			this.object.modelo_propuesta_formato_actual[row] = data
		else
			dwo.Primary[row] = ''
			this.object.formatos_descripcion[Row] 		= ''
			this.object.formatos_ancho[Row] = 0
			this.object.formatos_largo[Row]  = 0
			return 2
		end if
	CASE "modelo_propuesta_numero_piezas"
		if dw_piezas.rowcount() > 0 then
			npiezas = Integer(this.object.modelo_propuesta_npiezas_actual[row])
			MessageBox("Error","Una vez pasado a pieza el modelo, utilice los botones + y - para añadir o quitar piezas.")
			dwo.Primary[row] = npiezas
			return 2	
		end if
		this.object.modelo_propuesta_npiezas_actual[row] = Integer(data)
END CHOOSE


this.Accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo, modelo, porpuesta
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda
Int repetidos

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "modelo_propuesta_formato"
			
			busqueda.titulo_ventana = "Búsqueda de Formato"
			busqueda.consulta  = " SELECT CODIGO, DESCRIPCION, convert (decimal (10, 2), ancho) , convert (decimal (10, 2), largo) "+&
										" FROM FORMATOS "+&
										" WHERE empresa = '"+codigo_empresa+"' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Formato"
			busqueda.titulos[3] = "Ancho "
			busqueda.titulos[4] = "Largo"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				//Restricción "No puede haber una propuesta con el mismo formato y numero de piezas" es controlada por una clave UNIQUE en la BD
				/*
				//Comprobamos que no este repetido
				repetidos = 0
				repetidos = Integer(this.Describe("Evaluate('sum(if(long(modelo_propuesta_formato) = "+resultado.valores[1]+",1,0))', 0)"))
				if repetidos > 0 then
					MessageBox("Error","El formato seleccionado ya existe en la propuesta actual")
					return
				end if
				*/
				this.object.modelo_propuesta_formato[this.GetRow()] 	= String(resultado.valores[1])
				this.object.formatos_abreviado[this.GetRow()] 			= String(resultado.valores[2])
				this.object.formatos_ancho[this.GetRow()] 				= dec ( truncate ( dec ( resultado.valores[3] ), 2 ) )
				this.object.formatos_largo[this.GetRow()] 				= dec ( truncate ( dec ( resultado.valores[4] ), 2 ) )
			end if
	END CHOOSE
end if	
	
end event

event rowfocuschanged;call super::rowfocuschanged;String cliente, propuesta, pieza
Long fila_cliente, fila_propuesta, fila_pieza, fila_version, i

fila_cliente = dw_clientes.getrow()

if fila_cliente > 0 then 
	cliente = dw_clientes.object.cliente[fila_cliente]
else
	cliente = '-1'
end if

fila_propuesta = this.getrow()

if fila_propuesta > 0 then 
	propuesta = this.object.modelo_propuesta_codigo[fila_propuesta]
else
	propuesta = '-1'
end if

if isnull(cliente) or cliente = '' then
	cliente = '-1'
end if

if isnull(propuesta) or propuesta = '' then
	propuesta = '-1'
end if

dw_trabajos.setfilter("modelo_trabajo_cliente = '"+cliente+"' and modelo_trabajo_propuesta = '"+propuesta+"'")
dw_trabajos.filter()	
	
dw_versiones.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
dw_versiones.filter()

dw_piezas.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
dw_piezas.filter()		

dw_archivos.setfilter("cliente = '"+cliente+"' and propuesta = '"+propuesta+"'")
dw_archivos.filter()		

dw_bases_version_pieza.setfilter("modelo_pieza_version_cliente = '"+cliente+"' and modelo_pieza_version_propuesta = '"+propuesta+"'")
dw_bases_version_pieza.filter()		

//Selección Fila Pieza
//fila_pieza = dw_piezas.rowcount()
if dw_piezas.rowcount() > 0 then
	//fila_pieza = dw_piezas.getrow()
	fila_pieza = 1
	seleccionar_fila (dw_piezas,fila_pieza,0)
end if

//Selección Fila Versión
if dw_versiones.rowcount() > 0 then
	//fila_version = dw_versiones.rowcount()
	fila_version = 1
	seleccionar_fila (dw_versiones,fila_version,0)
end if

//Marcado especial de fila seleccionada
/*
if currentrow > 0 then
	For i = 1 To this.rowcount()
		this.object.seleccionado[i] = 0
	Next
	
	this.object.seleccionado[currentrow] = 1
end if
*/

end event

event doubleclicked;if row > 0 then
	if dwo.name <> "p_mas" and dwo.name <> "p_menos" then
		this.EVENT usr_dwnkey(KeyEnter!, 0)
	end if
end if
end event

type pb_1 from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 5312
integer y = 2632
integer width = 146
integer height = 128
integer taborder = 140
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_plus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;long fila_actual

fila_actual = dw_referencias.InsertRow(0)

if fila_actual > 0 then
	dw_referencias.object.empresa[fila_actual] = codigo_empresa
	dw_referencias.object.modelo[fila_actual] = padre_codigo
end if

end event

type pb_4 from picturebutton within wtc_trabajos_disenyo_nuevo
integer x = 5463
integer y = 2632
integer width = 146
integer height = 128
integer taborder = 150
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_minus.png"
alignment htextalign = left!
string powertiptext = "EliminarRegistro"
end type

event clicked;boolean error_borrando
long fila_actual

error_borrando = false
fila_actual = dw_archivos.getrow()
if dw_referencias.DeleteRow(fila_actual) <> 1 then
	error_borrando = True
else
	error_borrando = False
end if

if error_borrando then
	MessageBox("Error","No ha sido posible borrar el archivo")
end if


end event

type dw_referencias from u_dw within wtc_trabajos_disenyo_nuevo
integer x = 5294
integer y = 1900
integer width = 489
integer height = 876
integer taborder = 80
string dataobject = "dwtc_modelo_referencia"
boolean vscrollbar = true
end type

event clicked;call super::clicked;str_parametros lstr_param 

if row > 0 then
	if dwo.name = "modelo_modelo" then
		padre_codigo = this.object.modelo_modelo[row]	
		
		lstr_param.s_argumentos[1] = padre_codigo
		lstr_param.i_nargumentos = 1
		lstr_param.nombre_ventana = "wtc_trabajos_disenyo_nuevo"
		lstr_param.resultado = ''
		
		Message.PowerObjectParm = lstr_param
		Parent.triggerevent(open!)
	end if
end if
end event

event itemchanged;call super::itemchanged;string resultado 

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "referencia"
		SELECT modelo 
		INTO :resultado
		FROM modelo 
		WHERE modelo.empresa = :codigo_empresa AND modelo.modelo = :data;
		if SQLCA.sqlcode = 100 then
			dwo.Primary[row] = ''
			return 2	
		end if

END CHOOSE


this.Accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda

if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "referencia"
			busqueda.titulo_ventana = "Búsqueda de Modelos"
			busqueda.consulta  = " SELECT modelo.modelo, art_tipomoldura.descripcion, descoleccionsol_grupo.descripcion, descoleccionsol.descripcion "+&
										" FROM modelo "+&
										" INNER JOIN descoleccionsol ON modelo.empresa = descoleccionsol.empresa AND modelo.coleccion = descoleccionsol.codigo "+&		
										" INNER JOIN descoleccionsol_grupo ON descoleccionsol.empresa = descoleccionsol_grupo.empresa AND descoleccionsol.grupo = descoleccionsol_grupo.codigo "+&	
										" INNER JOIN art_tipomoldura ON modelo.empresa = art_tipomoldura.empresa AND modelo.relieve = art_tipomoldura.codigo "+&	
										" WHERE modelo.empresa = '"+codigo_empresa+"' ORDER BY CONVERT(float, modelo.modelo) DESC"
			busqueda.titulos[1] = "Modelo"
			busqueda.titulos[2] = "Relieve"
			busqueda.titulos[3] = "Grupo"
			busqueda.titulos[4] = "Colección Descripción"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.referencia[this.GetRow()] 							= resultado.valores[1]		// Devuelve el valor que encuentra ...
			end if
	END CHOOSE
end if	
	

end event

type cb_1 from commandbutton within wtc_trabajos_disenyo_nuevo
integer x = 4283
integer y = 16
integer width = 873
integer height = 100
integer taborder = 130
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Sustituir Bases de la Propuesta"
end type

event clicked;int fila
dw_actualizar_base.visible = true
fila = dw_actualizar_base.InsertRow(0)
string modelo, cliente, propuesta

if dw_1.Rowcount() > 0 and  dw_clientes.Rowcount() > 0  and dw_propuestas.Rowcount() > 0 then
	if dw_1.object.modelo[dw_1.GetRow()] <> '' and dw_clientes.object.cliente[dw_clientes.GetRow()] <> '' &
			and dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.GetRow()] <>'' and not isnull(dw_1.object.modelo[dw_1.GetRow()])&
			and not isnull(dw_clientes.object.cliente[dw_clientes.GetRow()]) and not isnull(dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.GetRow()]) then
	
		modelo = dw_1.object.modelo[dw_1.GetRow()]
		cliente = dw_clientes.object.cliente[dw_clientes.GetRow()]
		propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.GetRow()]
		
		dw_actualizar_base.object.titulo.text =  'Modelo: '+modelo +' -  Cliente: '+cliente +' - Propuesta: '+propuesta 
	end if
end if


end event

type dw_actualizar_base from u_dw within wtc_trabajos_disenyo_nuevo
boolean visible = false
integer x = 1810
integer y = 268
integer width = 2075
integer height = 328
integer taborder = 130
boolean bringtotop = true
string dataobject = "dwtc_aux2_bases"
boolean border = true
end type

event itemchanged;call super::itemchanged;string resultado, cliente

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "codigo"
		if dw_clientes.getrow() > 0 then
			cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
		end if
		if not isnull(cliente) and cliente <> "" then
			/*
			if cliente <> '87' then 
				SELECT articulos.descripcion 
				INTO :resultado 
				FROM articulos 
				LEFT OUTER JOIN genter ON articulos.empresa = genter.empresa AND articulos.cliente = genter.codigo 
				WHERE articulos.empresa = :codigo_empresa and articulos.uso = '1' and genter.codigo = :cliente and articulos.codigo = :data;
			else
				//Si el cliente es tencer codigo 87, puede probarse sobre cualquier base
				SELECT articulos.descripcion 
				INTO :resultado 
				FROM articulos 
				WHERE articulos.empresa = :codigo_empresa and articulos.uso = '1' and articulos.codigo = :data;
			end if
			*/
			//Se puede escoger una base de cualquier cliente
			SELECT articulos.descripcion 
			INTO :resultado 
			FROM articulos 
			WHERE articulos.empresa = :codigo_empresa  and articulos.codigo = :data;
			if SQLCA.sqlcode <> 100 then
				this.object.descripcion[Row] 		= resultado
			else
				dwo.Primary[row] = ''
				this.object.descripcion[Row] 		= ''
				return 2			
			end if
		end if
END CHOOSE


this.Accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo, cliente, filtro_bases = "", filtro_relieve, relieve
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda
Long num_versiones

//if key = KeyF8! then
	//dw_1.EVENT usr_keydown(key, keyflags)
//end if

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "codigo"
			if dw_clientes.getrow() > 0 then
				cliente = dw_clientes.object.cliente[dw_clientes.getrow()]
			end if
			if not isnull(cliente) and cliente <> "" then
				
				
				busqueda.consulta =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE articulos.uso = '1' AND "+&
							"articulos.empresa = '"+codigo_empresa+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
				busqueda.titulo_ventana = "Búsqueda de Bases"
				busqueda.titulos[1] = "Código"
				busqueda.titulos[2] = "Descripción"
				busqueda.titulos[3] = "Formato"
				busqueda.titulos[4] = "Uso"
				busqueda.titulos[5] = "Cliente"
				
				OpenWithParm(wt_busquedas, busqueda)
				resultado = Message.PowerObjectParm
				if resultado.resultado > 0 then
					this.object.codigo[this.GetRow()] 			= resultado.valores[1]		
					this.object.descripcion[this.GetRow()] 	= resultado.valores[2]		
				end if
			end if
	END CHOOSE
end if	
	
end event

event clicked;call super::clicked;string modelo, cliente, propuesta, base, base_final

this.accepttext()


CHOOSE CASE dwo.name
	CASE "b_continuar"
		modelo = dw_1.object.modelo[dw_1.GetRow()]
		cliente = dw_clientes.object.cliente[dw_clientes.GetRow()]
		propuesta = dw_propuestas.object.modelo_propuesta_codigo[dw_propuestas.GetRow()]
		base =  this.object.codigo[this.GetRow()]
		base_final =  this.object.base_final[this.GetRow()]
		
		if modelo <> '' and cliente <> '' and propuesta <>'' and not isnull(modelo) and not isnull(cliente) and not isnull(propuesta) and  &
				base <> '' and base_final <> '' and not isnull(base) and not isnull(base_final) then
				
			update modelo_pieza_version
			set base = :base, base_final = :base_final
			where  empresa = :codigo_empresa
			and	modelo = :modelo
			and	cliente = :cliente
			and	propuesta = :propuesta  using SQLCA;
			
			if SQLCA.SqlCode <> -1 then
				commit using SQLCA;
			else
				rollback using SQLCA;
				messagebox("Error", " No se ha actualizado la base")
			end if
		end if
		
		this.reset()
		this.visible = false
		
		dw_bases_version_pieza.Retrieve (codigo_empresa, modelo)
		
	CASE "b_cancelar"
		this.reset()
		this.visible = false
	
END CHOOSE
end event

type cb_2 from commandbutton within wtc_trabajos_disenyo_nuevo
integer x = 2501
integer y = 72
integer width = 942
integer height = 112
integer taborder = 120
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Borrado de Archivos (Bestial)"
end type

event clicked;Long fila_actual
String coleccion,  codigo
str_registro_sistema registro
String usuario_windows

Datastore archivo_resolucion, modelo_archivo_expo, modelo_propuesta_sistema_archivos, modelo_pieza_archivo, archivo_disenyo_sistema_archivos
Datastore coleccion_archivo, coleccion_sistema_archivos
String sel, fichero, modelo_borrar, ruta, ruta2
string ruta_archivos_exposicion, ruta_archivos_disenyo 
Long j, m, numero_tipos

IF MessageBox("¡ P E L I G R O !", "Vas a BORRAR todos los archivos de este modelo, ¿ ¡¡¡  LO TIENES CLARO !!! ?",   Exclamation!, YesNo!, 2) = 1 THEN
	
	modelo_borrar = dw_1.object.modelo[dw_1.getrow()]
	coleccion = dw_1.object.coleccion[dw_1.getrow()]

	
	update articulos set modelo_origen = '$'+:modelo_borrar
	where modelo_origen = :modelo_borrar using sqlca;
	commit using sqlca;

	SELECT ruta_archivos_exposicion 
	INTO :ruta_archivos_exposicion 
	FROM empresas 
	WHERE empresa = :codigo_empresa 
	USING SQLCA;
	
	SELECT ruta_archivos_disenyo 
	INTO :ruta_archivos_disenyo 
	FROM empresas 
	WHERE empresa = :codigo_empresa 
	USING SQLCA;


	if isnull(ruta_archivos_exposicion) then ruta_archivos_exposicion = ""
	if isnull(ruta_archivos_disenyo) then ruta_archivos_disenyo = ""
	
	sel = " SELECT fichero "+&
			" FROM modelo_archivo_expo "+&
			" where modelo =  '"+modelo_borrar+" '"
			
	f_cargar_cursor_transaccion (SQLCA,  modelo_archivo_expo, sel)

	For j = 1 To modelo_archivo_expo.RowCount()
		fichero = trim(String(modelo_archivo_expo.object.fichero[j]) )
		ruta = ruta_archivos_exposicion + fichero

	
		if 	FileDelete(ruta) then
			//PROCESO DE BORRADO DE IMÁGENES DE CADA RESOLUCIÓN ( \\AMAZONAS\DESARROLLO\CATALAGO_EXPO\resolucion\fichero.jpg )
			sel = "SELECT * FROM archivo_resolucion WHERE empresa = '"+codigo_empresa+"'"
			f_cargar_cursor_transaccion (SQLCA,  archivo_resolucion, sel)
			numero_tipos = archivo_resolucion.RowCount()
			For m = 1 To numero_tipos
				ruta2 = ruta_archivos_exposicion +  archivo_resolucion.object.tamanyo[m] + "\" + fichero
				FileDelete(ruta2)
			Next
			Destroy archivo_resolucion

		else
			MessageBox("(modelo_archivo_expo)", "No se ha podido borrar el archivo "+fichero+" del disco. Por favor, avise al administrador.")
		end if
	Next

	
	//##############################################################################
	//			 BORRADO ARCHIVOS ASOCIADOS A UNA PROPUESTA
	//##############################################################################
	
	
	sel = " SELECT ruta, fichero "+&
			" FROM modelo_propuesta_sistema_archivos "+&
			" where modelo =  '"+modelo_borrar+" '"
		
	f_cargar_cursor_transaccion (SQLCA,  modelo_propuesta_sistema_archivos, sel)

	For j = 1 To modelo_propuesta_sistema_archivos.RowCount()
		fichero = trim(String(modelo_propuesta_sistema_archivos.object.fichero[j]) )
		ruta = ruta_archivos_disenyo +trim(String(modelo_propuesta_sistema_archivos.object.ruta[j]) ) + fichero
		
		if not	FileDelete(ruta) then
			MessageBox("(modelo_archivo_expo)", "No se ha podido borrar el archivo "+fichero+" del disco. Por favor, avise al administrador.")
		end if
		int flag
		flag = 	RemoveDirectory (ruta_archivos_disenyo +trim(String(modelo_propuesta_sistema_archivos.object.ruta[j]) ))	
	Next	

	//##############################################################################
	//						 BORRADO ARCHIVOS ASOCIADOS A PIEZAS
	//##############################################################################
	
	
	sel = " SELECT modelo_pieza_archivo.fichero  "+&
			" FROM modelo_pieza "+&
			" inner join modelo_pieza_archivo on modelo_pieza.codigo_lab = modelo_pieza_archivo.pieza "+&
			" where modelo_pieza.modelo =  '"+modelo_borrar+" '"
		
	f_cargar_cursor_transaccion (SQLCA,  modelo_pieza_archivo, sel)

	For j = 1 To modelo_pieza_archivo.RowCount()
		fichero = trim(String(modelo_pieza_archivo.object.modelo_pieza_archivo_fichero[j]) )
		ruta = ruta_archivos_exposicion + fichero

		if 	FileDelete(ruta) then
			//PROCESO DE BORRADO DE IMÁGENES DE CADA RESOLUCIÓN ( \\AMAZONAS\DESARROLLO\CATALAGO_EXPO\resolucion\fichero.jpg )
			sel = "SELECT * FROM archivo_resolucion WHERE empresa = '"+codigo_empresa+"'"
			f_cargar_cursor_transaccion (SQLCA,  archivo_resolucion, sel)
			numero_tipos = archivo_resolucion.RowCount()
			For m = 1 To numero_tipos
				ruta2 = ruta_archivos_exposicion +  archivo_resolucion.object.tamanyo[m] + "\" + fichero
				
				FileDelete(ruta2)
	
			Next
			Destroy archivo_resolucion
			
		else
			MessageBox("(modelo_archivo_expo)", "No se ha podido borrar el archivo "+fichero+" del disco. Por favor, avise al administrador.")
			rtn = -1
		end if
	Next


	//##############################################################################
	//								 			BORRADO ARCHIVOS MAQUINAS
	//##############################################################################

	sel = " SELECT DISTINCT ruta, fichero  "+&
			" FROM modelo_archivo "+&
			" INNER JOIN archivo_disenyo_sistema_archivos on modelo_archivo.archivo_disenyo = archivo_disenyo_sistema_archivos.archivo "+&
			" AND  archivo_disenyo_sistema_archivos.tipomaquina_disenyo = modelo_archivo.tipo_maquina_disenyo "+&
			" AND modelo =  '"+modelo_borrar+" '"
		
	f_cargar_cursor_transaccion (SQLCA,  archivo_disenyo_sistema_archivos, sel)
	
	For j = 1 To archivo_disenyo_sistema_archivos.RowCount()
		fichero = trim(String(archivo_disenyo_sistema_archivos.object.fichero[j]) )
		ruta = ruta_archivos_disenyo +trim(String(archivo_disenyo_sistema_archivos.object.ruta[j]) ) + fichero

		if not	FileDelete(ruta) then
			MessageBox("(archivo_disenyo_sistema_archivos)", "No se ha podido borrar el archivo "+fichero+" del disco. Por favor, avise al administrador.")
		end if
		int flag2
		flag2 = 	RemoveDirectory ( ruta_archivos_disenyo + trim(String(archivo_disenyo_sistema_archivos.object.ruta[j] ) ) )	
	Next		

	
	//##############################################################################
	//					 					BORRADO ARCHIVOS COLECCION
	//##############################################################################


if isnull(ruta_archivos_exposicion) then ruta_archivos_exposicion = ""

sel = " SELECT ruta, fichero "+&
		" FROM coleccion_archivo "+&
		" where coleccion =  '"+coleccion+" '"
		
	f_cargar_cursor_transaccion (SQLCA,  coleccion_archivo, sel)

	for m = 1 to coleccion_Archivo.rowcount()
		fichero =  trim(String(coleccion_archivo.object.fichero[m]))
		if isnull (fichero) then fichero = ''
		ruta = ruta_archivos_exposicion + f_reemplazar(trim(String(coleccion_archivo.object.ruta[m])), ruta_archivos_exposicion, "") +fichero
		if  FileDelete(ruta) then

			//PROCESO DE BORRADO DE IMÁGENES DE CADA TAMAÑO EXISTENTE
			
			sel = "SELECT * FROM archivo_resolucion WHERE empresa = '"+codigo_empresa+"'"
			f_cargar_cursor_trans (SQLCA,  sel,  archivo_resolucion)
			numero_tipos = archivo_resolucion.RowCount()
			For j = 1 To numero_tipos
				ruta2 = ruta_archivos_exposicion +  archivo_resolucion.object.tamanyo[j] + "\" + fichero
				FileDelete(ruta2)
			Next
			Destroy archivo_resolucion
		else
			MessageBox("Error", "No se ha podido borrar el archivo del disco. Por favor, avise al administrador.")
		end if
	next
	
	
sel = " SELECT ruta, fichero "+&
		" FROM coleccion_sistema_archivos "+&
		" where coleccion =  '"+coleccion+" '"
		
	f_cargar_cursor_transaccion (SQLCA,  coleccion_sistema_archivos, sel)

	for m = 1 to coleccion_sistema_archivos.rowcount()
		fichero =  trim(String(coleccion_sistema_archivos.object.fichero[m]))
		ruta = ruta_archivos_disenyo +trim(String(coleccion_sistema_archivos.object.ruta[m]) ) + fichero
		

		if not FileDelete(ruta) then
			MessageBox("Error", "No se ha podido borrar el archivo del disco. Por favor, avise al administrador.")
		end if
		RemoveDirectory ( ruta_archivos_disenyo + trim(String(coleccion_sistema_archivos.object.ruta[m] ) ) )	
	next

	
	//##############################################################################
	//					 					FIN   BORRADO ARCHIVOS COLECCION
	//##############################################################################

END IF		


destroy modelo_archivo_expo
destroy modelo_propuesta_sistema_archivos
destroy archivo_disenyo_sistema_archivos
destroy archivo_resolucion
destroy modelo_pieza_archivo
destroy archivo_disenyo_sistema_archivos

messagebox ("OK", "Borrado bestial completado")
end event

