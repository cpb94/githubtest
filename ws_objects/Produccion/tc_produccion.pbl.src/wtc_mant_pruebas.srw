$PBExportHeader$wtc_mant_pruebas.srw
forward
global type wtc_mant_pruebas from wt_ventana_padre
end type
type pb_borrar_prueba from picturebutton within wtc_mant_pruebas
end type
type pb_duplica_prueba from picturebutton within wtc_mant_pruebas
end type
type pb_anyade_prueba from picturebutton within wtc_mant_pruebas
end type
type pb_borra_aplicacion from picturebutton within wtc_mant_pruebas
end type
type pb_anyade_aplicacion from picturebutton within wtc_mant_pruebas
end type
type st_2 from statictext within wtc_mant_pruebas
end type
type dw_ficha_comercial from datawindow within wtc_mant_pruebas
end type
type dw_modelo from u_dw within wtc_mant_pruebas
end type
type pb_intercala_aplicacion from picturebutton within wtc_mant_pruebas
end type
type dw_modelos_coleccion from u_dw within wtc_mant_pruebas
end type
type dw_piezas from u_dw within wtc_mant_pruebas
end type
type pb_1 from picturebutton within wtc_mant_pruebas
end type
type p_seleccion from picture within wtc_mant_pruebas
end type
type sle_busqueda from singlelineedit within wtc_mant_pruebas
end type
type st_crear_est from statictext within wtc_mant_pruebas
end type
type sle_desc_est from singlelineedit within wtc_mant_pruebas
end type
type st_desc_est from statictext within wtc_mant_pruebas
end type
type cb_crear_est_base from commandbutton within wtc_mant_pruebas
end type
type cb_crear_est from commandbutton within wtc_mant_pruebas
end type
type cb_crear_est_inicio from commandbutton within wtc_mant_pruebas
end type
type pb_2 from picturebutton within wtc_mant_pruebas
end type
type cb_1 from commandbutton within wtc_mant_pruebas
end type
type st_coste from statictext within wtc_mant_pruebas
end type
type dw_ficha_laboratorio from datawindow within wtc_mant_pruebas
end type
type pb_3 from picturebutton within wtc_mant_pruebas
end type
type dw_pantallas from datawindow within wtc_mant_pruebas
end type
type dw_ticket from u_dw within wtc_mant_pruebas
end type
type dw_lineas from datawindow within wtc_mant_pruebas
end type
type dw_stock_base from datawindow within wtc_mant_pruebas
end type
type pb_bases_mas from picturebutton within wtc_mant_pruebas
end type
type pb_bases_menos from picturebutton within wtc_mant_pruebas
end type
type dw_bases from u_dw within wtc_mant_pruebas
end type
type dw_pruebas from u_dw within wtc_mant_pruebas
end type
type dw_reenvio from datawindow within wtc_mant_pruebas
end type
type dw_trabajo from datawindow within wtc_mant_pruebas
end type
type cbx_solo_bases from checkbox within wtc_mant_pruebas
end type
type cbx_solo_base_ticket from checkbox within wtc_mant_pruebas
end type
type dw_pruebas_color from datawindow within wtc_mant_pruebas
end type
type cb_2 from commandbutton within wtc_mant_pruebas
end type
type cb_3 from commandbutton within wtc_mant_pruebas
end type
type pb_4 from picturebutton within wtc_mant_pruebas
end type
type dw_aplicaciones from u_dw within wtc_mant_pruebas
end type
type sle_pruebas from singlelineedit within wtc_mant_pruebas
end type
type st_1 from statictext within wtc_mant_pruebas
end type
type sle_version_color from singlelineedit within wtc_mant_pruebas
end type
type st_3 from statictext within wtc_mant_pruebas
end type
type cbx_pruebas_ok from checkbox within wtc_mant_pruebas
end type
type dw_imagen from u_dw_imagen within wtc_mant_pruebas
end type
type pb_5 from picturebutton within wtc_mant_pruebas
end type
type dw_seleccion from datawindow within wtc_mant_pruebas
end type
type dw_copiar from u_dw within wtc_mant_pruebas
end type
type pb_imprimir_etiqueta from picturebutton within wtc_mant_pruebas
end type
type dw_etiqueta_muestras from datawindow within wtc_mant_pruebas
end type
type st_4 from statictext within wtc_mant_pruebas
end type
type dw_molde_lineas from datawindow within wtc_mant_pruebas
end type
type pb_6 from picturebutton within wtc_mant_pruebas
end type
type uo_buscar_molde from u_em_campo_2 within wtc_mant_pruebas
end type
end forward

global type wtc_mant_pruebas from wt_ventana_padre
integer width = 8581
integer height = 3756
string title = "Trabajos diseño"
pb_borrar_prueba pb_borrar_prueba
pb_duplica_prueba pb_duplica_prueba
pb_anyade_prueba pb_anyade_prueba
pb_borra_aplicacion pb_borra_aplicacion
pb_anyade_aplicacion pb_anyade_aplicacion
st_2 st_2
dw_ficha_comercial dw_ficha_comercial
dw_modelo dw_modelo
pb_intercala_aplicacion pb_intercala_aplicacion
dw_modelos_coleccion dw_modelos_coleccion
dw_piezas dw_piezas
pb_1 pb_1
p_seleccion p_seleccion
sle_busqueda sle_busqueda
st_crear_est st_crear_est
sle_desc_est sle_desc_est
st_desc_est st_desc_est
cb_crear_est_base cb_crear_est_base
cb_crear_est cb_crear_est
cb_crear_est_inicio cb_crear_est_inicio
pb_2 pb_2
cb_1 cb_1
st_coste st_coste
dw_ficha_laboratorio dw_ficha_laboratorio
pb_3 pb_3
dw_pantallas dw_pantallas
dw_ticket dw_ticket
dw_lineas dw_lineas
dw_stock_base dw_stock_base
pb_bases_mas pb_bases_mas
pb_bases_menos pb_bases_menos
dw_bases dw_bases
dw_pruebas dw_pruebas
dw_reenvio dw_reenvio
dw_trabajo dw_trabajo
cbx_solo_bases cbx_solo_bases
cbx_solo_base_ticket cbx_solo_base_ticket
dw_pruebas_color dw_pruebas_color
cb_2 cb_2
cb_3 cb_3
pb_4 pb_4
dw_aplicaciones dw_aplicaciones
sle_pruebas sle_pruebas
st_1 st_1
sle_version_color sle_version_color
st_3 st_3
cbx_pruebas_ok cbx_pruebas_ok
dw_imagen dw_imagen
pb_5 pb_5
dw_seleccion dw_seleccion
dw_copiar dw_copiar
pb_imprimir_etiqueta pb_imprimir_etiqueta
dw_etiqueta_muestras dw_etiqueta_muestras
st_4 st_4
dw_molde_lineas dw_molde_lineas
pb_6 pb_6
uo_buscar_molde uo_buscar_molde
end type
global wtc_mant_pruebas wtc_mant_pruebas

type variables

boolean guardando = false
end variables

forward prototypes
public function boolean hay_cambios ()
public function integer f_guardar ()
public function integer f_borrar ()
public subroutine mostrar_controles_insercion ()
public subroutine mostrar_controles_edicion ()
public subroutine seleccionar_fila (datawindow dw, integer fila, integer columna)
public function boolean f_hay_ubicacion_asignada ()
public subroutine f_cargar_imagen_pieza ()
public function integer f_crear_estructura (boolean generar_base, ref string mensaje)
public subroutine seleccionar_fila_guardar (long sel_prueba, long sel_aplicacion)
end prototypes

public function boolean hay_cambios ();Boolean resultado
resultado = false

dw_1.accepttext() //Necesario para que se detecten los cambios en el campo en el que se tiene el foco

if dw_1.DeletedCount() + dw_1.ModifiedCount() > 0 or dw_pruebas.DeletedCount() + dw_pruebas.ModifiedCount() > 0 or dw_aplicaciones.DeletedCount() + dw_aplicaciones.ModifiedCount() > 0 then
	resultado = true
end if

return resultado
end function

public function integer f_guardar ();//SOBRESCRIBIMOS LA FUNCION DEL PADRE. NO LA LLMAMOS CON super::funcion()

long i, j, filas, sel_prueba, sel_aplicacion
string campo, motivo
boolean falta_Campo, aceptado
string modelo, cliente, propuesta, pieza, prueba
String pieza_lab, prueba_lab, base_lab
String tecnico_antiguo, tecnico_actual, coleccion
Int resultado

guardando = true

resultado = 1 //Todo ok si devolvemos 1

filas = dw_1.getrow()
if filas <= 0 then 
	return -1
end if

modelo = dw_1.object.modelo_pieza_modelo[filas]
if isnull(modelo) or modelo = "" then
	return -1
end if

//Obtenemos las filas seleccionadas para volverlas a marcar una vez realizado el guardado
sel_prueba = dw_pruebas.getrow()
sel_aplicacion = dw_aplicaciones.getrow()

//QUITAMOS REDRAW PARA EVITAR PARPADEOS
dw_1.SetRedraw(false)
dw_modelo.SetRedraw(false)	
dw_pruebas.SetRedraw(false)	
dw_aplicaciones.SetRedraw(false)	
dw_pantallas.SetRedraw(false)	
dw_modelos_coleccion.SetRedraw(false)
dw_piezas.SetRedraw(false)

cliente = dw_1.object.modelo_pieza_cliente[filas]
propuesta = dw_1.object.modelo_pieza_propuesta[filas]
pieza = dw_1.object.modelo_pieza_codigo[filas]

/*---------------------------------------------------------------------------------------------------------------------------------
			   AQUÍ IRÁ EL CÓDIGO PARA COMPROBAR LOS CAMPOS OBLIGATORIOS.
---------------------------------------------------------------------------------------------------------------------------------*/

// Campos obligatorios dw_1 

dw_1.accepttext()
falta_campo = false
if dw_1.rowcount() > 0 then
	if IsNull(dw_1.object.modelo_pieza_descripcion[dw_1.getrow()]) or Trim(String(dw_1.object.modelo_pieza_descripcion[dw_1.getrow()])) = "" then
		  campo = "modelo_pieza_descripcion"
		  motivo = "Campo Obligatorio: Descripción de la Pieza. "
		  falta_campo = True
	elseif IsNull(dw_1.object.modelo_pieza_activo[dw_1.getrow()]) or Trim(String(dw_1.object.modelo_pieza_activo[dw_1.getrow()])) = "" then
		  campo = "modelo_pieza_activo"
		  motivo = "Campo Obligatorio: Activa. "
		  falta_campo = True
	end if	

	if falta_campo then
	  MessageBox("Campo obligatorio: "+campo,motivo,Exclamation!, OK!,1)
	  seleccionar_fila_guardar(sel_prueba, sel_aplicacion)
	  dw_1.setfocus()
	  dw_1.SetColumn(campo)
	  return 0
	end if
end if


//DW MODELO

dw_modelo.accepttext()
falta_campo = false
if dw_modelo.rowcount() > 0 then
	if IsNull(dw_modelo.object.descoleccionsol_tecnico_lab[dw_modelo.getrow()]) or Trim(String(dw_modelo.object.descoleccionsol_tecnico_lab[dw_modelo.getrow()])) = "" then
		  campo = "descoleccionsol_tecnico_lab"
		  motivo = "Campo Obligatorio: Técnico de la Colección "
		  falta_campo = True
	end if	

	if falta_campo then
	  MessageBox("Campo obligatorio: "+campo,motivo,Exclamation!, OK!,1)
	  seleccionar_fila_guardar(sel_prueba, sel_aplicacion)
	  dw_modelo.setfocus()
	  dw_modelo.SetColumn(campo)
	  return 0
	end if
end if


// PRUEBAS

dw_pruebas.accepttext()
IF dw_pruebas.rowcount() > 0 AND NOT falta_campo THEN
	i = 1
	DO WHILE ( i <= dw_pruebas.rowcount() AND NOT falta_campo )
		
		IF IsNull(dw_pruebas.object.aceptado[i]) or Trim(String(dw_pruebas.object.aceptado[i]))="" THEN
			  campo="aceptado"
			  motivo  = "Campo Obligatorio: Introduzca si está OK"
			  falta_campo = True
		ELSEIF IsNull(dw_pruebas.object.modelo_version[i]) or Trim(String(dw_pruebas.object.modelo_version[i]))="" THEN
			  campo="modelo_version"
			  motivo  = "Campo Obligatorio: Introduzca la Versión de Color"
			  falta_campo = True
		ELSEIF IsNull(dw_pruebas.object.serie[i]) or Trim(String(dw_pruebas.object.serie[i]))="" THEN
			  campo="serie"
			  motivo  = "Campo Obligatorio: Introduzca la Serie"
			  falta_campo = True
		ELSEIF IsNull(dw_pruebas.object.base[i]) or Trim(String(dw_pruebas.object.base[i]))="" THEN
			  campo="base"
			  motivo  = "Campo Obligatorio: Introduzca la base"
			  falta_campo = True
		ELSEIF IsNull(dw_pruebas.object.tecnico_lab[i]) or Trim(String(dw_pruebas.object.tecnico_lab[i]))="" THEN
			  campo="tecnico_lab"
			  motivo  = "Campo Obligatorio: Introduzca el Técnico de Laboratorio"
			  falta_campo = True
		END IF
		
		// DW dependientes de la prueba
		prueba = dw_pruebas.object.codigo[i]
		
		// APLICACIONES
		dw_aplicaciones.setfilter("modelo_aplicacion_prueba = '"+prueba+"'")
		dw_aplicaciones.filter()
		dw_aplicaciones.accepttext()
		IF dw_aplicaciones.rowcount() > 0 AND NOT falta_campo THEN
			falta_campo = false
			j = 1
			DO WHILE ( j <= dw_aplicaciones.rowcount() AND NOT falta_campo )
				
				IF IsNull(dw_aplicaciones.object.modelo_aplicacion_operacion[j]) or Trim(String(dw_aplicaciones.object.modelo_aplicacion_operacion[j]))="" THEN
					  campo="modelo_aplicacion_operacion"
					  motivo  = "Campo Obligatorio: Introduzca la Operación"
					  falta_campo = True
				ELSEIF IsNull(dw_aplicaciones.object.modelo_aplicacion_aplicacion[j]) or Trim(String(dw_aplicaciones.object.modelo_aplicacion_aplicacion[j]))="" THEN
					  campo="modelo_aplicacion_aplicacion"
					  motivo  = "Campo Obligatorio: Introduzca el Tipo de Aplicación"
					  falta_campo = True
				END IF
				j++
			LOOP
				
			IF falta_campo THEN
			  MessageBox(" "+campo+": Campo obligatorio",motivo,Exclamation!, OK!,1)
			  seleccionar_fila_guardar(i, j)
			  dw_aplicaciones.setfocus()
			  dw_aplicaciones.SetColumn(campo)
			  return 0
			END IF
		END IF
		
		// FIN APLICACIONES
		// FIN DW dependientes de la prueba
		
		i++
	LOOP
		
	IF falta_campo THEN
	  MessageBox(" "+campo+": Campo obligatorio",motivo,Exclamation!, OK!,1)
	  seleccionar_fila_guardar(i, 0)
	  dw_pruebas.setfocus()
	  dw_pruebas.SetColumn(campo)
	  return 0
	END IF
END IF

// FIN PRUEBAS

/*---------------------------------------------------------------------------------------------------------------------------------
			   					FIN DE COMPROBAR LOS CAMPOS OBLIGATORIOS.
---------------------------------------------------------------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------------------------------------------------------------
			   					GRABACIÓN DW PRINCIPAL
---------------------------------------------------------------------------------------------------------------------------------*/

dw_1.accepttext()

//Codigo por si se desea mostrar aviso antes de guardar (Por defecto NO, si no utilizar Message.DoubleParm = 10001)

dw_1.SetTransObject(trans_ts)	
dw_modelo.SetTransObject(trans_ts)	
dw_pruebas.SetTransObject(trans_ts)
dw_aplicaciones.SetTransObject(trans_ts)


rtn = dw_1.Update()

/*---------------------------------------------------------------------------------------------------------------------------------
			   					FIN GRABACIÓN DW PRINCIPAL
---------------------------------------------------------------------------------------------------------------------------------*/

if rtn = 1 then
	coleccion = dw_modelo.object.modelo_coleccion[dw_modelo.getrow()]
	tecnico_actual = dw_modelo.object.descoleccionsol_tecnico_lab[dw_modelo.getrow()]
	SELECT tecnico_lab 
	INTO :tecnico_antiguo 
	FROM descoleccionsol 
	WHERE empresa = :codigo_empresa 
		AND codigo = :coleccion 
	using trans_ts;

	rtn = dw_modelo.Update()
	
	//Actualizamos contadores
	if tecnico_antiguo <> tecnico_actual then 
		UPDATE tecnico_lab 
		SET control = control - 1 
		WHERE empresa = :codigo_empresa 
			AND codigo = :tecnico_antiguo 
		USING trans_ts;
		
		if trans_ts.sqlcode = -1 then rtn = -1
		
		UPDATE tecnico_lab 
		SET control = control + 1 
		WHERE empresa = :codigo_empresa 
			AND codigo = :tecnico_actual 
		USING trans_ts;
		
		if trans_ts.sqlcode = -1 then rtn = -1		
	end if
end if


/*---------------------------------------------------------------------------------------------------------------------------------
				   				GRABACIÓN DATAWINDOWS AUXILIARES
---------------------------------------------------------------------------------------------------------------------------------*/
	
IF rtn = 1 THEN
	dw_pruebas.setfilter("")
	dw_pruebas.filter()
	rtn = dw_pruebas.update() 

end if		

if rtn = 1 then
	dw_aplicaciones.setfilter("")
	dw_aplicaciones.filter()
	rtn = dw_aplicaciones.update() 
end if
/*---------------------------------------------------------------------------------------------------------------------------------
				   			FIN GRABACIÓN DATAWINDOWS AUXILIARES
---------------------------------------------------------------------------------------------------------------------------------*/
		
IF rtn = 1 THEN
//	COMMIT USING sqlca;
	COMMIT USING trans_ts;
	mostrar_controles_edicion()

	dw_1.setfocus()
	dw_1.setcolumn(2)
	
ELSE
//	ROLLBACK USING sqlca;
	ROLLBACK USING trans_ts;
	seleccionar_fila_guardar(sel_prueba, sel_aplicacion)
	messagebox ("Error", "Error guardando ... ")
END IF
dw_1.SetTransObject(SQLCA)	
dw_pruebas.SetTransObject(SQLCA)	
dw_aplicaciones.SetTransObject(SQLCA)	
dw_modelo.SetTransObject(SQLCA)	

guardando = false
estado = 1 // Modo edición

// Refrescar Datawindows después de guardar.
if rtn = 1 then
	dw_1.retrieve (codigo_empresa, padre_codigo)
	dw_modelo.retrieve (codigo_empresa, dw_1.object.modelo_pieza_modelo[1],dw_1.object.modelo_pieza_cliente[1],dw_1.object.modelo_pieza_propuesta[1])
	dw_pruebas.retrieve (codigo_empresa, dw_1.object.modelo_pieza_modelo[1],dw_1.object.modelo_pieza_cliente[1],dw_1.object.modelo_pieza_propuesta[1],dw_1.object.modelo_pieza_codigo[1])
	dw_aplicaciones.retrieve (codigo_empresa, dw_1.object.modelo_pieza_modelo[1],dw_1.object.modelo_pieza_cliente[1],dw_1.object.modelo_pieza_propuesta[1],dw_1.object.modelo_pieza_codigo[1])
	dw_modelos_coleccion.retrieve (codigo_empresa, dw_modelo.object.modelo_coleccion[1])
	dw_piezas.retrieve(codigo_empresa, dw_1.object.modelo_pieza_modelo[1],dw_1.object.modelo_pieza_cliente[1],dw_1.object.modelo_pieza_propuesta[1])
	dw_pantallas.retrieve(codigo_empresa, dw_1.object.modelo_pieza_codigo_lab[1])
	f_cargar_imagen_pieza()//p_imagen.PictureName = f_cargar_imagen_nuevo(padre_codigo)
	
//	if dw_pruebas.rowcount() > 0 then
//		seleccionar_fila (dw_pruebas,1,7)
//	end if
	seleccionar_fila_guardar(sel_prueba, sel_aplicacion)
end if


return rtn
end function

public function integer f_borrar ();//SOBRESCRIBIMOS LA FUNCION DEL PADRE. NO LA LLMAMOS CON super::funcion()

string modelo, coleccion
long total_modelos_coleccion, total_trabajos_lab
str_ventana_alerta parametros
string botones[2]

// Excepcion: Tengo que tomar el valor de la coleccion antes de borrar el datawindow dw_1. Al borrarlo da error por no contener ninguna fila. Hemos sobrescrito es script del padre.
coleccion = dw_1.object.coleccion[1]
modelo = padre_codigo

parametros.titulo = "Atención Borrado de Modelo"
parametros.subtitulo = "Borrar MODELO"
parametros.mensaje = "¿Desea borrar el MODELO?"
parametros.tipo = 1
//parametros.botones = botones
parametros.mostrar_imagen = true
openwithparm(wtc_ventana_alerta, parametros)
borrar = Int(Message.DoubleParm)

rtn = 0
if borrar = 1 then
	padre_codigo = dw_1.object.#1[dw_1.GetRow()]

	dw_1.SetTransObject(trans_ts)	
	
	rtn = dw_1.deleterow(0)
	if rtn = 1 then
		rtn = dw_1.update()
	end if
end if

if rtn = 1 then
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//   AQUÍ IRÁ EL CÓDIGO DE LOS DW AUXILIARES. CONTROLAR LOS BORRADOS CON rtn. 
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	select count (*) 
	into :total_trabajos_lab
	from destrabajo2
	where empresa = :codigo_empresa
	and modelo = :padre_codigo
	and laboratorio = 'S' using trans_ts;
	
	if total_trabajos_lab > 0 then
		messagebox("Atencion", "No se puede borrar el modelo porque tiene pruebas de laboratorio")
		rtn = -1
	end if
	
	IF rtn = 1 THEN
		modelo = padre_codigo
		delete from destrabajo2
		where empresa = :codigo_empresa
		and modelo = :modelo using trans_ts;
		
		IF trans_ts.SQLCode <> 0 THEN         
			MessageBox("SQL error", trans_ts.SQLErrText)
			rtn = -1
		END IF
	end if
	
	if rtn = 1 then
		select count(*)
		into :total_modelos_coleccion
		from desmodelos
		where empresa = :codigo_empresa
		and coleccion = :coleccion using trans_ts;
		
		if total_modelos_coleccion = 1 then
			delete from deshistorico
			where empresa = :codigo_empresa
			and coleccion = :coleccion using trans_ts;
	
			IF trans_ts.SQLCode <> 0 THEN         
				MessageBox("SQL error", trans_ts.SQLErrText)
				rtn = -1
			END IF
		end if
	end if
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	if rtn = 1 then
//		COMMIT USING sqlca;
		COMMIT USING trans_ts;
		dw_1.SetTransObject(SQLCA)	
		pb_nuevo.TriggerEvent(Clicked!)	
		mostrar_controles_insercion()
		dw_1.setfocus()
		dw_1.setcolumn(2)
		estado = 0 // Modo Insercion
		dw_imagen.visible = false
	ELSE
//		ROLLBACK USING sqlca;
		ROLLBACK USING trans_ts;
		dw_1.SetTransObject(SQLCA)	
//		dw_1.object.coleccion[1] = coleccion
		dw_1.object.#1[1] = modelo
		pb_cancelar.triggerevent(Clicked!)
	
	END IF
end if

return rtn
end function

public subroutine mostrar_controles_insercion ();//Activa desactiva los botones de la ventana cuando estamos en modo inserción

pb_buscar.enabled = true
pb_cancelar.enabled = true
pb_grabar.enabled = true

pb_nuevo.enabled = false
pb_borrar.enabled = false
end subroutine

public subroutine mostrar_controles_edicion ();// Activa y desactiva botones cuando estamos en modo de edición

pb_buscar.enabled = true
pb_cancelar.enabled = true
pb_grabar.enabled = true

pb_nuevo.enabled = false
pb_borrar.enabled = false
end subroutine

public subroutine seleccionar_fila (datawindow dw, integer fila, integer columna);if fila > 0 then //and fila <> dw.getselectedrow(0) then
	dw.SetRow (fila)
	dw.scrolltorow(fila)
	if columna <> 0 then
		dw.SetColumn(columna)
	end if
	dw.event rowfocuschanged(fila)
end if
end subroutine

public function boolean f_hay_ubicacion_asignada ();boolean hay_ubicacion_asignada

if isnull(dw_1.object.modelo_pieza_ubicacion[dw_1.GetRow()]) or dw_1.object.modelo_pieza_ubicacion[dw_1.GetRow()] = 0 then
	hay_ubicacion_asignada = false
else
	hay_ubicacion_asignada = true
end if
return hay_ubicacion_asignada
end function

public subroutine f_cargar_imagen_pieza ();//CON RUTAS
string pieza

pieza = dw_1.object.modelo_pieza_codigo_lab[dw_1.getrow()]

if not isnull(pieza) and pieza <> "" then
	ftc_imagen_fondo_datawindow(dw_imagen,"1","","",pieza)	
end if

end subroutine

public function integer f_crear_estructura (boolean generar_base, ref string mensaje);String codigo_fin, modelo, pieza, prueba, codigo_pantallas, articulo_nuevo, articulo_sup, operacion, operacion_ant, base_version, relieve
String desc_articulo, cliente_articulo, coleccion_articulo, pasta_articulo, base_articulo, acabado_articulo, formato
String formula, aplicacion, nombre_fichero, tipo_maquina, archivo_disenyo_codigo, archivo_disenyo_prueba
Dec gramaje, gramaje_7_20
Boolean control_marca
Int i, k, cont_operacion, cont_aplicacion, total_filas, inserciones, clientes, numero_versiones
str_colisiones nuevo_codigo
Datetime ahora
Boolean insertar_formato 

String sel, sel2, articulo, desc_formula, formula_nueva, esta
String formula_estandar, formula_unidad, mprima, desc_unidad, proveedor, unidad_mprima
Int numero, numero2, j, res, cont_traspasado, cont_no_traspasado, cont_ya_traspasado
Datastore aplicaciones, mprimas
transaction trm
str_colisiones p_colisiones

String archivo_disenyo_validacion, archivo_disenyo_prueba_validacion, tipo_maquina_disenyo_validacion, primer_articulo_fallo, nombre_validacion
str_ventana_alerta parametros
string botones[1]
Int respuesta

String ruta, fichero
Boolean aviso_imagen = false
int orden_formula 

/*
Tablas afectadas

articulos
almartcal
almartcajas
palarticulo
art_versiones
art_escandallo
art_ver_operaciones
art_ver_op_aplicaciones
*/

//Obtener los parámetros necesarios y validación

ahora = Datetime(Today(),Now())

mensaje = ""

pieza = String(dw_1.object.modelo_pieza_codigo_lab[dw_1.getrow()])
if pieza = "" then
	pieza = "Debe indicar la Pieza"
	return -1
end if

modelo = String(dw_modelo.object.modelo_propuesta_modelo[dw_modelo.getrow()])
if modelo = "" then
	mensaje = "Debe indicar el Modelo"
	return -1
end if


if sle_busqueda.text = "" then
	mensaje = "Debe especificar el código del artículo fin de la estructura"
	return -1
end if

codigo_fin = sle_busqueda.text

if sle_desc_est.text = "" then
	mensaje = "Debe especificar una descripción para los artículos de la estructura"
	return -1
end if

desc_articulo = sle_desc_est.text

prueba = String(dw_pruebas.object.codigo[dw_pruebas.getrow()])
pasta_articulo = String(dw_1.object.modelo_trabajo_pasta[dw_1.getrow()])
acabado_articulo = String(dw_1.object.modelo_trabajo_acabado_lab[dw_1.getrow()])
insertar_formato = false
if generar_base then
	if isnull(dw_pruebas.object.base[dw_pruebas.getrow()]) or String(dw_pruebas.object.base[dw_pruebas.getrow()]) = "" then
		mensaje = "No ha seleccionado una prueba que tenga la base indicada, por lo que no se puede crear la estructura hasta la base."
		return -1
	else
		base_articulo = String(dw_pruebas.object.base[dw_pruebas.getrow()])
		//obtengo el formato de la base para insertar en todos los artículos (salvo que existan cortes)
		insertar_formato = true
		for i=1 To dw_aplicaciones.rowcount()
			operacion = dw_aplicaciones.object.modelo_aplicacion_operacion[i]
			if operacion = '5' then
				insertar_formato = false
			end if
		next
	end if
end if	

SELECT relieve INTO :relieve FROM articulos WHERE empresa = :codigo_empresa AND codigo = :codigo_fin using trans_ts;
if insertar_formato and generar_base then
	SELECT formato INTO :formato FROM articulos WHERE empresa = :codigo_empresa AND codigo = :base_articulo using trans_ts;
else 
	setnull(formato)
end if
// Modificacion para que coja el formato del encajado cuando se genera la estructura sin base.
if not generar_base then
	SELECT formato INTO :formato FROM articulos WHERE empresa = :codigo_empresa AND codigo = :codigo_fin using trans_ts;
end if

coleccion_articulo = String(dw_modelo.object.modelo_coleccion[dw_modelo.getrow()])

//Bucle de inserción de artículos por aplicaciones
inserciones = 0
operacion_ant = ""
cont_operacion = 1
articulo_sup = ""
total_filas = dw_aplicaciones.rowcount()
i = 1

//control incial del tiff en produccion
Do While i <= total_filas 
	archivo_disenyo_validacion = dw_aplicaciones.object.archivo_disenyo_codigo[i]
	tipo_maquina_disenyo_validacion = dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[i]
	archivo_disenyo_prueba_validacion = dw_aplicaciones.object.modelo_aplicacion_modelo_archivo_prueba[i]
	nombre_validacion = dw_aplicaciones.object.archivo_disenyo_sistema_archivos_fichero[i]
	
	primer_articulo_fallo = ""
	
	if not isnull(archivo_disenyo_validacion) and archivo_disenyo_validacion <> "" and not isnull(archivo_disenyo_prueba_validacion) and archivo_disenyo_prueba_validacion <> "" then
		//Comprobar que no hay una alta con codigo de prueba de archivo diferente
		SELECT articulo INTO :primer_articulo_fallo FROM art_ver_op_aplicaciones  
		WHERE empresa = :codigo_empresa 
		AND archivo_disenyo_tipomaquina_disenyo = :tipo_maquina_disenyo_validacion 
		AND archivo_disenyo_codigo = :archivo_disenyo_validacion
      AND archivo_disenyo_prueba <> :archivo_disenyo_prueba_validacion using trans_ts;
		
		if not isnull(primer_articulo_fallo) and primer_articulo_fallo <> "" then
			//Aviso, si continua puede provocar un error en producción (un TIFF con distintas versiones indetectable en la ficha).
			parametros.titulo = "Versión de Archivo erronea"
			parametros.subtitulo = "Problema para Producción"
			parametros.mensaje = "El articulo "+primer_articulo_fallo+" tiene una versión del archivo ("+nombre_validacion+") distinta. No se puede realizar la copia."
			parametros.tipo = 1
			botones[1] = "Continuar"
			//botones[2] = "No"
			parametros.botones = botones
			parametros.mostrar_imagen = true
			openwithparm(wtc_ventana_alerta, parametros)
			respuesta = Int(Message.DoubleParm)
			
			mensaje = "Copia Cancelada."

			ROLLBACK USING trans_ts;
			return -1
		end if
	end if
	i ++	
Loop

i = 1
Do While i <= total_filas 
	operacion = String(dw_aplicaciones.object.modelo_aplicacion_operacion[i])
	if operacion <>  operacion_ant or operacion = "5" or i = 1 then //Cambio de operación, Corte o primera operacion
		operacion_ant = ""
		//Nuevo código de artículo
		nuevo_codigo.empresa = codigo_empresa
		nuevo_codigo.tabla = "articulos"
		nuevo_codigo.campo = "codigo"
		nuevo_codigo.filtro = ""
		nuevo_codigo.buscar_huecos = false
		articulo_nuevo = f_colisiones(trans_ts,nuevo_codigo)
		
		//Detección código pantallas
		k = i
		codigo_pantallas = ""
		Do While k <= total_filas 
			if String(dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[k]) = '3' and not isnull(dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[k]) and dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[k] <> "" then
				codigo_pantallas = dw_aplicaciones.object.archivo_disenyo_nombre[k]
				k = total_filas + 1
			end if
			k++
		Loop
		
		INSERT INTO articulos 
			(empresa, codigo, descripcion, familia, formato, ancho, largo, subformato, modelo, unidad, precio_coste, 
			fecha_alta, fecha_anulado, fecha_fin, cuenta, proveedor, decorado, sector, conjunto, pesopieza, piezascaja, pesocaja, 
			pesoenvase, metroscaja, metroslcaja, cuenta_contable, tono, calibre, compras, activo, unidad_est, prev_anular, empleado, 
			molde, plato_sup, plato_inf, calibre_min, calibre_max, cliente, uso, estilo, coleccion, color, imagen, 
			modelo_origen, pieza_origen, prueba_origen, fecha_primera_produccion, tipo_pasta, codigo_pantallas, espesor, ciclo, 
			temp_inferior, temp_superior, ean13, ventasitalia, usuario, temp_inferior1, temp_superior1, obs_ficha_hornos, tipo, 
			partidaest, control_stock, ubi_muestras , fechastocksugerido, codigo_compras, 
         estandar, bloqueado, cod_cliente, marco, canto_vivo, marcado, etiqueta_ce, lote, observaciones, relieve)
		VALUES 
			(:codigo_empresa, :articulo_nuevo, :desc_articulo, '1', :formato, NULL, NULL, NULL, NULL, 0, NULL, 
			:ahora, NULL, NULL, NULL, NULL, NULL, 'S', NULL, NULL, NULL, NULL, 
			NULL, NULL, NULL, NULL, 'N', 'N', NULL, 'S', NULL, NULL, NULL, 
			NULL, NULL, NULL, NULL, NULL, NULL, 2, NULL, :coleccion_articulo, NULL, NULL, 
			:modelo, :pieza, :prueba, NULL, :pasta_articulo, :codigo_pantallas, NULL, NULL, 
			NULL, NULL, NULL, NULL, :nombre_usuario, NULL, NULL, NULL, NULL, 
			NULL, 'N', NULL, NULL, NULL, 
			NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, :relieve)
		USING trans_ts;
		
		IF trans_ts.sqlcode <> 0 THEN
			mensaje = "Error creando el artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
			ROLLBACK USING trans_ts;
			return -1
		END IF
		
		//Imagen articulo
		if not isnull(articulo_nuevo) and articulo_nuevo <> "" and not isnull(modelo) and modelo <> "" then
			if not isnull(pieza) and pieza <> "" then
				SELECT TOP 1 ruta, fichero INTO :ruta, :fichero FROM modelo_pieza_archivo WHERE empresa = :codigo_empresa AND pieza = :pieza using trans_ts;
				if isnull(fichero) or fichero = "" then
					SELECT ruta, fichero INTO :ruta, :fichero FROM modelo_archivo_expo WHERE empresa = :codigo_empresa AND modelo = :modelo AND produccion = 1 using trans_ts;
				end if
			else
				SELECT ruta, fichero INTO :ruta, :fichero FROM modelo_archivo_expo WHERE empresa = :codigo_empresa AND modelo = :modelo AND produccion = 1 using trans_ts;
			end if
			if not isnull(fichero) and fichero <> "" then
				INSERT INTO articulos_imagen_encajado (empresa, articulo, codigo, modelo, pieza, ruta, fichero, produccion, fecha_modificacion) 
				VALUES (:codigo_empresa, :articulo_nuevo, '1', :modelo, :pieza, :ruta, :fichero, 1, :ahora)
				USING trans_ts;
				
				IF trans_ts.sqlcode <> 0 THEN
					mensaje = "Error creando la imagen del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
					ROLLBACK USING trans_ts;
					return -1
				END IF	
			else
				aviso_imagen = true
			end if
		end if
		
		//Código estadístico
		INSERT INTO art_codestadistico 
			(empresa, codigo, G1, G2, G3, G4, PT, GD, NC, RE, rectificado, AV, PL, CT, EN, TM, OTR, N, INKCID)
		VALUES
			(:codigo_empresa, :articulo_nuevo, NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
		USING trans_ts;
		
		IF trans_ts.sqlcode <> 0 THEN
			mensaje = "Error creando el código estadístico del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
			ROLLBACK USING trans_ts;
			return -1
		END IF	
		
		
		//Escandallo y versiones
		if articulo_sup = "" then
			if generar_base then
				INSERT INTO art_versiones (empresa, articulo, version, base, descripcion, observaciones, aprovechar_base, tipo_version)
				VALUES (:codigo_empresa, :articulo_nuevo, 1, :base_articulo, "ÚNICA", NULL, NULL, 'P') 
				USING trans_ts;
				
				IF trans_ts.sqlcode <> 0 THEN
					mensaje = "Error creando versiones del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
					ROLLBACK USING trans_ts;
					return -1
				END IF
				
				INSERT INTO art_escandallo (empresa, articulo, version, articulo_ant, factor, aprovecha)
				VALUES (:codigo_empresa, :articulo_nuevo, 1, :base_articulo, 1, NULL) 
				USING trans_ts;
				
				IF trans_ts.sqlcode <> 0 THEN
					mensaje = "Error creando escandallo del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
					ROLLBACK USING trans_ts;
					return -1
				END IF
			else
				INSERT INTO art_versiones (empresa, articulo, version, base, descripcion, observaciones, aprovechar_base, tipo_version)
				VALUES (:codigo_empresa, :articulo_nuevo, 1, NULL, "ÚNICA", NULL, NULL, 'P') 
				USING trans_ts;
				IF trans_ts.sqlcode <> 0 THEN
					mensaje = "Error creando versiones del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
					ROLLBACK USING trans_ts;
					return -1
				END IF
				
				INSERT INTO art_escandallo (empresa, articulo, version, articulo_ant, factor, aprovecha)
				VALUES (:codigo_empresa, :articulo_nuevo, 1, 0, 1, NULL) 
				USING trans_ts;
				IF trans_ts.sqlcode <> 0 THEN
					mensaje = "Error creando escandallo del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
					ROLLBACK USING trans_ts;
					return -1
				END IF
			end if
		else
			INSERT INTO art_versiones (empresa, articulo, version, base, descripcion, observaciones, aprovechar_base, tipo_version)
			VALUES (:codigo_empresa, :articulo_nuevo, 1, :articulo_sup, "ÚNICA", NULL, NULL, 'P') 
			USING trans_ts;
			
			IF trans_ts.sqlcode <> 0 THEN
				mensaje = "Error creando versiones del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
				ROLLBACK USING trans_ts;
				return -1
			END IF
		
			INSERT INTO art_escandallo (empresa, articulo, version, articulo_ant, factor, aprovecha)
			VALUES (:codigo_empresa, :articulo_nuevo, 1, :articulo_sup, 1, NULL) 
			USING trans_ts;
			IF trans_ts.sqlcode <> 0 THEN
				mensaje = "Error creando escandallo del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
				ROLLBACK USING trans_ts;
				return -1
			END IF
		end if
		
		//Otros aspectos del artículo (Calidad, encajado, paletizado,...)
		INSERT INTO almartcal 
			(empresa, articulo, calidad, precio, fecha_alta, stockmin, stockmax, puntopedido)
		VALUES
			(:codigo_empresa, :articulo_nuevo, '1', NULL, :ahora, NULL, NULL, NULL)
		USING trans_ts;
		IF trans_ts.sqlcode <> 0 THEN
			mensaje = "Error añadiendo la calidad del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
			ROLLBACK USING trans_ts;
			return -1
		END IF	
		
		INSERT INTO almartcajas 
			(empresa, articulo, caja, piezascaja, metroscaja, metroslcaja, pesocaja, metros_reales_caja, peso_real_caja, 
			metros_reales, descripcion, codigo, pordefecto)
		VALUES
			(:codigo_empresa, :articulo_nuevo, '3', '999.0000', '58.9410', '294.7050', NULL, NULL, NULL, 
			'58.9410', NULL, NULL, 'S')
		USING trans_ts;
		
		IF trans_ts.sqlcode <> 0 THEN
			mensaje = "Error añadiendo el encajado del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
			ROLLBACK USING trans_ts;
			return -1
		END IF	
		
		INSERT INTO palarticulo 
			(empresa, articulo, codigo, caja, cajaspallet, planospallet, alturas, pordefecto)
		VALUES
			(:codigo_empresa, :articulo_nuevo, '0', '3', '999', '999', '999', 'S')
		USING trans_ts;
		IF trans_ts.sqlcode <> 0 THEN
			mensaje = "Error añadiendo el paletizado del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
			ROLLBACK USING trans_ts;
			return -1
		END IF	
		
		articulo_sup = articulo_nuevo
	end if
	
	
	//Operaciones
	if operacion_ant = "" or operacion <> operacion_ant then
		INSERT INTO art_ver_operaciones (empresa, articulo, version, operacion, tipo_operacion, orden, formato, factor, 
			juegopantallas, numaplicaciones, coste, coste_fab, coste_mp, orientacion, piezas_fila, coste_fab_mermas, coste_mp_mermas)
		VALUES 
			(:codigo_empresa, :articulo_nuevo, 1, '1', :operacion, '1', :formato, 1.00, 
			NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL) 
		USING trans_ts;
		IF trans_ts.sqlcode <> 0 THEN
			mensaje = "Error creando la operación del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
			ROLLBACK USING trans_ts;
			return -1
		END IF
		operacion_ant = operacion
		cont_operacion++
		cont_aplicacion = 1
	end if
	
	//Aplicaciones
	gramaje = dw_aplicaciones.object.modelo_aplicacion_gramaje[i]
	gramaje_7_20 = dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20[i]
	formula = String(dw_aplicaciones.object.modelo_aplicacion_formula[i])
	aplicacion =  String(dw_aplicaciones.object.modelo_aplicacion_aplicacion[i])
	nombre_fichero = ""
	nombre_fichero = String(dw_aplicaciones.object.archivo_disenyo_nombre[i])
	tipo_maquina = dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[i]		
	
	//Formulas para costes de TIFF
	//Creación Automática de Fórmulas estándar
	if not isnull(nombre_fichero) and nombre_fichero <> "" and not isnull(tipo_maquina) and tipo_maquina <> "3" then //Se exceptua serigrafía
		if isnull(formula) or formula = "" then
			esta = ""
			SELECT formula INTO :esta FROM prodformula WHERE descripcion_laboratorio = :nombre_fichero USING trans_ts;
			if isnull(esta) or esta = "" then
				
				//ES ESTRICTAMENTE NECESARIA LA EXISTENCIA DE FORMULAS PARA IMPRIMIR - La ficha técnica muestra fórmulas
				SELECT formula_estandar, formula_unidad INTO :formula_estandar, :formula_unidad FROM prodaplicaciones WHERE empresa = :codigo_empresa AND codigo = :aplicacion USING trans_ts;
				if formula_estandar = '0' then
					ROLLBACK USING trans_ts;
					MessageBox("Error", "No se puede crear estructura. No existe formula estandar para la aplicación :"+aplicacion+".Para imprimir un fichero, es necesario que tenga fórmula.")
					return -1
				end if
				
				//HAY QUE CREAR LA FORMULA DEL TIFF, ANTES DE AÑADIRLA AL CAMPO FORMULA DE LA APLICACIÓN
				p_colisiones.empresa = codigo_empresa
				p_colisiones.tabla = "prodformula"
				p_colisiones.campo = "formula"
				p_colisiones.filtro = ""
				p_colisiones.buscar_huecos = false
				formula_nueva = String(f_colisiones(trans_ts, p_colisiones))
				
				SELECT abreviado INTO :desc_unidad FROM comunimedida WHERE codigo = :formula_unidad USING trans_ts;
				desc_unidad = lower(desc_unidad)
				
				INSERT INTO prodformula (empresa, formula, descripcion_produccion, descripcion_laboratorio, fecha_alta, empleado, paletacolor, colorimetro, coste_kg_formula, 
												textura, activa_en_produccion, mp_equivalente, referencia_general, unidad_coste) 
				VALUES (:codigo_empresa, :formula_nueva, :nombre_fichero, :nombre_fichero, :ahora, NULL, NULL, NULL, NULL, NULL, 'S', NULL, NULL, :formula_unidad) USING trans_ts;
				
				IF trans_ts.SQLCode <> 0 THEN         
					MessageBox("SQL error Fórmula", trans_ts.SQLErrText)
					ROLLBACK USING trans_ts;
					return -1
				END IF
				
				
				//Componentes de la formula (extraidos de la estándar)
				sel2 = "SELECT mprima, proveedor, unidad, orden FROM prodaplicacion_mprima WHERE empresa = '"+codigo_empresa+"' AND aplicacion = '"+aplicacion+"'"
				f_cargar_cursor_transaccion (trans_ts,  mprimas,  sel2)
				numero2 = mprimas.RowCount()
				j = 1
				do while (j <= numero2) 
					mprima = mprimas.object.mprima[j]
					proveedor = mprimas.object.proveedor[j]
					unidad_mprima = mprimas.object.unidad[j]
					orden_formula = mprimas.object.orden[j]
					
					INSERT INTO proddetformula (empresa, formulacion, mp, cantidad, unidadmedida, proveedor, cantidad_u_m_mp, unidad_u_m_mp, coste_mp, orden) 
					VALUES (:codigo_empresa, :formula_nueva, :mprima, NULL, :desc_unidad, :proveedor, 0, :unidad_mprima ,0, :orden_formula ) USING trans_ts;
					IF trans_ts.SQLCode <> 0 THEN         
						MessageBox("SQL error Componentes Fórmula ", trans_ts.SQLErrText)
						ROLLBACK USING trans_ts;
						return -1
					END IF
					j++
				loop
				mprimas.reset()
			else
				formula_nueva = esta
			end if
			
			
			formula = formula_nueva
			
		else
			//Apuntar o imprimir listado de TIFFs no insertados porque ya hay formulas...
			desc_formula = ""
			SELECT descripcion_laboratorio INTO :desc_formula FROM prodformula WHERE empresa = :codigo_empresa AND formula = :formula USING trans_ts;
			if desc_formula <> nombre_fichero then
				MessageBox("Error", "Ya hay una fórmula asociada en la aplicación del TIF del artículo")
				ROLLBACK USING trans_ts;
				return -1
			end if
		end if
	else
		nombre_fichero = ""
	end if
	
	archivo_disenyo_codigo = dw_aplicaciones.object.archivo_disenyo_codigo[i]
	archivo_disenyo_prueba = dw_aplicaciones.object.modelo_aplicacion_modelo_archivo_prueba[i]
	
	INSERT INTO art_ver_op_aplicaciones
		(empresa, articulo, version, operacion, contadoraplicacion, pantalla, formula, gramaje, tipoaplicacion, orden, densidad, 
		viscosidad, boquilla, ciclo, temp_sup, temp_inf, cortes, discos, paso_cliche, gram_7x20, tiff, 
		archivo_disenyo_tipomaquina_disenyo, archivo_disenyo_codigo, archivo_disenyo_prueba)
	VALUES 
		(:codigo_empresa, :articulo_nuevo, 1, '1', :cont_aplicacion, NULL, :formula, :gramaje, :aplicacion, :cont_aplicacion, NULL, 
		NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, :gramaje_7_20, :nombre_fichero, :tipo_maquina, :archivo_disenyo_codigo, :archivo_disenyo_prueba) 
	USING trans_ts;
	IF trans_ts.sqlcode <> 0 THEN
		mensaje = "Error creando aplicacion del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
		ROLLBACK USING trans_ts;
		return -1
	END IF
	
	cont_aplicacion++
	i++
Loop

//Enlace al encajado en el escandallo y en versiones

//No enlazar a versiones si ya hay una entrada
SELECT COUNT(*) INTO :numero_versiones 
FROM art_versiones 
WHERE empresa = :codigo_empresa AND articulo = :codigo_fin using trans_ts;

if numero_versiones = 0 then
	INSERT INTO art_versiones (empresa, articulo, version, base, descripcion, observaciones, aprovechar_base, tipo_version)
	VALUES (:codigo_empresa, :codigo_fin, 1, :articulo_nuevo, "ÚNICA", NULL, NULL, 'P') 
	USING trans_ts;
	IF trans_ts.sqlcode <> 0 THEN
		mensaje = "Error creando versiones del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
		ROLLBACK USING trans_ts;
		return -1
	END IF
else
	SELECT base INTO :base_version 
	FROM art_versiones 
	WHERE empresa = :codigo_empresa AND articulo = :codigo_fin using trans_ts;
	
	if isnull(base_version) or base_version = "" then
		UPDATE art_versiones SET base = :articulo_nuevo WHERE empresa = :codigo_empresa AND articulo = :codigo_fin using trans_ts;
		IF trans_ts.sqlcode <> 0 THEN
			mensaje = "Error actualizado versiones del artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
			ROLLBACK USING trans_ts;
			return -1
		END IF
		
	end if
end if

INSERT INTO art_escandallo (empresa, articulo, version, articulo_ant, factor, aprovecha)
VALUES (:codigo_empresa, :codigo_fin, 1, :articulo_nuevo, 1, NULL) 
USING trans_ts;
IF trans_ts.sqlcode <> 0 THEN
	mensaje = "Error enlazando la base en el escandallo en el artículo nuevo "+articulo_nuevo+". Avise al administrador. Detalles: "+trans_ts.SQLErrText
	ROLLBACK USING trans_ts;
	return -1
END IF

COMMIT USING trans_ts;
if aviso_imagen then
	MessageBox("Aviso", "¡Atención! No se han encontrado imágenes para algunos artículos creados. Por favor, revise las imágenes de los artículos creados." )
end if
mensaje = "La estructura se ha creado con éxito a partir del artículo con código "+sle_busqueda.text+".~n¿Desea abrir el mantenimiento de intermedios para editar los artículos nuevos creados?"
return 1



end function

public subroutine seleccionar_fila_guardar (long sel_prueba, long sel_aplicacion);dw_1.SetRedraw(false)
dw_modelo.SetRedraw(false)	
dw_pruebas.SetRedraw(false)	
dw_aplicaciones.SetRedraw(false)	
dw_pantallas.SetRedraw(false)	
dw_modelos_coleccion.SetRedraw(false)
dw_piezas.SetRedraw(false)

seleccionar_fila(dw_pruebas,sel_prueba,0)
seleccionar_fila(dw_aplicaciones,sel_aplicacion,0)

dw_1.SetRedraw(true)
dw_modelo.SetRedraw(true)	
dw_pruebas.SetRedraw(true)	
dw_aplicaciones.SetRedraw(true)	
dw_pantallas.SetRedraw(true)	
dw_modelos_coleccion.SetRedraw(true)
dw_piezas.SetRedraw(true)
end subroutine

on wtc_mant_pruebas.create
int iCurrent
call super::create
this.pb_borrar_prueba=create pb_borrar_prueba
this.pb_duplica_prueba=create pb_duplica_prueba
this.pb_anyade_prueba=create pb_anyade_prueba
this.pb_borra_aplicacion=create pb_borra_aplicacion
this.pb_anyade_aplicacion=create pb_anyade_aplicacion
this.st_2=create st_2
this.dw_ficha_comercial=create dw_ficha_comercial
this.dw_modelo=create dw_modelo
this.pb_intercala_aplicacion=create pb_intercala_aplicacion
this.dw_modelos_coleccion=create dw_modelos_coleccion
this.dw_piezas=create dw_piezas
this.pb_1=create pb_1
this.p_seleccion=create p_seleccion
this.sle_busqueda=create sle_busqueda
this.st_crear_est=create st_crear_est
this.sle_desc_est=create sle_desc_est
this.st_desc_est=create st_desc_est
this.cb_crear_est_base=create cb_crear_est_base
this.cb_crear_est=create cb_crear_est
this.cb_crear_est_inicio=create cb_crear_est_inicio
this.pb_2=create pb_2
this.cb_1=create cb_1
this.st_coste=create st_coste
this.dw_ficha_laboratorio=create dw_ficha_laboratorio
this.pb_3=create pb_3
this.dw_pantallas=create dw_pantallas
this.dw_ticket=create dw_ticket
this.dw_lineas=create dw_lineas
this.dw_stock_base=create dw_stock_base
this.pb_bases_mas=create pb_bases_mas
this.pb_bases_menos=create pb_bases_menos
this.dw_bases=create dw_bases
this.dw_pruebas=create dw_pruebas
this.dw_reenvio=create dw_reenvio
this.dw_trabajo=create dw_trabajo
this.cbx_solo_bases=create cbx_solo_bases
this.cbx_solo_base_ticket=create cbx_solo_base_ticket
this.dw_pruebas_color=create dw_pruebas_color
this.cb_2=create cb_2
this.cb_3=create cb_3
this.pb_4=create pb_4
this.dw_aplicaciones=create dw_aplicaciones
this.sle_pruebas=create sle_pruebas
this.st_1=create st_1
this.sle_version_color=create sle_version_color
this.st_3=create st_3
this.cbx_pruebas_ok=create cbx_pruebas_ok
this.dw_imagen=create dw_imagen
this.pb_5=create pb_5
this.dw_seleccion=create dw_seleccion
this.dw_copiar=create dw_copiar
this.pb_imprimir_etiqueta=create pb_imprimir_etiqueta
this.dw_etiqueta_muestras=create dw_etiqueta_muestras
this.st_4=create st_4
this.dw_molde_lineas=create dw_molde_lineas
this.pb_6=create pb_6
this.uo_buscar_molde=create uo_buscar_molde
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.pb_borrar_prueba
this.Control[iCurrent+2]=this.pb_duplica_prueba
this.Control[iCurrent+3]=this.pb_anyade_prueba
this.Control[iCurrent+4]=this.pb_borra_aplicacion
this.Control[iCurrent+5]=this.pb_anyade_aplicacion
this.Control[iCurrent+6]=this.st_2
this.Control[iCurrent+7]=this.dw_ficha_comercial
this.Control[iCurrent+8]=this.dw_modelo
this.Control[iCurrent+9]=this.pb_intercala_aplicacion
this.Control[iCurrent+10]=this.dw_modelos_coleccion
this.Control[iCurrent+11]=this.dw_piezas
this.Control[iCurrent+12]=this.pb_1
this.Control[iCurrent+13]=this.p_seleccion
this.Control[iCurrent+14]=this.sle_busqueda
this.Control[iCurrent+15]=this.st_crear_est
this.Control[iCurrent+16]=this.sle_desc_est
this.Control[iCurrent+17]=this.st_desc_est
this.Control[iCurrent+18]=this.cb_crear_est_base
this.Control[iCurrent+19]=this.cb_crear_est
this.Control[iCurrent+20]=this.cb_crear_est_inicio
this.Control[iCurrent+21]=this.pb_2
this.Control[iCurrent+22]=this.cb_1
this.Control[iCurrent+23]=this.st_coste
this.Control[iCurrent+24]=this.dw_ficha_laboratorio
this.Control[iCurrent+25]=this.pb_3
this.Control[iCurrent+26]=this.dw_pantallas
this.Control[iCurrent+27]=this.dw_ticket
this.Control[iCurrent+28]=this.dw_lineas
this.Control[iCurrent+29]=this.dw_stock_base
this.Control[iCurrent+30]=this.pb_bases_mas
this.Control[iCurrent+31]=this.pb_bases_menos
this.Control[iCurrent+32]=this.dw_bases
this.Control[iCurrent+33]=this.dw_pruebas
this.Control[iCurrent+34]=this.dw_reenvio
this.Control[iCurrent+35]=this.dw_trabajo
this.Control[iCurrent+36]=this.cbx_solo_bases
this.Control[iCurrent+37]=this.cbx_solo_base_ticket
this.Control[iCurrent+38]=this.dw_pruebas_color
this.Control[iCurrent+39]=this.cb_2
this.Control[iCurrent+40]=this.cb_3
this.Control[iCurrent+41]=this.pb_4
this.Control[iCurrent+42]=this.dw_aplicaciones
this.Control[iCurrent+43]=this.sle_pruebas
this.Control[iCurrent+44]=this.st_1
this.Control[iCurrent+45]=this.sle_version_color
this.Control[iCurrent+46]=this.st_3
this.Control[iCurrent+47]=this.cbx_pruebas_ok
this.Control[iCurrent+48]=this.dw_imagen
this.Control[iCurrent+49]=this.pb_5
this.Control[iCurrent+50]=this.dw_seleccion
this.Control[iCurrent+51]=this.dw_copiar
this.Control[iCurrent+52]=this.pb_imprimir_etiqueta
this.Control[iCurrent+53]=this.dw_etiqueta_muestras
this.Control[iCurrent+54]=this.st_4
this.Control[iCurrent+55]=this.dw_molde_lineas
this.Control[iCurrent+56]=this.pb_6
this.Control[iCurrent+57]=this.uo_buscar_molde
end on

on wtc_mant_pruebas.destroy
call super::destroy
if IsValid(MenuID) then destroy(MenuID)
destroy(this.pb_borrar_prueba)
destroy(this.pb_duplica_prueba)
destroy(this.pb_anyade_prueba)
destroy(this.pb_borra_aplicacion)
destroy(this.pb_anyade_aplicacion)
destroy(this.st_2)
destroy(this.dw_ficha_comercial)
destroy(this.dw_modelo)
destroy(this.pb_intercala_aplicacion)
destroy(this.dw_modelos_coleccion)
destroy(this.dw_piezas)
destroy(this.pb_1)
destroy(this.p_seleccion)
destroy(this.sle_busqueda)
destroy(this.st_crear_est)
destroy(this.sle_desc_est)
destroy(this.st_desc_est)
destroy(this.cb_crear_est_base)
destroy(this.cb_crear_est)
destroy(this.cb_crear_est_inicio)
destroy(this.pb_2)
destroy(this.cb_1)
destroy(this.st_coste)
destroy(this.dw_ficha_laboratorio)
destroy(this.pb_3)
destroy(this.dw_pantallas)
destroy(this.dw_ticket)
destroy(this.dw_lineas)
destroy(this.dw_stock_base)
destroy(this.pb_bases_mas)
destroy(this.pb_bases_menos)
destroy(this.dw_bases)
destroy(this.dw_pruebas)
destroy(this.dw_reenvio)
destroy(this.dw_trabajo)
destroy(this.cbx_solo_bases)
destroy(this.cbx_solo_base_ticket)
destroy(this.dw_pruebas_color)
destroy(this.cb_2)
destroy(this.cb_3)
destroy(this.pb_4)
destroy(this.dw_aplicaciones)
destroy(this.sle_pruebas)
destroy(this.st_1)
destroy(this.sle_version_color)
destroy(this.st_3)
destroy(this.cbx_pruebas_ok)
destroy(this.dw_imagen)
destroy(this.pb_5)
destroy(this.dw_seleccion)
destroy(this.dw_copiar)
destroy(this.pb_imprimir_etiqueta)
destroy(this.dw_etiqueta_muestras)
destroy(this.st_4)
destroy(this.dw_molde_lineas)
destroy(this.pb_6)
destroy(this.uo_buscar_molde)
end on

event open;str_parametros lstr_param
String modelo, cliente, propuesta, pieza, coleccion

cerrar_sin_abrir = false


////PERMISOS NUEVOS
//String nombre_ventana
//nombre_ventana = this.ClassName()
//SELECT P.permiso INTO :permiso_ventana FROM uti_permisos_ventana P INNER JOIN uti_ventana V ON P.ventana = V.codigo AND P.empresa = V.empresa WHERE P.empresa = :codigo_empresa AND V.nombre = :nombre_ventana AND P.usuario = :nombre_usuario;
//If permiso_ventana = 0 then
//	MESSAGEBOX("Atención. Consulte con el Administrador",nombre_usuario+", No tienes Acceso a este programa")
//	cerrar_sin_abrir = true
//elseif permiso_ventana = 1 then
//	//Solo lectura
//	pb_grabar.visible = false
//	pb_borrar.visible = false
//	cb_crear_est_inicio.visible = false
//	pb_1.visible = false
//elseif permiso_ventana = 2 then
//	//OK acceso total
//	
//else
//	//Opción no contemplada -> Salir
//	MESSAGEBOX("Atención. Consulte con el Administrador",nombre_usuario+", No tienes Acceso a este programa")
//	cerrar_sin_abrir = true
//end if
//
//if cerrar_sin_abrir = true then
//	this.Post Event ue_cerrar_sin_abrir()
//else

	This.Title = "Pruebas Laboratorio"
	
	dw_1.SetTransObject(SQLCA)
	dw_pruebas.SetTransObject(SQLCA)
	dw_modelo.SetTransObject(SQLCA)
	dw_pruebas_color.SetTransObject(SQLCA)
	dw_molde_lineas.SetTransObject(SQLCA)
	
	
	//dw_pruebas.marcar_filas = true
	dw_pruebas.SetRowFocusIndicator(p_seleccion)
	dw_aplicaciones.SetTransObject(SQLCA)
	dw_aplicaciones.SetRowFocusIndicator(p_seleccion)
	dw_modelos_coleccion.SetTransObject(SQLCA)
	dw_piezas.SetTransObject(SQLCA)
	dw_ticket.SetTransObject(SQLCA)
	dw_lineas.SetTransObject(SQLCA)
	dw_pantallas.SetTransObject(SQLCA)
	dw_reenvio.SetTransObject(SQLCA)
	dw_trabajo.SetTransObject(SQLCA)
	
	select nombre
	into :st_titulo.text
	from empresas
	where empresa = :codigo_empresa;
	
	// Si recibo el codigo lo visualizo
	lstr_param = Message.PowerObjectParm
	
	nombre_ventana_invoca = lstr_param.s_titulo_ventana
	IF lstr_param.i_nargumentos >= 1 THEN
		ventana_invoca = lstr_param.nombre_ventana
		if not isnull(lstr_param.s_argumentos[1]) and lstr_param.s_argumentos[1] <> "" then
			padre_codigo = lstr_param.s_argumentos[1]
			if dw_1.retrieve (codigo_empresa, lstr_param.s_argumentos[1]) <> 1 then
				padre_codigo = ""
			else
				modelo = dw_1.object.modelo_pieza_modelo[1]
				cliente = dw_1.object.modelo_pieza_cliente[1]
				propuesta = dw_1.object.modelo_pieza_propuesta[1]
				pieza = dw_1.object.modelo_pieza_codigo[1]
				
				dw_modelo.retrieve (codigo_empresa, modelo, cliente, propuesta)
				coleccion = dw_modelo.object.modelo_coleccion[1]
				dw_pruebas.retrieve (codigo_empresa, modelo, cliente, propuesta, pieza)
				dw_aplicaciones.retrieve (codigo_empresa, modelo, cliente, propuesta, pieza)
				dw_modelos_coleccion.retrieve (codigo_empresa, coleccion)
				dw_piezas.retrieve(codigo_empresa, modelo, cliente, propuesta)
				dw_pantallas.retrieve(codigo_empresa, dw_1.object.modelo_pieza_codigo_lab[1])
				////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
				//p_imagen.PictureName = f_cargar_imagen_nuevo(dw_1.object.modelo_pieza_modelo[1])
				f_cargar_imagen_pieza()
				if dw_pruebas.rowcount() > 0 then
					if not isnull(lstr_param.s_argumentos[2]) and lstr_param.s_argumentos[2] <> "" then
						seleccionar_fila (dw_pruebas,long(lstr_param.s_argumentos[2]),7)
					else
						seleccionar_fila (dw_pruebas,dw_pruebas.rowcount(),7)
					end if
				end if
			end if
		end if
	END IF
	
	if padre_codigo <> "" then
		f_cargar_imagen_pieza()
		estado = 1
	end if
	
	dw_1.SetFocus()
//end if
end event

event activate;call super::activate;wtc_mant_pruebas = ventanas_activas[id_ventana_activa].ventana

if permiso_ventana = 1 then
	//Solo lectura
	pb_grabar.visible = false
	pb_borrar.visible = false
	cb_crear_est_inicio.visible = false
	pb_1.visible = false
end if




end event

type pb_imprimir from wt_ventana_padre`pb_imprimir within wtc_mant_pruebas
integer x = 658
integer y = 104
end type

event pb_imprimir::clicked;string pieza, bases,ls_opciones
string sel, caracter, datos_aux
String modelo, cliente, propuesta, pruebas []
long i, j, posicion, a, b
datastore total_pruebas

if f_guardar() <> 1 then
	return
end if

pieza = dw_1.object.modelo_pieza_codigo_lab[dw_1.getrow()]

if not isnull(pieza) and pieza <> "" then
	dw_ficha_laboratorio.object.p_1.filename = ftc_imagen_ruta("1","","",pieza)	
end if

if OpenWithParm(w_imprimir_trabajos_laboratorio_temp, "Imprimir") = 1 then
	ls_opciones = Message.StringParm
	IF ls_opciones = "" THEN
		//
	ELSE
		dw_ficha_laboratorio.SetTransObject(SQLCA)
		
		modelo = dw_modelo.object.modelo_propuesta_modelo[dw_modelo.getrow()]
		cliente = dw_modelo.object.modelo_propuesta_cliente[dw_modelo.getrow()]
		propuesta = dw_modelo.object.modelo_propuesta_codigo[dw_modelo.getrow()]
		pieza = dw_1.object.modelo_pieza_codigo[dw_1.getrow()]
		
		if ls_opciones = "*" then
			
			sel = " select codigo "+&
					" from modelo_prueba "+&
					" where empresa = '"+codigo_empresa+"'"+&
					" and modelo = '"+modelo+"'"+&
					" and cliente = '"+cliente+"'"+&
					" and propuesta = '"+propuesta+"'"+&
					" and pieza = '"+pieza+"'"
					
			f_cargar_cursor_nuevo(sel, total_pruebas)
			
			for i = 1 to total_pruebas.rowcount() 
				pruebas[i] = total_pruebas.object.codigo[i]
			next
			
			destroy total_pruebas
		else
			posicion = pos (ls_opciones, '-')
			if posicion > 0 then
				a =  long(left(ls_opciones, posicion - 1 ))
				b =  long(right(ls_opciones, len(ls_opciones) - posicion))
				j = 1
				for i = a to b
					pruebas[j] = String(i)
					j ++
				next
			else
				posicion = pos (ls_opciones, ',') 
				i= 1
				do while posicion >0
					posicion = pos (ls_opciones, ',')
					pruebas[i] = String(left(ls_opciones, posicion - 1 ))
					ls_opciones = right(ls_opciones, len(ls_opciones) - posicion)
				
					i ++
				loop
				if ls_opciones <> "" then
					pruebas[i] = ls_opciones
				end if
			end if
		end if
		
		dw_ficha_laboratorio.retrieve(codigo_empresa, modelo, cliente, propuesta, pieza, pruebas)
		f_imprimir_datawindow(dw_ficha_laboratorio)		
	END IF
end if

end event

type p_logo from wt_ventana_padre`p_logo within wtc_mant_pruebas
integer x = 5376
integer y = 8
end type

type dw_1 from wt_ventana_padre`dw_1 within wtc_mant_pruebas
integer x = 37
integer y = 264
integer width = 1440
integer height = 464
integer taborder = 10
string dataobject = "dwtc_pieza_lab"
boolean border = false
boolean livescroll = false
end type

type pb_borrar from wt_ventana_padre`pb_borrar within wtc_mant_pruebas
integer x = 5408
integer y = 112
boolean enabled = false
string disabledname = "C:\Tencer_PB12\Delete_24x24_D.png"
end type

type pb_salir from wt_ventana_padre`pb_salir within wtc_mant_pruebas
integer x = 5728
integer y = 112
string picturename = "C:\Tencer_PB12\Log Out_24x24Gris.png"
end type

type pb_grabar from wt_ventana_padre`pb_grabar within wtc_mant_pruebas
integer x = 503
integer y = 104
end type

type st_titulo from wt_ventana_padre`st_titulo within wtc_mant_pruebas
integer x = 46
integer y = 24
integer width = 1033
integer height = 72
string facename = "Verdana"
long bordercolor = 33554432
end type

type pb_nuevo from wt_ventana_padre`pb_nuevo within wtc_mant_pruebas
integer x = 37
integer y = 100
boolean enabled = false
string disabledname = "C:\Tencer_PB12\New_24x24_D.png"
end type

event pb_nuevo::clicked;call super::clicked;/*
if dw_1.rowcount() > 0 then
	dw_1.SetColumn(1)
end if
dwtc_mant_trabajos_disenyo.reset()
dw_historicomodelo.reset()
dw_con_piezas_coleccion.reset()
p_imagen.PictureName = ''

*/
end event

type pb_cancelar from wt_ventana_padre`pb_cancelar within wtc_mant_pruebas
integer x = 5568
integer y = 112
string picturename = "C:\Tencer_PB12\Undo_24x24Gris.png"
end type

event pb_cancelar::clicked;call super::clicked;if estado = 1 then
	dw_1.retrieve(codigo_empresa, padre_codigo)
	dw_modelo.retrieve (codigo_empresa, dw_1.object.modelo_pieza_modelo[1],dw_1.object.modelo_pieza_cliente[1],dw_1.object.modelo_pieza_propuesta[1])
	dw_pruebas.retrieve (codigo_empresa, dw_1.object.modelo_pieza_modelo[1],dw_1.object.modelo_pieza_cliente[1],dw_1.object.modelo_pieza_propuesta[1],dw_1.object.modelo_pieza_codigo[1])
	dw_modelos_coleccion.retrieve (codigo_empresa, dw_modelo.object.modelo_coleccion[1])
	dw_piezas.retrieve(codigo_empresa, dw_1.object.modelo_pieza_modelo[1],dw_1.object.modelo_pieza_cliente[1],dw_1.object.modelo_pieza_propuesta[1])
	dw_pantallas.retrieve(codigo_empresa, dw_1.object.modelo_pieza_codigo_lab[1])
	f_cargar_imagen_pieza()
end if


end event

type pb_buscar from wt_ventana_padre`pb_buscar within wtc_mant_pruebas
integer x = 192
integer y = 104
end type

event pb_buscar::clicked;string campo
String modelo, cliente, propuesta, pieza, coleccion
Long filas

campo = dw_1.GetColumnName()

padre_busqueda.filtro_es_codigo = true
padre_busqueda.consulta =  " SELECT modelo_pieza.codigo_lab, modelo_pieza.codigo_lab, modelo_pieza.modelo, genter.razon, modelo_pieza.propuesta, formatos.abreviado, modelo_pieza.codigo "+&	
									" FROM modelo_pieza "+&
									" INNER JOIN modelo_propuesta ON modelo_pieza.empresa = modelo_propuesta.empresa AND modelo_pieza.modelo = modelo_propuesta.modelo AND modelo_pieza.cliente = modelo_propuesta.cliente AND modelo_pieza.propuesta = modelo_propuesta.codigo "+&
									" INNER JOIN formatos ON modelo_propuesta.empresa = formatos.empresa AND modelo_propuesta.formato = formatos.codigo "+&
									" INNER JOIN genter ON modelo_pieza.empresa = genter.empresa AND modelo_pieza.cliente = genter.codigo AND genter.tipoter = 'C' "+&
									" WHERE modelo_pieza.empresa = '"+codigo_empresa+"' "+&
									" ORDER BY CONVERT(INTEGER, modelo_pieza.codigo_lab) desc"							
		
		padre_busqueda.titulos[1] = "Pieza"
		padre_busqueda.titulos[2] = "Pieza"
		padre_busqueda.titulos[3] = "Modelo"
		padre_busqueda.titulos[4] = "Cliente"
		padre_busqueda.titulos[5] = "Propuesta"
		padre_busqueda.titulos[6] = "Formato"
		padre_busqueda.titulos[7] = "Código"


call super :: clicked

if padre_codigo <> "" then
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// AQUÍ PONDREMOS TODOS LOS DATAWINDOWS AUXILIARES
	modelo = dw_1.object.modelo_pieza_modelo[1]
	cliente = dw_1.object.modelo_pieza_cliente[1]
	propuesta = dw_1.object.modelo_pieza_propuesta[1]
	pieza = dw_1.object.modelo_pieza_codigo[1]
	
	dw_modelo.retrieve (codigo_empresa, modelo, cliente, propuesta)
	coleccion = dw_modelo.object.modelo_coleccion[1]
	dw_pruebas.retrieve (codigo_empresa, modelo, cliente, propuesta, pieza)
	dw_aplicaciones.retrieve (codigo_empresa, modelo, cliente, propuesta, pieza)
	dw_modelos_coleccion.retrieve (codigo_empresa, coleccion)
	dw_piezas.retrieve(codigo_empresa, modelo, cliente, propuesta)
	
	dw_pantallas.retrieve(codigo_empresa, dw_1.object.modelo_pieza_codigo_lab[1])
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	f_cargar_imagen_pieza()
	filas = dw_pruebas.rowcount()
	if filas > 0 then
		seleccionar_fila (dw_pruebas,filas,7)
	end if
end if
end event

type pb_borrar_prueba from picturebutton within wtc_mant_pruebas
integer x = 206
integer y = 2184
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "C:\Tencer_PB12\navigate_minus.png"
alignment htextalign = left!
string powertiptext = "EliminarRegistro"
end type

event clicked;boolean error_borrando
long fila_actual, fila_maxima, i, total_aplicaciones
String prueba, prueba_apli

if dw_aplicaciones.rowcount() > 0 then
	if MessageBox("Atención","Si borra la prueba eliminará todas las aplicaciones asociadas. ¿Desea continuar?", Question!, YesNo!, 2) = 2 then
		return
	end if
end if
	
error_borrando = false
fila_actual = dw_pruebas.getrow()
fila_maxima = dw_pruebas.rowcount()
if isnull(fila_actual) or fila_actual = 0 then
	MessageBox("Error","Debe seleccionar una fila para borrar")
	return
end if

prueba = dw_pruebas.object.codigo[fila_actual]

if dw_pruebas.DeleteRow(fila_actual) <> 1 then
	error_borrando = True
else
	error_borrando = False

	dw_aplicaciones.setfilter("")
	dw_aplicaciones.filter()
	i = dw_aplicaciones.rowcount()
	Do while i > 0 
		prueba_apli = dw_aplicaciones.object.modelo_aplicacion_prueba[i]
		if prueba_apli = prueba then
			dw_aplicaciones.deleterow(i)
		end if
		i --
	Loop
end if

if error_borrando then
	MessageBox("Error","No ha sido posible borrar la propuesta")
else
	if fila_maxima = fila_actual then
		seleccionar_fila (dw_pruebas,fila_actual - 1,7)
	else
		seleccionar_fila (dw_pruebas,fila_actual,7)
	end if
end if

end event

type pb_duplica_prueba from picturebutton within wtc_mant_pruebas
boolean visible = false
integer x = 357
integer y = 2184
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\duplicar.png"
alignment htextalign = left!
string powertiptext = "Duplicar Registro"
end type

event clicked;long total_filas, fila_antigua, fila_actual, nuevaprueba, indice, maximo_valor_dw, total_aplicaciones, i, fila_destino, contador
string modelo_actual, v_empresa, v_modelo, v_cliente, v_propuesta, v_pieza
String v_serie, v_base, v_tecnico_lab, v_aceptado, v_version

fila_antigua = dw_pruebas.GetRow()

if fila_antigua > 0 then 
	v_empresa = dw_pruebas.object.empresa[fila_antigua]
	v_modelo = dw_pruebas.object.modelo[fila_antigua]
	v_cliente = dw_pruebas.object.cliente[fila_antigua]
	v_propuesta = dw_pruebas.object.propuesta[fila_antigua]
	v_pieza = dw_pruebas.object.pieza[fila_antigua]
	
	v_serie = dw_pruebas.object.serie[fila_antigua]
	//v_base = dw_pruebas.object.base[fila_antigua]
	v_tecnico_lab = dw_pruebas.object.tecnico_lab[fila_antigua]
	//v_version = dw_pruebas.object.modelo_version[fila_antigua]
	
	v_aceptado = 'N'
	
	maximo_valor_dw = long(dw_pruebas.Describe("Evaluate('Max(integer(codigo))', 0)"))
	if isnull(nuevaprueba) then nuevaprueba = 0
	if isnull(maximo_valor_dw) then maximo_valor_dw = 0
	
	if nuevaprueba > maximo_valor_dw then
		nuevaprueba ++
	else
		nuevaprueba = maximo_valor_dw +1
	end if		
	
	//Duplicar aplicaciones
	
	i = 1
	contador = 1
	total_aplicaciones = dw_aplicaciones.rowcount()
	Do While i <= total_aplicaciones 
		if dw_aplicaciones.object.seleccionada[i] = 1 then
			fila_destino = dw_aplicaciones.insertrow(0)
			
			dw_aplicaciones.object.modelo_aplicacion_empresa[fila_destino] = codigo_empresa
			dw_aplicaciones.object.modelo_aplicacion_modelo[fila_destino] = v_modelo
			dw_aplicaciones.object.modelo_aplicacion_cliente[fila_destino] = v_cliente
			dw_aplicaciones.object.modelo_aplicacion_propuesta[fila_destino] = v_propuesta
			dw_aplicaciones.object.modelo_aplicacion_pieza[fila_destino] = v_pieza
			dw_aplicaciones.object.modelo_aplicacion_codigo[fila_destino] = String(contador)
			dw_aplicaciones.object.modelo_aplicacion_prueba[fila_destino] = String(nuevaprueba)
			dw_aplicaciones.object.modelo_aplicacion_orden[fila_destino] = contador
			
			dw_aplicaciones.object.modelo_aplicacion_operacion[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_operacion[i]
			dw_aplicaciones.object.art_ver_tipooperacion_descripcion_abr[fila_destino] = dw_aplicaciones.object.art_ver_tipooperacion_descripcion_abr[i]
			dw_aplicaciones.object.modelo_aplicacion_aplicacion[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_aplicacion[i]
			dw_aplicaciones.object.prodaplicaciones_resumido[fila_destino] = dw_aplicaciones.object.prodaplicaciones_resumido[i]
			
			//Por las versiones de color se debe volver a seleccionar archivos
			dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[fila_destino] = ''
			dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[fila_destino] 	= ''
			dw_aplicaciones.object.archivo_disenyo_codigo[fila_destino] 	= ''
			dw_aplicaciones.object.archivo_disenyo_nombre[fila_destino] 	= ''
			
			dw_aplicaciones.object.modelo_aplicacion_pantallas[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_pantallas[i]			
			dw_aplicaciones.object.modelo_aplicacion_hilos[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_hilos[i]		
			dw_aplicaciones.object.modelo_aplicacion_formula[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_formula[i]		
			dw_aplicaciones.object.prodformula_descripcion_laboratorio[fila_destino] = dw_aplicaciones.object.prodformula_descripcion_laboratorio[i]		
			dw_aplicaciones.object.modelo_aplicacion_observaciones[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_observaciones[i]		
			dw_aplicaciones.object.modelo_aplicacion_paso_cliche[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_paso_cliche[i]		
			dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20[i]		
			dw_aplicaciones.object.modelo_aplicacion_gramaje[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_gramaje[i]		
			dw_aplicaciones.object.modelo_aplicacion_coste[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_coste[i]		
			dw_aplicaciones.object.seleccionada[fila_destino] = 1
			contador ++ 
		end if
		i ++
	loop
	
	
	fila_actual = dw_pruebas.InsertRow(0)
		
	total_filas = dw_pruebas.RowCount()
	
	dw_pruebas.object.empresa[fila_actual] = v_empresa
	dw_pruebas.object.modelo[fila_actual] = v_modelo
	dw_pruebas.object.cliente[fila_actual] = v_cliente
	dw_pruebas.object.propuesta[fila_actual] = v_propuesta
	dw_pruebas.object.pieza[fila_actual] = v_pieza
	dw_pruebas.object.codigo[fila_actual] = String(nuevaprueba)
	dw_pruebas.object.modelo_prueba_fecha_prueba[fila_actual] = Datetime(Today(), Now())
	
	dw_pruebas.object.serie[fila_actual] = v_serie
	dw_pruebas.EVENT itemchanged(fila_actual,dw_pruebas.object.serie, v_serie)
	//dw_pruebas.object.base[fila_actual] = v_base
	//dw_pruebas.EVENT itemchanged(fila_actual,dw_pruebas.object.base, v_base)
	dw_pruebas.object.tecnico_lab[fila_actual] = v_tecnico_lab
	dw_pruebas.EVENT itemchanged(fila_actual,dw_pruebas.object.tecnico_lab, v_tecnico_lab)
	//dw_pruebas.object.modelo_version[fila_actual] = v_version
	//dw_pruebas.EVENT itemchanged(fila_actual,dw_pruebas.object.modelo_version, v_version)
	dw_pruebas.object.aceptado[fila_actual] = v_aceptado
	
	dw_pruebas.scrolltorow(fila_actual)
	dw_pruebas.SetColumn(3)
	dw_pruebas.Setfocus()
	
	
end if	
end event

type pb_anyade_prueba from picturebutton within wtc_mant_pruebas
integer x = 55
integer y = 2184
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_plus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;long fila_actual, nuevo_codigo, indice, maximo_valor_dw
String modelo, cliente, propuesta, pieza
Datetime fecha

nuevo_codigo = 0

dw_1.accepttext()

maximo_valor_dw = long(dw_pruebas.Describe("Evaluate('Max(integer(codigo))', 0)"))
if isnull(maximo_valor_dw) then maximo_valor_dw = 0
nuevo_codigo = maximo_valor_dw +1

fila_actual = dw_pruebas.InsertRow(0)

if fila_actual > 0 then
	dw_pruebas.object.codigo[fila_actual] = String(nuevo_codigo)
	dw_pruebas.object.empresa[fila_actual] = codigo_empresa
	dw_pruebas.object.aceptado[fila_actual] = 'N'
	
	modelo = dw_1.object.modelo_pieza_modelo[1]
	cliente = dw_1.object.modelo_pieza_cliente[1]
	propuesta = dw_1.object.modelo_pieza_propuesta[1]
	pieza = dw_1.object.modelo_pieza_codigo[1]
	dw_pruebas.object.modelo[fila_actual] = modelo
	dw_pruebas.object.cliente[fila_actual] = cliente
	dw_pruebas.object.propuesta[fila_actual] = propuesta
	dw_pruebas.object.pieza[fila_actual] = pieza
	dw_pruebas.object.modelo_prueba_fecha_prueba[fila_actual] = Datetime(Today(), Now())
	
	//Activamos la pieza
	dw_1.object.modelo_pieza_activo[dw_1.getrow()] = 'S'
	
	//Datos del trabajo en la primera prueba
	if dw_pruebas.rowcount() = 1 then
		fecha = dw_1.object.modelo_pieza_fecha_lab[dw_1.getrow()]
		if isnull(fecha) or String(fecha) = "00/00/00" then
			dw_1.object.modelo_pieza_fecha_lab[dw_1.getrow()] = DateTime(today(),now())
		end if
		dw_pruebas.object.serie[fila_actual] = dw_1.object.modelo_trabajo_serie[dw_1.getrow()] 
		dw_pruebas.object.desserie_descripcion[fila_actual] = dw_1.object.desserie_descripcion[dw_1.getrow()] 
		dw_pruebas.object.tecnico_lab[fila_actual] = dw_modelo.object.descoleccionsol_tecnico_lab[dw_1.getrow()] 
		dw_pruebas.object.tecnico_lab_descripcion[fila_actual] = dw_modelo.object.tecnico_lab_descripcion[dw_1.getrow()] 
//		dw_pruebas.object.base[fila_actual] = dw_1.object.modelo_pieza_base[dw_1.getrow()] 
//		dw_pruebas.object.articulos_descripcion[fila_actual] = dw_1.object.articulos_descripcion[dw_1.getrow()] 
//		dw_pruebas.object.articulos_ancho[fila_actual] = dw_1.object.articulos_ancho[dw_1.getrow()] 
//		dw_pruebas.object.articulos_largo[fila_actual] = dw_1.object.articulos_largo[dw_1.getrow()] 
//		dw_pruebas.object.articulos_formato[fila_actual] = dw_1.object.articulos_formato[dw_1.getrow()] 
//		dw_pruebas.object.formatos_abreviado[fila_actual] = dw_1.object.formatos_abreviado[dw_1.getrow()] 
		
	end if
	
	seleccionar_fila (dw_pruebas,fila_actual,7)
end if
end event

type pb_borra_aplicacion from picturebutton within wtc_mant_pruebas
integer x = 210
integer y = 3428
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_minus.png"
alignment htextalign = left!
string powertiptext = "EliminarRegistro"
end type

event clicked;boolean error_borrando
long fila_actual, fila_maxima, i, total_aplicaciones

	
error_borrando = false
fila_actual = dw_aplicaciones.getrow()
fila_maxima = dw_aplicaciones.rowcount()
if isnull(fila_actual) or fila_actual = 0 then
	MessageBox("Error","Debe seleccionar una fila para borrar")
	return
end if

if dw_aplicaciones.DeleteRow(fila_actual) <> 1 then
	error_borrando = True
else
	error_borrando = False
end if

if error_borrando then
	MessageBox("Error","No ha sido posible borrar la propuesta")
else
	if fila_maxima = fila_actual then
		seleccionar_fila (dw_aplicaciones,fila_actual - 1,8)
	else
		seleccionar_fila (dw_aplicaciones,fila_actual,8)
	end if
end if
end event

type pb_anyade_aplicacion from picturebutton within wtc_mant_pruebas
integer x = 59
integer y = 3428
integer width = 146
integer height = 128
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_plus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;long fila_actual, fila, nuevo_codigo, orden, indice, maximo_valor_dw, maximo_valor_dw2
string modelo, cliente, propuesta, pieza, prueba

fila = dw_pruebas.getrow()
if fila > 0 then
	prueba = dw_pruebas.object.codigo[fila]
else
	MessageBox("Error","Debe seleccionar una prueba para añadir aplicaciones.")
	return
end if

if isnull(prueba) or prueba = '' then
	MessageBox("Error","Debe seleccionar una prueba para añadir aplicaciones.")
	return
end if

nuevo_codigo = 0

maximo_valor_dw = long(dw_aplicaciones.Describe("Evaluate('Max(integer(modelo_aplicacion_codigo))', 0)"))
if isnull(maximo_valor_dw) then maximo_valor_dw = 0
nuevo_codigo = maximo_valor_dw +1

maximo_valor_dw2 = long(dw_aplicaciones.Describe("Evaluate('Max(modelo_aplicacion_orden)', 0)"))
if isnull(maximo_valor_dw2) then maximo_valor_dw2 = 0
orden = maximo_valor_dw2 +1

fila_actual = dw_aplicaciones.InsertRow(0)

if fila_actual > 0 then
	dw_aplicaciones.object.modelo_aplicacion_codigo[fila_actual] = String(nuevo_codigo)
	dw_aplicaciones.object.modelo_aplicacion_empresa[fila_actual] = codigo_empresa
	dw_aplicaciones.object.modelo_aplicacion_prueba[fila_actual] = prueba
	dw_aplicaciones.object.modelo_aplicacion_orden[fila_actual] = orden
	dw_aplicaciones.object.seleccionada[fila_actual] = 1
	
	modelo = dw_1.object.modelo_pieza_modelo[1]
	cliente = dw_1.object.modelo_pieza_cliente[1]
	propuesta = dw_1.object.modelo_pieza_propuesta[1]
	pieza = dw_1.object.modelo_pieza_codigo[1]
	dw_aplicaciones.object.modelo_aplicacion_modelo[fila_actual] = modelo
	dw_aplicaciones.object.modelo_aplicacion_cliente[fila_actual] = cliente
	dw_aplicaciones.object.modelo_aplicacion_propuesta[fila_actual] = propuesta
	dw_aplicaciones.object.modelo_aplicacion_pieza[fila_actual] = pieza
	
	seleccionar_fila (dw_aplicaciones,fila_actual,8)
end if
end event

type st_2 from statictext within wtc_mant_pruebas
integer x = 4887
integer y = 736
integer width = 1015
integer height = 72
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 16777215
long backcolor = 24076881
string text = "Imagen"
alignment alignment = center!
boolean focusrectangle = false
end type

type dw_ficha_comercial from datawindow within wtc_mant_pruebas
boolean visible = false
integer x = 3022
integer y = 2320
integer width = 1371
integer height = 624
integer taborder = 90
boolean bringtotop = true
string dataobject = "dw_report_solicitud2"
boolean livescroll = true
end type

type dw_modelo from u_dw within wtc_mant_pruebas
integer x = 2949
integer y = 264
integer width = 2958
integer height = 464
integer taborder = 110
boolean bringtotop = true
string dataobject = "dwtc_modelo_lab2"
boolean livescroll = false
end type

event clicked;call super::clicked;str_parametros lstr_param
long esta_abierta

this.accepttext()

CHOOSE CASE dwo.name
	CASE "p_coleccion"
		esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_coleccion2")
		//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
		if esta_abierta = -1 then
			lstr_param.s_argumentos[1] = this.object.modelo_coleccion[row]
			lstr_param.i_nargumentos = 1
			lstr_param.nombre_ventana = "wtc_mant_pruebas"
			lstr_param.resultado = ''
			Openwithparm(wtc_mant_coleccion2, lstr_param)
		else
			ventanas_activas[esta_abierta].ventana.BringToTop = true
		end if
	CASE "p_modelo"
		esta_abierta = f_menu_ventana_esta_abierta("wtc_trabajos_disenyo_nuevo")
		
		//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
		if esta_abierta = -1 then
			lstr_param.s_argumentos[1] = this.object.modelo_propuesta_modelo[row]
			lstr_param.s_argumentos[2] = this.object.modelo_propuesta_cliente[row]
			lstr_param.s_argumentos[3] = this.object.modelo_propuesta_codigo[row]
			lstr_param.s_argumentos[4] = dw_1.object.modelo_pieza_codigo[row]
			lstr_param.i_nargumentos = 4
			lstr_param.nombre_ventana = "wtc_mant_pruebas"
			lstr_param.resultado = ''
			Openwithparm(wtc_trabajos_disenyo_nuevo, lstr_param)
		else
			ventanas_activas[esta_abierta].ventana.BringToTop = true
		end if
		/*
		lstr_param.s_argumentos[1] = this.object.modelo_propuesta_modelo[row]
		lstr_param.s_argumentos[2] = this.object.modelo_propuesta_cliente[row]
		lstr_param.s_argumentos[3] = this.object.modelo_propuesta_codigo[row]
		lstr_param.s_argumentos[4] = dw_1.object.modelo_pieza_codigo[row]
		lstr_param.i_nargumentos = 4
		lstr_param.nombre_ventana = "wtc_mant_pruebas"
		lstr_param.resultado = ''
		
		//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
		if esta_abierta = -1 then
			Openwithparm(wtc_trabajos_disenyo_nuevo, lstr_param)
		else
			Message.PowerObjectParm = lstr_param
			wtc_trabajos_disenyo_nuevo.triggerevent(open!)
			ventanas_activas[esta_abierta].ventana.BringToTop = true
		end if
		*/
END CHOOSE

end event

event itemchanged;call super::itemchanged;string resultado

this.Accepttext()

CHOOSE CASE dwo.name

	CASE "descoleccionsol_tecnico_lab"
		SELECT tecnico_lab.descripcion 
		INTO :resultado
		FROM tecnico_lab
		WHERE empresa = :codigo_empresa
		and tecnico_lab.codigo = :data 
		and activo = 'S' 
		ORDER BY tecnico_lab.descripcion ;

		if SQLCA.sqlcode <> 100 then
			this.object.tecnico_lab_descripcion[Row] 		= resultado
		else
			dwo.Primary[row] = ''
			this.object.tecnico_lab_descripcion[Row] 		= ''
			return 2
		end if
END CHOOSE

this.accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda

if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "descoleccionsol_tecnico_lab"
			busqueda.titulo_ventana = "Búsqueda de Técnico"
			busqueda.consulta  = "SELECT CODIGO, DESCRIPCION FROM TECNICO_LAB WHERE EMPRESA = '"+codigo_empresa+"' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Técnico"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				dw_modelo.object.descoleccionsol_tecnico_lab[dw_1.GetRow()] = resultado.valores[1]			// Devuelve el valor que encuentra ...
				dw_modelo.object.tecnico_lab_descripcion[dw_1.GetRow()] 	 = resultado.valores[2]			// Devuelve el valor que encuentra ...
			end if		
			
	END CHOOSE
end if
end event

type pb_intercala_aplicacion from picturebutton within wtc_mant_pruebas
integer x = 361
integer y = 3428
integer width = 146
integer height = 128
integer taborder = 140
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\insertar.png"
alignment htextalign = left!
string powertiptext = "Intercalar Registro"
end type

event clicked;long fila_actual, fila_destino, i, fila, nuevo_codigo, orden, indice, maximo_valor_dw, maximo_valor_dw2
string modelo, cliente, propuesta, pieza, prueba

fila = dw_pruebas.getrow()
if fila > 0 then
	prueba = dw_pruebas.object.codigo[fila]
else
	MessageBox("Error","Debe seleccionar una prueba para añadir aplicaciones.")
	return
end if

if isnull(prueba) or prueba = '' then
	MessageBox("Error","Debe seleccionar una prueba para añadir aplicaciones.")
	return
end if

if dw_aplicaciones.rowcount() = 0 then
	pb_anyade_aplicacion.Event clicked()
	return
end if

fila_destino = dw_aplicaciones.getrow()
if fila_destino <= 0 then
	MessageBox("Error","Debe seleccionar una posición donde intercalar la nueva aplicación.")
	return
end if

nuevo_codigo = 0

maximo_valor_dw = long(dw_aplicaciones.Describe("Evaluate('Max(integer(modelo_aplicacion_codigo))', 0)"))
if isnull(maximo_valor_dw) then maximo_valor_dw = 0
nuevo_codigo = maximo_valor_dw +1

modelo = dw_1.object.modelo_pieza_modelo[1]
cliente = dw_1.object.modelo_pieza_cliente[1]
propuesta = dw_1.object.modelo_pieza_propuesta[1]
pieza = dw_1.object.modelo_pieza_codigo[1]

fila_actual = dw_aplicaciones.InsertRow(0)
i = fila_actual
Do While i > fila_destino 
	
	dw_aplicaciones.object.modelo_aplicacion_empresa[i] = codigo_empresa
	dw_aplicaciones.object.modelo_aplicacion_modelo[i] = modelo
	dw_aplicaciones.object.modelo_aplicacion_cliente[i] = cliente
	dw_aplicaciones.object.modelo_aplicacion_propuesta[i] = propuesta
	dw_aplicaciones.object.modelo_aplicacion_pieza[i] = pieza
	dw_aplicaciones.object.modelo_aplicacion_codigo[i] = dw_aplicaciones.object.modelo_aplicacion_codigo[i - 1]
	dw_aplicaciones.object.modelo_aplicacion_prueba[i] = dw_aplicaciones.object.modelo_aplicacion_prueba[i - 1]
	dw_aplicaciones.object.modelo_aplicacion_orden[i] = dw_aplicaciones.object.modelo_aplicacion_orden[i - 1] + 1
	dw_aplicaciones.object.seleccionada[i] = dw_aplicaciones.object.seleccionada[i - 1]
	
	dw_aplicaciones.object.modelo_aplicacion_operacion[i] = dw_aplicaciones.object.modelo_aplicacion_operacion[i - 1]
	dw_aplicaciones.object.art_ver_tipooperacion_descripcion_abr[i] = dw_aplicaciones.object.art_ver_tipooperacion_descripcion_abr[i - 1]
	dw_aplicaciones.object.modelo_aplicacion_aplicacion[i] = dw_aplicaciones.object.modelo_aplicacion_aplicacion[i - 1]
	dw_aplicaciones.object.prodaplicaciones_resumido[i] = dw_aplicaciones.object.prodaplicaciones_resumido[i - 1]
	//dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[i] = dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[i - 1]
	//dw_aplicaciones.object.archivo_disenyo_nombre[i] = dw_aplicaciones.object.archivo_disenyo_nombre[i - 1]
	dw_aplicaciones.object.modelo_aplicacion_pantallas[i] = dw_aplicaciones.object.modelo_aplicacion_pantallas[i - 1]
	dw_aplicaciones.object.modelo_aplicacion_hilos[i] = dw_aplicaciones.object.modelo_aplicacion_hilos[i - 1]		
	dw_aplicaciones.object.modelo_aplicacion_formula[i] = dw_aplicaciones.object.modelo_aplicacion_formula[i - 1]		
	dw_aplicaciones.object.prodformula_descripcion_laboratorio[i] = dw_aplicaciones.object.prodformula_descripcion_laboratorio[i - 1]		
	dw_aplicaciones.object.modelo_aplicacion_observaciones[i] = dw_aplicaciones.object.modelo_aplicacion_observaciones[i - 1]		
	dw_aplicaciones.object.modelo_aplicacion_paso_cliche[i] = dw_aplicaciones.object.modelo_aplicacion_paso_cliche[i - 1]		
	dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20[i] = dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20[i - 1]		
	dw_aplicaciones.object.modelo_aplicacion_gramaje[i] = dw_aplicaciones.object.modelo_aplicacion_gramaje[i - 1]		
	dw_aplicaciones.object.modelo_aplicacion_coste[i] = dw_aplicaciones.object.modelo_aplicacion_coste[i - 1]		
	
	
	dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[i] = dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[i - 1]
	dw_aplicaciones.object.modelo_aplicacion_modelo_archivo_prueba[i] = dw_aplicaciones.object.modelo_aplicacion_modelo_archivo_prueba[i - 1]
	dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[i] = dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[i - 1]
	dw_aplicaciones.object.archivo_disenyo_codigo[i] = dw_aplicaciones.object.archivo_disenyo_codigo[i - 1]
	dw_aplicaciones.object.archivo_disenyo_sistema_archivos_fichero[i] = dw_aplicaciones.object.archivo_disenyo_sistema_archivos_fichero[i - 1]

	i --
loop

dw_aplicaciones.object.modelo_aplicacion_empresa[fila_destino] = codigo_empresa
dw_aplicaciones.object.modelo_aplicacion_modelo[fila_destino] = modelo
dw_aplicaciones.object.modelo_aplicacion_cliente[fila_destino] = cliente
dw_aplicaciones.object.modelo_aplicacion_propuesta[fila_destino] = propuesta
dw_aplicaciones.object.modelo_aplicacion_pieza[fila_destino] = pieza
dw_aplicaciones.object.modelo_aplicacion_codigo[fila_destino] = String(nuevo_codigo)
dw_aplicaciones.object.modelo_aplicacion_prueba[fila_destino] = prueba
dw_aplicaciones.object.modelo_aplicacion_orden[fila_destino] = dw_aplicaciones.object.modelo_aplicacion_orden[fila_destino + 1] - 1
dw_aplicaciones.object.seleccionada[fila_destino] = 1

dw_aplicaciones.object.modelo_aplicacion_operacion[fila_destino] = ""
dw_aplicaciones.object.art_ver_tipooperacion_descripcion_abr[fila_destino] = ""
dw_aplicaciones.object.modelo_aplicacion_aplicacion[fila_destino] = ""
dw_aplicaciones.object.prodaplicaciones_resumido[fila_destino] = ""
//dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[fila_destino] = ""
//dw_aplicaciones.object.archivo_disenyo_nombre[fila_destino] = ""
dw_aplicaciones.object.modelo_aplicacion_pantallas[fila_destino] = ""
dw_aplicaciones.object.modelo_aplicacion_hilos[fila_destino] = ""
dw_aplicaciones.object.modelo_aplicacion_formula[fila_destino] = ""
dw_aplicaciones.object.prodformula_descripcion_laboratorio[fila_destino] = ""
dw_aplicaciones.object.modelo_aplicacion_observaciones[fila_destino] = ""
dw_aplicaciones.object.modelo_aplicacion_paso_cliche[fila_destino] = 0
dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20[fila_destino] = 0
dw_aplicaciones.object.modelo_aplicacion_gramaje[fila_destino] = 0	
dw_aplicaciones.object.modelo_aplicacion_coste[fila_destino] = 0	

dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[fila_destino] = ""
dw_aplicaciones.object.modelo_aplicacion_modelo_archivo_prueba[fila_destino] = ""
dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[fila_destino] = ""
dw_aplicaciones.object.archivo_disenyo_codigo[fila_destino] = ""
dw_aplicaciones.object.archivo_disenyo_sistema_archivos_fichero[fila_destino] = ""

seleccionar_fila (dw_aplicaciones,fila_destino,8)
end event

type dw_modelos_coleccion from u_dw within wtc_mant_pruebas
integer x = 4878
integer y = 1548
integer width = 1024
integer height = 784
integer taborder = 120
boolean bringtotop = true
string dataobject = "dwtc_coleccion_modelos_lab"
boolean vscrollbar = true
end type

event clicked;call super::clicked;str_parametros lstr_param 
Long esta_abierta

if row > 0 then
	if dwo.name = "p_modelo" then
		
		lstr_param.s_argumentos[1] = this.object.modelo_modelo[row]
		lstr_param.i_nargumentos = 1
		lstr_param.nombre_ventana = "wtc_mant_pruebas"
		lstr_param.resultado = ''
		
		esta_abierta = f_menu_ventana_esta_abierta("wtc_trabajos_disenyo_nuevo")
		if esta_abierta <> -1 then
			close(wtc_trabajos_disenyo_nuevo)
			OpenWithParm(wtc_trabajos_disenyo_nuevo,lstr_param)
		else
			OpenWithParm(wtc_trabajos_disenyo_nuevo,lstr_param)
		end if
		
	end if
end if
end event

type dw_piezas from u_dw within wtc_mant_pruebas
integer x = 4878
integer y = 2336
integer width = 1033
integer height = 1240
integer taborder = 150
boolean bringtotop = true
string dataobject = "dwtc_modelo_pieza_lab"
boolean vscrollbar = true
end type

event clicked;call super::clicked;str_parametros lstr_param 

if row > 0 then
	if dwo.name = "p_pieza" then
		padre_codigo = this.object.codigo_lab[row]	
		
		lstr_param.s_argumentos[1] = padre_codigo
		lstr_param.i_nargumentos = 1
		lstr_param.nombre_ventana = "wtc_mant_pruebas"
		lstr_param.resultado = ''
		
		if hay_cambios() = true then
			if MessageBox("Atención", "¿Desea grabar las modificaciones?", Exclamation!, YesNo!, 2) = 1 then
				if f_guardar() <> 1 then
					return 1 //Fallo de validación en la grabación, no cambiar de pieza
				end if
			end if
		end if
		
		Message.PowerObjectParm = lstr_param
		Parent.triggerevent(open!)
	end if
end if
end event

type pb_1 from picturebutton within wtc_mant_pruebas
integer x = 814
integer y = 104
integer width = 146
integer height = 128
integer taborder = 160
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "C:\Tencer_PB12\tables.png"
string powertiptext = "Almacén de Pantallas"
end type

event clicked;str_parametros lstr_param
OpenWithParm(w_mant_almacen_laboratorio, lstr_param)
end event

type p_seleccion from picture within wtc_mant_pruebas
boolean visible = false
integer x = 1001
integer y = 144
integer width = 73
integer height = 64
boolean bringtotop = true
boolean originalsize = true
string picturename = "C:\Tencer_PB12\fila_seleccionada.png"
boolean focusrectangle = false
end type

type sle_busqueda from singlelineedit within wtc_mant_pruebas
event key pbm_keydown
boolean visible = false
integer x = 2258
integer y = 20
integer width = 279
integer height = 88
integer taborder = 30
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
borderstyle borderstyle = stylelowered!
end type

event key;String consulta_busqueda
str_wt_busquedas_entrada busqueda
str_wt_busquedas_salida resultado
Int numero_valores

consulta_busqueda =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE articulos.empresa = '"+codigo_empresa+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"


busqueda.consulta = consulta_busqueda
busqueda.titulos[1] = "Código"
busqueda.titulos[2] = "Descripción"
busqueda.titulos[3] = "Formato"
busqueda.titulos[4] = "Uso"
busqueda.titulos[5] = "Cliente"

IF not isnull(this.text) and this.text <> "" THEN
	busqueda.filtro = this.text
	if Long(this.text) = 0 then
		//Es texto
		//busqueda.filtro = this.text
		busqueda.filtro_es_codigo = false
	else
		//Es código
		busqueda.filtro_es_codigo = true
	end if
END IF

IF KeyDown(KeyEnter!) OR (not isnull(Message.LongParm) and Message.LongParm = 1001) THEN  
	OpenWithParm(wt_busquedas, busqueda)
	resultado = Message.PowerObjectParm
	if resultado.resultado = -1 then
		MessageBox("Error en la creación de la búsqueda",resultado.error)
	elseif resultado.resultado > 0 then
		this.text = resultado.valores[1]
		sle_desc_est.text = resultado.valores[2]
	end if
END IF

end event

event losefocus;/*
Long es_texto

if isnull(this.text) or trim(this.text) = "" then
	es_texto = 1
else
	es_texto = Long(this.text)
end if

if es_texto = 0 then
	IF KeyDown(KeyTab!) THEN
		this.triggerevent("key",0,1001)
	END IF
end if
*/

IF KeyDown(KeyTab!) THEN
	this.triggerevent("key",0,1001)
END IF
end event

type st_crear_est from statictext within wtc_mant_pruebas
boolean visible = false
integer x = 1970
integer y = 28
integer width = 283
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 553648127
string text = "Código fin:"
alignment alignment = center!
boolean focusrectangle = false
end type

type sle_desc_est from singlelineedit within wtc_mant_pruebas
boolean visible = false
integer x = 2939
integer y = 20
integer width = 1161
integer height = 84
integer taborder = 50
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 33554432
textcase textcase = upper!
integer limit = 40
borderstyle borderstyle = stylelowered!
end type

type st_desc_est from statictext within wtc_mant_pruebas
boolean visible = false
integer x = 2551
integer y = 32
integer width = 379
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 553648127
string text = "Nueva desc.:"
alignment alignment = center!
boolean focusrectangle = false
end type

type cb_crear_est_base from commandbutton within wtc_mant_pruebas
boolean visible = false
integer x = 2551
integer y = 120
integer width = 937
integer height = 92
integer taborder = 60
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
string text = "Crear estructura (incluyendo base)"
end type

event clicked;
Int resultado, contestacion
String mensaje
str_parametros lstr_param
lstr_param.s_argumentos[2] = sle_busqueda.text
lstr_param.i_nargumentos = 2

resultado = f_crear_estructura(true, mensaje)

if resultado = -1 then
	MessageBox("Error al Crear Estructura (incluyendo base)", mensaje)
else
	contestacion = MessageBox("Crear Estructura (incluyendo base)", mensaje,Question!,YesNo!)
	cb_crear_est_inicio.triggerEvent(Clicked!)
	if contestacion = 1 then
		if f_menu_ventana_esta_abierta("w_mant_altas_intermedios_nuevo") <> -1 then
			close(w_mant_altas_intermedios_nuevo)
		end if
		OpenWithParm(w_mant_altas_intermedios_nuevo, lstr_param)
	end if
end if


end event

type cb_crear_est from commandbutton within wtc_mant_pruebas
boolean visible = false
integer x = 3502
integer y = 120
integer width = 603
integer height = 92
integer taborder = 80
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
string text = "Crear estructura"
end type

event clicked;Int resultado, contestacion
String mensaje
str_parametros lstr_param
lstr_param.s_argumentos[2] = sle_busqueda.text
lstr_param.i_nargumentos = 2

resultado = f_crear_estructura(false, mensaje)

if resultado = -1 then
	MessageBox("Error al Crear Estructura", mensaje)
else
	contestacion = MessageBox("Crear Estructura", mensaje,Question!,YesNo!)
	cb_crear_est_inicio.triggerEvent(Clicked!)
	if contestacion = 1 then
		if f_menu_ventana_esta_abierta("w_mant_altas_intermedios_nuevo") <> -1 then
			close(w_mant_altas_intermedios_nuevo)
		end if
		OpenWithParm(w_mant_altas_intermedios_nuevo, lstr_param)
	end if
end if

end event

type cb_crear_est_inicio from commandbutton within wtc_mant_pruebas
integer x = 1157
integer y = 8
integer width = 750
integer height = 92
integer taborder = 40
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Iniciar Crear estructura"
end type

event clicked;
if cb_crear_est_inicio.text = "Iniciar Crear estructura" then
	
	if dw_1.object.modelo_pieza_codigo_lab[dw_1.getrow()] = "" then
		MessageBox("Error al crear estructura", "Primero debe indicar la pieza a partir de la cual se generará la estructura.")
		return
	end if
	
	sle_busqueda.visible=true
	cb_crear_est_base.visible=true
	cb_crear_est.visible=true
	st_crear_est.visible=true
	sle_desc_est.visible=true
	st_desc_est.visible=true
	
	cb_crear_est_inicio.text = "Cancelar Crear estructura"
	
	sle_busqueda.setfocus()
	
else
	sle_busqueda.visible=false
	sle_busqueda.text=""
	cb_crear_est_base.visible=false
	cb_crear_est.visible=false
	st_crear_est.visible=false
	sle_desc_est.visible=false
	sle_desc_est.text=""
	st_desc_est.visible=false
	
	cb_crear_est_inicio.text = "Iniciar Crear estructura"
end if

end event

type pb_2 from picturebutton within wtc_mant_pruebas
integer x = 512
integer y = 3428
integer width = 146
integer height = 128
integer taborder = 200
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\duplicar.png"
alignment htextalign = left!
string powertiptext = "Duplicar Registro"
end type

event clicked;long total_filas, fila_antigua, fila_actual, nueva, orden, maximo_valor_dw, fila_destino
string modelo_actual, v_empresa, v_modelo, v_cliente, v_propuesta, v_pieza, v_prueba
String v_operacion, v_aplicacion, v_modelo_archivo

fila_antigua = dw_aplicaciones.GetRow()

if fila_antigua > 0 then 
	v_empresa = dw_aplicaciones.object.modelo_aplicacion_empresa[fila_antigua]
	v_modelo = dw_aplicaciones.object.modelo_aplicacion_modelo[fila_antigua]
	v_cliente = dw_aplicaciones.object.modelo_aplicacion_cliente[fila_antigua]
	v_propuesta = dw_aplicaciones.object.modelo_aplicacion_propuesta[fila_antigua]
	v_pieza = dw_aplicaciones.object.modelo_aplicacion_pieza[fila_antigua]
	v_prueba = dw_aplicaciones.object.modelo_aplicacion_prueba[fila_antigua]
	
	v_operacion = dw_aplicaciones.object.modelo_aplicacion_operacion[fila_antigua]
	v_aplicacion = dw_aplicaciones.object.modelo_aplicacion_aplicacion[fila_antigua]
	v_modelo_archivo = mid(dw_aplicaciones.object.archivo_disenyo_sistema_archivos_fichero[fila_antigua], 1, pos(dw_aplicaciones.object.archivo_disenyo_sistema_archivos_fichero[fila_antigua],".") - 1)
	
	maximo_valor_dw = 0
	maximo_valor_dw = long(dw_aplicaciones.Describe("Evaluate('Max(integer(modelo_aplicacion_codigo))', 0)"))
	if isnull(nueva) then nueva = 0
	if isnull(maximo_valor_dw) then maximo_valor_dw = 0
	
	if nueva > maximo_valor_dw then
		nueva ++
	else
		nueva = maximo_valor_dw +1
	end if	
	
	//ORDEN
	maximo_valor_dw = 0
	maximo_valor_dw = long(dw_aplicaciones.Describe("Evaluate('Max(modelo_aplicacion_orden)', 0)"))
	if isnull(orden) then orden = 0
	if isnull(maximo_valor_dw) then maximo_valor_dw = 0
	
	if orden > maximo_valor_dw then
		orden ++
	else
		orden = maximo_valor_dw +1
	end if			
	
	fila_actual = dw_aplicaciones.InsertRow(0)
		
	total_filas = dw_aplicaciones.RowCount()
	
	dw_aplicaciones.object.modelo_aplicacion_empresa[fila_actual] = v_empresa
	dw_aplicaciones.object.modelo_aplicacion_modelo[fila_actual] = v_modelo
	dw_aplicaciones.object.modelo_aplicacion_cliente[fila_actual] = v_cliente
	dw_aplicaciones.object.modelo_aplicacion_propuesta[fila_actual] = v_propuesta
	dw_aplicaciones.object.modelo_aplicacion_pieza[fila_actual] = v_pieza
	dw_aplicaciones.object.modelo_aplicacion_prueba[fila_actual] = v_prueba
	dw_aplicaciones.object.modelo_aplicacion_codigo[fila_actual] = String(nueva)
	dw_aplicaciones.object.modelo_aplicacion_orden[fila_actual] = orden
	dw_aplicaciones.object.seleccionada[fila_actual] = 1
	
	dw_aplicaciones.object.modelo_aplicacion_operacion[fila_actual] = v_operacion
	dw_aplicaciones.EVENT itemchanged(fila_actual,dw_aplicaciones.object.modelo_aplicacion_operacion, v_operacion)
	dw_aplicaciones.object.modelo_aplicacion_aplicacion[fila_actual] = v_aplicacion
	dw_aplicaciones.EVENT itemchanged(fila_actual,dw_aplicaciones.object.modelo_aplicacion_aplicacion, v_aplicacion)
	dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[fila_actual] = v_modelo_archivo
	dw_aplicaciones.EVENT itemchanged(fila_actual,dw_aplicaciones.object.modelo_aplicacion_modelo_archivo, v_modelo_archivo)
	
	dw_aplicaciones.scrolltorow(fila_actual)
	dw_aplicaciones.SetColumn(3)
	dw_aplicaciones.Setfocus()
	
end if	
end event

type cb_1 from commandbutton within wtc_mant_pruebas
integer x = 1157
integer y = 128
integer width = 750
integer height = 88
integer taborder = 310
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Cálculo del Coste"
end type

event clicked;dec ancho, largo, coste, gramaje, gram_cm2, coste_aplicacion, paso, hilos
long i
string  formula

dw_aplicaciones.accepttext()

ancho = dw_pruebas.object.articulos_ancho[dw_pruebas.getrow()]
largo = dw_pruebas.object.articulos_largo[dw_pruebas.getrow()]

for i = 1 to dw_aplicaciones.rowcount()
	formula = dw_aplicaciones.object.modelo_aplicacion_formula[i]
	paso = dw_aplicaciones.object.modelo_aplicacion_paso_cliche[i]
	hilos = dec(dw_aplicaciones.object.modelo_aplicacion_hilos[i])
	
	select gram_cm2
	into :gram_cm2
	from prodhilosgramaje
	where prodhilosgramaje.empresa = :codigo_empresa
	and prodhilosgramaje.hilos = :hilos;

		
	if isnull (dw_aplicaciones.object.modelo_aplicacion_gramaje[i]) or dw_aplicaciones.object.modelo_aplicacion_gramaje[i] = 0 then
		gramaje = ((255 - long(paso)) / 255 ) *  ancho * largo * gram_cm2
	else 
		gramaje = dw_aplicaciones.object.modelo_aplicacion_gramaje[i]
	end if
	
	select sum (coste_kg_formula * :gramaje ) 
	into :coste_aplicacion
	from prodformula
	where prodformula.empresa = :codigo_empresa
	and prodformula.formula = :formula;

	if gramaje <> 0 or paso <> 0 then
		dw_aplicaciones.object.modelo_aplicacion_coste[i] = coste_aplicacion
		dw_aplicaciones.object.modelo_aplicacion_gramaje[i] = gramaje
	end if
next

st_coste.text = string(round (dw_aplicaciones.object.total_coste[1], 2))
end event

type st_coste from statictext within wtc_mant_pruebas
integer x = 1989
integer y = 128
integer width = 320
integer height = 80
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
string text = "0"
alignment alignment = right!
boolean border = true
long bordercolor = 16777215
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type dw_ficha_laboratorio from datawindow within wtc_mant_pruebas
boolean visible = false
integer x = 960
integer y = 1556
integer width = 1015
integer height = 568
integer taborder = 300
boolean bringtotop = true
string dataobject = "dw_report_pruebas"
boolean livescroll = true
end type

type pb_3 from picturebutton within wtc_mant_pruebas
integer x = 347
integer y = 104
integer width = 146
integer height = 128
integer taborder = 320
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\index_view.png"
alignment htextalign = right!
string powertiptext = "Búsqueda por Archivos de Pieza"
end type

event clicked;string campo
String modelo, cliente, propuesta, pieza, coleccion
long numero_valores
str_wt_busquedas_salida resultado_busqueda
integer columna

campo = dw_1.GetColumnName()

padre_busqueda.filtro_es_codigo = false
//padre_busqueda.filtro_es_codigo = true
/*
padre_busqueda.consulta =  " SELECT DISTINCT modelo_pieza.codigo_lab, archivo_disenyo.nombre "+&	
									" FROM modelo_pieza "+&	
									" LEFT OUTER JOIN modelo_aplicacion ON modelo_pieza.empresa = modelo_aplicacion.empresa AND modelo_pieza.modelo = modelo_aplicacion.modelo AND modelo_pieza.cliente = modelo_aplicacion.cliente AND modelo_pieza.propuesta = modelo_aplicacion.propuesta AND modelo_pieza.codigo = modelo_aplicacion.pieza  "+&
									" LEFT OUTER JOIN modelo_archivo ON modelo_aplicacion.empresa = modelo_archivo.empresa AND modelo_aplicacion.modelo = modelo_archivo.modelo AND modelo_aplicacion.cliente = modelo_archivo.cliente AND modelo_aplicacion.propuesta = modelo_archivo.propuesta AND modelo_aplicacion.pieza = modelo_archivo.pieza AND modelo_aplicacion.modelo_archivo = modelo_archivo.codigo "+&
									" LEFT OUTER JOIN archivo_disenyo ON modelo_archivo.empresa = archivo_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo.codigo "+&
									" LEFT OUTER JOIN modelo_propuesta ON modelo_pieza.empresa = modelo_propuesta.empresa AND modelo_pieza.modelo = modelo_propuesta.modelo AND modelo_pieza.cliente = modelo_propuesta.cliente AND modelo_pieza.propuesta = modelo_propuesta.codigo "+&
									" LEFT OUTER JOIN formatos ON modelo_propuesta.empresa = formatos.empresa AND modelo_propuesta.formato = formatos.codigo "+&
									" LEFT OUTER JOIN genter ON modelo_pieza.empresa = genter.empresa AND modelo_pieza.cliente = genter.codigo AND genter.tipoter = 'C' "+&
									" WHERE modelo_pieza.empresa = '"+codigo_empresa+"' AND archivo_disenyo IS NOT NULL "+&
									" ORDER BY modelo_pieza.codigo_lab desc"		
*/
padre_busqueda.consulta =  " SELECT DISTINCT modelo_pieza.codigo_lab, archivo_disenyo.nombre, CONVERT(integer, modelo_pieza.codigo_lab) AS orden "+&
									" FROM modelo "+&
									" LEFT OUTER JOIN modelo_archivo ON modelo.empresa = modelo_archivo.empresa AND modelo.modelo = modelo_archivo.modelo "+&
									" LEFT OUTER JOIN modelo_pieza ON modelo_archivo.empresa = modelo_pieza.empresa AND modelo_archivo.modelo = modelo_pieza.modelo AND modelo_archivo.cliente = modelo_pieza.cliente AND modelo_archivo.propuesta = modelo_pieza.propuesta AND modelo_archivo.pieza = modelo_pieza.codigo "+&
									" LEFT OUTER JOIN archivo_disenyo ON modelo_archivo.empresa = archivo_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo.codigo "+&
									" WHERE modelo.empresa = '"+codigo_empresa+"' AND archivo_disenyo IS NOT NULL "+&
									" ORDER BY orden desc  "								
		
padre_busqueda.titulos[1] = "Pieza"
padre_busqueda.titulos[2] = "Archivo Diseño"
padre_busqueda.titulos[3] = "Pieza"

if hay_cambios() = true then
	if MessageBox("Atención", "¿Desea grabar las modificaciones?", Exclamation!, YesNo!, 2) = 1 then
		if f_guardar() <> 1 then
			return //Fallo de validación en la grabación, no buscar
		end if
	end if
end if

columna = dw_1.GetColumn()
OpenWithParm(wt_busquedas, padre_busqueda)
resultado_busqueda = Message.PowerObjectParm		// Devuelve el valor que encuentra ...
if resultado_busqueda.error = '' then
	numero_valores = UpperBound(resultado_busqueda.valores)
	if not isnull(numero_valores) and numero_valores >= 1 then
		dw_1.retrieve (codigo_empresa, resultado_busqueda.valores[1])
		padre_codigo = dw_1.object.#1[1]
		estado = 1 // Modo edición
	else
		padre_codigo = ""
		if dw_1.rowcount() > 0 then
			if dw_1.getrow() > 0 and dw_1.object.#1[dw_1.getrow()] <> "" then
				padre_codigo = dw_1.object.#1[dw_1.getrow()]
			end if
		end if
	end if
else
	messagebox("Error", resultado_busqueda.error )
end if

mostrar_controles_edicion()

dw_1.setfocus()
if dw_1.rowcount() > 0 then
	dw_1.SetColumn(columna)
end if

if padre_codigo <> "" then
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// AQUÍ PONDREMOS TODOS LOS DATAWINDOWS AUXILIARES
	modelo = dw_1.object.modelo_pieza_modelo[1]
	cliente = dw_1.object.modelo_pieza_cliente[1]
	propuesta = dw_1.object.modelo_pieza_propuesta[1]
	pieza = dw_1.object.modelo_pieza_codigo[1]
	
	dw_modelo.retrieve (codigo_empresa, modelo, cliente, propuesta)
	coleccion = dw_modelo.object.modelo_coleccion[1]
	dw_pruebas.retrieve (codigo_empresa, modelo, cliente, propuesta, pieza)
	dw_aplicaciones.retrieve (codigo_empresa, modelo, cliente, propuesta, pieza)
	dw_modelos_coleccion.retrieve (codigo_empresa, coleccion)
	dw_piezas.retrieve(codigo_empresa, modelo, cliente, propuesta)
	
	dw_pantallas.retrieve(codigo_empresa, dw_1.object.modelo_pieza_codigo_lab[1])
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	f_cargar_imagen_pieza()
	if dw_pruebas.rowcount() > 0 then
		seleccionar_fila (dw_pruebas,1,7)
	end if
end if
end event

type dw_pantallas from datawindow within wtc_mant_pruebas
integer x = 4128
integer width = 777
integer height = 260
integer taborder = 70
boolean bringtotop = true
string title = "none"
string dataobject = "dw_pantallas_pieza"
boolean vscrollbar = true
boolean border = false
boolean livescroll = true
end type

type dw_ticket from u_dw within wtc_mant_pruebas
boolean visible = false
integer x = 4521
integer y = 1556
integer width = 1262
integer height = 2028
integer taborder = 240
boolean bringtotop = true
string dataobject = "dwtc_mant_modelo_pieza_ticket"
boolean border = true
borderstyle borderstyle = styleraised!
end type

event clicked;call super::clicked;string RUTA_INK-04 = "\\Amazonas\hotfolders\INK-04\EFECTOS\"
string operacion

String archivo, codigo_ticket, pieza, tipo_maquina, archivo_disenyo, archivo_disenyo_sufijo, archivo_disenyo_prueba, prueba
String tecnico, esmalte, base, pantallas, urgente, modo_impresion, observaciones, maquina, ruta_maquina, ruta_archivo, nombre_archivo, resolucion_maquina, perfil_color, gestion_color
Dec cantidad, stock
Datetime fecha
Long numero_maquinas, i, respuesta, res = 1
str_colisiones pcolisiones_ticket
Boolean todas, borrado
str_ventana_alerta parametros
string botones[3]
Boolean ver_stock = false			

this.accepttext()

CHOOSE CASE dwo.name
	CASE "b_enviar"
//		pieza = dw_1.object.modelo_pieza_codigo_lab[dw_1.getrow()]
		pieza = dw_1.object.modelo_pieza_codigo_lab[1]
		/*
		//Ya comprobado en el botón de ticket
		archivo = dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[dw_aplicaciones.getrow()]
		if isnull(archivo) or archivo = "" then
			MessageBox("Error","Debe indicar el fichero a enviar.")
			return
		end if
		archivo_disenyo_sufijo = dw_aplicaciones.object.modelo_aplicacion_pantallas[dw_aplicaciones.getrow()]
		tipo_maquina = dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[dw_aplicaciones.getrow()]
		archivo_disenyo = dw_aplicaciones.object.archivo_disenyo_codigo[dw_aplicaciones.getrow()]
		*/
		prueba = dw_pruebas.object.codigo[dw_pruebas.getrow()]
		cantidad = this.object.cantidad[1]
		if isnull(cantidad) or cantidad = 0 then
			MessageBox("Error","Debe indicar la cantidad.")
			return
		end if
		tecnico = dw_pruebas.object.tecnico_lab[dw_pruebas.getrow()]
		esmalte = this.object.esmalte[1]
		if dw_ticket.object.tipo_maquina[1] <> "2" and dw_ticket.object.tipo_maquina[1] <> "5"  and isnull(esmalte) or esmalte = "" then //En kerajet el esmalte no se pone
			MessageBox("Error","Debe indicar el esmalte.")
			return
		end if
		base = this.object.base[1]
		pantallas = this.object.pantallas[1]
		if isnull(pantallas) or pantallas = "" then
			MessageBox("Error","Debe indicar si se usan pantallas.")
			return
		end if
		urgente = this.object.urgente[1]
		if isnull(urgente) or urgente = "" then
			MessageBox("Error","Debe indicar si es urgente.")
			return
		end if
		modo_impresion = this.object.modo_impresion[1]
		if isnull(modo_impresion) or modo_impresion = "" then
			MessageBox("Error","Debe indicar el modo de impresión.")
			return
		end if
		numero_maquinas = 0
		for i = 1 To dw_lineas.rowcount()
			if dw_lineas.object.seleccionado[i] = 1 then
				numero_maquinas++
			end if
		next	
		if numero_maquinas <= 0 then
			MessageBox("Error","Debe seleccionar al menos una máquina de envío.")
			return
		end if
		fecha = datetime(today(),time(0))
		
		stock = 0
		//select sum(existencias) INTO :stock from almlinubica where empresa = :codigo_empresa and articulo = :base and almacen = '4';
		select sum(cantidade - cantidads) INTO :stock from almacenmovimientos where empresa = :codigo_empresa and articulo = :base and almacen = '4' using trans_ts;
		if isnull(stock) or stock < cantidad then
			if isnull(stock) then
				stock = 0
			end if
			parametros.titulo = "Stock Insuficiente"
			parametros.subtitulo = "El stock es "+ String(stock)
			parametros.mensaje = "¿Desea enviar el ticket?"
			parametros.tipo = 3
			botones[1] = "Enviar"
			botones[2] = "Cancelar"
			botones[3] = "Ver Stock"
			parametros.botones = botones
			parametros.mostrar_imagen = true
			openwithparm(wtc_ventana_alerta, parametros)
			respuesta = Long(Message.DoubleParm)
			if respuesta = 1 then
				
			elseif respuesta = 2 then 
				dw_lineas.visible = false
				dw_ticket.visible = false
				dw_stock_base.visible = false
				return
			elseif respuesta = 3 then 
				dw_stock_base.SetTransObject(SQLCA)
				dw_stock_base.retrieve(codigo_empresa, base)
				dw_stock_base.visible = true
				return
			end if
		else
			//Hay stock, pero hay que avisar si no está en I
			select sum(cantidade - cantidads) INTO :stock from almacenmovimientos where empresa = :codigo_empresa and articulo = :base and almacen = '4' and zona = 'I' using trans_ts;
			if isnull(stock) or stock < cantidad then
				MessageBox("ATENCIÓN", "HAY STOCK, PERO HAY QUE MOVERLO AL ALMACEN DE LA INK.")
				ver_stock = true
			end if
		end if
		
		
		pcolisiones_ticket.empresa = codigo_empresa
		pcolisiones_ticket.tabla = "modelo_pieza_ticket"
		pcolisiones_ticket.campo = "codigo"
		pcolisiones_ticket.filtro = ""
		pcolisiones_ticket.buscar_huecos = false
		codigo_ticket = f_colisiones (trans_ts, pcolisiones_ticket)
		if not isnull(codigo_ticket) and codigo_ticket <> "" then
			
			dw_ticket.object.empresa[1] = codigo_empresa
			dw_ticket.object.codigo[1] = codigo_ticket
			dw_ticket.object.pieza[1] = pieza
			dw_ticket.object.prueba[1] = prueba
			dw_ticket.object.tecnico[1] = tecnico
			//dw_ticket.object.base[1] = base
			dw_ticket.object.fecha[1] = fecha
			
			// Borramos las líneas desmarcadas de dw_lineas.			
			dw_lineas.Setfilter ("seleccionado = 0")
			dw_lineas.filter()
			do while dw_lineas.rowcount() > 0
				dw_lineas.deleterow(0)
			loop	
			dw_lineas.Setfilter ("seleccionado = 1")
			dw_lineas.filter()
			
			for i = 1 To dw_lineas.rowcount()
				dw_lineas.object.modelo_pieza_ticket_prodlineas_modelo_pieza_ticket[i] = codigo_ticket
			next		
			
			//Ya escrito en el botón de ticket
			//dw_ticket.object.tipo_maquina[1] = tipo_maquina
			//dw_ticket.object.archivo_disenyo[1] = archivo_disenyo
			//dw_ticket.object.modelo_pieza_ticket_archivo_disenyo_sufijo[1] = archivo_disenyo_sufijo
			
			//PREPARACIÓN ENVÍO A LA MÁQUINA
			//maquina = dw_ticket.object.modelo_pieza_ticket_prodlineas_codigo[1]
			tipo_maquina = dw_ticket.object.tipo_maquina[1]
			archivo_disenyo = dw_ticket.object.archivo_disenyo[1]
			archivo_disenyo_prueba = dw_ticket.object.modelo_pieza_ticket_archivo_disenyo_prueba[1]
			SELECT REPLACE((SELECT ruta_archivos_disenyo FROM empresas WHERE empresa = :codigo_empresa) + REPLACE(ruta,(SELECT ruta_archivos_disenyo FROM empresas WHERE empresa = :codigo_empresa),'') + fichero,' ', ''), fichero 
			INTO :ruta_archivo, :nombre_archivo FROM archivo_disenyo_sistema_archivos 
			WHERE empresa = :codigo_empresa AND tipomaquina_disenyo = :tipo_maquina AND archivo = :archivo_disenyo AND codigo = :archivo_disenyo_prueba using trans_ts;
			if isnull(ruta_archivo) or ruta_archivo = "" then
				MessageBox("Error","No se encuentra la ruta del archivo.")
				res = -1
			end if
			
			//UPDATE
			if res = 1 then
				dw_ticket.SetTransObject(trans_ts)
				res = dw_ticket.update()
				if res <> 1 then
					messagebox("Error 1", "Error actualizando dw_ticket")
				end if
			end if
			
			if res = 1 then
				dw_lineas.SetTransObject(trans_ts)
				res = dw_lineas.update()
				if res <> 1 then
					messagebox("Error 2", "Error actualizando dw_lineas")
				end if
				
			end if
			if res <> 1 then res = -1;
			
			//ENVÍO A MAQUINA
			if res = 1 then
				for i = 1 To dw_lineas.rowcount()
					ruta_maquina = ""
					resolucion_maquina = ""
					maquina = dw_lineas.object.modelo_pieza_ticket_prodlineas_prodlinea[i]
					perfil_color = dw_ticket.object.modelo_pieza_ticket_perfil_color[dw_ticket.getrow()]
					SELECT gestion_color INTO :gestion_color FROM tipomaquina_disenyo WHERE empresa = :codigo_empresa AND codigo = :tipo_maquina using trans_ts;
					if gestion_color = "1" then
						SELECT carpeta INTO :ruta_maquina 
						FROM prodlineas_perfil_color 
						WHERE empresa = :codigo_empresa 
						AND prodlineas = :maquina 
						AND perfil_color = :perfil_color 
						and activo = 1
						using trans_ts;
					else
						SELECT ruta_pruebas_lab, resolucion INTO :ruta_maquina, :resolucion_maquina FROM prodlineas WHERE empresa = :codigo_empresa AND codigo = :maquina using trans_ts;
					end if
					
					if isnull(ruta_maquina) or ruta_maquina = "" then
						MessageBox("Error","La máquina "+String(dw_lineas.object.prodlineas_descripcion[i])+" no tiene ruta de envío.")
						res = -1
					else
						if fileexists(ruta_maquina + nombre_archivo) then
							//No avisamos. Lo reemplazamos directamente puesto que es lo normal
						end if
						if not isnull(resolucion_maquina) and resolucion_maquina <> "" then
							//La maquina tiene una resolución especial y tiene que convertirse el archivo
							run ('C:\Program Files\ImageMagick-6.8.7-Q16\convert.exe '+ruta_archivo+' -resample '+resolucion_maquina+' '+ruta_maquina+nombre_archivo,Minimized!)
						else
							//Copiamos el archivo tal cual
							res = filecopy(ruta_archivo, ruta_maquina + nombre_archivo, true)
							// PROVISIONAL MAQUINA EN SERIE

							operacion = dw_aplicaciones.object.modelo_aplicacion_operacion[dw_aplicaciones.getrow()] 
							RUTA_INK-04 = "\\Amazonas\hotfolders\INK-04\EFECTOS\"							
							if maquina = '44' then
								if operacion = '43' or operacion = '45' or operacion = '54' then
									filecopy(ruta_archivo, RUTA_INK-04 + nombre_archivo, true)
								end if
							end if
							
						end if
						if res <> 1 then
							MessageBox("Error","Error en la copia del fichero en la máquina.")
						end if
					end if
				next		
			end if
			
			IF res = 1 THEN	
				COMMIT USING trans_ts;
				//Solo avisamos en caso de error
				//MessageBox("Ticket Enviado","Ticket enviado correctamente.")
				dw_aplicaciones.marcar_filas = false
				dw_aplicaciones.selectrow(0, false)
				dw_ticket.visible = false
				dw_lineas.visible = false
				dw_stock_base.visible = false
				cbx_solo_base_ticket.visible = false
				//Activamos la pieza
				dw_1.object.modelo_pieza_activo[dw_1.getrow()] = 'S'
				
			ELSE
				MessageBox("Error","Ha ocurrido un error al insertar el ticket para máquina de producción.")
				ROLLBACK USING trans_ts;
			END IF
			dw_lineas.SetTransObject(SQLCA)
			dw_ticket.SetTransObject(SQLCA)
			
		else
			MessageBox("Error","Ha ocurrido un error al generar el código del ticket para máquina de producción.")
			ROLLBACK USING trans_ts;
			
			dw_lineas.SetTransObject(SQLCA)
			dw_ticket.SetTransObject(SQLCA)
		end if
		
		f_guardar()  // Ojo con este guarda ¿para qué?
		
		if ver_stock then
			dw_stock_base.SetTransObject(SQLCA)
			dw_stock_base.retrieve(codigo_empresa, base)
			dw_stock_base.visible = true
		end if
		
	CASE "b_cancelar"
		
		dw_aplicaciones.marcar_filas = false
		dw_aplicaciones.selectrow(0, false)
		dw_ticket.visible = false
		dw_lineas.visible = false
		dw_stock_base.visible = false
		cbx_solo_base_ticket.visible = false
END CHOOSE
end event

event usr_dwnkey;call super::usr_dwnkey;String campo, filtro_base
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "esmalte"
			busqueda.titulo_ventana = "Búsqueda de Fórmulas"
			busqueda.consulta  = " SELECT formula, descripcion_laboratorio "+&
										" FROM prodformula "+&
										" WHERE empresa = '"+codigo_empresa+"' ORDER BY descripcion_laboratorio"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Fórmula"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.esmalte[this.GetRow()]										 = resultado.valores[1]		
				this.object.prodformula_descripcion_laboratorio[this.GetRow()]	 = resultado.valores[2]		
			end if
		CASE "modelo_pieza_ticket_prodlineas_codigo"
			busqueda.titulo_ventana = "Búsqueda de Máquinas de Producción"
			busqueda.consulta  = " SELECT codigo, descripcion "+&
										" FROM prodlineas "+&
										" WHERE empresa = '"+codigo_empresa+"' and digital = '1' ORDER BY descripcion"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Descripción"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_pieza_ticket_prodlineas_codigo[this.GetRow()]	= resultado.valores[1]		
				this.object.prodlineas_descripcion[this.GetRow()]	 = resultado.valores[2]		
			end if	
		CASE "base"		
			if cbx_solo_base_ticket.checked then
				filtro_base = "articulos.uso = '1'"
			else
				filtro_base = "articulos.uso <> '3'"
			end if
			busqueda.titulo_ventana = "Búsqueda de Bases"
			busqueda.consulta  = " SELECT articulos.codigo, CONVERT(char(140),articulos.descripcion), articulos.formato, formatos.abreviado,"+&
										"CONVERT(char(40),genter.razon), articulos.ancho, articulos.largo, articulos.bisel, "+&
										"CONVERT(char(11),almusos.descripcion), art_ver_tipooperacion.descripcion_abr, oanterior.descripcion_abr "+&
										" FROM articulos "+&
										" LEFT OUTER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
										" LEFT OUTER JOIN formatos ON articulos.empresa = formatos.empresa and articulos.formato = formatos.codigo "+&
										" LEFT OUTER JOIN genter ON articulos.empresa = genter.empresa and articulos.cliente = genter.codigo and genter.tipoter = 'C' "+&
										"LEFT OUTER JOIN art_ver_tipooperacion ON articulos.empresa = art_ver_tipooperacion.empresa AND articulos.tipo_operacion = art_ver_tipooperacion.codigo "+&
										"LEFT OUTER JOIN art_escandallo e1 ON articulos.empresa = e1.empresa AND articulos.codigo = e1.articulo AND e1.articulo_ant = (SELECT TOP 1 articulo_ant FROM art_escandallo WHERE empresa = articulos.empresa AND articulo = articulos.codigo) AND e1.version = (SELECT TOP 1 version FROM art_escandallo WHERE empresa = articulos.empresa AND articulo = articulos.codigo) "+&
										"LEFT OUTER JOIN articulos anterior ON e1.empresa = anterior.empresa AND e1.articulo_ant = anterior.codigo  "+&
										"LEFT OUTER JOIN art_ver_tipooperacion oanterior ON anterior.empresa = oanterior.empresa AND anterior.tipo_operacion = oanterior.codigo "+&  
										" WHERE articulos.empresa = '"+codigo_empresa+"' AND "+filtro_base+" ORDER BY articulos.descripcion"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Base"
			busqueda.titulos[3] = "Cod.Formato"
			busqueda.titulos[4] = "Formato"
			busqueda.titulos[5] = "Cliente"
			busqueda.titulos[6] = "Ancho"
			busqueda.titulos[7] = "Largo"
			busqueda.titulos[8] = "Bisel"
			busqueda.titulos[9] = "Uso"
			busqueda.titulos[10] = "Operacion"
			busqueda.titulos[11] = "Anterior"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.base[this.GetRow()]							 = resultado.valores[1]		
				this.object.articulos_descripcion[this.GetRow()]	 = resultado.valores[2]		
			end if
	END CHOOSE
end if	
end event

event itemchanged;call super::itemchanged;string resultado

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "esmalte"
		select descripcion_laboratorio
		into :resultado
		from prodformula
		where empresa = :codigo_empresa
		and formula = :data;
		
		if SQLCA.sqlcode <> 100 then
			this.object.prodformula_descripcion_laboratorio[Row] 	= resultado
		else
			dwo.Primary[row] = ''
			this.object.prodformula_descripcion_laboratorio[Row] 	= ''
			return 2			
		end if
	CASE "modelo_pieza_ticket_prodlineas_codigo"
		select descripcion
		into :resultado
		from prodlineas
		where empresa = :codigo_empresa and digital = '1' 
		and codigo = :data;
		
		if SQLCA.sqlcode <> 100 then
			this.object.prodlineas_descripcion[Row] 	= resultado
		else
			dwo.Primary[row] = ''
			this.object.prodlineas_descripcion[Row] 	= ''
			return 2			
		end if
	CASE "base"
		select descripcion
		into :resultado
		from articulos
		where empresa = :codigo_empresa  AND uso <> '3' 
		and codigo = :data;
		
		if SQLCA.sqlcode <> 100 then
			this.object.articulos_descripcion[Row] 	= resultado
		else
			dwo.Primary[row] = ''
			this.object.articulos_descripcion[Row] 	= ''
			return 2			
		end if
END CHOOSE

this.Accepttext()
end event

type dw_lineas from datawindow within wtc_mant_pruebas
boolean visible = false
integer x = 4535
integer y = 2124
integer width = 1184
integer height = 600
integer taborder = 170
boolean bringtotop = true
string title = "none"
string dataobject = "dwtc_maquina_ticket"
boolean vscrollbar = true
boolean border = false
boolean livescroll = true
end type

event clicked;if row > 0 then
	if this.object.seleccionado[row] = 1 then
		this.object.seleccionado[row] = 0
	else
		this.object.seleccionado[row] = 1
	end if
end if
end event

type dw_stock_base from datawindow within wtc_mant_pruebas
boolean visible = false
integer x = 2670
integer y = 1556
integer width = 1847
integer height = 2024
integer taborder = 250
boolean bringtotop = true
string title = "none"
string dataobject = "dwtc_mant_pruebas_almlinubica"
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event clicked;if dwo.name = "b_cerrar" then
	this.visible = false
end if
end event

type pb_bases_mas from picturebutton within wtc_mant_pruebas
boolean visible = false
integer x = 2199
integer y = 1244
integer width = 105
integer height = 92
integer taborder = 260
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_plus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;Long fila
String modelo, cliente, propuesta, pieza, version_color

fila = dw_bases.insertrow(0)

modelo = dw_1.object.modelo_pieza_modelo[1]
cliente = dw_1.object.modelo_pieza_cliente[1]
propuesta = dw_1.object.modelo_pieza_propuesta[1]
pieza = dw_1.object.modelo_pieza_codigo[1]
version_color = dw_pruebas.object.modelo_version[dw_pruebas.getrow()]

dw_bases.object.modelo_pieza_version_empresa[fila] = codigo_empresa
dw_bases.object.modelo_pieza_version_modelo[fila] = modelo
dw_bases.object.modelo_pieza_version_cliente[fila] = cliente
dw_bases.object.modelo_pieza_version_propuesta[fila] = propuesta
dw_bases.object.modelo_pieza_version_pieza[fila] = pieza
dw_bases.object.modelo_pieza_version_version[fila] = version_color

end event

type pb_bases_menos from picturebutton within wtc_mant_pruebas
boolean visible = false
integer x = 2309
integer y = 1244
integer width = 105
integer height = 92
integer taborder = 290
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\navigate_minus.png"
alignment htextalign = left!
string powertiptext = "Añadir Registro"
end type

event clicked;if dw_bases.getrow() > 0 then
	dw_bases.deleterow(dw_bases.getrow())
end if
end event

type dw_bases from u_dw within wtc_mant_pruebas
boolean visible = false
integer x = 1490
integer y = 888
integer width = 2752
integer height = 456
integer taborder = 270
string dataobject = "dwtc_aux_bases_lab"
boolean vscrollbar = true
boolean border = true
borderstyle borderstyle = styleraised!
end type

event itemchanged;call super::itemchanged;string resultado, cliente

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "modelo_pieza_version_base"
		cliente = dw_modelo.object.modelo_propuesta_cliente[dw_modelo.getrow()]
		if not isnull(cliente) and cliente <> "" then
			/*
			if cliente <> '87' then 
				SELECT articulos.descripcion 
				INTO :resultado 
				FROM articulos 
				LEFT OUTER JOIN genter ON articulos.empresa = genter.empresa AND articulos.cliente = genter.codigo 
				WHERE articulos.empresa = :codigo_empresa and articulos.uso = '1' and genter.codigo = :cliente and articulos.codigo = :data;
			else
				//Si el cliente es tencer codigo 87, puede probarse sobre cualquier base
				SELECT articulos.descripcion 
				INTO :resultado 
				FROM articulos 
				WHERE articulos.empresa = :codigo_empresa and articulos.uso = '1' and articulos.codigo = :data;
			end if
			*/
			//Permitimos probar bases (o cualquier tipo de artículo) de cualquier cliente
			SELECT articulos.descripcion 
			INTO :resultado 
			FROM articulos 
			WHERE articulos.empresa = :codigo_empresa and articulos.codigo = :data;
			if SQLCA.sqlcode <> 100 then
				this.object.articulos_descripcion[Row] 		= resultado
			else
				dwo.Primary[row] = ''
				this.object.articulos_descripcion[Row] 		= ''
				return 2			
			end if
		end if
END CHOOSE


this.Accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo, cliente, filtro_bases
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda
Long num_versiones

//if key = KeyF8! then
	//dw_1.EVENT usr_keydown(key, keyflags)
//end if

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "modelo_pieza_version_base"
			cliente = dw_modelo.object.modelo_propuesta_cliente[dw_modelo.getrow()]
			if not isnull(cliente) and cliente <> "" then
				/*
				if cliente <> '87' then 
					busqueda.consulta =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE articulos.uso = '1' AND articulos.empresa = '"+codigo_empresa+"' AND articulos.cliente = '"+cliente+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
				else
					//Para Tencer se puede seleccionar cualquier base
					busqueda.consulta =  "SELECT articulos.codigo, articulos.descripcion, formatos.abreviado, almusos.descripcion, genter.razon "+&
							"FROM articulos "+&
							"INNER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"WHERE articulos.uso = '1' AND articulos.empresa = '"+codigo_empresa+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
				end if
				*/
				//Permitimos probar bases de cualquier cliente
				if cbx_solo_bases.checked then
					filtro_bases = "articulos.uso = '1' "
				else
					filtro_bases = "1 = 1 "
					//filtro_bases = "articulos.uso <> '3' " //PERMITIMOS TAMBIEN ENCAJADOS - Diego 04/2015
				end if
				busqueda.consulta =  "SELECT articulos.codigo, CONVERT(char(140),articulos.descripcion),"+&
							"formatos.abreviado, almusos.descripcion, art_ver_tipooperacion.descripcion_abr, oanterior.descripcion_abr, genter.razon "+&
							"FROM articulos "+&
							"LEFT OUTER JOIN almusos ON articulos.uso = almusos.codigo and articulos.empresa = almusos.empresa "+&
							"LEFT OUTER JOIN genter ON articulos.cliente = genter.codigo and articulos.empresa = genter.empresa "+&
							"LEFT OUTER JOIN formatos ON articulos.formato = formatos.codigo and articulos.empresa = formatos.empresa "+&
							"LEFT OUTER JOIN art_ver_tipooperacion ON articulos.empresa = art_ver_tipooperacion.empresa AND articulos.tipo_operacion = art_ver_tipooperacion.codigo "+&
							"LEFT OUTER JOIN art_escandallo e1 ON articulos.empresa = e1.empresa AND articulos.codigo = e1.articulo AND e1.articulo_ant = (SELECT TOP 1 articulo_ant FROM art_escandallo WHERE empresa = articulos.empresa AND articulo = articulos.codigo) AND e1.version = (SELECT TOP 1 version FROM art_escandallo WHERE empresa = articulos.empresa AND articulo = articulos.codigo) "+&
							"LEFT OUTER JOIN articulos anterior ON e1.empresa = anterior.empresa AND e1.articulo_ant = anterior.codigo  "+&
							"LEFT OUTER JOIN art_ver_tipooperacion oanterior ON anterior.empresa = oanterior.empresa AND anterior.tipo_operacion = oanterior.codigo "+&  
							"WHERE "+filtro_bases+&
							"AND articulos.empresa = '"+codigo_empresa+"' AND "+&
							"articulos.fecha_anulado IS NULL AND "+&
							"(genter.tipoter IS NULL OR genter.tipoter = 'C')"+&
							"ORDER BY articulos.descripcion"
				busqueda.titulo_ventana = "Búsqueda de Bases"
				busqueda.titulos[1] = "Código"
				busqueda.titulos[2] = "Descripción"
				busqueda.titulos[3] = "Formato"
				busqueda.titulos[4] = "Uso"
				busqueda.titulos[5] = "Operación"
				busqueda.titulos[6] = "Anterior"
				busqueda.titulos[7] = "Cliente"
				
				OpenWithParm(wt_busquedas, busqueda)
				resultado = Message.PowerObjectParm
				if resultado.resultado > 0 then
					this.object.modelo_pieza_version_base[this.GetRow()] 			= resultado.valores[1]		
					this.object.articulos_descripcion[this.GetRow()] 	= resultado.valores[2]		
				end if
			end if
	END CHOOSE
end if	
	
end event

event buttonclicking;call super::buttonclicking;//Guardar y Cancelar
Long i

if dwo.name = "guardar" then
	if dw_bases.rowcount() <= 0 then
		MessageBox("Error", "Debe indicar al menos una base")
		return -1
	else
		For i = 1 To dw_bases.rowcount() 
			if isnull(dw_bases.object.modelo_pieza_version_base[i]) or dw_bases.object.modelo_pieza_version_base[i] = "" then
				MessageBox("Error", "Ha dejado una linea de base en blanco. Por favor, indique la base o borre la linea.")
				return -1 
			end if
			if isnull(dw_bases.object.base_final[i]) or dw_bases.object.base_final[i] = "" then
				MessageBox("Error", "Debe indicar si la base es DEFINITIVA o PROVISIONAL.")
				return -1 
			end if
		Next
	end if
	rtn = dw_bases.update()
	
	cbx_solo_bases.visible = false
	dw_bases.visible = false
	pb_bases_mas.visible = false
	pb_bases_menos.visible = false
	dw_pruebas.marcar_filas = false
	dw_pruebas.SelectRow(0,false)
elseif dwo.name = "cancelar" then
	cbx_solo_bases.visible = false
	dw_bases.visible = false
	pb_bases_mas.visible = false
	pb_bases_menos.visible = false
	dw_pruebas.marcar_filas = false
	dw_pruebas.SelectRow(0,false)
end if

if rtn = 1 then
	commit using sqlca;
else 
	rollback using  sqlca;
	Messagebox ("Error", "Error grabando")
end if

end event

type dw_pruebas from u_dw within wtc_mant_pruebas
integer x = 37
integer y = 736
integer width = 4837
integer height = 1592
integer taborder = 130
string dataobject = "dwtc_modelo_prueba"
boolean vscrollbar = true
end type

event rowfocuschanged;call super::rowfocuschanged;String prueba, modelo, cliente, propuesta, trabajo, modelo_version
Long fila, fila_aplicacion
string pieza
string molde, base

fila = this.getrow()
if fila > 0 then
	prueba = this.object.codigo[fila]
	modelo_version = this.object.modelo_version[fila]
else
	prueba = '-1'
	modelo_version = ""
end if

if isnull(prueba) or prueba = '' then
	prueba = '-1'
end if

dw_aplicaciones.setfilter("modelo_aplicacion_prueba = '"+prueba+"' ")
dw_aplicaciones.filter()

if not isnull(modelo_version) and modelo_version <> "" then
	modelo = dw_1.object.modelo_pieza_modelo[dw_1.getrow()]
	cliente = dw_1.object.modelo_pieza_cliente[dw_1.getrow()]
	propuesta = dw_1.object.modelo_pieza_propuesta[dw_1.getrow()]
	pieza = dw_1.object.modelo_pieza_codigo[dw_1.getrow()]

	SELECT codigo INTO :trabajo 
	FROM modelo_trabajo 
	WHERE empresa = :codigo_empresa 
	AND modelo = :modelo 
	AND cliente = :cliente 
	AND propuesta = :propuesta
	AND modelo_version = :modelo_version;
else
	dw_trabajo.reset()
end if

dw_trabajo.retrieve(codigo_empresa, modelo, cliente, propuesta, trabajo)


//Marcos 10/05/2019

if this.RowCount() > 0 then
	wtc_mant_pruebas.uo_buscar_molde.em_codigo.text = this.object.articulos_molde[fila]
	wtc_mant_pruebas.uo_buscar_molde.em_campo.text = f_nombre_molde(codigo_empresa,uo_buscar_molde.em_codigo.text)
end if

//Marcos 10/05/2019

// Inicio: Control de la ventana de pruebas por colores
if not guardando then
	if dw_trabajo.rowcount() > 0 then
			dw_pruebas_color.retrieve (codigo_empresa, modelo, cliente, propuesta, pieza, modelo_version, "")
			dw_pruebas_color.ExpandAll( )
		
//		if dw_trabajo.object.modelo_trabajo_acabado_lab[dw_trabajo.getrow()] = '1' or dw_trabajo.object.modelo_trabajo_acabado_lab[dw_trabajo.getrow()] = '2' then
//			dw_pruebas_color.retrieve (codigo_empresa, modelo, cliente, propuesta, pieza, modelo_version, "")
//			dw_pruebas_color.ExpandAll( )
//			wtc_mant_pruebas.width = 8600
//		else
//			wtc_mant_pruebas.width = 5950
//		end if
		wtc_mant_pruebas.Center = TRUE
	end if
end if
// Fin: Control de la ventana de pruebas por colores

//Seleccion fila y propuesta
fila_aplicacion = dw_aplicaciones.rowcount()
seleccionar_fila (dw_aplicaciones,fila_aplicacion,0)
end event

event usr_dwnkey;call super::usr_dwnkey;string campo
String modelo, cliente, propuesta, pieza, version_color, version_actual
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda
Int i

//if key = KeyF8! then
	//dw_1.EVENT usr_keydown(key, keyflags)
//end if

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "modelo_version"
			
			version_actual = dw_pruebas.object.modelo_prueba_modelo_version_actual[this.GetRow()]
			if isnull(version_actual) then
				version_actual = ""
			end if
			
			modelo = dw_1.object.modelo_pieza_modelo[1]
			cliente = dw_1.object.modelo_pieza_cliente[1]
			propuesta = dw_1.object.modelo_pieza_propuesta[1]
			busqueda.titulo_ventana = "Búsqueda de Versión de Color"
			busqueda.consulta  = " SELECT CODIGO, DESCRIPCION "+&
										" FROM modelo_version "+&
										" WHERE empresa = '"+codigo_empresa+"' AND modelo = '"+modelo+"' AND cliente = '"+cliente+"' AND propuesta = '"+propuesta+"'"+&
										" ORDER BY CODIGO"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Versión de Color"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_version[this.GetRow()] 				= resultado.valores[1]
				this.object.modelo_version_descripcion[this.GetRow()]	= resultado.valores[2]	
				
				if version_actual <> resultado.valores[1] then
					for i = 1 To dw_aplicaciones.rowcount()
						dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[i] = ''
						dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[i] 	= ''
						dw_aplicaciones.object.archivo_disenyo_codigo[i] 	= ''
						dw_aplicaciones.object.archivo_disenyo_nombre[i] 	= ''
						dw_aplicaciones.object.modelo_aplicacion_pantallas[i] = ''
					next
				end if
				
				dw_pruebas.object.modelo_prueba_modelo_version_actual[this.GetRow()] = resultado.valores[1]
				
				this.EVENT rowfocuschanged(this.GetRow())
				
			end if
			
		CASE "serie"
			busqueda.titulo_ventana = "Búsqueda de Serie"
			busqueda.consulta  = " SELECT CODIGO, DESCRIPCION "+&
										" FROM desserie "+&
										" WHERE empresa = '"+codigo_empresa+"' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Serie "
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.serie[this.GetRow()] 					= resultado.valores[1]		
				this.object.desserie_descripcion[this.GetRow()] = resultado.valores[2]		
			end if
			
		CASE "tecnico_lab"
			busqueda.titulo_ventana = "Búsqueda de Técnico"
			busqueda.consulta  = "SELECT CODIGO, DESCRIPCION FROM TECNICO_LAB WHERE EMPRESA = '"+codigo_empresa+"' ORDER BY DESCRIPCION"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Técnico"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.tecnico_lab[this.GetRow()] 				= resultado.valores[1]			
				this.object.tecnico_lab_descripcion[this.GetRow()] = resultado.valores[2]			
			end if		
			
		CASE "base"
			modelo = dw_1.object.modelo_pieza_modelo[1]
			cliente = dw_1.object.modelo_pieza_cliente[1]
			propuesta = dw_1.object.modelo_pieza_propuesta[1]
			pieza = dw_1.object.modelo_pieza_codigo[1]
			version_color = this.object.modelo_version[this.getrow()]
			busqueda.titulo_ventana = "Búsqueda de Bases"
			//busqueda.consulta  = "SELECT CODIGO, DESCRIPCION FROM ARTICULOS WHERE EMPRESA = '"+codigo_empresa+"' AND uso = '1' ORDER BY DESCRIPCION"
			busqueda.consulta =  "  SELECT articulos.codigo, CONVERT(char(140),articulos.descripcion), articulos.formato, formatos.abreviado, genter.razon, articulos.ancho, articulos.largo, articulos.bisel "+&
										"  FROM   articulos,   "+&
										"         formatos,"+&
										"			 genter"+&
										"   WHERE "+&
										"         (articulos.empresa = '"+codigo_empresa+"') AND"+&
										"			 (articulos.empresa *= formatos.empresa and articulos.formato *= formatos.codigo) and "+&
										"			 (articulos.empresa *= genter.empresa and articulos.cliente *= genter.codigo and genter.tipoter = 'C') AND"+&
										"			 articulos.codigo IN (SELECT base FROM modelo_pieza_version WHERE empresa = '"+codigo_empresa+"' AND modelo = '"+modelo+"' AND cliente = '"+cliente+"' AND propuesta = '"+propuesta+"' AND pieza = '"+pieza+"' AND version = '"+version_color+"')"+&
										"   ORDER BY articulos.descripcion ASC  "
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Base"
			busqueda.titulos[3] = "Cod.Formato"
			busqueda.titulos[4] = "Formato"
			busqueda.titulos[5] = "Cliente"
			busqueda.titulos[6] = "Ancho"
			busqueda.titulos[7] = "Largo"
			busqueda.titulos[8] = "Bisel"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.base[this.GetRow()] 						= resultado.valores[1]	
				this.object.articulos_descripcion[this.GetRow()] = resultado.valores[2]			
				this.object.articulos_formato[this.GetRow()] 	= resultado.valores[3]	
				this.object.formatos_abreviado[this.GetRow()] = resultado.valores[4]	
				this.object.articulos_ancho[this.GetRow()] 	= Dec(resultado.valores[6])
				this.object.articulos_largo[this.GetRow()] 	= Dec(resultado.valores[7])
				this.object.articulos_bisel[this.GetRow()] 	= Dec(resultado.valores[8])
			end if		
			
	END CHOOSE
end if	
end event

event itemchanged;call super::itemchanged;string resultado, resultado1, resultado2
dec  res1, res2, res3
Int i
datetime resultado_fecha
String modelo, cliente, propuesta, pieza, version_color, version_actual

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "serie"
		SELECT desserie.descripcion
		INTO :resultado
		FROM desserie
		WHERE empresa = :codigo_empresa
		and desserie.codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.desserie_descripcion[Row] 		= resultado
		else
			dwo.Primary[row] = ''
			this.object.desserie_descripcion[Row] 		= ''
			return 2			
		end if

	CASE "modelo_version"
		version_actual = dw_pruebas.object.modelo_prueba_modelo_version_actual[row]
		if isnull(version_actual) then
			version_actual = ""
		end if
		
		
		
		modelo = dw_1.object.modelo_pieza_modelo[1]
		cliente = dw_1.object.modelo_pieza_cliente[1]
		propuesta = dw_1.object.modelo_pieza_propuesta[1]
		SELECT modelo_version.descripcion
		INTO :resultado
		FROM modelo_version
		WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente AND propuesta = :propuesta 
		and codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.modelo_version_descripcion[Row] 		= resultado
			
			if data <>  version_actual then
				for i = 1 To dw_aplicaciones.rowcount()
					dw_aplicaciones.object.modelo_aplicacion_modelo_archivo[i] = ''
					dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[i] 	= ''
					dw_aplicaciones.object.archivo_disenyo_codigo[i] 	= ''
					//dw_aplicaciones.object.archivo_disenyo_nombre[i] 	= ''
					dw_aplicaciones.object.archivo_disenyo_sistema_archivos_fichero[i] = ''
					dw_aplicaciones.object.modelo_aplicacion_modelo_archivo_prueba[i] = ''
					//dw_aplicaciones.object.modelo_aplicacion_pantallas[i] = ''
				next
			end if
			
			dw_pruebas.object.modelo_prueba_modelo_version_actual[row] = data
			
		else
			dwo.Primary[row] = ''
			this.object.modelo_version_descripcion[Row] 		= ''
			dw_pruebas.object.modelo_prueba_modelo_version_actual[row] = ''
			return 2			
		end if
		
		this.EVENT rowfocuschanged(row)

	CASE "tecnico_lab"
		SELECT tecnico_lab.descripcion 
		INTO :resultado
		FROM tecnico_lab
		WHERE empresa = :codigo_empresa
		and tecnico_lab.codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.tecnico_lab_descripcion[Row] 		= resultado
		else
			dwo.Primary[row] = ''
			this.object.tecnico_lab_descripcion[Row] 		= ''
			return 2
		end if
		
	CASE "base"
		modelo = dw_1.object.modelo_pieza_modelo[1]
		cliente = dw_1.object.modelo_pieza_cliente[1]
		propuesta = dw_1.object.modelo_pieza_propuesta[1]
		pieza = dw_1.object.modelo_pieza_codigo[1]
		version_color = this.object.modelo_version[row]
		
		SELECT articulos.descripcion, articulos.formato, formatos.abreviado, articulos.ancho, articulos.largo, articulos.bisel 
		INTO :resultado, :resultado1, :resultado2, :res1, :res2, :res3 
		FROM articulos, formatos 
		WHERE articulos.empresa = :codigo_empresa 
		AND (articulos.empresa *= formatos.empresa AND articulos.formato *= formatos.codigo) and 
		articulos.codigo IN (SELECT base FROM modelo_pieza_version WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente AND propuesta = :propuesta AND pieza = :pieza AND version = :version_color) 
		AND articulos.codigo = :data;

		if SQLCA.sqlcode <> 100 then
			this.object.articulos_descripcion[Row] = resultado			
			this.object.articulos_formato[Row] 	= resultado1	
			this.object.formatos_abreviado[Row] = resultado2
			this.object.articulos_ancho[Row] 	= Dec(res1)
			this.object.articulos_largo[Row] 	= Dec(res2)
			this.object.articulos_bisel[Row] = Dec(res3)
		else
			dwo.Primary[row] = ''
			this.object.articulos_descripcion[Row] = ''			
			this.object.articulos_formato[Row] 	= ''
			this.object.formatos_abreviado[Row] = ''
			this.object.articulos_ancho[Row] 	= 0
			this.object.articulos_largo[Row] 	= 0
			this.object.articulos_bisel[Row] = 0
			return 2
		end if
		int a 

		for a = 1 to dw_aplicaciones.rowcount()
			if dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20[a] > 0 then
				dw_aplicaciones.trigger event itemchanged(a, dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20, string(dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20[a]))
			end if
		next

END CHOOSE


this.Accepttext()
end event

event clicked;call super::clicked;str_parametros lstr_param
long esta_abierta
String modelo, cliente, propuesta, pieza, version_color

this.accepttext()

CHOOSE CASE dwo.name
	CASE "p_produccion"
		lstr_param.i_nargumentos=2
		lstr_param.s_argumentos[1]="wtc_mant_pruebas"
		lstr_param.s_argumentos[2]=String(this.object.art_produccion[row])
		lstr_param.nombre_ventana = "wtc_mant_pruebas"
		lstr_param.resultado = ''
		
		esta_abierta = f_menu_ventana_esta_abierta("w_mant_altas_intermedios_nuevo")
		if esta_abierta <> -1 then
			close(w_mant_altas_intermedios_nuevo)
			OpenWithParm(w_mant_altas_intermedios_nuevo,lstr_param)
		else
			OpenWithParm(w_mant_altas_intermedios_nuevo,lstr_param)
		end if
		/*
		esta_abierta = f_menu_ventana_esta_abierta("w_mant_articulos_tencer")
		if esta_abierta <> -1 then
			close(w_mant_articulos_tencer)
			OpenWithParm(w_mant_articulos_tencer,lstr_param)
		else
			OpenWithParm(w_mant_articulos_tencer,lstr_param)
		end if
		//Abrimos la ventana si no está abierta ya. En caso contrario la mostramos
		if esta_abierta = -1 then
			
			Openwithparm(w_mant_articulos_tencer, lstr_param)
		else
			ventanas_activas[esta_abierta].ventana.BringToTop = true
		end if
		*/
	CASE "p_mas_base"
		dw_bases.settransobject(SQLCA)
		modelo = dw_1.object.modelo_pieza_modelo[1]
		cliente = dw_1.object.modelo_pieza_cliente[1]
		propuesta = dw_1.object.modelo_pieza_propuesta[1]
		pieza = dw_1.object.modelo_pieza_codigo[1]
		version_color = this.object.modelo_version[row]
		dw_bases.retrieve(codigo_empresa, modelo, cliente, propuesta, pieza, version_color)
		cbx_solo_bases.checked = true
		dw_bases.visible = true
		pb_bases_mas.visible = true
		pb_bases_menos.visible = true
		dw_pruebas.marcar_filas = true
		cbx_solo_bases.visible = true
		seleccionar_fila(dw_pruebas,row,0)
	CASE "p_copia"
		if permiso_ventana = 2 then
			dw_copiar.reset()
			dw_copiar.settransobject(SQLCA)
			dw_copiar.retrieve(codigo_empresa, dw_modelo.object.modelo_propuesta_modelo[dw_modelo.getrow()])
			dw_copiar.visible = true
		end if
END CHOOSE
end event

type dw_reenvio from datawindow within wtc_mant_pruebas
boolean visible = false
integer x = 1902
integer y = 2468
integer width = 1184
integer height = 696
integer taborder = 210
boolean bringtotop = true
string title = "none"
string dataobject = "dwtc_maquina_ticket_reenvio"
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event clicked;string RUTA_INK-04 = "\\Amazonas\hotfolders\INK-04\EFECTOS\"

String tipo_maquina, archivo_disenyo, archivo_disenyo_prueba, perfil_color, gestion_color
String ruta_archivo, nombre_archivo
String maquina, ruta_maquina, resolucion_maquina
Long res = 1, i
integer seleccionado

if row > 0 then	
	if this.object.seleccionado[row] = 1 then
		this.object.seleccionado[row] = 0
	else
		this.object.seleccionado[row] = 1
	end if
else
	CHOOSE CASE dwo.name
		CASE "b_reenvio"		
			//PREPARACIÓN ENVÍO A LA MÁQUINA
			//maquina = dw_ticket.object.modelo_pieza_ticket_prodlineas_codigo[1]
			tipo_maquina = dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[dw_aplicaciones.getrow()]
			archivo_disenyo = dw_aplicaciones.object.archivo_disenyo_codigo[dw_aplicaciones.getrow()]
			archivo_disenyo_prueba = dw_aplicaciones.object.modelo_aplicacion_modelo_archivo_prueba[dw_aplicaciones.getrow()]

			SELECT REPLACE((SELECT ruta_archivos_disenyo FROM empresas WHERE empresa = :codigo_empresa) + REPLACE(ruta,(SELECT ruta_archivos_disenyo FROM empresas WHERE empresa = :codigo_empresa),'') + fichero,' ', ''), fichero 
			INTO :ruta_archivo, :nombre_archivo FROM archivo_disenyo_sistema_archivos 
			WHERE empresa = :codigo_empresa AND tipomaquina_disenyo = :tipo_maquina AND archivo = :archivo_disenyo AND codigo = :archivo_disenyo_prueba
			using sqlca;
			
			if isnull(ruta_archivo) or ruta_archivo = "" then
				MessageBox("Error","No se encuentra la ruta del archivo.")
				res = -1
			end if
			
			//ENVÍO A MAQUINA
			if res = 1 then
				for i = 1 To dw_reenvio.rowcount()
					ruta_maquina = ""
					resolucion_maquina = ""
					maquina = dw_reenvio.object.modelo_pieza_ticket_prodlineas_prodlinea[i]
					perfil_color = dw_aplicaciones.object.archivo_disenyo_sistema_archivos_perfil_color[dw_aplicaciones.getrow()]
					seleccionado = dw_reenvio.object.seleccionado[i]
					
					if seleccionado = 1 then
						SELECT gestion_color 
						INTO :gestion_color 
						FROM tipomaquina_disenyo 
						WHERE empresa = :codigo_empresa AND codigo = :tipo_maquina 
						using sqlca;
						if gestion_color = "1" then
							SELECT carpeta INTO :ruta_maquina 
							FROM prodlineas_perfil_color 
							WHERE empresa = :codigo_empresa 
							AND prodlineas = :maquina 
							AND perfil_color = :perfil_color
							and activo = 1
							using sqlca;
						else
							SELECT ruta_inkcid, resolucion INTO :ruta_maquina, :resolucion_maquina FROM prodlineas WHERE empresa = :codigo_empresa AND codigo = :maquina using sqlca;
						end if
						
						if isnull(ruta_maquina) or ruta_maquina = "" then
							MessageBox("Error","La máquina "+String(dw_reenvio.object.prodlineas_descripcion[i])+" no tiene ruta de envío.")
							res = -1
						else
							if fileexists(ruta_maquina + nombre_archivo) then
								//No avisamos. Lo reemplazamos directamente puesto que es lo normal
							end if
							if not isnull(resolucion_maquina) and resolucion_maquina <> "" then
								//La maquina tiene una resolución especial y tiene que convertirse el archivo
								run ('C:\Program Files\ImageMagick-6.8.7-Q16\convert.exe '+ruta_archivo+' -resample '+resolucion_maquina+' '+ruta_maquina+nombre_archivo,Minimized!)
							else
								//Copiamos el archivo tal cual
								res = filecopy(ruta_archivo, ruta_maquina + nombre_archivo, true)
								// PROVISIONAL MAQUINA EN SERIE
								if maquina = '44' then
									filecopy(ruta_archivo, RUTA_INK-04 + nombre_archivo, true)
								end if
								
							end if
							if res <> 1 then
								MessageBox("Error","Error en la copia del fichero en la máquina.")
							end if
						end if
					end if
				next		
			end if
			
			if res = 1 then
				MessageBox("Reenvio de Archivo Correcto","Se ha reenviado el archivo a las máquinas seleccionadas.")
				dw_aplicaciones.marcar_filas = false
				dw_aplicaciones.selectrow(0, false)
				dw_reenvio.visible = false
			end if
		CASE "b_cancelar"
			dw_aplicaciones.marcar_filas = false
			dw_aplicaciones.selectrow(0, false)
			dw_reenvio.visible = false
	END CHOOSE
end if
end event

type dw_trabajo from datawindow within wtc_mant_pruebas
integer x = 1495
integer y = 264
integer width = 1435
integer height = 460
integer taborder = 20
boolean bringtotop = true
string title = "none"
string dataobject = "dw_mant_pruebas_trabajo_pasar"
boolean border = false
end type

type cbx_solo_bases from checkbox within wtc_mant_pruebas
boolean visible = false
integer x = 2757
integer y = 1252
integer width = 448
integer height = 80
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 30527953
string text = "Solo bases"
borderstyle borderstyle = styleraised!
end type

type cbx_solo_base_ticket from checkbox within wtc_mant_pruebas
boolean visible = false
integer x = 5230
integer y = 1648
integer width = 448
integer height = 80
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 30527953
string text = "Solo bases"
borderstyle borderstyle = styleraised!
end type

type dw_pruebas_color from datawindow within wtc_mant_pruebas
integer x = 5947
integer y = 264
integer width = 2597
integer height = 3312
integer taborder = 190
boolean bringtotop = true
string title = "none"
string dataobject = "dwtc_consulta_formulaciones_prueba"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean border = false
boolean livescroll = true
end type

type cb_2 from commandbutton within wtc_mant_pruebas
integer x = 7703
integer y = 52
integer width = 594
integer height = 88
integer taborder = 330
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Expandir"
end type

event clicked;dw_pruebas_color.ExpandAll( )
end event

type cb_3 from commandbutton within wtc_mant_pruebas
integer x = 7095
integer y = 52
integer width = 594
integer height = 88
integer taborder = 100
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Contraer"
end type

event clicked;dw_pruebas_color.CollapseAll( )
end event

type pb_4 from picturebutton within wtc_mant_pruebas
integer x = 8338
integer y = 32
integer width = 146
integer height = 128
integer taborder = 220
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "C:\Tencer_PB12\printer-icon2_24x24.png"
end type

event clicked;PrintSetup ( )
dw_pruebas_color.print()
end event

type dw_aplicaciones from u_dw within wtc_mant_pruebas
integer x = 37
integer y = 2336
integer width = 4827
integer height = 1240
integer taborder = 230
string dataobject = "dw_modelo_aplicaciones"
boolean vscrollbar = true
end type

event itemchanged;call super::itemchanged;string resultado, resultado1, resultado2, resultado3, resultado4, resultado5
dec {2} ancho, largo
Decimal {6} gram_7x20, gramaje
String modelo, cliente, propuesta, pieza, version_color, busqueda
String Formato

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "modelo_aplicacion_operacion"
		select descripcion_abr
		into :resultado
		from art_ver_tipooperacion
		where empresa = :codigo_empresa
		and codigo = :data;
		
		if SQLCA.sqlcode <> 100 then
			this.object.art_ver_tipooperacion_descripcion_abr[Row] 		= resultado
		else
			dwo.Primary[row] = ''
			this.object.art_ver_tipooperacion_descripcion_abr[Row] 		= ''
			return 2			
		end if
		
	CASE "modelo_aplicacion_aplicacion"
		select resumido
		into :resultado
		from prodaplicaciones
		where empresa = :codigo_empresa
		and codigo = :data;
		
		if SQLCA.sqlcode <> 100 then
			this.object.prodaplicaciones_resumido[Row] 	= resultado
		else
			dwo.Primary[row] = ''
			this.object.prodaplicaciones_resumido[Row] 	= ''
			return 2			
		end if
	
	CASE "modelo_aplicacion_modelo_archivo"
		
		if data = "" then
			dwo.Primary[row] = ''
			this.object.modelo_aplicacion_modelo_archivo_prueba[row] = ''
			this.object.modelo_archivo_tipo_maquina_disenyo[row]		 = ''
			this.object.archivo_disenyo_codigo[row] 						 = ''
			this.object.archivo_disenyo_sistema_archivos_fichero[row] = ''		
			return 2		
		end if
		
		modelo = dw_1.object.modelo_pieza_modelo[1]
		cliente = dw_1.object.modelo_pieza_cliente[1]
		propuesta = dw_1.object.modelo_pieza_propuesta[1]
		pieza = dw_1.object.modelo_pieza_codigo[1]
		version_color = dw_pruebas.object.modelo_version[dw_pruebas.getrow()]
		busqueda = data + "%"
		
		SELECT archivo_disenyo_sistema_archivos.tipomaquina_disenyo, archivo_disenyo_sistema_archivos.fichero, 
				 archivo_disenyo.codigo, archivo_disenyo_sistema_archivos.codigo, modelo_archivo.codigo 
		INTO :resultado1, :resultado2, :resultado3, :resultado4, :resultado5 
		FROM modelo_archivo 
		INNER JOIN archivo_disenyo ON modelo_archivo.empresa = archivo_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo.codigo 
		INNER JOIN tipomaquina_disenyo ON modelo_archivo.empresa = tipomaquina_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = tipomaquina_disenyo.codigo 
		INNER JOIN archivo_disenyo_sistema_archivos ON modelo_archivo.empresa = archivo_disenyo_sistema_archivos.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo_sistema_archivos.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo_sistema_archivos.archivo 
		WHERE modelo_archivo.empresa = :codigo_empresa 
		AND modelo_archivo.modelo = :modelo 
		AND modelo_archivo.cliente = :cliente 
		AND modelo_archivo.propuesta = :propuesta 
		AND modelo_archivo.pieza = :pieza 
		AND modelo_archivo.modelo_version = :version_color 
		AND archivo_disenyo_sistema_archivos.fichero LIKE :busqueda;
		
		if SQLCA.sqlcode <> 100 then
			dwo.Primary[row] = resultado5
			this.object.modelo_aplicacion_modelo_archivo_prueba[row] = resultado4
			this.object.modelo_archivo_tipo_maquina_disenyo[row]		 = resultado1
			this.object.archivo_disenyo_codigo[row] 						 = resultado3
			this.object.archivo_disenyo_sistema_archivos_fichero[row] = resultado2
			return 2
		else
			dwo.Primary[row] = ''
			this.object.modelo_aplicacion_modelo_archivo_prueba[row] = ''
			this.object.modelo_archivo_tipo_maquina_disenyo[row]		 = ''
			this.object.archivo_disenyo_codigo[row] 						 = ''
			this.object.archivo_disenyo_sistema_archivos_fichero[row] = ''		
			return 2		
		end if
	CASE "modelo_aplicacion_formula"
		select descripcion_laboratorio
		into :resultado
		from prodformula
		where empresa = :codigo_empresa
		and formula = :data;
		
		if SQLCA.sqlcode <> 100 then
			this.object.prodformula_descripcion_laboratorio[Row] 	= resultado
		else
			dwo.Primary[row] = ''
			this.object.prodformula_descripcion_laboratorio[Row] 	= ''
			return 2			
		end if
		
	CASE "modelo_aplicacion_gramaje_7_20"
		if not isnull (dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20) then
			gram_7x20 = dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20[row]
			
			formato = dw_pruebas.object.articulos_formato[dw_pruebas.getrow()]
			
			select ancho, largo
			into :ancho,:largo
			from formatos 
			where empresa = :codigo_empresa
			and codigo = :formato;
			
//			ancho = dw_pruebas.object.articulos_ancho[dw_pruebas.getrow()]
//			largo = dw_pruebas.object.articulos_largo[dw_pruebas.getrow()]
				
			//gramaje = ancho * largo * ( gram_7x20 / (7 * 20) )
			gramaje = gram_7x20 * ancho * largo / 140
			this.object.modelo_aplicacion_gramaje[row] = gramaje
		end if
END CHOOSE

this.Accepttext()
end event

event usr_dwnkey;call super::usr_dwnkey;string campo
String modelo, cliente, propuesta, pieza,  version_color
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda

//if key = KeyF8! then
	//dw_1.EVENT usr_keydown(key, keyflags)
//end if

control_teclas (keyflags, key)

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "modelo_aplicacion_operacion"
			busqueda.titulo_ventana = "Búsqueda de Operaciones"
			busqueda.consulta  = " SELECT CODIGO, descripcion_abr "+&
										" FROM art_ver_tipooperacion "+&
										" where empresa = '"+codigo_empresa+"'"+&
										" ORDER BY descripcion_abr"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Operacion"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_aplicacion_operacion[this.GetRow()]				= resultado.valores[1]		
				this.object.art_ver_tipooperacion_descripcion_abr[this.GetRow()]	= resultado.valores[2]		
			end if
			
		CASE "modelo_aplicacion_aplicacion"
			busqueda.titulo_ventana = "Búsqueda de Tipos de Aplicaciones"
			busqueda.consulta  = " SELECT CODIGO, resumido "+&
										" FROM prodaplicaciones "+&
										" WHERE empresa = '"+codigo_empresa+"' ORDER BY resumido"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Tipo de Aplicación"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_aplicacion_aplicacion[this.GetRow()] = resultado.valores[1]		
				this.object.prodaplicaciones_resumido[this.GetRow()]	 = resultado.valores[2]		
			end if
			
		CASE "modelo_aplicacion_modelo_archivo"	
			
			modelo = dw_1.object.modelo_pieza_modelo[1]
			cliente = dw_1.object.modelo_pieza_cliente[1]
			propuesta = dw_1.object.modelo_pieza_propuesta[1]
			pieza = dw_1.object.modelo_pieza_codigo[1]
			version_color = dw_pruebas.object.modelo_version[dw_pruebas.getrow()]
			
			
			busqueda.titulo_ventana = "Búsqueda de Archivos"
			/*
			busqueda.consulta  = " SELECT modelo_archivo.tipo_maquina_disenyo, CONVERT(char(20),tipomaquina_disenyo.descripcion), modelo_archivo.codigo, archivo_disenyo.nombre, archivo_disenyo.codigo "+&
										" FROM modelo_archivo "+&
										" INNER JOIN archivo_disenyo ON modelo_archivo.empresa = archivo_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo.codigo "+&
										" INNER JOIN tipomaquina_disenyo ON modelo_archivo.empresa = tipomaquina_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = tipomaquina_disenyo.codigo "+&
										" WHERE modelo_archivo.empresa = '"+codigo_empresa+"' AND "+&
										"			modelo_archivo.modelo = '"+modelo+"' AND "+&
										"			modelo_archivo.cliente = '"+cliente+"' AND "+&
										"			modelo_archivo.propuesta = '"+propuesta+"' AND "+&
										"			modelo_archivo.pieza = '"+pieza+"' AND "+&
										"			modelo_archivo.modelo_version = '"+version_color+"' "+&
										" ORDER BY modelo_archivo.tipo_maquina_disenyo, archivo_disenyo.nombre"
			*/
			busqueda.consulta  = " SELECT CONVERT(char(2),archivo_disenyo_sistema_archivos.tipomaquina_disenyo), CONVERT(char(20),tipomaquina_disenyo.descripcion), "+&
										" CONVERT(char(15),archivo_disenyo_sistema_archivos.fichero), archivo_disenyo_sistema_archivos.fecha_modificacion, "+&
										" CONVERT(char(50), perfil_color.descripcion), CONVERT(char(200), archivo_disenyo_sistema_archivos.observaciones), "+&
										" modelo_archivo.codigo, archivo_disenyo.codigo, archivo_disenyo_sistema_archivos.codigo "+&
										" FROM modelo_archivo "+&
										" INNER JOIN archivo_disenyo ON modelo_archivo.empresa = archivo_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo.codigo "+&
										" INNER JOIN tipomaquina_disenyo ON modelo_archivo.empresa = tipomaquina_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = tipomaquina_disenyo.codigo "+&
										" INNER JOIN archivo_disenyo_sistema_archivos ON modelo_archivo.empresa = archivo_disenyo_sistema_archivos.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo_sistema_archivos.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo_sistema_archivos.archivo "+&
										" LEFT OUTER JOIN perfil_color ON perfil_color.empresa = archivo_disenyo_sistema_archivos.empresa AND perfil_color.codigo = archivo_disenyo_sistema_archivos.perfil_color  "+&
										" WHERE modelo_archivo.empresa = '"+codigo_empresa+"' AND "+&
										"			modelo_archivo.modelo = '"+modelo+"' AND "+&
										"			modelo_archivo.cliente = '"+cliente+"' AND "+&
										"			modelo_archivo.propuesta = '"+propuesta+"' AND "+&
										"			modelo_archivo.pieza = '"+pieza+"' AND "+&
										"			modelo_archivo.modelo_version = '"+version_color+"' "+&
										" ORDER BY modelo_archivo.tipo_maquina_disenyo asc, archivo_disenyo_sistema_archivos.fecha_modificacion desc"
										
			busqueda.titulos[1] = ""
			busqueda.titulos[2] = ""
			busqueda.titulos[3] = ""
			busqueda.titulos[4] = ""
			busqueda.titulos[5] = "" 
			busqueda.titulos[6] = ""
			busqueda.titulos[7] = ""
			busqueda.titulos[8] = ""
			busqueda.titulos[9] = ""
			
//			busqueda.titulos[1] = "Código Tipo Máquina"
//			busqueda.titulos[2] = "Tipo Máquina"
//			busqueda.titulos[3] = "Fichero"
//			busqueda.titulos[4] = "Fecha"
//			busqueda.titulos[5] = "Observaciones"
//			busqueda.titulos[6] = "Código Modelo Archivo"
//			busqueda.titulos[7] = "Código Archivo Diseño"
//			busqueda.titulos[8] = "Código Modelo Archivo Prueba"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_aplicacion_modelo_archivo[this.GetRow()] 		 = resultado.valores[7]	
				this.object.modelo_aplicacion_modelo_archivo_prueba[this.GetRow()] = resultado.valores[9]
				this.object.modelo_archivo_tipo_maquina_disenyo[this.GetRow()]		 = resultado.valores[1]	
				this.object.archivo_disenyo_codigo[this.GetRow()] 						 = resultado.valores[8]	
				this.object.archivo_disenyo_sistema_archivos_fichero[this.GetRow()] = resultado.valores[3]		
				//this.object.archivo_disenyo_nombre[this.GetRow()] 						 = resultado.valores[3]						
			end if		
			
		CASE "modelo_aplicacion_formula"
			busqueda.titulo_ventana = "Búsqueda de Fórmulas"
			busqueda.consulta  = " SELECT formula, CONVERT(CHAR(150), descripcion_laboratorio),  activa_en_produccion as PROD  "+&
										" FROM prodformula "+&
										" WHERE empresa = '"+codigo_empresa+"' ORDER BY descripcion_laboratorio"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Fórmula"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_aplicacion_formula[this.GetRow()]				 = resultado.valores[1]		
				this.object.prodformula_descripcion_laboratorio[this.GetRow()]	 = resultado.valores[2]		
			end if
			
			CASE "modelo_aplicacion_hilos"
			busqueda.titulo_ventana = "Búsqueda de Hilos"
			busqueda.consulta  = " SELECT hilos, CONVERT(CHAR(75), descripcion), gram_cm2  "+&
										" FROM prodhilosgramaje "+&
										" WHERE empresa = '"+codigo_empresa+"' ORDER BY descripcion"
			busqueda.titulos[1] = "Código"
			busqueda.titulos[2] = "Descripción"
			busqueda.titulos[3] = "Gramaje"

			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				this.object.modelo_aplicacion_hilos[this.GetRow()]				 = resultado.valores[1]			
			end if
			
			
	END CHOOSE
end if	
end event

event clicked;call super::clicked;str_parametros lstr_param
long esta_abierta
Long res, i, numero_maquinas, lin
String ejecutable, ruta_fichero, tipom, pr, archivo, ma, archivo_tm, archivo_codigo, archivo_pr, sel, gestion_color, formula
Datastore maquinas
str_wt_busquedas_entrada busqueda

this.accepttext()

if row > 0 then
	CHOOSE CASE dwo.name
		CASE "p_ps"
			if permiso_ventana = 2 then
				tipom = this.object.modelo_archivo_tipo_maquina_disenyo[row]
				archivo = this.object.archivo_disenyo_codigo[row]
				pr = this.object.modelo_aplicacion_modelo_archivo_prueba[row]
				ma = this.object.modelo_aplicacion_modelo_archivo[row]
				if not isnull(ma) and ma <> "" then
					SELECT REPLACE((SELECT ruta_archivos_disenyo FROM empresas WHERE empresa = '1') + ruta + fichero, ' ', '' )  INTO :ruta_fichero FROM archivo_disenyo_sistema_archivos WHERE empresa = :codigo_empresa AND tipomaquina_disenyo = :tipom AND archivo = :archivo AND codigo = :pr;
					if dw_1.rowcount() > 0 then
						//Lanzamos photoshop o el explorador de windows
						if ftc_lanzar_photoshop(ruta_fichero) < 1 then
							run("explorer "+ruta_fichero) //Muestra la carpeta
						end if
					end if
				end if
			end if
		CASE "p_ticket"
			if permiso_ventana = 2 then
				if hay_cambios() then
					if MessageBox ("Atención", "Para continuar debe guardar los cambios. ¿Desea guardar?", Question!, YesNo!, 2) = 1 then
						res = f_guardar()
					else
						MessageBox("Operación cancelada", "Los cambios no se han guardado. Operación cancelada.")
						return
					end if
				else
					res = 1
				end if
				
				if res = 1 then
					//Obtenemos el archivo
					archivo_tm = this.object.modelo_archivo_tipo_maquina_disenyo[row]
					archivo_codigo = this.object.archivo_disenyo_codigo[row]
					archivo_pr = this.object.modelo_aplicacion_modelo_archivo_prueba[row]			
					
					if isnull(archivo_tm) or archivo_tm = "" or isnull(archivo_codigo) or archivo_codigo = "" or isnull(archivo_pr) or archivo_pr = "" then
						MessageBox("Error", "Debe seleccionar el archivo que va a enviar a la Máquina de Producción")
						return
					end if
					
					dw_aplicaciones.marcar_filas = true
					seleccionar_fila(dw_aplicaciones,row,0)
					dw_ticket.reset()
					dw_ticket.insertrow(0)
					dw_ticket.object.urgente[dw_ticket.getrow()] = 'N'
					dw_ticket.object.modo_impresion[dw_ticket.getrow()] = 'Repetir'
					dw_ticket.object.modelo_pieza_ticket_modelo_prueba[dw_ticket.getrow()] = String(dw_pruebas.object.codigo[dw_pruebas.getrow()])
					dw_ticket.object.base[dw_ticket.getrow()] = String(dw_pruebas.object.base[dw_pruebas.getrow()])
					dw_ticket.object.articulos_descripcion[dw_ticket.getrow()] = String(dw_pruebas.object.articulos_descripcion[dw_pruebas.getrow()])
					
					dw_ticket.object.tipo_maquina[dw_ticket.getrow()] = archivo_tm
					dw_ticket.object.archivo_disenyo[dw_ticket.getrow()] = archivo_codigo
					dw_ticket.object.modelo_pieza_ticket_archivo_disenyo_prueba[dw_ticket.getrow()] = archivo_pr
					
					dw_ticket.object.modelo_pieza_ticket_operacion[dw_ticket.getrow()] = String(dw_aplicaciones.object.modelo_aplicacion_operacion[dw_aplicaciones.getrow()])
					dw_ticket.object.modelo_pieza_ticket_perfil_color[dw_ticket.getrow()] = String(dw_aplicaciones.object.archivo_disenyo_sistema_archivos_perfil_color[dw_aplicaciones.getrow()])
					dw_ticket.object.perfil_color_descripcion[dw_ticket.getrow()] = String(dw_aplicaciones.object.perfil_color_descripcion[dw_aplicaciones.getrow()])
					
					dw_lineas.reset()
					
					SELECT gestion_color INTO :gestion_color FROM tipomaquina_disenyo WHERE empresa = :codigo_empresa AND codigo = :archivo_tm using sqlca;
					
					if gestion_color = '1' then
						sel =  "SELECT codigo, descripcion "+&
								"FROM prodlineas "+&
								"WHERE empresa = '"+codigo_empresa+"' "+&
								"AND digital = 1 "+&
								"AND prodlineas.codigo in (select prodlinea from prodlinea_tipomaquina_disenyo where tipomaquina_disenyo =  '"+archivo_tm+"') "+&
								"AND EXISTS (SELECT * "+&
												 "FROM prodlineas_perfil_color "+&
												 "WHERE empresa = prodlineas.empresa "+&
												 "AND prodlineas = prodlineas.codigo "+&
												 "AND perfil_color = '"+String(dw_aplicaciones.object.archivo_disenyo_sistema_archivos_perfil_color[dw_aplicaciones.getrow()])+"')"

						/*
						sel =  "SELECT codigo, descripcion "+&
								"FROM prodlineas "+&
								"WHERE empresa = '"+codigo_empresa+"' "+&
								"AND digital = 1 "+&
								"AND tipomaquina_disenyo = '"+archivo_tm+"' "+&
								"AND EXISTS (SELECT * "+&
												 "FROM prodlineas_perfil_color "+&
												 "WHERE empresa = prodlineas.empresa "+&
												 "AND prodlineas = prodlineas.codigo "+&
												 "AND perfil_color = '"+String(dw_aplicaciones.object.archivo_disenyo_sistema_archivos_perfil_color[dw_aplicaciones.getrow()])+"')"
						*/
						
					else
							sel =  "SELECT codigo, descripcion "+&
								"FROM prodlineas "+&
								"WHERE empresa = '"+codigo_empresa+"' "+&
								"AND digital = 1 "+&
								"AND prodlineas.codigo in (select prodlinea from prodlinea_tipomaquina_disenyo where tipomaquina_disenyo =  '"+archivo_tm+"')"
						/*
							sel =  "SELECT codigo, descripcion "+&
								"FROM prodlineas "+&
								"WHERE empresa = '"+codigo_empresa+"' "+&
								"AND digital = 1 "+&
								"AND tipomaquina_disenyo = '"+archivo_tm+"'"
						*/								
					end if
												
					f_cargar_cursor_trans (SQLCA,  sel, maquinas)
					numero_maquinas = maquinas.RowCount()
					i = 1
					do while (i <= numero_maquinas)	
						lin = dw_lineas.insertrow(0)
						dw_lineas.object.modelo_pieza_ticket_prodlineas_empresa[lin] = codigo_empresa
						dw_lineas.object.modelo_pieza_ticket_prodlineas_prodlinea[lin] = maquinas.object.codigo[i]
						dw_lineas.object.prodlineas_descripcion[lin] = maquinas.object.descripcion[i]
						dw_lineas.object.seleccionado[lin] = 0
						
						i++
					loop
					
					dw_ticket.visible = true
					dw_lineas.visible = true
					cbx_solo_base_ticket.checked = true
					cbx_solo_base_ticket.visible = true
					dw_ticket.setfocus()
				end if
			end if
		CASE "p_reenvio"
			if permiso_ventana = 2 then
				//Obtenemos el archivo
				archivo_tm = this.object.modelo_archivo_tipo_maquina_disenyo[row]
				archivo_codigo = this.object.archivo_disenyo_codigo[row]
				archivo_pr = this.object.modelo_aplicacion_modelo_archivo_prueba[row]			
				
				if isnull(archivo_tm) or archivo_tm = "" or isnull(archivo_codigo) or archivo_codigo = "" or isnull(archivo_pr) or archivo_pr = "" then
					MessageBox("Error", "Debe seleccionar el archivo que va a enviar a la Máquina de Producción")
					return
				end if
				
				dw_aplicaciones.marcar_filas = true
				seleccionar_fila(dw_aplicaciones,row,0)
				
				dw_reenvio.reset()
				
				SELECT gestion_color INTO :gestion_color FROM tipomaquina_disenyo WHERE empresa = :codigo_empresa AND codigo = :archivo_tm using sqlca;
				if gestion_color = '1' then
					sel =  "SELECT codigo, descripcion "+&
							"FROM prodlineas "+&
							"WHERE empresa = '"+codigo_empresa+"' "+&
							"AND digital = 1 "+&
							"AND prodlineas.codigo in (select prodlinea from prodlinea_tipomaquina_disenyo where tipomaquina_disenyo =  '"+archivo_tm+"') "+&
							"AND EXISTS (SELECT * "+&
											 "FROM prodlineas_perfil_color "+&
											 "WHERE empresa = prodlineas.empresa "+&
											 "AND prodlineas = prodlineas.codigo "+&
											 "AND perfil_color = '"+String(dw_aplicaciones.object.archivo_disenyo_sistema_archivos_perfil_color[dw_aplicaciones.getrow()])+"')"
				/*					
					sel =  "SELECT codigo, descripcion "+&
								"FROM prodlineas "+&
								"WHERE empresa = '"+codigo_empresa+"' "+&
								"AND digital = 1 "+&
								"AND tipomaquina_disenyo = '"+archivo_tm+"' "+&
								"AND EXISTS (SELECT * "+&
												 "FROM prodlineas_perfil_color "+&
												 "WHERE empresa = prodlineas.empresa "+&
												 "AND prodlineas = prodlineas.codigo "+&
												 "AND perfil_color = '"+String(dw_aplicaciones.object.archivo_disenyo_sistema_archivos_perfil_color[dw_aplicaciones.getrow()])+"')"
				 */
				else
					sel =  "SELECT codigo, descripcion "+&
							"FROM prodlineas "+&
							"WHERE empresa = '"+codigo_empresa+"' "+&
							"AND digital = 1 "+&
							"AND prodlineas.codigo in (select prodlinea from prodlinea_tipomaquina_disenyo where tipomaquina_disenyo =  '"+archivo_tm+"')"					
							
//					sel = "SELECT codigo, descripcion FROM prodlineas WHERE empresa = '"+codigo_empresa+"' and digital = 1 and tipomaquina_disenyo = '"+archivo_tm+"'"
				end if
				f_cargar_cursor_trans (SQLCA,  sel, maquinas)
				numero_maquinas = maquinas.RowCount()
				i = 1
				do while (i <= numero_maquinas) 
					lin = dw_reenvio.insertrow(0)
					dw_reenvio.object.modelo_pieza_ticket_prodlineas_empresa[lin] = codigo_empresa
					dw_reenvio.object.modelo_pieza_ticket_prodlineas_prodlinea[lin] = maquinas.object.codigo[i]
					dw_reenvio.object.prodlineas_descripcion[lin] = maquinas.object.descripcion[i]
					dw_reenvio.object.seleccionado[lin] = 0
					
					i++
				loop
				
				dw_reenvio.visible = true
			end if
		CASE "p_archivo"			
			lstr_param.s_argumentos[1] = this.object.archivo_disenyo_codigo[row]
			lstr_param.s_argumentos[2] = this.object.modelo_archivo_tipo_maquina_disenyo[row]
			lstr_param.i_nargumentos = 2
			lstr_param.nombre_ventana = "wtc_mant_pruebas"
			lstr_param.resultado = ''
			
			esta_abierta = f_menu_ventana_esta_abierta("wtc_mant_archivos_disenyo")
			if esta_abierta <> -1 then
				close(wtc_mant_archivos_disenyo)
				OpenWithParm(wtc_mant_archivos_disenyo,lstr_param)
			else
				OpenWithParm(wtc_mant_archivos_disenyo,lstr_param)
			end if
			
		CASE "p_formula"			
			lstr_param.s_argumentos[1]="wi_mant_formulaciones"
			lstr_param.s_argumentos[2] = this.object.modelo_aplicacion_formula[row]
//			lstr_param.s_argumentos[2] = this.object.modelo_archivo_tipo_maquina_disenyo[row]
			lstr_param.i_nargumentos = 2
			lstr_param.resultado = ''
			
			esta_abierta = f_menu_ventana_esta_abierta("wi_mant_formulaciones")
			if esta_abierta <> -1 then
				close(wi_mant_formulaciones)
				OpenWithParm(wi_mant_formulaciones,lstr_param)
			else
				OpenWithParm(wi_mant_formulaciones,lstr_param)
			end if
			
			if this.object.modelo_aplicacion_formula[row] = "" then
				this.object.modelo_aplicacion_formula[row] = Message.StringParm 
			else
				IF messagebox("Atención", "Desea Sustituir la fórmula", Question!, YesNo!, 2) = 1 THEN
					this.object.modelo_aplicacion_formula[row] = Message.StringParm 
					pb_grabar.Event clicked()
				END IF
			end if
			this.event ItemChanged(row, this.object.modelo_aplicacion_formula, this.object.modelo_aplicacion_formula[row])

		CASE "p_planificacion"			
			formula = this.object.modelo_aplicacion_formula[row]
			if formula  <> "" then

//				busqueda.titulo_ventana =  this.object.prodformula_descripcion_laboratorio[row]
				busqueda.consulta  = " SELECT     prodlineas.descripcion AS LINEAS , planificacion.fecha_fin AS FECHA, planificacion.cod_articulo AS ARTICULO, formatos.abreviado AS FORMATO, articulos.descripcion  AS ARTICULO"+&
											" FROM         planificacion  "+&
											" INNER JOIN prodlineas ON planificacion.empresa = prodlineas.empresa AND planificacion.lineaprod = prodlineas.codigo  "+&
											" INNER JOIN articulos ON planificacion.cod_articulo = articulos.codigo AND planificacion.empresa = articulos.empresa  "+&
											" INNER JOIN  formatos ON planificacion.empresa = formatos.empresa AND planificacion.formato = formatos.codigo "+&
											" WHERE     (planificacion.cod_articulo IN       (SELECT     articulo "+&
																					                        " FROM          art_ver_op_aplicaciones "+&
																										" WHERE      (formula = '"+formula+"' ))) "+&
																										" ORDER BY planificacion.fecha_fin  "
				string new_syntax, error_syntaxfromSQL, error_create
				new_syntax = SQLCA.SyntaxFromSQL(busqueda.consulta, 'Style(Type=Grid)', error_syntaxfromSQL)																										
				dw_seleccion.Create(new_syntax, error_create)	
				dw_seleccion.SetTransObject(SQLCA)
				dw_seleccion.Retrieve() 
				dw_seleccion.visible = true

											
//				busqueda.titulos[1] = "LÍNEA"
//				busqueda.titulos[2] = "FECHA FIN"
//				busqueda.titulos[3] = "COD."
//				busqueda.titulos[4] = "ARTÍCULO"
//				busqueda.titulos[5] = "FORMATO"
				
		//		OpenWithParm(wt_busquedas, busqueda)
			end if
			
	END CHOOSE
end if

Destroy maquinas


end event

type sle_pruebas from singlelineedit within wtc_mant_pruebas
integer x = 6528
integer y = 56
integer width = 402
integer height = 80
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
boolean border = false
end type

event losefocus;int i
string filtro

if sle_pruebas.text = '' then
	filtro = ""
else
	i = 1
	filtro = "'"
	do while i <= len (sle_pruebas.text)
		if Mid (sle_pruebas.text, i, 1) <> ',' then
			filtro = filtro + Mid (sle_pruebas.text, i, 1)
		else
			filtro = filtro +"','"
		end if
		
		i ++
	loop

	filtro = "modelo_aplicacion_prueba in ( "+ filtro +"' )"
end if


dw_pruebas_color.SetFilter (filtro)
dw_pruebas_color.Filter()
dw_pruebas_color.ExpandAll()
end event

type st_1 from statictext within wtc_mant_pruebas
integer x = 6085
integer y = 64
integer width = 439
integer height = 64
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 24076881
long backcolor = 67108864
string text = "Filtro Pruebas:"
boolean focusrectangle = false
end type

type sle_version_color from singlelineedit within wtc_mant_pruebas
integer x = 3374
integer y = 48
integer width = 242
integer height = 68
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
boolean border = false
end type

event losefocus;/*
string filtro

if sle_version_color.text <> '' then
	filtro = " modelo_version = '"+sle_version_color.text+"' "
else
	filtro = ""	
end if
	
dw_pruebas.SetFilter (filtro)
dw_pruebas.Filter()
cbx_pruebas_ok.checked = false
	
	*/
end event

type st_3 from statictext within wtc_mant_pruebas
integer x = 2770
integer y = 48
integer width = 594
integer height = 64
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 24076881
long backcolor = 67108864
string text = "Filtro Versión Color:"
boolean focusrectangle = false
end type

type cbx_pruebas_ok from checkbox within wtc_mant_pruebas
integer x = 2770
integer y = 128
integer width = 681
integer height = 80
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 24076881
long backcolor = 67108864
string text = "Mostrar Pruebas OK"
boolean lefttext = true
end type

event clicked;string filtro

if this.checked then
	filtro = " aceptado = 'S'"
else
	filtro = ""	
end if
		
dw_pruebas.SetFilter (filtro)
dw_pruebas.Filter()

sle_version_color.text = ""

end event

type dw_imagen from u_dw_imagen within wtc_mant_pruebas
integer x = 4910
integer y = 820
integer width = 987
integer height = 720
integer taborder = 280
end type

type pb_5 from picturebutton within wtc_mant_pruebas
integer x = 3634
integer y = 36
integer width = 110
integer height = 96
integer taborder = 340
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "C:\Fuentes_tencer_PB12\Add_16x16.png"
alignment htextalign = right!
end type

event clicked;
string filtro

if sle_version_color.text <> '' then
	filtro = " modelo_version = '"+sle_version_color.text+"' "
else
	filtro = ""	
end if
	
dw_pruebas.SetFilter (filtro)
dw_pruebas.Filter()
cbx_pruebas_ok.checked = false
	
sle_version_color.text = ''	
end event

type dw_seleccion from datawindow within wtc_mant_pruebas
boolean visible = false
integer x = 50
integer y = 752
integer width = 4617
integer height = 1568
integer taborder = 260
string title = "none"
boolean hscrollbar = true
boolean vscrollbar = true
boolean resizable = true
boolean livescroll = true
end type

event doubleclicked;dw_seleccion.visible = false
end event

type dw_copiar from u_dw within wtc_mant_pruebas
boolean visible = false
integer x = 41
integer y = 2332
integer width = 4617
integer height = 1248
integer taborder = 180
string dataobject = "dwtc_modelo_pieza_copiar"
boolean vscrollbar = true
boolean border = true
borderstyle borderstyle = styleraised!
end type

event clicked;call super::clicked;String sel, codigo_prueba, serie_destino
String modelo_destino, cliente_destino, propuesta_destino, pieza_destino, pieza_lab, modelo_version, codigo_aplicacion, modelo_archivo_prueba, modelo_archivo, tipomaq, fichero_serigrafia
String base, tecnico_lab, serie, observaciones
String aplicacion, operacion, pantallas, formula, hilos, observaciones_apli
Decimal paso, gramaje, gramaje_7_20,  densidad
Datetime fecha_destino, ahora
Int i, orden_aplicacion, res = 1 
str_parametros lstr_param
str_colisiones pcolisiones_prueba

if dwo.name = 'b_cancelar' then
	dw_copiar.visible = false
end if

if row > 0 then
	if dwo.name = 'b_copiar' then	
		
		modelo_destino = this.object.modelo_pieza_modelo[row]
		cliente_destino = this.object.modelo_pieza_cliente[row]
		propuesta_destino = this.object.modelo_pieza_propuesta[row]
		pieza_destino = this.object.modelo_pieza_codigo[row]
		pieza_lab = this.object.modelo_pieza_codigo_lab[row]
		modelo_version = this.object.version_color[row]
		codigo_prueba = this.object.prueba_destino[row]
		
		//serie_destino = this.object.modelo_trabajo_serie[row]
		
		if isnull(modelo_version) or modelo_version = "" then
			MessageBox("Error Copiando Prueba","Debe indicar la versión de color dela prueba destino.")
			return
		end if
		
		SELECT serie 
		INTO :serie_destino 
		FROM modelo_trabajo 
		WHERE empresa = :codigo_empresa 
			AND modelo = :modelo_destino 
			AND cliente = :cliente_destino 
			AND propuesta = :propuesta_destino
			AND modelo_version = :modelo_version 
		using trans_ts;
		
		//Colisiones obtener max codigo_prueba
		
		SELECT fecha_lab 
		INTO :fecha_destino 
		FROM modelo_pieza 
		WHERE empresa = :codigo_empresa 
			AND modelo = :modelo_destino 
			AND cliente = :cliente_destino 
			AND propuesta = :propuesta_destino 
			AND codigo = :pieza_destino 
		USING trans_ts;
		
		ahora = Datetime(today(), now())
		
		if isnull(codigo_prueba) OR codigo_prueba = "" then
			pcolisiones_prueba.empresa = codigo_empresa
			pcolisiones_prueba.tabla = "modelo_prueba"
			pcolisiones_prueba.campo = "codigo"
			pcolisiones_prueba.filtro = "modelo_prueba.empresa = '"+codigo_empresa+"' AND modelo_prueba.modelo = '"+modelo_destino+"' AND modelo_prueba.cliente = '"+cliente_destino+"' AND modelo_prueba.propuesta = '"+propuesta_destino+"' AND modelo_prueba.pieza = '"+pieza_destino+"'"
			pcolisiones_prueba.buscar_huecos = false
			codigo_prueba = f_colisiones (trans_ts, pcolisiones_prueba)
			codigo_aplicacion = "" 
			orden_aplicacion = 0
		else
			pcolisiones_prueba.empresa = codigo_empresa
			pcolisiones_prueba.tabla = "modelo_aplicacion"
			pcolisiones_prueba.campo = "codigo"
			pcolisiones_prueba.filtro = "modelo_aplicacion.empresa = '"+codigo_empresa+"' AND modelo_aplicacion.modelo = '"+modelo_destino+"' AND modelo_aplicacion.cliente = '"+cliente_destino+"' AND modelo_aplicacion.propuesta = '"+propuesta_destino+"' AND modelo_aplicacion.pieza = '"+pieza_destino+"' AND modelo_aplicacion.prueba = '"+codigo_prueba+"'"
			pcolisiones_prueba.buscar_huecos = false
			codigo_aplicacion = f_colisiones (trans_ts, pcolisiones_prueba)
			
			SELECT MAX(orden) 
			INTO :orden_aplicacion 
			FROM modelo_aplicacion 
			WHERE modelo_aplicacion.empresa = :codigo_empresa 
				AND modelo_aplicacion.modelo = :modelo_destino 
				AND modelo_aplicacion.cliente = :cliente_destino 
				AND modelo_aplicacion.propuesta = :propuesta_destino 
				AND modelo_aplicacion.pieza = :pieza_destino 
				AND modelo_aplicacion.prueba = :codigo_prueba 
			USING trans_ts;
			
			if isnull(orden_aplicacion) or orden_aplicacion = 0 then
				orden_aplicacion = 1
			else
				orden_aplicacion = orden_aplicacion + 1
			end if
		end if
		
		if isnull(fecha_destino) then
			UPDATE modelo_pieza 
			SET fecha_lab = :ahora, activo = 'S' 
			WHERE empresa = :codigo_empresa 
				AND modelo = :modelo_destino 
				AND cliente = :cliente_destino 
				AND propuesta = :propuesta_destino 
				AND codigo = :pieza_destino 
			USING trans_ts;
		else
			UPDATE modelo_pieza 
			SET activo = 'S' 
			WHERE empresa = :codigo_empresa 
				AND modelo = :modelo_destino 
				AND cliente = :cliente_destino 
				AND propuesta = :propuesta_destino 
				AND codigo = :pieza_destino 
			USING trans_ts;
		end if
		
		if trans_ts.sqlcode <> 0 then 
			res = -1
			messagebox ("Error 1", "Error actualizando modelo_pieza")
		end if 
		
		if not isnull(codigo_prueba) and codigo_prueba <> "" then 			
			//VALORES DE LA PRUEBA A COPIAR
			//base = dw_pruebas.object.base[dw_pruebas.getrow()]
			tecnico_lab = dw_pruebas.object.tecnico_lab[dw_pruebas.getrow()]
			//serie = dw_pruebas.object.serie[dw_pruebas.getrow()]
			
			//INSERCIÓN PRUEBA
			if isnull(codigo_aplicacion) or codigo_aplicacion = "" then
				INSERT INTO modelo_prueba (empresa, modelo, cliente, propuesta, pieza, codigo, aceptado, base, tecnico_lab, modelo_version, serie, fecha_prueba) 
				VALUES (:codigo_empresa, :modelo_destino, :cliente_destino, :propuesta_destino, :pieza_destino, :codigo_prueba, 'N', NULL, :tecnico_lab, :modelo_version, 
							:serie_destino, :ahora) 
				USING trans_ts;
			end if
						
			if trans_ts.sqlcode <> 0 then 
				res = -1
				messagebox ("Error 2", "Error insertando en modelo_pieza")
			end if 
			
			i = 1
			Do while (i <= dw_aplicaciones.rowcount() and res = 1)
				//VALORES DE LA APLICACION A COPIAR
				if dw_aplicaciones.object.seleccionada[i] = 1 then
					aplicacion = dw_aplicaciones.object.modelo_aplicacion_aplicacion[i]
					operacion = dw_aplicaciones.object.modelo_aplicacion_operacion[i]
					pantallas = dw_aplicaciones.object.modelo_aplicacion_pantallas[i]
					formula = dw_aplicaciones.object.modelo_aplicacion_formula[i]
					hilos = dw_aplicaciones.object.modelo_aplicacion_hilos[i]
					densidad = dw_aplicaciones.object.modelo_aplicacion_densidad[i]
					observaciones = dw_aplicaciones.object.modelo_aplicacion_observaciones[i]
					tipomaq = dw_aplicaciones.object.modelo_archivo_tipo_maquina_disenyo[i]
					fichero_serigrafia = dw_aplicaciones.object.archivo_disenyo_sistema_archivos_fichero[i] + "%"
					if not isnull(tipomaq) and tipomaq = '3' then //Serigrafía
						SELECT archivo_disenyo_sistema_archivos.codigo, modelo_archivo.codigo 
						INTO :modelo_archivo_prueba, :modelo_archivo 
						FROM modelo_archivo 
						INNER JOIN archivo_disenyo ON modelo_archivo.empresa = archivo_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo.codigo 
						INNER JOIN tipomaquina_disenyo ON modelo_archivo.empresa = tipomaquina_disenyo.empresa AND modelo_archivo.tipo_maquina_disenyo = tipomaquina_disenyo.codigo 
						INNER JOIN archivo_disenyo_sistema_archivos ON modelo_archivo.empresa = archivo_disenyo_sistema_archivos.empresa AND modelo_archivo.tipo_maquina_disenyo = archivo_disenyo_sistema_archivos.tipomaquina_disenyo AND modelo_archivo.archivo_disenyo = archivo_disenyo_sistema_archivos.archivo 
						WHERE modelo_archivo.empresa = :codigo_empresa 
							AND modelo_archivo.modelo = :modelo_destino 
							AND modelo_archivo.cliente = :cliente_destino 
							AND modelo_archivo.propuesta = :propuesta_destino  
							AND modelo_archivo.pieza = :pieza_destino  
							AND modelo_archivo.modelo_version = :modelo_version 
							AND archivo_disenyo_sistema_archivos.fichero LIKE :fichero_serigrafia 
						USING trans_ts;
						
						if trans_ts.sqlcode = 100 then
							setnull(modelo_archivo_prueba)
							setnull(modelo_archivo)
						end if
					else
						setnull(modelo_archivo_prueba)
						setnull(modelo_archivo)
					end if
					
					//INSERCIÓN APLICACION
					if isnull(codigo_aplicacion) or codigo_aplicacion = "" then
						codigo_aplicacion = String(i)
					end if
					if isnull(orden_aplicacion) or orden_aplicacion = 0 then
						orden_aplicacion = i
					end if
					if pieza_lab = dw_1.object.modelo_pieza_codigo_lab[dw_1.getrow()] then
						paso = dw_aplicaciones.object.modelo_aplicacion_paso_cliche[i]
						gramaje = dw_aplicaciones.object.modelo_aplicacion_gramaje[i]
						gramaje_7_20 = dw_aplicaciones.object.modelo_aplicacion_gramaje_7_20[i]
					else
						setnull(paso)
						setnull(gramaje)
						setnull(gramaje_7_20)
					end if
					INSERT INTO modelo_aplicacion (empresa, modelo, cliente, propuesta, pieza, prueba, codigo, orden, aplicacion, operacion, pantallas, formula, hilos, densidad, observaciones,
															modelo_archivo, modelo_archivo_prueba, paso_cliche, gramaje , gramaje_7_20) 
					VALUES (:codigo_empresa, :modelo_destino, :cliente_destino, :propuesta_destino, :pieza_destino, :codigo_prueba, :codigo_aplicacion, :orden_aplicacion, 
								:aplicacion, :operacion, :pantallas, :formula, :hilos, :densidad, :observaciones, :modelo_archivo, :modelo_archivo_prueba, :paso, :gramaje, :gramaje_7_20) 
					USING trans_ts;
					codigo_aplicacion = String(Long(codigo_aplicacion) + 1)
					orden_aplicacion = orden_aplicacion + 1

					if trans_ts.sqlcode <> 0 then 
						res = -1
						messagebox ("Error 3", "Error insertando en modelo_aplicacion")
					end if 

				end if
				i++
			Loop	
			
			// Comprobamos éxito operación
//			if res = 1 then
//				COMMIT USING trans_ts;
//				res = MessageBox("Copia de Prueba Completada","Se ha copiado correctamente la prueba. ¿Desea abrir la pieza en la que se ha copiado la prueba?", Question!, YesNo!, 2)
//				if res = 1 then
//					dw_copiar.visible = false
//					lstr_param.s_argumentos[1] = pieza_lab
//					lstr_param.s_argumentos[2] = codigo_prueba
//					lstr_param.i_nargumentos = 2
//					lstr_param.nombre_ventana = "wtc_mant_pruebas"
//					lstr_param.resultado = ''
//					
//					Message.PowerObjectParm = lstr_param
//					Parent.triggerevent(open!)
//				end if
//			else
//				ROLLBACK USING trans_ts;
//				MessageBox("Error Copiando Prueba","Fallo en la copia de la Prueba.")
//			end if		

		end if
	
	
		// Comprobamos éxito operación
		if res = 1 then
			COMMIT USING trans_ts;
			res = MessageBox("Copia de Prueba Completada","Se ha copiado correctamente la prueba. ¿Desea abrir la pieza en la que se ha copiado la prueba?", Question!, YesNo!, 2)
			if res = 1 then
				dw_copiar.visible = false
				lstr_param.s_argumentos[1] = pieza_lab
				lstr_param.s_argumentos[2] = codigo_prueba
				lstr_param.i_nargumentos = 2
				lstr_param.nombre_ventana = "wtc_mant_pruebas"
				lstr_param.resultado = ''
				
				Message.PowerObjectParm = lstr_param
				Parent.triggerevent(open!)
			end if
		else
			ROLLBACK USING trans_ts;
			MessageBox("Error Copiando Prueba","Fallo en la copia de la Prueba.")
		end if		
	end if
	
end if


end event

event usr_dwnkey;call super::usr_dwnkey;string campo
String modelo, cliente, propuesta, pieza
str_wt_busquedas_salida resultado
str_wt_busquedas_entrada busqueda
Long fila

busqueda.filtro_es_codigo = false
if key =  keyEnter! then
	campo = This.GetColumnName()
	CHOOSE CASE campo
		CASE "version_color"
			fila = dw_copiar.getrow()
			if isnull(dw_copiar.object.prueba_destino[fila]) or dw_copiar.object.prueba_destino[fila] = "" then
				modelo = dw_copiar.object.modelo_pieza_modelo[fila]
				cliente = dw_copiar.object.modelo_pieza_cliente[fila]
				propuesta = dw_copiar.object.modelo_pieza_propuesta[fila]
				busqueda.titulo_ventana = "Búsqueda de Versión de Color"
				busqueda.consulta  = " SELECT CODIGO, DESCRIPCION "+&
											" FROM modelo_version "+&
											" WHERE empresa = '"+codigo_empresa+"' AND modelo = '"+modelo+"' AND cliente = '"+cliente+"' AND propuesta = '"+propuesta+"'"+&
											" ORDER BY CONVERT(INTEGER,CODIGO)"
				busqueda.titulos[1] = "Código"
				busqueda.titulos[2] = "Versión de Color"
				
				OpenWithParm(wt_busquedas, busqueda)
				resultado = Message.PowerObjectParm
				if resultado.resultado > 0 then
					dw_copiar.object.version_color[fila] 					= resultado.valores[1]		
					dw_copiar.object.version_color_descripcion[fila]	= resultado.valores[2]		
				end if
			end if
		CASE "prueba_destino"
			fila = dw_copiar.getrow()
			modelo = dw_copiar.object.modelo_pieza_modelo[fila]
			cliente = dw_copiar.object.modelo_pieza_cliente[fila]
			propuesta = dw_copiar.object.modelo_pieza_propuesta[fila]
			pieza = dw_copiar.object.modelo_pieza_codigo[fila]
			busqueda.titulo_ventana = "Búsqueda de Pruebas destino"
			busqueda.consulta  = " SELECT modelo_prueba.codigo, modelo_prueba.codigo, modelo_prueba.modelo_version, modelo_version.descripcion "+&
										" FROM modelo_prueba LEFT OUTER JOIN modelo_version ON modelo_prueba.empresa = modelo_version.empresa AND modelo_prueba.modelo = modelo_version.modelo AND modelo_prueba.cliente = modelo_version.cliente AND modelo_prueba.propuesta = modelo_version.propuesta AND modelo_prueba.modelo_version = modelo_version.codigo "+&
										" WHERE modelo_prueba.empresa = '"+codigo_empresa+"' AND modelo_prueba.modelo = '"+modelo+"' AND modelo_prueba.cliente = '"+cliente+"' AND modelo_prueba.propuesta = '"+propuesta+"' AND modelo_prueba.pieza = '"+pieza+"'"
			busqueda.titulos[1] = "Prueba"
			busqueda.titulos[2] = "Prueba"
			busqueda.titulos[3] = "Código Versión"
			busqueda.titulos[4] = "Versión Color"
			
			OpenWithParm(wt_busquedas, busqueda)
			resultado = Message.PowerObjectParm
			if resultado.resultado > 0 then
				dw_copiar.object.prueba_destino[fila] = resultado.valores[1]	
				dw_copiar.object.version_color[fila] = resultado.valores[3]	
				dw_copiar.object.version_color_descripcion[fila] = resultado.valores[4]	
			end if
	END CHOOSE
end if
end event

event itemchanged;call super::itemchanged;string resultado, resultado2
String modelo, cliente, propuesta, pieza

this.Accepttext()

CHOOSE CASE dwo.name
	CASE "version_color"
		if isnull(dw_copiar.object.prueba_destino[dw_copiar.getrow()]) or dw_copiar.object.prueba_destino[dw_copiar.getrow()] = "" then
			modelo = dw_copiar.object.modelo_pieza_modelo[dw_copiar.getrow()]
			cliente = dw_copiar.object.modelo_pieza_cliente[dw_copiar.getrow()]
			propuesta = dw_copiar.object.modelo_pieza_propuesta[dw_copiar.getrow()]
			SELECT modelo_version.descripcion
			INTO :resultado
			FROM modelo_version
			WHERE empresa = :codigo_empresa AND modelo = :modelo AND cliente = :cliente AND propuesta = :propuesta 
			and codigo = :data;
	
			if SQLCA.sqlcode <> 100 then
				dw_copiar.object.version_color_descripcion[Row] 		= resultado
			else
				dwo.Primary[row] = ''
				dw_copiar.object.version_color_descripcion[Row] 		= ''
				return 2			
			end if
		end if
	CASE "prueba_destino"
		modelo = dw_copiar.object.modelo_pieza_modelo[dw_copiar.getrow()]
		cliente = dw_copiar.object.modelo_pieza_cliente[dw_copiar.getrow()]
		propuesta = dw_copiar.object.modelo_pieza_propuesta[dw_copiar.getrow()]
		pieza = dw_copiar.object.modelo_pieza_codigo[dw_copiar.getrow()]
		SELECT modelo_prueba.modelo_version, modelo_version.descripcion 
		INTO :resultado, :resultado2
		FROM modelo_prueba 
		LEFT OUTER JOIN modelo_version ON modelo_prueba.empresa = modelo_version.empresa AND modelo_prueba.modelo = modelo_version.modelo AND modelo_prueba.cliente = modelo_version.cliente AND modelo_prueba.propuesta = modelo_version.propuesta AND modelo_prueba.modelo_version = modelo_version.codigo 
		WHERE modelo_prueba.empresa = :codigo_empresa AND modelo_prueba.modelo = :modelo AND modelo_prueba.cliente = :cliente 
		AND modelo_prueba.propuesta = :propuesta AND modelo_prueba.pieza = :pieza 
		and modelo_prueba.codigo = :data;
			
		if SQLCA.sqlcode <> 100 then
			dw_copiar.object.version_color[Row] = resultado
			dw_copiar.object.version_color_descripcion[Row] 		= resultado2
		else
			dwo.Primary[row] = ''
			dw_copiar.object.version_color[Row] = ''
			dw_copiar.object.version_color_descripcion[Row] 		= ''
			return 2			
		end if
END CHOOSE


this.Accepttext()
end event

type pb_imprimir_etiqueta from picturebutton within wtc_mant_pruebas
integer x = 4946
integer y = 116
integer width = 146
integer height = 128
integer taborder = 340
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean originalsize = true
string picturename = "C:\Tencer_PB12\printer-icon2_24x24.png"
end type

event clicked;//string pieza, bases,ls_opciones, prueba
//string sel, caracter, datos_aux
//String modelo, cliente, propuesta, pruebas []
//long i, j, posicion, a, b
//datastore total_pruebas
//

dw_etiqueta_muestras.SetTransObject(SQLCA)

dw_etiqueta_muestras.object.referencia[1] = dw_modelo.object.modelo_propuesta_modelo[dw_modelo.getrow()]+' - '+dw_1.object.modelo_pieza_codigo_lab[dw_1.getrow()]+' - '+dw_pruebas.object.codigo[dw_pruebas.getrow()]
dw_etiqueta_muestras.object.version_color[1] = dw_pruebas.object.modelo_version[dw_pruebas.getrow()]+' : ' +dw_pruebas.object.modelo_version_descripcion[dw_pruebas.getrow()]
dw_etiqueta_muestras.object.imagen[1] = "c:\bmp\tencer_labor.bmp"

f_imprimir_datawindow(dw_etiqueta_muestras)		

//if OpenWithParm(w_imprimir_trabajos_laboratorio_temp, "Imprimir") = 1 then
//	ls_opciones = Message.StringParm
//	IF ls_opciones = "" THEN
//		//
//	ELSE
//		
//		modelo = dw_modelo.object.modelo_propuesta_modelo[dw_modelo.getrow()]
//		cliente = dw_modelo.object.modelo_propuesta_cliente[dw_modelo.getrow()]
//		propuesta = dw_modelo.object.modelo_propuesta_codigo[dw_modelo.getrow()]
//		pieza = dw_1.object.modelo_pieza_codigo[dw_1.getrow()]
//		
//		if ls_opciones = "*" then
//			
//			sel = " select codigo "+&
//					" from modelo_prueba "+&
//					" where empresa = '"+codigo_empresa+"'"+&
//					" and modelo = '"+modelo+"'"+&
//					" and cliente = '"+cliente+"'"+&
//					" and propuesta = '"+propuesta+"'"+&
//					" and pieza = '"+pieza+"'"
//					
//			f_cargar_cursor_nuevo(sel, total_pruebas)
//			
//			for i = 1 to total_pruebas.rowcount() 
//				pruebas[i] = total_pruebas.object.codigo[i]
//			next
//			
//			destroy total_pruebas
//		else
//			posicion = pos (ls_opciones, '-')
//			if posicion > 0 then
//				a =  long(left(ls_opciones, posicion - 1 ))
//				b =  long(right(ls_opciones, len(ls_opciones) - posicion))
//				j = 1
//				for i = a to b
//					pruebas[j] = String(i)
//					j ++
//				next
//			else
//				posicion = pos (ls_opciones, ',') 
//				i= 1
//				do while posicion >0
//					posicion = pos (ls_opciones, ',')
//					pruebas[i] = String(left(ls_opciones, posicion - 1 ))
//					ls_opciones = right(ls_opciones, len(ls_opciones) - posicion)
//				
//					i ++
//				loop
//				if ls_opciones <> "" then
//					pruebas[i] = ls_opciones
//				end if
//			end if
//		end if
//		
//	END IF
//end if
//
end event

type dw_etiqueta_muestras from datawindow within wtc_mant_pruebas
boolean visible = false
integer x = 5134
integer y = 960
integer width = 686
integer height = 400
integer taborder = 350
boolean bringtotop = true
string title = "none"
string dataobject = "dw_etiqueta_muestras"
boolean border = false
boolean livescroll = true
end type

type st_4 from statictext within wtc_mant_pruebas
integer x = 6085
integer y = 176
integer width = 416
integer height = 64
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 24076881
long backcolor = 67108864
string text = "Molde:"
alignment alignment = right!
boolean focusrectangle = false
end type

type dw_molde_lineas from datawindow within wtc_mant_pruebas
boolean visible = false
integer x = 6519
integer y = 264
integer width = 1568
integer height = 1876
integer taborder = 300
boolean bringtotop = true
string title = "none"
string dataobject = "dw_molde_lineas"
boolean vscrollbar = true
boolean livescroll = true
end type

event clicked;if dwo.name = "exit" then
	
	dw_molde_lineas.Reset()
	dw_molde_lineas.visible=False
	
end if
	
end event

type pb_6 from picturebutton within wtc_mant_pruebas
integer x = 7968
integer y = 156
integer width = 128
integer height = 112
integer taborder = 350
boolean bringtotop = true
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\Tencer_PB12\Search_24x24.png"
alignment htextalign = right!
end type

event clicked;dw_molde_lineas.visible=True
dw_molde_lineas.Retrieve(codigo_empresa,uo_buscar_molde.em_codigo.text)
end event

type uo_buscar_molde from u_em_campo_2 within wtc_mant_pruebas
integer x = 6528
integer y = 164
integer width = 1426
integer height = 96
integer taborder = 20
boolean bringtotop = true
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;uo_buscar_molde.em_campo.text = f_nombre_molde(codigo_empresa,uo_buscar_molde.em_codigo.text)
If Trim(uo_buscar_molde.em_campo.text) = "" then
	uo_buscar_molde.em_campo.text = ""
	uo_buscar_molde.em_codigo.text = ""
	Return
end if 

end event

event getfocus;call super::getfocus;ue_titulo = "Selección de Moldes"
ue_datawindow ="dw_ayuda_prodmoldes"
ue_filtro = ""
end event

on uo_buscar_molde.destroy
call u_em_campo_2::destroy
end on

