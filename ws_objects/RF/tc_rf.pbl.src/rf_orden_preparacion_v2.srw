$PBExportHeader$rf_orden_preparacion_v2.srw
forward
global type rf_orden_preparacion_v2 from window
end type
type pb_salir from picturebutton within rf_orden_preparacion_v2
end type
type tab_1 from tab within rf_orden_preparacion_v2
end type
type tp_seleccion_orden from userobject within tab_1
end type
type pb_bajar from picturebutton within tp_seleccion_orden
end type
type pb_subir from picturebutton within tp_seleccion_orden
end type
type pb_1 from picturebutton within tp_seleccion_orden
end type
type dw_seleccion_orden from u_datawindow within tp_seleccion_orden
end type
type r_barra from rectangle within tp_seleccion_orden
end type
type r_indicador from rectangle within tp_seleccion_orden
end type
type tp_seleccion_orden from userobject within tab_1
pb_bajar pb_bajar
pb_subir pb_subir
pb_1 pb_1
dw_seleccion_orden dw_seleccion_orden
r_barra r_barra
r_indicador r_indicador
end type
type tp_preparacion_bulto from userobject within tab_1
end type
type dw_seleccion_tipo_pallet_preparacion from datawindow within tp_preparacion_bulto
end type
type st_ubicar_indicador3 from statictext within tp_preparacion_bulto
end type
type st_preparar_indicador3 from statictext within tp_preparacion_bulto
end type
type em_piezas_2 from editmask within tp_preparacion_bulto
end type
type em_cajas_2 from editmask within tp_preparacion_bulto
end type
type em_pallets_2 from editmask within tp_preparacion_bulto
end type
type st_piezas_2 from statictext within tp_preparacion_bulto
end type
type st_cajas_2 from statictext within tp_preparacion_bulto
end type
type st_pallets_2 from statictext within tp_preparacion_bulto
end type
type p_bajar2 from picturebutton within tp_preparacion_bulto
end type
type p_subir2 from picturebutton within tp_preparacion_bulto
end type
type st_paso3_2 from statictext within tp_preparacion_bulto
end type
type dw_lineas_picos_orden_2 from u_datawindow within tp_preparacion_bulto
end type
type pb_aceptar_2 from picturebutton within tp_preparacion_bulto
end type
type pb_atras_2 from picturebutton within tp_preparacion_bulto
end type
type uo_lectura_destino_2 from u_sle_codbar within tp_preparacion_bulto
end type
type uo_lectura_origen_2 from u_sle_codbar within tp_preparacion_bulto
end type
type st_paso2_2 from statictext within tp_preparacion_bulto
end type
type st_paso1_2 from statictext within tp_preparacion_bulto
end type
type r_barra2 from rectangle within tp_preparacion_bulto
end type
type r_indicador2 from rectangle within tp_preparacion_bulto
end type
type tp_preparacion_bulto from userobject within tab_1
dw_seleccion_tipo_pallet_preparacion dw_seleccion_tipo_pallet_preparacion
st_ubicar_indicador3 st_ubicar_indicador3
st_preparar_indicador3 st_preparar_indicador3
em_piezas_2 em_piezas_2
em_cajas_2 em_cajas_2
em_pallets_2 em_pallets_2
st_piezas_2 st_piezas_2
st_cajas_2 st_cajas_2
st_pallets_2 st_pallets_2
p_bajar2 p_bajar2
p_subir2 p_subir2
st_paso3_2 st_paso3_2
dw_lineas_picos_orden_2 dw_lineas_picos_orden_2
pb_aceptar_2 pb_aceptar_2
pb_atras_2 pb_atras_2
uo_lectura_destino_2 uo_lectura_destino_2
uo_lectura_origen_2 uo_lectura_origen_2
st_paso2_2 st_paso2_2
st_paso1_2 st_paso1_2
r_barra2 r_barra2
r_indicador2 r_indicador2
end type
type tp_mover_pallets from userobject within tab_1
end type
type p_bajar3 from picturebutton within tp_mover_pallets
end type
type p_subir3 from picturebutton within tp_mover_pallets
end type
type st_ubicar_3 from statictext within tp_mover_pallets
end type
type em_pallets_3 from editmask within tp_mover_pallets
end type
type em_cajas_3 from editmask within tp_mover_pallets
end type
type em_piezas_3 from editmask within tp_mover_pallets
end type
type st_piezas_3 from statictext within tp_mover_pallets
end type
type st_cajas_3 from statictext within tp_mover_pallets
end type
type st_pallets_3 from statictext within tp_mover_pallets
end type
type st_preparar_3 from statictext within tp_mover_pallets
end type
type pb_aceptar_3 from picturebutton within tp_mover_pallets
end type
type pb_atras_3 from picturebutton within tp_mover_pallets
end type
type dw_lineas_pallets_orden_3 from u_datawindow within tp_mover_pallets
end type
type uo_lectura_destino_3 from u_sle_codbar within tp_mover_pallets
end type
type st_paso3_3 from statictext within tp_mover_pallets
end type
type st_paso2_3 from statictext within tp_mover_pallets
end type
type st_paso1_3 from statictext within tp_mover_pallets
end type
type r_barra3 from rectangle within tp_mover_pallets
end type
type r_indicador3 from rectangle within tp_mover_pallets
end type
type uo_lectura_origen_3 from u_sle_codbar within tp_mover_pallets
end type
type tp_mover_pallets from userobject within tab_1
p_bajar3 p_bajar3
p_subir3 p_subir3
st_ubicar_3 st_ubicar_3
em_pallets_3 em_pallets_3
em_cajas_3 em_cajas_3
em_piezas_3 em_piezas_3
st_piezas_3 st_piezas_3
st_cajas_3 st_cajas_3
st_pallets_3 st_pallets_3
st_preparar_3 st_preparar_3
pb_aceptar_3 pb_aceptar_3
pb_atras_3 pb_atras_3
dw_lineas_pallets_orden_3 dw_lineas_pallets_orden_3
uo_lectura_destino_3 uo_lectura_destino_3
st_paso3_3 st_paso3_3
st_paso2_3 st_paso2_3
st_paso1_3 st_paso1_3
r_barra3 r_barra3
r_indicador3 r_indicador3
uo_lectura_origen_3 uo_lectura_origen_3
end type
type tab_1 from tab within rf_orden_preparacion_v2
tp_seleccion_orden tp_seleccion_orden
tp_preparacion_bulto tp_preparacion_bulto
tp_mover_pallets tp_mover_pallets
end type
end forward

global type rf_orden_preparacion_v2 from window
integer width = 4722
integer height = 2904
boolean titlebar = true
string title = "PREPARACION ORDENES"
boolean resizable = true
windowstate windowstate = maximized!
long backcolor = 67108864
string icon = "AppIcon!"
boolean center = true
pb_salir pb_salir
tab_1 tab_1
end type
global rf_orden_preparacion_v2 rf_orden_preparacion_v2

type variables
string is_tipo_movimiento_salida = '204'
string is_tipo_movimiento_entrada = '205'
long   il_color_fondo_activo,il_color_fondo_inactivo
int    ii_paso_actual = 1
long   il_orden_carga_preparo,il_orden_preparacion_preparo
boolean ib_ubicar_tras_preparar = false
string is_almacen_maquina = '10',is_zona_maquina = 'Z01'
int    ii_fila_maquina = 1,ii_altura_maquina = 1
end variables

on rf_orden_preparacion_v2.create
this.pb_salir=create pb_salir
this.tab_1=create tab_1
this.Control[]={this.pb_salir,&
this.tab_1}
end on

on rf_orden_preparacion_v2.destroy
destroy(this.pb_salir)
destroy(this.tab_1)
end on

event open;il_color_fondo_activo   = tab_1.tp_preparacion_bulto.st_paso1_2.backcolor
il_color_fondo_inactivo = tab_1.tp_preparacion_bulto.st_paso2_2.backcolor

tab_1.tp_seleccion_orden.dw_seleccion_orden.settransobject(sqlca)
tab_1.tp_seleccion_orden.dw_seleccion_orden.retrieve(codigo_empresa,nombre_usuario)

tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.settransobject(sqlca)
tab_1.tp_preparacion_bulto.dw_seleccion_tipo_pallet_preparacion.settransobject(sqlca)

tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.settransobject(sqlca)

tab_1.tp_preparacion_bulto.uo_lectura_destino_2.SetFocus()
tab_1.tp_preparacion_bulto.uo_lectura_destino_2.event getfocus()
end event

type pb_salir from picturebutton within rf_orden_preparacion_v2
integer x = 4320
integer width = 357
integer height = 316
integer taborder = 20
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\RF\salir.png"
string disabledname = "C:\bmp\RF\salir_dis.tif"
alignment htextalign = left!
end type

event clicked;close(parent)
end event

type tab_1 from tab within rf_orden_preparacion_v2
event create ( )
event destroy ( )
integer width = 4681
integer height = 2796
integer taborder = 30
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 67108864
boolean raggedright = true
boolean focusonbuttondown = true
integer selectedtab = 1
tp_seleccion_orden tp_seleccion_orden
tp_preparacion_bulto tp_preparacion_bulto
tp_mover_pallets tp_mover_pallets
end type

on tab_1.create
this.tp_seleccion_orden=create tp_seleccion_orden
this.tp_preparacion_bulto=create tp_preparacion_bulto
this.tp_mover_pallets=create tp_mover_pallets
this.Control[]={this.tp_seleccion_orden,&
this.tp_preparacion_bulto,&
this.tp_mover_pallets}
end on

on tab_1.destroy
destroy(this.tp_seleccion_orden)
destroy(this.tp_preparacion_bulto)
destroy(this.tp_mover_pallets)
end on

event selectionchanged;choose case newindex
	case 1
		tab_1.tp_seleccion_orden.dw_seleccion_orden.retrieve(codigo_empresa,nombre_usuario)
	case 2
		tab_1.tp_preparacion_bulto.uo_lectura_destino_2.SetFocus()
		tab_1.tp_preparacion_bulto.uo_lectura_destino_2.event getfocus()					
	case 3
		tab_1.tp_mover_pallets.uo_lectura_origen_3.SetFocus()
		tab_1.tp_mover_pallets.uo_lectura_origen_3.event getfocus()			
end choose
end event

type tp_seleccion_orden from userobject within tab_1
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 4645
integer height = 2668
long backcolor = 67108864
string text = "Selección Orden"
long tabtextcolor = 33554432
long picturemaskcolor = 536870912
pb_bajar pb_bajar
pb_subir pb_subir
pb_1 pb_1
dw_seleccion_orden dw_seleccion_orden
r_barra r_barra
r_indicador r_indicador
end type

on tp_seleccion_orden.create
this.pb_bajar=create pb_bajar
this.pb_subir=create pb_subir
this.pb_1=create pb_1
this.dw_seleccion_orden=create dw_seleccion_orden
this.r_barra=create r_barra
this.r_indicador=create r_indicador
this.Control[]={this.pb_bajar,&
this.pb_subir,&
this.pb_1,&
this.dw_seleccion_orden,&
this.r_barra,&
this.r_indicador}
end on

on tp_seleccion_orden.destroy
destroy(this.pb_bajar)
destroy(this.pb_subir)
destroy(this.pb_1)
destroy(this.dw_seleccion_orden)
destroy(this.r_barra)
destroy(this.r_indicador)
end on

type pb_bajar from picturebutton within tp_seleccion_orden
integer x = 3392
integer y = 2240
integer width = 439
integer height = 368
integer taborder = 40
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\down.bmp"
alignment htextalign = left!
end type

event clicked;if tab_1.tp_seleccion_orden.dw_seleccion_orden.getrow() < tab_1.tp_seleccion_orden.dw_seleccion_orden.rowcount() then
	tab_1.tp_seleccion_orden.dw_seleccion_orden.setrow(tab_1.tp_seleccion_orden.dw_seleccion_orden.getrow() +1)
else
	tab_1.tp_seleccion_orden.dw_seleccion_orden.setrow(1)
end if


end event

type pb_subir from picturebutton within tp_seleccion_orden
integer x = 3392
integer width = 439
integer height = 368
integer taborder = 30
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\up.bmp"
alignment htextalign = left!
end type

event clicked;if tab_1.tp_seleccion_orden.dw_seleccion_orden.getrow() > 1 then
	tab_1.tp_seleccion_orden.dw_seleccion_orden.setrow(tab_1.tp_seleccion_orden.dw_seleccion_orden.getrow() -1)
else
	tab_1.tp_seleccion_orden.dw_seleccion_orden.setrow(tab_1.tp_seleccion_orden.dw_seleccion_orden.rowcount())
end if
end event

type pb_1 from picturebutton within tp_seleccion_orden
integer x = 3840
integer y = 1908
integer width = 800
integer height = 700
integer taborder = 80
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\RF\db-Post.png"
string disabledname = "C:\bmp\RF\db-Post_dis.png"
alignment htextalign = left!
end type

event clicked;if dw_seleccion_orden.getrow() > 0 then
	if tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.retrieve(codigo_empresa,tab_1.tp_seleccion_orden.dw_seleccion_orden.object.alm_orden_preparacion_id[dw_seleccion_orden.getrow()]) > 0 then
		il_orden_carga_preparo       = tab_1.tp_seleccion_orden.dw_seleccion_orden.object.alm_orden_carga_id[dw_seleccion_orden.getrow()]
		il_orden_preparacion_preparo = tab_1.tp_seleccion_orden.dw_seleccion_orden.object.alm_orden_preparacion_id[dw_seleccion_orden.getrow()]
		tab_1.SelectTab(2)
	else
		if tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.retrieve(codigo_empresa,tab_1.tp_seleccion_orden.dw_seleccion_orden.object.alm_orden_preparacion_id[dw_seleccion_orden.getrow()]) > 0 then
			il_orden_carga_preparo       = tab_1.tp_seleccion_orden.dw_seleccion_orden.object.alm_orden_carga_id[dw_seleccion_orden.getrow()]
			il_orden_preparacion_preparo = tab_1.tp_seleccion_orden.dw_seleccion_orden.object.alm_orden_preparacion_id[dw_seleccion_orden.getrow()]
			tab_1.SelectTab(3)
		else
			messagebox("Error","Ha marcado una orden de preparación sin lineas")
			il_orden_carga_preparo       = 0
			il_orden_preparacion_preparo = 0	
		end if
	end if
else	
	messagebox("Error","No ha marcado ninguna orden de preparación")
	il_orden_carga_preparo       = 0
	il_orden_preparacion_preparo = 0		
end if
end event

type dw_seleccion_orden from u_datawindow within tp_seleccion_orden
integer width = 3383
integer height = 2608
integer taborder = 11
string dataobject = "dw_rf_orden_preparacion_1"
end type

event retrieveend;call super::retrieveend;//r_barra.y = r_indicador.y

this.setrow(1)
end event

event rowfocuschanged;call super::rowfocuschanged;long ll_alto_total,ll_nueva_posicion

this.selectrow(0,false)

if currentrow > 0 then
	if currentrow = 1 then
		r_indicador.y = r_barra.y
	else
		ll_alto_total =  r_barra.height - r_indicador.height
	
		ll_nueva_posicion = (ll_alto_total / this.rowcount()) * currentrow
		
		r_indicador.y = r_barra.y + ll_nueva_posicion
	end if
	
	this.selectrow(currentrow,true)
	this.scrolltorow(currentrow)
else
	r_barra.y = r_indicador.y	
end if
end event

type r_barra from rectangle within tp_seleccion_orden
integer linethickness = 4
long fillcolor = 12632256
integer x = 3397
integer y = 372
integer width = 430
integer height = 1864
end type

type r_indicador from rectangle within tp_seleccion_orden
integer linethickness = 4
long fillcolor = 8421504
integer x = 3397
integer y = 372
integer width = 430
integer height = 168
end type

type tp_preparacion_bulto from userobject within tab_1
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 4645
integer height = 2668
long backcolor = 67108864
string text = "Preparación Bulto"
long tabtextcolor = 33554432
long picturemaskcolor = 536870912
dw_seleccion_tipo_pallet_preparacion dw_seleccion_tipo_pallet_preparacion
st_ubicar_indicador3 st_ubicar_indicador3
st_preparar_indicador3 st_preparar_indicador3
em_piezas_2 em_piezas_2
em_cajas_2 em_cajas_2
em_pallets_2 em_pallets_2
st_piezas_2 st_piezas_2
st_cajas_2 st_cajas_2
st_pallets_2 st_pallets_2
p_bajar2 p_bajar2
p_subir2 p_subir2
st_paso3_2 st_paso3_2
dw_lineas_picos_orden_2 dw_lineas_picos_orden_2
pb_aceptar_2 pb_aceptar_2
pb_atras_2 pb_atras_2
uo_lectura_destino_2 uo_lectura_destino_2
uo_lectura_origen_2 uo_lectura_origen_2
st_paso2_2 st_paso2_2
st_paso1_2 st_paso1_2
r_barra2 r_barra2
r_indicador2 r_indicador2
end type

on tp_preparacion_bulto.create
this.dw_seleccion_tipo_pallet_preparacion=create dw_seleccion_tipo_pallet_preparacion
this.st_ubicar_indicador3=create st_ubicar_indicador3
this.st_preparar_indicador3=create st_preparar_indicador3
this.em_piezas_2=create em_piezas_2
this.em_cajas_2=create em_cajas_2
this.em_pallets_2=create em_pallets_2
this.st_piezas_2=create st_piezas_2
this.st_cajas_2=create st_cajas_2
this.st_pallets_2=create st_pallets_2
this.p_bajar2=create p_bajar2
this.p_subir2=create p_subir2
this.st_paso3_2=create st_paso3_2
this.dw_lineas_picos_orden_2=create dw_lineas_picos_orden_2
this.pb_aceptar_2=create pb_aceptar_2
this.pb_atras_2=create pb_atras_2
this.uo_lectura_destino_2=create uo_lectura_destino_2
this.uo_lectura_origen_2=create uo_lectura_origen_2
this.st_paso2_2=create st_paso2_2
this.st_paso1_2=create st_paso1_2
this.r_barra2=create r_barra2
this.r_indicador2=create r_indicador2
this.Control[]={this.dw_seleccion_tipo_pallet_preparacion,&
this.st_ubicar_indicador3,&
this.st_preparar_indicador3,&
this.em_piezas_2,&
this.em_cajas_2,&
this.em_pallets_2,&
this.st_piezas_2,&
this.st_cajas_2,&
this.st_pallets_2,&
this.p_bajar2,&
this.p_subir2,&
this.st_paso3_2,&
this.dw_lineas_picos_orden_2,&
this.pb_aceptar_2,&
this.pb_atras_2,&
this.uo_lectura_destino_2,&
this.uo_lectura_origen_2,&
this.st_paso2_2,&
this.st_paso1_2,&
this.r_barra2,&
this.r_indicador2}
end on

on tp_preparacion_bulto.destroy
destroy(this.dw_seleccion_tipo_pallet_preparacion)
destroy(this.st_ubicar_indicador3)
destroy(this.st_preparar_indicador3)
destroy(this.em_piezas_2)
destroy(this.em_cajas_2)
destroy(this.em_pallets_2)
destroy(this.st_piezas_2)
destroy(this.st_cajas_2)
destroy(this.st_pallets_2)
destroy(this.p_bajar2)
destroy(this.p_subir2)
destroy(this.st_paso3_2)
destroy(this.dw_lineas_picos_orden_2)
destroy(this.pb_aceptar_2)
destroy(this.pb_atras_2)
destroy(this.uo_lectura_destino_2)
destroy(this.uo_lectura_origen_2)
destroy(this.st_paso2_2)
destroy(this.st_paso1_2)
destroy(this.r_barra2)
destroy(this.r_indicador2)
end on

type dw_seleccion_tipo_pallet_preparacion from datawindow within tp_preparacion_bulto
boolean visible = false
integer y = 316
integer width = 4645
integer height = 2352
integer taborder = 40
string title = "SELECCIONE EL TIPO DE PALLET"
string dataobject = "dw_rf_orden_preparacion_4"
boolean livescroll = true
end type

event clicked;
if row > 0 then
	uo_lectura_destino_2.is_codigo_pallet = this.object.codigo[row]
	
	this.visible = false
	
	uo_lectura_origen_2.SetFocus()
	uo_lectura_origen_2.event getfocus()	
end if
end event

type st_ubicar_indicador3 from statictext within tp_preparacion_bulto
integer x = 978
integer y = 2472
integer width = 2702
integer height = 196
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 32768
string text = "Ubicar"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

event clicked;window lw_ventana 
str_parametros lstr_param 

string ls_tipo_ventana
long   ll_rf_parametros_ventanas_id = 11

if tab_1.tp_preparacion_bulto.uo_lectura_destino_2.il_id_bulto <> 0 then		
	
	ls_tipo_ventana = f_rf_parametros_ventanas_tipo_ventana(ll_rf_parametros_ventanas_id)
	
	lstr_param.i_nargumentos   = 3
	lstr_param.s_argumentos[2] = string(ll_rf_parametros_ventanas_id)
	lstr_param.s_argumentos[3] = string(tab_1.tp_preparacion_bulto.uo_lectura_destino_2.sle_codbar.text) 
	
	OpenWithParm(lw_ventana, lstr_param , ls_tipo_ventana)	
				
	//Esto no funciona 			
	//parent.Hide()					
	lw_ventana.show()					
	//					

end if
end event

type st_preparar_indicador3 from statictext within tp_preparacion_bulto
integer x = 978
integer y = 1972
integer width = 2702
integer height = 168
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24011603
boolean enabled = false
string text = "Preparar"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type em_piezas_2 from editmask within tp_preparacion_bulto
event clicked pbm_bnclicked
integer x = 2871
integer y = 2300
integer width = 805
integer height = 168
integer taborder = 140
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "0"
alignment alignment = center!
boolean displayonly = true
borderstyle borderstyle = stylelowered!
string mask = "######0"
boolean autoskip = true
double increment = 1
string minmax = "0~~9999"
end type

event getfocus;this.SelectText(1,len(this.text))
end event

event losefocus;this.event modified()
end event

event modified;string cadena,ls_articulos_unidad,ls_codigo_articulo,ls_codigo_caja,ls_m2 
dec    ld_metroscaja,ld_m2
int    posi_aux,posi,li_piezas,li_piezascaja

//Control de rango
string ls_minmax,ls_min,ls_max
long   ll_min,ll_max,ll_pos,ll_valor,ll_nuevo_valor

ls_minmax = this.minmax

ll_pos = pos(ls_minmax,"~~")
if ll_pos > 0 then
	ls_min = mid(ls_minmax,1,ll_pos -1)
	ls_max = mid(ls_minmax,ll_pos +1,len(ls_minmax)- ll_pos)
	
	ll_min = long(ls_min)
	ll_max = long(ls_max)
else
	ll_min = 0
	ll_max = 0
end if

ll_valor = long(this.text)

if ll_valor > ll_max then
	this.text = string(0,this.mask)
	messagebox("Error de datos","No se puede realizar un movimiento de cantidad superior a "+string(ll_max)+" Pzs")
else
	if ll_valor < ll_min then
		this.text = string(0,this.mask)		
		messagebox("Error de datos","No se puede realizar un movimiento de cantidad inferior a "+string(ll_min)+" Pzs")
	end if	
end if
//Fin de control de rango

if integer(this.text) > 0 then
	li_piezas = dec(this.text)
	
	ls_codigo_articulo = uo_lectura_origen_2.is_codigo_articulo
	ls_codigo_caja     = uo_lectura_origen_2.is_codigo_caja
	
	SELECT isnull(articulos.unidad,''),
			 isnull(almartcajas.metroscaja,0), 
			 isnull(almartcajas.piezascaja,0) 
	INTO   :ls_articulos_unidad,
			 :ld_metroscaja,
			 :li_piezascaja
	FROM   articulos,almartcajas 
	WHERE  almartcajas.empresa  = articulos.empresa 
	AND    almartcajas.articulo = articulos.codigo 
	AND    almartcajas.empresa  = :codigo_empresa 
	AND    almartcajas.articulo = :ls_codigo_articulo 
	AND    almartcajas.caja     = :ls_codigo_caja;
	
	if ls_articulos_unidad = '1' then
		ld_m2 = (li_piezas / li_piezascaja) * ld_metroscaja
		
		cadena = f_calculo_unidades_piezas(codigo_empresa,uo_lectura_origen_2.is_codigo_articulo,&
										  uo_lectura_origen_2.is_codigo_pallet,&
										  uo_lectura_origen_2.is_codigo_caja,&
										  0,&
										  0,ld_m2, "")
	else
		cadena = f_calculo_unidades_piezas(codigo_empresa,uo_lectura_origen_2.is_codigo_articulo,&
										  uo_lectura_origen_2.is_codigo_pallet,&
										  uo_lectura_origen_2.is_codigo_caja,&
										  0,&
										  0,li_piezas, "")
	end if
								 
	//Pallets
	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		em_pallets_2.text     = Mid(cadena,1,posi - 1)
		posi_aux = posi + 1
	end if
	//Cajas de pico
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		//em_cajas_2.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Total cajas
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cajas_2.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Metros Lineales
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		if uo_lectura_origen_2.ib_ubicacion_gestionada_en_piezas then
			em_piezas_2.text      = string(li_piezas)
		else
			em_piezas_2.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
			posi_aux = posi + 1
		end if
	end if
else
	em_pallets_2.text     = "0"
	em_cajas_2.text       = "0"
end if
end event

type em_cajas_2 from editmask within tp_preparacion_bulto
event clicked pbm_bnclicked
integer x = 1938
integer y = 2300
integer width = 805
integer height = 168
integer taborder = 130
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "0"
alignment alignment = center!
boolean displayonly = true
borderstyle borderstyle = stylelowered!
string mask = "######0"
boolean autoskip = true
double increment = 1
string minmax = "0~~9999"
end type

event getfocus;this.SelectText(1,len(this.text))
end event

event losefocus;this.event modified()
end event

event modified;string cadena 
int    posi_aux,posi

//Control de rango
string ls_minmax,ls_min,ls_max
long   ll_min,ll_max,ll_pos,ll_valor,ll_nuevo_valor

ls_minmax = this.minmax

ll_pos = pos(ls_minmax,"~~")
if ll_pos > 0 then
	ls_min = mid(ls_minmax,1,ll_pos -1)
	ls_max = mid(ls_minmax,ll_pos +1,len(ls_minmax)- ll_pos)
	
	ll_min = long(ls_min)
	ll_max = long(ls_max)
else
	ll_min = 0
	ll_max = 0
end if

ll_valor = long(this.text)

if ll_valor > ll_max then
	this.text = string(0,this.mask)
	messagebox("Error de datos","No se puede realizar un movimiento de cantidad superior a "+string(ll_max)+" Cajas")
else
	if ll_valor < ll_min then
		this.text = string(0,this.mask)		
		messagebox("Error de datos","No se puede realizar un movimiento de cantidad inferior a "+string(ll_min)+" Cajas")
	end if	
end if
//Fin de control de rango

if integer(this.text) > 0 then
	cadena = f_calculo_unidades_piezas(codigo_empresa,uo_lectura_origen_2.is_codigo_articulo,&
									  uo_lectura_origen_2.is_codigo_pallet,&
									  uo_lectura_origen_2.is_codigo_caja,&
									  0,&
									  integer(this.text),0, "")
								 
	//Pallets
	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		em_pallets_2.text     = Mid(cadena,1,posi - 1)
		posi_aux = posi + 1
	end if
	//Cajas de pico
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		//em_cajas_2.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Total cajas
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cajas_2.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Metros Lineales
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_piezas_2.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
else
	em_pallets_2.text     = "0"
	em_piezas_2.text      = "0"
end if
end event

type em_pallets_2 from editmask within tp_preparacion_bulto
event clicked pbm_bnclicked
integer x = 978
integer y = 2300
integer width = 805
integer height = 168
integer taborder = 120
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "0"
alignment alignment = center!
boolean displayonly = true
borderstyle borderstyle = stylelowered!
string mask = "0"
boolean autoskip = true
double increment = 1
string minmax = "0~~1"
end type

event clicked;this.event modified()
end event

event getfocus;this.SelectText(1,len(this.text))
end event

event losefocus;this.event modified()
end event

event modified;string cadena
int    posi_aux,posi

//Control de rango
string ls_minmax,ls_min,ls_max
long   ll_min,ll_max,ll_pos,ll_valor,ll_nuevo_valor

ls_minmax = this.minmax

ll_pos = pos(ls_minmax,"~~")
if ll_pos > 0 then
	ls_min = mid(ls_minmax,1,ll_pos -1)
	ls_max = mid(ls_minmax,ll_pos +1,len(ls_minmax)- ll_pos)
	
	ll_min = long(ls_min)
	ll_max = long(ls_max)
else
	ll_min = 0
	ll_max = 0
end if

ll_valor = long(this.text)

if ll_valor > ll_max then
	this.text = string(0,this.mask)
else
	if ll_valor < ll_min then
		this.text = string(0,this.mask)		
	end if	
end if
//Fin de control de rango

if integer(this.text) > 0 then
	
	cadena = f_calculo_unidades_piezas(codigo_empresa,uo_lectura_origen_2.is_codigo_articulo,&
									  uo_lectura_origen_2.is_codigo_pallet,&
									  uo_lectura_origen_2.is_codigo_caja,&
									  integer(this.text),&
									  0,0, "")
								 
	//Pallets
	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		em_pallets_2.text     = Mid(cadena,1,posi - 1)
		posi_aux = posi + 1
	end if
	//Cajas de pico
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		//em_cajas_2.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Total cajas
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cajas_2.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Metros Lineales
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_piezas_2.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
else
	em_cajas_2.text       = "0"
	em_piezas_2.text      = "0"
end if
end event

type st_piezas_2 from statictext within tp_preparacion_bulto
integer x = 2871
integer y = 2136
integer width = 809
integer height = 168
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24011603
string text = "Piezas"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_cajas_2 from statictext within tp_preparacion_bulto
integer x = 1938
integer y = 2136
integer width = 809
integer height = 168
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24011603
string text = "Cajas"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_pallets_2 from statictext within tp_preparacion_bulto
integer x = 978
integer y = 2132
integer width = 809
integer height = 168
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24011603
boolean enabled = false
string text = "Pallets"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type p_bajar2 from picturebutton within tp_preparacion_bulto
integer x = 4352
integer y = 1740
integer width = 274
integer height = 224
integer taborder = 50
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\down.bmp"
string disabledname = "C:\bmp\down.bmp"
alignment htextalign = left!
end type

event clicked;if tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow() < tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.rowcount() then
	tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.setrow(tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow() +1)
else
	tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.setrow(1)
end if

end event

type p_subir2 from picturebutton within tp_preparacion_bulto
integer x = 4352
integer y = 1252
integer width = 274
integer height = 224
integer taborder = 40
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\up.bmp"
string disabledname = "C:\bmp\up.bmp"
alignment htextalign = left!
end type

event clicked;if tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow() > 1 then
	tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.setrow(tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow() -1)
else
	tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.setrow(tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.rowcount())
end if
end event

type st_paso3_2 from statictext within tp_preparacion_bulto
boolean visible = false
integer x = 2917
integer y = 4
integer width = 1403
integer height = 144
integer textsize = -20
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 67108864
string text = "Ubicar"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type dw_lineas_picos_orden_2 from u_datawindow within tp_preparacion_bulto
integer y = 1252
integer width = 4347
integer height = 712
integer taborder = 11
string dataobject = "dw_rf_orden_preparacion_2"
end type

event rowfocuschanged;call super::rowfocuschanged;long ll_alto_total,ll_nueva_posicion

this.selectrow(0,false)

if currentrow > 0 then
	if currentrow = 1 then
		r_indicador2.y = r_barra2.y
	else
		ll_alto_total =  r_barra2.height - r_indicador2.height
	
		ll_nueva_posicion = (ll_alto_total / this.rowcount()) * currentrow
		
		r_indicador2.y = r_barra2.y + ll_nueva_posicion
	end if
	
	tab_1.tp_preparacion_bulto.em_pallets_2.text = "0"
	tab_1.tp_preparacion_bulto.em_cajas_2.text   = string(this.object.cajas[currentrow],tab_1.tp_preparacion_bulto.em_cajas_2.mask)
	tab_1.tp_preparacion_bulto.em_piezas_2.text  = string(this.object.venliped_reservas_cantidad[currentrow],tab_1.tp_preparacion_bulto.em_piezas_2.mask)
	
	this.selectrow(currentrow,true)
	this.scrolltorow(currentrow)
else
	tab_1.tp_preparacion_bulto.em_pallets_2.text = "0"
	tab_1.tp_preparacion_bulto.em_cajas_2.text   = "0"
	tab_1.tp_preparacion_bulto.em_piezas_2.text  = "0"
	
	r_barra2.y = r_indicador2.y	
end if
end event

event clicked;call super::clicked;string ls_sort,ls_color_blanco,ls_color_negro
long   ll_row_seleccionada,ll_venliped_reservas_alm_bultos_lineas_id

ls_color_blanco = string(rgb(255,255,255))
ls_color_negro  = string(rgb(0,0,0))

this.modify('nombre_articulo_t.color = '+ls_color_blanco)
this.modify('nombre_formato_t.color = '+ls_color_blanco)
this.modify('almubimapa_codbar_almacen_t.color = '+ls_color_blanco)
this.modify('almubimapa_codbar_zona_t.color = '+ls_color_blanco)
this.modify('almubimapa_codbar_fila_t.color = '+ls_color_blanco)
this.modify('almubimapa_codbar_altura_t.color = '+ls_color_blanco)
this.modify('venliped_pallets_t.color = '+ls_color_blanco)
this.modify('cajas_t.color = '+ls_color_blanco)
this.modify('venliped_reservas_cantidad_t.color = '+ls_color_blanco)

ll_row_seleccionada = this.GetSelectedRow(0)

if ll_row_seleccionada > 0 then
	ll_venliped_reservas_alm_bultos_lineas_id = this.object.venliped_reservas_alm_bultos_lineas_id[ll_row_seleccionada]
end if

choose case dwo.name
	case 'nombre_articulo_t','nombre_formato_t'
		ls_sort = 'nombre_formato A,articulos_descripcion A,venped_anyo A,venped_pedido A,venliped_linea A,distancia A'		
		
		this.setsort(ls_sort)
		this.sort()
		
		this.modify('nombre_articulo_t.color = '+ls_color_negro)
		this.modify('nombre_formato_t.color = '+ls_color_negro)
	case 'almubimapa_codbar_almacen_t','almubimapa_codbar_zona_t','almubimapa_codbar_fila_t','almubimapa_codbar_altura_t'
		ls_sort = 'distancia A'
		
		this.setsort(ls_sort)
		this.sort()		
		
		this.modify('almubimapa_codbar_almacen_t.color = '+ls_color_negro)
		this.modify('almubimapa_codbar_zona_t.color = '+ls_color_negro)
		this.modify('almubimapa_codbar_fila_t.color = '+ls_color_negro)
		this.modify('almubimapa_codbar_altura_t.color = '+ls_color_negro)		
		
	case 'venliped_pallets_t','cajas_t','venliped_reservas_cantidad_t'
		ls_sort = 'cajas D,venliped_reservas_cantidad D,distancia A'
		
		this.setsort(ls_sort)
		this.sort()
		
		this.modify('venliped_pallets_t.color = '+ls_color_negro)
		this.modify('cajas_t.color = '+ls_color_negro)
		this.modify('venliped_reservas_cantidad_t.color = '+ls_color_negro)		
		
end choose

if ll_row_seleccionada > 0 then
	ll_row_seleccionada = this.find('venliped_reservas_alm_bultos_lineas_id = '+string(ll_venliped_reservas_alm_bultos_lineas_id),1,this.rowcount())
	
	if ll_row_seleccionada > 0 then
		this.selectrow(0,false)
		this.selectrow(ll_row_seleccionada,true)
		this.setrow(ll_row_seleccionada)
	end if
end if

choose case ii_paso_actual 
	case 1
		uo_lectura_destino_2.SetFocus()
		uo_lectura_destino_2.event getfocus()					
	case 2
		uo_lectura_origen_2.SetFocus()
		uo_lectura_origen_2.event getfocus()				
	case else
		uo_lectura_destino_2.SetFocus()
		uo_lectura_destino_2.event getfocus()							
end choose
end event

type pb_aceptar_2 from picturebutton within tp_preparacion_bulto
integer x = 3831
integer y = 1968
integer width = 800
integer height = 700
integer taborder = 70
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\RF\db-Post.png"
string disabledname = "C:\bmp\RF\db-Post_dis.png"
alignment htextalign = left!
end type

event clicked;str_movimiento_almacen lstr_movimiento_almacen
str_venliped_reservas lstr_venliped_reservas
str_venliped_reservas_ubi_orig lstr_venliped_reservas_ubi_orig

long    ll_indice,ll_total,ll_piezas_traspaso
boolean lb_correcto = true,lb_cerrar = false
integer li_pallets_reflejados_en_pedido

ll_total  = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.ii_lineas_bulto

if tab_1.tp_preparacion_bulto.uo_lectura_origen_2.ii_bultos = 1 and tab_1.tp_preparacion_bulto.uo_lectura_origen_2.ii_indice_lineas_bulto > 0 and tab_1.tp_preparacion_bulto.uo_lectura_destino_2.ii_bultos = 1 then
	if tab_1.tp_preparacion_bulto.uo_lectura_origen_2.il_id_bulto <> tab_1.tp_preparacion_bulto.uo_lectura_destino_2.il_id_bulto then
		if long(em_piezas_2.text) > 0 then
			
			lstr_venliped_reservas.anyo                 = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.object.venped_anyo[tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow()]
			lstr_venliped_reservas.pedido               = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.object.venped_pedido[tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow()]
			lstr_venliped_reservas.linea                = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.object.venliped_linea[tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow()]
			lstr_venliped_reservas.alm_bultos_lineas_id = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.object.venliped_reservas_alm_bultos_lineas_id[tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow()]
			
			if f_cargar_str_venliped_reservas(codigo_empresa,lstr_venliped_reservas.anyo,lstr_venliped_reservas.pedido,lstr_venliped_reservas.linea,lstr_venliped_reservas.alm_bultos_lineas_id,lstr_venliped_reservas) then
				lstr_venliped_reservas_ubi_orig.empresa               = lstr_venliped_reservas.empresa
				lstr_venliped_reservas_ubi_orig.anyo                  = lstr_venliped_reservas.anyo
				lstr_venliped_reservas_ubi_orig.pedido                = lstr_venliped_reservas.pedido
				lstr_venliped_reservas_ubi_orig.linea                 = lstr_venliped_reservas.linea
				lstr_venliped_reservas_ubi_orig.alm_bultos_lineas_id  = lstr_venliped_reservas.alm_bultos_lineas_id
				lstr_venliped_reservas_ubi_orig.cantidad              = lstr_venliped_reservas.cantidad
				lstr_venliped_reservas_ubi_orig.id_ubicacion_original = lstr_venliped_reservas.id_ubicacion_original
				lstr_venliped_reservas_ubi_orig.alm_bultos_id         = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.il_id_bulto
				lstr_venliped_reservas_ubi_orig.id_ubicacion_destino  = lstr_venliped_reservas.id_ubicacion_destino 
				
				if not(f_insert_str_venliped_reservas_ubi_orig(lstr_venliped_reservas_ubi_orig)) then
					messagebox("¡Error!","Se ha producido un error al guardar las ubicaciones originales de la O.C.")
					lb_correcto = false				
				end if
			else
				messagebox("¡Error!","Se ha producido un error al guardar las ubicaciones originales de la O.C.")
				lb_correcto = false
			end if			
			
			ll_piezas_traspaso = long(tab_1.tp_preparacion_bulto.em_piezas_2.text)
			
			if tab_1.tp_preparacion_bulto.uo_lectura_origen_2.ii_anyo_orden_carga = tab_1.tp_preparacion_bulto.uo_lectura_destino_2.ii_anyo_orden_carga and tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_orden_carga = tab_1.tp_preparacion_bulto.uo_lectura_destino_2.is_orden_carga then
				lstr_movimiento_almacen.empresa            = codigo_empresa
				lstr_movimiento_almacen.articulo           = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_codigo_articulo
				lstr_movimiento_almacen.calidad            = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_codigo_calidad
				lstr_movimiento_almacen.tono               = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_lote
				lstr_movimiento_almacen.calibre            = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.ii_calibre
				lstr_movimiento_almacen.tipo_pallet        = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_codigo_pallet
				lstr_movimiento_almacen.caja               = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_codigo_caja
				lstr_movimiento_almacen.cantidad           = -1 * ll_piezas_traspaso //( uo_lectura_origen_2.il_piezas )
				lstr_movimiento_almacen.orden_carga_anyo   = 0
				lstr_movimiento_almacen.orden_carga_codigo = ""
				lstr_movimiento_almacen.orden_carga_linea  = 0
				lstr_movimiento_almacen.tipo_movimiento    = is_tipo_movimiento_salida
				lstr_movimiento_almacen.observaciones      = ""
				lstr_movimiento_almacen.almacen            = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_almacen
				lstr_movimiento_almacen.zona               = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_zona
				lstr_movimiento_almacen.fila               = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.ii_fila
				lstr_movimiento_almacen.altura             = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.ii_altura
				lstr_movimiento_almacen.tercero            = ""
				lstr_movimiento_almacen.documento          = ""
				lstr_movimiento_almacen.fecha              = datetime(today())
				lstr_movimiento_almacen.id_ubicacion       = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.il_id_ubicacion
				lstr_movimiento_almacen.id_alm_bultos		 = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.il_id_bulto
				lstr_movimiento_almacen.venliped_anyo      = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.object.venped_anyo[tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow()]
				lstr_movimiento_almacen.venliped_pedido    = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.object.venped_pedido[tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow()]
				lstr_movimiento_almacen.venliped_linea     = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.object.venliped_linea[tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow()]
							
				if f_movimiento_almacen(lstr_movimiento_almacen) then
					//Si el bulto de destino no tiene una ubicacion definida(Es un bulto nuevo)
					//Le asignamos la ubicacion del bulto de origen
					
					lstr_movimiento_almacen.empresa            = codigo_empresa
					lstr_movimiento_almacen.articulo           = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_codigo_articulo
					lstr_movimiento_almacen.calidad            = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_codigo_calidad
					lstr_movimiento_almacen.tono               = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_lote
					lstr_movimiento_almacen.calibre            = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.ii_calibre
					if tab_1.tp_preparacion_bulto.uo_lectura_destino_2.ib_ubicacion_con_bulto_asociado then
						//Si el destino tiene bulto asociado le asociamos al movimiento de entrada el tipo de pallet de este
						lstr_movimiento_almacen.tipo_pallet = tab_1.tp_preparacion_bulto.uo_lectura_destino_2.is_codigo_pallet
					else
						lstr_movimiento_almacen.tipo_pallet = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_codigo_pallet
					end if
					lstr_movimiento_almacen.caja               = tab_1.tp_preparacion_bulto.uo_lectura_origen_2.is_codigo_caja
					lstr_movimiento_almacen.cantidad           = ll_piezas_traspaso
					lstr_movimiento_almacen.orden_carga_anyo   = 0
					lstr_movimiento_almacen.orden_carga_codigo = ""
					lstr_movimiento_almacen.orden_carga_linea  = 0
					lstr_movimiento_almacen.tipo_movimiento    = is_tipo_movimiento_entrada
					lstr_movimiento_almacen.observaciones      = ""
					if tab_1.tp_preparacion_bulto.uo_lectura_destino_2.il_id_ubicacion > 0 then
						lstr_movimiento_almacen.almacen         = tab_1.tp_preparacion_bulto.uo_lectura_destino_2.is_almacen
						lstr_movimiento_almacen.zona            = tab_1.tp_preparacion_bulto.uo_lectura_destino_2.is_zona
						lstr_movimiento_almacen.fila            = tab_1.tp_preparacion_bulto.uo_lectura_destino_2.ii_fila
						lstr_movimiento_almacen.altura          = tab_1.tp_preparacion_bulto.uo_lectura_destino_2.ii_altura
					else
						//Por defecto la ubicacion asignada a la carretilla
						lstr_movimiento_almacen.almacen         = is_almacen_maquina
						lstr_movimiento_almacen.zona            = is_zona_maquina
						lstr_movimiento_almacen.fila            = ii_fila_maquina
						lstr_movimiento_almacen.altura          = ii_altura_maquina						
					end if
					lstr_movimiento_almacen.tercero            = ""
					lstr_movimiento_almacen.documento          = ""
					lstr_movimiento_almacen.fecha              = datetime(today())
					if tab_1.tp_preparacion_bulto.uo_lectura_destino_2.il_id_ubicacion > 0 then
						lstr_movimiento_almacen.id_ubicacion    = tab_1.tp_preparacion_bulto.uo_lectura_destino_2.il_id_ubicacion
					else
						lstr_movimiento_almacen.id_ubicacion    = 0
					end if
					lstr_movimiento_almacen.id_alm_bultos		 = tab_1.tp_preparacion_bulto.uo_lectura_destino_2.il_id_bulto
					lstr_movimiento_almacen.venliped_anyo      = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.object.venped_anyo[tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow()]
					lstr_movimiento_almacen.venliped_pedido    = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.object.venped_pedido[tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow()]
					lstr_movimiento_almacen.venliped_linea     = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.object.venliped_linea[tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.getrow()]					
					
					if f_movimiento_almacen(lstr_movimiento_almacen) then
			
					else
						lb_correcto = false					
					end if
				else
					lb_correcto = false
				end if	
			
				//Vamos a chequear si ya hay pallet en las lineas del bulto
				SELECT sum(isnull(venliped.pallets,0))
				INTO   :li_pallets_reflejados_en_pedido
				FROM   venliped,   
						 venliped_reservas,   
						 alm_bultos,   
						 alm_bultos_lineas  
				WHERE ( venliped.empresa                       = venliped_reservas.empresa ) 
				and   ( venliped.anyo                          = venliped_reservas.anyo ) 
				and   ( venliped.pedido                        = venliped_reservas.pedido ) 
				and   ( venliped.linea                         = venliped_reservas.linea ) 
				and   ( alm_bultos_lineas.id_alm_bultos        = alm_bultos.id ) 
				and   ( venliped_reservas.alm_bultos_lineas_id = alm_bultos_lineas.id ) 
				and ( ( alm_bultos.id                          = :tab_1.tp_preparacion_bulto.uo_lectura_destino_2.il_id_bulto ) );		
				
				if li_pallets_reflejados_en_pedido = 0 then
					update venliped
					set    venliped.pallets = 1
					where  venliped.empresa = :lstr_venliped_reservas.empresa
					and    venliped.anyo    = :lstr_venliped_reservas.anyo
					and    venliped.pedido  = :lstr_venliped_reservas.pedido
					and    venliped.linea   = :lstr_venliped_reservas.linea;
					
					if sqlca.sqlcode <> 0 then
						lb_correcto = false					
					end if						
				end if
				
				//Indicamos en venliped el tipo de pallet de la preparacion
				update venliped
				set    venliped.tipo_pallet_preparacion = :tab_1.tp_preparacion_bulto.uo_lectura_destino_2.is_codigo_pallet,
						 venliped.operario_prepa          = :nombre_usuario 
				where  venliped.empresa = :lstr_venliped_reservas.empresa
				and    venliped.anyo    = :lstr_venliped_reservas.anyo
				and    venliped.pedido  = :lstr_venliped_reservas.pedido
				and    venliped.linea   = :lstr_venliped_reservas.linea;
				
				if sqlca.sqlcode <> 0 then
					lb_correcto = false					
				end if										
			
				//marcamos la linea como preparada en venliped_reservas
				update venliped_reservas
				set    venliped_reservas.preparado            = 'S'
				from   venliped_reservas,
						 alm_bultos_lineas
				where  venliped_reservas.alm_bultos_lineas_id = alm_bultos_lineas.id
				and    alm_bultos_lineas.id_alm_bultos        = :tab_1.tp_preparacion_bulto.uo_lectura_destino_2.il_id_bulto 
				and    venliped_reservas.empresa              = :lstr_venliped_reservas.empresa
				and    venliped_reservas.anyo                 = :lstr_venliped_reservas.anyo 
				and    venliped_reservas.pedido               = :lstr_venliped_reservas.pedido 
				and    venliped_reservas.linea                = :lstr_venliped_reservas.linea;
				
				if sqlca.sqlcode <> 0 then
					messagebox("¡Error!","Se ha producido un error al actualizar al situacion de la reserva.")
					lb_correcto = false
				end if								
			
				if lb_correcto then
					
					commit;					
					
					update venliped
					set    venliped.situacion = 'P'
					from   venliped,
							 venliped_reservas 
					where  venliped.empresa = venliped_reservas.empresa 
					and    venliped.anyo    = venliped_reservas.anyo 
					and    venliped.pedido  = venliped_reservas.pedido 
					and    venliped.linea   = venliped_reservas.linea 
					and    venliped.situacion <> 'P'
					and    ( select isnull(count(*),0) 
								from   venliped_reservas as venliped_reservas_no_preparadas 
								where  venliped_reservas_no_preparadas.empresa = venliped.empresa
								and    venliped_reservas_no_preparadas.anyo    = venliped.anyo
								and    venliped_reservas_no_preparadas.pedido  = venliped.pedido
								and    venliped_reservas_no_preparadas.linea   = venliped.linea
								and    isnull(venliped_reservas_no_preparadas.preparado,'') <> 'S' ) = 0;
								
					if sqlca.sqlcode <> 0 then
						rollback;
					else
						commit;
					end if														
					
					tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.retrieve(codigo_empresa,il_orden_preparacion_preparo)
					
					tab_1.tp_preparacion_bulto.uo_lectura_origen_2.f_reset() //event ue_refrescar()
					tab_1.tp_preparacion_bulto.uo_lectura_destino_2.event ue_refrescar()
					//
				else
					rollback;
					Messagebox("Error","No se ha generado el movimiento")
				end if			
			else
				//Error por no seleccionar la misma orden de carga
				Messagebox("Error","No se han seleccionado bultos de la misma O.C.")
			end if			
		else
			Messagebox("Error","Debe indicar la cantidad a traspasar")
		end if
			
	else
		//Error al no seleccionar distintos bultos
		Messagebox("Error","No se han seleccionado distintos bultos")
	end if
else
	if tab_1.tp_preparacion_bulto.uo_lectura_origen_2.ii_bultos > 1 then
		Messagebox("Error","Ha seleccionado un origen con mas de un bulto")
	else
		Messagebox("Error","No se ha seleccionado el origen del traspaso")
	end if
end if

if lb_cerrar then
	//close(parent)
else
	tab_1.tp_preparacion_bulto.uo_lectura_origen_2.SetFocus()
	tab_1.tp_preparacion_bulto.uo_lectura_origen_2.event getfocus()
end if
end event

type pb_atras_2 from picturebutton within tp_preparacion_bulto
integer y = 1968
integer width = 800
integer height = 700
integer taborder = 60
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\RF\Back.png"
string disabledname = "C:\bmp\RF\Back_dis.png"
alignment htextalign = left!
end type

event clicked;choose case ii_paso_actual
	case 2
		uo_lectura_destino_2.SetFocus()
		uo_lectura_destino_2.event getfocus()		
	case 3
		uo_lectura_origen_2.SetFocus()
		uo_lectura_origen_2.event getfocus()			
	case else
		uo_lectura_destino_2.SetFocus()
		uo_lectura_destino_2.event getfocus()		
end choose
end event

type uo_lectura_destino_2 from u_sle_codbar within tp_preparacion_bulto
event destroy ( )
integer y = 168
integer height = 152
integer taborder = 50
boolean ib_permitir_desplegar = false
string is_descripcion = "LECTURA DESTINO"
end type

on uo_lectura_destino_2.destroy
call u_sle_codbar::destroy
end on

event getfocus;call super::getfocus;ii_paso_actual = 1

st_paso1_2.backcolor         = il_color_fondo_activo
st_paso2_2.backcolor         = il_color_fondo_inactivo

pb_atras_2.visible           = false
pb_aceptar_2.visible         = false
dw_seleccion_tipo_pallet_preparacion.visible = false
end event

event modified;call super::modified;long ll_donde

if il_id_bulto = 0 then
	f_reset()
	messagebox("¡Atención!","Debe seleccionar un bulto.",StopSign!)
	uo_lectura_destino_2.SetFocus()
	uo_lectura_destino_2.event getfocus()			
else
//	if il_id_bulto = uo_lectura_origen_2.il_id_bulto then
//		f_reset()
//		messagebox("¡Atención!","Debe seleccionar un bulto distinto al origen.",StopSign!)
//		uo_lectura_destino_2.SetFocus()
//		uo_lectura_destino_2.event getfocus()				
//	else
		//Comprobar si el bulto está vacio o las lineas que lo componen tienen material de la orden que estamos preparando
		
		long ll_lineas_reservadas_otra_orden,ll_lineas_reservadas_misma_orden
		
		SELECT isnull(count(venliped.id_alm_orden_carga),0)
		INTO   :ll_lineas_reservadas_otra_orden
		FROM alm_bultos,   
			  alm_bultos_lineas,   
			  venliped,   
			  venliped_reservas  
		WHERE ( alm_bultos.id               = alm_bultos_lineas.id_alm_bultos ) 
		and   ( alm_bultos_lineas.id        = venliped_reservas.alm_bultos_lineas_id ) 
		and   ( venliped_reservas.empresa   = venliped.empresa ) 
		and   ( venliped_reservas.anyo      = venliped.anyo ) 
		and   ( venliped_reservas.pedido    = venliped.pedido ) 
		and   ( venliped_reservas.linea     = venliped.linea ) 
		and ( ( alm_bultos.id               = :il_id_bulto ) 
		and   ( venliped.id_alm_orden_carga <> :il_orden_carga_preparo ) );
		
		SELECT isnull(count(venliped.id_alm_orden_carga),0)
		INTO   :ll_lineas_reservadas_misma_orden
		FROM alm_bultos,   
			  alm_bultos_lineas,   
			  venliped,   
			  venliped_reservas  
		WHERE ( alm_bultos.id               = alm_bultos_lineas.id_alm_bultos ) 
		and   ( alm_bultos_lineas.id        = venliped_reservas.alm_bultos_lineas_id ) 
		and   ( venliped_reservas.empresa   = venliped.empresa ) 
		and   ( venliped_reservas.anyo      = venliped.anyo ) 
		and   ( venliped_reservas.pedido    = venliped.pedido ) 
		and   ( venliped_reservas.linea     = venliped.linea ) 
		and ( ( alm_bultos.id               = :il_id_bulto ) 
		and   ( venliped.id_alm_orden_carga = :il_orden_carga_preparo ) );		
		
		if ll_lineas_reservadas_otra_orden > 0 then
			f_reset()
			messagebox("¡Atención!","Debe seleccionar un bulto no asociado a otra orden de carga.",StopSign!)
			uo_lectura_destino_2.SetFocus()
			uo_lectura_destino_2.event getfocus()			
		else
			//dw_lineas_picos_orden_2.setfilter("alm_bultos_id <> "+string(il_id_bulto))
			//dw_lineas_picos_orden_2.filter()
		end if
//	end if
end if
end event

event ue_siguiente_objeto;call super::ue_siguiente_objeto;ii_paso_actual = 2

uo_lectura_origen_2.visible = true

if is_codigo_pallet = "" then
	dw_seleccion_tipo_pallet_preparacion.retrieve(codigo_empresa)
	dw_seleccion_tipo_pallet_preparacion.visible = true
else
	uo_lectura_origen_2.SetFocus()
	uo_lectura_origen_2.event getfocus()
end if
end event

type uo_lectura_origen_2 from u_sle_codbar within tp_preparacion_bulto
event destroy ( )
integer y = 328
integer taborder = 20
boolean ib_mostrar_desplegado = true
boolean ib_obligatorio_marcar_una_linea = true
string is_descripcion = "LECTURA ORIGEN"
end type

on uo_lectura_origen_2.destroy
call u_sle_codbar::destroy
end on

event getfocus;call super::getfocus;ii_paso_actual = 2

tab_1.tp_preparacion_bulto.st_paso1_2.backcolor         = il_color_fondo_inactivo
tab_1.tp_preparacion_bulto.st_paso2_2.backcolor         = il_color_fondo_activo

tab_1.tp_preparacion_bulto.pb_atras_2.visible           = true
tab_1.tp_preparacion_bulto.pb_aceptar_2.visible         = false

tab_1.tp_preparacion_bulto.em_pallets_2.text = "0"
tab_1.tp_preparacion_bulto.em_cajas_2.text   = "0"
tab_1.tp_preparacion_bulto.em_piezas_2.text  = "0"

tab_1.tp_preparacion_bulto.p_subir2.enabled = true
tab_1.tp_preparacion_bulto.p_bajar2.enabled = true

ib_lanzar_modified = false
tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.selectrow(0,false)
ib_lanzar_modified = true
end event

event modified;call super::modified;long ll_donde
string  ls_busqueda,ls_lineas_bulto
integer li_lineas_bulto

//¿cambiar este evento o el evento que lanza el boton v?

if il_id_bulto = 0 or ii_lineas_bulto = 0 then
	f_reset()
	messagebox("¡Atención!","Debe seleccionar un bulto con contenido.",StopSign!)
	this.SetFocus()
	this.event getfocus()	
else
	if ii_bultos > 1 then
		Messagebox("Error","Ha seleccionado un origen con mas de un bulto~nDebe hacer la lectura de la etiqueta del bulto.")
		this.SetFocus()
		this.event getfocus()			
	else	
		if il_id_bulto = uo_lectura_destino_2.il_id_bulto then
			messagebox("¡Atención!","Debe seleccionar un bulto distinto al destino.",StopSign!)
			this.SetFocus()
			this.event getfocus()				
		else		
			ls_lineas_bulto = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.describe('evaluate("sum(if (alm_bultos_id = '+string(il_id_bulto)+',1,0) for all)",1)')
			li_lineas_bulto = integer(ls_lineas_bulto)			
			
			ls_busqueda = "alm_bultos_id     = "+string(il_id_bulto)+" and "+&
							  "venliped_articulo = '"+is_codigo_articulo+"' and "+&
							  "venliped_calidad  = '"+is_codigo_calidad+"' and "+&
							  "venliped_tonochar = '"+is_lote+"' and "+&
							  "venliped_calibre  = "+string(ii_calibre,"#0")+" and "+&
							  "venliped_caja     = '"+is_codigo_caja+"' "
							  			
			ll_donde = tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.find(ls_busqueda,1,tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.rowcount())
			
			if ll_donde > 0 then
				tab_1.tp_preparacion_bulto.p_subir2.enabled = false
				tab_1.tp_preparacion_bulto.p_bajar2.enabled = false
	
				tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.selectrow(0,false)
				tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.selectrow(ll_donde,true)
				tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.setrow(ll_donde)
				tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.scrolltorow(ll_donde)
				
				tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.event rowfocuschanged(ll_donde)
			else
				//f_reset()
				if li_lineas_bulto = 0 then
					messagebox("¡Atención!","Debe seleccionar un bulto de la orden.",StopSign!)			
					this.SetFocus()
					this.event getfocus()		
				else
					tab_1.tp_preparacion_bulto.dw_lineas_picos_orden_2.event rowfocuschanged(0)
					pb_aceptar_2.visible         = false
				end if
			end if
		end if
	end if	
end if




/*
if il_id_bulto = 0 or ii_lineas_bulto = 0 then
	f_reset()
	messagebox("¡Atención!","Debe seleccionar un bulto con contenido.",StopSign!)
	this.SetFocus()
	this.event getfocus()	
else
	if ii_bultos > 1 then
		Messagebox("Error","Ha seleccionado un origen con mas de un bulto~nDebe hacer la lectura de la etiqueta del bulto.")
		this.SetFocus()
		this.event getfocus()			
	else
		string ls_articulo,ls_pallet,ls_caja
		int    li_piezas_caja,li_cajas_maximas
		long   ll_piezas_pallet,ll_piezas_bulto, li_cajas_pallet
				
		ls_articulo     = uo_lectura_origen_2.is_codigo_articulo
		ls_pallet       = uo_lectura_origen_2.is_codigo_pallet
		ls_caja         = uo_lectura_origen_2.is_codigo_caja
		ll_piezas_bulto = uo_lectura_origen_2.il_piezas - uo_lectura_origen_2.il_piezas_reservadas_bulto
	
//Solo controlamos la piezas reservadas de ese bulto	
//		if ll_piezas_bulto > uo_lectura_origen_2.il_piezas_disponibles_totales then
//			ll_piezas_bulto = uo_lectura_origen_2.il_piezas_disponibles_totales
//		end if
		
		select isnull(almartcajas.piezascaja,0),
				 isnull(palarticulo.cajaspallet,0),
				 isnull(palarticulo.cajaspallet,0) * isnull(almartcajas.piezascaja,0) 
		into   :li_piezas_caja,
				 :li_cajas_pallet,
				 :ll_piezas_pallet 
		from   almartcajas,palarticulo
		where  almartcajas.empresa  = palarticulo.empresa 
		and    almartcajas.articulo = palarticulo.articulo 
		and    almartcajas.caja     = palarticulo.caja 
		and    almartcajas.empresa  = :codigo_empresa 
		and    almartcajas.articulo = :ls_articulo 
		and    almartcajas.caja     = :ls_caja 
		and    palarticulo.codigo   = :ls_pallet;
		
		if li_piezas_caja = 0 then
			select isnull(almartcajas.piezascaja,0),
					 0,
					 0 
			into   :li_piezas_caja,
					 :li_cajas_pallet,
					 :ll_piezas_pallet 
			from   almartcajas
			where  almartcajas.empresa  = :codigo_empresa 
			and    almartcajas.articulo = :ls_articulo 
			and    almartcajas.caja     = :ls_caja;			
			
		end if
		
		if li_piezas_caja <> 0 then
			li_cajas_maximas = truncate(ll_piezas_bulto / li_piezas_caja,0)
		else
			li_cajas_maximas = 0
		end if
				
		if ll_piezas_bulto >= ll_piezas_pallet and ll_piezas_pallet > 0 then
		else
		end if
		//editmask			
	end if	
end if
*/
end event

event ue_siguiente_objeto;call super::ue_siguiente_objeto;pb_aceptar_2.visible         = true
pb_aceptar_2.SetFocus()
end event

event ue_pre_siguiente_objeto;call super::ue_pre_siguiente_objeto;pb_atras_2.visible           = true
end event

type st_paso2_2 from statictext within tp_preparacion_bulto
integer x = 1463
integer y = 4
integer width = 1403
integer height = 144
integer textsize = -20
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 67108864
boolean enabled = false
string text = "Bulto Origen"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_paso1_2 from statictext within tp_preparacion_bulto
integer x = 18
integer y = 4
integer width = 1403
integer height = 144
integer textsize = -20
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 8388736
string text = "Bulto Destino"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type r_barra2 from rectangle within tp_preparacion_bulto
integer linethickness = 4
long fillcolor = 12632256
integer x = 4357
integer y = 1476
integer width = 265
integer height = 264
end type

type r_indicador2 from rectangle within tp_preparacion_bulto
integer linethickness = 4
long fillcolor = 8421504
integer x = 4357
integer y = 1476
integer width = 265
integer height = 44
end type

type tp_mover_pallets from userobject within tab_1
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 4645
integer height = 2668
long backcolor = 67108864
string text = "Mover Pallets Completos"
long tabtextcolor = 33554432
long picturemaskcolor = 536870912
p_bajar3 p_bajar3
p_subir3 p_subir3
st_ubicar_3 st_ubicar_3
em_pallets_3 em_pallets_3
em_cajas_3 em_cajas_3
em_piezas_3 em_piezas_3
st_piezas_3 st_piezas_3
st_cajas_3 st_cajas_3
st_pallets_3 st_pallets_3
st_preparar_3 st_preparar_3
pb_aceptar_3 pb_aceptar_3
pb_atras_3 pb_atras_3
dw_lineas_pallets_orden_3 dw_lineas_pallets_orden_3
uo_lectura_destino_3 uo_lectura_destino_3
st_paso3_3 st_paso3_3
st_paso2_3 st_paso2_3
st_paso1_3 st_paso1_3
r_barra3 r_barra3
r_indicador3 r_indicador3
uo_lectura_origen_3 uo_lectura_origen_3
end type

on tp_mover_pallets.create
this.p_bajar3=create p_bajar3
this.p_subir3=create p_subir3
this.st_ubicar_3=create st_ubicar_3
this.em_pallets_3=create em_pallets_3
this.em_cajas_3=create em_cajas_3
this.em_piezas_3=create em_piezas_3
this.st_piezas_3=create st_piezas_3
this.st_cajas_3=create st_cajas_3
this.st_pallets_3=create st_pallets_3
this.st_preparar_3=create st_preparar_3
this.pb_aceptar_3=create pb_aceptar_3
this.pb_atras_3=create pb_atras_3
this.dw_lineas_pallets_orden_3=create dw_lineas_pallets_orden_3
this.uo_lectura_destino_3=create uo_lectura_destino_3
this.st_paso3_3=create st_paso3_3
this.st_paso2_3=create st_paso2_3
this.st_paso1_3=create st_paso1_3
this.r_barra3=create r_barra3
this.r_indicador3=create r_indicador3
this.uo_lectura_origen_3=create uo_lectura_origen_3
this.Control[]={this.p_bajar3,&
this.p_subir3,&
this.st_ubicar_3,&
this.em_pallets_3,&
this.em_cajas_3,&
this.em_piezas_3,&
this.st_piezas_3,&
this.st_cajas_3,&
this.st_pallets_3,&
this.st_preparar_3,&
this.pb_aceptar_3,&
this.pb_atras_3,&
this.dw_lineas_pallets_orden_3,&
this.uo_lectura_destino_3,&
this.st_paso3_3,&
this.st_paso2_3,&
this.st_paso1_3,&
this.r_barra3,&
this.r_indicador3,&
this.uo_lectura_origen_3}
end on

on tp_mover_pallets.destroy
destroy(this.p_bajar3)
destroy(this.p_subir3)
destroy(this.st_ubicar_3)
destroy(this.em_pallets_3)
destroy(this.em_cajas_3)
destroy(this.em_piezas_3)
destroy(this.st_piezas_3)
destroy(this.st_cajas_3)
destroy(this.st_pallets_3)
destroy(this.st_preparar_3)
destroy(this.pb_aceptar_3)
destroy(this.pb_atras_3)
destroy(this.dw_lineas_pallets_orden_3)
destroy(this.uo_lectura_destino_3)
destroy(this.st_paso3_3)
destroy(this.st_paso2_3)
destroy(this.st_paso1_3)
destroy(this.r_barra3)
destroy(this.r_indicador3)
destroy(this.uo_lectura_origen_3)
end on

type p_bajar3 from picturebutton within tp_mover_pallets
integer x = 4352
integer y = 1580
integer width = 274
integer height = 224
integer taborder = 60
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\down.bmp"
string disabledname = "C:\bmp\down.bmp"
alignment htextalign = left!
end type

event clicked;if tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.getrow() < tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.rowcount() then
	tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.setrow(tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.getrow() +1)
else
	tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.setrow(1)
end if

end event

type p_subir3 from picturebutton within tp_mover_pallets
integer x = 4352
integer y = 1092
integer width = 274
integer height = 224
integer taborder = 50
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\up.bmp"
string disabledname = "C:\bmp\up.bmp"
alignment htextalign = left!
end type

event clicked;if tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.getrow() > 1 then
	tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.setrow(tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.getrow() -1)
else
	tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.setrow(tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.rowcount())
end if
end event

type st_ubicar_3 from statictext within tp_mover_pallets
integer x = 978
integer y = 2472
integer width = 2702
integer height = 196
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 32768
string text = "Ubicar"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

event clicked;window lw_ventana 
str_parametros lstr_param 

string ls_tipo_ventana
long   ll_rf_parametros_ventanas_id = 11

if tab_1.tp_preparacion_bulto.uo_lectura_destino_2.il_id_bulto <> 0 then		
	
	ls_tipo_ventana = f_rf_parametros_ventanas_tipo_ventana(ll_rf_parametros_ventanas_id)
	
	lstr_param.i_nargumentos   = 3
	lstr_param.s_argumentos[2] = string(ll_rf_parametros_ventanas_id)
	lstr_param.s_argumentos[3] = string(tab_1.tp_preparacion_bulto.uo_lectura_destino_2.sle_codbar.text) 
	
	OpenWithParm(lw_ventana, lstr_param , ls_tipo_ventana)	
				
	//Esto no funciona 			
	//parent.Hide()					
	lw_ventana.show()					
	//					

end if
end event

type em_pallets_3 from editmask within tp_mover_pallets
event clicked pbm_bnclicked
integer x = 978
integer y = 2300
integer width = 805
integer height = 168
integer taborder = 130
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "0"
alignment alignment = center!
boolean displayonly = true
borderstyle borderstyle = stylelowered!
string mask = "0"
boolean autoskip = true
double increment = 1
string minmax = "0~~1"
end type

event clicked;this.event modified()
end event

event getfocus;this.SelectText(1,len(this.text))
end event

event losefocus;this.event modified()
end event

event modified;string cadena
int    posi_aux,posi

//Control de rango
string ls_minmax,ls_min,ls_max
long   ll_min,ll_max,ll_pos,ll_valor,ll_nuevo_valor

ls_minmax = this.minmax

ll_pos = pos(ls_minmax,"~~")
if ll_pos > 0 then
	ls_min = mid(ls_minmax,1,ll_pos -1)
	ls_max = mid(ls_minmax,ll_pos +1,len(ls_minmax)- ll_pos)
	
	ll_min = long(ls_min)
	ll_max = long(ls_max)
else
	ll_min = 0
	ll_max = 0
end if

ll_valor = long(this.text)

if ll_valor > ll_max then
	this.text = string(0,this.mask)
else
	if ll_valor < ll_min then
		this.text = string(0,this.mask)		
	end if	
end if
//Fin de control de rango

if integer(this.text) > 0 then
	
	cadena = f_calculo_unidades_piezas(codigo_empresa,uo_lectura_origen_3.is_codigo_articulo,&
									  uo_lectura_origen_3.is_codigo_pallet,&
									  uo_lectura_origen_3.is_codigo_caja,&
									  integer(this.text),&
									  0,0, "")
								 
	//Pallets
	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		em_pallets_3.text     = Mid(cadena,1,posi - 1)
		posi_aux = posi + 1
	end if
	//Cajas de pico
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		//em_cajas_3.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Total cajas
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cajas_3.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Metros Lineales
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_piezas_3.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
else
	em_cajas_3.text       = "0"
	em_piezas_3.text      = "0"
end if
end event

type em_cajas_3 from editmask within tp_mover_pallets
event clicked pbm_bnclicked
integer x = 1938
integer y = 2300
integer width = 805
integer height = 168
integer taborder = 140
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "0"
alignment alignment = center!
boolean displayonly = true
borderstyle borderstyle = stylelowered!
string mask = "######0"
boolean autoskip = true
double increment = 1
string minmax = "0~~9999"
end type

event getfocus;this.SelectText(1,len(this.text))
end event

event losefocus;this.event modified()
end event

event modified;string cadena 
int    posi_aux,posi

//Control de rango
string ls_minmax,ls_min,ls_max
long   ll_min,ll_max,ll_pos,ll_valor,ll_nuevo_valor

ls_minmax = this.minmax

ll_pos = pos(ls_minmax,"~~")
if ll_pos > 0 then
	ls_min = mid(ls_minmax,1,ll_pos -1)
	ls_max = mid(ls_minmax,ll_pos +1,len(ls_minmax)- ll_pos)
	
	ll_min = long(ls_min)
	ll_max = long(ls_max)
else
	ll_min = 0
	ll_max = 0
end if

ll_valor = long(this.text)

if ll_valor > ll_max then
	this.text = string(0,this.mask)
	messagebox("Error de datos","No se puede realizar un movimiento de cantidad superior a "+string(ll_max)+" Cajas")
else
	if ll_valor < ll_min then
		this.text = string(0,this.mask)		
		messagebox("Error de datos","No se puede realizar un movimiento de cantidad inferior a "+string(ll_min)+" Cajas")
	end if	
end if
//Fin de control de rango

if integer(this.text) > 0 then
	cadena = f_calculo_unidades_piezas(codigo_empresa,uo_lectura_origen_3.is_codigo_articulo,&
									  uo_lectura_origen_3.is_codigo_pallet,&
									  uo_lectura_origen_3.is_codigo_caja,&
									  0,&
									  integer(this.text),0, "")
								 
	//Pallets
	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		em_pallets_3.text     = Mid(cadena,1,posi - 1)
		posi_aux = posi + 1
	end if
	//Cajas de pico
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		//em_cajas_3.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Total cajas
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cajas_3.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Metros Lineales
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_piezas_3.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
else
	em_pallets_3.text     = "0"
	em_piezas_3.text      = "0"
end if
end event

type em_piezas_3 from editmask within tp_mover_pallets
event clicked pbm_bnclicked
integer x = 2871
integer y = 2300
integer width = 805
integer height = 168
integer taborder = 150
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "0"
alignment alignment = center!
boolean displayonly = true
borderstyle borderstyle = stylelowered!
string mask = "######0"
boolean autoskip = true
double increment = 1
string minmax = "0~~9999"
end type

event getfocus;this.SelectText(1,len(this.text))
end event

event losefocus;this.event modified()
end event

event modified;string cadena,ls_articulos_unidad,ls_codigo_articulo,ls_codigo_caja,ls_m2 
dec    ld_metroscaja,ld_m2
int    posi_aux,posi,li_piezas,li_piezascaja

//Control de rango
string ls_minmax,ls_min,ls_max
long   ll_min,ll_max,ll_pos,ll_valor,ll_nuevo_valor

ls_minmax = this.minmax

ll_pos = pos(ls_minmax,"~~")
if ll_pos > 0 then
	ls_min = mid(ls_minmax,1,ll_pos -1)
	ls_max = mid(ls_minmax,ll_pos +1,len(ls_minmax)- ll_pos)
	
	ll_min = long(ls_min)
	ll_max = long(ls_max)
else
	ll_min = 0
	ll_max = 0
end if

ll_valor = long(this.text)

if ll_valor > ll_max then
	this.text = string(0,this.mask)
	messagebox("Error de datos","No se puede realizar un movimiento de cantidad superior a "+string(ll_max)+" Pzs")
else
	if ll_valor < ll_min then
		this.text = string(0,this.mask)		
		messagebox("Error de datos","No se puede realizar un movimiento de cantidad inferior a "+string(ll_min)+" Pzs")
	end if	
end if
//Fin de control de rango

if integer(this.text) > 0 then
	li_piezas = dec(this.text)
	
	ls_codigo_articulo = uo_lectura_origen_3.is_codigo_articulo
	ls_codigo_caja     = uo_lectura_origen_3.is_codigo_caja
	
	SELECT isnull(articulos.unidad,''),
			 isnull(almartcajas.metroscaja,0), 
			 isnull(almartcajas.piezascaja,0) 
	INTO   :ls_articulos_unidad,
			 :ld_metroscaja,
			 :li_piezascaja
	FROM   articulos,almartcajas 
	WHERE  almartcajas.empresa  = articulos.empresa 
	AND    almartcajas.articulo = articulos.codigo 
	AND    almartcajas.empresa  = :codigo_empresa 
	AND    almartcajas.articulo = :ls_codigo_articulo 
	AND    almartcajas.caja     = :ls_codigo_caja;
	
	if ls_articulos_unidad = '1' then
		ld_m2 = (li_piezas / li_piezascaja) * ld_metroscaja
		
		cadena = f_calculo_unidades_piezas(codigo_empresa,uo_lectura_origen_3.is_codigo_articulo,&
										  uo_lectura_origen_3.is_codigo_pallet,&
										  uo_lectura_origen_3.is_codigo_caja,&
										  0,&
										  0,ld_m2, "")
	else
		cadena = f_calculo_unidades_piezas(codigo_empresa,uo_lectura_origen_3.is_codigo_articulo,&
										  uo_lectura_origen_3.is_codigo_pallet,&
										  uo_lectura_origen_3.is_codigo_caja,&
										  0,&
										  0,li_piezas, "")
	end if
								 
	//Pallets
	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		em_pallets_3.text     = Mid(cadena,1,posi - 1)
		posi_aux = posi + 1
	end if
	//Cajas de pico
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		//em_cajas_3.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Total cajas
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cajas_3.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Metros Lineales
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		posi_aux = posi + 1
	end if
	//Unidades
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		if uo_lectura_origen_3.ib_ubicacion_gestionada_en_piezas then
			em_piezas_3.text      = string(li_piezas)
		else
			em_piezas_3.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
			posi_aux = posi + 1
		end if
	end if
else
	em_pallets_3.text     = "0"
	em_cajas_3.text       = "0"
end if
end event

type st_piezas_3 from statictext within tp_mover_pallets
integer x = 2871
integer y = 2136
integer width = 809
integer height = 168
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24011603
string text = "Piezas"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_cajas_3 from statictext within tp_mover_pallets
integer x = 1938
integer y = 2136
integer width = 809
integer height = 168
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24011603
string text = "Cajas"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_pallets_3 from statictext within tp_mover_pallets
integer x = 978
integer y = 2132
integer width = 809
integer height = 168
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24011603
boolean enabled = false
string text = "Pallets"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_preparar_3 from statictext within tp_mover_pallets
integer x = 978
integer y = 1972
integer width = 2702
integer height = 168
integer textsize = -24
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 24011603
boolean enabled = false
string text = "Preparar"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type pb_aceptar_3 from picturebutton within tp_mover_pallets
integer x = 3831
integer y = 1968
integer width = 800
integer height = 700
integer taborder = 80
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\RF\db-Post.png"
string disabledname = "C:\bmp\RF\db-Post_dis.png"
alignment htextalign = left!
end type

event clicked;//str_movimiento_almacen lstr_movimiento_almacen
str_movimiento_almacen_traspaso_bultos lstr_movimiento_almacen_traspaso_bultos

long ll_indice,ll_total
boolean lb_correcto = true

ll_total  = tab_1.tp_mover_pallets.uo_lectura_origen_3.ii_lineas_bulto

if tab_1.tp_mover_pallets.uo_lectura_origen_3.ii_bultos = 1 then
	for ll_indice = 1 to ll_total
		if tab_1.tp_mover_pallets.uo_lectura_origen_3.f_setrow(ll_indice) > 0 then

			lstr_movimiento_almacen_traspaso_bultos.empresa                   = codigo_empresa
			lstr_movimiento_almacen_traspaso_bultos.articulo                  = tab_1.tp_mover_pallets.uo_lectura_origen_3.is_codigo_articulo
			lstr_movimiento_almacen_traspaso_bultos.calidad                   = tab_1.tp_mover_pallets.uo_lectura_origen_3.is_codigo_calidad
			lstr_movimiento_almacen_traspaso_bultos.tono                      = tab_1.tp_mover_pallets.uo_lectura_origen_3.is_lote
			lstr_movimiento_almacen_traspaso_bultos.calibre                   = tab_1.tp_mover_pallets.uo_lectura_origen_3.ii_calibre
			lstr_movimiento_almacen_traspaso_bultos.tipo_pallet               = tab_1.tp_mover_pallets.uo_lectura_origen_3.is_codigo_pallet
			lstr_movimiento_almacen_traspaso_bultos.caja                      = tab_1.tp_mover_pallets.uo_lectura_origen_3.is_codigo_caja
			lstr_movimiento_almacen_traspaso_bultos.cantidad                  = -1 * ( tab_1.tp_mover_pallets.uo_lectura_origen_3.il_piezas )
			lstr_movimiento_almacen_traspaso_bultos.orden_carga_anyo          = tab_1.tp_mover_pallets.uo_lectura_origen_3.ii_anyo_orden_carga
			lstr_movimiento_almacen_traspaso_bultos.orden_carga_codigo        = tab_1.tp_mover_pallets.uo_lectura_origen_3.is_orden_carga
			lstr_movimiento_almacen_traspaso_bultos.orden_carga_linea         = tab_1.tp_mover_pallets.uo_lectura_origen_3.il_linea_orden_carga
			lstr_movimiento_almacen_traspaso_bultos.tipo_movimiento_salida    = is_tipo_movimiento_salida
			lstr_movimiento_almacen_traspaso_bultos.observaciones             = ""
			lstr_movimiento_almacen_traspaso_bultos.almacen_salida            = tab_1.tp_mover_pallets.uo_lectura_origen_3.is_almacen
			lstr_movimiento_almacen_traspaso_bultos.zona_salida               = tab_1.tp_mover_pallets.uo_lectura_origen_3.is_zona
			lstr_movimiento_almacen_traspaso_bultos.fila_salida               = tab_1.tp_mover_pallets.uo_lectura_origen_3.ii_fila
			lstr_movimiento_almacen_traspaso_bultos.altura_salida             = tab_1.tp_mover_pallets.uo_lectura_origen_3.ii_altura
			lstr_movimiento_almacen_traspaso_bultos.tercero                   = ""
			lstr_movimiento_almacen_traspaso_bultos.documento                 = ""
			lstr_movimiento_almacen_traspaso_bultos.fecha                     = datetime(today())
			lstr_movimiento_almacen_traspaso_bultos.id_ubicacion_salida       = tab_1.tp_mover_pallets.uo_lectura_origen_3.il_id_ubicacion
			lstr_movimiento_almacen_traspaso_bultos.id_alm_bultos		         = tab_1.tp_mover_pallets.uo_lectura_origen_3.il_id_bulto		
			lstr_movimiento_almacen_traspaso_bultos.tipo_movimiento_entrada   = is_tipo_movimiento_entrada
			lstr_movimiento_almacen_traspaso_bultos.almacen_entrada           = tab_1.tp_mover_pallets.uo_lectura_destino_3.is_almacen
			lstr_movimiento_almacen_traspaso_bultos.zona_entrada              = tab_1.tp_mover_pallets.uo_lectura_destino_3.is_zona
			lstr_movimiento_almacen_traspaso_bultos.fila_entrada              = tab_1.tp_mover_pallets.uo_lectura_destino_3.ii_fila
			lstr_movimiento_almacen_traspaso_bultos.altura_entrada            = tab_1.tp_mover_pallets.uo_lectura_destino_3.ii_altura			
			lstr_movimiento_almacen_traspaso_bultos.id_ubicacion_entrada      = tab_1.tp_mover_pallets.uo_lectura_destino_3.il_id_ubicacion
			
			if not(f_movimiento_almacen_traspaso_bultos(lstr_movimiento_almacen_traspaso_bultos)) then
				lb_correcto = false
			end if			
			
		else
			lb_correcto = false
		end if

	next

	//marcamos la linea como preparada en venliped_reservas
	update venliped_reservas
	set    venliped_reservas.preparado            = 'S'
	from   venliped_reservas,
			 alm_bultos_lineas
	where  venliped_reservas.alm_bultos_lineas_id = alm_bultos_lineas.id
	and    alm_bultos_lineas.id_alm_bultos        = :tab_1.tp_mover_pallets.uo_lectura_origen_3.il_id_bulto;
	
	if sqlca.sqlcode <> 0 then
		messagebox("¡Error!","Se ha producido un error al actualizar al situacion de la reserva.")
		lb_correcto = false
	end if								

	if lb_correcto then
		commit;
		 
		update venliped
		set    venliped.situacion = 'P'
		from   venliped,
				 venliped_reservas 
		where  venliped.empresa = venliped_reservas.empresa 
		and    venliped.anyo    = venliped_reservas.anyo 
		and    venliped.pedido  = venliped_reservas.pedido 
		and    venliped.linea   = venliped_reservas.linea 
		and    venliped.situacion <> 'P'
		and    ( select isnull(count(*),0) 
					from   venliped_reservas as venliped_reservas_no_preparadas 
					where  venliped_reservas_no_preparadas.empresa = venliped.empresa
					and    venliped_reservas_no_preparadas.anyo    = venliped.anyo
					and    venliped_reservas_no_preparadas.pedido  = venliped.pedido
					and    venliped_reservas_no_preparadas.linea   = venliped.linea
					and    isnull(venliped_reservas_no_preparadas.preparado,'') <> 'S' ) = 0;
					
		if sqlca.sqlcode <> 0 then
			rollback;
		else
			commit;
		end if									
		
		tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.retrieve(codigo_empresa,il_orden_preparacion_preparo)
		
		tab_1.tp_mover_pallets.uo_lectura_origen_3.f_reset()
		tab_1.tp_mover_pallets.uo_lectura_destino_3.f_reset()
	else
		rollback;
		Messagebox("Error","No se ha generado el movimiento")
	end if
else
	if tab_1.tp_mover_pallets.uo_lectura_origen_3.ii_bultos > 1 then
		Messagebox("Error","Ha seleccionado un origen con mas de un bulto")
	else
		Messagebox("Error","No se ha seleccionado el origen del traspaso")
	end if
end if

tab_1.tp_mover_pallets.uo_lectura_origen_3.SetFocus()
tab_1.tp_mover_pallets.uo_lectura_origen_3.event getfocus()
end event

type pb_atras_3 from picturebutton within tp_mover_pallets
integer y = 1968
integer width = 800
integer height = 700
integer taborder = 70
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "C:\bmp\RF\Back.png"
string disabledname = "C:\bmp\RF\Back_dis.png"
alignment htextalign = left!
end type

event clicked;choose case ii_paso_actual
	case 2
		uo_lectura_origen_3.SetFocus()
		uo_lectura_origen_3.event getfocus()				
	case 3
		uo_lectura_destino_3.SetFocus()
		uo_lectura_destino_3.event getfocus()			
	case else
		uo_lectura_origen_3.SetFocus()
		uo_lectura_origen_3.event getfocus()				
end choose
end event

type dw_lineas_pallets_orden_3 from u_datawindow within tp_mover_pallets
integer y = 1092
integer width = 4347
integer height = 712
integer taborder = 21
string dataobject = "dw_rf_orden_preparacion_3"
end type

event clicked;call super::clicked;string ls_sort,ls_color_blanco,ls_color_negro
long   ll_row_seleccionada,ll_venliped_reservas_alm_bultos_lineas_id

ls_color_blanco = string(rgb(255,255,255))
ls_color_negro  = string(rgb(0,0,0))

this.modify('nombre_articulo_t.color = '+ls_color_blanco)
this.modify('nombre_formato_t.color = '+ls_color_blanco)
this.modify('almubimapa_codbar_almacen_t.color = '+ls_color_blanco)
this.modify('almubimapa_codbar_zona_t.color = '+ls_color_blanco)
this.modify('almubimapa_codbar_fila_t.color = '+ls_color_blanco)
this.modify('almubimapa_codbar_altura_t.color = '+ls_color_blanco)
this.modify('venliped_pallets_t.color = '+ls_color_blanco)
this.modify('cajas_t.color = '+ls_color_blanco)
this.modify('venliped_reservas_cantidad_t.color = '+ls_color_blanco)

ll_row_seleccionada = this.GetSelectedRow(0)

if ll_row_seleccionada > 0 then
	ll_venliped_reservas_alm_bultos_lineas_id = this.object.venliped_reservas_alm_bultos_lineas_id[ll_row_seleccionada]
end if

choose case dwo.name
	case 'nombre_articulo_t','nombre_formato_t'
		ls_sort = 'nombre_formato A,articulos_descripcion A,venped_anyo A,venped_pedido A,venliped_linea A,distancia A'		
		
		this.setsort(ls_sort)
		this.sort()
		
		this.modify('nombre_articulo_t.color = '+ls_color_negro)
		this.modify('nombre_formato_t.color = '+ls_color_negro)
	case 'almubimapa_codbar_almacen_t','almubimapa_codbar_zona_t','almubimapa_codbar_fila_t','almubimapa_codbar_altura_t'
		ls_sort = 'distancia A'
		
		this.setsort(ls_sort)
		this.sort()		
		
		this.modify('almubimapa_codbar_almacen_t.color = '+ls_color_negro)
		this.modify('almubimapa_codbar_zona_t.color = '+ls_color_negro)
		this.modify('almubimapa_codbar_fila_t.color = '+ls_color_negro)
		this.modify('almubimapa_codbar_altura_t.color = '+ls_color_negro)		
		
	case 'venliped_pallets_t','cajas_t','venliped_reservas_cantidad_t'
		ls_sort = 'cajas D,venliped_reservas_cantidad D,distancia A'
		
		this.setsort(ls_sort)
		this.sort()
		
		this.modify('venliped_pallets_t.color = '+ls_color_negro)
		this.modify('cajas_t.color = '+ls_color_negro)
		this.modify('venliped_reservas_cantidad_t.color = '+ls_color_negro)		
		
end choose

if ll_row_seleccionada > 0 then
	ll_row_seleccionada = this.find('venliped_reservas_alm_bultos_lineas_id = '+string(ll_venliped_reservas_alm_bultos_lineas_id),1,this.rowcount())
	
	if ll_row_seleccionada > 0 then
		this.selectrow(0,false)
		this.selectrow(ll_row_seleccionada,true)
		this.setrow(ll_row_seleccionada)
	end if
end if

choose case ii_paso_actual 
	case 1
		uo_lectura_origen_3.SetFocus()
		uo_lectura_origen_3.event getfocus()						
	case 2
		uo_lectura_destino_3.SetFocus()
		uo_lectura_destino_3.event getfocus()					
	case else
		uo_lectura_origen_3.SetFocus()
		uo_lectura_origen_3.event getfocus()						
end choose

end event

event rowfocuschanged;call super::rowfocuschanged;long ll_alto_total,ll_nueva_posicion

this.selectrow(0,false)

if currentrow > 0 then
	if currentrow = 1 then
		r_indicador3.y = r_barra3.y
	else
		ll_alto_total =  r_barra3.height - r_indicador3.height
	
		ll_nueva_posicion = (ll_alto_total / this.rowcount()) * currentrow
		
		r_indicador3.y = r_barra3.y + ll_nueva_posicion
	end if
	
	tab_1.tp_mover_pallets.em_pallets_3.text = "0"
	tab_1.tp_mover_pallets.em_cajas_3.text   = string(this.object.cajas[currentrow],tab_1.tp_mover_pallets.em_cajas_3.mask)
	tab_1.tp_mover_pallets.em_piezas_3.text  = string(this.object.venliped_reservas_cantidad[currentrow],tab_1.tp_mover_pallets.em_piezas_3.mask)
	
	this.selectrow(currentrow,true)
	this.scrolltorow(currentrow)
else
	tab_1.tp_mover_pallets.em_pallets_3.text = "0"
	tab_1.tp_mover_pallets.em_cajas_3.text   = "0"
	tab_1.tp_mover_pallets.em_piezas_3.text  = "0"
	
	r_barra3.y = r_indicador3.y	
end if
end event

type uo_lectura_destino_3 from u_sle_codbar within tp_mover_pallets
event destroy ( )
integer y = 1808
integer height = 152
integer taborder = 60
boolean ib_permitir_desplegar = false
string is_descripcion = "LECTURA DESTINO"
boolean ib_sugiriendo_ubicacion = true
end type

on uo_lectura_destino_3.destroy
call u_sle_codbar::destroy
end on

event getfocus;call super::getfocus;ii_paso_actual = 2

tab_1.tp_mover_pallets.st_paso1_3.backcolor         = il_color_fondo_inactivo
tab_1.tp_mover_pallets.st_paso2_3.backcolor         = il_color_fondo_activo
tab_1.tp_mover_pallets.st_paso3_3.backcolor         = il_color_fondo_inactivo

this.f_sugerir_ubicacion_destino(tab_1.tp_mover_pallets.uo_lectura_origen_3)

pb_atras_3.visible           = true
pb_aceptar_3.visible         = false
end event

event modified;call super::modified;long ll_donde

if il_id_ubicacion = 0 then
	f_reset()
	messagebox("¡Atención!","Debe seleccionar una ubicacion.",StopSign!)
	uo_lectura_destino_3.SetFocus()
	uo_lectura_destino_3.event getfocus()			
else
	//Comprobar si la ubicación está vacia o tiene material de la orden que estamos preparando
	
	long ll_pallets_otra_orden,ll_pallets_misma_orden
	
	SELECT isnull(count(venliped.id_alm_orden_carga),0)
	INTO   :ll_pallets_otra_orden
	FROM alm_bultos,   
		  alm_bultos_lineas,   
		  venliped,   
		  venliped_reservas  
	WHERE ( alm_bultos.id               = alm_bultos_lineas.id_alm_bultos ) 
	and   ( alm_bultos_lineas.id        = venliped_reservas.alm_bultos_lineas_id ) 
	and   ( venliped_reservas.empresa   = venliped.empresa ) 
	and   ( venliped_reservas.anyo      = venliped.anyo ) 
	and   ( venliped_reservas.pedido    = venliped.pedido ) 
	and   ( venliped_reservas.linea     = venliped.linea ) 
	and ( ( alm_bultos.id_ubicacion     = :il_id_ubicacion ) 
	and   ( venliped.id_alm_orden_carga <> :il_orden_carga_preparo ) );
	
	SELECT isnull(count(venliped.id_alm_orden_carga),0)
	INTO   :ll_pallets_misma_orden
	FROM alm_bultos,   
		  alm_bultos_lineas,   
		  venliped,   
		  venliped_reservas  
	WHERE ( alm_bultos.id               = alm_bultos_lineas.id_alm_bultos ) 
	and   ( alm_bultos_lineas.id        = venliped_reservas.alm_bultos_lineas_id ) 
	and   ( venliped_reservas.empresa   = venliped.empresa ) 
	and   ( venliped_reservas.anyo      = venliped.anyo ) 
	and   ( venliped_reservas.pedido    = venliped.pedido ) 
	and   ( venliped_reservas.linea     = venliped.linea ) 
	and ( ( alm_bultos.id_ubicacion     = :il_id_ubicacion ) 
	and   ( venliped.id_alm_orden_carga = :il_orden_carga_preparo ) );		
	
	if ll_pallets_otra_orden > 0 then
		f_reset()
		messagebox("¡Atención!","Debe seleccionar una ubicación no asociada a otra orden de carga.",StopSign!)
		uo_lectura_destino_3.SetFocus()
		uo_lectura_destino_3.event getfocus()			
	else
		long ll_color_fondo,ll_color_texto
		
		select almubimapa_codbar.color_fondo,
				 almubimapa_codbar.color_texto 
		into   :ll_color_fondo,
				 :ll_color_texto
		from   almubimapa_codbar
		where  almubimapa_codbar.id = :il_id_ubicacion;		
		
		//this.il_id_ubicacion_sugerida
		
		this.st_texto.backcolor = ll_color_fondo
		this.st_texto.textcolor = ll_color_texto	
		this.st_texto.text = this.is_almacen+'-'+this.is_zona+'-'+string(this.ii_fila,'##0')+'-'+string(this.ii_altura,'#0')		
		//this.st_texto.text = this.is_almacen_sugerida+'-'+this.is_zona_sugerida+'-'+string(this.ii_fila_sugerida,'##0')+'-'+string(this.ii_altura_sugerida,'#0')		
		
		
	end if
end if
end event

event ue_siguiente_objeto;call super::ue_siguiente_objeto;ii_paso_actual = 3

tab_1.tp_mover_pallets.st_paso1_3.backcolor         = il_color_fondo_inactivo
tab_1.tp_mover_pallets.st_paso2_3.backcolor         = il_color_fondo_inactivo
tab_1.tp_mover_pallets.st_paso3_3.backcolor         = il_color_fondo_activo

tab_1.tp_mover_pallets.pb_aceptar_3.visible = true
tab_1.tp_mover_pallets.pb_aceptar_3.enabled = true

end event

type st_paso3_3 from statictext within tp_mover_pallets
integer x = 2917
integer y = 4
integer width = 1403
integer height = 144
integer textsize = -20
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 67108864
string text = "Ubicar"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_paso2_3 from statictext within tp_mover_pallets
integer x = 1463
integer y = 4
integer width = 1403
integer height = 144
integer textsize = -20
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 67108864
boolean enabled = false
string text = "Ubicación Destino"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_paso1_3 from statictext within tp_mover_pallets
integer x = 18
integer y = 4
integer width = 1403
integer height = 144
integer textsize = -20
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 8388736
string text = "Bulto Origen"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type r_barra3 from rectangle within tp_mover_pallets
integer linethickness = 4
long fillcolor = 12632256
integer x = 4357
integer y = 1316
integer width = 265
integer height = 264
end type

type r_indicador3 from rectangle within tp_mover_pallets
integer linethickness = 4
long fillcolor = 8421504
integer x = 4357
integer y = 1316
integer width = 265
integer height = 44
end type

type uo_lectura_origen_3 from u_sle_codbar within tp_mover_pallets
event destroy ( )
integer y = 168
integer taborder = 30
boolean ib_mostrar_desplegado = true
boolean ib_obligatorio_marcar_una_linea = true
string is_descripcion = "LECTURA ORIGEN"
end type

on uo_lectura_origen_3.destroy
call u_sle_codbar::destroy
end on

event getfocus;call super::getfocus;ii_paso_actual = 1	

tab_1.tp_mover_pallets.st_paso1_3.backcolor         = il_color_fondo_activo
tab_1.tp_mover_pallets.st_paso2_3.backcolor         = il_color_fondo_inactivo
tab_1.tp_mover_pallets.st_paso3_3.backcolor         = il_color_fondo_inactivo

tab_1.tp_mover_pallets.pb_atras_3.visible           = false
tab_1.tp_mover_pallets.pb_aceptar_3.visible         = false

tab_1.tp_mover_pallets.em_pallets_3.text = "0"
tab_1.tp_mover_pallets.em_cajas_3.text   = "0"
tab_1.tp_mover_pallets.em_piezas_3.text  = "0"

tab_1.tp_mover_pallets.p_subir3.enabled = true
tab_1.tp_mover_pallets.p_bajar3.enabled = true

ib_lanzar_modified = false
tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.selectrow(0,false)
ib_lanzar_modified = true
end event

event modified;call super::modified;long ll_donde
string  ls_busqueda,ls_lineas_bulto
integer li_lineas_bulto

//¿cambiar este evento o el evento que lanza el boton v?

if il_id_bulto = 0 or ii_lineas_bulto = 0 then
	f_reset()
	messagebox("¡Atención!","Debe seleccionar un bulto con contenido.",StopSign!)
	this.SetFocus()
	this.event getfocus()	
else
	if ii_bultos > 1 then
		Messagebox("Error","Ha seleccionado un origen con mas de un bulto~nDebe hacer la lectura de la etiqueta del bulto.")
		this.SetFocus()
		this.event getfocus()			
	else	
		if il_id_bulto = uo_lectura_destino_3.il_id_bulto then
			messagebox("¡Atención!","Debe seleccionar un bulto distinto al destino.",StopSign!)
			this.SetFocus()
			this.event getfocus()				
		else		
			ls_lineas_bulto = tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.describe('evaluate("sum(if (alm_bultos_id = '+string(il_id_bulto)+',1,0) for all)",1)')
			li_lineas_bulto = integer(ls_lineas_bulto)			
			
			ls_busqueda = "alm_bultos_id     = "+string(il_id_bulto)+" and "+&
							  "venliped_articulo = '"+is_codigo_articulo+"' and "+&
							  "venliped_calidad  = '"+is_codigo_calidad+"' and "+&
							  "venliped_tonochar = '"+is_lote+"' and "+&
							  "venliped_calibre  = "+string(ii_calibre,"#0")+" and "+&
							  "venliped_caja     = '"+is_codigo_caja+"' "
							  			
			ll_donde = tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.find(ls_busqueda,1,tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.rowcount())
			
			if ll_donde > 0 then
				tab_1.tp_mover_pallets.p_subir3.enabled = false
				tab_1.tp_mover_pallets.p_bajar3.enabled = false
	
				tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.selectrow(0,false)
				tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.selectrow(ll_donde,true)
				tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.setrow(ll_donde)
				tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.scrolltorow(ll_donde)
				
				tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.event rowfocuschanged(ll_donde)
			else
				//Primero vamos a comprobar si el bulto leido tiene lineas reservadas preparadas
				
				ls_busqueda = "alm_bultos_id    <> "+string(il_id_bulto)+" and "+&
								  "venliped_articulo = '"+is_codigo_articulo+"' and "+&
								  "venliped_calidad  = '"+is_codigo_calidad+"' and "+&
								  "venliped_tonochar = '"+is_lote+"' and "+&
								  "venliped_calibre  = "+string(ii_calibre,"#0")+" and "+&
								  "venliped_caja     = '"+is_codigo_caja+"' and "+&
								  "venliped_tipo_pallet = '"+is_codigo_pallet+"' and "+&
								  "venliped_reservas_cantidad = "+string(il_piezas)+""								  
											
				ll_donde = tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.find(ls_busqueda,1,tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.rowcount())
				
				if ll_donde > 0 and istr_almubimapa_codbar.apilado_en_bloque = 'S' then				
					//Si es una ubicación de apilado en bloque, y tenemos reservas en la orden que coinciden con el tipo de producto, 
					//hacemos un intercambio de las reservas y damos la lectura como correcta
					
					
					//buscamos las reservas del bulto que acabamos de leer y las de la linea que hemos encontrado
					string  ls_sel
					integer li_total_reservas_bulto_actual,li_total_reservas_linea_pedido_actual,li_indice
					long    id_bulto_pedido_actual,ll_alm_bultos_lineas_id_bulto_actual,ll_alm_bultos_lineas_id_linea_pedido_actual
					boolean lb_correcto
					datastore lds_reservas_bulto_actual
					datastore lds_reservas_linea_pedido_actual
					
					ls_sel = "SELECT venliped_reservas.empresa, "+&
								"       venliped_reservas.anyo, "+&
								"       venliped_reservas.pedido, "+&
								"       venliped_reservas.linea, "+&
								"       venliped_reservas.alm_bultos_lineas_id, "+&
								"       venliped_reservas.cantidad, "+&
								"       venliped_reservas.id_ubicacion_original, "+&
								"       venliped_reservas.id_ubicacion_destino, "+&
								"       venliped_reservas.bulto_orden_carga, "+&
								"       venliped_reservas.preparado "+&
								"FROM   venliped_reservas, "+&
								"       alm_bultos_lineas, "+&
								"       alm_bultos "+&
								"WHERE ( venliped_reservas.alm_bultos_lineas_id = alm_bultos_lineas.id ) "+&
								"AND   ( alm_bultos_lineas.id_alm_bultos = alm_bultos.id ) "+&
								"AND ( ( alm_bultos.id = "+string(il_id_bulto)+" ) )"
					
					li_total_reservas_bulto_actual = f_cargar_cursor_transaccion(sqlca,lds_reservas_bulto_actual,ls_sel)
					
					lds_reservas_bulto_actual.Modify("DataWindow.Table.UpdateTable='venliped_reservas'")
					lds_reservas_bulto_actual.Modify("DataWindow.Table.UpdateKeyInPlace=yes")
					lds_reservas_bulto_actual.Modify("DataWindow.Table.UpdateWhere=0")
					
					lds_reservas_bulto_actual.Modify("venliped_reservas_empresa.key=yes")
					lds_reservas_bulto_actual.Modify("venliped_reservas_anyo.key=yes")
					lds_reservas_bulto_actual.Modify("venliped_reservas_pedido.key=yes")
					lds_reservas_bulto_actual.Modify("venliped_reservas_linea.key=yes")
					lds_reservas_bulto_actual.Modify("venliped_reservas_alm_bultos_lineas_id.key=yes")
					lds_reservas_bulto_actual.Modify("venliped_reservas_empresa.key=yes")
					
					lds_reservas_bulto_actual.Modify("venliped_reservas_alm_bultos_lineas_id.Update=Yes")					
					
					if li_total_reservas_bulto_actual > 0 then
						ll_alm_bultos_lineas_id_bulto_actual = lds_reservas_bulto_actual.object.venliped_reservas_alm_bultos_lineas_id[1]
					else
						select alm_bultos_lineas.id
						into   :ll_alm_bultos_lineas_id_bulto_actual
						from   alm_bultos_lineas 
						where  alm_bultos_lineas.id_alm_bultos = :il_id_bulto;
					end if

					ls_sel = "SELECT venliped_reservas.empresa, "+&
								"       venliped_reservas.anyo, "+&
								"       venliped_reservas.pedido, "+&
								"       venliped_reservas.linea, "+&
								"       venliped_reservas.alm_bultos_lineas_id, "+&
								"       venliped_reservas.cantidad, "+&
								"       venliped_reservas.id_ubicacion_original, "+&
								"       venliped_reservas.id_ubicacion_destino, "+&
								"       venliped_reservas.bulto_orden_carga, "+&
								"       venliped_reservas.preparado "+&
								"FROM   venliped_reservas, "+&
								"       alm_bultos_lineas "+&
								"WHERE ( venliped_reservas.alm_bultos_lineas_id = alm_bultos_lineas.id ) "+&
								"AND   ( venliped_reservas.empresa = '"+codigo_empresa+"' ) "+&
								"AND   ( venliped_reservas.anyo    = "+string(tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.object.venped_anyo[ll_donde])+" ) "+&
								"AND   ( venliped_reservas.pedido  = "+string(tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.object.venped_pedido[ll_donde])+" ) "+&
								"AND   ( venliped_reservas.linea   = "+string(tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.object.venliped_linea[ll_donde])+" ) "+&
								"AND   ( alm_bultos_lineas.id_alm_bultos = "+string(tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.object.alm_bultos_id[ll_donde])+" )"
					
					li_total_reservas_linea_pedido_actual = f_cargar_cursor_transaccion(sqlca,lds_reservas_linea_pedido_actual,ls_sel)
					
					lds_reservas_linea_pedido_actual.Modify("DataWindow.Table.UpdateTable='venliped_reservas'")
					lds_reservas_linea_pedido_actual.Modify("DataWindow.Table.UpdateKeyInPlace=yes")
					lds_reservas_linea_pedido_actual.Modify("DataWindow.Table.UpdateWhere=0")
					
					lds_reservas_linea_pedido_actual.Modify("venliped_reservas_empresa.key=yes")
					lds_reservas_linea_pedido_actual.Modify("venliped_reservas_anyo.key=yes")
					lds_reservas_linea_pedido_actual.Modify("venliped_reservas_pedido.key=yes")
					lds_reservas_linea_pedido_actual.Modify("venliped_reservas_linea.key=yes")
					lds_reservas_linea_pedido_actual.Modify("venliped_reservas_alm_bultos_lineas_id.key=yes")
					lds_reservas_linea_pedido_actual.Modify("venliped_reservas_empresa.key=yes")
					
					lds_reservas_linea_pedido_actual.Modify("venliped_reservas_alm_bultos_lineas_id.Update=Yes")
					
					id_bulto_pedido_actual = tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.object.alm_bultos_id[ll_donde]
					
					if li_total_reservas_linea_pedido_actual > 0 then
						ll_alm_bultos_lineas_id_linea_pedido_actual = lds_reservas_linea_pedido_actual.object.venliped_reservas_alm_bultos_lineas_id[1]
					else
						select alm_bultos_lineas.id
						into   :ll_alm_bultos_lineas_id_linea_pedido_actual
						from   alm_bultos_lineas 
						where  alm_bultos_lineas.id_alm_bultos = :id_bulto_pedido_actual;
					end if										
					
					for li_indice = 1 to li_total_reservas_bulto_actual
						lds_reservas_bulto_actual.object.venliped_reservas_alm_bultos_lineas_id[li_indice] = ll_alm_bultos_lineas_id_linea_pedido_actual
					next

					for li_indice = 1 to li_total_reservas_linea_pedido_actual
						lds_reservas_linea_pedido_actual.object.venliped_reservas_alm_bultos_lineas_id[li_indice] = ll_alm_bultos_lineas_id_bulto_actual
					next
								
					if lds_reservas_bulto_actual.update() = 1 then
						if lds_reservas_linea_pedido_actual.update() = 1 then
							commit;		
							lb_correcto = true
						else
							rollback;
							lb_correcto = false
						end if						
					else
						messagebox("Error",sqlca.sqlerrtext)
						rollback;
						lb_correcto = false
					end if
								
					destroy lds_reservas_bulto_actual
					destroy lds_reservas_linea_pedido_actual					
					
					if lb_correcto then
						tab_1.tp_mover_pallets.p_subir3.enabled = false
						tab_1.tp_mover_pallets.p_bajar3.enabled = false
			
						tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.selectrow(0,false)
						tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.object.alm_bultos_id[ll_donde] = il_id_bulto
						tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.selectrow(ll_donde,true)
						tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.setrow(ll_donde)
						tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.scrolltorow(ll_donde)
						
						tab_1.tp_mover_pallets.dw_lineas_pallets_orden_3.event rowfocuschanged(ll_donde)						
					else
						messagebox("¡Atención!","Error al intercambiar las reservas.",StopSign!)			
						this.SetFocus()
						this.event getfocus()								
					end if
				else
					//f_reset()
					messagebox("¡Atención!","Debe seleccionar un bulto de la orden.",StopSign!)			
					this.SetFocus()
					this.event getfocus()		
				end if
			end if
		end if
	end if	
end if


/*
if il_id_bulto = 0 or ii_lineas_bulto = 0 then
	f_reset()
	messagebox("¡Atención!","Debe seleccionar un bulto con contenido.",StopSign!)
	this.SetFocus()
	this.event getfocus()	
else
	if ii_bultos > 1 then
		Messagebox("Error","Ha seleccionado un origen con mas de un bulto~nDebe hacer la lectura de la etiqueta del bulto.")
		this.SetFocus()
		this.event getfocus()			
	else
		string ls_articulo,ls_pallet,ls_caja
		int    li_piezas_caja,li_cajas_maximas
		long   ll_piezas_pallet,ll_piezas_bulto, li_cajas_pallet
				
		ls_articulo     = uo_lectura_origen_3.is_codigo_articulo
		ls_pallet       = uo_lectura_origen_3.is_codigo_pallet
		ls_caja         = uo_lectura_origen_3.is_codigo_caja
		ll_piezas_bulto = uo_lectura_origen_3.il_piezas - uo_lectura_origen_3.il_piezas_reservadas_bulto
	
//Solo controlamos la piezas reservadas de ese bulto	
//		if ll_piezas_bulto > uo_lectura_origen_3.il_piezas_disponibles_totales then
//			ll_piezas_bulto = uo_lectura_origen_3.il_piezas_disponibles_totales
//		end if
		
		select isnull(almartcajas.piezascaja,0),
				 isnull(palarticulo.cajaspallet,0),
				 isnull(palarticulo.cajaspallet,0) * isnull(almartcajas.piezascaja,0) 
		into   :li_piezas_caja,
				 :li_cajas_pallet,
				 :ll_piezas_pallet 
		from   almartcajas,palarticulo
		where  almartcajas.empresa  = palarticulo.empresa 
		and    almartcajas.articulo = palarticulo.articulo 
		and    almartcajas.caja     = palarticulo.caja 
		and    almartcajas.empresa  = :codigo_empresa 
		and    almartcajas.articulo = :ls_articulo 
		and    almartcajas.caja     = :ls_caja 
		and    palarticulo.codigo   = :ls_pallet;
		
		if li_piezas_caja = 0 then
			select isnull(almartcajas.piezascaja,0),
					 0,
					 0 
			into   :li_piezas_caja,
					 :li_cajas_pallet,
					 :ll_piezas_pallet 
			from   almartcajas
			where  almartcajas.empresa  = :codigo_empresa 
			and    almartcajas.articulo = :ls_articulo 
			and    almartcajas.caja     = :ls_caja;			
			
		end if
		
		if li_piezas_caja <> 0 then
			li_cajas_maximas = truncate(ll_piezas_bulto / li_piezas_caja,0)
		else
			li_cajas_maximas = 0
		end if
				
		if ll_piezas_bulto >= ll_piezas_pallet and ll_piezas_pallet > 0 then
		else
		end if
		//editmask			
	end if	
end if
*/
end event

event ue_siguiente_objeto;call super::ue_siguiente_objeto;
tab_1.tp_mover_pallets.uo_lectura_destino_3.visible = true

tab_1.tp_mover_pallets.uo_lectura_destino_3.SetFocus()
tab_1.tp_mover_pallets.uo_lectura_destino_3.event getfocus()
end event

event ue_pre_siguiente_objeto;call super::ue_pre_siguiente_objeto;pb_atras_3.visible           = true
end event

