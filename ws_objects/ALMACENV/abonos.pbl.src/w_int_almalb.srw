$PBExportHeader$w_int_almalb.srw
forward
global type w_int_almalb from w_int_con_empresa
end type
type pb_salir from upb_salir within w_int_almalb
end type
type st_3 from statictext within w_int_almalb
end type
type st_texto_cantidad from statictext within w_int_almalb
end type
type st_pallets from statictext within w_int_almalb
end type
type st_total_cajas from statictext within w_int_almalb
end type
type st_cajas from statictext within w_int_almalb
end type
type st_tipopallet from statictext within w_int_almalb
end type
type st_calidad from statictext within w_int_almalb
end type
type st_articulo from statictext within w_int_almalb
end type
type em_t_pallets from u_em_campo within w_int_almalb
end type
type em_cajas from u_em_campo within w_int_almalb
end type
type em_t_cajas from u_em_campo within w_int_almalb
end type
type em_cantidad from u_em_campo within w_int_almalb
end type
type uo_articulo from u_em_campo_2 within w_int_almalb
end type
type uo_calidad from u_em_campo_2 within w_int_almalb
end type
type uo_tipo_pallet from u_em_campo_2 within w_int_almalb
end type
type st_texto_mtrslinieales from statictext within w_int_almalb
end type
type em_mtrs_lineales from u_em_campo within w_int_almalb
end type
type cb_grabar from u_boton within w_int_almalb
end type
type cb_borrar from u_boton within w_int_almalb
end type
type em_descripcion from u_em_campo within w_int_almalb
end type
type st_33 from statictext within w_int_almalb
end type
type cb_insertar from u_boton within w_int_almalb
end type
type uo_tipolinea from u_em_campo_2 within w_int_almalb
end type
type st_tplinea from statictext within w_int_almalb
end type
type cb_stock from u_boton within w_int_almalb
end type
type em_anyo from u_em_campo within w_int_almalb
end type
type em_situacion from u_em_campo within w_int_almalb
end type
type gb_4 from groupbox within w_int_almalb
end type
type em_falbaran from u_em_campo within w_int_almalb
end type
type st_tono from statictext within w_int_almalb
end type
type em_tono from u_em_campo within w_int_almalb
end type
type st_calibre from statictext within w_int_almalb
end type
type em_calibre from u_em_campo within w_int_almalb
end type
type st_deposito from statictext within w_int_almalb
end type
type deposito from statictext within w_int_almalb
end type
type pb_2 from u_calculadora within w_int_almalb
end type
type st_21 from statictext within w_int_almalb
end type
type st_2 from statictext within w_int_almalb
end type
type cb_1 from u_boton within w_int_almalb
end type
type st_23 from statictext within w_int_almalb
end type
type st_4 from statictext within w_int_almalb
end type
type st_peso_linea from statictext within w_int_almalb
end type
type st_peso_total from statictext within w_int_almalb
end type
type st_7 from statictext within w_int_almalb
end type
type st_5 from statictext within w_int_almalb
end type
type st_6 from statictext within w_int_almalb
end type
type uo_cliente from u_em_campo_2 within w_int_almalb
end type
type em_albaran from u_em_campo within w_int_almalb
end type
type pb_imprimir from upb_imprimir within w_int_almalb
end type
type pb_imprimir2 from upb_imprimir within w_int_almalb
end type
type st_333 from statictext within w_int_almalb
end type
type dw_listado from datawindow within w_int_almalb
end type
type cb_ubicar from u_boton within w_int_almalb
end type
type cb_2 from commandbutton within w_int_almalb
end type
type cb_3 from commandbutton within w_int_almalb
end type
type cantidad from editmask within w_int_almalb
end type
type st_cantidad from statictext within w_int_almalb
end type
type uo_caja from u_em_campo_2 within w_int_almalb
end type
type st_caja from statictext within w_int_almalb
end type
type em_prec from u_em_campo within w_int_almalb
end type
type st_precio from statictext within w_int_almalb
end type
type uo_serie from u_em_campo_2 within w_int_almalb
end type
type gb_1 from groupbox within w_int_almalb
end type
type st_idioma from statictext within w_int_almalb
end type
type uo_idioma from u_em_campo_2 within w_int_almalb
end type
type sle_dtoesp2 from singlelineedit within w_int_almalb
end type
type st_1 from statictext within w_int_almalb
end type
type dw_ubicaciones from u_datawindow within w_int_almalb
end type
type dw_detalle from datawindow within w_int_almalb
end type
type cb_desubicar from u_boton within w_int_almalb
end type
type em_tono_imprimir from u_em_campo within w_int_almalb
end type
type st_14 from statictext within w_int_almalb
end type
type st_13 from statictext within w_int_almalb
end type
type em_calibre_imprimir from u_em_campo within w_int_almalb
end type
end forward

global type w_int_almalb from w_int_con_empresa
integer width = 3246
integer height = 2112
string title = "Introducción lineas de abono"
pb_salir pb_salir
st_3 st_3
st_texto_cantidad st_texto_cantidad
st_pallets st_pallets
st_total_cajas st_total_cajas
st_cajas st_cajas
st_tipopallet st_tipopallet
st_calidad st_calidad
st_articulo st_articulo
em_t_pallets em_t_pallets
em_cajas em_cajas
em_t_cajas em_t_cajas
em_cantidad em_cantidad
uo_articulo uo_articulo
uo_calidad uo_calidad
uo_tipo_pallet uo_tipo_pallet
st_texto_mtrslinieales st_texto_mtrslinieales
em_mtrs_lineales em_mtrs_lineales
cb_grabar cb_grabar
cb_borrar cb_borrar
em_descripcion em_descripcion
st_33 st_33
cb_insertar cb_insertar
uo_tipolinea uo_tipolinea
st_tplinea st_tplinea
cb_stock cb_stock
em_anyo em_anyo
em_situacion em_situacion
gb_4 gb_4
em_falbaran em_falbaran
st_tono st_tono
em_tono em_tono
st_calibre st_calibre
em_calibre em_calibre
st_deposito st_deposito
deposito deposito
pb_2 pb_2
st_21 st_21
st_2 st_2
cb_1 cb_1
st_23 st_23
st_4 st_4
st_peso_linea st_peso_linea
st_peso_total st_peso_total
st_7 st_7
st_5 st_5
st_6 st_6
uo_cliente uo_cliente
em_albaran em_albaran
pb_imprimir pb_imprimir
pb_imprimir2 pb_imprimir2
st_333 st_333
dw_listado dw_listado
cb_ubicar cb_ubicar
cb_2 cb_2
cb_3 cb_3
cantidad cantidad
st_cantidad st_cantidad
uo_caja uo_caja
st_caja st_caja
em_prec em_prec
st_precio st_precio
uo_serie uo_serie
gb_1 gb_1
st_idioma st_idioma
uo_idioma uo_idioma
sle_dtoesp2 sle_dtoesp2
st_1 st_1
dw_ubicaciones dw_ubicaciones
dw_detalle dw_detalle
cb_desubicar cb_desubicar
em_tono_imprimir em_tono_imprimir
st_14 st_14
st_13 st_13
em_calibre_imprimir em_calibre_imprimir
end type
global w_int_almalb w_int_almalb

type variables
string filtro,bloqueado,cabecera = "N"
Integer bien,ante_pallets,ante_cajas
decimal{2} ante_valor
String  tipo // I-> inserción , M -> Modificación
Dec{0}  linea_albaran
String  cod_tipo_unidad,cod_formato,cod_familia,var_control_alm,var_sector,var_clase,control_incremento
String idioma_ant,articulo_ant,calidad_ant,tipolinea_ant,referencia_ant,tipopallet_ant
Dec{2} precio_ant,ante_existencias,var_total
str_venalb venalb
String campo_actual,var_situacion,var_tipo_pallet_preparacion  
Integer tipo_precio
Dec em_precio,em_dto
String  var_calidad,var_tipo_pallet,var_articulo,var_tono,var_caja
Dec{0}  var_calibre
Dec{2}  var_cantidad
boolean control_tono,control_calibre
end variables

forward prototypes
public subroutine f_grabar_linea ()
public subroutine f_borrar_linea ()
public subroutine f_botones ()
public subroutine f_calculo_precio ()
public subroutine f_consulta_disponible ()
public subroutine f_activar_primer_campo ()
public subroutine f_campos_segun_tiplin ()
public subroutine f_control ()
public subroutine f_peso_linea ()
public subroutine f_recalcular_lineas ()
public subroutine f_deposito ()
public subroutine f_leer_cab ()
public subroutine f_ubicar ()
public function boolean f_entrada_almacen (string empresa, decimal anyo, decimal albaran, decimal linea)
public subroutine f_ubi (integer opcion)
public subroutine f_activar (boolean r)
public subroutine f_control_tono_calibre ()
public function boolean f_entrada_deposito (string almacen, string referencia, string tipo_pallet, decimal vcantidad)
public function boolean f_salida_deposito (string almacen, string referencia, string tipo_pallet, decimal vcantidad, string ar_caja)
public subroutine f_desubicar ()
public function boolean f_salida_almacen (string empresa, decimal anyo, decimal albaran, decimal linea)
end prototypes

public subroutine f_grabar_linea ();str_venlialb linalb
Dec var_ejercicio
var_ejercicio = f_ejercicio_activo(codigo_empresa)
str_venalb   alb 
alb.falbaran = DateTime(Date(em_falbaran.text))

linalb.situacion = "P"
SetNull(linalb.anyo_ent)
SetNull(linalb.nummov_ent)
SetNull(linalb.anyo_sal)
SetNull(linalb.nummov_sal)
SetNull(linalb.fila_ent)
SetNull(linalb.altura_ent)
SetNull(linalb.operario_prepa)
linalb.numpalet = 0
linalb.anyo_proddiaria = 0
linalb.contador_proddiaria = 0

Dec{0}  ultima,albaran,periodo,parcial_pallets

periodo   =  Integer(em_anyo.text)
albaran   =  Dec(em_albaran.text)
linalb.falbaran = DateTime(Date(em_falbaran.text))
alb.falbaran    = DateTime(Date(em_falbaran.text))
venalb.falbaran = DateTime(Date(em_falbaran.text))

  SELECT venlialb.precio_estand,   
         venlialb.orden_preparacion,   
         venlialb.cantidad_prepa,   
         venlialb.es_pico,   
         venlialb.numero_pico,   
         venlialb.anyo_ent,   
         venlialb.nummov_ent,   
         venlialb.anyo_sal,   
         venlialb.nummov_sal,   
         venlialb.fila_ent,   
         venlialb.altura_ent,   
         venlialb.operario_prepa,   
         venlialb.almacen_ent,   
         venlialb.precio_aduana,   
         venlialb.precio
    INTO :linalb.precio_estand,   
         :linalb.orden_preparacion,   
         :linalb.cantidad_prepa,   
         :linalb.es_pico,   
         :linalb.numero_pico,   
         :linalb.anyo_ent,   
         :linalb.nummov_ent,   
         :linalb.anyo_sal,   
         :linalb.nummov_sal,   
         :linalb.fila_ent,   
         :linalb.altura_ent,   
         :linalb.operario_prepa,   
         :linalb.almacen_ent,   
         :linalb.precio_aduana,   
         :linalb.precio
   	From venlialb
	WHERE ( venlialb.empresa   = :codigo_empresa ) AND  
         ( venlialb.anyo      = :periodo ) AND  
         ( venlialb.albaran   = :albaran ) AND  
         ( venlialb.linea     = :linea_albaran);
			
UPDATE venlialb
Set  venlialb.falbaran = :alb.falbaran
	WHERE ( venlialb.empresa   = :codigo_empresa ) AND  
         ( venlialb.anyo      = :periodo ) AND  
         ( venlialb.albaran   = :albaran );

UPDATE venalb
Set  venalb.falbaran = :alb.falbaran
	WHERE ( venalb.empresa   = :codigo_empresa ) AND  
         ( venalb.anyo      = :periodo ) AND  
         ( venalb.albaran   = :albaran );



linalb.control_incremento = control_incremento 
IF Trim(linalb.control_incremento) = "" or IsNull(linalb.control_incremento) Then
 	linalb.control_incremento = "S"
END IF	

IF tipo ="I" THEN
 ultima =  0
 Select max(venlialb.linea) Into :ultima From venlialb
 Where  venlialb.empresa   =   :codigo_empresa
 And    venlialb.anyo      =   :periodo
 And    venlialb.albaran    =   :albaran;
 IF ISNull(ultima) Then ultima=0
 ultima = ultima +1
END IF

linalb.empresa   = venalb.empresa
linalb.anyo      = venalb.anyo
linalb.albaran   = venalb.albaran
linalb.falbaran  = venalb.falbaran
linalb.cliente   = venalb.cliente
linalb.tipoiva   = venalb.tipoiva
linalb.iva       = venalb.iva
linalb.divisa    = venalb.divisa
linalb.serie     = venalb.serie
linalb.zona      = venalb.zona
linalb.agente1   = venalb.agente1
linalb.agente2   = venalb.agente2
linalb.agente3   = venalb.agente3
linalb.comision11= venalb.comision1
linalb.comision12= venalb.comision11
linalb.comision21= venalb.comision2
linalb.comision22= venalb.comision22
linalb.comision31= venalb.comision31
linalb.comision32= venalb.comision32
linalb.linea     = ultima
linalb.articulo  = uo_articulo.em_codigo.text
linalb.clase     = var_clase
linalb.sector    = var_sector
linalb.tonochar  = Trim(em_tono.text)
linalb.calibre   = Dec(em_calibre.text)
linalb.tono_imprimir = em_tono_imprimir.text
linalb.calibre_imprimir = em_calibre_imprimir.text
IF Isnull(linalb.tonochar)    Then linalb.tonochar = ""
IF Isnull(linalb.calibre) Then linalb.calibre = 0
linalb.deposito = "N"
  IF deposito.text = "X" Then
	linalb.deposito = "S"
	linalb.almacen_deposito = f_depalmacen_cliente(linalb.empresa,linalb.cliente)
	IF IsNUll(linalb.almacen_deposito) or trim(linalb.almacen_deposito) = ""Then
		f_mensaje("Error en datos","Este cliente no tiene un almacen de deposito asignado" )
		RETURN
	END IF
  END IF

SELECT articulos.empresa,
       articulos.codigo,
		 articulos.familia,
		 articulos.subfamilia,
       articulos.formato,
		 articulos.subformato,
		 articulos.modelo,
		 articulos.unidad,
		 articulos.pesopieza
INTO   :linalb.empresa,
       :linalb.articulo,
		 :linalb.familia,
		 :linalb.subfamilia,
		 :linalb.formato,
		 :linalb.subformato,
       :linalb.modelo,
		 :linalb.tipo_unidad,
		 :linalb.peso    
FROM articulos  
WHERE (articulos.empresa = :codigo_empresa )
AND   (articulos.codigo = :linalb.articulo ) ;



linalb.calidad         = uo_calidad.em_codigo.text
linalb.precio       	  = dec(em_prec.text)
linalb.precio_aduana   = 0
linalb.precio_estand   = f_precio_articulo(linalb.empresa,linalb.cliente,linalb.articulo,linalb.calidad,f_tarifa_venalb(linalb.empresa,linalb.anyo,linalb.albaran))
linalb.cantidad        = Dec(em_cantidad.text)
linalb.cantidad_pedido = Dec(em_cantidad.text)
linalb.pallets         = Dec(em_t_pallets.text)
linalb.total_cajas     = Dec(em_t_cajas.text)
linalb.cajas           = Dec(em_cajas.text)
linalb.dtocomer        = 0
linalb.dtoesp          = em_dto
linalb.descripcion     = em_descripcion.text
linalb.idioma          = uo_idioma.em_campo.text
linalb.cantidad_original = Dec(em_cantidad.text)
SetNull(linalb.linea_desdoblada_de)


  SELECT familias.linea INTO :linalb.linfab FROM familias  
   WHERE familias.empresa = :codigo_empresa 
	AND   familias.codigo = :linalb.familia;
	
String   var_tipoter
SELECT genter.empresa,genter.tipoter,genter.codigo,genter.pais,
       genter.provincia  
INTO   :alb.empresa,:var_tipoter,:alb.cliente,:linalb.pais,:linalb.provincia  
FROM   genter  
WHERE (genter.empresa = :codigo_empresa)
AND   (genter.tipoter = 'C' )
AND   (genter.codigo = :linalb.cliente );

linalb.tipolinea       = uo_tipolinea.em_codigo.text
linalb.texto1          = ""
linalb.texto2          = ""
linalb.texto3          = ""
linalb.referencia      = f_componer_ref(linalb.articulo,linalb.calidad,linalb.tonochar,linalb.calibre)
linalb.montajeartcal   = f_componer_artcal(linalb.articulo,linalb.calidad)
linalb.situacion       = em_situacion.text
linalb.metros_lineales = Dec(em_mtrs_lineales.text)
linalb.falta           = Datetime(today())
linalb.usuario         = nombre_usuario
linalb.tipo_pallet     = uo_tipo_pallet.em_codigo.text
linalb.caja            = uo_caja.em_codigo.text

IF tipo="M" THEN
	DELETE FROM venlialb  
   WHERE venlialb.empresa   = :linalb.empresa
	AND   venlialb.anyo      = :linalb.anyo
	AND   venlialb.albaran  = :linalb.albaran 
	AND   venlialb.linea   = :linea_albaran ;
     linalb.linea   = linea_albaran
END IF


 IF var_control_alm = "N" Then 
    SetNull(linalb.articulo)
    SetNull(linalb.formato)
    SetNull(linalb.modelo)
    SetNull(linalb.calidad)
    SetNull(linalb.tonochar)
    SetNull(linalb.calibre)
    SetNull(linalb.pallets)
    SetNull(linalb.total_cajas)
    SetNull(linalb.cajas)
    SetNull(linalb.linfab)
    SetNull(linalb.referencia)
    SetNull(linalb.montajeartcal)
    SetNull(linalb.tipo_pallet)
	 SetNull(linalb.caja)
    //linalb.tipo_unidad = "0"
  END IF
SetNull(linalb.orden_preparacion)
  linalb.cantidad_prepa = 0
  IF linalb.pallets = 0 or IsNull(linalb.pallets) Then
	    linalb.es_pico = "S"
  ELSE		 
	    linalb.es_pico = "N"
  END IF	
  If linalb.control_incremento = "S" Then 
	 If linalb.pallets >1 Then linalb.control_incremento = "N"
  END IF	
  // David 05-02-04  Utilizamos el dtoesp2 para los descuentos por cliente articulo y fecha
	linalb.dtoesp2 			= dec(sle_dtoesp2.text)
	// Fin David 

  IF Not f_insertar_venlialb(linalb) Then bien = 1
  IF cabecera = "N" Then  
	alb.empresa = linalb.empresa
	alb.anyo    = linalb.anyo
	alb.albaran = linalb.albaran
 	alb.abono   = "S"
	cabecera    = "S"
	

	    SELECT venclientes.zona,venclientes.serie,venclientes.agente1,   
                      venclientes.agente2,venclientes.agente3,venclientes.comision1, venclientes.comision2,   venclientes.comision31,
                      venclientes.cod_pago,venclientes.dtopp,venclientes.dtoesp1,   
                      venclientes.dtoesp2, venclientes.tipoiva,
						    venclientes.forma_envio, venclientes.tipo_portes,   
							 venclientes.cod_entrega, venclientes.periodo_fac,   
							 venclientes.explicaciondto1, venclientes.explicaciondto2,   
							 venclientes.tarifa,   
							 venclientes.comision11,      venclientes.comision22,   venclientes.comision31, 
							 venclientes.dtoesp3,         venclientes.dtoesp4,   
							 venclientes.explicaciondto3, venclientes.explicaciondto4,   
							 venclientes.tipodto1,        venclientes.tipodto2,   
							 venclientes.tipodto3,        venclientes.tipodto4,   
							 venclientes.empresa,         venclientes.codigo  ,
							 venclientes.cod_entrega,     venclientes.calculo_dto  ,
							 venclientes.banco_de_cobro,  venclientes.envio,
							 venclientes.correspondencia,venclientes.domiciliacion,venclientes.transportista,
							 venclientes.deposito,venclientes.agrupa
					INTO   :alb.zona, :alb.serie, :alb.agente1, :alb.agente2,:alb.agente3,:alb.comision1,   
                      :alb.comision2,:alb.comision31,:alb.codpago,:alb.dtopp,:alb.dtoesp1,
						    :alb.dtoesp2,:alb.tipoiva, :alb.forma_envio,   
						    :alb.tipo_portes,:alb.cod_entrega,:alb.periodo_fac,
						    :alb.explicaciondto1,:alb.explicaciondto2,   
						    :alb.tarifa,:alb.comision11,:alb.comision22,:alb.comision31,:alb.dtoesp3,   
					       :alb.dtoesp4,:alb.explicaciondto3,:alb.explicaciondto4,
						    :alb.tipodto1,:alb.tipodto2,:alb.tipodto3,:alb.tipodto4,   
						    :alb.empresa,:alb.cliente ,:alb.cod_entrega,
							 :alb.calculo_dto,:alb.banco_de_cobro,
							 :alb.envio,:alb.correspondencia,
							 :alb.domiciliacion,:alb.transportista,
							 :alb.deposito,:alb.agrupa
					FROM   venclientes  
               WHERE  ( venclientes.empresa = :codigo_empresa ) AND  
                      ( venclientes.codigo = :alb.cliente )   ;

               Select  genter.idioma,genter.moneda
               Into    :alb.idioma,:alb.divisa
               From genter
               Where   genter.empresa = :codigo_empresa 
               And     genter.tipoter = 'C'
               And     genter.codigo  = :alb.cliente;
			
				// David 05-02-02. Añado el cambio de moneda en los abonos. Antes no se grababa
				alb.cambio = f_cambio_moneda(alb.divisa)
   	  
					SELECT contaiva.iva  INTO :alb.iva  
					FROM contaiva  
					WHERE ( contaiva.ejercicio = :var_ejercicio ) AND  
					   	( contaiva.empresa = :codigo_empresa ) AND  
							( contaiva.tipoiva = :alb.tipoiva )   ;
	  alb.calculo_dto = "N"

	// David 04-06-04. Control del documento de impresión (Depósito o No Depósito)
	long i	

	alb.deposito = 'N'

	IF deposito.text = "X" Then
		alb.deposito = 'S'
	end if
	
	for i = 1 to dw_detalle.rowcount()
		if dw_detalle.object.almacen_deposito[i] = 'S' then
			alb.deposito = 'S'
		end if
	next
	
	
	
	IF Not f_insertar_venalb(alb) Then
		bien = 1
		f_mensaje("error",sqlca.sqlerrtext)
	END IF
	END IF
	COMMIT;
	f_actualizar_linea_venalbaran(codigo_empresa,periodo,albaran,linalb.linea)
	f_actualizar_venalbaran(codigo_empresa,periodo,albaran)
COMMIT;

end subroutine

public subroutine f_borrar_linea ();Dec{0}periodo,albaran,lineas

periodo = Dec(em_anyo.text)
albaran  = Dec(em_albaran.text)

DELETE FROM venlialb 
WHERE  venlialb.empresa = :codigo_empresa
AND    venlialb.anyo    = :periodo
AND    venlialb.albaran  = :albaran
AND    venlialb.linea   = :linea_albaran;

if sqlca.sqlcode <> 0 then
	rollback;
	messagebox("Atención","Se ha producido un error al borrar la linea del albaran.")
else
	select count(*)
	into   :lineas
	from   venlialb
	WHERE  venlialb.empresa = :codigo_empresa
	AND    venlialb.anyo    = :periodo
	AND    venlialb.albaran = :albaran;
	
	if isnull(lineas) then lineas = 0
	if lineas = 0 then
		DELETE FROM venalb 
		WHERE  venalb.empresa = :codigo_empresa
		AND    venalb.anyo    = :periodo
		AND    venalb.albaran = :albaran;
		
		// Limpiamos pantalla
		
		uo_serie.em_codigo.text = ''
		uo_serie.em_campo.text = ''
		em_albaran.text = ''
		em_albaran.text = ''
		uo_cliente.em_codigo.text = ''
		uo_cliente.em_campo.text = ''
		setnull (em_falbaran.text )
		
		if sqlca.sqlcode <> 0 then
			rollback;
			messagebox("Atención","Se ha producido un error al borrar la cabecera del albaran.")
		else
			if f_actualizar_venalbaran(codigo_empresa,periodo,albaran) then
				COMMIT;	
			else
				rollback;
				messagebox("Atención","Se ha producido un error al actualizar la cabecera del albaran.")
			end if
		end if
	else
		if f_actualizar_venalbaran(codigo_empresa,periodo,albaran) then
			COMMIT;	
		else
			rollback;
			messagebox("Atención","Se ha producido un error al actualizar la cabecera del albaran.")
		end if
	end if	
end if
end subroutine

public subroutine f_botones ();  	cb_borrar.enabled   = TRUE
  	cb_grabar.enabled   = TRUE
	cb_insertar.enabled = TRUE
	cb_stock.enabled    = TRUE
	
	
	IF tipo = "I" Then
		cb_insertar.enabled   = FALSE		
		cb_borrar.enabled     = FALSE		
	  	cb_grabar.enabled     = TRUE
	ELSE
		cb_insertar.enabled   = TRUE
	END IF

IF tipo = "M" and var_situacion = "S" Then
	cb_stock.enabled    = FALSE
	cb_borrar.enabled   = FALSE
	cb_grabar.enabled   = FALSE
END IF


end subroutine

public subroutine f_calculo_precio ();string codpais
Integer t_pallets
Dec{4}  t_cantidad,dto,v_precio_esp,v_precio_tarifa,v_pre,incre,incre2
//dec{2}  dtoesp2



//dtoesp2 = f_dto_cliente_articulo_fecha(codigo_empresa, uo_cliente.em_codigo.text, uo_articulo.em_codigo.text, datetime(today()))

IF IsNull(uo_articulo.em_codigo.text) or Trim(uo_articulo.em_codigo.text)= "" Then Return 
IF IsNull(uo_calidad.em_codigo.text) or Trim(uo_calidad.em_codigo.text)= "" Then Return 
	dto = 0
	em_dto = 0
	// David 05-02-04
	sle_dtoesp2.text = string(f_dto_cliente_articulo_fecha(codigo_empresa, uo_cliente.em_codigo.text, uo_articulo.em_codigo.text, datetime(today()))	)
	// fin David 
	v_precio_esp    = f_precio_articulo_especial(codigo_empresa,uo_cliente.em_codigo.text,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text)
	v_precio_tarifa = f_precio_articulo_venlintarifas_activa(codigo_empresa,venalb.tarifa,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text)
	dto= f_dto_cliente_articulo(codigo_empresa,uo_cliente.em_codigo.text,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text,Dec(em_t_pallets.text))
	v_pre = Dec(String(v_precio_tarifa - (v_precio_tarifa * dto/100),f_mascara_moneda(venalb.divisa)))
	IF (v_pre < v_precio_esp) OR v_precio_esp = 0 Then
		em_dto = dto
		em_precio = v_precio_tarifa
	Else
		em_precio = Dec(String(v_precio_esp,f_mascara_moneda(venalb.divisa)))
	END IF
	
	codpais = f_pais_genter(codigo_empresa,"C",uo_cliente.em_codigo.text)  
	codpais = f_pais_genter(codigo_empresa,"C",uo_cliente.em_codigo.text)  
	IF em_precio <> 0 AND Not IsNull(em_precio)Then
		t_pallets   = Integer(em_t_pallets.text)
		t_cantidad  = Dec(em_cantidad.text)
		IF IsNull(t_pallets) Then t_pallets=0
		IF t_pallets <1 and t_cantidad <>0 Then 
		  incre  = f_incremento_pallet_cliente(codigo_empresa,uo_cliente.em_codigo.text)
		  incre2 = f_incremento_precio(codigo_empresa,cod_familia,uo_calidad.em_codigo.text,em_precio,codpais)
		  IF incre<> 0 and incre2 <> 0 Then incre2 = incre + em_precio
		  em_precio = incre2
  		End IF  
END IF
em_prec.text = string(em_precio)
precio_ant = em_precio

end subroutine

public subroutine f_consulta_disponible ();str_parametros str
str.s_argumentos[1]= "w_int_venliped"
str.s_argumentos[2]= uo_articulo.em_codigo.text
str.s_argumentos[3]= uo_calidad.em_codigo.text
str.s_argumentos[6]= uo_tipo_pallet.em_codigo.text
str.s_argumentos[7]= uo_cliente.em_codigo.text
CHOOSE CASE campo_actual
	CASE "ARTICULO"
     str.s_argumentos[3]= ""
     str.s_argumentos[4]= ""
     str.s_argumentos[5]= ""
     str.s_argumentos[6]= ""
   CASE "CALIDAD"
     str.s_argumentos[4]= ""
     str.s_argumentos[5]= ""
     str.s_argumentos[6]= ""
END CHOOSE

str.i_nargumentos = 6
OpenWithParm(w_con_stock_articulos,str)

end subroutine

public subroutine f_activar_primer_campo ();f_activar_campo(uo_articulo.em_campo)
end subroutine

public subroutine f_campos_segun_tiplin ();Integer var_linea
String impreso
Boolean  sino,sino_articulo
String   var_empresa,var_codigo
String cod_tiplin

cod_tiplin  = uo_tipolinea.em_codigo.text 
var_control_alm ="S"

IF dw_detalle.GetRow() <> 0 Then
	var_linea= dw_detalle.getItemNumber(dw_detalle.GetRow(),"linea")
END IF

 em_cantidad.enabled            = TRUE
 sino = TRUE
 sino_articulo= TRUE
 em_cajas.enabled               = sino
 em_calibre.enabled             = sino
 em_mtrs_lineales.enabled       = sino
 em_t_cajas.enabled             = sino
 em_t_pallets.enabled           = sino
 em_tono.enabled                = sino
 uo_calidad.enabled             = sino
 uo_tipo_pallet.enabled         = sino
 uo_articulo.enabled            = sino_articulo





      IF trim(uo_articulo.em_codigo.text) <> "" THEN
        cb_stock.enabled        = sino
      ELSE
        cb_stock.enabled        = FALSE
      END IF
IF (var_control_alm = "S" and var_sector ="N") or var_control_alm = "N" THEN 
   uo_calidad.em_codigo.text = ""  
   uo_calidad.em_campo.text = ""
   em_tono.text = ""
   em_calibre.text = ""
   uo_tipo_pallet.em_codigo.text = ""
   uo_tipo_pallet.em_campo.text = ""
   em_mtrs_lineales.text = ""
   em_t_cajas.text = ""
   em_t_pallets.text = ""
   em_cajas.text = ""
END IF
    
IF tipo = "M" Then
	 em_tono.enabled    = FALSE
 	 em_calibre.enabled    = FALSE
    uo_tipo_pallet.em_campo.enabled = FALSE
    uo_articulo.em_campo.enabled = FALSE	 
    uo_calidad.em_campo.enabled = FALSE	 
    uo_tipolinea.em_campo.enabled = FALSE	 
ELSE
	 em_tono.enabled    = TRUE
 	 em_calibre.enabled    = TRUE
    uo_tipo_pallet.em_campo.enabled = TRUE
    uo_articulo.em_campo.enabled = TRUE 
    uo_calidad.em_campo.enabled = TRUE	 
    uo_tipolinea.em_campo.enabled = TRUE
END IF
end subroutine

public subroutine f_control ();dw_detalle.Retrieve(codigo_empresa,Integer(em_anyo.text),Dec(em_albaran.text))
end subroutine

public subroutine f_peso_linea ();Dec{4} var_anyo,var_albaran,var_peso_linea
var_anyo     = Dec(em_anyo.text)
var_albaran  = Dec(em_albaran.text)
IF len(uo_articulo.em_codigo.text) <> 0  and len(uo_tipo_pallet.em_codigo.text) <> 0 Then
	var_peso_linea= f_calculo_peso(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text,Dec(em_cajas.text),Dec(em_t_cajas.text),dec(em_t_pallets.text),Dec(em_cantidad.text),uo_caja.em_codigo.text)
Else	
	var_peso_linea = 0
END IF
st_peso_linea.text   = String(var_peso_linea,"###,###,###")
Select sum(peso) Into :var_total From venlialb
Where  venlialb.empresa   = :codigo_empresa
And    venlialb.anyo      = :var_anyo
And    venlialb.albaran    = :var_albaran
And    venlialb.linea    <>:linea_albaran;
IF IsNull(var_total)      Then var_total       =  0
IF IsNull(var_peso_linea) Then var_peso_linea  =  0

st_peso_total.text = String(var_total + var_peso_linea,"###,###,###")
end subroutine

public subroutine f_recalcular_lineas ();str_venlialb  linalb
str_venalb   ped 
Integer  reg,reg1 
Dec{0}  ultima,albaran,periodo,parcial_pallets
Dec{2}  parcial_cantidad,parcial_cajas
Dec{4}  impdto,importe,acumulado,importedto1,importedto2,importedto3,importedto4,importedtopp,importedtoesp,control_precio,control_bruto,control_importedto,control_importe
Dec{2}  var_dto1,var_dto2,var_dto3,var_dto4,var_dtopp,control_descuento
String  var_tipodto1,var_tipodto2,var_tipodto3,var_tipodto4,var_calculo_dto
Dec{4}  var_impdto1,var_impdto2,var_impdto3,var_impdto4
Integer procesos

periodo   =  Integer(em_anyo.text)
albaran    =  Dec(em_albaran.text)
reg1 = dw_detalle.RowCount()
linalb.empresa   = codigo_empresa
linalb.anyo      = periodo
linalb.albaran  = albaran
  SELECT venalb.dtoesp1,     venalb.dtoesp2,   
         venalb.dtoesp3,     venalb.dtoesp4,   
         venalb.dtopp,       venalb.tipodto1,   
         venalb.tipodto2,    venalb.tipodto3,   
         venalb.tipodto4,    venalb.divisa,
			venalb.calculo_dto
    INTO :var_dto1,    :var_dto2,    :var_dto3,  :var_dto4,   
         :var_dtopp,   :var_tipodto1,:var_tipodto2,   
         :var_tipodto3,:var_tipodto4,:linalb.divisa,
			:var_calculo_dto
    FROM venalb  
   WHERE (venalb.empresa  = :linalb.empresa ) AND  
         (venalb.anyo     = :linalb.anyo ) AND  
         (venalb.albaran = :linalb.albaran );


For reg = 1 To reg1 
 linalb.linea              = Dec(f_valor_columna(dw_detalle,reg,"linea"))
 linalb.cantidad           = Dec(f_valor_columna(dw_detalle,reg,"cantidad"))
 linalb.dtoesp             = Dec(f_valor_columna(dw_detalle,reg,"dtoesp"))
 linalb.tipolinea         = f_valor_columna(dw_detalle,reg,"tipolinea")
 linalb.control_comisiones = f_comision_ventipolin(linalb.empresa,linalb.tipolinea)
 linalb.control_descuentos = f_descuento_ventipolin(linalb.empresa,linalb.tipolinea)

 IF  IsNull(linalb.dtoesp) Then linalb.dtoesp= 0
 IF IsNull(var_dto1)  Then var_dto1  = 0
 IF IsNull(var_dto2)  Then var_dto2  = 0
 IF IsNull(var_dto3)  Then var_dto3  = 0
 IF IsNull(var_dto4)  Then var_dto4  = 0
 IF IsNull(var_dtopp) Then var_dtopp = 0

For procesos = 1 To 2
 linalb.precio_aduana      = Dec(f_valor_columna(dw_detalle,reg,"precio_aduana"))
 linalb.precio             = Dec(f_valor_columna(dw_detalle,reg,"precio"))
 IF procesos = 1 then control_precio = linalb.precio
 IF procesos = 2 then control_precio = linalb.precio_aduana
	
	control_bruto = Dec(String(linalb.cantidad * control_precio,f_mascara_moneda(linalb.divisa)))
	IF var_calculo_dto = "N" Then
		importedtoesp = Dec(String((control_bruto * linalb.dtoesp /100),f_mascara_moneda(linalb.divisa)))
		acumulado = control_bruto - importedtoesp
	ELSE
		acumulado = control_bruto
	END IF
	
	IF linalb.control_descuentos = "N" Then
		linalb.descuento = 0
	ELSE
	 IF var_tipodto1  = "L" Then 
			importedto1 = Dec(String((acumulado * var_dto1 /100),f_mascara_moneda(linalb.divisa)))
			acumulado = acumulado - importedto1
	 END IF
	 IF var_tipodto2  = "L" Then 
			importedto2 = Dec(String((acumulado * var_dto2 /100),f_mascara_moneda(linalb.divisa)))
			acumulado = acumulado - importedto2
	 END IF
	 IF var_tipodto3  = "L" Then 	
		   importedto3 = Dec(String((acumulado * var_dto3 /100),f_mascara_moneda(linalb.divisa)))
			acumulado = acumulado - importedto3
	 END IF
	 IF var_tipodto4  = "L" Then 	
			importedto4  = Dec(String((acumulado * var_dto4 /100),f_mascara_moneda(linalb.divisa)))
			acumulado = acumulado - importedto4
	 END IF
	 importedtopp  = Dec(String((acumulado * var_dtopp /100),f_mascara_moneda(linalb.divisa))) 
	END IF
	control_importedto    = control_bruto - acumulado 
	control_importe       = control_bruto - control_importedto
	If control_bruto = 0 then
		control_descuento  = 0
	ELse
		control_descuento  = (control_importedto/control_bruto)* 100
	END IF
	control_importedto    = control_bruto * control_descuento / 100
	control_importe       = control_bruto - control_importedto
	
	IF var_calculo_dto = "S" Then
		control_precio = control_precio - &
		Dec(String((control_precio * control_descuento)/100,f_mascara_moneda(linalb.divisa)))
		control_descuento = linalb.dtoesp
		control_bruto = Dec(String(linalb.cantidad * control_precio,f_mascara_moneda(linalb.divisa)))
	   importedtoesp = Dec(String((control_bruto * linalb.dtoesp /100),f_mascara_moneda(linalb.divisa)))
		control_importedto    = importedtoesp
	   control_importe       = control_bruto - importedtoesp
	END IF
	
	IF procesos = 1 Then
		linalb.descuento       = control_descuento
		linalb.bruto           = control_bruto
	   linalb.importedto      = control_importedto
	   linalb.importe         = control_importe
		linalb.precio_neto     = control_precio
		
	END IF
	IF procesos = 2 Then
		linalb.descuento_aduana       = control_descuento
	   linalb.importe_aduana         = control_importe
		linalb.precio_aduana_neto     = control_precio
	END IF
Next
  UPDATE venlialb  
     SET importe            = :linalb.importe,   
         descuento          = :linalb.descuento,   
         importedto         = :linalb.importedto,   
         precio_neto        = :linalb.precio_neto,   
         precio_aduana_neto = :linalb.precio_aduana_neto,   
         descuento_aduana   = :linalb.descuento_aduana,   
         importe_aduana     = :linalb.importe_aduana,   
         bruto = :linalb.bruto  
   WHERE ( venlialb.empresa = :linalb.empresa ) AND  
         ( venlialb.anyo = :linalb.anyo ) AND  
         ( venlialb.albaran = :linalb.albaran )  AND 
        ( venlialb.linea = :linalb.linea )   ;
COMMIT;
NEXT
f_actualizar_venalbaran(codigo_empresa,periodo,albaran)
end subroutine

public subroutine f_deposito ();dw_detalle.AcceptText()
String almacen,articulo,calidad,tipo_pallet,tono
Dec existencias,calibre
long cuantos

articulo    = uo_articulo.em_codigo.text
calidad     = uo_calidad.em_codigo.text
tipo_pallet = uo_tipo_pallet.em_codigo.text
tono        = Trim(em_tono.text)
calibre     = Dec(em_calibre.text)
IF IsNUll(tono)    Then tono    = ""
IF IsNUll(calibre) Then calibre = 0

st_deposito.visible = FALSE
st_cantidad.visible = FALSE
deposito.visible = FALSE
deposito.text = ""
cantidad.visible = FALSE
cantidad.text = ""
IF tipo = "M" then
	if dw_detalle.GetItemString(dw_detalle.GetRow(),"deposito") = "N" Then 
		Return
	end if
end if
IF f_deposito_venclientes(codigo_empresa,uo_cliente.em_codigo.text) = "S" Then
			almacen = f_depalmacen_cliente(codigo_empresa,uo_cliente.em_codigo.text)
			SELECT sum(existencias) INTO :existencias FROM deplinubica  
			WHERE deplinubica.empresa      = :codigo_empresa
			AND   deplinubica.almacen      = :almacen
			AND   deplinubica.articulo     = :articulo
			AND   deplinubica.calidad      = :calidad
			AND   deplinubica.tonochar     = :tono
			AND   deplinubica.calibre      = :calibre
			AND   deplinubica.tipo_pallet  = :tipo_pallet;
			IF IsNull(existencias) Then existencias = 0
			IF tipo = "M" Then 
				existencias = existencias + Abs(dw_detalle.GetItemNumber(dw_detalle.GetRow(),"cantidad"))
			END IF
			
			
			select count(*)
			into :cuantos
			from venarticulosdeposito
			where  empresa  = :codigo_empresa
			and    cliente  = :uo_cliente.em_codigo.text
			and    articulo = :articulo;
			
			// Esto sustituye a lo comentado abajo. David 30-05-05
		   IF cuantos >  0 Then			
					st_deposito.visible = TRUE
					deposito.visible = TRUE
					st_cantidad.visible = TRUE
					deposito.text = "X"
					cantidad.visible = TRUE
					cantidad.text = String(existencias)
			END IF
			
			
//		   IF existencias <> 0 Then			
//					st_deposito.visible = TRUE
//					deposito.visible = TRUE
//					st_cantidad.visible = TRUE
//					deposito.text = "X"
//					cantidad.visible = TRUE
//					cantidad.text = String(existencias)
//			END IF
END IF
			










end subroutine

public subroutine f_leer_cab ();    
venalb.anyo   = Dec(em_anyo.text)
venalb.albaran = Dec(em_albaran.text)


  SELECT venalb.empresa,venalb.anyo,
  			venalb.albaran,venalb.falbaran,   
         venalb.falta,venalb.cliente,
         venalb.observaciones,venalb.codpago,
			venalb.agente1,venalb.agente2,venalb.comision1,
			venalb.comision2,venalb.comision11,
			venalb.comision22,venalb.dtopp,venalb.dtoesp1,   
         venalb.dtoesp2,venalb.dtoesp3,   
         venalb.dtoesp4,venalb.tipodto1,   
         venalb.tipodto2,venalb.tipodto3,   
         venalb.tipodto4,venalb.explicaciondto1,   
         venalb.explicaciondto2,venalb.explicaciondto3,   
         venalb.explicaciondto4,venalb.tipoiva,   
         venalb.iva,venalb.numpedcli,venalb.idioma,   
         venalb.divisa,venalb.cambio,venalb.tarifa,   
         venalb.ftarifa,venalb.fbloqueo,
         venalb.serie,venalb.zona,
         venalb.forma_envio,venalb.cod_entrega,   
         venalb.usuario,venalb.tipo_portes,
			venalb.periodo_fac,venalb.peso,venalb.abono  
         INTO :venalb.empresa,:venalb.anyo,:venalb.albaran,:venalb.falbaran,   
         :venalb.falta,:venalb.cliente,
         :venalb.observaciones,:venalb.codpago,:venalb.agente1,   
         :venalb.agente2,:venalb.comision1,:venalb.comision2,
         :venalb.comision11,:venalb.comision22,:venalb.dtopp,
         :venalb.dtoesp1,:venalb.dtoesp2,:venalb.dtoesp3,:venalb.dtoesp4,   
         :venalb.tipodto1,:venalb.tipodto2,:venalb.tipodto3,
         :venalb.tipodto4,:venalb.explicaciondto1,:venalb.explicaciondto2,   
         :venalb.explicaciondto3,:venalb.explicaciondto4,:venalb.tipoiva,   
         :venalb.iva,:venalb.numpedcli,:venalb.idioma,:venalb.divisa,   
         :venalb.cambio,:venalb.tarifa,:venalb.ftarifa,:venalb.fbloqueo,   
         :venalb.serie,:venalb.zona,:venalb.forma_envio,   
         :venalb.cod_entrega,:venalb.usuario,:venalb.tipo_portes,   
         :venalb.periodo_fac,:venalb.peso,:venalb.abono  
         FROM venalb  
         WHERE venalb.empresa = :codigo_empresa
         AND   venalb.anyo    = :venalb.anyo
         AND   venalb.albaran  = :venalb.albaran;
	
	      IF SQLCA.SQLCODE = 0 Then
 					 if Trim(venalb.abono)="N" then
					    f_mensaje("!Atención¡","Este albaran no es abono.")
						 f_activar_campo(em_albaran)
						 Return
				    end if

					 venalb.cliente = f_cliente_venalb(codigo_empresa,venalb.anyo,venalb.albaran)
					 uo_cliente.em_codigo.text = venalb.cliente
					 uo_cliente.em_campo.text= f_nombre_cliente(codigo_empresa,"C",venalb.cliente)
					 em_falbaran.text = String(venalb.falbaran,"dd-mm-yy") 
					 tipo = "I"
					 f_control()
					 f_peso_linea()
					 cb_insertar.TriggerEvent(Clicked!)
					 cabecera = "S"
  		   ELSE
					 cabecera = "N"
					 tipo = "I"
					 em_falbaran.text = String(Today(),"dd-mm-yy")
					 uo_cliente.em_codigo.text = ""
					 uo_cliente.em_campo.text= ""
					 f_control()
					 f_activar_campo(em_falbaran)
			END IF
			
end subroutine

public subroutine f_ubicar ();Integer r , r1,v_bien
String ubicacion
Dec    albaran,anyo,linea
r1 = dw_detalle.RowCount()
v_bien = 0
IF r1 = 0 Then Return

For r = 1 To r1
//	ubicacion = 'S'
	anyo    = dw_detalle.GetItemNumber(r,"anyo")
	albaran = dw_detalle.GetItemNumber(r,"albaran")
	linea   = dw_detalle.GetItemNumber(r,"linea")
  IF  dw_detalle.GetItemString(r,"situacion") = "P" Then
//	IF Trim(ubicacion)<> "" Then
		IF Not f_entrada_almacen(codigo_empresa,anyo,albaran,linea) Then v_bien = 1
		Update venlialb
		Set    venlialb.situacion = "S"
		Where  venlialb.empresa  = :codigo_empresa
		And    venlialb.anyo     = :anyo
		And    venlialb.albaran  = :albaran
		And    venlialb.linea    = :linea;
		IF SQLCA.SQLCODE <> 0 Then v_bien = 1
		IF v_bien = 0 Then 
			COMMIT;
		ELSE
			ROLLBACK;
		END IF
//	END IF
END IF
Next
f_control()
end subroutine

public function boolean f_entrada_almacen (string empresa, decimal anyo, decimal albaran, decimal linea);String  var_familia, var_formato, var_tipounidad, var_subformato, var_subfamilia, var_modelo
Datetime ahora 
str_almacenmovimientos movimiento_nuevo
String   v_ubicacion,v_almacen,v_zona,v_articulo,v_calidad,v_tipo_pallet,&
         v_cliente,v_deposito,v_tono,v_caja
Dec      v_fila,v_altura,v_cantidad,v_calibre,v_cant
Int v_piezascaja
decimal contador_nummov,contador_orden ,v_bien, var_total_cajas, var_metroscaja

ahora = Datetime(Today(),Now())

str_movimiento_almacen lstr_movimiento_almacen

Select   venlialb.ubicacion,
			venlialb.cantidad,
			venlialb.articulo,
         venlialb.calidad,
			venlialb.tonochar,
			venlialb.calibre,
			venlialb.tipo_pallet,
			venlialb.cliente,
			venlialb.deposito,
			venlialb.caja,
			venlialb.tipo_unidad,
			venlialb.total_cajas,
			almartcajas.metroscaja,
			almartcajas.piezascaja
Into     :v_ubicacion,
			:v_cantidad,
			:v_articulo,
			:v_calidad,
			:v_tono,
			:v_calibre,
         :v_tipo_pallet,
			:v_cliente,
			:v_deposito,
			:v_caja,
			:var_tipounidad,
			:var_total_cajas,
			:var_metroscaja,
			:v_piezascaja
From     venlialb 
left outer join almartcajas ON venlialb.empresa = almartcajas.empresa AND venlialb.articulo = almartcajas.articulo AND venlialb.caja = almartcajas.caja 
Where    venlialb.empresa    = :empresa
And      venlialb.anyo       = :anyo
And      venlialb.albaran    = :albaran
And      venlialb.linea      = :linea;

IF SQLCA.SQLCode<>0 THEN return false

//ATENCIÓN - EL ALMACEN SIEMPRE TRABAJA EN PIEZAS - CONVERSIÓN METROS/PIEZAS
v_cant = v_cantidad * (-1)

if isnull(var_metroscaja) then var_metroscaja = 0
if isnull(v_piezascaja) then v_piezascaja = 0

if var_tipounidad = "1" then //metros
	if  v_piezascaja <> 0 then
		v_cant = v_cant / var_metroscaja
		v_cant = v_cant * v_piezascaja
		v_cant = truncate(v_cant, 0)
	else
		MessageBox("Error alta del artículo", "Atención, encajado mal definido. Faltan piezas / caja para poder anular.")
		return false
	end if
end if

lstr_movimiento_almacen.empresa            = codigo_empresa
lstr_movimiento_almacen.articulo           = v_articulo
lstr_movimiento_almacen.calidad            = v_calidad
lstr_movimiento_almacen.tono               = v_tono
lstr_movimiento_almacen.calibre            = v_calibre
lstr_movimiento_almacen.tipo_pallet        = v_tipo_pallet
lstr_movimiento_almacen.caja               = v_caja
lstr_movimiento_almacen.cantidad           = v_cant
lstr_movimiento_almacen.orden_carga_anyo   = 0
lstr_movimiento_almacen.orden_carga_codigo = ""
lstr_movimiento_almacen.orden_carga_linea  = 0
lstr_movimiento_almacen.tipo_movimiento    = "6" 
lstr_movimiento_almacen.observaciones      = ""
lstr_movimiento_almacen.almacen            = "1"
lstr_movimiento_almacen.zona               = "P"
lstr_movimiento_almacen.fila               = 2
lstr_movimiento_almacen.altura             = 1
lstr_movimiento_almacen.tercero            = ""
lstr_movimiento_almacen.documento          = ""
lstr_movimiento_almacen.fecha              = datetime(today(),now())
lstr_movimiento_almacen.id_ubicacion       = 0
lstr_movimiento_almacen.id_alm_bultos		 = 0
				
if not(f_movimiento_almacen(lstr_movimiento_almacen)) then
	return false
end if

return true

/*
//ATENCIÓN: El almacén solo trabaja con piezas. Si el artículo está dado de alta en otra unidad hay que hacer la conversión aquí ********************************************************************************
//if var_tipounidad = "1" then //metros
//	v_cant =  truncate(var_total_cajas *  var_metroscaja,0)
//end if
//var_tipounidad = "0"
 
//ALMACEN NUEVO 01/2014
movimiento_nuevo.empresa = codigo_empresa
movimiento_nuevo.tipomov = "6" 
movimiento_nuevo.usuario = nombre_usuario
movimiento_nuevo.almacen = "1"
movimiento_nuevo.zona = "P"
movimiento_nuevo.fila = 2 //ABONOS EN 1 P 2 1
movimiento_nuevo.altura = 1
movimiento_nuevo.articulo = v_articulo	
movimiento_nuevo.calidad = v_calidad
movimiento_nuevo.tono = v_tono
movimiento_nuevo.calibre = v_calibre
movimiento_nuevo.fecha_mov = ahora
movimiento_nuevo.orden = 0
movimiento_nuevo.fecha_intr = ahora
movimiento_nuevo.tipo_pallet = v_tipo_pallet
movimiento_nuevo.caja = v_caja

SELECT articulos.familia, articulos.formato, articulos.subformato, articulos.subfamilia, articulos.modelo 
INTO   :var_familia, :var_formato, :var_subformato, :var_subfamilia, :var_modelo
FROM   articulos  
WHERE  articulos.empresa = :codigo_empresa
AND    articulos.codigo = :v_articulo;
 
IF SQLCA.SQLCode<>0 THEN 
	f_mensaje("Error","El artículo no existe")
	return false
END IF

movimiento_nuevo.familia = var_familia
movimiento_nuevo.formato = var_formato
movimiento_nuevo.tipo_unidad = "0" //EL ALMACEN SIEMPRE EN PIEZAS

movimiento_nuevo.origen = ''
//movimiento_nuevo.nummov = ''
//movimiento_nuevo.observaciones = ""
movimiento_nuevo.trazabilidad = ""	

//ATENCIÓN - EL ALMACEN SIEMPRE TRABAJA EN PIEZAS - CONVERSIÓN METROS/PIEZAS
if isnull(var_metroscaja) then var_metroscaja = 0
if isnull(v_piezascaja) then v_piezascaja = 0

if var_tipounidad = "1" then //metros
	if  v_piezascaja <> 0 then
		v_cant = v_cant / var_metroscaja
		v_cant = v_cant * v_piezascaja
		v_cant = truncate(v_cant, 0)
	else
		MessageBox("Error alta del artículo", "Atención, encajado mal definido. Faltan piezas / caja para poder anular.")
		return false
	end if
end if


movimiento_nuevo.cantidade = v_cant
movimiento_nuevo.cantidads = 0

if ftc_movimiento_almacen(movimiento_nuevo, sqlca) = 0 then
	return true 
else
	return false 
end if
*/
end function

public subroutine f_ubi (integer opcion);dw_ubicaciones.Reset()
dw_ubicaciones.SetFilter("")
//IF opcion = 1 Then
//	filtro = " almlinubica_tonochar = "+ Trim(var_tono)+ " And  almlinubica_calibre =" +&
//   String(var_calibre) + " And almlinubica_tipo_pallet = '" +var_tipo_pallet+ "'"
//dw_ubicaciones.SetFilter(filtro)
//dw_ubicaciones.Filter()
//END IF
dw_ubicaciones.Retrieve(codigo_empresa,var_articulo,var_calidad,var_tono,var_calibre,var_caja,var_tipo_pallet)
end subroutine

public subroutine f_activar (boolean r);cb_1.enabled = r
cb_borrar.enabled = r
cb_grabar.enabled = r
cb_insertar.enabled = r
cb_stock.enabled = r
//cb_ubicar.enabled = r
deposito.enabled = r
dw_detalle.enabled = r
em_albaran.enabled = r
uo_serie.enabled = r
em_anyo.enabled = r
em_cajas.enabled = r
em_calibre.enabled = r
em_cantidad.enabled = r
em_descripcion.enabled = r
em_t_pallets.enabled = r
em_falbaran.enabled =r
em_mtrs_lineales.enabled = r
em_tono.enabled = r
uo_articulo.enabled = r
uo_calidad.enabled = r
uo_cliente.enabled = r
uo_tipo_pallet.enabled = r


	
end subroutine

public subroutine f_control_tono_calibre (); control_tono   =  TRUE
 control_calibre =  TRUE

 IF Not f_control_tono_artcal(codigo_empresa,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text) Then
   control_tono   =  FALSE
 	em_tono.text       =  ""
END IF
IF Not f_control_calibre_artcal(codigo_empresa,uo_articulo.em_codigo.text,uo_calidad.em_codigo.text) Then
   control_calibre =  FALSE
   em_calibre.text    =  "0"
 END IF  
end subroutine

public function boolean f_entrada_deposito (string almacen, string referencia, string tipo_pallet, decimal vcantidad);Integer vbien = 0
Int anyo
Str_deplinubica  ubi
Str_depmovhis    mov
vcantidad = vcantidad  

 string codigo_articulo
 String codigo_calidad
 codigo_articulo = uo_articulo.em_codigo.text
 codigo_calidad  = uo_calidad.em_codigo.text
 ubi.empresa       = codigo_empresa
 mov.anyo          = year(Today())
 mov.usuario       = nombre_usuario
 ubi.almacen       = almacen
 ubi.articulo      = f_articulo_referencia(referencia)
 ubi.calidad       = f_calidad_referencia(referencia)
 ubi.tonochar      = Trim(f_tono_referencia(referencia))
 ubi.calibre       = Integer(f_calibre_referencia(referencia))
 mov.fechmov       = venalb.falbaran // DateTime(Today())
 mov.f_alta        = Datetime(today(),now())
 mov.observaciones = ""
 mov.tipomov       = "3"
 ubi.tipo_pallet   = tipo_pallet
 mov.numdoc        = em_albaran.text
 
 SELECT  articulos.familia,articulos.formato,articulos.modelo,
         articulos.unidad  
    INTO :ubi.familia,:ubi.formato,:ubi.modelo, :ubi.tipo_unidad  
    FROM articulos  
   WHERE articulos.empresa = :ubi.empresa 
	AND   articulos.codigo  = :ubi.articulo;
  IF SQLCA.SQLCode<>0 THEN vbien=1
  
ubi.referencia   = f_componer_ref(ubi.articulo,ubi.calidad,ubi.tonochar,ubi.calibre)
ubi.cliente = venalb.cliente
ubi.f_alta       =  DateTime(today(),now())
mov.cantidads = vcantidad
mov.cantidade = 0
ubi.existencias      = vcantidad * (-1)
mov.empresa          = ubi.empresa
mov.almacen          = ubi.almacen
mov.articulo         = ubi.articulo
mov.codtercero       = venalb.cliente
mov.situacion        = "N"
mov.observaciones    = ""
mov.tipo             = "C"
SetNull(mov.punteado)
mov.antexist=0      
mov.familia        = ubi.familia
mov.formato        = ubi.formato
mov.modelo         = ubi.modelo
mov.calidad        = ubi.calidad
mov.tonochar       = ubi.tonochar
mov.calibre        = ubi.calibre
mov.tipo_unidad    = ubi.tipo_unidad
mov.tipo_pallet    = ubi.tipo_pallet
mov.referencia     = ubi.referencia
mov.f_alta         = DateTime(today(),now())

   
  mov.nummov  = f_depparam_nummov(codigo_empresa,Year(Today()))
  // Variables para cargar el cursor

      integer cur_pedido,cur_linea,cur_anyo
      String  cur_empresa,cur_almacen
      decimal{4}  cur_existencias


	 Select deplinubica.existencias 
	 Into   :cur_existencias 
	 From   deplinubica
	 Where  deplinubica.empresa     = :codigo_empresa
	 And    deplinubica.almacen     = :almacen 
	 And    deplinubica.referencia  = :ubi.referencia
	 And    deplinubica.tipo_pallet = :ubi.tipo_pallet;
	 IF SQLCA.SQLCODE = 0 Then
			Update deplinubica
				Set    deplinubica.existencias = deplinubica.existencias - :mov.cantidads
				Where  deplinubica.empresa     = :codigo_empresa
			   And    deplinubica.almacen     = :almacen 
				And    deplinubica.referencia  = :ubi.referencia
 			   And    deplinubica.tipo_pallet = :ubi.tipo_pallet;
		ELSE
				Select  max(deplinubica.linea) Into :ubi.linea from deplinubica
				Where  deplinubica.empresa     = :codigo_empresa
			   And    deplinubica.almacen     = :almacen;
				IF IsNUll(ubi.linea) Then ubi.linea = 0
				ubi.linea = ubi.linea +1
			 IF Not f_insert_deplinubica(ubi) Then vbien = 1
   END IF

// Grabo el movimiento en el historico
  IF NOT f_insert_depmovhis(mov) Then vbien=1
  IF NOT f_actualiza_depnummov(codigo_empresa,Year(Today()),mov.nummov) THEN
     vbien=1
  END IF
IF vbien = 0  Then
	Return True
Else
	Return False
End IF
end function

public function boolean f_salida_deposito (string almacen, string referencia, string tipo_pallet, decimal vcantidad, string ar_caja);Integer vbien = 0
Int anyo
Str_deplinubica  ubi
Str_depmovhis    mov
vcantidad = vcantidad * (-1)

 string codigo_articulo
 String codigo_calidad
 codigo_articulo = uo_articulo.em_codigo.text
 codigo_calidad  = uo_calidad.em_codigo.text
 ubi.empresa       = codigo_empresa
 mov.anyo          = year(Today())
 mov.usuario       = nombre_usuario
 ubi.almacen       = almacen
 ubi.articulo      = f_articulo_referencia(referencia)
 ubi.calidad       = f_calidad_referencia(referencia)
 ubi.tonochar      = Trim(em_tono.text)
 ubi.calibre       = Integer(em_calibre.text)
 mov.fechmov       =datetime(date(em_falbaran.text))// venalb.falbaran //DateTime(Today())
 mov.f_alta        = Datetime(today(),now())
 mov.observaciones = ""
 mov.tipomov       = "7"  // Devolución Fábrica
 ubi.tipo_pallet   = tipo_pallet
 ubi.caja   		 = ar_caja
 mov.numdoc        = em_albaran.text
 
 SELECT  articulos.familia,articulos.formato,articulos.modelo,
         articulos.unidad  
    INTO :ubi.familia,:ubi.formato,:ubi.modelo, :ubi.tipo_unidad  
    FROM articulos  
   WHERE articulos.empresa = :ubi.empresa 
	AND   articulos.codigo  = :ubi.articulo;

         IF SQLCA.SQLCode<>0 THEN vbien=1
 ubi.referencia   = f_componer_ref(ubi.articulo,&
                                   ubi.calidad,ubi.tonochar,&
                                   ubi.calibre)

ubi.cliente = venalb.cliente
ubi.f_alta       =  DateTime(today(),now())
mov.cantidads = vcantidad
mov.cantidade = 0
ubi.existencias      = vcantidad
mov.empresa          = ubi.empresa
mov.almacen          = ubi.almacen
mov.articulo         = ubi.articulo
mov.cantidade        = 0
mov.codtercero       = venalb.cliente
mov.situacion        = "N"
mov.observaciones    = ""
mov.tipo             = "C"
SetNull(mov.punteado)
mov.antexist=0      
mov.familia        = ubi.familia
mov.formato        = ubi.formato
mov.modelo         = ubi.modelo
mov.calidad        = ubi.calidad
mov.tonochar       = ubi.tonochar
mov.calibre        = ubi.calibre
mov.tipo_unidad    = ubi.tipo_unidad
mov.tipo_pallet    = ubi.tipo_pallet
mov.caja		    	 = ubi.caja
mov.referencia     = ubi.referencia
mov.f_alta         = DateTime(today(),now())
mov.nummov  = f_depparam_nummov(codigo_empresa,Year(Today()))
  // Variables para cargar el cursor

      integer cur_pedido,cur_linea,cur_anyo
      String  cur_empresa,cur_almacen
      decimal{4}  cur_existencias

	 Select deplinubica.existencias Into :cur_existencias From deplinubica
	 Where  deplinubica.empresa     = :codigo_empresa
	 And    deplinubica.almacen     = :almacen 
	 And    deplinubica.referencia  = :ubi.referencia
	 And    deplinubica.tipo_pallet = :ubi.tipo_pallet
	 and 	  deplinubica.caja = :ubi.caja;
	 IF SQLCA.SQLCODE = 0 Then
		IF cur_existencias = mov.cantidads Then
		   	Delete from deplinubica
				Where  deplinubica.empresa     = :codigo_empresa
			   And    deplinubica.almacen     = :almacen 
				And    deplinubica.referencia  = :ubi.referencia
				And    deplinubica.tipo_pallet = :ubi.tipo_pallet
				And    deplinubica.caja = :ubi.caja;
				
				iF sqlca.sqlcode <> 0 Then vbien = 1
	    	ELSE
			   IF cur_existencias < mov.cantidads Then
							vbien = 1
							f_mensaje("Error", "Falta stock")
 			      ELSE
							Update deplinubica
							Set    deplinubica.existencias = deplinubica.existencias - :mov.cantidads
							Where  deplinubica.empresa     = :codigo_empresa
							And    deplinubica.almacen     = :almacen 
							And    deplinubica.referencia  = :ubi.referencia
							And    deplinubica.tipo_pallet = :ubi.tipo_pallet
							And    deplinubica.caja = :ubi.caja;
							
							iF sqlca.sqlcode <> 0 Then vbien = 1
			    END IF
			END IF
	ELSE
		  if mov.cantidads >0 then
				   f_mensaje("Error en proceso","Error al selecionar existencias" )	
				   vbien = 1
			  else
				    	
						SELECT  max(deplinubica.linea)  
						INTO  :cur_linea  
						FROM   deplinubica  
						WHERE  deplinubica.empresa   = :ubi.empresa
						AND    deplinubica.almacen = :ubi.almacen;
						IF IsNull(cur_linea) or trim(string(cur_linea))="" THEN
						 cur_linea = 0 
						END IF
						cur_linea=cur_linea+1
						ubi.linea=cur_linea
                  ubi.existencias = ubi.existencias * -1 				  
				  INSERT INTO deplinubica  
								( empresa,almacen,linea,articulo,familia,   
								  formato,modelo,calidad,tonochar,calibre,   
								  existencias,cliente,tipo_unidad,referencia,   
								  f_alta,tipo_pallet, caja )  
					  VALUES ( :ubi.empresa,:almacen,:ubi.linea,:ubi.articulo,
					           :ubi.familia,:ubi.formato,:ubi.modelo,:ubi.calidad,
								  :ubi.tonochar,:ubi.calibre,:ubi.existencias,:ubi.cliente,
								  :ubi.tipo_unidad,:ubi.referencia,:ubi.f_alta,:ubi.tipo_pallet, :ubi.caja )  ;
                      	  iF sqlca.sqlcode <> 0 Then vbien = 1		
		  End if 
 END IF
	

// Grabo el movimiento en el historico
  IF NOT f_insert_depmovhis(mov) Then vbien=1
  IF NOT f_actualiza_depnummov(codigo_empresa,Year(Today()),mov.nummov) THEN
     vbien=1
  END IF

IF vbien = 0  Then

	Return True
Else
		f_mensaje("Error en salida almacen",sqlca.sqlerrtext)
	Return False
End IF
end function

public subroutine f_desubicar ();Integer r ,v_bien
String ubicacion
Dec    albaran,anyo,linea
r = dw_detalle.Getrow()
v_bien = 0
IF r = 0 Then Return

ubicacion = 'S'
anyo    = dw_detalle.GetItemNumber(r,"anyo")
albaran = dw_detalle.GetItemNumber(r,"albaran")
linea   = dw_detalle.GetItemNumber(r,"linea")
IF  dw_detalle.GetItemString(r,"situacion") = "S" Then
	IF Trim(ubicacion)<> "" Then
		IF Not f_salida_almacen(codigo_empresa,anyo,albaran,linea) Then v_bien = 1

		Update venlialb
		Set    venlialb.situacion = "P"
		Where  venlialb.empresa  = :codigo_empresa
		And    venlialb.anyo     = :anyo
		And    venlialb.albaran  = :albaran
		And    venlialb.linea    = :linea;
		
		IF SQLCA.SQLCODE <> 0 Then v_bien = 1
			IF v_bien = 0 Then 
				COMMIT;
			ELSE
				ROLLBACK;
			END IF
	END IF
END IF

f_control()
end subroutine

public function boolean f_salida_almacen (string empresa, decimal anyo, decimal albaran, decimal linea);MessageBox("Error", "Deshabilitado")
return false
/*
str_almlinubica    ubi 
str_almmovhis      mov 
str_almlinubicahis ubihis 

String   v_ubicacion,v_almacen,v_zona,v_articulo,v_calidad,v_tipo_pallet,&
         v_cliente,v_deposito,v_tono,v_caja
Dec      v_fila,v_altura,v_cantidad,v_calibre,v_cant
decimal contador_nummov,contador_orden ,v_bien
IF SQLCA.SQLCode<>0 THEN v_bien=1

Select   venlialb.ubicacion,venlialb.cantidad,venlialb.articulo,
         venlialb.calidad,venlialb.tonochar,venlialb.calibre,
			venlialb.tipo_pallet,venlialb.cliente,venlialb.deposito,venlialb.caja
Into     :v_ubicacion,:v_cantidad,:v_articulo,:v_calidad,:v_tono,:v_calibre,
         :v_tipo_pallet,:v_cliente,:v_deposito,:v_caja
From     venlialb
Where    venlialb.empresa    = :empresa
And      venlialb.anyo       = :anyo
And      venlialb.albaran    = :albaran
And      venlialb.linea      = :linea;

IF SQLCA.SQLCode<>0 THEN v_bien=1
v_cant = v_cantidad * (-1)
IF v_deposito = "S" Then
//	f_salida_deposito(empresa,anyo,albaran,linea)
END IF

// David 15-06-04: Pongo a piñon la ubicación de entrada
//v_almacen  = f_almacen_ubicacion(v_ubicacion)
//v_zona     = f_zona_ubicacion(v_ubicacion)
//v_fila     = f_fila_ubicacion(v_ubicacion)
//v_altura   = f_altura_ubicacion(v_ubicacion)
// David 15-06-04: Pongo a piñon la ubicación de entrada

v_almacen  = '1'
v_zona     = 'P'
v_fila     = 1
v_altura   = 1


IF IsNull(v_fila)   Then v_fila = 0
IF IsNull(v_altura) Then v_altura = 0
ubihis.usuario       = nombre_usuario
mov.usuario          = nombre_usuario
ubihis.empresa       = codigo_empresa
ubihis.anyo          = year(Today())
ubihis.almacen       = v_almacen
ubihis.articulo      = v_articulo
ubihis.calidad       = v_calidad
ubihis.tonochar      = v_tono
ubihis.calibre       = v_calibre
ubihis.fecha         = DateTime(Today())
ubihis.f_alta        = DateTime(Today(),now())
SetNull(ubihis.observaciones)
//ubihis.tipomov       = "3"
ubihis.tipomov       = "104" // David 15-06-04: Forzamos a que el tipo de movimiento sea anulación de albarán
ubihis.tipo_pallet   = v_tipo_pallet
ubihis.caja          = v_caja

SELECT 	articulos.empresa,articulos.codigo,articulos.familia,   
			articulos.formato,articulos.modelo,articulos.unidad,
			articulos.sector
INTO 		:ubihis.empresa,:ubihis.articulo,   :ubihis.familia,:ubihis.formato,   
			:ubihis.modelo,:ubihis.tipo_unidad  ,:ubihis.sector
FROM 		articulos  
WHERE 	articulos.empresa= :ubihis.empresa 
AND   	articulos.codigo = :ubihis.articulo;  

IF SQLCA.SQLCode<>0 THEN v_bien=1
ubihis.referencia   = f_componer_ref(ubihis.articulo, ubihis.calidad, ubihis.tonochar,ubihis.calibre)

ubi.empresa    =  ubihis.empresa
ubi.almacen    =  ubihis.almacen
ubi.articulo   =  ubihis.articulo
ubi.familia    =  ubihis.familia
ubi.formato    =  ubihis.formato
ubi.modelo     =  ubihis.modelo
ubi.calidad    =  ubihis.calidad
ubi.tonochar   =  ubihis.tonochar
ubi.calibre    =  ubihis.calibre
ubi.tipo_pallet=  ubihis.tipo_pallet
ubi.caja       =  ubihis.caja
ubi.sector     =  ubihis.sector
SetNull(ubi.anyo)
SetNull(ubi.pedido) 
SetNull(ubi.linped)
SetNull(ubi.cliente)
ubi.tipo_unidad=  ubihis.tipo_unidad
ubi.referencia =  ubihis.referencia
ubi.f_alta     =  Datetime(today(),now())
// Valor movimiento historico
mov.empresa    =  ubihis.empresa
mov.almacen    =  ubihis.almacen
mov.articulo   =  ubihis.articulo
mov.familia    =  ubihis.familia
mov.formato    =  ubihis.formato
mov.modelo     =  ubihis.modelo
mov.calidad    =  ubihis.calidad
mov.tonochar   =  ubihis.tonochar
mov.calibre    =  ubihis.calibre
mov.tipo_unidad=  ubihis.tipo_unidad
mov.tipo_pallet=  ubihis.tipo_pallet
mov.caja       =  ubihis.caja
mov.sector     =  ubihis.sector
mov.referencia =  ubihis.referencia
mov.f_alta     =  DateTime(Today(),now())
mov.anyo       =  year(Today())
mov.origen     = "7"
mov.fechmov    = ubihis.fecha
mov.tipomov    = ubihis.tipomov
//mov.cantidade  = - v_cant
//mov.cantidads  = 0
// Lo antoamos cómo salida positiva David
mov.cantidade  = 0
mov.cantidads  = v_cant
mov.precio     = 0
mov.tipo			= "C"
mov.codtercero   = v_cliente
mov.numdoc        = STRING(albaran,"#########")
mov.situacion     = "N"
SetNull(mov.observaciones)
SetNull(mov.punteado)
mov.antexist   =0


contador_nummov= f_almparam_nummov(codigo_empresa,Year(Today()))
contador_orden = f_almparam_numorden(codigo_empresa,Year(Today()))
mov.nummov     = contador_nummov
ubihis.nummov  = contador_nummov
ubihis.orden   = contador_orden
ubihis.zona       = v_zona	
ubihis.fila       = v_fila
ubihis.altura     = v_altura
IF IsNull(ubihis.altura) Then ubihis.altura = 0
ubihis.cantidade  = v_cant
ubihis.orden      = contador_orden
ubihis.nummov     = contador_nummov
ubihis.observaciones  = mov.observaciones
ubihis.f_alta     = DateTime(Today(),now())
ubihis.usuario    = nombre_usuario
ubihis.ubicacion  = f_componer_ubicacion(ubihis.almacen,ubihis.zona,&
													 ubihis.fila,ubihis.altura)
ubihis.cantidads    = 0
ubi.zona            = ubihis.zona
ubi.fila            = ubihis.fila
ubi.altura          = ubihis.altura
ubi.existencias     = ubihis.cantidade
ubi.ubicacion       = ubihis.ubicacion
//------------------------------------------------------------------
// Inserto en el historico de lineas de ubicacion por movimiento
//------------------------------------------------------------------
ubihis.observaciones =""
IF Not f_insert_almlinubicahis(ubihis) Then  v_bien=1

//-----------------------------------------------------------------------
// Variables para cargar el cursor
//-----------------------------------------------------------------------
String cur_empresa,cur_almacen
decimal cur_pedido,cur_linea,cur_anyo
decimal{4}  cur_existencias
string  cur_referencia,cur_ubicacion,cur_tipo_pallet
  
//----------------------------------------------------------
// Busco si hay linea este articulo sin reservar
//---------------------------------------------------------
decimal registros
seleccion = "Select * from almlinubica "+&
            "where empresa    =  '" + codigo_empresa +"'" +&
            "And ubicacion    =  '" + ubi.ubicacion +"'"+&
	         "And referencia   =  '" + ubi.referencia +"'"+&
            "And tipo_pallet  =  '" + ubi.tipo_pallet +"'"+&
				"And caja         =  '" + ubi.caja +"'"+&
				"And pedido  is null"
DataStore dw_comodin				

//dw_comodin = f_cargar_cursor(seleccion)
f_cargar_cursor_nuevo(seleccion, dw_comodin)


registros = dw_comodin.RowCOunt()
decimal grabado,salir,x1
grabado=0
salir  =0


IF registros<>0 THEN 
 	FOR x1 = 1 To registros
	  cur_empresa       =   dw_comodin.GetItemString(x1,"empresa")
	  cur_almacen       =   dw_comodin.GetItemString(x1,"almacen")
	  cur_ubicacion     =   dw_comodin.GetItemString(x1,"ubicacion")
	  cur_referencia    =   dw_comodin.GetItemString(x1,"referencia")
	  cur_pedido        =   dw_comodin.GetItemNumber(x1,"pedido")
	  cur_linea         =   dw_comodin.GetItemNumber(x1,"linea")
	  cur_existencias   =   dw_comodin.GetItemNumber(x1,"existencias")
	  grabado = 1
//	  ubi.existencias=ubi.existencias + cur_existencias

	  ubi.existencias = - v_cant + cur_existencias

	  UPDATE almlinubica  SET existencias   = :ubi.existencias,   
									  f_alta            = :ubi.f_alta
	  WHERE almlinubica.empresa   = :ubi.empresa 
	  AND   almlinubica.ubicacion = :ubi.ubicacion 
	  AND   almlinubica.linea     = :cur_linea USING SQLCA;
	  IF SQLCA.SQLCode<>0 THEN  v_bien=1
	  EXIT
	NEXT
END IF

IF grabado=0 THEN
	cur_linea=0
	SELECT     max(almlinubica.linea) INTO   :cur_linea  
	FROM   almlinubica  
	WHERE  almlinubica.empresa   = :ubi.empresa 
	AND    almlinubica.ubicacion = :ubi.ubicacion; 
	
	IF IsNull(cur_linea) or trim(string(cur_linea))="" THEN
		cur_linea = 0 
	END IF
	cur_linea=cur_linea+1
	ubi.linea=cur_linea
	SetNull(ubi.observaciones)
	IF NOT f_insert_almlinubica(ubi) Then  v_bien=1
END IF

//-----------------------Fin Grabación Lineas de Ubicacion--------------
// el contador incrementa uno para cada linea
contador_orden = contador_orden + 1

// Grabar el movimiento en el historico por el total de existencias
IF NOT f_insert_almmovhis(mov) Then
	MessageBox("Error en proceso","Grabando almmovhis",Exclamation!, OK!,1)
	v_bien=1
END IF
IF NOT f_actualiza_nummov(mov.empresa,Year(Today()),mov.nummov) THEN
	v_bien=1
END IF
IF NOT f_actualiza_numorden(ubihis.empresa,Year(Today()),ubihis.orden) THEN
	v_bien=1
END IF

destroy dw_comodin
CHOOSE CASE v_bien
	CASE 0
		Return True
	CASE ELSE
		Return FALSE
END CHOOSE
*/


end function

event open;call super::open;istr_parametros = Message.PowerObjectParm
istr_parametros.s_titulo_ventana="Introducción lineas de abono"
This.title=istr_parametros.s_titulo_ventana
tipo_precio = 1
dw_detalle.SetTransObject(SQLCA)
dw_ubicaciones.SetTransObject(SQLCA)
dw_listado.SetTransObject(SqlCA)

em_falbaran.text = string(today(),em_falbaran.mask)

IF istr_parametros.i_nargumentos>1 THEN
     em_anyo.text=String(Dec(istr_parametros.s_argumentos[2]))
     em_albaran.text=String(Dec(istr_parametros.s_argumentos[3]))
     IF Trim(em_anyo.text)<>"" and Trim(em_albaran.text)<>"" THEN
		   f_leer_cab()
         f_control()
     END IF
     istr_parametros.i_nargumentos=0
END IF

f_mascara_columna(dw_ubicaciones,"altura","#0")

em_anyo.text                = String(Year(Today()))
em_situacion.text           = "P"
uo_tipolinea.em_codigo.text = "12"
uo_tipolinea.em_campo.text  = f_nombre_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
uo_tipolinea.TriggerEvent("modificado")

f_activar_campo(uo_serie.em_campo)

end event

event close;call super::close; longitud     =  len(trim(codigo_empresa))
 criterio[1]  =  trim(codigo_empresa)+ space(20-longitud)
 longitud     =  len(Trim(String(Dec(em_anyo.text))))
 criterio[2]  =  trim(String(Dec(em_anyo.text)))+space(20-longitud)
 longitud     =  len(Trim(String(Dec(em_albaran.text))))
 criterio[3]  =  trim(String(Dec(em_albaran.text)))+space(20-longitud)
 seleccion    =  criterio[1]+criterio[2]+criterio[3]
 tabla        = "venalb"

 f_desbloquear(tabla,seleccion,titulo)
 COMMIT;

 
end event

on ue_f3;call w_int_con_empresa::ue_f3;cb_grabar.TriggerEvent(Clicked!)
end on

on ue_f5;call w_int_con_empresa::ue_f5;cb_stock.TriggerEvent(Clicked!)
end on

on ue_f4;call w_int_con_empresa::ue_f4;cb_borrar.TriggerEvent(Clicked!)
end on

on w_int_almalb.create
int iCurrent
call super::create
this.pb_salir=create pb_salir
this.st_3=create st_3
this.st_texto_cantidad=create st_texto_cantidad
this.st_pallets=create st_pallets
this.st_total_cajas=create st_total_cajas
this.st_cajas=create st_cajas
this.st_tipopallet=create st_tipopallet
this.st_calidad=create st_calidad
this.st_articulo=create st_articulo
this.em_t_pallets=create em_t_pallets
this.em_cajas=create em_cajas
this.em_t_cajas=create em_t_cajas
this.em_cantidad=create em_cantidad
this.uo_articulo=create uo_articulo
this.uo_calidad=create uo_calidad
this.uo_tipo_pallet=create uo_tipo_pallet
this.st_texto_mtrslinieales=create st_texto_mtrslinieales
this.em_mtrs_lineales=create em_mtrs_lineales
this.cb_grabar=create cb_grabar
this.cb_borrar=create cb_borrar
this.em_descripcion=create em_descripcion
this.st_33=create st_33
this.cb_insertar=create cb_insertar
this.uo_tipolinea=create uo_tipolinea
this.st_tplinea=create st_tplinea
this.cb_stock=create cb_stock
this.em_anyo=create em_anyo
this.em_situacion=create em_situacion
this.gb_4=create gb_4
this.em_falbaran=create em_falbaran
this.st_tono=create st_tono
this.em_tono=create em_tono
this.st_calibre=create st_calibre
this.em_calibre=create em_calibre
this.st_deposito=create st_deposito
this.deposito=create deposito
this.pb_2=create pb_2
this.st_21=create st_21
this.st_2=create st_2
this.cb_1=create cb_1
this.st_23=create st_23
this.st_4=create st_4
this.st_peso_linea=create st_peso_linea
this.st_peso_total=create st_peso_total
this.st_7=create st_7
this.st_5=create st_5
this.st_6=create st_6
this.uo_cliente=create uo_cliente
this.em_albaran=create em_albaran
this.pb_imprimir=create pb_imprimir
this.pb_imprimir2=create pb_imprimir2
this.st_333=create st_333
this.dw_listado=create dw_listado
this.cb_ubicar=create cb_ubicar
this.cb_2=create cb_2
this.cb_3=create cb_3
this.cantidad=create cantidad
this.st_cantidad=create st_cantidad
this.uo_caja=create uo_caja
this.st_caja=create st_caja
this.em_prec=create em_prec
this.st_precio=create st_precio
this.uo_serie=create uo_serie
this.gb_1=create gb_1
this.st_idioma=create st_idioma
this.uo_idioma=create uo_idioma
this.sle_dtoesp2=create sle_dtoesp2
this.st_1=create st_1
this.dw_ubicaciones=create dw_ubicaciones
this.dw_detalle=create dw_detalle
this.cb_desubicar=create cb_desubicar
this.em_tono_imprimir=create em_tono_imprimir
this.st_14=create st_14
this.st_13=create st_13
this.em_calibre_imprimir=create em_calibre_imprimir
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.pb_salir
this.Control[iCurrent+2]=this.st_3
this.Control[iCurrent+3]=this.st_texto_cantidad
this.Control[iCurrent+4]=this.st_pallets
this.Control[iCurrent+5]=this.st_total_cajas
this.Control[iCurrent+6]=this.st_cajas
this.Control[iCurrent+7]=this.st_tipopallet
this.Control[iCurrent+8]=this.st_calidad
this.Control[iCurrent+9]=this.st_articulo
this.Control[iCurrent+10]=this.em_t_pallets
this.Control[iCurrent+11]=this.em_cajas
this.Control[iCurrent+12]=this.em_t_cajas
this.Control[iCurrent+13]=this.em_cantidad
this.Control[iCurrent+14]=this.uo_articulo
this.Control[iCurrent+15]=this.uo_calidad
this.Control[iCurrent+16]=this.uo_tipo_pallet
this.Control[iCurrent+17]=this.st_texto_mtrslinieales
this.Control[iCurrent+18]=this.em_mtrs_lineales
this.Control[iCurrent+19]=this.cb_grabar
this.Control[iCurrent+20]=this.cb_borrar
this.Control[iCurrent+21]=this.em_descripcion
this.Control[iCurrent+22]=this.st_33
this.Control[iCurrent+23]=this.cb_insertar
this.Control[iCurrent+24]=this.uo_tipolinea
this.Control[iCurrent+25]=this.st_tplinea
this.Control[iCurrent+26]=this.cb_stock
this.Control[iCurrent+27]=this.em_anyo
this.Control[iCurrent+28]=this.em_situacion
this.Control[iCurrent+29]=this.gb_4
this.Control[iCurrent+30]=this.em_falbaran
this.Control[iCurrent+31]=this.st_tono
this.Control[iCurrent+32]=this.em_tono
this.Control[iCurrent+33]=this.st_calibre
this.Control[iCurrent+34]=this.em_calibre
this.Control[iCurrent+35]=this.st_deposito
this.Control[iCurrent+36]=this.deposito
this.Control[iCurrent+37]=this.pb_2
this.Control[iCurrent+38]=this.st_21
this.Control[iCurrent+39]=this.st_2
this.Control[iCurrent+40]=this.cb_1
this.Control[iCurrent+41]=this.st_23
this.Control[iCurrent+42]=this.st_4
this.Control[iCurrent+43]=this.st_peso_linea
this.Control[iCurrent+44]=this.st_peso_total
this.Control[iCurrent+45]=this.st_7
this.Control[iCurrent+46]=this.st_5
this.Control[iCurrent+47]=this.st_6
this.Control[iCurrent+48]=this.uo_cliente
this.Control[iCurrent+49]=this.em_albaran
this.Control[iCurrent+50]=this.pb_imprimir
this.Control[iCurrent+51]=this.pb_imprimir2
this.Control[iCurrent+52]=this.st_333
this.Control[iCurrent+53]=this.dw_listado
this.Control[iCurrent+54]=this.cb_ubicar
this.Control[iCurrent+55]=this.cb_2
this.Control[iCurrent+56]=this.cb_3
this.Control[iCurrent+57]=this.cantidad
this.Control[iCurrent+58]=this.st_cantidad
this.Control[iCurrent+59]=this.uo_caja
this.Control[iCurrent+60]=this.st_caja
this.Control[iCurrent+61]=this.em_prec
this.Control[iCurrent+62]=this.st_precio
this.Control[iCurrent+63]=this.uo_serie
this.Control[iCurrent+64]=this.gb_1
this.Control[iCurrent+65]=this.st_idioma
this.Control[iCurrent+66]=this.uo_idioma
this.Control[iCurrent+67]=this.sle_dtoesp2
this.Control[iCurrent+68]=this.st_1
this.Control[iCurrent+69]=this.dw_ubicaciones
this.Control[iCurrent+70]=this.dw_detalle
this.Control[iCurrent+71]=this.cb_desubicar
this.Control[iCurrent+72]=this.em_tono_imprimir
this.Control[iCurrent+73]=this.st_14
this.Control[iCurrent+74]=this.st_13
this.Control[iCurrent+75]=this.em_calibre_imprimir
end on

on w_int_almalb.destroy
call super::destroy
if IsValid(MenuID) then destroy(MenuID)
destroy(this.pb_salir)
destroy(this.st_3)
destroy(this.st_texto_cantidad)
destroy(this.st_pallets)
destroy(this.st_total_cajas)
destroy(this.st_cajas)
destroy(this.st_tipopallet)
destroy(this.st_calidad)
destroy(this.st_articulo)
destroy(this.em_t_pallets)
destroy(this.em_cajas)
destroy(this.em_t_cajas)
destroy(this.em_cantidad)
destroy(this.uo_articulo)
destroy(this.uo_calidad)
destroy(this.uo_tipo_pallet)
destroy(this.st_texto_mtrslinieales)
destroy(this.em_mtrs_lineales)
destroy(this.cb_grabar)
destroy(this.cb_borrar)
destroy(this.em_descripcion)
destroy(this.st_33)
destroy(this.cb_insertar)
destroy(this.uo_tipolinea)
destroy(this.st_tplinea)
destroy(this.cb_stock)
destroy(this.em_anyo)
destroy(this.em_situacion)
destroy(this.gb_4)
destroy(this.em_falbaran)
destroy(this.st_tono)
destroy(this.em_tono)
destroy(this.st_calibre)
destroy(this.em_calibre)
destroy(this.st_deposito)
destroy(this.deposito)
destroy(this.pb_2)
destroy(this.st_21)
destroy(this.st_2)
destroy(this.cb_1)
destroy(this.st_23)
destroy(this.st_4)
destroy(this.st_peso_linea)
destroy(this.st_peso_total)
destroy(this.st_7)
destroy(this.st_5)
destroy(this.st_6)
destroy(this.uo_cliente)
destroy(this.em_albaran)
destroy(this.pb_imprimir)
destroy(this.pb_imprimir2)
destroy(this.st_333)
destroy(this.dw_listado)
destroy(this.cb_ubicar)
destroy(this.cb_2)
destroy(this.cb_3)
destroy(this.cantidad)
destroy(this.st_cantidad)
destroy(this.uo_caja)
destroy(this.st_caja)
destroy(this.em_prec)
destroy(this.st_precio)
destroy(this.uo_serie)
destroy(this.gb_1)
destroy(this.st_idioma)
destroy(this.uo_idioma)
destroy(this.sle_dtoesp2)
destroy(this.st_1)
destroy(this.dw_ubicaciones)
destroy(this.dw_detalle)
destroy(this.cb_desubicar)
destroy(this.em_tono_imprimir)
destroy(this.st_14)
destroy(this.st_13)
destroy(this.em_calibre_imprimir)
end on

on ue_f2;call w_int_con_empresa::ue_f2;cb_insertar.TriggerEvent(Clicked!)
end on

event activate;call super::activate;w_int_almalb = ventanas_activas[id_ventana_activa].ventana
end event

type ole_cont_pro from w_int_con_empresa`ole_cont_pro within w_int_almalb
integer taborder = 90
end type

type sle_opcion_orden from w_int_con_empresa`sle_opcion_orden within w_int_almalb
end type

type st_empresa from w_int_con_empresa`st_empresa within w_int_almalb
integer y = 16
integer width = 2629
integer height = 88
end type

type pb_salir from upb_salir within w_int_almalb
integer x = 3077
integer y = 20
integer width = 110
integer height = 104
integer taborder = 0
end type

type st_3 from statictext within w_int_almalb
integer x = 123
integer y = 156
integer width = 155
integer height = 80
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Alb.:"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_texto_cantidad from statictext within w_int_almalb
integer x = 2706
integer y = 1616
integer width = 329
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Cantidad"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_pallets from statictext within w_int_almalb
integer x = 1851
integer y = 1616
integer width = 114
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Pl"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_total_cajas from statictext within w_int_almalb
integer x = 2176
integer y = 1616
integer width = 224
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "T.Cj"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_cajas from statictext within w_int_almalb
integer x = 1970
integer y = 1616
integer width = 201
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Cj"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_tipopallet from statictext within w_int_almalb
integer x = 1719
integer y = 1616
integer width = 133
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Tp"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_calidad from statictext within w_int_almalb
integer x = 1157
integer y = 1616
integer width = 123
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Cl"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_articulo from statictext within w_int_almalb
integer x = 306
integer y = 1616
integer width = 699
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Artículo"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_t_pallets from u_em_campo within w_int_almalb
integer x = 1851
integer y = 1688
integer width = 114
integer height = 88
integer taborder = 170
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "##0"
string displaydata = ""
end type

event modificado;call super::modificado;string cadena
long   posi,posi_aux

cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                          uo_tipo_pallet.em_codigo.text,&
                          uo_caja.em_codigo.text,&
								  integer(em_t_pallets.text),&
                          0,0, uo_tipolinea.em_codigo.text)
                      
IF ante_pallets <> Integer(This.text) Then em_mtrs_lineales.text=""
posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if
f_calculo_precio()


end event

event getfocus;call super::getfocus;ante_pallets = Integer(This.text)
campo_actual = "PALLETS"
f_peso_linea()
end event

type em_cajas from u_em_campo within w_int_almalb
integer x = 1970
integer y = 1688
integer width = 201
integer height = 88
integer taborder = 180
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "###,###"
end type

event modificado;call super::modificado;string cadena
long   posi,posi_aux

cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                          uo_tipo_pallet.em_codigo.text,&
								  uo_caja.em_codigo.text,&
                           integer(em_t_pallets.text),&
                           integer(em_cajas.text),&
                           Dec(em_cantidad.text), uo_tipolinea.em_codigo.text)
                      
IF ante_cajas <> Integer(This.text) Then em_mtrs_lineales.text=""
posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if

f_calculo_precio()


end event

event getfocus;call super::getfocus;ante_cajas = Integer(This.text)
campo_actual = "CAJAS"
f_peso_linea()
end event

type em_t_cajas from u_em_campo within w_int_almalb
integer x = 2176
integer y = 1688
integer width = 224
integer height = 88
integer taborder = 0
fontcharset fontcharset = ansi!
string facename = "Arial"
boolean enabled = false
alignment alignment = right!
boolean displayonly = true
maskdatatype maskdatatype = numericmask!
string mask = "###,###"
end type

type em_cantidad from u_em_campo within w_int_almalb
integer x = 2702
integer y = 1688
integer width = 334
integer height = 88
integer taborder = 200
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "###,###.00"
string displaydata = "Ä"
end type

event modificado;call super::modificado; long   posi,posi_aux
 string cadena
 
 IF var_control_alm ="S"  and var_sector = "S" THEN
	If ante_valor<>Dec(em_cantidad.text) THEN
		 em_cajas.text=""
		 em_t_cajas.text=""
		 em_t_pallets.text=""
		 em_mtrs_lineales.text =""
 	END  IF

	cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
										 uo_tipo_pallet.em_codigo.text,&
										 uo_caja.em_codigo.text,&
										 integer(em_t_pallets.text),&
										 integer(em_cajas.text),&
										 Dec(em_cantidad.text), uo_tipolinea.em_codigo.text)
	
	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		em_t_pallets.text     = Mid(cadena,1,posi - 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
	end if
		
	f_calculo_precio()
END IF
f_peso_linea()

end event

event getfocus;call super::getfocus;IF var_control_alm = "N" Then st_texto_cantidad.text = "Unidades"
ante_valor= Dec(em_cantidad.text)
campo_actual = "CANTIDAD"
f_peso_linea()


end event

type uo_articulo from u_em_campo_2 within w_int_almalb
integer x = 306
integer y = 1688
integer width = 699
integer height = 88
integer taborder = 100
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;String var_empresa,codigo_articulo,texto_unidad,des,desc2
string cod_tono,cod_calibre
Long   total_desc

SELECT articulos.descripcion,
       articulos.familia,
		 articulos.formato,
		 articulos.unidad
INTO   :des,
       :cod_familia,
		 :cod_formato,
		 :cod_tipo_unidad
FROM   articulos  
WHERE  articulos.empresa = :codigo_empresa
AND    articulos.codigo  = :uo_articulo.em_codigo.text;

if uo_tipolinea.em_codigo.text = "4" then cod_tipo_unidad = "0" //MUY IMPORTANTE - La promoción siempre va en piezas

desc2=f_descripcion_almcliartdesc2(codigo_empresa,uo_cliente.em_codigo.text,uo_articulo.em_codigo.text,dec(uo_idioma.em_codigo.text))
if desc2<>'' then
	uo_articulo.em_campo.text=desc2
else		
	uo_articulo.em_campo.text=des
end if	

select count(descripcion)
into :total_desc
from almcliartdesc
where empresa=:codigo_empresa and
		cliente=:venalb.cliente and
		articulo=:uo_articulo.em_codigo.text
group by empresa,cliente,articulo;

if isnull(total_desc) then total_desc = 0

if total_desc >= 1 then
	uo_idioma.em_codigo.text = "1"
	uo_idioma.em_campo.text = "1"
	if total_desc = 1 then
		uo_idioma.em_codigo.enabled = FALSE
	else
		uo_idioma.em_codigo.enabled = TRUE
	end if
end if
if total_desc = 0 then
	uo_idioma.em_codigo.text = "0"
	uo_idioma.em_campo.text = "0"
	uo_idioma.em_codigo.enabled = FALSE
end if

em_cajas.text                 = ""
em_cantidad.text              = ""
em_mtrs_lineales.text         = ""
em_t_cajas.text               = ""
em_t_pallets.text             = ""
uo_calidad.em_campo.text      = ""
uo_calidad.em_codigo.text     = ""
uo_tipo_pallet.em_campo.text  = ""
uo_tipo_pallet.em_codigo.text = ""
em_descripcion.text           = uo_articulo.em_campo.text

IF Trim(uo_articulo.em_campo.text)="" THEN 
	IF Trim(uo_articulo.em_codigo.text)<>"" Then uo_articulo.em_campo.SetFocus()
	uo_articulo.em_campo.text  = ""
	uo_articulo.em_codigo.text = ""
END IF

codigo_articulo               = uo_articulo.em_codigo.text
var_sector                    = f_sector_familia(codigo_empresa,cod_familia)
IF var_sector = "S" Then
	IF len(Trim(uo_articulo.em_codigo.text))<> 0 Then
		uo_tipo_pallet.em_codigo.text = f_pallet_palarticulo_cliente(codigo_empresa,uo_articulo.em_codigo.text,uo_cliente.em_codigo.text)
		uo_tipo_pallet.em_campo.text  = f_nombre_pallet_abr(codigo_empresa,uo_tipo_pallet.em_codigo.text)
		uo_caja.em_codigo.text        = f_caja_articulo_pallet(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text)
		uo_caja.em_campo.text         = f_nombre_caja_abr(codigo_empresa,uo_caja.em_codigo.text)		
	END IF
END IF

uo_calidad.em_codigo.text    = f_calidad_venparametros(codigo_empresa)
uo_calidad.em_campo.text     = f_nombre_calidad_abr(codigo_empresa,uo_calidad.em_codigo.text)
uo_calidad.ue_valor_anterior = uo_calidad.em_campo.text
st_texto_cantidad.text       = f_nombre_unidad(cod_tipo_unidad)
em_cantidad.Setmask(NumericMask!,f_mascara_unidad(cod_tipo_unidad))
f_campos_segun_tiplin()

IF var_total <> 0  and Not IsNUll(var_total) Then
	st_peso_total.text = String(var_total,"###,###,###")
ELse
	f_peso_linea()
END IF
f_calculo_precio()
f_deposito()

end event

event getfocus;call super::getfocus;// Controla si hay cliente en cabecera

if uo_cliente.em_codigo.text="" then
   f_mensaje("Campo de cliente","El cliente no esta introducido")
	f_activar_campo(uo_cliente.em_campo)
	Return
End if

// para controlar valor anterior
  articulo_ant = uo_articulo.em_codigo.text


ue_titulo     = "Ayuda seleccion de articulos"
ue_datawindow = "dw_ayuda_articulos_almcliartdesc"
ue_filtro     = ""
f_botones()

campo_actual = "ARTICULO"
end event

event losefocus;call super::losefocus;IF Trim(This.em_codigo.text) <> "" Then
  cb_stock.enabled    = TRUE
ELSE
  cb_stock.enabled    = FALSE
END IF
end event

on uo_articulo.destroy
call u_em_campo_2::destroy
end on

event busqueda;str_parametros param
IF IsNull(ue_datawindow) or Trim(ue_datawindow)="" Then Return
   param.s_titulo_ventana   =  ue_titulo
   param.s_nom_datawindow   =  ue_datawindow
   param.s_filtro           =  ue_filtro
   param.b_empresa          =  valor_empresa
   This.em_codigo.text      =  Trim(ue_valor)
   This.em_campo.text       =  ""
   f_buscar_largo(This.em_codigo,param)
   This.TriggerEvent("modificado")
	ue_valor_anterior = Trim(em_campo.text)
//	ue_campo.SetFocus()
	ue_campo.SelectText(1,Len(ue_campo.Text))
end event

type uo_calidad from u_em_campo_2 within w_int_almalb
integer x = 1157
integer y = 1688
integer width = 123
integer height = 88
integer taborder = 120
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;call super::modificado;uo_calidad.em_campo.text=f_nombre_calidad_abr(codigo_empresa,uo_calidad.em_codigo.text)
IF Trim(uo_calidad.em_campo.text)="" THEN 
 IF Trim(uo_calidad.em_codigo.text)<>"" Then uo_calidad.em_campo.SetFocus()
 uo_calidad.em_campo.text=""
 uo_calidad.em_codigo.text=""
END IF
f_calculo_precio()
f_campos_segun_tiplin()
f_deposito()
end event

event getfocus;call super::getfocus;// para controlar valor anterio
  calidad_ant = uo_calidad.em_codigo.text

ue_titulo     = "Ayuda seleccion de calidades"
ue_datawindow = "dw_ayuda_calidades"
ue_filtro     = ""

campo_actual = "CALIDAD"
f_peso_linea()
end event

on uo_calidad.destroy
call u_em_campo_2::destroy
end on

type uo_tipo_pallet from u_em_campo_2 within w_int_almalb
integer x = 1714
integer y = 1688
integer width = 133
integer height = 88
integer taborder = 160
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;uo_tipo_pallet.em_campo.text=f_nombre_palarticulocaja_abr(codigo_empresa,uo_articulo.em_codigo.text,uo_tipo_pallet.em_codigo.text,uo_caja.em_codigo.text)

IF Trim(uo_tipo_pallet.em_campo.text)=""  or IsNull(uo_tipo_pallet.em_campo.text)THEN 
 IF Trim(uo_tipo_pallet.em_codigo.text)<>"" Then 
   uo_tipo_pallet.em_campo.SetFocus()
 END IF
 uo_tipo_pallet.em_campo.text=""
 uo_tipo_pallet.em_codigo.text=""
END IF


f_peso_linea()	
f_deposito()
end event

event getfocus;call super::getfocus;ue_titulo     = "Ayuda seleccion de pallets"
ue_datawindow = "dw_ayuda_palarticulo_abr"
ue_filtro     = "(palarticulo_articulo = '" + uo_articulo.em_codigo.text+ "') and "+&
                "(palarticulo_caja = '" + uo_caja.em_codigo.text + "')" 
campo_actual = "TIPO_PALLET"



end event

on uo_tipo_pallet.destroy
call u_em_campo_2::destroy
end on

type st_texto_mtrslinieales from statictext within w_int_almalb
integer x = 2405
integer y = 1616
integer width = 297
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "M. Lin"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_mtrs_lineales from u_em_campo within w_int_almalb
integer x = 2405
integer y = 1688
integer width = 293
integer height = 88
integer taborder = 190
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "###,###.0"
end type

event getfocus;call super::getfocus;campo_actual = "METROS_LINEALES"
f_peso_linea()

end event

event modificado;call super::modificado;If Dec(em_mtrs_lineales.text)=0 THEN Return
em_cajas.text=""
em_t_cajas.text=""
em_t_pallets.text=""
string cadena
long posi,posi_aux

cadena=f_calculo_unidades_lineales(codigo_empresa,uo_articulo.em_codigo.text,&
								 uo_tipo_pallet.em_codigo.text,&
								 uo_caja.em_codigo.text,&
								 Dec(em_mtrs_lineales.text))
						  
posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if
f_calculo_precio()



end event

type cb_grabar from u_boton within w_int_almalb
integer x = 1998
integer y = 1864
integer width = 398
integer height = 68
integer taborder = 0
string text = "F3 Grabar  "
end type

event clicked;Dec{0}    var_anyo,var_albaran,cc,parcial
long      posi,posi_aux
tipo_array arg
Dec{4}    var_precio,disponible2
String    mascara,es_pico
mascara  = f_mascara_moneda(venalb.divisa)


if dec(em_cantidad.text)>=0 or isnull(em_cantidad.text) then
   f_mensaje("!!! A t e n c i ó n ¡¡¡¡¡ ","No pueden ser cantidades positivas, es un ABONO")
   f_activar_campo(em_cantidad) 
	Return
end if

f_control_tono_calibre()

IF control_tono  and Trim(em_tono.text) = "" Then
	f_mensaje("Control de tono","Introduzca el tono correcto")
	f_activar_campo(em_tono)
	Return
END IF

//IF control_calibre and Dec(em_calibre.text) = 0 Then
//	f_mensaje("Control de calibre","Introduzca el calibre correcto")
//	f_activar_campo(em_calibre)
//	Return
//END IF

IF control_calibre and (ISNULL(em_calibre.text) or em_calibre.text = '') Then
	f_mensaje("Control de calibre","Introduzca el calibre correcto")
	f_activar_campo(em_calibre)
	Return
END IF

string mensaje 

if f_articulos_tono_cliente(codigo_empresa,uo_articulo.em_codigo.text) = 'S' and trim(em_tono_imprimir.text) = '' then
	mensaje="El artículo tiene obligacion de tono de cliente."
	MessageBox("Atención",mensaje,Exclamation!,OK!,1)
	em_tono_imprimir.SetFocus()
	RETURN	
end if

if f_articulos_calibre_cliente(codigo_empresa,uo_articulo.em_codigo.text) = 'S' and trim(em_calibre_imprimir.text) = '' then
	mensaje="El artículo tiene obligacion de calibre de cliente."
	MessageBox("Atención",mensaje,Exclamation!,OK!,1)
	em_calibre_imprimir.SetFocus()
	RETURN	
end if

parcial = 0
IF deposito.text = "X" Then
	IF Abs(dec(em_cantidad.text)) > Dec(cantidad.text) Then
		parcial = Dec(em_cantidad.text) + Dec(cantidad.text)
//		f_mensaje("Inicial",STring(Dec(em_cantidad.text)))
//		f_mensaje("Deposito",STring(Dec(cantidad.text)))
//		f_mensaje("PArcial",String(parcial))
	END IF
END IF
em_cantidad.text = String(Dec(em_cantidad.text) - parcial)

var_anyo       = Dec(em_anyo.text)
var_albaran     = Dec(em_albaran.text)
var_precio     = dec(em_prec.text)
String motivo,controles,referencia,condicion,tipo_unidad,texto,acumular,condicion2
Integer  opcion,var_linea_acumulado
dec{2}   disponible,var_conjunto,diferencia,piezas_caja,dife,var_precio1,var_precio2
EditMask campo
piezas_caja = f_piezascaja_articulo(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text)
tipo_unidad = f_unidad_articulo(codigo_empresa,uo_articulo.em_codigo.text)
if uo_tipolinea.em_codigo.text = "4" then tipo_unidad = "0" //MUY IMPORTANTE - La promoción siempre trabaja en piezas


IF This.visible = FALSE Then RETURN
controles="N"
acumular  = "N" 

IF var_control_alm ="S" and var_sector = "S" THEN
	 em_cajas.text=""
	 em_t_cajas.text=""
	 em_t_pallets.text=""
	 em_mtrs_lineales.text =""
	 string cadena
	 cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                              uo_tipo_pallet.em_codigo.text,&
									   uo_caja.em_codigo.text,&
                              integer(em_t_pallets.text),&
                              integer(em_cajas.text),&
                              Dec(em_cantidad.text), uo_tipolinea.em_codigo.text)
 	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		em_t_pallets.text     = Mid(cadena,1,posi - 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
	end if    
  
END IF
IF var_control_alm ="S"  and var_sector = "S" THEN
  uo_tipo_pallet.TriggerEvent("modificado")
  IF TRIM(uo_tipo_pallet.em_campo.text)="" or IsNull(uo_tipo_pallet.em_campo.text) Then
   campo=uo_tipo_pallet.em_campo
   motivo= "(Campo Obligatorio) Introduzca el tipo de pallet"
   controles="S"
  END IF
END IF

IF Dec(em_cantidad.text) = 0  or IsNull(em_cantidad.text) Then
   campo=em_cantidad
   motivo= "(Campo Obligatorio) Introduzca la cantidad"
   controles="S"
END IF

IF var_control_alm ="S" and var_sector ="S" THEN
  IF Trim(uo_calidad.em_codigo.text) = ""  or IsNull(uo_articulo.em_codigo.text) Then
   campo=uo_calidad.em_campo
   motivo= "(Campo Obligatorio) Introduzca la calidad"
   controles="S"
  END IF
END IF

IF var_control_alm = "S" THEN
  IF Trim(uo_articulo.em_codigo.text) = ""  or IsNull(uo_articulo.em_codigo.text) Then
   campo=uo_articulo.em_campo
   motivo= "(Campo Obligatorio) Introduzca el articulo"
   controles="S"
  END IF
  
  // Control piezas por conjunto
     var_conjunto= f_conjunto_articulo(codigo_empresa,uo_articulo.em_codigo.text)
     IF var_conjunto<> 0 And Not IsNULL(var_conjunto) Then
      IF (Dec(String(Dec(em_cantidad.text)/var_conjunto,"##########")) * var_conjunto) <> Dec(em_cantidad.text) Then
          motivo= "Cantidad no valida Este articulo va por conjuntos la cantidad a de ser multiplo de: " + String(var_conjunto,"##")
          controles="S"
          campo= em_cantidad
      END IF
END IF


END IF

IF controles="S" THEN
 MessageBox("No se puede grabar la linea",motivo,Exclamation!, OK!,1)
 f_activar_campo(campo)
 Return
END IF

referencia  = f_componer_ref(uo_articulo.em_codigo.text,&
                            uo_calidad.em_codigo.text,Trim(em_tono.text),Dec(em_calibre.text))
									 
// Control clase de venta
var_clase ="A"

//// David 13-01-2005. Control de la clase de línea.
//// V-> Venta (típica)
//// M-> Muestras sin precio
//// S-> Ventas sin cargo
//// P-> Precio pendiente
//
//IF dec(em_prec.text) = 0  or IsNull(em_prec.text) Then
//	controles="S"
//	arg.valor[1]  = "Linea de pedido Sin precio"
//	arg.valor[11] = "Muestras"
//	arg.valor[12] = "Sin Cargo"
//	arg.valor[13] = "Precio Pdte." 
//	arg.valor[14] = "Cancelar" 
//	opcion = f_opciones(arg)
//	CHOOSE CASE opcion
//		CASE 1
//			var_clase ="M"
//		CASE 2
//			var_clase ="S"
//		CASE 3
//			var_clase ="P"
//		CASE 4
//			 f_activar_campo(em_prec)
//			 Return
//	END CHOOSE
//END IF
//
//// Fin David 13-01-2005

acumular ="N"
//-------------------------------------------------------------------------
// controlo si existe alguna linea al mismo articulo el albaran par informar
//-------------------------------------------------------------------------
IF tipo = "I" Then
IF var_control_alm = "S" THEN
	IF Len(em_t_pallets.text)= 0 Then
	    es_pico = "S"
   ELSE		 
	    es_pico = "N"
   END IF		

   	  acumular ="N"
END IF
IF var_control_alm = "N" Then
  SetNull(uo_articulo.text)
  SetNull(uo_calidad.text)
  SetNull(uo_tipo_pallet.text)
  SetNull(referencia)
 END IF
END IF

IF deposito.text = "X" Then
	// David: No se marcaba la cabecera del albarán como depósito.
	venalb.deposito = 'S'
	// fin david
	venalb.almacen_deposito = f_depalmacen_cliente(codigo_empresa,uo_cliente.em_codigo.text)
	IF tipo = "M" Then
		cc = dw_detalle.GetItemNumber(dw_detalle.getRow(),"cantidad")
		IF Not f_entrada_deposito(venalb.almacen_deposito,referencia,uo_tipo_pallet.em_codigo.text,cc) Then 
			ROLLBACK;
			f_mensaje("Error al procesar datos","Error al generar entrada del deposito")
			f_activar_campo(uo_articulo.em_campo)
			Return 
		END IF
	END IF
	// Salida almacen depósito
	
	// Añadimos la caja como parámetro 24-10-03
	//uo_caja.em_codigo.text,
	IF Not f_salida_deposito(venalb.almacen_deposito,referencia,uo_tipo_pallet.em_codigo.text,&
									 Dec(em_cantidad.text), uo_caja.em_codigo.text) Then 
		ROLLBACK;
		f_mensaje("Error al procesar datos","Error al generar salida del deposito")
		f_activar_campo(uo_articulo.em_campo)
		Return 
	END IF
END IF

f_grabar_linea()

IF parcial <> 0 Then
	SetNull(venalb.almacen_deposito)
	deposito.text = ""
	em_cantidad.text = String(parcial)
	cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                            uo_tipo_pallet.em_codigo.text,&
									 uo_caja.em_codigo.text,&
                            0,&
                            0,&
                            Dec(em_cantidad.text), uo_tipolinea.em_codigo.text)
                       
	posi_aux = 1
	posi = pos(cadena,"|",1)
	if posi <> 0 then
		em_t_pallets.text     = Mid(cadena,1,posi - 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <> 0 then
		em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
		posi_aux = posi + 1
	end if
	
	posi = pos(cadena,"|",posi_aux)
	if posi <>0 then
		em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
	end if
	f_grabar_linea()
END IF
f_control()
IF tipo = "I" Then dw_detalle.ScrollToRow(dw_detalle.RowCount())
f_botones()
cb_insertar.TriggerEvent(clicked!)
articulo_ant=""
f_deposito()


// David 15-06-04: Si no es depósito, haremos un movimiento en el almacén normal.
IF deposito.text <> "X" Then
	cb_ubicar.triggerevent (clicked!)
end if

end event

type cb_borrar from u_boton within w_int_almalb
integer x = 2395
integer y = 1796
integer width = 398
integer height = 68
integer taborder = 0
boolean bringtotop = true
string text = "F4 Borrar     "
end type

event clicked;String referencia
IF This.enabled = FALSE Then RETURN
If MessageBox("Comfirmacion Baja linea de pedido","Desa borra la linea de pedido seleccionada",Question!, YesNo!,2)= 2 Then
  f_activar_primer_campo()
  Return
END IF
IF f_valor_columna(dw_detalle,dw_detalle.GetRow(),"situacion") = "S" Then
	f_mensaje("No se puede borrar la linea","Linea ubicada no se puede borrar")
	Return
END IF
IF deposito.text = "X" Then
	referencia = f_componer_ref(dw_detalle.GetItemString(dw_detalle.GetRow(),"articulo"),dw_detalle.GetItemString(dw_detalle.GetRow(),"calidad"),dw_detalle.GetItemString(dw_detalle.GetRow(),"tonochar"),dw_detalle.GetItemNumber(dw_detalle.GetRow(),"calibre"))
	venalb.almacen_deposito = f_depalmacen_cliente(codigo_empresa,dw_detalle.GetItemString(dw_detalle.GetRow(),"cliente"))
	IF Not f_entrada_deposito(venalb.almacen_deposito,referencia,uo_tipo_pallet.em_codigo.text,dw_detalle.GetItemNumber(dw_detalle.GetRow(),"cantidad")) Then 
		ROLLBACK;
		f_mensaje("Error al procesar datos","Error al generar salida del deposito")
		f_activar_campo(uo_articulo.em_campo)
		Return 
	END IF
END IF
f_borrar_linea()
f_control()
cb_insertar.TriggerEvent(clicked!)

end event

type em_descripcion from u_em_campo within w_int_almalb
integer x = 14
integer y = 1864
integer width = 1166
integer taborder = 220
fontcharset fontcharset = ansi!
string facename = "Arial"
string mask = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
end type

on getfocus;call u_em_campo::getfocus;campo_actual = "DESCRIPCION"
end on

type st_33 from statictext within w_int_almalb
integer x = 14
integer y = 1788
integer width = 1170
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Descripción artículo"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type cb_insertar from u_boton within w_int_almalb
integer x = 1998
integer y = 1796
integer width = 398
integer height = 68
integer taborder = 0
string text = "F2 Insertar"
end type

event clicked;
control_incremento            = "S"
tipo                          = "I"
linea_albaran                 = 0
em_cajas.text                 = ""
em_tono.text                  = ""
em_tono_imprimir.text         = ""
em_calibre.text               = ""
em_calibre_imprimir.text      = ""
em_cantidad.text              = ""
em_descripcion.text           = ""
em_mtrs_lineales.text         = ""
em_situacion.text             = ""
em_t_cajas.text               = ""
em_t_pallets.text             = ""
uo_articulo.em_campo.text     = ""
uo_calidad.em_campo.text      = ""
uo_tipo_pallet.em_campo.text  = ""
uo_articulo.em_codigo.text    = ""
articulo_ant                  = ""
uo_calidad.em_codigo.text     = ""
uo_idioma.em_campo.text       = "0"
uo_tipo_pallet.em_codigo.text = ""
uo_tipolinea.em_codigo.text   = "12"
uo_tipolinea.em_campo.text    = f_nombre_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
uo_tipolinea.TriggerEvent("modificado")
em_situacion.text             = "P"
f_deposito()
f_botones()
dw_detalle.SelectRow(0,FALSE)
f_campos_segun_tiplin()
f_activar_primer_campo()
f_peso_linea()
end event

type uo_tipolinea from u_em_campo_2 within w_int_almalb
integer x = 9
integer y = 1688
integer width = 288
integer height = 88
boolean enabled = false
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;call super::modificado;f_campos_segun_tiplin()
uo_tipolinea.em_campo.text=f_nombre_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
IF Trim(uo_tipolinea.em_campo.text)=""  or IsNull(uo_tipolinea.em_campo.text)THEN 
 IF Trim(uo_tipolinea.em_codigo.text)<>"" Then 
   f_activar_campo(uo_tipolinea.em_campo)
 END IF
 uo_tipolinea.em_campo.text   = ""
 uo_tipolinea.em_codigo.text  = ""
END IF

end event

on getfocus;call u_em_campo_2::getfocus;ue_titulo     = "Ayuda seleccion tipos de linea (facturación)"
ue_datawindow = "dw_ayuda_ventipolin"
ue_filtro     = ""
tipolinea_ant = this.em_codigo.text

campo_actual = "TIPO_LINEA"
end on

on uo_tipolinea.destroy
call u_em_campo_2::destroy
end on

type st_tplinea from statictext within w_int_almalb
integer x = 9
integer y = 1616
integer width = 288
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Tp. linea"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type cb_stock from u_boton within w_int_almalb
integer x = 2395
integer y = 1864
integer width = 398
integer height = 68
integer taborder = 0
string text = "F5 Ver stock"
end type

event clicked;call super::clicked;IF This.enabled = FALSE Then RETURN
str_parametros valores
       IF var_control_alm = "N" Then Return
       f_consulta_disponible()
       IF Message.DoubleParm=-1  THEN 
       ELSE
          If em_tono.text= "0" Then em_tono.text="" 
          If em_calibre.text= "0" Then em_calibre.text="" 
          valores = Message.PowerObjectParm
          uo_articulo.em_campo.text= f_nombre_articulo(codigo_empresa,valores.s_argumentos[1])
          uo_articulo.em_codigo.text= valores.s_argumentos[1]
          uo_calidad.em_campo.text  = f_nombre_calidad_abr(codigo_empresa,valores.s_argumentos[2])
	   	 uo_calidad.em_codigo.text     = valores.s_argumentos[2]
		    em_tono.text                  = valores.s_argumentos[3]
		    em_calibre.text               = valores.s_argumentos[4]
          uo_tipo_pallet.em_campo.text  = f_nombre_pallet_abr(codigo_empresa,valores.s_argumentos[5])
		    uo_tipo_pallet.em_codigo.text = valores.s_argumentos[5]
 			 uo_articulo.ue_valor_anterior = uo_articulo.em_campo.text
			 uo_tipo_pallet.ue_valor_anterior = uo_tipo_pallet.em_campo.text
			 uo_calidad.ue_valor_anterior = uo_calidad.em_campo.text
			 f_activar_campo(uo_calidad.em_campo)
        END IF
end event

type em_anyo from u_em_campo within w_int_almalb
integer x = 288
integer y = 156
integer width = 178
integer height = 80
integer taborder = 10
long textcolor = 128
alignment alignment = right!
maskdatatype maskdatatype = numericmask!
string mask = "####"
end type

type em_situacion from u_em_campo within w_int_almalb
boolean visible = false
integer x = 23
integer y = 1968
integer width = 123
integer taborder = 280
boolean border = false
borderstyle borderstyle = stylebox!
end type

type gb_4 from groupbox within w_int_almalb
integer x = 1989
integer y = 1760
integer width = 1216
integer height = 180
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
borderstyle borderstyle = styleraised!
end type

type em_falbaran from u_em_campo within w_int_almalb
integer x = 1490
integer y = 156
integer width = 370
integer height = 80
integer taborder = 50
long textcolor = 128
alignment alignment = center!
maskdatatype maskdatatype = datemask!
string mask = "dd-mm-yyyy"
string displaydata = ""
end type

type st_tono from statictext within w_int_almalb
integer x = 1454
integer y = 1616
integer width = 82
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "C"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_tono from u_em_campo within w_int_almalb
event getfocus pbm_ensetfocus
event modificado pbm_custom02
integer x = 1285
integer y = 1688
integer width = 165
integer height = 88
integer taborder = 130
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = "!!!!!!!!!!!!!!!!!!!!"
end type

event getfocus;call super::getfocus;campo_actual = "TONO"
f_control_tono_calibre()


end event

event modificado;call super::modificado;string cadena
long   posi,posi_aux

cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                          uo_tipo_pallet.em_codigo.text,&
                          uo_caja.em_codigo.text,&
								  integer(em_t_pallets.text),&
                          integer(em_cajas.text),Dec(em_cantidad.text), uo_tipolinea.em_codigo.text)
                      

IF ante_pallets <> Integer(This.text) Then em_mtrs_lineales.text=""
posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if


IF precio_ant = em_precio Then f_calculo_precio()

f_deposito()
end event

event losefocus;call super::losefocus;f_control_tono_calibre()

if f_familias_replica_tono_calibre(codigo_empresa,f_familia_articulo(codigo_empresa,uo_articulo.em_codigo.text)) = 'S' then
	em_tono_imprimir.text = this.text
end if
end event

type st_calibre from statictext within w_int_almalb
integer x = 1285
integer y = 1616
integer width = 169
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "To"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_calibre from u_em_campo within w_int_almalb
event getfocus pbm_ensetfocus
event modificado pbm_custom02
integer x = 1454
integer y = 1688
integer width = 78
integer height = 88
integer taborder = 140
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = ""
end type

event getfocus;call super::getfocus;campo_actual = "TONO"
f_control_tono_calibre()

end event

event modificado;call super::modificado;string cadena
long   posi,posi_aux

cadena=f_calculo_unidades_tipolin(codigo_empresa,uo_articulo.em_codigo.text,&
                          uo_tipo_pallet.em_codigo.text,&
                          uo_caja.em_codigo.text,&
								  integer(em_t_pallets.text),&
                          integer(em_cajas.text),Dec(em_cantidad.text), uo_tipolinea.em_codigo.text)
                      
IF ante_pallets <> Integer(This.text) Then em_mtrs_lineales.text=""
posi_aux = 1
posi = pos(cadena,"|",1)
if posi <> 0 then
	em_t_pallets.text     = Mid(cadena,1,posi - 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <> 0 then
	em_cajas.text         = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_t_cajas.text       = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_cantidad.text      = Mid(cadena,posi_aux,posi - posi_aux + 1)
	posi_aux = posi + 1
end if

posi = pos(cadena,"|",posi_aux)
if posi <>0 then
	em_mtrs_lineales.text = Mid(cadena,posi_aux,posi - posi_aux + 1)
end if

IF precio_ant = em_precio Then f_calculo_precio()

f_deposito()
end event

event losefocus;call super::losefocus;f_control_tono_calibre()

if f_familias_replica_tono_calibre(codigo_empresa,f_familia_articulo(codigo_empresa,uo_articulo.em_codigo.text)) = 'S' then
	em_calibre_imprimir.text = this.text
end if
end event

type st_deposito from statictext within w_int_almalb
boolean visible = false
integer x = 1184
integer y = 1788
integer width = 123
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Dep"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type deposito from statictext within w_int_almalb
boolean visible = false
integer x = 1184
integer y = 1864
integer width = 123
integer height = 88
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string pointer = "\BMP\Mano.cur"
long textcolor = 255
long backcolor = 12632256
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

event doubleclicked;//IF this.visible = FALSE Then Return 
//
//IF This.text = "X" Then
//	This.text = ""
//ELSE
//	This.text = "X"
//END IF
//
end event

type pb_2 from u_calculadora within w_int_almalb
integer x = 1029
integer y = 148
integer taborder = 0
end type

event clicked;dec{0} n_albaran
Integer numero, anyo, i , contador = 50
String  var_empresa, var_serie
boolean insertado 

IF Trim(em_anyo.text) = "" THEN
	messagebox("Atención","Debe introducir el año del abono")
	em_anyo.setfocus()
	return
end if

IF Trim(uo_serie.em_codigo.text) = "" THEN
	messagebox("Atención","Debe introducir la serie del albaran")
	uo_serie.em_campo.setfocus()
	return
end if

anyo = Integer(em_anyo.text)
var_serie = uo_serie.em_codigo.text

SELECT venparamalb.empresa,
       venparamalb.albaran
INTO   :var_empresa,
       :n_albaran
FROM   venparamalb  
WHERE  venparamalb.empresa = :codigo_empresa  
And    venparamalb.anyo    = :anyo
And    venparamalb.serie   = :var_serie;

IF IsNull(n_albaran) Then n_albaran = 0

If Sqlca.Sqlcode = 100 Then
	messagebox("Atención","El contador de la serie que ha seleccionado no esta activado.")
else
	i = 1
	insertado = false
	do  while i < contador and not insertado
		SELECT venparamalb.empresa,
				 venparamalb.albaran
		INTO   :var_empresa,
				 :n_albaran
		FROM   venparamalb  
		WHERE  venparamalb.empresa = :codigo_empresa  
		And    venparamalb.anyo    = :anyo
		And    venparamalb.serie   = :var_serie;
		
//-----------------------------------------------------------		
//		Select max(venalb.albaran)
//		Into   :var_albaran
//		From   venalb
//		Where  venalb.empresa = :codigo_empresa
//		And    venalb.anyo    = :anyo
//		And    venalb.serie   = :var_serie;
//		
//		if isnull(var_albaran) then var_albaran = 0
//		var_albaran ++
//		
//		Select max(venlifac.albaran)
//		Into   :var_albaran_fac
//		From   venlifac
//		Where  venlifac.empresa      = :codigo_empresa
//		And    venlifac.anyo_albaran = :anyo
//		And    venlifac.serie        = :var_serie;
//		
//		if isnull(var_albaran_fac) then var_albaran_fac = 0
//		var_albaran_fac ++
//		
//		if var_albaran_fac > var_albaran then
//			registros = var_albaran_fac
//		else
//			registros = var_albaran
//		end if
//-----------------------------------------------------------		

		IF IsNull(n_albaran) Then n_albaran = 0
		n_albaran = n_albaran + 1
		
		UPDATE venparamalb
		SET    albaran = :n_albaran
		WHERE  venparamalb.empresa = :codigo_empresa
		And    venparamalb.anyo    = :anyo
		And    venparamalb.serie   = :var_serie;
		
		if Sqlca.Sqlcode = 0  then
			COMMIT;
			insertado = true
		else
			ROLLBACK;
			insertado = false
		end if
		i++
	loop
end If
	
em_albaran.text = String(n_albaran)
f_leer_cab()	
//apartados.TriggerEvent("pulsar_datawindow")





end event

type st_21 from statictext within w_int_almalb
integer x = 37
integer y = 260
integer width = 238
integer height = 80
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Cliente:"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_2 from statictext within w_int_almalb
integer x = 475
integer y = 160
integer width = 46
integer height = 72
integer textsize = -11
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "Algerian"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
string text = "-"
alignment alignment = right!
boolean focusrectangle = false
end type

type cb_1 from u_boton within w_int_almalb
integer x = 1911
integer y = 156
integer width = 274
integer height = 80
integer taborder = 0
string text = "&Consultar"
end type

event clicked;call super::clicked;str_parametros lstr_param
lstr_param.i_nargumentos=3
lstr_param.s_argumentos[2]=uo_cliente.em_codigo.text
lstr_param.s_argumentos[3]="S"
OpenWithParm(w_con_almalb_cliente,lstr_param) 
Close(Parent)


end event

type st_23 from statictext within w_int_almalb
integer x = 1280
integer y = 156
integer width = 197
integer height = 80
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Fecha:"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_4 from statictext within w_int_almalb
integer x = 2505
integer y = 268
integer width = 279
integer height = 52
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Peso total"
alignment alignment = center!
boolean focusrectangle = false
end type

type st_peso_linea from statictext within w_int_almalb
integer x = 2619
integer y = 316
integer width = 242
integer height = 52
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
alignment alignment = right!
boolean focusrectangle = false
end type

type st_peso_total from statictext within w_int_almalb
integer x = 2825
integer y = 264
integer width = 242
integer height = 52
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
boolean enabled = false
alignment alignment = right!
boolean focusrectangle = false
end type

type st_7 from statictext within w_int_almalb
integer x = 2816
integer y = 260
integer width = 265
integer height = 116
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
alignment alignment = right!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_5 from statictext within w_int_almalb
integer x = 2519
integer y = 312
integer width = 283
integer height = 60
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Peso Linea"
alignment alignment = center!
boolean focusrectangle = false
end type

type st_6 from statictext within w_int_almalb
integer x = 2496
integer y = 260
integer width = 320
integer height = 116
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
alignment alignment = right!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type uo_cliente from u_em_campo_2 within w_int_almalb
event modificado pbm_custom01
event getfocus pbm_custom04
event destroy ( )
integer x = 288
integer y = 256
integer width = 1897
integer taborder = 70
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;call super::modificado;uo_cliente.em_campo.text=f_nombre_cliente(codigo_empresa,"C",uo_cliente.em_codigo.text)
If Trim(uo_cliente.em_campo.text)="" then
	uo_cliente.em_campo.text=""
	uo_cliente.em_codigo.text=""
	Return
end if 
venalb.cliente = uo_cliente.em_codigo.text
Dec var_ejercicio
SELECT venclientes.zona,venclientes.serie,venclientes.agente1,   
       venclientes.agente2,venclientes.agente3,venclientes.comision1, venclientes.comision2,   venclientes.comision31,
       venclientes.cod_pago,venclientes.dtopp,venclientes.dtoesp1,   
       venclientes.dtoesp2, venclientes.tipoiva,
	    venclientes.forma_envio, venclientes.tipo_portes,   
   	 venclientes.cod_entrega, venclientes.periodo_fac,   
		 venclientes.explicaciondto1, venclientes.explicaciondto2,   
		 venclientes.tarifa,   
		 venclientes.comision11,      venclientes.comision22,   venclientes.comision31, 
		 venclientes.dtoesp3,         venclientes.dtoesp4,   
		 venclientes.explicaciondto3, venclientes.explicaciondto4,   
		 venclientes.tipodto1,        venclientes.tipodto2,   
		 venclientes.tipodto3,        venclientes.tipodto4,   
		 venclientes.empresa,         venclientes.codigo  ,
		 venclientes.cod_entrega,     venclientes.calculo_dto  ,
		 venclientes.banco_de_cobro,  venclientes.envio,
		 venclientes.correspondencia,venclientes.domiciliacion,venclientes.transportista
	INTO   :venalb.zona, :venalb.serie, :venalb.agente1, :venalb.agente2,:venalb.agente3,:venalb.comision1,   
          :venalb.comision2,:venalb.comision31,:venalb.codpago,:venalb.dtopp,:venalb.dtoesp1,
		    :venalb.dtoesp2,:venalb.tipoiva, :venalb.forma_envio,   
		    :venalb.tipo_portes,:venalb.cod_entrega,:venalb.periodo_fac,
		    :venalb.explicaciondto1,:venalb.explicaciondto2,   
		    :venalb.tarifa,:venalb.comision11,:venalb.comision22,:venalb.comision31,:venalb.dtoesp3,   
	       :venalb.dtoesp4,:venalb.explicaciondto3,:venalb.explicaciondto4,
		    :venalb.tipodto1,:venalb.tipodto2,:venalb.tipodto3,:venalb.tipodto4,   
		    :venalb.empresa,:venalb.cliente ,:venalb.cod_entrega,
			 :venalb.calculo_dto,:venalb.banco_de_cobro,
			 :venalb.envio,:venalb.correspondencia,
			 :venalb.domiciliacion,:venalb.transportista
		FROM  venclientes  
      WHERE venclientes.empresa = :codigo_empresa 
		AND   venclientes.codigo = :venalb.cliente;
		
      Select genter.idioma,genter.moneda
     Into    :venalb.idioma,:venalb.divisa
     From    genter
     Where   genter.empresa = :codigo_empresa 
     And     genter.tipoter = 'C'
     And     genter.codigo  = :venalb.cliente;
       
   var_ejercicio = f_ejercicio_activo(codigo_empresa) 	  
	SELECT contaiva.iva  INTO :venalb.iva  
	FROM   contaiva  
	WHERE  contaiva.ejercicio = :var_ejercicio 
	AND    contaiva.empresa = :codigo_empresa 
	AND    contaiva.tipoiva = :venalb.tipoiva;


end event

event getfocus;call super::getfocus;ue_titulo = "Selección de Clientes"
ue_datawindow ="dw_ayuda_clientes"
ue_filtro = ""
end event

on uo_cliente.destroy
call u_em_campo_2::destroy
end on

type em_albaran from u_em_campo within w_int_almalb
integer x = 759
integer y = 156
integer height = 80
integer taborder = 30
long textcolor = 128
maskdatatype maskdatatype = numericmask!
string mask = "######"
end type

event modificado;call super::modificado;f_leer_cab()
end event

type pb_imprimir from upb_imprimir within w_int_almalb
event clicked pbm_bnclicked
integer x = 1147
integer y = 148
integer taborder = 0
end type

event clicked;Dec var_anyo,var_albaran
dateTime    fecha
fecha = DateTime(Today(),Now())
 
 IF Trim(em_albaran.text) = "" THEN Return
 str_parametros lstr_param
 lstr_param.i_nargumentos    = 4
 lstr_param.s_argumentos[2]= "1"
 lstr_param.s_argumentos[3]= em_anyo.text
 lstr_param.s_argumentos[4]= em_albaran.text
 f_activar_campo(em_albaran)
 OpenWithParm(w_lis_venalbaranes,lstr_param)

 var_anyo     =  Dec(em_anyo.text)
 var_albaran  =  Dec(em_albaran.text)
	Update venalb 
	Set    venalb.flistado = :fecha,
	       venalb.veces    = venalb.veces + 1
	 Where venalb.empresa   = :codigo_empresa
	 And   venalb.anyo      = :var_anyo
	 And   venalb.albaran   = :var_albaran;
	 COMMIT;
f_activar_campo(em_albaran)


end event

type pb_imprimir2 from upb_imprimir within w_int_almalb
event clicked pbm_bnclicked
integer x = 2478
integer y = 132
integer height = 120
integer taborder = 0
boolean originalsize = false
end type

event clicked;call super::clicked;IF Trim(em_albaran.text) = "" THEN Return
dw_listado.Retrieve(codigo_empresa,Dec(em_anyo.text),Dec(em_albaran.text))
f_imprimir_datawindow(dw_listado)

end event

type st_333 from statictext within w_int_almalb
integer x = 2592
integer y = 132
integer width = 242
integer height = 120
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Listado Ubicar"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type dw_listado from datawindow within w_int_almalb
boolean visible = false
integer x = 2208
integer y = 24
integer width = 494
integer height = 76
integer taborder = 80
boolean bringtotop = true
string dataobject = "report_albaranes_abonos"
boolean livescroll = true
end type

type cb_ubicar from u_boton within w_int_almalb
event clicked pbm_bnclicked
boolean visible = false
integer x = 37
integer y = 1496
integer width = 297
integer height = 72
integer taborder = 0
string text = "Ubicar"
end type

event clicked;call super::clicked;IF Not f_bloquear_almacen(w_int_almalb.title) Then
	f_ubicar()
	f_desbloquear_almacen(w_int_almalb.title)
END IF
end event

type cb_2 from commandbutton within w_int_almalb
integer x = 2793
integer y = 1796
integer width = 398
integer height = 68
integer taborder = 270
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
string text = "&Ult.Ventas"
end type

event clicked;f_activar_campo(uo_articulo.em_campo)
str_parametros lstr_param

lstr_param.s_argumentos[1] = "w_con_stock_articulos"
lstr_param.s_argumentos[2] = uo_articulo.em_codigo.text
lstr_param.s_argumentos[3] = uo_calidad.em_codigo.text
lstr_param.s_argumentos[4] = em_tono.text
lstr_param.s_argumentos[5] = em_calibre.text
lstr_param.s_argumentos[6] = uo_tipo_pallet.em_codigo.text
lstr_param.s_argumentos[7] = uo_cliente.em_codigo.text
lstr_param.s_argumentos[8] = ""
lstr_param.i_nargumentos   = 8

OpenWithParm(w_con_ventas_articulos,lstr_param) 

end event

type cb_3 from commandbutton within w_int_almalb
event clicked pbm_bnclicked
integer x = 2793
integer y = 1864
integer width = 398
integer height = 68
integer taborder = 260
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
end type

type cantidad from editmask within w_int_almalb
boolean visible = false
integer x = 1312
integer y = 1864
integer width = 293
integer height = 80
integer taborder = 230
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 8388608
long backcolor = 12632256
boolean border = false
alignment alignment = right!
end type

type st_cantidad from statictext within w_int_almalb
boolean visible = false
integer x = 1307
integer y = 1788
integer width = 315
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Existencias"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type uo_caja from u_em_campo_2 within w_int_almalb
event destroy ( )
integer x = 1536
integer y = 1688
integer width = 183
integer height = 88
integer taborder = 150
boolean border = true
borderstyle borderstyle = stylelowered!
end type

on uo_caja.destroy
call u_em_campo_2::destroy
end on

event modificado;uo_caja.em_campo.text=f_nombre_almartcaja_abr(codigo_empresa,uo_articulo.em_codigo.text,uo_caja.em_codigo.text)

IF Trim(uo_caja.em_campo.text)=""  or IsNull(uo_caja.em_campo.text)THEN 
 IF Trim(uo_caja.em_codigo.text)<>"" Then 
   uo_caja.em_campo.SetFocus()
 END IF
 uo_caja.em_campo.text=""
 uo_caja.em_codigo.text=""
END IF


end event

event getfocus;call super::getfocus;ue_titulo     = "Ayuda seleccion de cajas"
ue_datawindow = "dw_ayuda_almartcajas"
ue_filtro     = "almartcajas_articulo = '" + uo_articulo.em_codigo.text+ "'"
campo_actual = "CAJA"



end event

type st_caja from statictext within w_int_almalb
integer x = 1536
integer y = 1616
integer width = 183
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Tc"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_prec from u_em_campo within w_int_almalb
integer x = 1184
integer y = 1864
integer width = 347
integer taborder = 240
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
maskdatatype maskdatatype = decimalmask!
string mask = "###,###,###.00###"
end type

event getfocus;call super::getfocus;//this.setmask(NumericMask!,f_mascara_precios_fra_moneda(venped.divisa))
end event

event modificado;call super::modificado;//if venped.divisa="1" then
//	This.text = String(Dec(This.text),"###,###,###,###.00")
//else
//f_mensaje("masc",f_mascara_precios_fra_moneda(venped.divisa))
//	This.text = String(Dec(This.text),f_mascara_precios_fra_moneda(venped.divisa))
//end if

//campo_actual = "PRECIO"

end event

type st_precio from statictext within w_int_almalb
integer x = 1184
integer y = 1788
integer width = 347
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Precio"
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type uo_serie from u_em_campo_2 within w_int_almalb
event destroy ( )
integer x = 553
integer y = 156
integer width = 201
integer height = 80
integer taborder = 20
boolean border = true
borderstyle borderstyle = stylelowered!
end type

on uo_serie.destroy
call u_em_campo_2::destroy
end on

event modificado;uo_serie.em_campo.text = f_nombre_venseries_abr(codigo_empresa,uo_serie.em_codigo.text)

If Trim(uo_serie.em_campo.text)="" then
	uo_serie.em_campo.text=""
	uo_serie.em_codigo.text=""
	Return
end if 

end event

event getfocus;call super::getfocus;
	ue_titulo = "Selección de Series"
	ue_datawindow ="dw_ayuda_venseries"
	ue_filtro = ""

end event

type gb_1 from groupbox within w_int_almalb
integer x = 14
integer y = 108
integer width = 2190
integer height = 256
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Small Fonts"
long textcolor = 128
long backcolor = 12632256
end type

type st_idioma from statictext within w_int_almalb
integer x = 1010
integer y = 1616
integer width = 137
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Idi"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type uo_idioma from u_em_campo_2 within w_int_almalb
integer x = 1010
integer y = 1688
integer width = 137
integer height = 88
integer taborder = 110
boolean border = true
borderstyle borderstyle = stylelowered!
end type

event modificado;String des,desc2

uo_idioma.em_campo.text=uo_idioma.em_codigo.text
IF Trim(uo_idioma.em_campo.text)="" THEN 
 IF Trim(uo_idioma.em_codigo.text)<>"" Then uo_idioma.em_campo.SetFocus()
 uo_idioma.em_campo.text=""
 uo_idioma.em_codigo.text=""
END IF
des = uo_articulo.em_campo.text
desc2=f_descripcion_almcliartdesc2(codigo_empresa,venalb.cliente,uo_articulo.em_codigo.text,dec(uo_idioma.em_codigo.text))
if desc2<>'' then
	uo_articulo.em_campo.text=desc2
else		
	uo_articulo.em_campo.text=des
end if
em_descripcion.text = uo_articulo.em_campo.text
f_calculo_precio()
f_campos_segun_tiplin()
f_deposito()
end event

event getfocus;call super::getfocus;// para controlar valor anterio
  idioma_ant = uo_idioma.em_codigo.text

valor_empresa = TRUE
ue_titulo     = "Ayuda seleccion de descripciones alternativas"
ue_datawindow = "dw_ayuda_almcliartdesc"
ue_filtro     = "cliente = '"+venalb.cliente+"' and codigo = '"+uo_articulo.em_codigo.text+"'"


campo_actual = "IDIOMA"
f_peso_linea()
end event

on uo_idioma.destroy
call u_em_campo_2::destroy
end on

type sle_dtoesp2 from singlelineedit within w_int_almalb
integer x = 3040
integer y = 1688
integer width = 160
integer height = 88
integer taborder = 210
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
borderstyle borderstyle = stylelowered!
end type

type st_1 from statictext within w_int_almalb
integer x = 3040
integer y = 1616
integer width = 165
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Dto2"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type dw_ubicaciones from u_datawindow within w_int_almalb
boolean visible = false
integer x = 974
integer y = 632
integer width = 1870
integer height = 716
integer taborder = 40
string dataobject = "dw_con_almalb_cliente2"
borderstyle borderstyle = styleraised!
end type

event clicked;call super::clicked;IF f_objeto_datawindow(This) = "salir" Then
	dw_ubicaciones.visible = FALSE
	dw_detalle.enabled = TRUE
	f_activar(TRUE)
END IF
IF f_objeto_datawindow(This) = "referencia" Then
	f_ubi(1)
END IF
IF f_objeto_datawindow(This) = "todas" Then
	f_ubi(2)
END IF
IF f_objeto_datawindow(This) = "ubicar" Then
	dw_ubicaciones.Object.referencia.visible = FALSE
	dw_ubicaciones.Object.todas.visible = FALSE
	dw_ubicaciones.Object.ubicar.visible = FALSE
	
	This.Reset()
	This.InsertRow(1)
	This.SetItem(1,"almlinubica_empresa",codigo_empresa)
	This.SetItem(1,"calidades_abreviado",f_nombre_calidad_abr(codigo_empresa,var_calidad))
	This.SetItem(1,"almlinubica_tonochar",var_tono)
	This.SetItem(1,"almlinubica_calibre",var_calibre)
	This.SetItem(1,"pallets_resumido",f_nombre_pallet_abr(codigo_empresa,var_tipo_pallet))
	This.SetItem(1,"almlinubica_existencias",var_cantidad)
   This.SetItem(1,"altura",0)
	This.SetTabOrder("almlinubica_almacen",1)
	This.SetTabOrder("zona",2)
	This.SetTabOrder("fila",3)
	This.SetTabOrder("altura",4)
	This.SetFocus()
	This.SetRow(1)	
	This.SetColumn("almlinubica_almacen")	
	
END IF

end event

event doubleclicked;call super::doubleclicked;IF row = 0 Then Return
String var_almacen,var_zona,var_ubicacion
Dec    var_fila,var_altura,anyo,albaran,linea
var_almacen  = GetItemString(row,"almlinubica_almacen")
var_zona     = GetItemString(row,"zona")
var_fila     = GetItemNumber(row,"fila")
var_altura   = GetItemNumber(row,"altura")
IF f_ubi_exist(codigo_empresa,var_almacen,var_zona,var_fila,var_altura) Then
  var_ubicacion = f_componer_ubicacion(var_almacen,var_zona,var_fila,var_altura)
  dw_detalle.SetItem(dw_detalle.GetRow(),"ubicacion",var_ubicacion)
   anyo    = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"anyo")
	albaran = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"albaran")
	linea   = dw_detalle.GetItemNumber(dw_detalle.GetRow(),"linea")
	Update venlialb
	Set   venlialb.ubicacion         = :var_ubicacion
	Where venlialb.empresa  = :codigo_empresa
	And   venlialb.anyo     = :anyo
	And   venlialb.albaran  = :albaran
	And   venlialb.linea    = :linea;
	COMMIT;
	IF SQLCA.SQLCODE <> 0 Then
			f_mensaje("Error en datos","Error al modificar la linea")
	END IF
ELSE
	f_mensaje("Error en datos","La ubicacion no existe")
END IF
This.visible = FALSE
dw_detalle.enabled = TRUE
end event

event key; bus_campo = This.GetColumnName()
 CHOOSE CASE bus_campo
	CASE "almlinubica_almacen"
      bus_titulo     = "VENTANA SELECCION DE TIPO DE ALMACEN "
		bus_datawindow   =  "dw_ayuda_almacenes"
      bus_filtro            = ""
CASE "zona"
      bus_titulo     = "VENTANA SELECCION DE TIPO DE ZONA "
    	bus_datawindow   =  "dw_ayuda_almubizonas"
      bus_filtro            = "almacen='" + &
                                   This.GetItemString(This.GetRow(),"almlinubica_almacen") + "'"

 	CASE ELSE
		SetNull(bus_campo)
 END CHOOSE
CALL Super::Key
end event

event rbuttondown;bus_campo = This.GetColumnName()
 CHOOSE CASE bus_campo
	CASE "almlinubica_almacen"
      bus_titulo     = "VENTANA SELECCION DE TIPO DE ALMACEN "
		bus_datawindow   =  "dw_ayuda_almacenes"
      bus_filtro            = ""
CASE "zona"
      bus_titulo     = "VENTANA SELECCION DE TIPO DE ZONA "
    	bus_datawindow   =  "dw_ayuda_almubizonas"
      bus_filtro            = "almacen='" + &
      This.GetItemString(This.GetRow(),"almlinubica_almacen") + "'"

CASE ELSE
		SetNull(bus_campo)
END CHOOSE
CALL Super::rbuttondown
end event

type dw_detalle from datawindow within w_int_almalb
integer x = 14
integer y = 380
integer width = 3195
integer height = 1216
string dataobject = "dw_int_almlialb3"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;IF Row = 0 Then 
   f_activar_primer_campo()
   Return
End IF

This.SelectRow(0,FALSE)
This.SelectRow(Row,TRUE)
uo_tipolinea.em_codigo.text   = This.GetItemString(Row,"tipolinea")
uo_tipolinea.em_campo.text    = f_nombre_ventipolin(codigo_empresa,uo_tipolinea.em_codigo.text)
em_cajas.text                 = String(This.GetItemNumber(Row,"cajas"))
ante_existencias              = Dec(em_cantidad.text)
em_descripcion.text           = This.GetItemString(Row,"descripcion")
em_mtrs_lineales.text         = String(This.GetItemNumber(Row,"metros_lineales"))
ante_valor                    = This.GetItemNumber(Row,"precio")
em_precio                     = Dec(f_valor_columna(This,Row,"precio"))
em_prec.text                  = f_valor_columna(This,Row,"precio")
em_dto                        = This.GetItemNumber(Row,"dtoesp")
em_situacion.text             = This.GetItemString(Row,"situacion")
em_cajas.text                 = String(This.GetItemNumber(Row,"cajas"))
em_t_cajas.text               = String(This.GetItemNumber(Row,"total_cajas"))
uo_articulo.em_codigo.text    = This.GetItemString(Row,"articulo")
uo_calidad.em_codigo.text     = This.GetItemString(Row,"calidad")
uo_idioma.em_codigo.text      = This.GetItemString(Row,"idioma")
uo_idioma.em_campo.text       = This.GetItemString(Row,"idioma")
em_tono.text                  = Trim(This.GetItemString(Row,"tonochar"))
em_calibre.text               = String(This.GetItemNumber(Row,"calibre"))
em_tono_imprimir.text         = This.GetItemString(Row,"tono_imprimir")
em_calibre_imprimir.text      = This.GetItemString(Row,"calibre_imprimir")
uo_tipo_pallet.em_codigo.text = This.GetItemString(Row,"tipo_pallet")
em_t_pallets.text             = String(This.GetItemNumber(Row,"pallets"))
linea_albaran                  = This.GetItemNumber(Row,"linea")
control_incremento            = This.GetItemString(Row,"control_incremento")
uo_articulo.em_campo.text     = f_nombre_articulo(codigo_empresa,uo_articulo.em_codigo.text)
uo_articulo.ue_valor_anterior = uo_articulo.em_campo.text
uo_calidad.em_campo.text      = f_nombre_calidad_abr(codigo_empresa,uo_calidad.em_codigo.text)
uo_tipo_pallet.em_campo.text  = f_nombre_pallet_abr(codigo_empresa,uo_tipo_pallet.em_codigo.text)
referencia_ant                = This.GetItemString(Row,"referencia")
tipopallet_ant                = This.GetItemString(Row,"tipo_pallet")
cod_familia                   = This.GetItemString(Row,"familia")
cod_formato                   = This.GetItemString(Row,"formato")
var_situacion                   = This.GetItemString(Row,"situacion")
cod_tipo_unidad                   = This.GetItemString(Row,"tipo_unidad")
st_texto_cantidad.text=f_nombre_unidad(f_codigo_articulo_unidad(codigo_empresa,uo_articulo.em_codigo.text))
em_cantidad.Setmask(NumericMask!,f_mascara_unidad(cod_tipo_unidad))
em_cantidad.text              = String(This.GetItemNumber(Row,"cantidad"))
tipo="M"
f_botones()
f_peso_linea()
f_deposito()
IF This.GetItemString(Row,"deposito") = "S" Then
		deposito.text = "X"
ELSE
		deposito.text = ""
END IF

var_sector  = f_sector_familia(codigo_empresa,f_familia_articulo(codigo_empresa,uo_articulo.em_codigo.text))
f_activar_primer_campo()
f_campos_segun_tiplin()
Return
end event

event rbuttondown;//NO NECESARIO ALMACEN NUEVO 01/2014
/*
IF GetRow()= 0 Then Return
IF This.GetItemString(GetRow(),"situacion") = "S" Then Return
var_articulo    = This.GetItemString(GetRow(),"articulo") 
var_calidad     = This.GetItemString(GetRow(),"calidad")  
var_tipo_pallet = This.GetItemString(GetRow(),"tipo_pallet")  
var_caja        = This.GetItemString(GetRow(),"caja")  
var_calibre     = This.GetItemNumber(GetRow(),"calibre")  
var_tono        = This.GetItemString(GetRow(),"tonochar")  
var_cantidad     = This.GetItemNumber(GetRow(),"cantidad")  
this.enabled = FALSE
dw_ubicaciones.visible = TRUE

f_ubi(1)

dw_ubicaciones.Object.referencia.visible = TRUE
dw_ubicaciones.Object.todas.visible = TRUE
dw_ubicaciones.Object.ubicar.visible = TRUE

f_activar(FALSE)
*/
end event

type cb_desubicar from u_boton within w_int_almalb
boolean visible = false
integer x = 343
integer y = 1496
integer width = 329
integer height = 72
integer taborder = 60
boolean bringtotop = true
string text = "DesUbicar"
end type

event clicked;call super::clicked;//NO HABILITADO -  ALMACEN NUEVO 01/2014
IF Not f_bloquear_almacen(w_int_almalb.title) Then
	f_desubicar()
	f_desbloquear_almacen(w_int_almalb.title)
END IF

end event

type em_tono_imprimir from u_em_campo within w_int_almalb
integer x = 1627
integer y = 1864
integer width = 247
integer height = 80
integer taborder = 250
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = "!!!!!!!!!!!!!!!!!!!!!"
end type

type st_14 from statictext within w_int_almalb
integer x = 1627
integer y = 1788
integer width = 247
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Tono I"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_13 from statictext within w_int_almalb
integer x = 1879
integer y = 1788
integer width = 96
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "CI"
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type em_calibre_imprimir from u_em_campo within w_int_almalb
integer x = 1874
integer y = 1864
integer width = 101
integer height = 80
integer taborder = 250
boolean bringtotop = true
fontcharset fontcharset = ansi!
string facename = "Arial"
alignment alignment = right!
string mask = ""
end type

